<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Herbdocs – raft</title><link>/tags/raft/</link><description>Recent content in raft on Herbdocs</description><generator>Hugo -- gohugo.io</generator><atom:link href="/tags/raft/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Raft-01.基础理论</title><link>/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/Raft-01.%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/Raft-01.%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA/</guid><description>
&lt;h1 id="简介">简介&lt;/h1>
&lt;p>Raft 算法可以说是目前最成功的分布式共识算法，包括 TiDB、FaunaDB、Redis 等都使用了这种技术。原因是 Multi-Paxos 没有具体的实现细节，虽然它给了开发者想象空间，但共识算法一般居于核心位置，一旦存在潜在问题必然带给系统灾难性的后果。而 Raft 算法给出了大量的实现细节，且处理方式相比于 Multi-Paxos 有两点优势。&lt;/p>
&lt;h2 id="相关术语">相关术语&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">英文&lt;/th>
&lt;th style="text-align:left">中文&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">Term&lt;/td>
&lt;td style="text-align:left">选举任期，每次选举之后递增1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">Vote&lt;/td>
&lt;td style="text-align:left">选举投票(的ID)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">Entry&lt;/td>
&lt;td style="text-align:left">Raft算法的日志数据条目&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">candidate&lt;/td>
&lt;td style="text-align:left">候选人&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">leader&lt;/td>
&lt;td style="text-align:left">领导者&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">follower&lt;/td>
&lt;td style="text-align:left">跟随者&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">commit&lt;/td>
&lt;td style="text-align:left">提交&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">propose&lt;/td>
&lt;td style="text-align:left">提议&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1 id="raft-基本原理">Raft 基本原理&lt;/h1>
&lt;h2 id="对比paxos">对比Paxos&lt;/h2>
&lt;p>Zookeeper的ZAB，Viewstamped Replication（VR），raft，multi-paxos，这些都可以被称之为Leader-based一致性协议。不同的是，multi-paxos leader是作为对经典 paxos 的优化而提出，通过选择一个 proposer 作为 leader 降低多个 proposer 引起冲突的频率，提升性能将一次决议的平均消息代价缩小到最优的两次，实际上就算有多个leader存在，算法还是安全的，只是退化为经典的paxos算法。&lt;/p>
&lt;p>相同点：&lt;/p>
&lt;p>1、Multi-paxos和Raft都用一个数字来标识leader的合法性，multi-paxos中叫proposer-id，Raft叫term&lt;/p>
&lt;p>2、法定数量(半数以上)的follows确认之后才会进行commit&lt;/p>
&lt;p>不同点：&lt;/p>
&lt;p>1、proposer &amp;amp; leader&lt;/p>
&lt;p>Paxos 的 proposer是可以有多个，所以他叫做proposer，而不叫 Leader。Raft协议比Paxos的优点是 容易理解，容易实现。它强化了leader的地位，把整个协议可以清楚的分割成两个部分，并利用日志的连续性做了一些简化：&lt;/p>
&lt;p>（1）Leader在时。由Leader向Follower同步日志&lt;/p>
&lt;p>（2）Leader挂掉了，选一个新Leader，Leader选举算法。&lt;/p>
&lt;p>2、日志的连续性&lt;/p>
&lt;p>Raft协议强调日志的连续性，multi-paxos 则允许日志有空洞。 日志的连续性蕴含了这样一条性质：如果两个不同节点上相同序号的日志，term相同，那么这和这之前的日志必然也相同的。&lt;/p>
&lt;p>Raft 可以看成是 Multi-Paxos 的改进算法。相比而言 Raft 算法给出了大量的实现细节，且处理方式相比于 Multi-Paxos 有两点优势。&lt;/p>
&lt;ol>
&lt;li>发送的请求的是连续的，也就是说 Raft 的写日志操作必须是连续的；而 Multi-Paxos 可以并发修改日志，这也体现了“Multi”的特点。&lt;/li>
&lt;li>选主必须是最新、最全的日志节点才可以当选，这一点与 ZAB 算法有相同的原则；而 Multi-Paxo 是随机的。因此 Raft 可以看成是简化版本的 Multi-Paxos，正是这个简化，造就了 Raft 的流行。&lt;/li>
&lt;/ol>
&lt;h2 id="定义问题">定义问题&lt;/h2>
&lt;ol>
&lt;li>输入：输入命令&lt;/li>
&lt;li>输出：所有节点最终处于相同状态&lt;/li>
&lt;li>约束
&lt;ol>
&lt;li>网络不确定性：在非拜占庭情况下（即非受信网络），出现网络 分区/冗余/丢失/乱序 等问题下要保证数据状态正确&lt;/li>
&lt;li>基本可用性：集群中大部分节点能够保持相互通信，集群就应该能够正确响应客户端&lt;/li>
&lt;li>不依赖时序：不依赖物理时钟或极端的消息延迟来保证一致性&lt;/li>
&lt;li>快速响应：对客户端请求的响应不能依赖集群中最慢的节点&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;h2 id="拆解问题">拆解问题&lt;/h2>
&lt;p>raft 将一致性问题分解为3个子问题：&lt;/p>
&lt;ol>
&lt;li>领导者选举&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>现有领导者失效时，需要选举新的领导者&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>日志复制&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>领导者需要通过复制保持所有服务器的日志与自己的同步&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>安全性&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>如果其中一个服务器在特定索引上提交了日志条目，那么其它服务器不能在该索引应用不同的日志条目&lt;/p>
&lt;/blockquote>
&lt;h2 id="一个可行解">一个可行解&lt;/h2>
&lt;ol>
&lt;li>初始化时有一个领导者节点，负责发送日志到其他跟随者，并决定日志的顺序&lt;/li>
&lt;li>当读请求到来时，在任意节点都可以读，而写请求只能重定向到领导者处理&lt;/li>
&lt;li>领导者先写入自身的日志，然后同步给半数以上节点，跟随者成功复制日志，领导者才提交日志&lt;/li>
&lt;li>日志最终由领导者先按顺序应用于状态机，其它跟随者随机应用到状态机&lt;/li>
&lt;li>当领导者崩溃后，其它跟随者通过心跳感知并选举出新的领导者继续集群的正常运转&lt;/li>
&lt;li>当有新的节点加入或退出集群，需要将配置信息同步给整个集群&lt;/li>
&lt;/ol>
&lt;h1 id="raft-选举">Raft 选举&lt;/h1>
&lt;h2 id="状态机">状态机&lt;/h2>
&lt;p>在 raft 算法中，任意时刻每个服务器节点都处于这三个状态之一：&lt;/p>
&lt;ul>
&lt;li>Follower：追随者&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>跟随者都是被动的，不会发送任何请求，只是简单的响应来自领导者或候选人的请求&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>Candidate：候选人&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>如果跟随者接收不到消息，那么它就会变成候选人并发起一次选举，获得集群中大多数选票的候选人将成为领导者&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>Leader：领导者&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>系统中只有一个领导者并且其它节点全部都是跟随者，领导者处理所有的客户端请求（如果一个客户端和跟随者联系，那么跟随者会把请求重定向给领导者）&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="../imgs/raft_base20220904_1.png" alt="raft_base20220904_1.png">&lt;/p>
&lt;h2 id="任期">任期&lt;/h2>
&lt;p>Raft 将时间划分为任意长度的任期，每个任期都以一次选举开始。如果一个候选者赢得选举，在剩下的任期时间内都是领导者。每个任期最多有一个领导者（投票出现分歧则没有领导者）。&lt;/p>
&lt;p>任期号单调递增，每个服务器存储当前任期号，并在每次通信中交换该任期编号。&lt;/p>
&lt;p>如果一个服务器的当前任期号小于其他服务器，那么它将把当前任期更新为更大的值。如果候选人或领导者发现其任期已过期，则立即转化为追随者状态。如果服务器接收到带有过期任期号的请求，将拒绝请求。&lt;/p>
&lt;h2 id="leader-选举">Leader 选举&lt;/h2>
&lt;p>领导者定期向跟随者发送心跳来维持自己的 Leader 角色。如果跟随者在一定的时间内没有接收到任何的消息，也就是选举超时，那么它就会认为系统中没有可用的领导者，并且发起选举以选出新的领导者。&lt;/p>
&lt;p>开始一次选举，跟随者先要增加自己的当前任期号并且转换到候选人状态。然后并行地向集群中的其它服务器节点发送请求投票的 RPCs 来给自己投票。&lt;/p>
&lt;p>候选人的选举会有下面三种结果：&lt;/p>
&lt;p>1、候选人自己成为 Leader；&lt;/p>
&lt;p>2、其他服务成为 Leader&lt;/p>
&lt;p>3、候选人没有选出 Leader，可能是多个跟随者同时成为候选人，然后选票被瓜分导致没有候选人能获得最大的票数。&lt;/p>
&lt;p>对于选举过程选票被瓜分的情况，Raft 算法使用随机候选超时时间的方法来确保很少会发生选票瓜分的情况，就算发生也能很快地解决。如下选举的随机算法：&lt;/p>
&lt;ol>
&lt;li>为了防止选票期初就被瓜分，候选超时时间是从一个固定的区间（如：150-300ms）随机选择；&lt;/li>
&lt;li>这个候选超时时间就是 Follower 要等待成为 Candidate 的时间；&lt;/li>
&lt;li>每个候选人在开始一次选举时会重置一个随机候选的时间，也就是 150-300ms 中的随机值；&lt;/li>
&lt;li>这个时间结束后 Follower 变成 Candidate 开始选举，不同时间苏醒竞争 Leader，苏醒时间早就有竞争优势；&lt;/li>
&lt;li>这样大大减少选票被瓜分的情况，如果选票还是被瓜分就继续从第 1 步开始。&lt;/li>
&lt;/ol>
&lt;h2 id="日志复制">日志复制&lt;/h2>
&lt;p>一旦 Leader 被选举成功，就可以对客户端提供服务。客户端提交的每一条命令都会被顺序记录到 Leader 的命令中，每一条命令都包含 Term 编号和顺序索引，然后向其它节点并行发送 AppendEntries RPC 命令用以复制命令（如果命令丢失会不断重发），当大多数节点复制成功后，Leader 就会提交命令，即执行该命令并且将执行结果返回给客户端，Raft 保证已经提交的命令最终也会被其它节点成功执行。&lt;/p>
&lt;p>具体流程如下：&lt;/p>
&lt;ol>
&lt;li>所有请求都先经过 Leader，每个请求首先以日志的形式保存在 Leader 中，然后日志的状态是 uncommited 状态；&lt;/li>
&lt;li>Leader 将这些更改的请求发送到 Follower；&lt;/li>
&lt;li>Leader 等待大多数的 Follower 确定提交；&lt;/li>
&lt;li>Leader 在等待大多数的 Follower 确定提交后，commit 这些更改，提交这个信息到自己的状态机中，然后通知客户端更新的结果；&lt;/li>
&lt;li>同时 Leader 会不断的尝试通知 Follower 去存储所有更新的信息。
&lt;img src="../imgs/raft_base20220904_2.png" alt="raft_base20220904_2.png">&lt;/li>
&lt;/ol>
&lt;p>日志由有序编号（log index）的日志条目组成。每个日志包含它被创建时的任期号（term），和用于状态机执行的命令。如果一个日志条目被复制到大多数服务器上，就被认为可以提交（commit）了。&lt;/p>
&lt;p>&lt;img src="../imgs/raft_base20220904_3.png" alt="raft_base20220904_3.png">&lt;/p>
&lt;p>Raft 日志同步保证如下两点：&lt;/p>
&lt;ul>
&lt;li>如果不同日志中的两个条目有相同的索引和任期号，则它们所储存的命令是相同的&lt;/li>
&lt;li>如果不同日志中的两个条目有相同的索引和任期号，则它们之前的所有日志条目都是相同的
第一条特性源于Leader在一个 term 内在给定的一个 log index 最多创建一条日志条目，同时该条目在日志中的位置也从来不会改变。&lt;/li>
&lt;/ul>
&lt;p>第二条特性：Raft算法在发送日志复制请求时会携带前置日志的 term 和 logIndex 值（即 prevLogTerm 和 prevLogIndex），只有在 prevLogTerm 和 prevLogIndex 匹配的情况下才能成功响应请求。如果 prevLogTerm 和 prevLogIndex 不匹配，则说明当前节点可能是新加入的、或者之前服从于其它 Leader，亦或当前节点之前是 Leader 节点。为了兑现承诺二，Leader 节点需要与该 Follower 节点向前追溯找到 term 和 logIndex 匹配的那条日志，并使用Leader节点的日志强行覆盖该 Follower 此后的日志数据。&lt;/p>
&lt;h1 id="raft-详细实现">Raft 详细实现&lt;/h1>
&lt;h2 id="数据结构">数据结构&lt;/h2>
&lt;p>&lt;img src="../imgs/raft_base20220904_4.png" alt="raft_base20220904_4.png">&lt;/p>
&lt;h2 id="各类状态">各类状态&lt;/h2>
&lt;h3 id="通用持久性状态">通用持久性状态&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">参数&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">currentTerm&lt;/td>
&lt;td style="text-align:left">服务器已知最新任期（服务器首次启动时初始化为0，单调递增）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">votedFor&lt;/td>
&lt;td style="text-align:left">当前任期内收到选票的候选者id，如果没有投给任何候选者则为空&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">log[]&lt;/td>
&lt;td style="text-align:left">日志条目；每个条目包含用于状态机的命令，以及领导者接收到该条目时的任期（第一个索引为1）&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="通用易失性状态">通用易失性状态&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">参数&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">commitIndex&lt;/td>
&lt;td style="text-align:left">已知已提交的最高的日志条目的索引（初始值为0，单调递增）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">lastApplied&lt;/td>
&lt;td style="text-align:left">已知被应用到状态机的最高的日志条目的索引（初始值为0，单调递增）&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="领导者上的易失性状态">领导者上的易失性状态&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">参数&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">nextIndex[]&lt;/td>
&lt;td style="text-align:left">对于每一台服务器，发送到该服务的下一个日志条目的索引（初始值为领导者最后的日志条目的索引+1）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">matchIndex[]&lt;/td>
&lt;td style="text-align:left">对于每一台服务器，已知的已经复制到该服务器的最高日志条目的索引（初始值为0，单调递增）&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="rpc">RPC&lt;/h2>
&lt;p>候选人发起选举投票RPC到跟随者或候选人&lt;/p>
&lt;p>由领导者发起RPC到跟随者&lt;/p>
&lt;p>a. 日志追加&lt;/p>
&lt;p>b. 心跳通知&lt;/p>
&lt;h3 id="请求投票">请求投票&lt;/h3>
&lt;ol>
&lt;li>跟随者变更为候选人后&lt;/li>
&lt;li>选举超时后&lt;/li>
&lt;/ol>
&lt;h4 id="请求参数">请求参数&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">参数&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">term&lt;/td>
&lt;td style="text-align:left">候选人的任期号&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">candidateId&lt;/td>
&lt;td style="text-align:left">请求选票的候选人的id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">lastLogIndex&lt;/td>
&lt;td style="text-align:left">候选人的最后日志条目的索引值&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">lastLogTerm&lt;/td>
&lt;td style="text-align:left">候选人最后日志条目的任期号&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="返回值">返回值&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">返回值&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">term&lt;/td>
&lt;td style="text-align:left">当前任期号，以便于候选人去更新自己的任期号&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">voteGranted&lt;/td>
&lt;td style="text-align:left">候选人赢得了此张选票时为真&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="追加日志-心跳-领导者调用">追加日志&amp;amp;心跳（领导者调用）&lt;/h3>
&lt;blockquote>
&lt;ol>
&lt;li>客户端发起写命令请求时&lt;/li>
&lt;li>发送心跳时&lt;/li>
&lt;li>日志匹配失败时&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h4 id="请求参数-1">请求参数&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">参数&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">term&lt;/td>
&lt;td style="text-align:left">当前领导者的任期&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">leaderId&lt;/td>
&lt;td style="text-align:left">领导者ID，因此跟随者可以对客户端进行重定向&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">prevLogIndex&lt;/td>
&lt;td style="text-align:left">紧邻新日志条目之前的那个日志条目的索引&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">prevLogTerm&lt;/td>
&lt;td style="text-align:left">紧邻新日志条目之前的那个日志条目的任期&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">entries[]&lt;/td>
&lt;td style="text-align:left">需要被保存的日志条目（被当做心跳使用时 则日志条目内容为空；为了提高效率可能一次性发送多个）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">leaderCommit&lt;/td>
&lt;td style="text-align:left">领导者的已知已提交的最高的日志条目的索引&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="返回值-1">返回值&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">返回值&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">term&lt;/td>
&lt;td style="text-align:left">当前任期，对于领导者而言会更新自己的任期&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">success&lt;/td>
&lt;td style="text-align:left">结果为真，如果跟随者所含有的条目和prevLogIndex以及prevLogTerm匹配上了&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1 id="raft-算法原理与证明">Raft 算法原理与证明&lt;/h1>
&lt;h2 id="基本原则与特性">基本原则与特性&lt;/h2>
&lt;h3 id="选举安全特性">选举安全特性&lt;/h3>
&lt;p>对于一个给定的任期号，最多只会有一个领导人被选举出来&lt;/p>
&lt;blockquote>
&lt;p>在一个任期内半数以上的票数才能当选，保证每个任期要么0个领导要么1个领导&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="../imgs/raft_base20220904_5.png" alt="raft_base20220904_5.png">&lt;/p>
&lt;h3 id="领导人只附加原则">领导人只附加原则&lt;/h3>
&lt;p>领导人绝对不会删除或者覆盖自己的日志，只会增加&lt;/p>
&lt;h3 id="日志匹配原则">日志匹配原则&lt;/h3>
&lt;p>如果两个日志在相同的索引位置的日志条目的任期号相同，那么就认为这个日志从头到这个索引位置之间全部完全相同&lt;/p>
&lt;ol>
&lt;li>因为 集群在任意时刻最多有一个 leader 存在，leader在一个任期内只会在同一个索引处写入一次日志&lt;/li>
&lt;li>又因为 领导者从来不会删除或者覆盖自己的日志，并且日志一旦写入就不允许修改&lt;/li>
&lt;li>所以 只要任期和索引相同，那么在任何节点上的日志也都相同&lt;/li>
&lt;li>因为跟随者每次只会从与 leader 的 PreLog 匹配出追加日志，如果不匹配则 nextIndex-1 重试&lt;/li>
&lt;li>所以 由递归的性质可知一旦跟随者和 leader 在 PreLog 处匹配，那么之前的所有日志就都是匹配的&lt;/li>
&lt;li>所以 只要把 PreLog 之后的日志全部按此次 Leader 同步 RPC 的日志顺序覆盖即可保证二者的一致性&lt;/li>
&lt;/ol>
&lt;h3 id="领导人完全特性">领导人完全特性&lt;/h3>
&lt;p>如果某个日志条目在某个任期号中已经被提交，那么这个条目必然出现在更大任期号的所有领导者中&lt;/p>
&lt;h3 id="状态机安全特性">状态机安全特性&lt;/h3>
&lt;p>如果一个领导者已经将给定的索引值位置的日志条目应用到状态机中，那么其它任何的服务器在这个索引位置不会应用到一个不同的日志&lt;/p>
&lt;h2 id="安全性">安全性&lt;/h2>
&lt;p>每一任的领导者是否一定会有所有任期内领导者的全部已提交日志？&lt;/p>
&lt;h3 id="选举限制">选举限制&lt;/h3>
&lt;p>选民只会投票给任期比自己大，最后一条日志比自己新（任期大于 或 等于时索引更大）的候选人。&lt;/p>
&lt;p>这个存在一个问题，如下图示：&lt;/p>
&lt;p>&lt;img src="../imgs/raft_base20220904_6.png" alt="raft_base20220904_6.png">&lt;/p>
&lt;ol>
&lt;li>时刻a，S1 是任期2的领导者并且想部分节点（S1和S2）复制了2号位置的日志条目，然后宕机&lt;/li>
&lt;li>时刻b，S5 获得了 S3、S4（S5 的日志与 S3 和 S4 的一样新，最新的日志的任期号都是1）和自己的选票赢得了选举，成了3号任期的领导者，并且在2号位置上写入了一个任期号为3的日志条目。在新日志条目复制到其他节点之前，S5 宕机了。&lt;/li>
&lt;li>时刻c，S1 重启，并且通过 S2、S3、S4 和自己的选票赢得了选举，成了4号任期的领导人，并且继续向 S3 复制2号位置的日志。此时，任期2的日志条目已经在大多数节点上完成了复制。&lt;/li>
&lt;li>时刻d，S1 发生故障，S5 通过 S2、S3 的选票再次成为领导者（因为 S5 最后一条日制条目的任期号是 3，比 S2、S3、S4 中任意一个节点上日志都更加新些），任期号为5。然后 S5 用自己的本地日志也写了其它节点上的日志&lt;/li>
&lt;li>上面这个例子生动地说明了，即使日志条目被半数以上的节点写盘（复制）了，也并不代表它已经被提交了（commited）到 Raft 集群了——因为一旦某条日志被提交，那么它将永远没法被删除或修改。这个例子同时也说明了，领导人无法单纯地依靠之前任期的日志条目信息判断它的提交状态&lt;/li>
&lt;li>因此针对以上场景，Raft算法对日志提交条件增加了一个额外的限制：要求Leader在当前任期至少有一条日志被提交，即被超过半数的节点写盘。&lt;/li>
&lt;li>正如上图中e描述的那样，S1 作为 Leader，在崩溃之前，将3号位置的日志（任期号为4）在大多数节点上复制了一条日志条目（指的是条目3，term 4），那么即使这时 S1 宕机了，S5 也不可能赢得票。无法赢得选举，这就意味着2号位置的日志条目不会被覆写。
&lt;strong>所以新上任的领导者在接受客户端写入命令之前，需要提交一个 no-op（空命令），携带自己任期号的日志复制到大多数集群节点上才能真正的保证选举限制的成立。&lt;/strong>&lt;/li>
&lt;/ol>
&lt;h3 id="状态机安全性证明-三段论">状态机安全性证明(三段论)&lt;/h3>
&lt;ol>
&lt;li>定义 A为上个任期最后一条已提交日志，B为当前任期的 leader&lt;/li>
&lt;li>因为 A必然同步到了集群中的半数以上节点&lt;/li>
&lt;li>又因为 B只有获得集群中半数以上节点的选票后才能成为 leader&lt;/li>
&lt;li>所以 B的选民必然存在拥有A日志的节点&lt;/li>
&lt;li>又因为 选举限制，B成为leader的前提是比给它投票的所有选民都要新&lt;/li>
&lt;li>所以 B的日志中必然要包含A&lt;/li>
&lt;li>又因为 日志完全匹配规则，如果A被包含，那么比A小的所有日志都被B包含&lt;/li>
&lt;li>因为 lastAppied &amp;lt;= commitIndex&lt;/li>
&lt;li>又因为 raft保证已提交日志在所有集群节点上的顺序一致&lt;/li>
&lt;li>所以 应用日志必然在所有节点上顺序一致&lt;/li>
&lt;li>因为 状态机只能按序执行应用日志部分&lt;/li>
&lt;li>得证 状态机在整个集群所有节点上必然 最终一致&lt;/li>
&lt;/ol>
&lt;h3 id="状态机安全性证明-反证法">状态机安全性证明(反证法)&lt;/h3>
&lt;ol>
&lt;li>当日志条目L被同步给半数以上节点时，leader A会移动 commitIndex 指针提交日志，此时的日志被提交&lt;/li>
&lt;li>当 leader 崩溃后，由一个新节点成为 leader B，假设 leader B 是第一个未包含 leader A 最后已提交日志的领导者&lt;/li>
&lt;li>选举过程中，只有获得半数以上节点认可才能成为 leader，因此至少有一个投票给当前 leader B 的节点中含有已经提交的那条日志L。&lt;/li>
&lt;li>那么根据选举限制，节点只会将选票投给至少与自己一样新的节点
&lt;ol>
&lt;li>节点C作为包含 leader A 最后提交日志条目的投票者，如果 leader B 与节点 C 的最后一条日志的任期号一样大时，节点 C 的条目数一定大于 leader B，因为 leader B 是第一个未包含最后一条 leader A 日志的领导者。这与选举限制相矛盾，节点 C 不会投票给 leader B&lt;/li>
&lt;li>如果 leader B 最后一条日志的任期号大于节点 C 最后一条日志的任期号，那么 leader B 的前任领导中必然包含了 leader A 已经提交的日志（leader B 是第一个不包含 leader A 已提交日志的领导者 这一假设）。根据日志匹配特性 leader B 也必包含 leader A 最后的已提交日志，这与假设矛盾。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>所以证明 未来所有的临高这必然包含过去领导者已提交的日志，并且日志匹配原则，所有已提交日志的顺序一定是一致的。&lt;/li>
&lt;li>又因为 任意节点仅会将已提交日志按顺序应用于自身的状态机，更新 lastApplied 指针，因此所有节点的状态机都会最终顺序一致。&lt;/li>
&lt;li>得证 raft 算法能够保证节点之间的协同工作。&lt;/li>
&lt;/ol>
&lt;h3 id="常见问题">常见问题&lt;/h3>
&lt;h4 id="新leader未同步前任committed数据">新Leader未同步前任committed数据&lt;/h4>
&lt;p>问题描述：&lt;/p>
&lt;blockquote>
&lt;p>Leader 宕机后选出的新 Leader 没有同步前任 committed 数据，新leader节点会强行覆盖集群中其它节点与自己冲突的日志数据。&lt;/p>
&lt;/blockquote>
&lt;p>解决方法：&lt;/p>
&lt;blockquote>
&lt;p>这种情况 Raft 会对参加选举的节点进行限制，只有包含已经 committed 日志的节点才有机会竞选成功。&lt;/p>
&lt;ol>
&lt;li>参选节点的 term 值大于等于投票节点的 term 值&lt;/li>
&lt;li>如果 term 值相等，则参选节点的 lastLogIndex 大于等于投票节点的 lastLogIndex 值&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h4 id="leader在将日志复制给follower节点之前宕机">Leader在将日志复制给Follower节点之前宕机&lt;/h4>
&lt;p>如果在复制之前宕机，这时消息处于uncommitted状态，新选出的 Leader 一定不包含这些日志信息，所以新的 Leader 会强制覆盖 Follower 中跟自己冲突的日志，也就是刚刚宕机的Leader，如果变成follower，它未同步的信息会被新的 Leader 覆盖掉。&lt;/p>
&lt;h4 id="leader在将日志复制给follower节点之间宕机">Leader在将日志复制给Follower节点之间宕机&lt;/h4>
&lt;p>在复制的过程中宕机，会有两种情况：&lt;/p>
&lt;ol>
&lt;li>只有少数的 Follower 被同步到了；&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>如果只有少数的 Follower 被同步了，新的 Leader 不会包含这些信息，新的 Leader 会覆盖那些已经同步的节点的信息。&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>大多数的 Follower 被同步到了。&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Leader 在复制的过程中宕机，消息肯定没有 commit ，新的 Leader 需要再次尝试将其复制给各个 Follower 节点，并依据自己的复制状态决定是否提交这些日志。&lt;/p>
&lt;/blockquote>
&lt;h4 id="leader在响应客户端之前宕机">Leader在响应客户端之前宕机&lt;/h4>
&lt;p>这种情况根据上面的同步机制可以知道，消息肯定是 committed 状态，新的 Leader 肯定包含这个信息，但是新任 Leader 可能还未被通知该日志已经被提交，不过这个信息在之后一定会被新任 Leader 标记为 committed。&lt;/p>
&lt;p>不过对于客户端可能超时拿不到结果，认为本次消息失败了，客户端需要考虑幂等性。&lt;/p>
&lt;h2 id="时间和可用性">时间和可用性&lt;/h2>
&lt;p>Raft 的要求之一就是安全性不能依赖时间：整个系统不能因为某些事件运行的比预期快一点或者慢一点就产生了错误的结果。但是可用性（系统可以及时的响应客户端）不可避免的要依赖于时间。&lt;/p>
&lt;p>领导人选举是 Raft 中对时间要求最为关键的方面。Raft 可以选举并维持一个稳定的领导人，只要系统满足下面的时间要求：&lt;/p>
&lt;blockquote>
&lt;p>广播时间（broadcastTime） &amp;lt;&amp;lt; 候选超时时间（electionTimeout） &amp;lt;&amp;lt; 平均故障间隔时间（MTBF）&lt;/p>
&lt;/blockquote>
&lt;h1 id="工程优化">工程优化&lt;/h1>
&lt;h2 id="容错性">容错性&lt;/h2>
&lt;ol>
&lt;li>领导者崩溃通过选举可以解决，但跟随者与候选人崩溃呢？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>基础的 raft 算法，通过无限次幂等的附加复制 rpc 进行重试来解决&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>当平均故障时间大于信息交换时间，系统将没有一个稳定的领导者，集群无法工作&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>广播时间 &amp;lt;&amp;lt; 心跳超时时间 &amp;lt;&amp;lt; 平均故障时间&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>客户端如何连接 raft 的 server 节点？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>客户端随机选择一个节点去访问，如果是跟随者，跟随者会把自己知道的领导者告知客户端&lt;/p>
&lt;/blockquote>
&lt;ol start="4">
&lt;li>领导者提交后返回时崩溃，客户端重试不就导致相同的命令反复执行了吗？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>客户端为每次请求标记唯一序列号，服务端在状态中维护客户端最新的序列号标记，进行幂等处理&lt;/p>
&lt;/blockquote>
&lt;ol start="5">
&lt;li>客户端给领导者 set a=3 并进行了提交，此时客户端如果从一个未被同步的节点读取a读不到写后的值&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>每个客户端应该维持一个 latestIdx 值，每个节点在接受请求的时候与自己的 lastApplied 值比较，如果这个值大于自己的 lastApplied，则拒绝此次请求，客户端重定向到一个 lastApplied 大于等于自己 latestIdx 的请求，并且每次读取请求都会返回这个节点的 lastApplied 值，客户端将 lastestIdx 更新为此值，保证读取的线性一致。&lt;/p>
&lt;/blockquote>
&lt;ol start="6">
&lt;li>如果 leader 被孤立，其它跟随者选举出 leader，但是当前 leader 还是向外提供脏数据怎么办？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>写入数据由于无法提交，因此会立即失败，但无法防止读到脏数据。
解决办法是：心跳超过半数失败，leader 感知到自己处于少数分区而被孤立进而拒绝提供读写服务&lt;/p>
&lt;/blockquote>
&lt;ol start="7">
&lt;li>当出现网络分区后，被孤立少数集合的节点无法选举，只会不断地增加自己的任期，分区恢复后由于失联的节点任期更大，会强行更新所有节点的任期，触发一次重新选举，而又因为其日志不够新，被孤立的节点不可能成为新的 leader 。所以其状态机是安全的，只是触发了一次重新选举，使得集群有一定时间的不可用。这是完全可以避免的。&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>在跟随者成为候选人时，先发送一轮 pre-vote rpc 来判断自己是否在大多数分区内（是否有半数节点回应自己），如果是则任期加 1 进行选举。否则的话就不断尝试 pre-vote 请求。&lt;/p>
&lt;/blockquote>
&lt;h2 id="扩展性">扩展性&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>集群的成员发生变化时，存在某一时刻新老配置共存，进而有选举出两个领导者的可能
&lt;img src="../imgs/raft_base20220904_7.png" alt="raft_base20220904_7.png">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>新集群节点在配置变更期间必须获得老配置的多数派投票才能成为 leader&lt;/p>
&lt;/li>
&lt;li>
&lt;p>发送新配置 c-new 给集群的领导者&lt;/p>
&lt;/li>
&lt;li>
&lt;p>领导者将自己的 c-old 配置与 c-new 合并为一个 c-old-new 配置【123-45】&lt;/p>
&lt;/li>
&lt;li>
&lt;p>然后下发给其他所有跟随者&lt;/p>
&lt;ol>
&lt;li>当 c-old-new 被同步给半数以上节点后，那么此配置已经提交，遵循 raft 安全性机制&lt;/li>
&lt;li>当 leader 在将 c-old-new 写入半数以上跟随者之前崩溃了，那么选举出来的新 leader 会退回到老的配置，此时重试更新配置即可&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>当 c-old-new 被提交之后，leader 会真正的提交 c-new 配置&lt;/p>
&lt;ol>
&lt;li>如果提交给了半数节点，则 c-new 真正地被提交&lt;/li>
&lt;li>如果未提交给半数节点时崩溃，则新选举的 leader 必定包含已提交的 c-old-new 那么接着更新配置即可
&lt;strong>集群变更过于复杂，因此可以简化这一过程，使用单节点变更机制，即每一次只添加或删除一个节点&lt;/strong>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="../imgs/raft_base20220904_8.png" alt="raft_base20220904_8.png">&lt;/p>
&lt;ol>
&lt;li>单节点变更时，如果 leader 挂了造成一致性问题（丢失已提交日志）如何处理？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>新 leader 先发一条 no-op 日志再开始配置变更
可参考：&lt;a href="https://zhuanlan.zhihu.com/p/359206808">Raft成员变更的工程实践&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>单节点变更时偶数节点遇到网络分区，则没有办法选举 leader 了怎么办？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>重新定义偶数节点情况下的 法定人数模型下的大多数情况(n/2 或 n/2-1)
可参考：
&lt;a href="https://blog.openacid.com/distributed/raft-bug/">TiDB 在 Raft 成员变更上踩的坑&lt;/a>
&lt;a href="https://blog.openacid.com/algo/quorum/">后分布式时代: 多数派读写的’少数派’实现&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>新的服务器没有存储任何日志，领导要复制很长一段时间，此时不能参加选举否则会使得整体不可用&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>新加入的节点设置一个保护期，再次保护期内不会参加选举与日志提交决策，只用来同步日志&lt;/p>
&lt;/blockquote>
&lt;ol start="4">
&lt;li>如果集群的领导不是新集群中的一员，该如何处理？&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>在提交 c-new 时，不将自己算作半数提交，并且在提交后要主动退位&lt;/p>
&lt;/blockquote>
&lt;ol start="5">
&lt;li>被移除的节点如果不及时关闭，会导致选举超时后强行发起投票请求干扰在线集群&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>每个节点如果未达到最小心跳时间，则不会进行投票&lt;/p>
&lt;/blockquote>
&lt;h2 id="性能提升">性能提升&lt;/h2>
&lt;ol>
&lt;li>生成快照
1）日志如果无线增长会将本地磁盘打满，会造成可用性问题&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>定期地将状态机中的状态生成快照，而将之前的日志全部删除，是一种常见的压缩方式&lt;/p>
&lt;ol>
&lt;li>将节点的状态保存为 LSM Tree，然后存储最后应用日志的索引与任期，以保证日志匹配特性&lt;/li>
&lt;li>为支持集群的配置更新，快照中也要将最后应用的集群配置也当做状态保存下来&lt;/li>
&lt;li>当跟随者需要的日志已经在领导者上面被删除时（netxtIndex--），需要将快照通过RPC发送过去&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>注意：由领导人调用以将快照的分块发送给跟随者。领导者总是按顺序发送分块。&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">参数&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">term&lt;/td>
&lt;td style="text-align:left">领导人的任期号&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">leaderId&lt;/td>
&lt;td style="text-align:left">领导人的Id，以便于跟随者重定向请求&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">lastIncludedIndex&lt;/td>
&lt;td style="text-align:left">快照中包含的最后日志条目的索引值&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">lastincludedTerm&lt;/td>
&lt;td style="text-align:left">快照中包含的最后日志条目的任期号&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">offset&lt;/td>
&lt;td style="text-align:left">分块在快照中的字节偏移量&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">data[]&lt;/td>
&lt;td style="text-align:left">从偏移量开始的快照分块的原始字节&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">done&lt;/td>
&lt;td style="text-align:left">如果这时最后一个分块则为 true&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">结果&lt;/th>
&lt;th style="text-align:left">解释&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">term&lt;/td>
&lt;td style="text-align:left">当前任期号（currentTerm），便于领导人更新自己&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>2）快照何时创建？过于频繁会浪费性能，过于低频日志占用磁盘的量更大，重建时间更长。&lt;/p>
&lt;blockquote>
&lt;p>限定日志文件大小到达某一个阈值后立刻生成快照&lt;/p>
&lt;/blockquote>
&lt;p>3）写入快照花费的时间昂贵如何处理？如何保证不影响节点的正常工作？&lt;/p>
&lt;blockquote>
&lt;p>使用写时复制技术，状态机的函数式顺序性天然支持&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>调节参数&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;ol>
&lt;li>心跳的随机时间，过快会增加网络负载，过慢则会导致告知领导者崩溃的时间更长&lt;/li>
&lt;li>选举的随机事件，如果大部分跟随者同时变为候选人则会导致选票被瓜分&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>流批组合&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>首先可以做的就是 batch，很多情况下 batch 可以明显提升性能，譬如对于 RocksDB 的写入来说，通过不会每次写入一个值，而是会用一个 WriteBatch 缓存一批修改，然后再整个写入。对于 Raft 来说，Leader 可以一次收集多个 requests，然后一批发送给 Follower。当然需要有一个最大发送 size 来限制每次最多可以发送数据&lt;/p>
&lt;blockquote>
&lt;p>如果只是用 batch，Leader 还是需要等待 Follower 返回才能继续后面的流程，这里还可以使用 Pipeline 来进行加速。大家知道，Leader 会维护一个 NextIndex 的变量来表示下一个给 Follower 发送的 log 位置，通常情况下只要 Leader 跟 Follower 建立起了连接，都会认为网络是稳定互通的。所以只要当 Leader 给 Follower 发送了一批 log 后，可以直接更新 NextIndex，并且立刻发送后面的 log，不需要等待 Follower 的返回。如果网络出现了错误，或者 Follower 返回一些错误，Leader 就需要重新调整 NextIndex，然后重新发送 log 了。&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;ol start="4">
&lt;li>并行追加&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>对于上面提到的一次 request 简易 Raft 流程来说，Leader 可以先并行地将 log 发送给 Followers，然后再将 log append。这么做的原因主要是因为在 Raft 里面，如果一个 log 被大多数的节点 append，我们就可以认为这个 log 是被 committed 了，所以即使 Leader 再给 Follower 发送 log 之后，自己 append log 失败 panic 了，只要 N/2+1 个 Follower 能接收都这个 log 并成功 append，仍然认为这个 log 是被 commited 了，被 commited 的 log 后续就一定能被成功 apply。&lt;/p>
&lt;blockquote>
&lt;p>这么做的原因主要是因为 append log 会涉及到落盘，有开销，所以完全可以在 Leader 落盘的同时让 Follower 也尽快地收到 log 并 append
这里还需要注意，虽然 Leader 能在 append log 之前给 Follower 发 log，但是 Follower 却不能在 append log 之前告诉 Leader 已经成功 append 这个 log。如果 Follower 提前告诉 Leader 说已经成功 append，但实际后面 append log 时失败了，Leader 仍然会认为这个 log 是被 committed 了，这样系统就有丢失数据的风险了。&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;ol start="5">
&lt;li>异步应用&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>上面提到，当一个 log 被大部分节点 append 后，就可以认为这个 log 被 committed 了，被 committed 的 log 在什么时候被 apply 都不会再影响数据的一致性。所以当一个 log 被 committed 之后，可以用另一个线程去异步地 apply 这个 log。
所以整个 Raft 流程就可以变成：&lt;/p>
&lt;ol>
&lt;li>Leader 接收一个 client 发送的 request&lt;/li>
&lt;li>Leader 将对应的 log 发送给其他 follower 并本地 append&lt;/li>
&lt;li>Leader 继续接受其他 client 的 requests，持续进行步骤2&lt;/li>
&lt;li>Leader 发现 log 已经被 committed，在另外一个线程 apply&lt;/li>
&lt;li>Leader 异步 apply log 之后，返回结果给对应的 client
使用 asychronous apply 的好处在于现在可以完全地并行处理 append log 和 apply log，虽然对于一个 client 来说，它的一次 request 仍然要走完完整的 Raft 流程，但对于多个 clients 来说，整体的并发和吞吐量是提升了。&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h1 id="reference">Reference&lt;/h1>
&lt;p>&lt;a href="https://raft.github.io/">Raft 官网&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://thesecretlivesofdata.com/raft/#election">Raft 算法动画演示&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://ongardie.github.io/raft-talk-archive/2015/buildstuff/raftscope-replay/">Raft 算法演示&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.cnblogs.com/ricklz/p/15094389.html">etcd学习(5)-etcd的Raft一致性算法原理&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://pingcap.com/zh/blog/optimizing-raft-in-tikv">TiKV 功能介绍 - Raft 的优化&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://blog.openacid.com/distributed/raft-bug/">TiDB 在 Raft 成员变更上踩的坑&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.codedump.info/post/20180921-raft/">Raft算法原理&lt;/a>&lt;/p></description></item><item><title>Docs: Raft-02.raftexample源码分析</title><link>/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/Raft-02.raftexample%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/Raft-02.raftexample%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</guid><description>
&lt;h1 id="前言">前言&lt;/h1>
&lt;p>本文源码分析代码参考 etcd v3.5.0 中 raft 代码：&lt;/p>
&lt;p>&lt;a href="https://github.com/etcd-io/etcd/tree/v3.5.0/contrib/raftexample">https://github.com/etcd-io/etcd/tree/v3.5.0/contrib/raftexample&lt;/a>&lt;/p>
&lt;p>Etcd 将 raft 协议实现为一个 library，然后本身作为一个应用使用它。此外，etcd 还提供了一个叫 raftexample 的示例程序。&lt;/p>
&lt;p>在 etcd 中，raft 作为底层的共识模块，运行在一个 goroutine 里，通过 channel 接受上层（etcdserver）的消息，并将处理结果通过另一个 channel 返回给上层应用，交互过程大致如下：&lt;/p>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_1.png" alt="raft_sourcecode20220904_1.png">&lt;/p>
&lt;p>这种全异步地交互方式好处是提高了性能，坏处是难以测试，增加代码阅读难度。&lt;/p>
&lt;h1 id="基本概念">基本概念&lt;/h1>
&lt;p>源码中定义的一些变量概念&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Node: 对 etcd-raft 模块具体实现的一层封装，方便上层模块使用 etcd-raft 模块；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>上层模块: etcd-raft 的调用者，上层模块通过Node提供的API与底层的 etcd-raft 模块进行交互；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Cluster: 表示一个集群,其中记录了该集群的基础信息；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Member: 组层Cluster的元素之一，其中封装了一个节点的基本信息；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Peer: 集群中某个节点对集群中另一个节点的称呼；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Entry记录: 节点之间的传递是通过 message 进行的，每条消息中可以携带多条 Entry 记录,每条Entry对应一条一个独立的操作
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">type&lt;/span> &lt;span style="color:#000">Entry&lt;/span> &lt;span style="color:#a90d91">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// Term：表示该Entry所在的任期。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Term&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,2,opt,name=Term&amp;#34; json:&amp;#34;Term&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// Index:当前这个entry在整个raft日志中的位置索引,有了Term和Index之后，一个`log entry`就能被唯一标识。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Index&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,3,opt,name=Index&amp;#34; json:&amp;#34;Index&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 当前entry的类型
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 目前etcd支持两种类型：EntryNormal和EntryConfChange
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// EntryNormaln表示普通的数据操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// EntryConfChange表示集群的变更操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Type&lt;/span> &lt;span style="color:#000">EntryType&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,1,opt,name=Type,enum=raftpb.EntryType&amp;#34; json:&amp;#34;Type&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 序列化后的具体操作数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Data&lt;/span> []&lt;span style="color:#a90d91">byte&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;bytes,4,opt,name=Data&amp;#34; json:&amp;#34;Data,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Message: 是所有消息的抽象，包括各种消息所需要的字段，raft集群中各个节点之前的通讯都是通过这个message进行的。
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">type&lt;/span> &lt;span style="color:#000">Message&lt;/span> &lt;span style="color:#a90d91">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 该字段定义了不同的消息类型，etcd-raft就是通过不同的消息类型来进行处理的，etcd中一共定义了19种类型
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Type&lt;/span> &lt;span style="color:#000">MessageType&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,1,opt,name=type,enum=raftpb.MessageType&amp;#34; json:&amp;#34;type&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 消息的目标节点 ID，在急群中每个节点都有一个唯一的id作为标识
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">To&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,2,opt,name=to&amp;#34; json:&amp;#34;to&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 发送消息的节点ID
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">From&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,3,opt,name=from&amp;#34; json:&amp;#34;from&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 整个消息发出去时，所处的任期
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Term&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,4,opt,name=term&amp;#34; json:&amp;#34;term&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 该消息携带的第一条Entry记录的的Term值
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">LogTerm&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,5,opt,name=logTerm&amp;#34; json:&amp;#34;logTerm&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 索引值，该索引值和消息的类型有关,不同的消息类型代表的含义不同
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Index&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,6,opt,name=index&amp;#34; json:&amp;#34;index&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 需要存储的日志信息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Entries&lt;/span> []&lt;span style="color:#000">Entry&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;bytes,7,rep,name=entries&amp;#34; json:&amp;#34;entries&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 已经提交的日志的索引值，用来向别人同步日志的提交信息。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Commit&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,8,opt,name=commit&amp;#34; json:&amp;#34;commit&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 在传输快照时，该字段保存了快照数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Snapshot&lt;/span> &lt;span style="color:#000">Snapshot&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;bytes,9,opt,name=snapshot&amp;#34; json:&amp;#34;snapshot&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 主要用于响应类型的消息，表示是否拒绝收到的消息。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Reject&lt;/span> &lt;span style="color:#a90d91">bool&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,10,opt,name=reject&amp;#34; json:&amp;#34;reject&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// Follower 节点拒绝 eader 节点的消息之后，会在该字段记录 一个Entry索引值供Leader节点。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">RejectHint&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;varint,11,opt,name=rejectHint&amp;#34; json:&amp;#34;rejectHint&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 携带的一些上下文的信息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Context&lt;/span> []&lt;span style="color:#a90d91">byte&lt;/span> &lt;span style="color:#c41a16">`protobuf:&amp;#34;bytes,12,opt,name=context&amp;#34; json:&amp;#34;context,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>raftLog: Raft中日志同步的核心就是集群中leader如何同步日志到各个follower。日志的管理是在raftLog结构上完成的。
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">type&lt;/span> &lt;span style="color:#000">raftLog&lt;/span> &lt;span style="color:#a90d91">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 用于保存自从最后一次snapshot之后提交的数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">storage&lt;/span> &lt;span style="color:#000">Storage&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 用于保存还没有持久化的数据和快照，这些数据最终都会保存到storage中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">unstable&lt;/span> &lt;span style="color:#000">unstable&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 当天提交的日志数据索引
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">committed&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// committed保存是写入持久化存储中的最高index，而applied保存的是传入状态机中的最高index
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 即一条日志首先要提交成功（即committed），才能被applied到状态机中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 因此以下不等式一直成立：applied &amp;lt;= committed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">applied&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">logger&lt;/span> &lt;span style="color:#000">Logger&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 调用 nextEnts 时，返回的日志项集合的最大的大小
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// nextEnts 函数返回应用程序已经可以应用到状态机的日志项集合
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">maxNextEntsSize&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="raftexample">raftexample&lt;/h1>
&lt;h2 id="简介">简介&lt;/h2>
&lt;p>raftexample 是一个 etcd raft library 的使用示例。它为Raft一致性算法的键值对集群存储提供了一个简单的 REST API。&lt;/p>
&lt;h2 id="总体架构图">总体架构图&lt;/h2>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_2.png" alt="raft_sourcecode20220904_2.png">&lt;/p>
&lt;h2 id="启动">启动&lt;/h2>
&lt;p>该包提供了goreman启动集群的方式，按照 README 使用 goreman start 启动，可以很清楚的看到 raft 在启动过程中的选举过程，能够很好的帮助理解 raft 的选举过程。&lt;/p>
&lt;p>程序入口：&lt;/p>
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">contrib&lt;/span>&lt;span style="color:#000">/&lt;/span>&lt;span style="color:#000">raftexample&lt;/span>&lt;span style="color:#000">/&lt;/span>&lt;span style="color:#000">main&lt;/span>.&lt;span style="color:#a90d91">go&lt;/span>:&lt;span style="color:#1c01ce">24&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>下面介绍主要的函数&lt;/p>
&lt;h2 id="newraftnode">newRaftNode&lt;/h2>
&lt;p>在该函数中主要完成了 raftNode 的初始化 。在该方法中会使用上层模块传入的配置信息（其中包括 proposeC 通道和 confChangeC 通道）来创建raftNode实例，同时会创建 commitC 通道和 errorC 通道返回给上层模块使用 。这样上层模块就可以通过这几个通道与 rafeNode 实例进行交互。另外，newRaftNode() 函数中还会启动一个独立的后台 goroutine 来完成回放 WAL 日志、 启动网络组件等初始化操作。&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// contrib/raftexample/raft.go:87
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// raftNode 初始化
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 使用上层模块传入的配置信息来创建 raftNode 实例，
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 同时创建 commitC 通道和 errorC 通道返回给上层模块使用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 上层应用通过这几个 channel 就能和 raftNode 进行交互
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">newRaftNode&lt;/span>(&lt;span style="color:#000">id&lt;/span> &lt;span style="color:#a90d91">int&lt;/span>, &lt;span style="color:#000">peers&lt;/span> []&lt;span style="color:#a90d91">string&lt;/span>, &lt;span style="color:#000">join&lt;/span> &lt;span style="color:#a90d91">bool&lt;/span>, &lt;span style="color:#000">getSnapshot&lt;/span> &lt;span style="color:#a90d91">func&lt;/span>() ([]&lt;span style="color:#a90d91">byte&lt;/span>, &lt;span style="color:#a90d91">error&lt;/span>), &lt;span style="color:#000">proposeC&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">string&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">confChangeC&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#000">raftpb&lt;/span>.&lt;span style="color:#000">ConfChange&lt;/span>) (&lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">commit&lt;/span>, &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">error&lt;/span>, &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">snap&lt;/span>.&lt;span style="color:#000">Snapshotter&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// channel，主要传输 Entry 记录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// raftNode 会将 etcd-raft 模块返回的待应用 Entry 记录（封装在Ready实例中〉写入commitC通道，
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 另一方面，kvstore 会从 commitC 通道中读取这些待应用的 Entry 记录井保存其中的键值对信息。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">commitC&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">commit&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">errorC&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;amp;&lt;/span>&lt;span style="color:#000">raftNode&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">proposeC&lt;/span>: &lt;span style="color:#000">proposeC&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">confChangeC&lt;/span>: &lt;span style="color:#000">confChangeC&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">commitC&lt;/span>: &lt;span style="color:#000">commitC&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">errorC&lt;/span>: &lt;span style="color:#000">errorC&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">id&lt;/span>: &lt;span style="color:#000">id&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">peers&lt;/span>: &lt;span style="color:#000">peers&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">join&lt;/span>: &lt;span style="color:#000">join&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 初始化存放 WAL 日志和 Snapshot 文件的的目录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">waldir&lt;/span>: &lt;span style="color:#000">fmt&lt;/span>.&lt;span style="color:#000">Sprintf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;raftexample-%d&amp;#34;&lt;/span>, &lt;span style="color:#000">id&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">snapdir&lt;/span>: &lt;span style="color:#000">fmt&lt;/span>.&lt;span style="color:#000">Sprintf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;raftexample-%d-snap&amp;#34;&lt;/span>, &lt;span style="color:#000">id&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">getSnapshot&lt;/span>: &lt;span style="color:#000">getSnapshot&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">snapCount&lt;/span>: &lt;span style="color:#000">defaultSnapshotCount&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">stopc&lt;/span>: &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">struct&lt;/span>{}),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">httpstopc&lt;/span>: &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">struct&lt;/span>{}),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">httpdonec&lt;/span>: &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">struct&lt;/span>{}),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">logger&lt;/span>: &lt;span style="color:#000">zap&lt;/span>.&lt;span style="color:#000">NewExample&lt;/span>(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">snapshotterReady&lt;/span>: &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">snap&lt;/span>.&lt;span style="color:#000">Snapshotter&lt;/span>, &lt;span style="color:#1c01ce">1&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// rest of structure populated after WAL replay
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 启动一个goroutine，完成剩余的初始化工作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">go&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">startRaft&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#000">commitC&lt;/span>, &lt;span style="color:#000">errorC&lt;/span>, &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapshotterReady&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;h2 id="startraft">startRaft&lt;/h2>
&lt;ol>
&lt;li>创建 Snapshotter，并将该 Snapshotter 实例返回给上层模块；&lt;/li>
&lt;li>创建 WAL 实例，然后加载快照并回放 WAL 日志；&lt;/li>
&lt;li>创建 raft.Config 实例，其中包含了启动 etcd-raft 模块的所有配置；&lt;/li>
&lt;li>初始化底层 etcd-raft 模块，得到 node 实例；&lt;/li>
&lt;li>创建 Transport 实例，该实例负责集群中各个节点之间的网络通信，其具体实现在 raft-http 包中；&lt;/li>
&lt;li>建立与集群中其他节点的网络连接；&lt;/li>
&lt;li>启动网络组件，其中会监听当前节点与集群中其他节点之间的网络连接，并进行节点之间的消息读写；&lt;/li>
&lt;li>启动两个后台的 goroutine，它们主要工作是处理上层模块与底层 etcd-raft 模块的交互，但处理的具体内容不同，后面会详细介绍这两个 goroutine 的处理流程。&lt;/li>
&lt;/ol>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">rc&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raftNode&lt;/span>) &lt;span style="color:#000">startRaft&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">fileutil&lt;/span>.&lt;span style="color:#000">Exist&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapdir&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">os&lt;/span>.&lt;span style="color:#000">Mkdir&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapdir&lt;/span>, &lt;span style="color:#1c01ce">0750&lt;/span>); &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">log&lt;/span>.&lt;span style="color:#000">Fatalf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;raftexample: cannot create dir for snapshot (%v)&amp;#34;&lt;/span>, &lt;span style="color:#000">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapshotter&lt;/span> = &lt;span style="color:#000">snap&lt;/span>.&lt;span style="color:#000">New&lt;/span>(&lt;span style="color:#000">zap&lt;/span>.&lt;span style="color:#000">NewExample&lt;/span>(), &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapdir&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 创建 WAL 实例，然后加载快照并回放 WAL 日志
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">oldwal&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">wal&lt;/span>.&lt;span style="color:#000">Exist&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">waldir&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// replayWAL() 方法首先会读取快照数据，
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 在快照数据中记录了该快照包含的最后一条 Entry 记录的 Term 值 和 索引值。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 然后根据 Term 值 和 索引值确定读取 WAL 日志文件的位置，读取日志记录。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">wal&lt;/span> = &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">replayWAL&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// signal replay has finished
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapshotterReady&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapshotter&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rpeers&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">make&lt;/span>([]&lt;span style="color:#000">raft&lt;/span>.&lt;span style="color:#000">Peer&lt;/span>, &lt;span style="color:#a90d91">len&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">peers&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">for&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">range&lt;/span> &lt;span style="color:#000">rpeers&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rpeers&lt;/span>[&lt;span style="color:#000">i&lt;/span>] = &lt;span style="color:#000">raft&lt;/span>.&lt;span style="color:#000">Peer&lt;/span>{&lt;span style="color:#000">ID&lt;/span>: &lt;span style="color:#a90d91">uint64&lt;/span>(&lt;span style="color:#000">i&lt;/span> &lt;span style="color:#000">+&lt;/span> &lt;span style="color:#1c01ce">1&lt;/span>)}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 创建 raft.Config 实例
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">c&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;amp;&lt;/span>&lt;span style="color:#000">raft&lt;/span>.&lt;span style="color:#000">Config&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ID&lt;/span>: &lt;span style="color:#a90d91">uint64&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">id&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 选举超时
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">ElectionTick&lt;/span>: &lt;span style="color:#1c01ce">10&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 心跳超时
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">HeartbeatTick&lt;/span>: &lt;span style="color:#1c01ce">1&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Storage&lt;/span>: &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">raftStorage&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">MaxSizePerMsg&lt;/span>: &lt;span style="color:#1c01ce">1024&lt;/span> &lt;span style="color:#000">*&lt;/span> &lt;span style="color:#1c01ce">1024&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">MaxInflightMsgs&lt;/span>: &lt;span style="color:#1c01ce">256&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">MaxUncommittedEntriesSize&lt;/span>: &lt;span style="color:#1c01ce">1&lt;/span> &lt;span style="color:#000">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#1c01ce">30&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 初始化底层的 etcd-raft 模块，根据 WAL 日志回放情况判断首次启动还是重新启动
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">oldwal&lt;/span> &lt;span style="color:#000">||&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">join&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span> = &lt;span style="color:#000">raft&lt;/span>.&lt;span style="color:#000">RestartNode&lt;/span>(&lt;span style="color:#000">c&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 首次启动
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span> = &lt;span style="color:#000">raft&lt;/span>.&lt;span style="color:#000">StartNode&lt;/span>(&lt;span style="color:#000">c&lt;/span>, &lt;span style="color:#000">rpeers&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 创建 Transport 实例并启动，其负责 raft 节点之间的网络通信服务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">transport&lt;/span> = &lt;span style="color:#000">&amp;amp;&lt;/span>&lt;span style="color:#000">rafthttp&lt;/span>.&lt;span style="color:#000">Transport&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Logger&lt;/span>: &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">logger&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ID&lt;/span>: &lt;span style="color:#000">types&lt;/span>.&lt;span style="color:#000">ID&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">id&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ClusterID&lt;/span>: &lt;span style="color:#1c01ce">0x1000&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Raft&lt;/span>: &lt;span style="color:#000">rc&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ServerStats&lt;/span>: &lt;span style="color:#000">stats&lt;/span>.&lt;span style="color:#000">NewServerStats&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;&amp;#34;&lt;/span>, &lt;span style="color:#c41a16">&amp;#34;&amp;#34;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">LeaderStats&lt;/span>: &lt;span style="color:#000">stats&lt;/span>.&lt;span style="color:#000">NewLeaderStats&lt;/span>(&lt;span style="color:#000">zap&lt;/span>.&lt;span style="color:#000">NewExample&lt;/span>(), &lt;span style="color:#000">strconv&lt;/span>.&lt;span style="color:#000">Itoa&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">id&lt;/span>)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ErrorC&lt;/span>: &lt;span style="color:#a90d91">make&lt;/span>(&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">error&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 启动网络服务相关组件
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">transport&lt;/span>.&lt;span style="color:#000">Start&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 建立与集群中其它节点的连接
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">for&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">range&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">peers&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000">+&lt;/span>&lt;span style="color:#1c01ce">1&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">id&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">transport&lt;/span>.&lt;span style="color:#000">AddPeer&lt;/span>(&lt;span style="color:#000">types&lt;/span>.&lt;span style="color:#000">ID&lt;/span>(&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000">+&lt;/span>&lt;span style="color:#1c01ce">1&lt;/span>), []&lt;span style="color:#a90d91">string&lt;/span>{&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">peers&lt;/span>[&lt;span style="color:#000">i&lt;/span>]})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 启动协程，监听当前节点与集群中其他节点之间的网络连接
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">go&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">serveRaft&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 启动后台协程，处理上层应用与底层 etcd-raft 模块的交互
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">go&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">serveChannels&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;h2 id="servechannels">serveChannels&lt;/h2>
&lt;p>用于处理上次应用于底层 etcd-raft 模块的交互&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 单独启动一个后台协程负责上层模块传递给 etcd-raft 模块的数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 主要是 proposeC、confChangeC 两个通道
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">rc&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raftNode&lt;/span>) &lt;span style="color:#000">serveChannels&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 获取快照数据和快照元数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">snap&lt;/span>, &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">raftStorage&lt;/span>.&lt;span style="color:#000">Snapshot&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">panic&lt;/span>(&lt;span style="color:#000">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">confState&lt;/span> = &lt;span style="color:#000">snap&lt;/span>.&lt;span style="color:#000">Metadata&lt;/span>.&lt;span style="color:#000">ConfState&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">snapshotIndex&lt;/span> = &lt;span style="color:#000">snap&lt;/span>.&lt;span style="color:#000">Metadata&lt;/span>.&lt;span style="color:#000">Index&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">appliedIndex&lt;/span> = &lt;span style="color:#000">snap&lt;/span>.&lt;span style="color:#000">Metadata&lt;/span>.&lt;span style="color:#000">Index&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">defer&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">wal&lt;/span>.&lt;span style="color:#000">Close&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 定时器，推进逻辑时钟。100ms 是 etcd-raft 组件的最小时间单位
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">ticker&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">time&lt;/span>.&lt;span style="color:#000">NewTicker&lt;/span>(&lt;span style="color:#1c01ce">100&lt;/span> &lt;span style="color:#000">*&lt;/span> &lt;span style="color:#000">time&lt;/span>.&lt;span style="color:#000">Millisecond&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">defer&lt;/span> &lt;span style="color:#000">ticker&lt;/span>.&lt;span style="color:#000">Stop&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 单独的协程负责接收 proposeC、confChangeC 的数据传递给 etcd-raft 组件处理
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// send proposals over raft
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">go&lt;/span> &lt;span style="color:#a90d91">func&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">confChangeCount&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>(&lt;span style="color:#1c01ce">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">for&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">proposeC&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> &lt;span style="color:#000">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">confChangeC&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">select&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">prop&lt;/span>, &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">proposeC&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">ok&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 异常时将 proposeC 置空
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">proposeC&lt;/span> = &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 阻塞知道消息处理
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// blocks until accepted by raft state machine
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span>.&lt;span style="color:#000">Propose&lt;/span>(&lt;span style="color:#000">context&lt;/span>.&lt;span style="color:#000">TODO&lt;/span>(), []&lt;span style="color:#a90d91">byte&lt;/span>(&lt;span style="color:#000">prop&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 接收上层应用通过 confChangeC 传递的数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">cc&lt;/span>, &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">confChangeC&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">ok&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 异常时将 confChangeC 置空
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">confChangeC&lt;/span> = &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">confChangeCount&lt;/span>&lt;span style="color:#000">++&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">cc&lt;/span>.&lt;span style="color:#000">ID&lt;/span> = &lt;span style="color:#000">confChangeCount&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span>.&lt;span style="color:#000">ProposeConfChange&lt;/span>(&lt;span style="color:#000">context&lt;/span>.&lt;span style="color:#000">TODO&lt;/span>(), &lt;span style="color:#000">cc&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 关闭 stopc 通道，触发调用 rafeNode.stop()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// client closed channel; shutdown raft if not already
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">close&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">stopc&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 处理 etcd-raft 模块返回给上层模块的数据及其他相关操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// event loop on raft state machine updates
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">for&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">select&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">ticker&lt;/span>.&lt;span style="color:#000">C&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 触发 tricker 定时器
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span>.&lt;span style="color:#000">Tick&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 读取 node.readyc 通道(etcd-raft组件与上层应用交互的主要channel之一)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// Ready 实例封装了很多信息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// store raft entries to wal, then publish over commit channel
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">rd&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span>.&lt;span style="color:#000">Ready&lt;/span>():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将当前组件状态信息和待持久化的 Entry 记录保存到 WAL 日志文件中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 这样即使宕机，信息也可以在节点下次启动时，通过前面回放 WAL 日志的方式恢复
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">wal&lt;/span>.&lt;span style="color:#000">Save&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">HardState&lt;/span>, &lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Entries&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 检测组件生成新的快照数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">raft&lt;/span>.&lt;span style="color:#000">IsEmptySnap&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Snapshot&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 新的快照数据写入到快照文件中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">saveSnap&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Snapshot&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将新快照持久化到 raftStorage
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">raftStorage&lt;/span>.&lt;span style="color:#000">ApplySnapshot&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Snapshot&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 通知上层应用加载新快照
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">publishSnapshot&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Snapshot&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将待持久化的 Entry 记录追加到 raftStorage 中完成初始化
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">raftStorage&lt;/span>.&lt;span style="color:#000">Append&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Entries&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将待发送消息发送到指定节点
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">transport&lt;/span>.&lt;span style="color:#000">Send&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">Messages&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将已提交、待应用的 Entry 记录应用到上层应用的状态机中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">applyDoneC&lt;/span>, &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">publishEntries&lt;/span>(&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">entriesToApply&lt;/span>(&lt;span style="color:#000">rd&lt;/span>.&lt;span style="color:#000">CommittedEntries&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">ok&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">stop&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// WAL 日志量和 raftLog.storage 中的 Entry 记录会不断增加
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 节点每处理 1000 条(默认值) Entry 记录会触发一次创建快照的记录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 同时 WAL 会释放一些日志文件的句柄，raftLog.storage 也会压缩其保存的 Entry 记录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">maybeTriggerSnapshot&lt;/span>(&lt;span style="color:#000">applyDoneC&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 上层应用处理完该 Ready 实例，通知组件准备返回下一个 Ready 实例
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">node&lt;/span>.&lt;span style="color:#000">Advance&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">transport&lt;/span>.&lt;span style="color:#000">ErrorC&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">writeError&lt;/span>(&lt;span style="color:#000">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">stopc&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rc&lt;/span>.&lt;span style="color:#000">stop&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;h1 id="领导者选举">领导者选举&lt;/h1>
&lt;h2 id="启动节点">启动节点&lt;/h2>
&lt;p>Node 初始化时是 Follower 状态，集群的节点初次启动时会通过 StartNode() 启动创建对应的 node 实例和底层的 raft 实例。StartNode() 方法根据传入的 config 配置创建 raft 实例并初始raft 使用的相关组件。&lt;/p>
&lt;p>代码入口：&lt;/p>
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-plain" data-lang="plain">&lt;span style="display:flex;">&lt;span>newRaftNode() -&amp;gt; startRaft() -&amp;gt; StartNode()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>StartNode 启动节点
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-plain" data-lang="plain">&lt;span style="display:flex;">&lt;span>// raft/node.go:218
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>// Peer封装了节点 ID, 且记录了当前集群中全部节点 ID
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>func StartNode(c *Config, peers []Peer) Node {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> if len(peers) == 0 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> panic(&amp;#34;no peers given; use RestartNode instead&amp;#34;)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> // 根据 config 初始化 RawNode，并且也初始化一个 raft
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rn, err := NewRawNode(c)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> if err != nil {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> panic(err)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> // 第一次使用初始化 RawNode
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err = rn.Bootstrap(peers)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> if err != nil {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> c.Logger.Warningf(&amp;#34;error occurred during starting a new node: %v&amp;#34;, err)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> // 初始化 node 实例
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> n := newNode(rn)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> go n.run()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> return &amp;amp;n
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>func NewRawNode(config *Config) (*RawNode, error) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> // 调用初始化 newRaft
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r := newRaft(config)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rn := &amp;amp;RawNode{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> raft: r,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rn.prevSoftSt = r.softState()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rn.prevHardSt = r.hardState()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> return rn, nil
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>func newRaft(c *Config) *raft {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> if err := c.validate(); err != nil {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> panic(err.Error())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> raftlog := newLogWithSize(c.Storage, c.Logger, c.MaxCommittedSizePerReady)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hs, cs, err := c.Storage.InitialState()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> if err != nil {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> panic(err) // TODO(bdarnell)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r := &amp;amp;raft{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id: c.ID,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> lead: None,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> isLearner: false,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> raftLog: raftlog,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> maxMsgSize: c.MaxSizePerMsg,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> maxUncommittedSize: c.MaxUncommittedEntriesSize,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> prs: tracker.MakeProgressTracker(c.MaxInflightMsgs),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> electionTimeout: c.ElectionTick,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> heartbeatTimeout: c.HeartbeatTick,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger: c.Logger,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> checkQuorum: c.CheckQuorum,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> preVote: c.PreVote,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> readOnly: newReadOnly(c.ReadOnlyOption),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> disableProposalForwarding: c.DisableProposalForwarding,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> // 启动时都是 Follower 状态
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.becomeFollower(r.Term, None)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> var nodesStrs []string
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> for _, n := range r.prs.VoterNodes() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> nodesStrs = append(nodesStrs, fmt.Sprintf(&amp;#34;%x&amp;#34;, n))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.logger.Infof(&amp;#34;newRaft %x [peers: [%s], term: %d, commit: %d, applied: %d, lastindex: %d, lastterm: %d]&amp;#34;,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.id, strings.Join(nodesStrs, &amp;#34;,&amp;#34;), r.Term, r.raftLog.committed, r.raftLog.applied, r.raftLog.lastIndex(), r.raftLog.lastTerm())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> return r
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;p>node 节点初始化时，所有 node 开始都被初始化为 Follower 状态。
run方法调用：&lt;/p>
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-plain" data-lang="plain">&lt;span style="display:flex;">&lt;span>StartNode() -&amp;gt; go n.run()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>run方法：
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">n&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">node&lt;/span>) &lt;span style="color:#000">run&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">for&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">select&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pm&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">propc&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">recvc&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// filter out response message from unknown From.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">pr&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">prs&lt;/span>.&lt;span style="color:#000">Progress&lt;/span>[&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>]; &lt;span style="color:#000">pr&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> &lt;span style="color:#000">||&lt;/span> !&lt;span style="color:#000">IsResponseMsg&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">cc&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">confc&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">tickc&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">rn&lt;/span>.&lt;span style="color:#000">Tick&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">readyc&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span> &lt;span style="color:#000">rd&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">rn&lt;/span>.&lt;span style="color:#000">acceptReady&lt;/span>(&lt;span style="color:#000">rd&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">advancec&lt;/span> = &lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">advancec&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">advancec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">rn&lt;/span>.&lt;span style="color:#000">Advance&lt;/span>(&lt;span style="color:#000">rd&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">rd&lt;/span> = &lt;span style="color:#000">Ready&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">advancec&lt;/span> = &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">c&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">status&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">c&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span> &lt;span style="color:#000">getStatus&lt;/span>(&lt;span style="color:#000">r&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">stop&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">close&lt;/span>(&lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">done&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;p>这里主要是通过 for - select - channel 监听 channel 信息来处理不同请求。
其中 propc 和 recvc 拿到上层应用传来的消息会提交给 raft 层的 Step 函数处理。&lt;/p>
&lt;p>Step 函数是 etcd-raft 模块负责各类信息的入口。&lt;/p>
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHup&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgVote&lt;/span>, &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgPreVote&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">step&lt;/span>(&lt;span style="color:#000">r&lt;/span>, &lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>Step 函数中最后的 default 里的 step 被实现为一个状态机，其 step 属性是一个函数指针，根据当前节点的不同角色指向不同的消息处理函数：stepLeader/stepFollower/stepCandidate。同样还有一个 tick 函数指针，根据角色不同也有有不同的处理函数 tickHeartbeat 和 tickElection，分别用来触发定时心跳和选举检测。&lt;/p>
&lt;h2 id="发送心跳包">发送心跳包&lt;/h2>
&lt;h3 id="leader">Leader&lt;/h3>
&lt;p>当一个节点成为 Leader 时，会将节点的定时器设置为 tickHearbeat，然后周期性调用以维持 Leader 地位。&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// raft/raft.go:724
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">becomeLeader&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 检测当前节点的状态，禁止从 Follower 状态切换成 Leader 状态
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// TODO(xiangli) remove the panic when the raft implementation is stable
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">StateFollower&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">panic&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;invalid transition [follower -&amp;gt; leader]&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将 step 设置为 stepLeader
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">step&lt;/span> = &lt;span style="color:#000">stepLeader&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">reset&lt;/span>(&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 设置心跳函数
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tick&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tickHeartbeat&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 设置 lead 的 id
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 更新当前角色
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> = &lt;span style="color:#000">StateLeader&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">tickHeartbeat&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 心跳计数器递增
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">heartbeatElapsed&lt;/span>&lt;span style="color:#000">++&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 选举计数器递增
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span>&lt;span style="color:#000">++&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span> &lt;span style="color:#000">&amp;gt;=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionTimeout&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span> = &lt;span style="color:#1c01ce">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 检测当前节点时大多数节点保持连通
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">checkQuorum&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">From&lt;/span>: &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgCheckQuorum&lt;/span>}); &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Debugf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;error occurred during checking sending heartbeat: %v&amp;#34;&lt;/span>, &lt;span style="color:#000">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// If current leader cannot transfer leadership in electionTimeout, it becomes leader again.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">StateLeader&lt;/span> &lt;span style="color:#000">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">leadTransferee&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#000">None&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">abortLeaderTransfer&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#000">StateLeader&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">heartbeatElapsed&lt;/span> &lt;span style="color:#000">&amp;gt;=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">heartbeatTimeout&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">heartbeatElapsed&lt;/span> = &lt;span style="color:#1c01ce">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">From&lt;/span>: &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgBeat&lt;/span>}); &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Debugf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;error occurred during checking sending heartbeat: %v&amp;#34;&lt;/span>, &lt;span style="color:#000">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>becomeLeader 中 step 被设置成 stepLeader，所以会调用 stepLeader 来处理 leader 中对应的消息。然后调用 bcastHeartbeat 向所有节点发送心跳。
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepLeader&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// These message types do not require any progress for m.From.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgBeat&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 向所有节点发送心跳
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">bcastHeartbeat&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgCheckQuorum&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 检测是否和大部分节点保持连通
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 如果不连通则切换到 Follower 状态
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">prs&lt;/span>.&lt;span style="color:#000">QuorumActive&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Warningf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x stepped down to follower since quorum is not active&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomeFollower&lt;/span>(&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>, &lt;span style="color:#000">None&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// bcastHeartbeat sends RPC, without entries to all the peers.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">bcastHeartbeat&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">lastCtx&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">readOnly&lt;/span>.&lt;span style="color:#000">lastPendingRequestCtx&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 下面函数都会调用 sendHeartbeat
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#a90d91">len&lt;/span>(&lt;span style="color:#000">lastCtx&lt;/span>) &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#1c01ce">0&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">bcastHeartbeatWithCtx&lt;/span>(&lt;span style="color:#a90d91">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">bcastHeartbeatWithCtx&lt;/span>([]&lt;span style="color:#a90d91">byte&lt;/span>(&lt;span style="color:#000">lastCtx&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 向指定的节点发送消息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// sendHeartbeat sends a heartbeat RPC to the given peer.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">sendHeartbeat&lt;/span>(&lt;span style="color:#000">to&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>, &lt;span style="color:#000">ctx&lt;/span> []&lt;span style="color:#a90d91">byte&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// Attach the commit as min(to.matched, r.committed).
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// When the leader sends out heartbeat message,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// the receiver(follower) might not be matched with the leader
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// or it might not have all the committed entries.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// The leader MUST NOT forward the follower&amp;#39;s commit to
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// an unmatched index.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">commit&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">min&lt;/span>(&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">prs&lt;/span>.&lt;span style="color:#000">Progress&lt;/span>[&lt;span style="color:#000">to&lt;/span>].&lt;span style="color:#000">Match&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">committed&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">to&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 发送 MsgHeartbeat 类型的数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHeartbeat&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Commit&lt;/span>: &lt;span style="color:#000">commit&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Context&lt;/span>: &lt;span style="color:#000">ctx&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;p>最终的心跳通过 MsgHeartbeat 的消息类型进行发送，通知它们目前 Leader 的存活状态，重置所有 Follower 持有的超时计时器。&lt;/p>
&lt;h3 id="follower">Follower&lt;/h3>
&lt;p>Follower 节点行为：&lt;/p>
&lt;ol>
&lt;li>接收来自 Leader 的 RPC 消息 MsgHearbeat；&lt;/li>
&lt;li>重置当前节点的选举超时时间；&lt;/li>
&lt;li>回复 Leader 自己存活。
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">nc&lt;/span> &lt;span style="color:#000">stepFollower&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgProp&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHeartbeat&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span> = &lt;span style="color:#1c01ce">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> = &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">handleHeartbeat&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">handleHeartbeat&lt;/span>(&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">commitTo&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Commit&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHeartbeatResp&lt;/span>, &lt;span style="color:#000">Context&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Context&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="candidate">Candidate&lt;/h3>
&lt;p>Candidate 来处理 MsgHeartbeat 的信息，是先把自己变成 Follower，然后和上面的 Follower 一样，回复 Leader 自己存活。&lt;/p>
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// stepCandidate is shared by StateCandidate and StatePreCandidate; the difference is
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// whether they respond to MsgVoteResp or MsgPreVoteResp.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepCandidate&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHeartbeat&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomeFollower&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Term&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>) &lt;span style="color:#177500">// always m.Term == r.Term
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">handleHeartbeat&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">handleHeartbeat&lt;/span>(&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">commitTo&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Commit&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHeartbeatResp&lt;/span>, &lt;span style="color:#000">Context&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Context&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>当 Leader 收到返回信息时，会将对应节点设置为 RecentActive，表示该节点目前存活。
&lt;style>
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
.code-collapse1 {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 100%;
}
&lt;/style>
&lt;div class="code-collapse1">
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepLeader&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 根据 from，取出当前的 Follower 的 Progress
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">pr&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">prs&lt;/span>.&lt;span style="color:#000">Progress&lt;/span>[&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">pr&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Debugf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x no progress available for %x&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHeartbeatResp&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">RecentActive&lt;/span> = &lt;span style="color:#a90d91">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>&lt;/p>
&lt;p>如果 Follower 在一定的时间内，没有收到 Leader 节点的消息，就会发起新一轮的选举，重新选一个 Leader 节点。&lt;/p>
&lt;h2 id="leader-选举">Leader 选举&lt;/h2>
&lt;h3 id="接收心跳">接收心跳&lt;/h3>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">becomeFollower&lt;/span>(&lt;span style="color:#000">term&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>, &lt;span style="color:#000">lead&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">step&lt;/span> = &lt;span style="color:#000">stepFollower&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">reset&lt;/span>(&lt;span style="color:#000">term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tick&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tickElection&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> = &lt;span style="color:#000">lead&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> = &lt;span style="color:#000">StateFollower&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x became follower at term %d&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// follower以及candidate的tick函数，在r.electionTimeout之后被调用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">tickElection&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span>&lt;span style="color:#000">++&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// promotable返回是否可以被提升为leader
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// pastElectionTimeout检测当前的候选超时间是否过期
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">promotable&lt;/span>() &lt;span style="color:#000">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">pastElectionTimeout&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span> = &lt;span style="color:#1c01ce">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 发起选举
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">From&lt;/span>: &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHup&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>小结：&lt;/p>
&lt;ol>
&lt;li>如果可以成为 Leader&lt;/li>
&lt;li>当没有收到 Leader 心跳且候选超时时间过期；&lt;/li>
&lt;li>则重新发起新的选举请求；&lt;/li>
&lt;/ol>
&lt;h3 id="发起竞选">发起竞选&lt;/h3>
&lt;p>Step 函数接收 MsgHup 这个类型的消息后会调用 campaign 函数，进入竞选状态。&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgHup&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">preVote&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">hup&lt;/span>(&lt;span style="color:#000">campaignPreElection&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">hup&lt;/span>(&lt;span style="color:#000">campaignElection&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">hup&lt;/span>(&lt;span style="color:#000">t&lt;/span> &lt;span style="color:#000">CampaignType&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">campaign&lt;/span>(&lt;span style="color:#000">t&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">campaign&lt;/span>(&lt;span style="color:#000">t&lt;/span> &lt;span style="color:#000">CampaignType&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">t&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">campaignPreElection&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomePreCandidate&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">voteMsg&lt;/span> = &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgPreVote&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// PreVote RPCs are sent for the next term before we&amp;#39;ve incremented r.Term.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">term&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span> &lt;span style="color:#000">+&lt;/span> &lt;span style="color:#1c01ce">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 切换到Candidate状态
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomeCandidate&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">voteMsg&lt;/span> = &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgVote&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">term&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 统计当前节点收到的选票 并统计其得票数是否超过半数，这次检测主要是为单节点设置的
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 判断是否是单节点
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">_&lt;/span>, &lt;span style="color:#000">_&lt;/span>, &lt;span style="color:#000">res&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">poll&lt;/span>(&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">voteRespMsgType&lt;/span>(&lt;span style="color:#000">voteMsg&lt;/span>), &lt;span style="color:#a90d91">true&lt;/span>); &lt;span style="color:#000">res&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">quorum&lt;/span>.&lt;span style="color:#000">VoteWon&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">t&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">campaignPreElection&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">campaign&lt;/span>(&lt;span style="color:#000">campaignElection&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 是单节点的话直接变成 Leader
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomeLeader&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 向集群中的所有节点发送信息请求投票
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">for&lt;/span> &lt;span style="color:#000">_&lt;/span>, &lt;span style="color:#000">id&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">range&lt;/span> &lt;span style="color:#000">ids&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 跳过自身的节点
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">id&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x [logterm: %d, index: %d] sent %s request to %x at term %d&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastTerm&lt;/span>(), &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>(), &lt;span style="color:#000">voteMsg&lt;/span>, &lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">var&lt;/span> &lt;span style="color:#000">ctx&lt;/span> []&lt;span style="color:#a90d91">byte&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">t&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">campaignTransfer&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ctx&lt;/span> = []&lt;span style="color:#a90d91">byte&lt;/span>(&lt;span style="color:#000">t&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">Term&lt;/span>: &lt;span style="color:#000">term&lt;/span>, &lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">voteMsg&lt;/span>, &lt;span style="color:#000">Index&lt;/span>: &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>(), &lt;span style="color:#000">LogTerm&lt;/span>: &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastTerm&lt;/span>(), &lt;span style="color:#000">Context&lt;/span>: &lt;span style="color:#000">ctx&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>切换到 campaign 状态，然后发送自己的 term 消息，请求投票。
campaignPreElection 的作用：&lt;/p>
&lt;blockquote>
&lt;p>当系统之前出现分区，在分区消失后恢复时，可能会造成某个被 split 的 Followe r的 Term 数值很大。
对服务器进行分区时，它将不会收到 heartbeat 包，每次 electionTimeout 后成为 Candidate 都会递增 Term。
服务器在一段时间后恢复连接时，Term 的值将会变得很大，然后引入的重新选举会导致导致临时的延迟与可用性问题。
PreElection 阶段并不会真正增加当前节点的 Term，它的主要作用是得到当前集群能否成功选举出一个 Leader 的答案，避免上面这种情况的发生。&lt;/p>
&lt;/blockquote>
&lt;h3 id="接受消息并投票">接受消息并投票&lt;/h3>
&lt;p>投票需要满足的条件：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>当前节点没有给任何节点投票&lt;/strong>或者 &lt;strong>投票的节点 term 大于本节点的&lt;/strong>或者 &lt;strong>是之前已经投票的节点&lt;/strong>；&lt;/li>
&lt;li>该节点的消息是最新的。&lt;/li>
&lt;/ol>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">Step&lt;/span>(&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgVote&lt;/span>, &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgPreVote&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// We can vote if this is a repeat of a vote we&amp;#39;ve already cast...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">canVote&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Vote&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span> &lt;span style="color:#000">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// ...we haven&amp;#39;t voted and we don&amp;#39;t think there&amp;#39;s a leader yet in this term...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> (&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Vote&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">None&lt;/span> &lt;span style="color:#000">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">None&lt;/span>) &lt;span style="color:#000">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// ...or this is a PreVote for a future term...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> (&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgPreVote&lt;/span> &lt;span style="color:#000">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Term&lt;/span> &amp;gt; &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// ...and we believe the candidate is up to date.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">canVote&lt;/span> &lt;span style="color:#000">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">isUpToDate&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Index&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">LogTerm&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 如果当前没有给任何节点投票（r.Vote == None）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 或者 投票的节点 term 大于本节点的（m.Term &amp;gt; r.Term）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 或者 是之前已经投票的节点（r.Vote == m.From）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 同时还满足该节点的消息是最新的（r.raftLog.isUpToDate(m.Index, m.LogTerm)），
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 那么就接收这个节点的投票
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x [logterm: %d, index: %d, vote: %x] cast %s for %x [logterm: %d, index: %d] at term %d&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastTerm&lt;/span>(), &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>(), &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Vote&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">LogTerm&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Index&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">Term&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Term&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">voteRespMsgType&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>)})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgVote&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 保存给哪个节点投票
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span> = &lt;span style="color:#1c01ce">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Vote&lt;/span> = &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x [logterm: %d, index: %d, vote: %x] rejected %s from %x [logterm: %d, index: %d] at term %d&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastTerm&lt;/span>(), &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>(), &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Vote&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">LogTerm&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Index&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">Term&lt;/span>: &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">voteRespMsgType&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>), &lt;span style="color:#000">Reject&lt;/span>: &lt;span style="color:#a90d91">true&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;h3 id="candidate-统计投票">Candidate 统计投票&lt;/h3>
&lt;p>Candidate 节点接收到投票信息，然后统计投票数量&lt;/p>
&lt;ol>
&lt;li>如果投票数大于节点数的一半，成为 Leader；&lt;/li>
&lt;li>如果不满足则变成 Follower；&lt;/li>
&lt;/ol>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepCandidate&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// Only handle vote responses corresponding to our candidacy (while in
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// StateCandidate, we may get stale MsgPreVoteResp messages in this term from
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// our pre-candidate state).
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">var&lt;/span> &lt;span style="color:#000">myVoteRespType&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MessageType&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">StatePreCandidate&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">myVoteRespType&lt;/span> = &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgPreVoteResp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">myVoteRespType&lt;/span> = &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgVoteResp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">myVoteRespType&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 计算当前集群中给自己投票的节点数
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">gr&lt;/span>, &lt;span style="color:#000">rj&lt;/span>, &lt;span style="color:#000">res&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">poll&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>, !&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Reject&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x has received %d %s votes and %d vote rejections&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">gr&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span>, &lt;span style="color:#000">rj&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">res&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 大多数得票
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">quorum&lt;/span>.&lt;span style="color:#000">VoteWon&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">StatePreCandidate&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">campaign&lt;/span>(&lt;span style="color:#000">campaignElection&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 如果进行投票的节点数量正好是半数以上节点数量
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomeLeader&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 向集群中其他节点广播 MsgApp 消息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">bcastAppend&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 票数不够
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">quorum&lt;/span>.&lt;span style="color:#000">VoteLost&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// pb.MsgPreVoteResp contains future term of pre-candidate
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// m.Term &amp;gt; r.Term; reuse r.Term
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 切换到 Follower
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">becomeFollower&lt;/span>(&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>, &lt;span style="color:#000">None&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>每当收到一个 MsgVoteResp 类型的消息时，就会设置当前节点持有的 votes 数组，更新其中存储的节点投票状态，如果收到大多数的节点票数，切换成 Leader，向其他的节点发送当前节点当选的消息，通知其余节点更新 Raft 结构体中的 Term 等信息。
状态切换：&lt;/p>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_3.png" alt="raft_sourcecode20220904_3.png">&lt;/p>
&lt;p>PreCandidate 是为了防止在分区的情况下，某个 split 的 Follower 的 Term 数值变得很大。&lt;/p>
&lt;p>不同节点之间的切换，调用对应的 bacome* 方法就可以。需要注意每个 bacome* 中的 step 和 tick。&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">becomeFollower&lt;/span>(&lt;span style="color:#000">term&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>, &lt;span style="color:#000">lead&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">step&lt;/span> = &lt;span style="color:#000">stepFollower&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">reset&lt;/span>(&lt;span style="color:#000">term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tick&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tickElection&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> = &lt;span style="color:#000">lead&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> = &lt;span style="color:#000">StateFollower&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x became follower at term %d&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">becomeCandidate&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// TODO(xiangli) remove the panic when the raft implementation is stable
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">StateLeader&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">panic&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;invalid transition [leader -&amp;gt; candidate]&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">step&lt;/span> = &lt;span style="color:#000">stepCandidate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">reset&lt;/span>(&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span> &lt;span style="color:#000">+&lt;/span> &lt;span style="color:#1c01ce">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tick&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">tickElection&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Vote&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">state&lt;/span> = &lt;span style="color:#000">StateCandidate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x became candidate at term %d&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>step 属性是一个函数指针，根据当前节点的不同角色，指向不同的消息处理函数，如 stepLeader/stepFollower/stepCandidate。
tick 也是一个函数指针，根据角色的不同，也会在 tickHeartbeat 和 tickElection 之间来回切换，分别用来触发定时心跳和选举检测。&lt;/p>
&lt;h1 id="日志同步">日志同步&lt;/h1>
&lt;h2 id="wal-日志">WAL 日志&lt;/h2>
&lt;p>WAL（Write Ahead Log）主要的作用是记录整个数据变化的全部历程。etcd 中所有数据的修改在提交前，都要先写入到 WAL 中。这使得etcd拥有两个重要功能：&lt;/p>
&lt;ul>
&lt;li>故障快速恢复&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>数据遭到破坏时，可以通过执行所有 WAL 中记录的修改操作，快速从最原始的数据恢复到数据损坏前的状态。&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>数据回滚（undo）/重做（redo）&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>所有的修改操作都被记录在 WAL 中，需要回滚或重做，只需要反向或正向执行日志中的操作即可，类似 MySQL 。&lt;/p>
&lt;/blockquote>
&lt;p>etcd中处理 Entry 记录的流程图（摘自【etcd技术内幕】)&lt;/p>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_4.png" alt="raft_sourcecode20220904_4.png">&lt;/p>
&lt;p>具体流程如下：&lt;/p>
&lt;ol>
&lt;li>客户端向 etcd 集群发起一次请求，请求中封装的 Entry 首先会交给 etcd-raft 处理，etcd-raft 会将 Entry 记录保存到 raftLog.unstable 中；&lt;/li>
&lt;li>etcd-raft 将 Entry 记录封装到 Ready 实例中，返回给上层模块进行持久化；&lt;/li>
&lt;li>上层模块收到持久化的 Ready 记录后，会记录到 WAL 文件中然后持久化，最后通知 etcd-raft 模块进行处理；&lt;/li>
&lt;li>etcd-raft 将该 Entry 记录从 unstable 中移到 storage 中保存；&lt;/li>
&lt;li>当 Entry 记录被复制到集群中的半数以上节点时，该记录会被 Leader 节点认为已经提交，封装到 Ready 实例中通知上层模块；&lt;/li>
&lt;li>此时上层模块将该 Ready 实例封装的 Entry 记录应用到状态机上。&lt;/li>
&lt;/ol>
&lt;h2 id="同步日志">同步日志&lt;/h2>
&lt;p>etcd 中 Leader 节点数据 同步 到 Follower 流程图：&lt;/p>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_5.png" alt="raft_sourcecode20220904_5.png">&lt;/p>
&lt;p>etcd 日志保存的总体流程如下：&lt;/p>
&lt;p>1、集群某个节点收到 client 的 put 请求要求修改数据。节点会生成一个 Type 为 MsgProp 的Message，发送给 Leader。&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 生成MsgProp消息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">n&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">node&lt;/span>) &lt;span style="color:#000">Propose&lt;/span>(&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>.&lt;span style="color:#000">Context&lt;/span>, &lt;span style="color:#000">data&lt;/span> []&lt;span style="color:#a90d91">byte&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#000">n&lt;/span>.&lt;span style="color:#000">stepWait&lt;/span>(&lt;span style="color:#000">ctx&lt;/span>, &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgProp&lt;/span>, &lt;span style="color:#000">Entries&lt;/span>: []&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Entry&lt;/span>{{&lt;span style="color:#000">Data&lt;/span>: &lt;span style="color:#000">data&lt;/span>}}})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepFollower&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgProp&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> &lt;span style="color:#000">==&lt;/span> &lt;span style="color:#000">None&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x no leader at term %d; dropping proposal&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#000">ErrProposalDropped&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">disableProposalForwarding&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Infof&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x not forwarding to leader %x at term %d; dropping proposal&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#000">ErrProposalDropped&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 设置发送的目标为leader
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#177500">// 将信息发送给leader
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">To&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>2、Leader 收到 Message 后，会处理 Message 中的日志条目，将其 append 到 raftLog 的unstable 的日志中，并且调用 bcastAppend() 广播 append 日志的消息。
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepLeader&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// These message types do not require any progress for m.From.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgProp&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 将Entry记录追加到当前节点的raftlog中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> !&lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">appendEntry&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Entries&lt;/span>&lt;span style="color:#000">...&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#000">ErrProposalDropped&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 向其他节点复制Entry记录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">bcastAppend&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">maybeSendAppend&lt;/span>(&lt;span style="color:#000">to&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>, &lt;span style="color:#000">sendIfEmpty&lt;/span> &lt;span style="color:#a90d91">bool&lt;/span>) &lt;span style="color:#a90d91">bool&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">pr&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">prs&lt;/span>.&lt;span style="color:#000">Progress&lt;/span>[&lt;span style="color:#000">to&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">IsPaused&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">To&lt;/span> = &lt;span style="color:#000">to&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> = &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgApp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Index&lt;/span> = &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">Next&lt;/span> &lt;span style="color:#000">-&lt;/span> &lt;span style="color:#1c01ce">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">LogTerm&lt;/span> = &lt;span style="color:#000">term&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Entries&lt;/span> = &lt;span style="color:#000">ents&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Commit&lt;/span> = &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">committed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">n&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#a90d91">len&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Entries&lt;/span>); &lt;span style="color:#000">n&lt;/span> &lt;span style="color:#000">!=&lt;/span> &lt;span style="color:#1c01ce">0&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">State&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// optimistically increase the next when in StateReplicate
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">tracker&lt;/span>.&lt;span style="color:#000">StateReplicate&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">last&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Entries&lt;/span>[&lt;span style="color:#000">n&lt;/span>&lt;span style="color:#000">-&lt;/span>&lt;span style="color:#1c01ce">1&lt;/span>].&lt;span style="color:#000">Index&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">OptimisticUpdate&lt;/span>(&lt;span style="color:#000">last&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">Inflights&lt;/span>.&lt;span style="color:#000">Add&lt;/span>(&lt;span style="color:#000">last&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">tracker&lt;/span>.&lt;span style="color:#000">StateProbe&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">ProbeSent&lt;/span> = &lt;span style="color:#a90d91">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Panicf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;%x is sending append in unhandled state %s&amp;#34;&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">id&lt;/span>, &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">State&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;p>3、Leader 中的消息最终会以 MsgApp 类型的消息通知 Follower，Follower 收到信息之后，同 Leader 一样先将缓存中的日志条目持久化到磁盘中，并将当前已经持久化的最新日志 index 返回给 Leader。
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepFollower&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgApp&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">electionElapsed&lt;/span> = &lt;span style="color:#1c01ce">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">lead&lt;/span> = &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">handleAppendEntries&lt;/span>(&lt;span style="color:#000">m&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">handleAppendEntries&lt;/span>(&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">mlastIndex&lt;/span>, &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">maybeAppend&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Index&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">LogTerm&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Commit&lt;/span>, &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Entries&lt;/span>&lt;span style="color:#000">...&lt;/span>); &lt;span style="color:#000">ok&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">send&lt;/span>(&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>{&lt;span style="color:#000">To&lt;/span>: &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>, &lt;span style="color:#000">Type&lt;/span>: &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgAppResp&lt;/span>, &lt;span style="color:#000">Index&lt;/span>: &lt;span style="color:#000">mlastIndex&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// maybeAppend returns (0, false) if the entries cannot be appended. Otherwise,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// it returns (last index of new entries, true).
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">l&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raftLog&lt;/span>) &lt;span style="color:#000">maybeAppend&lt;/span>(&lt;span style="color:#000">index&lt;/span>, &lt;span style="color:#000">logTerm&lt;/span>, &lt;span style="color:#000">committed&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>, &lt;span style="color:#000">ents&lt;/span> &lt;span style="color:#000">...&lt;/span>&lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Entry&lt;/span>) (&lt;span style="color:#000">lastnewi&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>, &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#a90d91">bool&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">commitTo&lt;/span>(&lt;span style="color:#000">min&lt;/span>(&lt;span style="color:#000">committed&lt;/span>, &lt;span style="color:#000">lastnewi&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#1c01ce">0&lt;/span>, &lt;span style="color:#a90d91">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">l&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raftLog&lt;/span>) &lt;span style="color:#000">commitTo&lt;/span>(&lt;span style="color:#000">tocommit&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// never decrease commit
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">committed&lt;/span> &amp;lt; &lt;span style="color:#000">tocommit&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>() &amp;lt; &lt;span style="color:#000">tocommit&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Panicf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;tocommit(%d) is out of range [lastIndex(%d)]. Was the raft log corrupted, truncated, or lost?&amp;#34;&lt;/span>, &lt;span style="color:#000">tocommit&lt;/span>, &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">committed&lt;/span> = &lt;span style="color:#000">tocommit&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;p>4、最后leader收到大多数的follower的确认，commit自己的log，同时再次广播通知follower自己已经提交了。
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">func&lt;/span> &lt;span style="color:#000">stepLeader&lt;/span>(&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>, &lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">Message&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// These message types do not require any progress for m.From.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">switch&lt;/span> &lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">Type&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">case&lt;/span> &lt;span style="color:#000">pb&lt;/span>.&lt;span style="color:#000">MsgAppResp&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">pr&lt;/span>.&lt;span style="color:#000">RecentActive&lt;/span> = &lt;span style="color:#a90d91">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">maybeCommit&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">releasePendingReadIndexMessages&lt;/span>(&lt;span style="color:#000">r&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 如果可以commit日志，那么广播append消息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">bcastAppend&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#a90d91">else&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">oldPaused&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// 如果该节点之前状态是暂停，继续发送append消息给它
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">sendAppend&lt;/span>(&lt;span style="color:#000">m&lt;/span>.&lt;span style="color:#000">From&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#a90d91">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 尝试提交索引，如果已经提交返回true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 然后应该调用bcastAppend通知所有的follower
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raft&lt;/span>) &lt;span style="color:#000">maybeCommit&lt;/span>() &lt;span style="color:#a90d91">bool&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">mci&lt;/span> &lt;span style="color:#000">:=&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">prs&lt;/span>.&lt;span style="color:#000">Committed&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">return&lt;/span> &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">raftLog&lt;/span>.&lt;span style="color:#000">maybeCommit&lt;/span>(&lt;span style="color:#000">mci&lt;/span>, &lt;span style="color:#000">r&lt;/span>.&lt;span style="color:#000">Term&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">// 提交修改committed就可以了
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>&lt;span style="color:#a90d91">func&lt;/span> (&lt;span style="color:#000">l&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#000">raftLog&lt;/span>) &lt;span style="color:#000">commitTo&lt;/span>(&lt;span style="color:#000">tocommit&lt;/span> &lt;span style="color:#a90d91">uint64&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#177500">// never decrease commit
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">committed&lt;/span> &amp;lt; &lt;span style="color:#000">tocommit&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a90d91">if&lt;/span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>() &amp;lt; &lt;span style="color:#000">tocommit&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">logger&lt;/span>.&lt;span style="color:#000">Panicf&lt;/span>(&lt;span style="color:#c41a16">&amp;#34;tocommit(%d) is out of range [lastIndex(%d)]. Was the raft log corrupted, truncated, or lost?&amp;#34;&lt;/span>, &lt;span style="color:#000">tocommit&lt;/span>, &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">lastIndex&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span>.&lt;span style="color:#000">committed&lt;/span> = &lt;span style="color:#000">tocommit&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>&lt;/p>
&lt;h1 id="实战">实战&lt;/h1>
&lt;p>利用 raft 算法库实现一个分布式存储，此算法库已被广泛应用在 etcd、cockroachdb、dgraph 等开源项目中。&lt;/p>
&lt;p>总体架构：&lt;/p>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_6.png" alt="raft_sourcecode20220904_6.png">&lt;/p>
&lt;h2 id="api-设计">API 设计&lt;/h2>
&lt;p>API 由一组接口定义和协议组成，设计 API 会考虑如下因素：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>性能
如 etcd v2 使用的是 HTTP/1.x，性能上无法满足大规模 Kubernetes 集群等场景的诉求，etcd v3 使用的是基于 HTTP/2 的 gRPC 协议&lt;/p>
&lt;/li>
&lt;li>
&lt;p>易用性、可调试性
有的内部高并发服务为了性能会使用 UDP 协议，相比 HTTP 协议，UDP 协议在易用性、可调试性存在一定差距&lt;/p>
&lt;/li>
&lt;li>
&lt;p>开发效率、跨平台、可移植性
相比基于裸 UDP、TCP 协议设计的接口，如果使用 Protobuf 等 IDL 语言，支持跨平台、代码自动生成，开发效率更高。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安全性
使用 HTTPS 协议可对通信数据加密更安全，可适用于不安全的网络环境（比如公网传输）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>接口幂等性
基于 raftexample 定制开发，因此日志持久化存储、网络都使用的是 etcd 自带的 WAL 和 rafthttp 模块。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>WAL模块中提供了核心的保存未持久化的日志条目和快照功能接口；rafthttp模块基于 HTTP 协议提供了各个节点间的消息发送能力&lt;/p>
&lt;h2 id="复制状态机">复制状态机&lt;/h2>
&lt;p>复制状态机由共识模块、日志模块、状态机组成。&lt;/p>
&lt;p>&lt;img src="../imgs/raft_sourcecode20220904_7.png" alt="raft_sourcecode20220904_7.png">&lt;/p>
&lt;p>复制状态机的写请求流程：&lt;/p>
&lt;ul>
&lt;li>client 发起一个写请求；&lt;/li>
&lt;li>server 向 Raft 共识模块提交请求，共识模块生成一个写提案日志条目。若 server 是 Leader，则把日志条目广播给其他节点，并持久化日志条目到 WAL 中；&lt;/li>
&lt;li>当一半以上节点持久化日志条目后，Leader 的共识模块将此日志条目标记为已提交（committed），并通知其他节点提交；&lt;/li>
&lt;li>server 从共识模块获取已经提交的日志条目，异步应用到状态机存储中（boltdb/leveldb/memory），然后返回给 client。&lt;/li>
&lt;/ul>
&lt;h2 id="多存储引擎">多存储引擎&lt;/h2>
&lt;p>raftexample 本身只支持内存存储。通过将 KV 存储接口进行抽象化设计，实现支持多存储引擎。KVStore interface 的定义如下所示。&lt;/p>
&lt;style>
.highlight {
overflow-y: auto;
max-height: 500px;
overflow-x: auto;
max-width: 130%;
}
.td-content .highlight {
margin-top: 0.5rem;
margin-bottom: 0.5rem;
}
&lt;/style>
&lt;details class="code-collapse">
&lt;summary>Expand/Collapse Code Block&lt;/summary>
&lt;div class="highlight">&lt;div style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;">&lt;tr>&lt;td style="vertical-align:top;padding:0;margin:0;border:0;">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
&lt;/span>&lt;span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a90d91">type&lt;/span> &lt;span style="color:#000">KVStore&lt;/span> &lt;span style="color:#a90d91">interface&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   &lt;span style="color:#177500">// LookUp get key value
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>   &lt;span style="color:#000">Lookup&lt;/span>(&lt;span style="color:#000">key&lt;/span> &lt;span style="color:#a90d91">string&lt;/span>) (&lt;span style="color:#a90d91">string&lt;/span>, &lt;span style="color:#a90d91">bool&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   &lt;span style="color:#177500">// Propose propose kv request into raft state machine
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>   &lt;span style="color:#000">Propose&lt;/span>(&lt;span style="color:#000">k&lt;/span>, &lt;span style="color:#000">v&lt;/span> &lt;span style="color:#a90d91">string&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   &lt;span style="color:#177500">// ReadCommits consume entry from raft state machine into KvStore map until error
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>   &lt;span style="color:#000">ReadCommits&lt;/span>(&lt;span style="color:#000">commitC&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#000">*&lt;/span>&lt;span style="color:#a90d91">string&lt;/span>, &lt;span style="color:#000">errorC&lt;/span> &lt;span style="color:#000">&amp;lt;-&lt;/span>&lt;span style="color:#a90d91">chan&lt;/span> &lt;span style="color:#a90d91">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   &lt;span style="color:#177500">// Snapshot return KvStore snapshot
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>   &lt;span style="color:#000">Snapshot&lt;/span>() ([]&lt;span style="color:#a90d91">byte&lt;/span>, &lt;span style="color:#a90d91">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   &lt;span style="color:#177500">// RecoverFromSnapshot recover data from snapshot
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>   &lt;span style="color:#000">RecoverFromSnapshot&lt;/span>(&lt;span style="color:#000">snapshot&lt;/span> []&lt;span style="color:#a90d91">byte&lt;/span>) &lt;span style="color:#a90d91">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   &lt;span style="color:#177500">// Close close backend databases
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#177500">&lt;/span>   &lt;span style="color:#000">Close&lt;/span>() &lt;span style="color:#000">err&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;br/>
&lt;p>存储引擎的选型及基本原理&lt;/p>
&lt;h3 id="boltdb">boltdb&lt;/h3>
&lt;p>github 链接：&lt;a href="https://github.com/etcd-io/bbolt">https://github.com/etcd-io/bbolt&lt;/a>&lt;/p>
&lt;p>boltdb 是一个基于 B+ tree 实现的存储引擎库。&lt;/p>
&lt;p>boltdb 适用于读多写少，一般情况下可直接从内存中基于 B+ tree 遍历，快速获取数据返回给 client，不涉及经过磁盘 I/O。&lt;/p>
&lt;p>对于写请求，基于 B+ tree 查找写入位置，更新 key-value。事务提交时，写请求包括 B+ tree 重平衡、分裂、持久化 dirty page、持久化 freelist、持久化 meta page 流程。同时，dirty page 分布位置可能分散，这里是随机写磁盘 I/O。&lt;/p>
&lt;h3 id="leveldb">leveldb&lt;/h3>
&lt;p>github 链接：&lt;a href="https://github.com/google/leveldb">https://github.com/google/leveldb&lt;/a> 和 &lt;a href="https://github.com/syndtr/goleveldb">https://github.com/syndtr/goleveldb&lt;/a>&lt;/p>
&lt;p>写多读少最简单的自然就是通过写内存最快，但是内存空间有限，无法支撑大容量的数据存储，且不持久化数据会丢失。&lt;/p>
&lt;p>可以通过将数据顺序追加到文件末尾（AOF）来提升写速度。&lt;a href="https://en.wikipedia.org/wiki/Bitcask">Bitcask&lt;/a>存储模型就是采用 AOF 模式，把写请求顺序追加到文件。Facebook 的图片存储&lt;a href="https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Beaver.pdf">Haystack&lt;/a>也是使用类似的方案来解决大规模写入痛点。&lt;/p>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Bitcask">Bitcask&lt;/a>存储模型通过内存哈希表维护各个 key-value 数据的索引，实现了快速查找 key-value 数据。虽然内存只保存 key 索引信息，但是当 key 较多时对内存要求依然较高。&lt;/p>
&lt;p>leveldb 是基于 LSM tree(log-structured merge-tree) 实现的 key-value 存储（架构可参考：&lt;a href="https://microsoft.github.io/MLOS/notebooks/LevelDbTuning/">https://microsoft.github.io/MLOS/notebooks/LevelDbTuning/&lt;/a>），提升写性能的核心思路同样是将随机写转化为顺序写磁盘 WAL 文件和内存。&lt;/p>
&lt;h2 id="读写流程">读写流程&lt;/h2>
&lt;p>写流程：&lt;/p>
&lt;ul>
&lt;li>client 通过 curl 发送 HTTP PUT 请求到 server；&lt;/li>
&lt;li>server 收到后，将消息写入到 KVStore 的 ProposeC 管道；&lt;/li>
&lt;li>raftNode 循环逻辑将消息通过 Raft 模块的 Propose 接口提交；&lt;/li>
&lt;li>Raft 模块输出 Ready 结构，server 将日志条目持久化后，并发送给其他节点；&lt;/li>
&lt;li>集群多数节点持久化此日志条目后，这个日志条目被提交给存储状态机 KVStore 执行；&lt;/li>
&lt;li>KVStore 根据启动的 backend 存储引擎名称，调用对应的 Put 接口即可。
&lt;img src="../imgs/raft_sourcecode20220904_8.png" alt="raft_sourcecode20220904_8.png">&lt;/li>
&lt;/ul>
&lt;p>读流程：&lt;/p>
&lt;ul>
&lt;li>client 通过 curl 发送 HTTP Get 请求到 server；&lt;/li>
&lt;li>server 收到后，根据 KVStore 的存储引擎，从后端查询出对应的 key-value 数据。
&lt;img src="../imgs/raft_sourcecode20220904_9.png" alt="raft_sourcecode20220904_9.png">&lt;/li>
&lt;/ul>
&lt;h1 id="总结">总结&lt;/h1>
&lt;ol>
&lt;li>etcd 中的 raft 是作为一个 library 被使用的。这个库仅仅实现了对应的 raft 算法；&lt;/li>
&lt;li>etcd-raft 这种实现的过程，其中的 step 和 tick 被设计成了函数指针，根据不同的角色来防止不同的函数；&lt;/li>
&lt;li>为了防止出现网络分区 Term 数值变得很大的场景，引入了 PreCandidate；&lt;/li>
&lt;li>etcd 中所有的数据都是通过 Leader 分发到 Follower，通过日志的复制确认机制，保证绝大多数的 Follower 都能同步到消息。&lt;/li>
&lt;/ol>
&lt;h1 id="reference">Reference&lt;/h1>
&lt;p>&lt;a href="https://blog.betacat.io/post/raft-implementation-in-etcd/">Raft 在 etcd 中的实现&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.codedump.info/post/20180922-etcd-raft/">etcd Raft库解析&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/lichuang/etcd-3.1.10-codedump">etcd Raft 源码注释解析&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.cnblogs.com/ricklz/p/15155095.html">etcd学习(6)-etcd实现raft源码解读&lt;/a>&lt;/p>
&lt;p>《etcd技术内幕》&lt;/p>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/91314329">raftexample 源码解读&lt;/a>&lt;/p></description></item></channel></rss>