<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/10.OS/><link rel=alternate type=application/rss+xml href=/docs/10.OS/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>OS | Herbdocs</title><meta name=description content="Introduction
操作系统，如Linux和Shell基本知识
"><meta property="og:title" content="OS"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/10.OS/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="OS"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="OS"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/10.OS/>返回本页常规视图</a>.</p></div><h1 class=title>OS</h1><ul><li>1: <a href=#pg-84b7f9d27f10f9fa471805c25d64e1ee>00.OS相关概念</a></li><li>2: <a href=#pg-b0668b92c1663805e02463fc783fb89c>Linux负载均衡LVS之IPVS</a></li><li>3: <a href=#pg-858d6a90d7f50022cacf13f6f44c398a>shell</a></li><ul><li>3.1: <a href=#pg-87b710ee2a8cb64508663e95a4eb8f0b>Shebang</a></li><li>3.2: <a href=#pg-490b491886e52a4b6a3f9d5eb09160a3>curl&wget</a></li><li>3.3: <a href=#pg-f80614d5954cbe084cff76fe7cb36a6b>shell-find</a></li><li>3.4: <a href=#pg-a3de2a40d38dbc6507897dc1601203d6>shell文本处理三剑客</a></li><li>3.5: <a href=#pg-c3ac6af8c8745d6d3daa083e31eb18ed>shell解析json</a></li><li>3.6: <a href=#pg-217d9697cd7dc2705202d21fc0e09835>获取程序当前路径有多麻烦</a></li></ul><li>4: <a href=#pg-0659b8fad1f0a169ddb5df2f7c111fdd>进程</a></li><ul><li>4.1: <a href=#pg-96f3d1bcce14bd1e11a43f2c64a1c481>Linux后台进程</a></li><li>4.2: <a href=#pg-89e0946384b3f67a5b20c8a00bf162a3>Linux的启动过程</a></li><li>4.3: <a href=#pg-3b8e4619334355226769bbce91df6df8>supervisor</a></li><li>4.4: <a href=#pg-f3d9259623dc5dcb82a4c71fca06077c>systemd</a></li><li>4.5: <a href=#pg-603075ac01bc3caf87450a80e3fda26d>goreman</a></li><li>4.6: <a href=#pg-f980e31301aeace33166387bd2a4d43f>守护进程</a></li><li>4.7: <a href=#pg-26c4cb04ca10d7949be89845549dde58>进程间通信</a></li></ul><li>5: <a href=#pg-2f72ff9138894ca6f7c89ae54772e10e>文件系统</a></li><ul><li>5.1: <a href=#pg-2ee2ec2642eaef42de79f646b1afbde5>Linux文件系统-01设备</a></li></ul></ul><div class=content><h1 id=introduction>Introduction</h1><p>操作系统，如Linux和Shell基本知识</p></div></div><div class=td-content><h1 id=pg-84b7f9d27f10f9fa471805c25d64e1ee>1 - 00.OS相关概念</h1><h1 id=namespace>Namespace</h1><p>当一台物理主机（宿主机）运行容器的时候，为了避免容器所需系统资源之间相互干扰。所以Docker利用操作系统的隔离技术-NameSpace，来实现在同一个操作系统中，不同容器之间的资源独立隔离运行。</p><h2 id=隔离系统资源列表>隔离系统资源列表</h2><p>Linux NameSpace是Linux系统提供的一种资源隔离机制，可实现系统资源的列表如下：</p><table><thead><tr><th style=text-align:left>Mount</th><th style=text-align:left>用于隔离文件系统的挂载点</th></tr></thead><tbody><tr><td style=text-align:left>UTS</td><td style=text-align:left>用于隔离HostName和DomainName</td></tr><tr><td style=text-align:left>IPC</td><td style=text-align:left>用于隔离进程间通信</td></tr><tr><td style=text-align:left>PID</td><td style=text-align:left>用于隔离进程ID</td></tr><tr><td style=text-align:left>NetWork</td><td style=text-align:left>用于隔离网络</td></tr><tr><td style=text-align:left>User</td><td style=text-align:left>用于隔离用户和用户组 UID/GID</td></tr></tbody></table><h2 id=查看系统资源隔离>查看系统资源隔离</h2><h3 id=查找进程>查找进程</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ps aux | grep ssh
</span></span></code></pre></td></tr></table></div></div></div><h3 id=查看namespace-ns>查看NameSpace(NS)</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ll /proc/727 /ns/
</span></span></code></pre></td></tr></table></div></div></div><h1 id=linux-cgroup>Linux CGroup</h1><p>Linux Control Group， 是Linux内核的一个功能，用来限制、控制与分离一个进程组群的资源（如CPU、内存、磁盘输入输出等）。这个项目最早是由Google的工程师在2006年发起（主要是Paul Menage和Rohit Seth），最早的名称为进程容器（process containers）。在2007年时，因为在Linux内核中，容器（container）这个名词太过广泛，为避免混乱，被重命名为cgroup，并且被合并到2.6.24版的内核中去。然后，其它开始了他的发展。 </p><p>Linux CGroupCgroup 可​​​为​​​系​​​统​​​中​​​所​​​运​​​行​​​任​​​务​​​（进​​​程​​​）的​​​用​​​户​​​定​​​义​​​组​​​群​​​分​​​配​​​资​​​源​​​ — 比​​​如​​​ CPU 时​​​间​​​、​​​系​​​统​​​内​​​存​​​、​​​网​​​络​​​带​​​宽​​​或​​​者​​​这​​​些​​​资​​​源​​​的​​​组​​​合​​​。​​​可​​​以​​​监​​​控​​​​​​配​​​置​​​的​​​ cgroup，拒​​​绝​​​ cgroup 访​​​问​​​某​​​些​​​资​​​源​​​，甚​​​至​​​在​​​运​​​行​​​的​​​系​​​统​​​中​​​动​​​态​​​配​​​置​​​​cgroup。</p><p>主要功能:</p><p>限制资源使用，比如内存使用上限以及文件系统的缓存限制。</p><p>优先级控制，CPU利用和磁盘IO吞吐。</p><p>一些审计或一些统计，主要目的是为了计费。</p><p>挂起进程，恢复执行进程。</p><h2 id=cgroups子系统>cgroups子系统</h2><p>1、cpu 子系统</p><p>主要限制进程的 cpu 使用率。</p><p>2、cpuacct 子系统</p><p>可以统计 cgroups 中的进程的 cpu 使用报告。</p><p>3、cpuset 子系统</p><p>可以为 cgroups 中的进程分配单独的 cpu 节点或者内存节点。</p><p>4、memory 子系统</p><p>可以限制进程的 memory 使用量。</p><p>5、blkio 子系统</p><p>可以限制进程的块设备 io。</p><p>6、devices 子系统</p><p>可以控制进程能够访问某些设备。</p><p>7、net_cls 子系统</p><p>可以标记 cgroups 中进程的网络数据包，然后可以使用 tc 模块（traffic control）对数据包进行控制。</p><p>8、net_prio</p><p>用来设计网络流量的优先级</p><p>9、freezer 子系统</p><p>可以挂起或者恢复 cgroups 中的进程。</p><p>10、ns 子系统</p><p>可以使不同 cgroups 下面的进程使用不同的 namespace</p><p>11、hugetlb</p><p>主要针对于HugeTLB系统进行限制，这是一个大页文件系统。</p><h2 id=cgroups层级结构-hierarchy>cgroups层级结构(Hierarchy)</h2><p>内核使用 cgroup 结构体来表示一个 control group 对某一个或者某几个 cgroups 子系统的资源限制。cgroup 结构体可以组织成一颗树的形式，每一棵cgroup 结构体组成的树称之为一个 cgroups 层级结构。</p><p>cgroups层级结构可以 attach 一个或者几个 cgroups 子系统，当前层级结构可以对其 attach 的 cgroups 子系统进行资源的限制。每一个 cgroups 子系统只能被 attach 到一个 cpu 层级结构中。</p><p><img src=../imgs/20220107_os_1.png alt=20220107_os_1.png></p><p>创建了 cgroups 层级结构中的节点（cgroup 结构体）之后，可以把进程加入到某一个节点的控制任务列表中，一个节点的控制列表中的所有进程都会受到当前节点的资源限制。同时某一个进程也可以被加入到不同的 cgroups 层级结构的节点中，因为不同的 cgroups 层级结构可以负责不同的系统资源。所以说进程和 cgroup 结构体是一个多对多的关系。</p><h2 id=查看系统资源限制>查看系统资源限制</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>cat /proc/cgroups
</span></span></code></pre></td></tr></table></div></div></div><h2 id=cpu限制实战>CPU限制实战</h2><h3 id=查看cgroup挂载点>查看cgroup挂载点</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>mount -t cgroup
</span></span></code></pre></td></tr></table></div></div></div><h3 id=创建隔离组>创建隔离组</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> /sys/fs/cgroup/cpu  <span style=color:#177500># 进入cgroup挂载点</span>
</span></span><span style=display:flex><span>mkdir cpu_demo <span style=color:#177500># 创建目录后会自动生成文件</span>
</span></span><span style=display:flex><span>ls cpu_demo/ 
</span></span></code></pre></td></tr></table></div></div></div><h3 id=测试cpu>测试cpu</h3><p>死循环程序测试cpu</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>int main(void) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  int i=0;
</span></span><span style=display:flex><span>  for(;;) i++;
</span></span><span style=display:flex><span>  return 0;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>启动程序后cpu使用100%
默认-1不限制，现在改成30000，可以理解使用率限制在30%</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#1c01ce>30000</span> &gt; /sys/fs/cgroup/cpu/cpu_demo/cpu.cfs_quota_us
</span></span></code></pre></td></tr></table></div></div></div><p>找到进程号增加到cpu tasks里面，再看top  cpu使用率很快就下来<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> &lt;pid&gt; &gt;&gt; /sys/fs/cgroup/cpu/cpu_demo/tasks
</span></span></code></pre></td></tr></table></div></div></div></p><p>其他资源限制同cpu限制</p><h2 id=内存限制实战>内存限制实战</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ service sshd status
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>cd</span> /sys/fs/cgroup/memory/system.slice/sshd.service
</span></span><span style=display:flex><span><span style=color:#177500># 查看内存限制(byte)</span>
</span></span><span style=display:flex><span>$ cat memory.limit_in_bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 设置限制内存</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>echo</span> 64k &gt; memory.limit_in_bytes
</span></span><span style=display:flex><span>$ cat memory.limit_in_bytes
</span></span><span style=display:flex><span><span style=color:#1c01ce>65536</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=reference>Reference</h1><p><a href=https://www.cnblogs.com/menkeyi/p/10941843.html>Linux CGroup总结</a></p><p><a href=https://github.com/opencontainers/runtime-spec/blob/main/config-linux.md#control-groups>https://github.com/opencontainers/runtime-spec/blob/main/config-linux.md#control-groups</a></p><p><a href=https://man7.org/linux/man-pages/man7/cgroups.7.html>https://man7.org/linux/man-pages/man7/cgroups.7.html</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-b0668b92c1663805e02463fc783fb89c>2 - Linux负载均衡LVS之IPVS</h1><h1 id=名词概念>名词概念</h1><h2 id=lvs>LVS</h2><p>LVS（Linux Virtual Server）即Linux虚拟服务器，是一个虚拟的服务器集群系统，由<a href=https://baike.baidu.com/item/%E7%AB%A0%E6%96%87%E5%B5%A9>章文嵩</a>博士在1998年5月成立，在linux2.6+后将lvs自动加入了kernel模块。</p><p>LVS的用户空间的命令行管理工具为ipvsadm，ipvs是工作在内核中netfilter的INPUT的钩子函数上，对进入的报文在没有进入用户空间前，对这些报文进行操作。</p><h2 id=ipvs>IPVS</h2><p>IPVS是LVS（Linux Virtual Server）项目重要组成部分，目前包含于官方Linux Kernel，IPVS依赖于netfilter框架，位于内核源码的net/netfilter/ipvs目录下。</p><p><a href=http://www.linuxvirtualserver.org/software/ipvs.html>IPVS</a>是<a href=http://www.linuxvirtualserver.org/>LVS</a>项目的一部分，是一款运行在Linux kernel当中的4层负载均衡器，性能异常优秀。 </p><h2 id=rs>RS</h2><p>realserver，常简称为RS</p><h2 id=nat>NAT</h2><p>网络地址转换(Network Address Translate)</p><h2 id=snat>SNAT</h2><p>原地址转换</p><h2 id=dnat>DNAT</h2><p>目标地址转换</p><h2 id=几种ip>几种IP</h2><p><img src=../imgs/20220227_ipvs_1.png alt=20220227_ipvs_1.png></p><h3 id=vip>VIP</h3><p>virtual IP，LVS服务器上接收外网数据包的网卡IP地址。</p><h3 id=dip>DIP</h3><p>director IP，LVS服务器上转发数据包到realserver的网卡IP地址。</p><h3 id=rip>RIP</h3><p>realserver(常简称为RS)上接收Director转发数据包的IP，即提供服务的服务器IP。</p><p>CIP:客户端的IP。</p><h1 id=ipvs的三种转发模式>IPVS的三种转发模式</h1><h2 id=dr模式-direct-routing>DR模式(Direct Routing)</h2><p>DR模式下，客户端的请求包到达负载均衡器的虚拟服务IP端口后，负载均衡器不会改写请求包的IP和端口，但是会改写请求包的MAC地址为后端RS的MAC地址，然后将数据包转发；真实服务器处理请求后，响应包直接回给客户端，不再经过负载均衡器。所以DR模式的转发效率是最高的，特别适合下行流量较大的业务场景，比如请求视频等大文件。</p><h2 id=nat模式-network-address-translation>NAT模式(Network Address Translation)</h2><p>NAT模式下，请求包和响应包都需要经过LB处理。当客户端的请求到达虚拟服务后，LB会对请求包做目的地址转换（DNAT），将请求包的目的IP改写为RS的IP。当收到RS的响应后，LB会对响应包做源地址转换（SNAT），将响应包的源IP改写为LB的IP。</p><h2 id=tun模式>TUN模式</h2><p>采用NAT技术时，由于请求和响应报文都必须经过调度器地址重写，当客户请求越来越多时，调度器的处理能力将成为瓶颈。为了解决这个问题，调度器把请求报文通过IP隧道转发至真实服务器，而真实服务器将响应直接返回给客户，所以调度器只处理请求报文。由于一般网络服务响应报文比请求报文大许多，采用VS/TUN技术后，调度器得到极大的解放，集群系统的最大吞吐量可以提高10倍。</p><h2 id=fullnat模式>FULLNAT模式</h2><p>FULLNAT模式下，LB会对请求包和响应包都做SNAT+DNAT。</p><h1 id=转发模式对比>转发模式对比</h1><p>三种转发模式性能从高到低：DR > NAT >FULLNAT。</p><p>虽然FULLNAT模式的性能比不上DR和NAT，但是FULLNAT模式没有组网要求，允许LB和RS部署在不同的子网中，这给运维带来了便利。并且 FULLNAT模式具有更好的可拓展性，可以通过增加更多的LB节点，提升系统整体的负载均衡能力。</p><h1 id=ipvs实现service>IPVS实现Service</h1><h2 id=背景知识>背景知识</h2><p>一定要让Kernel认为VIP是本地地址，这样4层的LVS才能开始工作。</p><h2 id=网络结构>网络结构</h2><p><img src=../imgs/20220227_ipvs_2.png alt=20220227_ipvs_2.png></p><h2 id=步骤>步骤</h2><p>1、绑定VIP到本地（欺骗内核）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># ip route add to local 192.168.60.200/32 dev eth0proto kernel</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、为该虚IP创建一个IPVS的virtual server<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># ipvsadm -A -t 192.168.60.200:9376 -s rr -p 600</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>3、为该IPVS service创建相应的real server<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># ipvsadm -A -t 192.168.60.200:9376 -r 10.1.2.3:80 -m</span>
</span></span><span style=display:flex><span><span style=color:#177500># ipvsadm -A -t 192.168.60.200:9376 -r 10.1.4.5:80 -m</span>
</span></span><span style=display:flex><span><span style=color:#177500># ipvsadm -A -t 192.168.60.200:9376 -r 10.1.3.8:80 -m</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=reference>Reference</h1><p><a href=https://www.cnblogs.com/lipengxiang2009/p/7349271.html>Linux负载均衡LVS（IPVS）</a></p><p><a href=https://www.sohu.com/a/223150286_744906>应用负载均衡之LVS(一)：基本概念和三种模式</a></p><p><a href="https://www.bilibili.com/video/BV1XJ411s7cd?spm_id_from=333.999.0.0">IPVS实现Service</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-858d6a90d7f50022cacf13f6f44c398a>3 - shell</h1><h1 id=introduction>Introduction</h1><p>shell脚本相关</p></div><div class=td-content><h1 id=pg-87b710ee2a8cb64508663e95a4eb8f0b>3.1 - Shebang</h1><h1 id=简介>简介</h1><p>在计算机领域，Shebang（也称为Hashbang）是一个由井号和叹号构成的字符序列 <code>#!</code> ，其出现在文本文件中的第一行的前两个字符。</p><p>在文件中存在 Shebang 的情况下，类 Unix 操作系统的程序加载器会分析 Shebang 后的内容，将这些内容作为解释器指令，并调用该指令，并将载有 Shebang 的文件路径作为该解释器的参数。</p><p>例如，以指令 <code>#!/bin/sh</code> 开头的文件在执行时会实际调用 /bin/sh 程序。</p><p>由于 # 符号在许多脚本语言中都是注释标识符，Shebang 的内容会被这些脚本解释器自动忽略。 在 # 字符不是注释标识符的语言中，例如 <a href=https://zh.wikipedia.org/wiki/Scheme>Scheme</a>，解释器也可能忽略以 #! 开头的首行内容，以提供与 Shebang 的兼容性。</p><h1 id=env-bash>env bash</h1><p>使用方式：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#633820>#!/usr/bin/env bash
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=env-的作用>env 的作用</h2><p>env 命令用于显式系统中已存在的环境变量，以及在定义的环境中执行命令。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ ls /usr/bin | grep env
</span></span><span style=display:flex><span>env
</span></span><span style=display:flex><span>printenv
</span></span></code></pre></td></tr></table></div></div></div><p>与 <code>#!/bin/bash</code> 声明了 bash 所在位置，系统知道去哪里找 bash 相比， <code>#!/usr/bin/env bash</code> 只声明了 env 所在位置，然后去 $PATH 中找 bash 的位置。
比如执行 <code>env python</code> 时，它其实会去 <code>env | grep PATH</code> 中的几个路径中依次寻找 python 的可执行文件。</p><h1 id=env-bash和bash对比>env bash和bash对比</h1><h2 id=env-bash优缺点>env bash优缺点</h2><p>优点：</p><ul><li><p><code>#!/usr/bin/env bash</code> 不必在系统的特定位置查找命令解释器，为多系统间的移植提供了极大的灵活性和便利性（某些系统的一些命令解释器并不在 /bin 或一些约定的目录下，而是一些比较奇怪的目录）</p></li><li><p>不了解主机环境时，<code>#!/usr/bin/env bash</code> 可以使开发工作快速开展
缺点：</p></li><li><p>对安全性比较看重时，该写法会出现安全隐患</p></li></ul><blockquote><p>该写法会从 $PATH 中查找命令解释器所在的位置并匹配第一个找到的位置，这意味着可以伪造一个假的命令解释器，并将伪造后的命令解释器所在目录写入 PATH 环境变量中并位于靠前位置，这样就形成了安全隐患。</p></blockquote><ul><li>因为 Shebang 解析的设计导致无法传递多个多个参数</li></ul><blockquote><p>如 <code>#!/usr/bin/perl -w</code> 和 <code>#!/bin/csh -f</code> ，而如果使用 <code>#!/usr/bin/env perl -w</code> 这种写法的话，perl -w 会被当成一个参数，但根本找不到 perl -w 这个命令解释器，就会出错。</p></blockquote><ul><li>某些系统 env 命令的位置不在 /usr/bin 下</li></ul><h2 id=bash优缺点>bash优缺点</h2><p>优点：</p><ul><li><p>准确指出所需命令解释器的位置</p></li><li><p>安全性相对较高</p></li><li><p>可以传递多个参数
缺点：</p></li><li><p>移植性相对较差，很多系统的命令解释器位置不一致</p></li><li><p>一些命令解释器的位置记不住</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-490b491886e52a4b6a3f9d5eb09160a3>3.2 - curl&wget</h1><h2 id=curl>curl</h2><h3 id=语法>语法</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl <span style=color:#000>[</span>options<span style=color:#000>]</span> <span style=color:#000>[</span>URL...<span style=color:#000>]</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=参数说明>参数说明</h3><h4 id=d-data>-d/--data</h4><p>参数用于发送 POST 请求的数据体。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -d&#39;login=emma＆password=123&#39;-X POST https://google.com/login
</span></span><span style=display:flex><span># 或者
</span></span><span style=display:flex><span>curl -d &#39;login=emma&#39; -d &#39;password=123&#39; -X POST \
</span></span><span style=display:flex><span>https://google.com/login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 读取data.txt文件的内容发送
</span></span><span style=display:flex><span>curl -d &#39;@data.txt&#39; https://google.com/login
</span></span></code></pre></td></tr></table></div></div></div><p>1、--data
value如果是@a_file_name，表示数据来自一个文件，文件中的回车符和换行符将被转换</p><p>2、--data-ascii &lt;key=value></p><p>完全等价于-d</p><ol start=3><li>--data-binary key=value</li></ol><p>HTTP POST请求中的数据为纯二进制数据</p><p>value如果是@file_name，则保留文件中的回车符和换行符，不做任何转换</p><ol start=4><li>--data-raw key=value</li></ol><p>@也作为普通字符串，不会作为文件名给出文件名的标志。即value如果是@file_name，只表示值为“@file_name”的字符串。</p><p>其他等价于-d</p><ol start=5><li>--data-urlencode key=value</li></ol><p>基本同-d，区别在于会将发送的数据进行 URL 编码，如空格等</p><h4 id=f-fail><strong>-f/--fail</strong></h4><p>禁止服务器在打开页面失败或脚本调用失败时向客户端发送错误说明，取而代之，curl 会返回错误码 22</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># curl -fsSL https://get.docker.com | sh</span>
</span></span><span style=display:flex><span>curl -fsSL https://get.docker.com -o get-docker.sh
</span></span><span style=display:flex><span>sudo sh get-docker.sh
</span></span></code></pre></td></tr></table></div></div></div><h4 id=f-form>-F/--form</h4><p>模拟表单</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl -F <span style=color:#c41a16>&#34;image=@./1.png&#34;</span> http:xxx     
</span></span><span style=display:flex><span><span style=color:#177500># image 相当于&lt;input type=&#39;file&#39; name=&#39;image&#39;&gt;中name的value，@后面是文件路径</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=h-header>-H/--header</h4><p>增加头信息</p><h4 id=i>-i</h4><p>打印出服务器回应的 HTTP 标头。先输出服务器回应的标头，然后空一行，再输出网页的源码。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -i https://www.example.com
</span></span></code></pre></td></tr></table></div></div></div><h4 id=i-head>-I/--head</h4><p>向服务器发出 HEAD 请求，然会将服务器返回的 HTTP 标头打印出来。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -I https://www.example.com
</span></span></code></pre></td></tr></table></div></div></div><h4 id=l-location>-L/--location</h4><p>让 HTTP 请求跟随服务器的重定向。curl 默认不跟随重定向。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -L -d &#39;tweet=hi&#39; https://api.twitter.com/tweet
</span></span></code></pre></td></tr></table></div></div></div><h4 id=o-output>-o/--output</h4><p>将服务器的回应保存成文件，等同于wget命令</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -o example.html https://www.example.com
</span></span></code></pre></td></tr></table></div></div></div><h4 id=o>-O</h4><p>服务器回应保存成文件，并将 URL 的最后部分当作文件名</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl -O https://www.example.com/foo/bar.html <span style=color:#177500># 保存为bar.html</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=p-proxytunnel>-p/--proxytunnel</h4><h4 id=s>-s</h4><p>不输出错误和进度信息</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s https://www.example.com
</span></span><span style=display:flex><span>curl -s -o /dev/null https://google.com
</span></span></code></pre></td></tr></table></div></div></div><h4 id=s-1>-S</h4><p>参数指定只输出错误信息，通常与-o一起使用。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 没有任何输出，除非发生错误。</span>
</span></span><span style=display:flex><span>curl -S -o /dev/null https://google.com
</span></span></code></pre></td></tr></table></div></div></div><h4 id=v-verbose>-v/--verbose</h4><p>显示更多更详细的信息，调试时使用</p><h4 id=x>-x</h4><p>指定 HTTP 请求的代理，如果没有指定代理协议，默认为 HTTP。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -x socks5://james:cats@myproxy.com:8080 https://www.example.com
</span></span></code></pre></td></tr></table></div></div></div><h4 id=x-request>-X/--request</h4><p>指定 HTTP 请求的方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>curl -X POST https://www.example.com
</span></span></code></pre></td></tr></table></div></div></div><h3 id=实战>实战</h3><h4 id=连接是否可用>连接是否可用</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl 10.225.147.108:9669/ping/kitex
</span></span></code></pre></td></tr></table></div></div></div><h4 id=增加header>增加header</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl -H <span style=color:#c41a16>&#34;X-TT-ENV: boe_cloud_toolkits_debug_42&#34;</span> 10.225.147.108:9669/ping/kitex
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl --location --request POST <span style=color:#c41a16>&#39;https://xxx.xxx.org&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--header <span style=color:#c41a16>&#39;Token: e144c79a-14e8-4908-9edf-d24e02688b36&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--header <span style=color:#c41a16>&#39;X-TT-LOGID: 1234&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--header <span style=color:#c41a16>&#39;Content-Type: application/json&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--data-raw <span style=color:#c41a16>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;language&#34;: &#34;c&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;code&#34;: &#34;I2luY2x1ZGUgPHN0ZGlvLmg+CmludCBtYWluKCkKewogICBwcmludGYoIkhlbGxvLCBXb3JsZCBjISIpOwogICByZXR1cm4gMDsKfQ==&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#c41a16>&#39;http://xxx.xxx.net&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>-H <span style=color:#c41a16>&#39;Content-Type:application/json&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>-H <span style=color:#c41a16>&#39;Token:e144c79a-14e8-4908-9edf-d24e02688b36&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>-H <span style=color:#c41a16>&#39;X-TT-LOGID:1234567&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--data <span style=color:#c41a16>&#39;{&#34;language&#34;:&#34;c&#34;,&#34;code&#34;:&#34;I2luY2x1ZGUgPHN0ZGlvLmg+CmludCBtYWluKCkKewogICBwcmludGYoIkhlbGxvLCBXb3JsZCBjISIpOwogICByZXR1cm4gMDsKfQ==&#34;}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fmt.Sprintf<span style=color:#000>(</span><span style=color:#c41a16>&#34;curl -fsSL &#39;%s&#39; -o %s&#34;</span>, downloadURL, downloadPath<span style=color:#000>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -i -X POST <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span> -H <span style=color:#c41a16>&#34;Content-Type:application/json&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span> -d <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#c41a16>&#39;[
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;type&#34;: &#34;store&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;key&#34;: &#34;psmlist&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;value&#34;: 3,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;Tags&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      &#34;git&#34;: &#34;cli&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      &#34;username&#34;: &#34;zhangsan&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>]&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#c41a16>&#39;https://xxx.xxx.org/xxx&#39;</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=上传文件>上传文件</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> <span style=color:#c41a16>${</span><span style=color:#000>PRODUCT_OUTPUT_DIR</span><span style=color:#c41a16>}</span> <span style=color:#000>&amp;&amp;</span> curl --location --request POST <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#c41a16>&#39;xxx.xxx.org/repository/xxx&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--form <span style=color:#c41a16>&#34;file=@\&#34;</span><span style=color:#c41a16>${</span><span style=color:#000>BUILD_REPO_PACKAGE_NAME</span><span style=color:#c41a16>}</span><span style=color:#c41a16>.tar.gz\&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=获取当前机器ip>获取当前机器ip</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s http://ipinfo.io/ip
</span></span></code></pre></td></tr></table></div></div></div><h2 id=wget>wget</h2><h3 id=语法说明>语法说明</h3><h3 id=参数说明-1>参数说明</h3><h4 id=b>-b</h4><p>后台下载</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>wget -b https://xxx/xxx.tar.gz
</span></span><span style=display:flex><span><span style=color:#177500># 将把输出写入至 wget-log</span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看下载进度</span>
</span></span><span style=display:flex><span>tail -f wget-log
</span></span></code></pre></td></tr></table></div></div></div><h4 id=c-continue>-c/--continue</h4><p>断点续传</p><p>对于我们下载大文件时突然由于网络等原因中断非常有帮助，我们可以继续接着下载而不是重新下载一个文件</p><h4 id=i-1>-i</h4><p>下载多个文件</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt; filelist.txt 
</span></span><span style=display:flex><span>url1 
</span></span><span style=display:flex><span>url2 
</span></span><span style=display:flex><span>url3 
</span></span><span style=display:flex><span><span style=color:#177500># 接着使用这个文件和参数-i下载 </span>
</span></span><span style=display:flex><span>wget -i filelist.txt
</span></span></code></pre></td></tr></table></div></div></div><h4 id=reject>-reject</h4><p>过滤指定格式下载</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>wget –reject<span style=color:#000>=</span>gif url   <span style=color:#177500># 过滤gif图片下载某个网站</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=limit-rate>-limit-rate</h4><p>设置下载速率</p><h4 id=o-1>-o</h4><p>把下载信息存入日志文件而不是显示在终端</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>wget -o download.log URL
</span></span></code></pre></td></tr></table></div></div></div><h4 id=o-output-1>-O/--output</h4><p>下载并以不同文件名保存</p><p>下载到对应目录，并且修改文件名称</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>wget -O xxx.zip http://xxx/xxx
</span></span></code></pre></td></tr></table></div></div></div><h4 id=q-quiet>-q/--quiet</h4><p>安静模式（无信息输出）</p><h4 id=q-quota>-Q/--quota</h4><p>设置下载的容量限制</p><h4 id=v-verbose-1>-v/--verbose</h4><p>输出详细信息</p><h3 id=实战-1>实战</h3><h4 id=下载显示进度>下载显示进度</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>wget -q --show-progress --progress<span style=color:#000>=</span>dot:mega -O targetFilePath url
</span></span></code></pre></td></tr></table></div></div></div><h4 id=下载重命名>下载重命名</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>wget -c -O targetFilePath url
</span></span></code></pre></td></tr></table></div></div></div><h2 id=reference>Reference</h2><p><a href=https://www.ruanyifeng.com/blog/2019/09/curl-reference.html>curl用法指南</a></p><p><a href=https://www.ruanyifeng.com/blog/2011/09/curl.html>curl网站开发指南</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f80614d5954cbe084cff76fe7cb36a6b>3.3 - shell-find</h1><h2 id=find>find</h2><p>文件或目录查找</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 检索当前文件夹</span>
</span></span><span style=display:flex><span>find .  <span style=color:#177500># 同find . -print</span>
</span></span><span style=display:flex><span><span style=color:#177500># 检索指定文件夹</span>
</span></span><span style=display:flex><span>find dir
</span></span><span style=display:flex><span><span style=color:#177500># 多个目录</span>
</span></span><span style=display:flex><span>find dir1 dir2
</span></span></code></pre></td></tr></table></div></div></div><h3 id=name>-name</h3><p>按文件名搜索</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find ./dir -name <span style=color:#c41a16>&#34;test.txt&#34;</span>  <span style=color:#177500># 隐藏文件 &#34;.*&#34;</span>
</span></span><span style=display:flex><span><span style=color:#177500># 模糊匹配</span>
</span></span><span style=display:flex><span>find ./dir -name <span style=color:#c41a16>&#34;*.txt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#177500># 忽略大小写</span>
</span></span><span style=display:flex><span>find ./dir -iname <span style=color:#c41a16>&#34;test.txt&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=not或>-not或!</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find ./dir -not -name <span style=color:#c41a16>&#34;*.txt&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#177500># 等同</span>
</span></span><span style=display:flex><span>find ./dir ! -name <span style=color:#c41a16>&#34;*.txt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#177500># 多条件检索</span>
</span></span><span style=display:flex><span>find ./dir -name <span style=color:#c41a16>&#39;test&#39;</span> ! -name <span style=color:#c41a16>&#34;*.txt&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=maxdepth>-maxdepth</h3><p>限制目录遍历深度</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find ./dir -maxdepth <span style=color:#1c01ce>2</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=type>-type</h3><p>文件类型</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 仅查询文件</span>
</span></span><span style=display:flex><span>-type f 
</span></span><span style=display:flex><span><span style=color:#177500># 仅查询目录</span>
</span></span><span style=display:flex><span>-type d
</span></span></code></pre></td></tr></table></div></div></div><h3 id=perm>-perm</h3><p>访问权限</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find ./dir --perm <span style=color:#1c01ce>0777</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 2&gt;/dev/null 表示去掉“Permission Denied”的条目</span>
</span></span><span style=display:flex><span>find / -maxdepth <span style=color:#1c01ce>2</span> -perm /u<span style=color:#000>=</span>s 2&gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查找只读文件 </span>
</span></span><span style=display:flex><span>-perm /u<span style=color:#000>=</span>r
</span></span><span style=display:flex><span><span style=color:#177500># 查找可执行文件 </span>
</span></span><span style=display:flex><span>-perm /a<span style=color:#000>=</span>x
</span></span></code></pre></td></tr></table></div></div></div><h3 id=user>-user</h3><p>查找属于特定用户</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find dir -user zhangsan
</span></span></code></pre></td></tr></table></div></div></div><h3 id=group>-group</h3><p>查找属于特定组</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find dir -group zhangsan
</span></span></code></pre></td></tr></table></div></div></div><h3 id=time>-time</h3><p>基于修改时间的检索</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 过去N天之内修改的文件</span>
</span></span><span style=display:flex><span>-mtime <span style=color:#1c01ce>10</span>  <span style=color:#177500># +30 30天以前   -1 1天以内</span>
</span></span><span style=display:flex><span><span style=color:#177500># 过去N天之内访问的文件</span>
</span></span><span style=display:flex><span>-atime <span style=color:#1c01ce>10</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=size>-size</h3><p>基于文件大小检索</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-size 50M
</span></span><span style=display:flex><span><span style=color:#177500># 大于xx小于xx</span>
</span></span><span style=display:flex><span>-size +50M -size -100M
</span></span><span style=display:flex><span>-size +10k
</span></span></code></pre></td></tr></table></div></div></div><h2 id=高级用法>高级用法</h2><h3 id=xargs>xargs</h3><p>与管道一起用</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># {} 替换前面的输出，&#34;\;&#34;固定格式</span>
</span></span><span style=display:flex><span>|xargs rm -rf <span style=color:#000>{}</span> <span style=color:#c41a16>\;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>失效情况，不是所有情况都可以用<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>|xargs cp <span style=color:#000>{}</span> /tmp/ <span style=color:#c41a16>\;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>可以换成-exec</p><h3 id=exec>-exec</h3><p>使用范围更广（推荐），不需要管道</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find . -name <span style=color:#c41a16>&#34;*.txt&#34;</span> -exec cp -r <span style=color:#000>{}</span> /tmp/ <span style=color:#c41a16>\;</span>
</span></span><span style=display:flex><span><span style=color:#177500># 循环遍历当前目录下最大的5个文件</span>
</span></span><span style=display:flex><span>find . -type f -exec ls -s <span style=color:#000>{}</span> <span style=color:#c41a16>\;</span> | sort -n -r | head -5
</span></span></code></pre></td></tr></table></div></div></div><h2 id=实战>实战</h2><h3 id=将所有文件和目录都恢复成644和755>将所有文件和目录都恢复成644和755</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find . -type f -exec chmod -R <span style=color:#1c01ce>644</span> <span style=color:#000>{}</span> <span style=color:#c41a16>\;</span>
</span></span><span style=display:flex><span>find . -type d -exec chmod -R <span style=color:#1c01ce>755</span> <span style=color:#000>{}</span> <span style=color:#c41a16>\;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=删除30天以前的日志>删除30天以前的日志</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>find . -type f -name <span style=color:#c41a16>&#34;*.log&#34;</span> -mtime +30 -exec rm -rf <span style=color:#000>{}</span> <span style=color:#c41a16>\;</span>
</span></span></code></pre></td></tr></table></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a3de2a40d38dbc6507897dc1601203d6>3.4 - shell文本处理三剑客</h1><h1 id=grep>grep</h1><p>grep 命令用于查找文件里符合条件的字符串。</p><h2 id=语法>语法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>grep <span style=color:#000>[</span>-abcEFGhHilLnqrsvVwxy<span style=color:#000>]</span><span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>[</span>-A&lt;显示行数&gt;<span style=color:#000>][</span>-B&lt;显示列数&gt;<span style=color:#000>][</span>-C&lt;显示列数&gt;<span style=color:#000>][</span>-d&lt;进行动作&gt;<span style=color:#000>]</span><span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>[</span>-e&lt;范本样式&gt;<span style=color:#000>][</span>-f&lt;范本文件&gt;<span style=color:#000>][</span>--help<span style=color:#000>][</span>范本样式<span style=color:#000>][</span>文件或目录...<span style=color:#000>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>grep <span style=color:#c41a16>&#34;root&#34;</span> /etc/passwd
</span></span></code></pre></td></tr></table></div></div></div><p>egrep是grep命令的扩展</p><h3 id=a或-text><strong>-a或--text</strong> </h3><p>不要忽略二进制的数据，以文本文件方式搜索</p><h3 id=c>-c</h3><p>计算找到符合行的次数</p><h3 id=color>--color</h3><p>对查找到的文本颜色标红</p><h3 id=n-或-line-number>-n 或 --line-number</h3><p>在显示符合样式的那一行之前，标示出该行的列数编号。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>grep -n --color <span style=color:#c41a16>&#34;root&#34;</span> /etc/passwd
</span></span></code></pre></td></tr></table></div></div></div><h3 id=v或-invert-match><strong>-v或--invert-match</strong> </h3><p>反向选择，显示不包含匹配文本的所有行。</p><h3 id=h>-h</h3><p>查询多文件时不显示文件名</p><h3 id=i>-i</h3><p>不区分大小写</p><h3 id=l>-l</h3><p>查询多文件时只输出包含匹配字符的文件名</p><h3 id=v>-v</h3><p>取反</p><h3 id=s>-s</h3><p>不显示不存在或无匹配文本的错误信息</p><h3 id=和>^和$</h3><p>^表示以xx字符开头，$表示以什么结尾</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>grep <span style=color:#c41a16>&#34;^root&#34;</span> /etc/passwd
</span></span></code></pre></td></tr></table></div></div></div><h2 id=正则表达式>正则表达式</h2><p>^：锚定行的开头</p><p>$：锚定行的结尾</p><p>"."：点匹配一个非换行符的字符</p><p>"*"：匹配零个或多个先前字符</p><p>".*"：一起用代表任意字符</p><p>[]：匹配一个指定范围内的字符，如"[Gg]rep"匹配Grep和grep</p><p>[^]：匹配一个不再指定范围内的字符，</p><p>{}：匹配次数，{2}表示2次，{1-3}表示1到3次</p><h2 id=实战>实战</h2><h3 id=前后几行>前后几行</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 匹配行及后5行，不区分大小写</span>
</span></span><span style=display:flex><span>grep -A <span style=color:#1c01ce>5</span> -i foo file
</span></span><span style=display:flex><span><span style=color:#177500># 匹配行及前5行，不区分大小写</span>
</span></span><span style=display:flex><span>grep -B <span style=color:#1c01ce>5</span> -i foo file
</span></span><span style=display:flex><span><span style=color:#177500># 匹配行及前后5行，不区分大小写</span>
</span></span><span style=display:flex><span>grep -C <span style=color:#1c01ce>5</span> -i foo file
</span></span></code></pre></td></tr></table></div></div></div><h3 id=调试命令技巧>调试命令技巧</h3><p>使用--color高亮查看grep命令的匹配结果</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>grep <span style=color:#c41a16>&#34;[0-9][0-9]&#34;</span> test.txt
</span></span></code></pre></td></tr></table></div></div></div><h3 id=去除-号行内容和空行>去除#号行内容和空行</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>grep -v <span style=color:#c41a16>&#34;#&#34;</span> /usr/local/nginx/conf/nginx.conf.default | grep -v <span style=color:#c41a16>&#34;^</span>$<span style=color:#c41a16>&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=匹配ip>匹配ip</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>egrep <span style=color:#c41a16>&#34;[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}</span>$<span style=color:#c41a16>&#34;</span> test.txt
</span></span><span style=display:flex><span><span style=color:#177500># $表示最后最多只匹配3位数字，$表示结尾</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>#简化</span>
</span></span><span style=display:flex><span>egrep <span style=color:#c41a16>&#34;([0-9]{1,3}\.){3}[0-9]{1,3}</span>$<span style=color:#c41a16>&#34;</span> test.txt
</span></span></code></pre></td></tr></table></div></div></div><h1 id=awk>awk</h1><p>AWK 是一种处理文本文件的语言，是一个强大的文本分析工具。</p><h2 id=语法-1>语法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>awk <span style=color:#000>[</span>选项参数<span style=color:#000>]</span> <span style=color:#c41a16>&#39;script&#39;</span> <span style=color:#000>var</span><span style=color:#000>=</span>value file<span style=color:#000>(</span>s<span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#177500># 或</span>
</span></span><span style=display:flex><span>awk <span style=color:#000>[</span>选项参数<span style=color:#000>]</span> -f scriptfile <span style=color:#000>var</span><span style=color:#000>=</span>value file<span style=color:#000>(</span>s<span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=f>-F</h3><p>指定分割字符（默认以空格为分割字符）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 用法</span>
</span></span><span style=display:flex><span>-F: 或 -F<span style=color:#c41a16>&#34;:&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 以 : 为分割字符，打印前5行的第1列和最后1列</span>
</span></span><span style=display:flex><span>awk -F: <span style=color:#c41a16>&#39;{print $1,$NF}&#39;</span> /etc/passwd | head -5
</span></span><span style=display:flex><span><span style=color:#177500># 以空格分割打印</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 指定以 : 分割打印</span>
</span></span><span style=display:flex><span>awk -F: <span style=color:#c41a16>&#39;{print $1&#34;:&#34;$NF}&#39;</span> /etc/passwd | head -5
</span></span></code></pre></td></tr></table></div></div></div><h3 id=v-1>-v</h3><p>设置变量</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 数字直接加，字符串拼接</span>
</span></span><span style=display:flex><span>awk -va<span style=color:#000>=</span><span style=color:#1c01ce>1</span> <span style=color:#c41a16>&#39;{print $1,$1+a}&#39;</span> test.txt 
</span></span><span style=display:flex><span>awk -va<span style=color:#000>=</span><span style=color:#1c01ce>1</span> -vb<span style=color:#000>=</span>s <span style=color:#c41a16>&#39;{print $1,$1+a,$1b}&#39;</span> test.txt
</span></span></code></pre></td></tr></table></div></div></div><h2 id=内建变量>内建变量</h2><h3 id=n>$n</h3><p>当前记录的第n个字段，字段间由FS分隔</p><h3 id=0>$0</h3><p>完整记录</p><h3 id=fs>FS</h3><p>字段分隔符(默认是任何空格)</p><h3 id=nf>NF</h3><p>表示一行记录的个数</p><h3 id=nr>NR</h3><p>表示文本的行数（记录数）</p><h2 id=实战-1>实战</h2><h3 id=打印第x列>打印第x列</h3><p>默认以空格为间隔</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 打印第1列</span>
</span></span><span style=display:flex><span>awk <span style=color:#c41a16>&#39;{print $1}&#39;</span> test.txt
</span></span><span style=display:flex><span><span style=color:#177500># 打印第3列</span>
</span></span><span style=display:flex><span>awk <span style=color:#c41a16>&#39;{print $3}&#39;</span> test.txt
</span></span><span style=display:flex><span><span style=color:#177500># 打印最后1列</span>
</span></span><span style=display:flex><span>awk <span style=color:#c41a16>&#39;{print $NF}&#39;</span> test.txt
</span></span><span style=display:flex><span><span style=color:#177500># 打印倒数第2列</span>
</span></span><span style=display:flex><span>awk <span style=color:#c41a16>&#39;{print $(NF-1)}&#39;</span> test.txt
</span></span></code></pre></td></tr></table></div></div></div><h3 id=打印本机ip>打印本机ip</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># linux查找ip</span>
</span></span><span style=display:flex><span>ifconfig | grep <span style=color:#c41a16>&#34;inet addr:&#34;</span> | grep -v <span style=color:#c41a16>&#34;127.0.0.1&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| awk <span style=color:#c41a16>&#39;{print $2}&#39;</span> | awk -F<span style=color:#c41a16>&#34;addr:&#34;</span> <span style=color:#c41a16>&#39;{print $2}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 将ip的点换成-</span>
</span></span><span style=display:flex><span>xx接上
</span></span><span style=display:flex><span>| awk -F. <span style=color:#c41a16>&#39;{print $1&#34;-&#34;$2&#34;-&#34;$3&#34;-&#34;$4}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#177500># 一般机房主机名</span>
</span></span><span style=display:flex><span>| awk -F. <span style=color:#c41a16>&#39;{print &#34;xx-WEB&#34;$1&#34;-&#34;$2&#34;-&#34;$3&#34;-&#34;$4&#34;.xx.net&#34;}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 修改主机名，反引号表示当做一串命令执行</span>
</span></span><span style=display:flex><span>host <span style=color:#c41a16>`</span>ifconfig | grep <span style=color:#c41a16>&#34;inet addr:&#34;</span> | grep -v <span style=color:#c41a16>&#34;127.0.0.1&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| awk <span style=color:#c41a16>&#39;{print $2}&#39;</span> | awk -F<span style=color:#c41a16>&#34;addr:&#34;</span> <span style=color:#c41a16>&#39;{print $2}&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| awk -F. <span style=color:#c41a16>&#39;{print &#34;xx-WEB&#34;$1&#34;-&#34;$2&#34;-&#34;$3&#34;-&#34;$4&#34;.xx.net&#34;}&#39;</span><span style=color:#c41a16>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># mac查找ip</span>
</span></span><span style=display:flex><span>ifconfig | grep <span style=color:#c41a16>&#34;inet &#34;</span> | grep -v <span style=color:#c41a16>&#34;127.0.0.1&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| awk <span style=color:#c41a16>&#39;{print $2}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=sed>sed</h1><p>sed 命令是利用脚本来处理文本文件。</p><p>注意：<strong>sed里面有变量必须用双引号</strong></p><h2 id=语法-2>语法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>sed [-hnV][-e&lt;script&gt;][-f&lt;script文件&gt;][文本文件]
</span></span></code></pre></td></tr></table></div></div></div><h3 id=i-1>-i</h3><p>修改文件内容</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>sed -i <span style=color:#c41a16>&#39;s/old/new/2&#39;</span> test.txt  <span style=color:#177500># 不加-i不修改文件内容</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=s-取代>s 取代</h3><p>字符替换</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>格式：
</span></span><span style=display:flex><span>s///g 或者 s###g 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 替换第1个old字符</span>
</span></span><span style=display:flex><span>sed <span style=color:#c41a16>&#39;s/old/new/1&#39;</span> test.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 替换第2个old字符</span>
</span></span><span style=display:flex><span>sed <span style=color:#c41a16>&#39;s/old/new/2&#39;</span> test.txt 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 全部替换</span>
</span></span><span style=display:flex><span>sed <span style=color:#c41a16>&#39;s/old/new/g&#39;</span> test.txt 
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>sed -e &#34;0,/\&#34;name\&#34;:.*$/s//\&#34;name\&#34;: \&#34;$mount_docker_path\&#34;/1&#34; daemon.json
</span></span></code></pre></td></tr></table></div></div></div><p>问题：
行尾逗号比较难处理</p><p>sed参考：</p><p><a href=https://wangchujiang.com/linux-command/c/sed.html>https://wangchujiang.com/linux-command/c/sed.html</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c3ac6af8c8745d6d3daa083e31eb18ed>3.5 - shell解析json</h1><h1 id=背景>背景</h1><p>写一个自动安装程序的脚本，脚本需要查询接口最近的版本号从而拼接链接去下载固定的版本程序。但是之前解析json用的是jq，有一定的依赖性，虽然针对LInux没有安装jq脚本会帮忙自动安装，但是对于mac或其他平台没有做适配。鉴此，打算增加一个兜底逻辑，没有安装jq就自动解析字符串json</p><h2 id=heading></h2><h1 id=目标>目标</h1><p>解析json数组中第一个对象的固定字段。如下需要解析出"1.0.0.59"：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>[{
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;version&#34;</span>: <span style=color:#c41a16>&#34;1.0.0.59&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;arch&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;x86_64&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;type&#34;</span>: <span style=color:#c41a16>&#34;online&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;create_user&#34;</span>: <span style=color:#c41a16>&#34;zhangsan&#34;</span>
</span></span><span style=display:flex><span>},
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;version&#34;</span>: <span style=color:#c41a16>&#34;1.0.0.58&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;arch&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;x86_64&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;type&#34;</span>: <span style=color:#c41a16>&#34;online&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;create_user&#34;</span>: <span style=color:#c41a16>&#34;zhangsan&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>]
</span></span></code></pre></td></tr></table></div></div></div><h1 id=涉及命令>涉及命令</h1><h2 id=sed>sed</h2><p>主要做字符替换</p><p>全局字符替换</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>sed <span style=color:#c41a16>&#39;s/old_str/new_str/g&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=grep>grep</h2><p>主要负责行查找</p><h2 id=awk>awk</h2><p>主要做列解析</p><p>取第一行</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>awk <span style=color:#c41a16>&#39;NR==1&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>取第一列<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>awk <span style=color:#c41a16>&#39;{print $1}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=实战>实战</h1><p>脚本名为：parse_json.sh，文件名为json.txt</p><h2 id=grep处理字符串和文件的区别>grep处理字符串和文件的区别</h2><p>首先，解析出version行的内容。</p><p>grep处理多行文件和一行文件是有区别的。</p><p><strong>获取version行命令</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># echo $(cat &#34;json.txt&#34; | grep &#34;version&#34;)</span>
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span> | grep <span style=color:#c41a16>&#34;version&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>如处理上文中多行文件输出：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>&#34;version&#34;: &#34;1.0.0.59&#34;, &#34;version&#34;: &#34;1.0.0.58&#34;,
</span></span></code></pre></td></tr></table></div></div></div></p><p>但如果使用以下命令将文件处理成一行：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span><span style=color:#a90d91>)</span> &gt; <span style=color:#c41a16>&#34;json2.txt&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>然后将执行 “获取version行命令” (修改文件名为json2.txt)<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#c41a16>&#34;json2.txt&#34;</span> | grep <span style=color:#c41a16>&#34;version&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>此时输出的是整个一行文件。问题原因：grep是按行来区分的。</p><blockquote><p>如果将多行文件内容硬编码在脚本里也是当做一行处理的！！错误效果同上</p></blockquote><h2 id=sed替换-为多行>sed替换,为多行</h2><p>解决上面问题需要用到 sed将“,”替换成“
”，</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#c41a16>&#34;json2.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span> | grep <span style=color:#c41a16>&#34;version&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>结果依然是一行文件，原因：grep不能识别其中的换行符。</p><h2 id=echo-e识别换行符>echo -e识别换行符</h2><p>可以借助 echo -e 识别换行符。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json2.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> | grep <span style=color:#c41a16>&#34;version&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>或增加中间变量，效果相同：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>s1</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> -e <span style=color:#000>$info</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span><span style=color:#177500># echo -e &#34;s1:</span>
</span></span><span style=display:flex><span><span style=color:#c41a16>${</span><span style=color:#000>s1</span><span style=color:#c41a16>}</span><span style=color:#c41a16>&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16># echo -e &#34;</span>s2:
</span></span><span style=display:flex><span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> -e <span style=color:#000>$s1</span> | grep <span style=color:#c41a16>&#34;version&#34;</span><span style=color:#a90d91>)</span><span style=color:#c41a16>&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>echo -e </span><span style=color:#000>$s1</span><span style=color:#c41a16> | grep &#34;</span>version<span style=color:#c41a16>&#34;
</span></span></span></code></pre></td></tr></table></div></div></div></p><h2 id=兼容一行或多行>兼容一行或多行</h2><p>不管一行多行将其先转成一行，在根据“,”转成多行</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| grep <span style=color:#c41a16>&#34;version&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这样不管文件内容如何多行或几行串在一行都不会影响最终解析结果，如1，2，3行一行，其余都是一行；或者version跟版本号不在一行 等等情况。</p><h2 id=awk取第一行>awk取第一行</h2><p>不管文件内容如何变动，执行以下命令都能稳定获取结果</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| grep <span style=color:#c41a16>&#34;version&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| awk <span style=color:#c41a16>&#39;NR==1&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>结果为：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>[{ &#34;version&#34;: &#34;1.0.0.59&#34;
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=sed按照-分割成两行>sed按照:分割成两行</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| grep <span style=color:#c41a16>&#34;version&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| awk <span style=color:#c41a16>&#39;NR==1&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/:/\n/g&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>删除第一行<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span><span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | grep <span style=color:#c41a16>&#34;version&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | awk <span style=color:#c41a16>&#39;NR==1&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | sed <span style=color:#c41a16>&#39;s/:/\n/g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;1d&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>得到：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span> <span style=color:#c41a16>&#34;1.0.0.59&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=sed去除-和空格>sed去除"和空格</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span><span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | grep <span style=color:#c41a16>&#34;version&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | awk <span style=color:#c41a16>&#39;NR==1&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | sed <span style=color:#c41a16>&#39;s/:/\n/g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;1d&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/&#34;/\ /g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/ //g&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>得到最终结果<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>1.0.0.59
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=暴力测试>暴力测试</h2><p>将json字符串任意换行（不破坏引号内字符串内容），结果都是正确的</p><h1 id=相关文件>相关文件</h1><h2 id=parse-json-sh>parse_json.sh</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#633820>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#633820></span><span style=color:#177500># set -x </span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>json_content</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>[{
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;version&#34;: &#34;1.0.0.59&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;arch&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#c41a16>            &#34;x86_64&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        ],
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;type&#34;: &#34;online&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;create_user&#34;: &#34;zhangsan&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>},
</span></span></span><span style=display:flex><span><span style=color:#c41a16>{
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;version&#34;: &#34;1.0.0.58&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;arch&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#c41a16>            &#34;x86_64&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        ],
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;type&#34;: &#34;online&#34;,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;create_user&#34;: &#34;zhangsan&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>]&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 解析文件</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span><span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;json2.txt&#34;</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | grep <span style=color:#c41a16>&#34;version&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | awk <span style=color:#c41a16>&#39;NR==1&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | sed <span style=color:#c41a16>&#39;s/:/\n/g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;1d&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/&#34;/\ /g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/ //g&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 解析字符串，或去掉echo -e $json_content中的-e 表示不转换换行</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span><span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>echo</span> -e <span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> -e <span style=color:#000>$json_content</span> | sed <span style=color:#c41a16>&#39;s/\n//g&#39;</span> | sed <span style=color:#c41a16>&#39;s/,/\n/g&#39;</span><span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | grep <span style=color:#c41a16>&#34;version&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | awk <span style=color:#c41a16>&#39;NR==1&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    | sed <span style=color:#c41a16>&#39;s/:/\n/g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>    <span style=color:#a90d91>)</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;1d&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/&#34;/\ /g&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sed <span style=color:#c41a16>&#39;s/ //g&#39;</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=json-txt>json.txt</h2><p>见本文开头</p><h2 id=json2-txt>json2.txt</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>[{   
</span></span><span style=display:flex><span>         &#34;version&#34;:
</span></span><span style=display:flex><span> &#34;1.0.0.59&#34;, &#34;arch&#34;: [ &#34;x86_64&#34; ], &#34;type&#34;: &#34;online&#34;, &#34;create_user&#34;: &#34;zhangsan&#34; }, { &#34;version&#34;: 
</span></span><span style=display:flex><span> &#34;1.0.0.58&#34;, &#34;arch&#34;: [ &#34;x86_64&#34; ], &#34;type&#34;: &#34;online&#34;, 
</span></span><span style=display:flex><span> &#34;create_user&#34;: &#34;zhangsan&#34; } ]
</span></span></code></pre></td></tr></table></div></div></div><h2 id=运行脚本>运行脚本</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>bash parse_json.sh
</span></span></code></pre></td></tr></table></div></div></div><h1 id=jq解析>jq解析</h1><h2 id=安装>安装</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>brew install jq <span style=color:#177500># 失败可以使用port安装</span>
</span></span><span style=display:flex><span>sudo port install jq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt-get install jq
</span></span></code></pre></td></tr></table></div></div></div><h2 id=解析json>解析json</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#c41a16>&#34;json2.txt&#34;</span> | jq -r <span style=color:#c41a16>&#39;.[0].version&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#000>$json_content</span> | jq -r <span style=color:#c41a16>&#39;.[0].version&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> -e <span style=color:#000>$json_content</span> | jq -r <span style=color:#c41a16>&#39;.[0].version&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=tips>tips</h1><h2 id=sed替换>sed替换[</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>sed <span style=color:#c41a16>&#39;s/[/ /g&#39;</span>  <span style=color:#177500># 可能需要增加个空格？</span>
</span></span></code></pre></td></tr></table></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-217d9697cd7dc2705202d21fc0e09835>3.6 - 获取程序当前路径有多麻烦</h1><h1 id=背景>背景</h1><p>为了实现程序自己更新自己，需要获取当前程序的安装路径。</p><h1 id=程序执行方式>程序执行方式</h1><p>程序可以通过如下几种方式来执行：</p><h2 id=软链接>软链接</h2><p>通过软链接执行程序</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 生成软链接</span>
</span></span><span style=display:flex><span>ln -s /Users/bo/util-cli/util-cli_darwin_amd64 /usr/local/bin/util-cli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 1、在 非/usr/local/bin路径下执行</span>
</span></span><span style=display:flex><span>util-cli
</span></span><span style=display:flex><span><span style=color:#177500># 2、在/usr/local/bin路径下执行</span>
</span></span><span style=display:flex><span>util-cli
</span></span></code></pre></td></tr></table></div></div></div><h2 id=相对路径>相对路径</h2><p>如以下命令：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 1、当前路径</span>
</span></span><span style=display:flex><span>./util-cli_darwin_amd64
</span></span><span style=display:flex><span><span style=color:#177500># 2、父目录</span>
</span></span><span style=display:flex><span>./install_dir/util-cli_darwin_amd64
</span></span><span style=display:flex><span><span style=color:#177500># 3、当前路径</span>
</span></span><span style=display:flex><span>../install_dir/util-cli_darwin_amd64
</span></span></code></pre></td></tr></table></div></div></div><h2 id=alias>alias</h2><p>通过在 .bash_profile或 .bash_rc 中配置 alias 的方式来执行</p><p>注意：脚本配置 alias 需要用 source 执行脚本而不是 bash 等，否则alias不会生效</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>alias</span> util-cli<span style=color:#000>=</span><span style=color:#c41a16>&#34;/Users/bo/util-cli/util-cli_darwin_amd64&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=解决方案>解决方案</h1><p>针对以上三个类情况对文件安装目录进行解析，然后安装替换。</p><h2 id=运行程序名称>运行程序名称</h2><p>通过os.Args[0] 来获取程序运行名称。</p><h3 id=软链接方式>软链接方式</h3><p>程序名称为输入的程序名称，如 util-cli</p><h3 id=相对路径-1>相对路径</h3><p>同上，程序名称为输入的程序名称，如</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>./install_dir/util-cli_darwin_amd64
</span></span><span style=display:flex><span><span style=color:#177500># 或</span>
</span></span><span style=display:flex><span>./install_dir/util-cli_darwin_amd64  <span style=color:#177500># 等</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=alias-1>alias</h3><p>程序名称为文件全路径，如</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>/Users/bo/util-cli/util-cli_darwin_amd64
</span></span></code></pre></td></tr></table></div></div></div><h2 id=which-type>which/type</h2><p>可通过 which type 等命令来获取其软链地址</p><p>注意：</p><p>1、which、type 不可获取 alias 地址，尤其是 sh -c which/type xxx会报错</p><p>2、程序运行时，which、type获取不到alias的别名信息，与环境有关</p><h2 id=pwd>pwd</h2><p>通过pwd或者os.Getwd()来获取当前运行路径，然后拼接运行程序名获取全路径，可解决 相对路径 执行方式</p><h1 id=核心解决思路>核心解决思路</h1><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ls -ld <span style=color:#a90d91>$(</span>programName<span style=color:#a90d91>)</span> | awk <span style=color:#c41a16>&#39;{print $(NF)}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该命令可解决 软链在其目录下 和 alias 的执行方式
其他情况可搭配 which pwd 处理</p><h1 id=程序代码>程序代码</h1><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>getProgramRealDir</span>(<span style=color:#000>programName</span> <span style=color:#a90d91>string</span>) (<span style=color:#a90d91>string</span>, <span style=color:#a90d91>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#000>programPath</span>, <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>util</span>.<span style=color:#000>ShellExecWithWorkDir</span>(<span style=color:#000>fmt</span>.<span style=color:#000>Sprintf</span>(<span style=color:#c41a16>&#34;ls -ld %s | awk &#39;{print $(NF)}&#39;&#34;</span>, <span style=color:#000>programName</span>), <span style=color:#c41a16>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;&#34;</span>, <span style=color:#000>err</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#000>realDir</span> <span style=color:#000>:=</span> <span style=color:#c41a16>&#34;&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// ln -s, not in /usr/local/bin
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>strings</span>.<span style=color:#000>HasSuffix</span>(<span style=color:#000>programPath</span>, <span style=color:#c41a16>&#34;No such file or directory&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#000>lnCmdPath</span>, <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>util</span>.<span style=color:#000>ShellExecWithWorkDir</span>(<span style=color:#000>fmt</span>.<span style=color:#000>Sprintf</span>(<span style=color:#c41a16>&#34;which %s&#34;</span>, <span style=color:#000>programName</span>), <span style=color:#c41a16>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;&#34;</span>, <span style=color:#000>err</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#000>realDir</span>, <span style=color:#000>err</span> = <span style=color:#000>util</span>.<span style=color:#000>ShellExecWithWorkDir</span>(<span style=color:#000>fmt</span>.<span style=color:#000>Sprintf</span>(<span style=color:#c41a16>&#34;ls -ld %s | awk &#39;{print $(NF)}&#39;&#34;</span>, <span style=color:#000>lnCmdPath</span>), <span style=color:#c41a16>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;&#34;</span>, <span style=color:#000>err</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>filepath</span>.<span style=color:#000>Dir</span>(<span style=color:#000>realDir</span>), <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>   } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#177500>// alias and ln -s in /usr/local/bin
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>realDir</span> = <span style=color:#000>filepath</span>.<span style=color:#000>Dir</span>(<span style=color:#000>programPath</span>)
</span></span><span style=display:flex><span>      <span style=color:#177500>// relative path
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>strings</span>.<span style=color:#000>HasPrefix</span>(<span style=color:#000>programPath</span>, <span style=color:#c41a16>&#34;.&#34;</span>) {
</span></span><span style=display:flex><span>         <span style=color:#000>pwd</span>, <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>os</span>.<span style=color:#000>Getwd</span>()
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;&#34;</span>, <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#000>programDir</span> <span style=color:#000>:=</span> <span style=color:#000>filepath</span>.<span style=color:#000>Dir</span>(<span style=color:#000>programPath</span>)
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>programDir</span> <span style=color:#000>==</span> <span style=color:#c41a16>&#34;.&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>realDir</span> = <span style=color:#000>pwd</span>
</span></span><span style=display:flex><span>         } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>realDir</span> = <span style=color:#000>fmt</span>.<span style=color:#000>Sprintf</span>(<span style=color:#c41a16>&#34;%s/%s&#34;</span>, <span style=color:#000>pwd</span>, <span style=color:#000>programDir</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>realDir</span>, <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></div><div class=td-content style=page-break-before:always><h1 id=pg-0659b8fad1f0a169ddb5df2f7c111fdd>4 - 进程</h1><h1 id=introduction>Introduction</h1><p>进程相关</p></div><div class=td-content><h1 id=pg-96f3d1bcce14bd1e11a43f2c64a1c481>4.1 - Linux后台进程</h1><h1 id=背景>背景</h1><p>使用终端程序启动应用时，一旦退出命令行窗口，应用就会一起退出，无法继续运行。怎么将它变成系统的守护进程（daemon），成为一种服务（serive）？</p><h1 id=前台-后台任务>前台/后台任务</h1><p>变成守护进程的第一步，就是把它改成后台任务。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>xxx xxx &amp;
</span></span></code></pre></td></tr></table></div></div></div><p>只要在明星的尾部加上“&”，启动的进程就会成为后台任务。<strong>如果要让前台任务变为后台任务，可以先按 ctrl + z，然后执行 bg 命令</strong>（让最近一个暂停的后台任务继续执行）。
后台任务有两个特点：</p><p>1、继承当前 session 的标准输出和标准错误，因此后台任务的所有输出依然会同步地在命令行下显示</p><p>2、不再继承当前 session 的标注输入，无法向这个任务输入指令。如果它视图读取标注输入，就会暂停执行（halt）</p><p>可以看出，前台任务和后台任务的本质区别只要一个：是否继承标准输入。所以，执行后台任务的同时，用户还可以输入其他命令。</p><p><strong>&忽略SIGINT信号</strong></p><h1 id=sighup信号>SIGHUP信号</h1><p>Linux系统设计：</p><p>1、用户准备退出 session</p><p>2、系统向该 session 发出 SIGHUP 信号</p><p>3、session 将 SIGHUP 信号发给所有子进程</p><p>4、子进程收到 SIGHUP 信号后自动退出</p><p>这也解释了为什么前台任务会随着 session 的退出而退出，因为它收到 SIGHUP 信号。</p><p>那么，后台任务是否会收到 SIGHUP 信号呢？</p><p>这是由 Shell 的 huponexit 参数决定的，执行如下命令可看到该参数的值：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>shopt</span> | grep huponexit
</span></span></code></pre></td></tr></table></div></div></div><p>大多数Linux系统，这个参数默认关闭（off），因此，session退出的时候，不会把 SIGHUP 信号发给后台任务。所以，一般后台任务不会随着session一起退出。</p><h1 id=disown命令>disown命令</h1><p>通过后台任务启动守护进程并不保险，因为有的系统的 huponexit 参数可能是打开的（on）。</p><p>更保险的方法是使用 disown 命令，它可以将指定任务从**后台任务列表（jobs 命令返回的结果）**之中移除。一个后台任务只要不在这个列表中，session肯定就不会向它发出 SIGHUP 信号。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ xxx xx &amp;
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span>
</span></span></code></pre></td></tr></table></div></div></div><p>执行该命令后，正在执行的后台进程就被移出了后台任务列表。可以执行<strong>jobs命令</strong>验证，输出结果里面，不会有这个进程。</p><h2 id=disown-命令使用说明>disown 命令使用说明</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 移出最近一个正在执行的后台任务</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span>
</span></span><span style=display:flex><span><span style=color:#177500># 移出所有正在执行的后台任务</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span> -r
</span></span><span style=display:flex><span><span style=color:#177500># 移出所有后台任务</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span> -a
</span></span><span style=display:flex><span><span style=color:#177500># 不移出后台任务，但是让它们不会收到SIGHUP信号</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span> -h
</span></span><span style=display:flex><span><span style=color:#177500># 根据jobId，移出指定的后台任务</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span> %2
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span> -h %2
</span></span></code></pre></td></tr></table></div></div></div><h1 id=标准i-o>标准I/O</h1><p>使用disown命令之后，还有一个问题。那就是，退出 session 以后，如果后台进程与标准I/O有交互，它还是会挂掉。</p><p>举例，后台进程访问后有log输出。按照以下命令运行，退出session，访问进程会发现连接不上</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ xxx xx &amp;
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这是因为后台任务的标准I/O继承自当前session，disown 命令并没有改变这一点。一旦后台任务读写标准I/O，就会发现它已经不存在，所以会报错终止执行。
为了解决该问题，需要对后台任务的标准I/O进行重定向。</p><h2 id=重定向>重定向</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ xxx xx &gt; stdout.txt 2&gt; stderr.txt &lt; /dev/null &amp;
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>disown</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=nohup命令>nohup命令</h1><p>比 disown 更方便的命令，就是 nohup</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ nohup xxx xx &amp;
</span></span></code></pre></td></tr></table></div></div></div><p>nohup 命令对进程做了三件事
1、组织 SIGHUP 信号发到这个进程</p><p>2、关闭标准输入。该进程不再能够接收任何输入，即使运行在前台</p><p>3、重定向标准输出和标准错误到文件 nohup.out</p><p>即，nohup 命令实际上将子进程与它所在的session分离了。</p><p>注意：nohup 命令不会自动把任务变为后台任务，所以必须加上 & 符号</p><h2 id=nohup和-比较>nohup和&比较</h2><p>no hangup的缩写，意即“不挂断”</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>&amp;     <span style=color:#177500># ctrl+c 无影响，但是关闭 shell 程序会终止</span>
</span></span><span style=display:flex><span>nohup <span style=color:#177500># ctrl+c 有影响，忽略SIGHUP信号，关闭 shell 程序不会终止  </span>
</span></span><span style=display:flex><span>nohup <span style=color:#a90d91>command</span> &amp; <span style=color:#177500># 启动一些后台程序</span>
</span></span><span style=display:flex><span><span style=color:#177500># nohup java -jar xxxx.jar &amp;</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=screen-tmux命令>Screen/Tmux命令</h1><h2 id=screen>Screen</h2><p>另一种思路是使用 terminal multiplexer （终端复用器：在同一个终端里面，管理多个session），典型的就是 <a href=https://www.gnu.org/software/screen/>Screen</a> 命令和 <a href=https://tmux.github.io/>Tmux</a> 命令。</p><p>它们可以在当前 session 里面，新建另一个 session。这样的话，当前 session 一旦结束，不影响其他 session。而且，以后重新登录，还可以再连上早先新建的 session。</p><p>Screen 的用法如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 新建一个 session</span>
</span></span><span style=display:flex><span>$ screen
</span></span><span style=display:flex><span>$ xxx xx  <span style=color:#177500># 启动一个任务</span>
</span></span></code></pre></td></tr></table></div></div></div><p>然后，按下<code>ctrl + A</code>和<code>ctrl + D</code>，回到原来的 session，从那里退出登录。下次登录时，再切回去。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>$ screen -r
</span></span></code></pre></td></tr></table></div></div></div></p><p>如果新建多个后台 session，就需要为它们指定名字。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>$ screen -S name
</span></span><span style=display:flex><span># 切回指定 session
</span></span><span style=display:flex><span>$ screen -r name
</span></span><span style=display:flex><span>$ screen -r pid_number
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 列出所有 session
</span></span><span style=display:flex><span>$ screen -ls
</span></span></code></pre></td></tr></table></div></div></div></p><p>如果要停掉某个 session，可以先切回它，然后按下<code>ctrl + c</code>和<code>ctrl + d</code>。</p><h2 id=tmux>Tmux</h2><p>Tmux 比 Screen 功能更多、更强大，它的基本用法如下。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>$ tmux
</span></span><span style=display:flex><span>$ node server.js
</span></span><span style=display:flex><span># 返回原来的session
</span></span><span style=display:flex><span>$ tmux detach
</span></span></code></pre></td></tr></table></div></div></div><p>除了<code>tmux detach</code>，另一种方法是按下<code>Ctrl + B</code>和<code>d</code> ，也可以回到原来的 session。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 下次登录时，返回后台正在运行服务session
</span></span><span style=display:flex><span>$ tmux attach
</span></span></code></pre></td></tr></table></div></div></div></p><p>如果新建多个 session，就需要为每个 session 指定名字。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 新建 session
</span></span><span style=display:flex><span>$ tmux new -s session_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 切换到指定 session
</span></span><span style=display:flex><span>$ tmux attach -t session_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 列出所有 session
</span></span><span style=display:flex><span>$ tmux list-sessions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 退出当前 session，返回前一个 session 
</span></span><span style=display:flex><span>$ tmux detach
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 杀死指定 session
</span></span><span style=display:flex><span>$ tmux kill-session -t session-name
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=node工具>Node工具</h1><p>对于 Node 应用来说，可以不用上面的方法，有一些专门用来启动的工具：<a href=https://github.com/foreverjs/forever>forever</a>，<a href=http://nodemon.io/>nodemon</a> 和 <a href=http://pm2.keymetrics.io/>pm2</a>。</p><h2 id=forever>forever</h2><p>forever 的功能很简单，就是保证进程退出时，应用会自动重启。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span> # 作为前台任务启动
</span></span><span style=display:flex><span>$ forever server.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 作为服务进程启动 
</span></span><span style=display:flex><span>$ forever start app.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 停止服务进程
</span></span><span style=display:flex><span>$ forever stop Id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 重启服务进程
</span></span><span style=display:flex><span>$ forever restart Id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 监视当前目录的文件变动，一有变动就重启
</span></span><span style=display:flex><span>$ forever -w server.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># -m 参数指定最多重启次数
</span></span><span style=display:flex><span>$ forever -m 5 server.js 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 列出所有进程
</span></span><span style=display:flex><span>$ forever list
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=nodemon>nodemon</h2><p><code>nodemon</code>一般只在开发时使用，它最大的长处在于 watch 功能，一旦文件发生变化，就自动重启进程。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 默认监视当前目录的文件变化
</span></span><span style=display:flex><span>$ nodemon server.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>＃ 监视指定文件的变化   
</span></span><span style=display:flex><span>$ nodemon --watch app --watch libs server.js  
</span></span></code></pre></td></tr></table></div></div></div><h2 id=pm2>pm2</h2><p>pm2 的功能最强大，除了重启进程以外，还能实时收集日志和监控。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 启动应用
</span></span><span style=display:flex><span>$ pm2 start app.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 指定同时起多少个进程（由CPU核心数决定），组成一个集群
</span></span><span style=display:flex><span>$ pm2 start app.js -i max
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 列出所有任务
</span></span><span style=display:flex><span>$ pm2 list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 停止指定任务
</span></span><span style=display:flex><span>$ pm2 stop 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>＃ 重启指定任务
</span></span><span style=display:flex><span>$ pm2 restart 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 删除指定任务
</span></span><span style=display:flex><span>$ pm2 delete 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 保存当前的所有任务，以后可以恢复
</span></span><span style=display:flex><span>$ pm2 save
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 列出每个进程的统计数据
</span></span><span style=display:flex><span>$ pm2 monit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 查看所有日志
</span></span><span style=display:flex><span>$ pm2 logs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 导出数据
</span></span><span style=display:flex><span>$ pm2 dump
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 重启所有进程
</span></span><span style=display:flex><span>$ pm2 kill
</span></span><span style=display:flex><span>$ pm2 resurect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 启动web界面 http://localhost:9615
</span></span><span style=display:flex><span>$ pm2 web
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=systemd>Systemd</h1><p>见 Systemd 专栏</p><h1 id=reference>Reference</h1><p><a href=https://www.ruanyifeng.com/blog/2016/02/linux-daemon.html>Linux守护进程</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-89e0946384b3f67a5b20c8a00bf162a3>4.2 - Linux的启动过程</h1><h1 id=概述>概述</h1><p><img src=../imgs/linux_start_process_1.png alt=linux_start_process_1.png></p><h1 id=1-加载内核>1、加载内核</h1><p>操作系统接管硬件以后，首先读入 /boot 目录下的内核文件。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ll /boot
</span></span></code></pre></td></tr></table></div></div></div><h1 id=2-启动初始化进程>2、启动初始化进程</h1><p>内核文件加载以后，就开始运行第一个程序 /sbin/init，它的作用是初始化系统环境。</p><p>进程编号（pid）就是1。其他所有进程都从它衍生，都是它的子进程</p><h1 id=3-确定运行级别>3、确定运行级别</h1><p>许多程序需要开机启动。它们在Windows叫做"服务"（service），在Linux就叫做守护进程（daemon）。</p><p>Linux预置七种运行级别（0-6）。一般来说，0是关机，1是单用户模式（也就是维护模式），6是重启。运行级别2-5，各个发行版不太一样，对于Debian来说，都是同样的多用户模式（也就是正常模式）。</p><p>init进程首先读取文件 /etc/inittab，它是运行级别的设置文件。如果你打开它，可以看到第一行是这样的：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>id:</span><span style=color:#000>2</span><span style=color:#000>:</span><span style=color:#000>initdefault</span><span style=color:#000>:</span>
</span></span></code></pre></td></tr></table></div></div></div><p>表明系统启动时的运行级别为2。
运行级别为2的程序清单在/etc目录下面</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>/</span><span style=color:#000>etc</span><span style=color:#000>/</span><span style=color:#000>rc0</span><span style=color:#000>.</span><span style=color:#836c28>d</span>
</span></span><span style=display:flex><span><span style=color:#000>/</span><span style=color:#000>etc</span><span style=color:#000>/</span><span style=color:#000>rc1</span><span style=color:#000>.</span><span style=color:#836c28>d</span>
</span></span><span style=display:flex><span><span style=color:#000>/</span><span style=color:#000>etc</span><span style=color:#000>/</span><span style=color:#000>rc2</span><span style=color:#000>.</span><span style=color:#836c28>d</span>
</span></span><span style=display:flex><span><span style=color:#000>...</span>
</span></span></code></pre></td></tr></table></div></div></div><p>"rc"，表示run command（运行程序）、d表示directory（目录）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ls /etc/rc2.d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   README
</span></span><span style=display:flex><span>　　S01motd
</span></span><span style=display:flex><span>　　S13rpcbind
</span></span><span style=display:flex><span>　　S14nfs-common
</span></span><span style=display:flex><span>　　S16binfmt-support
</span></span><span style=display:flex><span>　　S16rsyslog
</span></span><span style=display:flex><span>　　S16sudo
</span></span><span style=display:flex><span>　　S17apache2
</span></span><span style=display:flex><span>　　S18acpid
</span></span><span style=display:flex><span>　　...
</span></span></code></pre></td></tr></table></div></div></div></p><p>除了第一个文件README以外，其他文件名都是"<strong>字母S+两位数字+程序名</strong>"的形式。
S表示Start，K表示Kill。</p><p>如果想修改程序不建议修改该目录，可以参考：<a href=http://www.debianadmin.com/manage-linux-init-or-startup-scripts.html>Debian Admin - Manage init</a> 和 <a href=http://www.debianadmin.com/remove-unwanted-startup-files-or-services-in-debian.html>Debian Admin - Remove Services</a></p><h1 id=4-加载开机启动程序>4、加载开机启动程序</h1><p>如果有多个运行级别的程序需要启动，为了避免拷贝，设置文件链接指向目录 /etc/init.d ，真正的启动脚本都统一放在这个目录中。init进程会运行这个目录里的启动脚本逐一加载开机启动程序。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ls -l /etc/rc2.d
</span></span><span style=display:flex><span><span style=color:#177500># 能看到链接</span>
</span></span></code></pre></td></tr></table></div></div></div><p>另外一个好处，直接使用 /etc/init.d下的链接文件直接启动或者关闭程序，不必到真实路径下查找。如：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>sudo /etc/init.d/apache2 restart
</span></span></code></pre></td></tr></table></div></div></div></p><p>/etc/init.d 这个目录名最后一个字母d，表示目录（directory），用来与程序 /etc/init 区分。</p><h1 id=5-用户登录>5、用户登录</h1><p>用户的登录方式有三种：</p><p>1）命令行登录</p><p>init进程调用getty程序（意为get teletype），让用户输入用户名和密码。输入完成后，再调用login程序，核对密码（Debian还会再多运行一个身份核对程序/etc/pam.d/login）。如果密码正确，就从文件 /etc/passwd 读取该用户指定的shell，然后启动这个shell。</p><p>2）ssh登录</p><p>这时系统调用sshd程序（Debian还会再运行/etc/pam.d/ssh ），取代getty和login，然后启动shell。</p><p>3）图形界面登录</p><p>init进程调用显示管理器，Gnome图形界面对应的显示管理器为gdm（GNOME Display Manager），然后用户输入用户名和密码。如果密码正确，就读取/etc/gdm3/Xsession，启动用户的会话。</p><h1 id=6-进入-login-shell>6、进入 login shell</h1><p>shell就是命令行界面，让用户可以直接与操作系统对话。用户登录时打开的shell，就叫做login shell。</p><p>1）命令行登录</p><p>首先读入 /etc/profile，这是对所有用户都有效的配置；然后依次寻找下面三个文件，这是针对当前用户的配置。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>~/.</span><span style=color:#836c28>bash_profile</span>
</span></span><span style=display:flex><span><span style=color:#000>~/.</span><span style=color:#836c28>bash_login</span>
</span></span><span style=display:flex><span><span style=color:#000>~/.</span><span style=color:#836c28>profile</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意：<strong>这三个文件只要有一个存在，就不再读入后面的文件</strong>。
2）ssh登录：</p><p>与命令行登录完全相同。</p><p>3）图形界面登录</p><p><strong>只加载 /etc/profile 和 ~/.profile。也就是说，~/.bash_profile 不管有没有，都不会运行。</strong></p><h1 id=7-打开-non-login-shell>7、打开 non-login shell</h1><p>用户进入操作系统以后，常常会再手动开启一个shell。这个shell就叫做 non-login shell，意思是它不同于登录时出现的那个shell，不读取/etc/profile和.profile等配置文件。</p><p><strong>non-login shell 会读入用户自己的bash配置文件 ~/.bashrc。</strong></p><p>如果不进入 non-login shell，.bashrc会通过 ~/.profile文件运行，如下.profile文件内容：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>　　if [ -n &#34;$BASH_VERSION&#34; ]; then
</span></span><span style=display:flex><span>　　　　if [ -f &#34;$HOME/.bashrc&#34; ]; then
</span></span><span style=display:flex><span>　　　　　　. &#34;$HOME/.bashrc&#34;
</span></span><span style=display:flex><span>　　　　fi
</span></span><span style=display:flex><span>　　fi　　
</span></span></code></pre></td></tr></table></div></div></div><p>上面代码先判断变量 $BASH_VERSION 是否有值，然后判断主目录下是否存在 .bashrc 文件，如果存在就运行该文件。第三行开头的那个点，是source命令的简写形式，表示运行某个文件，写成"source ~/.bashrc"也是可以的。
因此，<strong>只要运行～/.profile文件，～/.bashrc文件就会连带运行</strong>。但是上一节的第一种情况提到过，如果存在～/.bash_profile文件，那么有可能不会运行～/.profile文件。解决这个问题很简单，把下面代码写入.bash_profile就行了。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>　　if [ -f ~/.profile ]; then
</span></span><span style=display:flex><span>　　　　. ~/.profile
</span></span><span style=display:flex><span>　　fi　
</span></span></code></pre></td></tr></table></div></div></div><p>这样一来，不管是哪种情况，.bashrc都会执行，用户的设置可以放心地都写入这个文件了。
Bash的设置之所以如此繁琐，是由于历史原因造成的。早期的时候，计算机运行速度很慢，载入配置文件需要很长时间，Bash的作者只好把配置文件分成了几个部分，阶段性载入。系统的通用设置放在 /etc/profile，用户个人的、需要被所有子进程继承的设置放在.profile，不需要被继承的设置放在.bashrc。</p><p>顺便提一下，除了Linux以外， Mac OS X 使用的shell也是Bash。但是，它只加载 .bash_profile，然后在.bash_profile里面调用.bashrc。而且，不管是ssh登录，还是在图形界面里启动shell窗口，都是如此。</p><h1 id=reference>Reference</h1><p><a href=https://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html>Linux的启动过程</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3b8e4619334355226769bbce91df6df8>4.3 - supervisor</h1><h1 id=简介>简介</h1><p>Supervisor是用Python开发的一套通用的进程管理程序，能将一个普通的命令行进程变为后台daemon，并监控进程状态，异常退出时能自动重启。它是通过fork/exec的方式把这些被管理的进程当作supervisor的子进程来启动，这样只要在supervisor的配置文件中，把要管理的进程的可执行文件的路径写进去即可。也实现当子进程挂掉的时候，父进程可以准确获取子进程挂掉的信息的，可以选择是否自己启动和报警。supervisor还提供了一个功能，可以为supervisord或者每个子进程，设置一个非root的user，这个user就可以管理它对应的进程。</p><p>官网：<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fsupervisord.org">http://supervisord.org</a></p><h1 id=supervisor安装>supervisor安装</h1><h2 id=yum源>yum源</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>yum install supervisor
</span></span></code></pre></td></tr></table></div></div></div><h2 id=debian-ubuntu>Debian/Ubuntu</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>apt-get install supervisor
</span></span></code></pre></td></tr></table></div></div></div><h2 id=pip安装>pip安装</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>pip install supervisor
</span></span></code></pre></td></tr></table></div></div></div><h2 id=easy-install安装>easy_install安装</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>easy_install supervisor
</span></span></code></pre></td></tr></table></div></div></div><h1 id=supervisor使用>supervisor使用</h1><p>supervisor配置文件：/etc/supervisord.conf</p><p>注：supervisor的配置文件默认是不全的，不过在大部分默认的情况下，上面说的基本功能已经满足。</p><p>子进程配置文件路径：/etc/supervisord.d/</p><p>注：默认子进程配置文件为ini格式，可在supervisor主配置文件中修改。</p><h1 id=配置文件说明>配置文件说明</h1><h2 id=supervisor-conf配置文件说明>supervisor.conf配置文件说明</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>[unix_http_server]
</span></span><span style=display:flex><span>file=/tmp/supervisor.sock   ;UNIX socket 文件，supervisorctl 会使用
</span></span><span style=display:flex><span>;chmod=0700                 ;socket文件的mode，默认是0700
</span></span><span style=display:flex><span>;chown=nobody:nogroup       ;socket文件的owner，格式：uid:gid
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>;[inet_http_server]         ;HTTP服务器，提供web管理界面
</span></span><span style=display:flex><span>;port=127.0.0.1:9001        ;Web管理后台运行的IP和端口，如果开放到公网，需要注意安全性
</span></span><span style=display:flex><span>;username=user              ;登录管理后台的用户名
</span></span><span style=display:flex><span>;password=123               ;登录管理后台的密码
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>[supervisord]
</span></span><span style=display:flex><span>logfile=/tmp/supervisord.log ;日志文件，默认是 $CWD/supervisord.log
</span></span><span style=display:flex><span>logfile_maxbytes=50MB        ;日志文件大小，超出会rotate，默认 50MB，如果设成0，表示不限制大小
</span></span><span style=display:flex><span>logfile_backups=10           ;日志文件保留备份数量默认10，设为0表示不备份
</span></span><span style=display:flex><span>loglevel=info                ;日志级别，默认info，其它: debug,warn,trace
</span></span><span style=display:flex><span>pidfile=/tmp/supervisord.pid ;pid 文件
</span></span><span style=display:flex><span>nodaemon=false               ;是否在前台启动，默认是false，即以 daemon 的方式启动
</span></span><span style=display:flex><span>minfds=1024                  ;可以打开的文件描述符的最小值，默认 1024
</span></span><span style=display:flex><span>minprocs=200                 ;可以打开的进程数的最小值，默认 200
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>[supervisorctl]
</span></span><span style=display:flex><span>serverurl=unix:///tmp/supervisor.sock ;通过UNIX socket连接supervisord，路径与unix_http_server部分的file一致
</span></span><span style=display:flex><span>;serverurl=http://127.0.0.1:9001 ; 通过HTTP的方式连接supervisord
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>; [program:xx]是被管理的进程配置参数，xx是进程的名称
</span></span><span style=display:flex><span>[program:xx]
</span></span><span style=display:flex><span>command=/opt/apache-tomcat-8.0.35/bin/catalina.sh run  ; 程序启动命令
</span></span><span style=display:flex><span>autostart=true       ; 在supervisord启动的时候也自动启动
</span></span><span style=display:flex><span>startsecs=10         ; 启动10秒后没有异常退出，就表示进程正常启动了，默认为1秒
</span></span><span style=display:flex><span>autorestart=true     ; 程序退出后自动重启,可选值：[unexpected,true,false]，默认为unexpected，表示进程意外杀死后才重启
</span></span><span style=display:flex><span>startretries=3       ; 启动失败自动重试次数，默认是3
</span></span><span style=display:flex><span>user=tomcat          ; 用哪个用户启动进程，默认是root
</span></span><span style=display:flex><span>priority=999         ; 进程启动优先级，默认999，值小的优先启动
</span></span><span style=display:flex><span>redirect_stderr=true ; 把stderr重定向到stdout，默认false
</span></span><span style=display:flex><span>stdout_logfile_maxbytes=20MB  ; stdout 日志文件大小，默认50MB
</span></span><span style=display:flex><span>stdout_logfile_backups = 20   ; stdout 日志文件备份数，默认是10
</span></span><span style=display:flex><span>; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）
</span></span><span style=display:flex><span>stdout_logfile=/opt/apache-tomcat-8.0.35/logs/catalina.out
</span></span><span style=display:flex><span>stopasgroup=false     ;默认为false,进程被杀死时，是否向这个进程组发送stop信号，包括子进程
</span></span><span style=display:flex><span>killasgroup=false     ;默认为false，向进程组发送kill信号，包括子进程
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>;包含其它配置文件
</span></span><span style=display:flex><span>[include]
</span></span><span style=display:flex><span>files = relative/directory/*.ini    ;可以指定一个或多个以.ini结束的配置文件
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=子进程配置文件说明>子进程配置文件说明</h2><p>给需要管理的子进程(程序)编写一个配置文件，放在<code>/etc/supervisor.d/</code>目录下，以<code>.ini</code>作为扩展名（每个进程的配置文件都可以单独分拆也可以把相关的脚本放一起）。如任意定义一个和脚本相关的项目名称的选项组（/etc/supervisord.d/test.conf）：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>#项目名
</span></span><span style=display:flex><span>[program:blog]
</span></span><span style=display:flex><span>#脚本目录
</span></span><span style=display:flex><span>directory=/opt/bin
</span></span><span style=display:flex><span>#脚本执行命令
</span></span><span style=display:flex><span>command=/usr/bin/python /opt/bin/test.py
</span></span><span style=display:flex><span>#supervisor启动的时候是否随着同时启动，默认True
</span></span><span style=display:flex><span>autostart=true
</span></span><span style=display:flex><span>#当程序exit的时候，这个program不会自动重启,默认unexpected，设置子进程挂掉后自动重启的情况，有三个选项，false,unexpected和true。如果为false的时候，无论什么情况下，都不会被重新启动，如果为unexpected，只有当进程的退出码不在下面的exitcodes里面定义的
</span></span><span style=display:flex><span>autorestart=false
</span></span><span style=display:flex><span>#这个选项是子进程启动多少秒之后，此时状态如果是running，则我们认为启动成功了。默认值为1
</span></span><span style=display:flex><span>startsecs=1
</span></span><span style=display:flex><span>#脚本运行的用户身份 
</span></span><span style=display:flex><span>user = test
</span></span><span style=display:flex><span>#日志输出 
</span></span><span style=display:flex><span>stderr_logfile=/tmp/blog_stderr.log 
</span></span><span style=display:flex><span>stdout_logfile=/tmp/blog_stdout.log 
</span></span><span style=display:flex><span>#把stderr重定向到stdout，默认 false
</span></span><span style=display:flex><span>redirect_stderr = true
</span></span><span style=display:flex><span>#stdout日志文件大小，默认 50MB
</span></span><span style=display:flex><span>stdout_logfile_maxbytes = 20MB
</span></span><span style=display:flex><span>#stdout日志文件备份数
</span></span><span style=display:flex><span>stdout_logfile_backups = 20
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=子进程配置示例>子进程配置示例</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>#说明同上
</span></span><span style=display:flex><span>[program:test] 
</span></span><span style=display:flex><span>directory=/opt/bin 
</span></span><span style=display:flex><span>command=/opt/bin/test
</span></span><span style=display:flex><span>autostart=true 
</span></span><span style=display:flex><span>autorestart=false 
</span></span><span style=display:flex><span>stderr_logfile=/tmp/test_stderr.log 
</span></span><span style=display:flex><span>stdout_logfile=/tmp/test_stdout.log 
</span></span><span style=display:flex><span>#user = test  
</span></span></code></pre></td></tr></table></div></div></div><h1 id=supervisor命令说明>supervisor命令说明</h1><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>supervisord ctl restart serverName
</span></span><span style=display:flex><span>supervisorctl status        //查看所有进程的状态
</span></span><span style=display:flex><span>supervisorctl stop es       //停止es
</span></span><span style=display:flex><span>supervisorctl start es      //启动es
</span></span><span style=display:flex><span>supervisorctl restart       //重启es
</span></span><span style=display:flex><span>supervisorctl update        //配置文件修改后使用该命令加载新的配置
</span></span><span style=display:flex><span>supervisorctl reload        //重新启动配置中的所有程序
</span></span></code></pre></td></tr></table></div></div></div><p>注意事项：</p><p>使用supervisor进程管理命令之前先启动supervisord，否则程序报错。</p><p>使用命令<code>supervisord -c /etc/supervisord.conf</code>启动。</p><p>若是centos7：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>systemctl start supervisord.service     //启动supervisor并加载默认配置文件
</span></span><span style=display:flex><span>systemctl enable supervisord.service    //将supervisor加入开机启动项
</span></span></code></pre></td></tr></table></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f3d9259623dc5dcb82a4c71fca06077c>4.4 - systemd</h1><h1 id=背景>背景</h1><p>Linux的启动一直是采用 init 进程</p><p>如以下命令</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo /etc/init.d/apache2 start
</span></span><span style=display:flex><span><span style=color:#177500># 或</span>
</span></span><span style=display:flex><span>$ service apache2 start
</span></span></code></pre></td></tr></table></div></div></div><p>该方法有如下缺点
1、启动时间长。init进程是串行启动。</p><p>2、启动脚本复杂。init进程只是执行启动脚本，不管其他事情。脚本需要自己处理各种情况，使得脚本变得很长。</p><h1 id=简述>简述</h1><p>Systemd 就是为了解决这些问题而诞生的。它的设计目标是，为系统的启动和管理提供一套完整的解决方案。</p><p>根据 Linux 惯例，字母d是守护进程（daemon）的缩写。 Systemd 这个名字的含义，就是它要守护整个系统。</p><p>使用了 Systemd，就不需要再用init了。Systemd 取代了initd，成为系统的第一个进程（PID 等于 1），其他进程都是它的子进程。</p><p>Systemd 是 Linux 系统工具，用来启动守护进程，已成为大多数发行版的标准配置。</p><p>Systemd 的优点是功能强大，使用方便，缺点是体系庞大，非常复杂。与操作系统的其他部分强耦合，违反"keep simple, keep stupid"的Unix 哲学。（"简单原则"——尽量用简单的方法解决问题——是"Unix哲学"的根本原则。这也就是著名的KISS（keep it simple, stupid），意思是"保持简单和笨拙"。）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl --version  <span style=color:#177500># 查看版本</span>
</span></span></code></pre></td></tr></table></div></div></div><p>systemd架构图
<img src=../imgs/systemd_1.png alt=systemd_1.png></p><h1 id=系统管理>系统管理</h1><p>systemd不是一个命令，而是一组命令，涉及到系统管理的方方面面。</p><h2 id=systemctl>systemctl</h2><p>主命令，用于管理系统。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 重启系统</span>
</span></span><span style=display:flex><span>$ sudo systemctl reboot
</span></span><span style=display:flex><span><span style=color:#177500># 关闭系统，切断电源</span>
</span></span><span style=display:flex><span>$ sudo systemctl poweroff
</span></span><span style=display:flex><span><span style=color:#177500># CPU停止工作</span>
</span></span><span style=display:flex><span>$ sudo systemctl halt
</span></span><span style=display:flex><span><span style=color:#177500># 暂停系统</span>
</span></span><span style=display:flex><span>$ sudo systemctl <span style=color:#a90d91>suspend</span>
</span></span><span style=display:flex><span><span style=color:#177500># 让系统进入冬眠状态</span>
</span></span><span style=display:flex><span>$ sudo systemctl hibernate
</span></span><span style=display:flex><span><span style=color:#177500># 让系统进入交互式休眠状态</span>
</span></span><span style=display:flex><span>$ sudo systemctl hybrid-sleep
</span></span><span style=display:flex><span><span style=color:#177500># 启动进入救援状态（单用户状态）</span>
</span></span><span style=display:flex><span>$ sudo systemctl rescue
</span></span></code></pre></td></tr></table></div></div></div><h2 id=systemd-analyze>systemd-analyze</h2><p>用于查看启动耗时。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看启动耗时</span>
</span></span><span style=display:flex><span>$ systemd-analyze                                                                                       
</span></span><span style=display:flex><span><span style=color:#177500># 查看每个服务的启动耗时</span>
</span></span><span style=display:flex><span>$ systemd-analyze blame
</span></span><span style=display:flex><span><span style=color:#177500># 显示瀑布状的启动过程流</span>
</span></span><span style=display:flex><span>$ systemd-analyze critical-chain
</span></span><span style=display:flex><span><span style=color:#177500># 显示指定服务的启动流</span>
</span></span><span style=display:flex><span>$ systemd-analyze critical-chain atd.service
</span></span></code></pre></td></tr></table></div></div></div><h2 id=hostnamectl>hostnamectl</h2><p>用于查看当前主机的信息。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 显示当前主机的信息</span>
</span></span><span style=display:flex><span>$ hostnamectl
</span></span><span style=display:flex><span><span style=color:#177500># 设置主机名。</span>
</span></span><span style=display:flex><span>$ sudo hostnamectl set-hostname rhel7
</span></span></code></pre></td></tr></table></div></div></div><h2 id=localectl>localectl</h2><p>用户查看本地化设置</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 查看本地化设置
</span></span><span style=display:flex><span>$ localectl
</span></span><span style=display:flex><span># 设置本地化参数。
</span></span><span style=display:flex><span>$ sudo localectl set-locale LANG=en_GB.utf8
</span></span><span style=display:flex><span>$ sudo localectl set-keymap en_GB 
</span></span></code></pre></td></tr></table></div></div></div><h2 id=timedatectl>timedatectl</h2><p>用于查看当前时区设置</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看当前时区设置</span>
</span></span><span style=display:flex><span>$ timedatectl
</span></span><span style=display:flex><span><span style=color:#177500># 显示所有可用的时区</span>
</span></span><span style=display:flex><span>$ timedatectl list-timezones                                                                                   
</span></span><span style=display:flex><span><span style=color:#177500># 设置当前时区</span>
</span></span><span style=display:flex><span>$ sudo timedatectl set-timezone America/New_York
</span></span><span style=display:flex><span>$ sudo timedatectl set-time YYYY-MM-DD
</span></span><span style=display:flex><span>$ sudo timedatectl set-time HH:MM:SS
</span></span></code></pre></td></tr></table></div></div></div><h2 id=loginctl>loginctl</h2><p>用于查看当前登录的用户</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 列出当前session</span>
</span></span><span style=display:flex><span>$ loginctl list-sessions
</span></span><span style=display:flex><span><span style=color:#177500># 列出当前登录用户</span>
</span></span><span style=display:flex><span>$ loginctl list-users
</span></span><span style=display:flex><span><span style=color:#177500># 列出显示指定用户的信息</span>
</span></span><span style=display:flex><span>$ loginctl show-user ruanyf
</span></span></code></pre></td></tr></table></div></div></div><h1 id=unit>Unit</h1><h2 id=含义>含义</h2><p>Systemd可以管理所有系统资源，不同的系统的资源统称为Unit（单位）。</p><p>Unit一共分为12种</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>Service unit：系统服务
</span></span><span style=display:flex><span>Target unit：多个 Unit 构成的一个组
</span></span><span style=display:flex><span>Device Unit：硬件设备
</span></span><span style=display:flex><span>Mount Unit：文件系统的挂载点
</span></span><span style=display:flex><span>Automount Unit：自动挂载点
</span></span><span style=display:flex><span>Path Unit：文件或路径
</span></span><span style=display:flex><span>Scope Unit：不是由 Systemd 启动的外部进程
</span></span><span style=display:flex><span>Slice Unit：进程组
</span></span><span style=display:flex><span>Snapshot Unit：Systemd 快照，可以切回某个快照
</span></span><span style=display:flex><span>Socket Unit：进程间通信的 socket
</span></span><span style=display:flex><span>Swap Unit：swap 文件
</span></span><span style=display:flex><span>Timer Unit：定时器
</span></span></code></pre></td></tr></table></div></div></div><h2 id=unit查询>Unit查询</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 列出正在运行的 Unit</span>
</span></span><span style=display:flex><span>$ systemctl list-units
</span></span><span style=display:flex><span><span style=color:#177500># 列出所有Unit，包括没有找到配置文件的或者启动失败的</span>
</span></span><span style=display:flex><span>$ systemctl list-units --all
</span></span><span style=display:flex><span><span style=color:#177500># 列出所有没有运行的 Unit</span>
</span></span><span style=display:flex><span>$ systemctl list-units --all --state<span style=color:#000>=</span>inactive
</span></span><span style=display:flex><span><span style=color:#177500># 列出所有加载失败的 Unit</span>
</span></span><span style=display:flex><span>$ systemctl list-units --failed
</span></span><span style=display:flex><span><span style=color:#177500># 列出所有正在运行的、类型为 service 的 Unit</span>
</span></span><span style=display:flex><span>$ systemctl list-units --type<span style=color:#000>=</span>service
</span></span></code></pre></td></tr></table></div></div></div><h2 id=unit状态>Unit状态</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 显示系统状态</span>
</span></span><span style=display:flex><span>$ systemctl status
</span></span><span style=display:flex><span><span style=color:#177500># 显示单个 Unit 的状态</span>
</span></span><span style=display:flex><span>$ sysystemctl status bluetooth.service
</span></span><span style=display:flex><span><span style=color:#177500># 显示远程主机的某个 Unit 的状态</span>
</span></span><span style=display:flex><span>$ systemctl -H root@rhel7.example.com status httpd.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看以某个用户启动的服务</span>
</span></span><span style=display:flex><span>$ sudo -u &lt;user&gt; bash
</span></span><span style=display:flex><span>$ systemctl --user status xxx.service  <span style=color:#177500># 相关命令都需要加上--user</span>
</span></span></code></pre></td></tr></table></div></div></div><p>查询状态
可以供脚本内部的判断语句使用。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 显示某个 Unit 是否正在运行</span>
</span></span><span style=display:flex><span>$ systemctl is-active application.service
</span></span><span style=display:flex><span><span style=color:#177500># 显示某个 Unit 是否处于启动失败状态</span>
</span></span><span style=display:flex><span>$ systemctl is-failed application.service
</span></span><span style=display:flex><span><span style=color:#177500># 显示某个 Unit 服务是否建立了启动链接</span>
</span></span><span style=display:flex><span>$ systemctl is-enabled application.service
</span></span></code></pre></td></tr></table></div></div></div><h2 id=unit管理>Unit管理</h2><p>对于用户来说，最常用的是下面这些命令，用于启动和停止 Unit（主要是 service）。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 立即启动一个服务</span>
</span></span><span style=display:flex><span>$ sudo systemctl start apache.service
</span></span><span style=display:flex><span><span style=color:#177500># 立即停止一个服务</span>
</span></span><span style=display:flex><span>$ sudo systemctl stop apache.service
</span></span><span style=display:flex><span><span style=color:#177500># 重启一个服务</span>
</span></span><span style=display:flex><span>$ sudo systemctl restart apache.service
</span></span><span style=display:flex><span><span style=color:#177500># 杀死一个服务的所有子进程</span>
</span></span><span style=display:flex><span>$ sudo systemctl <span style=color:#a90d91>kill</span> apache.service
</span></span><span style=display:flex><span><span style=color:#177500># 重新加载一个服务的配置文件</span>
</span></span><span style=display:flex><span>$ sudo systemctl reload apache.service
</span></span><span style=display:flex><span><span style=color:#177500># 重载所有修改过的配置文件</span>
</span></span><span style=display:flex><span>$ sudo systemctl daemon-reload
</span></span><span style=display:flex><span><span style=color:#177500># 显示某个 Unit 的所有底层参数</span>
</span></span><span style=display:flex><span>$ systemctl show httpd.service
</span></span><span style=display:flex><span><span style=color:#177500># 显示某个 Unit 的指定属性的值</span>
</span></span><span style=display:flex><span>$ systemctl show -p CPUShares httpd.service
</span></span><span style=display:flex><span><span style=color:#177500># 设置某个 Unit 的指定属性</span>
</span></span><span style=display:flex><span>$ sudo systemctl set-property httpd.service <span style=color:#000>CPUShares</span><span style=color:#000>=</span><span style=color:#1c01ce>500</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=unit依赖关系>Unit依赖关系</h2><p>Unit 之间存在依赖关系：A 依赖于 B，就意味着 Systemd 在启动 A 的时候，同时会去启动 B。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查询依赖关系</span>
</span></span><span style=display:flex><span>$ systemctl list-dependencies nginx.service
</span></span></code></pre></td></tr></table></div></div></div><p>上面命令的输出结果之中，有些依赖是 Target 类型（详见下文），默认不会展开显示。如果要展开 Target，就需要使用--all参数。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ systemctl list-dependencies --all nginx.service
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=unit配置文件>Unit配置文件</h1><p>每个Unit都有一个配置文件，告诉Systemd怎么启动Unit。</p><p>Systemd 默认从目录/etc/systemd/system/读取配置文件。但是，里面存放的大部分文件都是符号链接，指向目录/usr/lib/systemd/system/，真正的配置文件存放在那个目录。</p><p>systemctl enable命令用于在上面两个目录之间，建立符号链接关系。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo systemctl <span style=color:#a90d91>enable</span> xx.service
</span></span><span style=display:flex><span><span style=color:#177500># 等同于</span>
</span></span><span style=display:flex><span>$ sudo ln -s <span style=color:#c41a16>&#39;/usr/lib/systemd/system/xx.service&#39;</span> <span style=color:#c41a16>&#39;/etc/systemd/system/xxx/xx.service&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>如果配置文件里面设置了开机启动，systemctl enable命令相当于激活开机启动。
与之对应的，systemctl disable命令用于在两个目录之间，撤销符号链接关系，相当于撤销开机启动。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo systemctl disable xx.service
</span></span></code></pre></td></tr></table></div></div></div><p><strong>配置文件的后缀名，就是该 Unit 的种类，比如sshd.socket。如果省略，Systemd 默认后缀名为.service，所以sshd会被理解成sshd.service。</strong></p><h2 id=配置文件状态>配置文件状态</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 列出所有配置文件</span>
</span></span><span style=display:flex><span>$ systemctl list-unit-files
</span></span><span style=display:flex><span><span style=color:#177500># 列出指定类型的配置文件</span>
</span></span><span style=display:flex><span>$ systemctl list-unit-files --type<span style=color:#000>=</span>service
</span></span></code></pre></td></tr></table></div></div></div><p>状态一共分为四种：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>enabled：已建立启动链接
</span></span><span style=display:flex><span>disabled：没建立启动链接
</span></span><span style=display:flex><span>static：该配置文件没有[Install]部分（无法执行），只能作为其他配置文件的依赖
</span></span><span style=display:flex><span>masked：该配置文件被禁止建立启动链接
</span></span></code></pre></td></tr></table></div></div></div></p><p>一旦修改配置文件，就要Systemd重新加载配置文件，然后重新启动，否则修改不会生效。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo systemctl daemon-reload
</span></span><span style=display:flex><span>$ sudo systemctl restart httpd.service
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=配置文件格式>配置文件格式</h2><p>配置文件为普通的文本文件。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ systemctl cat atd.service  <span style=color:#177500># 查看配置文件内容</span>
</span></span><span style=display:flex><span><span style=color:#000>[</span>Unit<span style=color:#000>]</span>
</span></span><span style=display:flex><span><span style=color:#000>Description</span><span style=color:#000>=</span>ATD daemon
</span></span><span style=display:flex><span><span style=color:#000>[</span>Service<span style=color:#000>]</span>
</span></span><span style=display:flex><span><span style=color:#000>Type</span><span style=color:#000>=</span>forking
</span></span><span style=display:flex><span><span style=color:#000>ExecStart</span><span style=color:#000>=</span>/usr/bin/atd
</span></span><span style=display:flex><span><span style=color:#000>[</span>Install<span style=color:#000>]</span>
</span></span><span style=display:flex><span><span style=color:#000>WantedBy</span><span style=color:#000>=</span>multi-user.target
</span></span></code></pre></td></tr></table></div></div></div><p>配置文件分成几个区块。每个区块的第一行，是用方括号表示的区别名。
每个区块内部都是一些等号连接的键值对。</p><p>注意：</p><p>1、区块名和字段名，都是大小写敏感的。</p><p>2、键值对的等号两侧不能有空格。</p><h2 id=配置文件的区块>配置文件的区块</h2><p>Unit 配置文件的完整字段清单，可以参考<a href=https://www.freedesktop.org/software/systemd/man/systemd.unit.html>官方文档</a>。</p><h3 id=unit区块>Unit区块</h3><p>通常是配置文件的第一个区块。</p><p>用来定义 Unit 的元数据，以及配置与其他 Unit 的关系。主要字段如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>Description：简短描述
</span></span><span style=display:flex><span>Documentation：文档地址
</span></span><span style=display:flex><span>Requires：当前 Unit 依赖的其他 Unit，如果它们没有运行，当前 Unit 会启动失败
</span></span><span style=display:flex><span>Wants：与当前 Unit 配合的其他 Unit，如果它们没有运行，当前 Unit 不会启动失败
</span></span><span style=display:flex><span>BindsTo：与Requires类似，它指定的 Unit 如果退出，会导致当前 Unit 停止运行
</span></span><span style=display:flex><span>Before：如果该字段指定的 Unit 也要启动，那么必须在当前 Unit 之后启动
</span></span><span style=display:flex><span>After：如果该字段指定的 Unit 也要启动，那么必须在当前 Unit 之前启动
</span></span><span style=display:flex><span>Conflicts：这里指定的 Unit 不能与当前 Unit 同时运行
</span></span><span style=display:flex><span>Condition...：当前 Unit 运行必须满足的条件，否则不会运行
</span></span><span style=display:flex><span>Assert...：当前 Unit 运行必须满足的条件，否则会报启动失败
</span></span></code></pre></td></tr></table></div></div></div><h3 id=install区块>Install区块</h3><p>通常是配置文件的最后一个区块，用来定义如何启动，以及是否开启启动等。主要字段如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>WantedBy：它的值是一个或多个 Target，当前 Unit 激活时（enable）符号链接会放入/etc/systemd/system目录下面以 Target 名 + .wants后缀构成的子目录中
</span></span><span style=display:flex><span>RequiredBy：它的值是一个或多个 Target，当前 Unit 激活时，符号链接会放入/etc/systemd/system目录下面以 Target 名 + .required后缀构成的子目录中
</span></span><span style=display:flex><span>Alias：当前 Unit 可用于启动的别名
</span></span><span style=display:flex><span>Also：当前 Unit 激活（enable）时，会被同时激活的其他 Unit
</span></span></code></pre></td></tr></table></div></div></div><h3 id=service区块>Service区块</h3><p>用来 Service 的配置，只有 Service 类型的 Unit 才有这个区块。主要字段如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>Type：定义启动时的进程行为。它有以下几种值。
</span></span><span style=display:flex><span>Type=simple：默认值，执行ExecStart指定的命令，启动主进程
</span></span><span style=display:flex><span>Type=forking：以 fork 方式从父进程创建子进程，创建后父进程会立即退出
</span></span><span style=display:flex><span>Type=oneshot：一次性进程，Systemd 会等当前服务退出，再继续往下执行
</span></span><span style=display:flex><span>Type=dbus：当前服务通过D-Bus启动
</span></span><span style=display:flex><span>Type=notify：当前服务启动完毕，会通知Systemd，再继续往下执行
</span></span><span style=display:flex><span>Type=idle：若有其他任务执行完毕，当前服务才会运行
</span></span><span style=display:flex><span>ExecStart：启动当前服务的命令
</span></span><span style=display:flex><span>ExecStartPre：启动当前服务之前执行的命令
</span></span><span style=display:flex><span>ExecStartPost：启动当前服务之后执行的命令
</span></span><span style=display:flex><span>ExecReload：重启当前服务时执行的命令
</span></span><span style=display:flex><span>ExecStop：停止当前服务时执行的命令
</span></span><span style=display:flex><span>ExecStopPost：停止当其服务之后执行的命令
</span></span><span style=display:flex><span>RestartSec：自动重启当前服务间隔的秒数
</span></span><span style=display:flex><span>Restart：定义何种情况 Systemd 会自动重启当前服务，可能的值包括always（总是重启）、on-success、on-failure、on-abnormal、on-abort、on-watchdog
</span></span><span style=display:flex><span>TimeoutSec：定义 Systemd 停止当前服务之前等待的秒数
</span></span><span style=display:flex><span>Environment：指定环境变量
</span></span><span style=display:flex><span>KillMode: 服务停止时，杀死进程的方法
</span></span></code></pre></td></tr></table></div></div></div><h1 id=target>Target</h1><p>启动计算机的时候，需要启动大量的 Unit。如果每一次启动，都要一一写明本次启动需要哪些 Unit，显然非常不方便。Systemd 的解决方案就是 Target。</p><p>简单说，Target 就是一个 Unit 组，包含许多相关的 Unit 。启动某个 Target 的时候，Systemd 就会启动里面所有的 Unit。从这个意义上说，Target 这个概念类似于"状态点"，启动某个 Target 就好比启动到某种状态。</p><p>传统的init启动模式里面，有 RunLevel 的概念，跟 Target 的作用很类似。不同的是，RunLevel 是互斥的，不可能多个 RunLevel 同时启动，但是多个 Target 可以同时启动。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看当前系统的所有 Target</span>
</span></span><span style=display:flex><span>$ systemctl list-unit-files --type<span style=color:#000>=</span>target
</span></span><span style=display:flex><span><span style=color:#177500># 查看一个 Target 包含的所有 Unit</span>
</span></span><span style=display:flex><span>$ systemctl list-dependencies multi-user.target
</span></span><span style=display:flex><span><span style=color:#177500># 查看启动时的默认 Target</span>
</span></span><span style=display:flex><span>$ systemctl get-default
</span></span><span style=display:flex><span><span style=color:#177500># 设置启动时的默认 Target</span>
</span></span><span style=display:flex><span>$ sudo systemctl set-default multi-user.target
</span></span><span style=display:flex><span><span style=color:#177500># 切换 Target 时，默认不关闭前一个 Target 启动的进程，</span>
</span></span><span style=display:flex><span><span style=color:#177500># systemctl isolate 命令改变这种行为，</span>
</span></span><span style=display:flex><span><span style=color:#177500># 关闭前一个 Target 里面所有不属于后一个 Target 的进程</span>
</span></span><span style=display:flex><span>$ sudo systemctl isolate multi-user.target
</span></span></code></pre></td></tr></table></div></div></div><p>Target 与 传统 RunLevel 的对应关系如下。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>Traditional runlevel      New target name     Symbolically linked to...
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>0</span>           |    runlevel0.target -&gt; poweroff.target
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>1</span>           |    runlevel1.target -&gt; rescue.target
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>2</span>           |    runlevel2.target -&gt; multi-user.target
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>3</span>           |    runlevel3.target -&gt; multi-user.target
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>4</span>           |    runlevel4.target -&gt; multi-user.target
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>5</span>           |    runlevel5.target -&gt; graphical.target
</span></span><span style=display:flex><span>Runlevel <span style=color:#1c01ce>6</span>           |    runlevel6.target -&gt; reboot.target
</span></span></code></pre></td></tr></table></div></div></div><p>它与init进程的主要差别如下：
（1）默认的 RunLevel（在/etc/inittab文件设置）现在被默认的 Target 取代，位置是/etc/systemd/system/default.target，通常符号链接到graphical.target（图形界面）或者multi-user.target（多用户命令行）。</p><p>（2）启动脚本的位置，以前是/etc/init.d目录，符号链接到不同的 RunLevel 目录 （比如/etc/rc3.d、/etc/rc5.d等），现在则存放在/lib/systemd/system和/etc/systemd/system目录。</p><p>（3）配置文件的位置，以前init进程的配置文件是/etc/inittab，各种服务的配置文件存放在/etc/sysconfig目录。现在的配置文件主要存放在/lib/systemd目录，在/etc/systemd目录里面的修改可以覆盖原始设置。</p><h1 id=日志管理>日志管理</h1><p>Systemd 统一管理所有 Unit 的启动日志。带来的好处就是，可以只用journalctl一个命令，查看所有日志（内核日志和应用日志）。日志的配置文件是/etc/systemd/journald.conf。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看所有日志（默认情况下 ，只保存本次启动的日志）</span>
</span></span><span style=display:flex><span>$ sudo journalctl
</span></span><span style=display:flex><span><span style=color:#177500># 查看内核日志（不显示应用日志）</span>
</span></span><span style=display:flex><span>$ sudo journalctl -k
</span></span><span style=display:flex><span><span style=color:#177500># 查看系统本次启动的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl -b
</span></span><span style=display:flex><span>$ sudo journalctl -b -0
</span></span><span style=display:flex><span><span style=color:#177500># 查看上一次启动的日志（需更改设置）</span>
</span></span><span style=display:flex><span>$ sudo journalctl -b -1
</span></span><span style=display:flex><span><span style=color:#177500># 查看指定时间的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl --since<span style=color:#000>=</span><span style=color:#c41a16>&#34;2012-10-30 18:17:16&#34;</span>
</span></span><span style=display:flex><span>$ sudo journalctl --since <span style=color:#c41a16>&#34;20 min ago&#34;</span>
</span></span><span style=display:flex><span>$ sudo journalctl --since yesterday
</span></span><span style=display:flex><span>$ sudo journalctl --since <span style=color:#c41a16>&#34;2015-01-10&#34;</span> --until <span style=color:#c41a16>&#34;2015-01-11 03:00&#34;</span>
</span></span><span style=display:flex><span>$ sudo journalctl --since 09:00 --until <span style=color:#c41a16>&#34;1 hour ago&#34;</span>
</span></span><span style=display:flex><span><span style=color:#177500># 显示尾部的最新10行日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl -n
</span></span><span style=display:flex><span><span style=color:#177500># 显示尾部指定行数的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl -n <span style=color:#1c01ce>20</span>
</span></span><span style=display:flex><span><span style=color:#177500># 实时滚动显示最新日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl -f
</span></span><span style=display:flex><span><span style=color:#177500># 查看指定服务的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl /usr/lib/systemd/systemd
</span></span><span style=display:flex><span><span style=color:#177500># 查看指定进程的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl <span style=color:#000>_PID</span><span style=color:#000>=</span><span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看某个路径的脚本的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl /usr/bin/bash
</span></span><span style=display:flex><span><span style=color:#177500># 查看指定用户的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl <span style=color:#000>_UID</span><span style=color:#000>=</span><span style=color:#1c01ce>33</span> --since today
</span></span><span style=display:flex><span><span style=color:#177500># 查看某个 Unit 的日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl -u nginx.service
</span></span><span style=display:flex><span>$ sudo journalctl -u nginx.service --since today
</span></span><span style=display:flex><span><span style=color:#177500># 实时滚动显示某个 Unit 的最新日志</span>
</span></span><span style=display:flex><span>$ sudo journalctl -u nginx.service -f
</span></span><span style=display:flex><span><span style=color:#177500># 合并显示多个 Unit 的日志</span>
</span></span><span style=display:flex><span>$ journalctl -u nginx.service -u php-fpm.service --since today
</span></span><span style=display:flex><span><span style=color:#177500># 查看指定优先级（及其以上级别）的日志，共有8级</span>
</span></span><span style=display:flex><span><span style=color:#177500># 0: emerg</span>
</span></span><span style=display:flex><span><span style=color:#177500># 1: alert</span>
</span></span><span style=display:flex><span><span style=color:#177500># 2: crit</span>
</span></span><span style=display:flex><span><span style=color:#177500># 3: err</span>
</span></span><span style=display:flex><span><span style=color:#177500># 4: warning</span>
</span></span><span style=display:flex><span><span style=color:#177500># 5: notice</span>
</span></span><span style=display:flex><span><span style=color:#177500># 6: info</span>
</span></span><span style=display:flex><span><span style=color:#177500># 7: debug</span>
</span></span><span style=display:flex><span>$ sudo journalctl -p err -b
</span></span><span style=display:flex><span><span style=color:#177500># 日志默认分页输出，--no-pager 改为正常的标准输出</span>
</span></span><span style=display:flex><span>$ sudo journalctl --no-pager
</span></span><span style=display:flex><span><span style=color:#177500># 以 JSON 格式（单行）输出</span>
</span></span><span style=display:flex><span>$ sudo journalctl -b -u nginx.service -o json
</span></span><span style=display:flex><span><span style=color:#177500># 以 JSON 格式（多行）输出，可读性更好</span>
</span></span><span style=display:flex><span>$ sudo journalctl -b -u nginx.serviceqq
</span></span><span style=display:flex><span> -o json-pretty
</span></span><span style=display:flex><span><span style=color:#177500># 显示日志占据的硬盘空间</span>
</span></span><span style=display:flex><span>$ sudo journalctl --disk-usage
</span></span><span style=display:flex><span><span style=color:#177500># 指定日志文件占据的最大空间</span>
</span></span><span style=display:flex><span>$ sudo journalctl --vacuum-size<span style=color:#000>=</span>1G
</span></span><span style=display:flex><span><span style=color:#177500># 指定日志文件保存多久</span>
</span></span><span style=display:flex><span>$ sudo journalctl --vacuum-time<span style=color:#000>=</span>1years
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=reference>Reference</h1><p><a href=http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html>Systemd入门教程：命令篇</a></p><p><a href=https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html>Systemd入门教程：实战篇</a></p><p><a href=https://www.ruanyifeng.com/blog/2018/03/systemd-timer.html>Systemd定时器教程</a></p><p><a href="https://blog.csdn.net/charles_neil/article/details/78448326?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ELandingCtr%7ERate-1.queryctrv2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ELandingCtr%7ERate-1.queryctrv2&utm_relevant_index=2">Linux-启动和服务(service)</a></p><p><a href=https://blog.csdn.net/u011095110/article/details/81020839>Linux下service xxx服务深入理解</a></p><p><a href=https://www.cnblogs.com/taoyuxuan/p/11468172.html>使用systemd管理程序</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-603075ac01bc3caf87450a80e3fda26d>4.5 - goreman</h1><h1 id=概述>概述</h1><p>Linux下多进程管理工具对开发和运维都很有用，常见的功能全面的主流工具主要有monit、supervisor。不过开发中使用则推荐轻量级小工具 <a href=https://github.com/mattn/goreman>goreman</a>。</p><p>goreman 是对 Ruby 下广泛使用的 foreman 的重写，毕竟基于golang的工具简单易用很多。</p><blockquote><p>goreman的作者是mattn，在golang社区挺活跃的日本的一名程序员。foreman原作者也实现了一个golang版：forego，不过没有goreman好用，举个例子：coreos的etcd就是使用的goreman来一键启停单机版的etcd集群。</p></blockquote><h1 id=安装>安装</h1><blockquote><p>前提：</p><ol><li>先安装好 go 环境</li><li>将 $GOPATH/bin 添加到 $PATH</li></ol></blockquote><p>go 工具安装都比较简单：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>go get github.com/mattn/goreman
</span></span><span style=display:flex><span><span style=color:#177500># 或</span>
</span></span><span style=display:flex><span>go install github.com/mattn/goreman@latest
</span></span><span style=display:flex><span>goreman <span style=color:#a90d91>help</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=使用>使用</h1><blockquote><p>善用 goreman help</p></blockquote><ol><li>新建一个 Procfile 文件，如果改名则需要 <code>goreman -f</code> 指定</li><li>在包含 Procfile 的目录下执行： <code>goreman start</code></li><li>关闭时直接 ctrl + c 退出，goreman 会自动把所有启动的进程都 shut down</li></ol><h1 id=举例>举例</h1><h2 id=kafka>kafka</h2><p>以 <a href="https://link.segmentfault.com/?enc=lsohoYw0%2BDPJ0r7LmzdIDw%3D%3D.j3G7cbkJOFFj9KmkW5zxerxElou1iBsI53g4YklmuTc%3D">Apache kafka</a> 的使用为例，了解的朋友应该知道，kafka 使用时通常需要启动两个进程：zookeeper 和 kafka broker，因此可以编写一个 kafka 开发环境的 Procfile：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>zookeeper: bash ~/tool/kafka_2.11-0.8.2.1/bin/zookeeper-server-start.sh config/zookeeper.properties
</span></span><span style=display:flex><span>broker: bash ~/tool/kafka_2.11-0.8.2.1/bin/kafka-server-start.sh config/server.properties
</span></span></code></pre></td></tr></table></div></div></div><p>然后执行 <code>goreman start</code> ，可以看到不同颜色区分的 zookeeper、kafka broker 进程的启动日志。
关闭时，直接 ctrl + c，则两个 bash 进程也会被自动关闭。</p><h2 id=etcd-raftexample>etcd raftexample</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># Use goreman to run `go install github.com/mattn/goreman@latest`
</span></span><span style=display:flex><span>raftexample1: ./raftexample --id 1 --cluster http://127.0.0.1:12379,http://127.0.0.1:22379,http://127.0.0.1:32379 --port 12380
</span></span><span style=display:flex><span>raftexample2: ./raftexample --id 2 --cluster http://127.0.0.1:12379,http://127.0.0.1:22379,http://127.0.0.1:32379 --port 22380
</span></span><span style=display:flex><span>raftexample3: ./raftexample --id 3 --cluster http://127.0.0.1:12379,http://127.0.0.1:22379,http://127.0.0.1:32379 --port 32380
</span></span></code></pre></td></tr></table></div></div></div><h1 id=高级用法>高级用法</h1><p>上述是最简单的使用场景：直接使用 goreman start，不过有个缺点，即 goreman 绑定到了当前的 session，而且不能灵活控制多个进程启停以及顺序。而实际开发过程中，通常需要经常单独启停某个正在开发的模块相关的进程，比如上面例子中的 kafka-broker，而 Zookeeper 通常不需要频繁启停。</p><p>可以使用更高级的 goreman run 命令来实现，如：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 先启动 Zookeeper</span>
</span></span><span style=display:flex><span>goreman run start zookeeper
</span></span><span style=display:flex><span><span style=color:#177500># 然后启动 kafka</span>
</span></span><span style=display:flex><span>goreman run start broker
</span></span><span style=display:flex><span><span style=color:#177500># 查看进程状态</span>
</span></span><span style=display:flex><span>goreman run status
</span></span><span style=display:flex><span><span style=color:#177500># 停止 broker 进程</span>
</span></span><span style=display:flex><span>goreman run stop broker
</span></span><span style=display:flex><span><span style=color:#177500># 重启 broker 进程</span>
</span></span><span style=display:flex><span>goreman run restart broker
</span></span></code></pre></td></tr></table></div></div></div><h1 id=小结>小结</h1><p>多进程管理是目前开发尤其是互联网web、服务器后端很常用的工具，尤其上云之后，云应用普遍推崇的 microservices 微服务架构进一步增加了后端进程数。而 goreman 很适合开发环境使用，能够一键式管理多个后台进程，并及时清理环境。不过真正的生产环境，还是使用monit/m、supervisor 等更成熟稳定、功能全面的多进程管理工具。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f980e31301aeace33166387bd2a4d43f>4.6 - 守护进程</h1><h1 id=简述>简述</h1><p>守护进程（daemon）是生存期长的一种进程，没有控制终端。它们常常在系统引导装入时启动，仅在系统关闭时才终止。UNIX系统有很多守护进程，守护进程程序的名称通常以字母“d”结尾：例如，<a href=https://zh.wikipedia.org/wiki/Syslog>syslogd</a> 就是指管理系统日志的守护进程。通过ps进程查看器 <code>ps -efj</code> 的输出实例，内核守护进程的名字出现在方括号中，大致输出如下：</p><h1 id=基本概念>基本概念</h1><p>进程组</p><ul><li>每个进程除了有一个进程ID之外，还属于一个进程组</li><li>进程组是一个或多个进程的集合，同一进程组中的各进程接收来自同一终端的各种信号</li><li>每个进程组有一个组长进程。组长进程的进程组ID等于其进程ID</li></ul><p>会话（session）是一个或多个进程组的集合，进程调用 setsid 函数（原型：<code>pid_t setsid(void)</code> ）建立一个会话。</p><p>进程调用 setsid 函数建立一个新会话，如果调用此函数的进程不是一个进程组的组长，则此函数创建一个新会话。具体会发生以下3件事：</p><ul><li>该进程变成新会话的会话首进程（session leader，会话首进程是创建该会话的进程）。此时，该进程是新会话的唯一进程。</li><li>该进程成为一个新进程组的组长进程。新进程组ID是该调用进程的进程ID</li><li>该进程没有控制终端。如果调用setsid之前该进程有一个控制终端，那么这种联系也被切断</li></ul><p>控制终端（Controlling Terminal）</p><p>每个会话可以有一个单独的控制终端，与控制终端连接的 Leader 就是控制进程（Controlling Process）。</p><h2 id=进程分类>进程分类</h2><p><strong>子进程</strong><code>child thread</code>：</p><p>相对父进程而言， 父进程创建的进程， 子进程只能对应一个父进程。如果没有标记为daemon ， 则杀死父进程不会对子进程的运行状态有丝毫影响。</p><p><strong>守护进程</strong><code>daemon thread</code>：</p><p>即daemon thread，是子进程的一种状态，标记子进程与父进程一起结束。</p><p><strong>僵尸进程</strong>：</p><p>本该结束，但仍在后台运行的子进程。因为某些子进程没有设置daemon 属性，如果杀死父进程，其子进程将会变成“僵尸进程”。僵尸进程的父进程将成为init 进程的子进程。</p><h2 id=基本操作>基本操作</h2><p>查看守护进程</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>ps -axj
</span></span><span style=display:flex><span>-a表示显示由其他用户所拥有的进程的状态
</span></span><span style=display:flex><span>-x显示没有控制终端的进程状态
</span></span><span style=display:flex><span>-j显示与作业有关的信息：会话ID、进程组ID等 
</span></span></code></pre></td></tr></table></div></div></div><p>如何编写守护进程</p><p>可参考《unix环境高级编程》第13章 守护进程</p><p>如何使普通进程达到守护进程的部分效果</p><p>参考 Linux后台进程 专栏</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>nohup ./a.out &amp;
</span></span></code></pre></td></tr></table></div></div></div><p>nohup忽略SIGHUP信号，&忽略SIGINT信号。</p><h1 id=守护进程的创建>守护进程的创建</h1><h2 id=fork>fork</h2><p>守护进程的父进程是 init 进程，在创建时先从父进程 fork 出来一个子进程，退出父进程，这时子进程变成孤儿，就成了 init 的子进程。</p><p>子进程会继承父进程的会话，进程组，控制终端，文件描述符等。</p><h2 id=setid>setid</h2><p>通过<code>setid()</code>来创建新会话，同时也脱离了原来的进程组，会话以及控制终端，成为新的会话的组长。此时它可能会再申请一个控制终端，所以我们再 fork 一下，并只保留新的子进程，这样就不是会话组长了，就不能申请控制终端了。</p><h3 id=close-fd>close(fd)</h3><p>之后再关闭从父进程继承的文件描述符。至少要关闭 0,1,2 这三个文件描述符，分别对应了 stdin, stdout, 和 stderr。不过通常用 <code>sysconf(_SC_OPEN_MAX)</code> 获取系统允许的最大文件描述符个数，然后全部 close 掉。</p><p>关闭之后我们要将文件描述符 0，1，2 重新定向到 "/dev/null"，防止新打开的文件的文件描述符为 0，1，2。</p><h3 id=umask-0>umask(0)</h3><p>设置文件掩码是为了不受父进程的 umask 的影响，能自由创建读写文件和目录。</p><h3 id=chdir>chdir("/")</h3><p>守护进程一般是一直执行到系统关机，在它运行过程中，它所在的目录就不能卸载（unmounted）。通过将它的工作目录转移到根目录，用来的目录就允许卸载了。也不一定要根目录（这种情况，运行需要超级权限），可以选择一个不需要卸载的路径。</p><h1 id=对比>对比</h1><h2 id=守护进程与后台进程的区别>守护进程与后台进程的区别</h2><p>1、守护进程已经完全脱离终端控制台了，而后台程序并未完全脱离终端(在终端未关闭前还是会往终端输出结果);</p><p>2、守护进程在关闭终端控制台时不会受影响，而后台程序会随用户退出而停止，需要在启动命令后加上“&”格式运行才能避免影响;</p><p>3、守护进程的会话组和当前目录、文件描述符都是独立的。后台进程运行只是终端进行了一次fork，仅仅让程序在后台执行而已。</p><h1 id=reference>Reference</h1><p><a href=https://cloud.tencent.com/developer/article/1635805>守护进程（Daemon）</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-26c4cb04ca10d7949be89845549dde58>4.7 - 进程间通信</h1><h1 id=简述>简述</h1><p>IPC（Inter-Process  Communication，进程间通信）。进程间通信是指两个进程的数据之间产生交互</p><h1 id=进程间通信方式>进程间通信方式</h1><p>有如下几种方式：</p><ul><li>管道/匿名管道(pipe)</li><li>命名管道(FIFO)</li><li>消息队列</li><li>共享内存</li><li>信号量</li><li>信号</li><li>套接字</li></ul><h1 id=管道-匿名管道-pipe>管道/匿名管道(pipe)</h1><p>匿名管道（Anonymous Pipes），即将多个命令串起来的竖线，背后的原理到底是什么。</p><p>如</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ps -ef |grep xxx |awk <span style=color:#c41a16>&#39;{print $2}&#39;</span>|xargs <span style=color:#a90d91>kill</span> -9
</span></span></code></pre></td></tr></table></div></div></div><p>创建管道，系统调用</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>pipe</span>(<span style=color:#a90d91>int</span> <span style=color:#000>fd</span>[<span style=color:#1c01ce>2</span>])
</span></span></code></pre></td></tr></table></div></div></div><p>创建管道 pipe，返回了两个文件描述符，表示管道的两端，一个是管道的读取端描述符 fd[0]，另一个是管道的写入端描述符 fd[1]。
<img src=../imgs/20220320_ipc_1.png alt=20220320_ipc_1.png></p><p>所谓的匿名管道，其实就是内核里面的一串缓存。</p><p>无论是匿名管道，还是命名管道，在内核都是一个文件。只要是文件就要有一个 inode。这里又用到了特殊 inode、字符设备、块设备，其实都是这种特殊的 inode。</p><p>在这种特殊的 inode 里面，file_operations 指向管道特殊的 pipefifo_fops，这个 inode 对应内存里面的缓存。</p><p>当用文件的 open 函数打开这个管道设备文件的时候，会调用 pipefifo_fops 里面的方法创建 struct file 结构，inode 指向特殊的 inode，也对应内存里面的缓存，file_operations 也指向管道特殊的 pipefifo_fops。</p><p>写入一个 pipe 就是从 struct file 结构找到缓存写入，读取一个 pipe 就是从 struct file 结构找到缓存读出。</p><p><img src=../imgs/20220320_ipc_2.png alt=20220320_ipc_2.png></p><h1 id=命名管道-fifo>命名管道(FIFO)</h1><p>通过 <code>mkdifo</code> 命令显示创建</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ mkfifo hello_pipe
</span></span><span style=display:flex><span>$ ls -l 
</span></span><span style=display:flex><span>prw-r--r-- <span style=color:#1c01ce>1</span> root root <span style=color:#1c01ce>0</span> May <span style=color:#1c01ce>21</span> 23:29 hello_pipe
</span></span><span style=display:flex><span><span style=color:#177500># 文件类型 p，表示 pipe</span>
</span></span></code></pre></td></tr></table></div></div></div><p>测试<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 终端1</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;hello world&#34;</span> &gt; hello_pipe <span style=color:#177500># 阻塞</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 终端2</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>echo</span> &lt; hello_pipe <span style=color:#177500># 终端1 命令退出</span>
</span></span><span style=display:flex><span>hello world 
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=消息队列>消息队列</h1><h2 id=结构体>结构体</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>struct</span> <span style=color:#3f6e75>msg_buffer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>long</span> <span style=color:#000>mtype</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>char</span> <span style=color:#000>mtext</span>[<span style=color:#1c01ce>1024</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></div><h2 id=创建消息队列>创建消息队列</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;stdio.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;stdlib.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;sys/msg.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820></span>
</span></span><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>messagequeueid</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>key_t</span> <span style=color:#000>key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span>((<span style=color:#000>key</span> <span style=color:#000>=</span> <span style=color:#000>ftok</span>(<span style=color:#c41a16>&#34;/root/messagequeue/messagequeuekey&#34;</span>, <span style=color:#1c01ce>1024</span>)) <span style=color:#000>&lt;</span> <span style=color:#1c01ce>0</span>)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;ftok error&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>exit</span>(<span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>printf</span>(<span style=color:#c41a16>&#34;Message Queue key: %d.</span>
</span></span><span style=display:flex><span><span style=color:#c41a16>&#34;, key);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ((<span style=color:#000>messagequeueid</span> <span style=color:#000>=</span> <span style=color:#000>msgget</span>(<span style=color:#000>key</span>, <span style=color:#000>IPC_CREAT</span><span style=color:#000>|</span><span style=color:#1c01ce>0777</span>)) <span style=color:#000>==</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;msgget error&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>exit</span>(<span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>printf</span>(<span style=color:#c41a16>&#34;Message queue id: %d.</span>
</span></span><span style=display:flex><span><span style=color:#c41a16>&#34;, messagequeueid);</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>运行上面的程序<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./a.out
</span></span><span style=display:flex><span>Message Queue key: 92536.
</span></span><span style=display:flex><span>Message queue id: 32768.
</span></span></code></pre></td></tr></table></div></div></div></p><p>msgget 函数；
ftok（file to key）会根据文件的 inode 生成近乎唯一的 key。</p><p>这些都属于 System V IPC 进程间通信机制体系。</p><p>System V IPC 体系有一个统一的命令行工具：ipcmk，ipcs 和 ipcrm 用于创建、查看和删除 IPC 对象。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ ipcs -q  <span style=color:#177500># 查看创建的消息队列对象</span>
</span></span><span style=display:flex><span>------ Message Queues --------
</span></span><span style=display:flex><span>key        msqid      owner      perms      used-bytes   messages    
</span></span><span style=display:flex><span>0x00016978 32768      root       777        0            <span style=color:#1c01ce>0</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=发送消息>发送消息</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;stdio.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;stdlib.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;sys/msg.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;getopt.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;string.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820></span>
</span></span><span style=display:flex><span><span style=color:#a90d91>struct</span> <span style=color:#3f6e75>msg_buffer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>long</span> <span style=color:#000>mtype</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>char</span> <span style=color:#000>mtext</span>[<span style=color:#1c01ce>1024</span>];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>main</span>(<span style=color:#a90d91>int</span> <span style=color:#000>argc</span>, <span style=color:#a90d91>char</span> <span style=color:#000>*</span><span style=color:#000>argv</span>[]) {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>next_option</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>const</span> <span style=color:#a90d91>char</span><span style=color:#000>*</span> <span style=color:#a90d91>const</span> <span style=color:#000>short_options</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;i:t:m:&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>const</span> <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>option</span> <span style=color:#000>long_options</span>[] <span style=color:#000>=</span> {
</span></span><span style=display:flex><span>    { <span style=color:#c41a16>&#34;id&#34;</span>, <span style=color:#1c01ce>1</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#2300ce>&#39;i&#39;</span>},
</span></span><span style=display:flex><span>    { <span style=color:#c41a16>&#34;type&#34;</span>, <span style=color:#1c01ce>1</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#2300ce>&#39;t&#39;</span>},
</span></span><span style=display:flex><span>    { <span style=color:#c41a16>&#34;message&#34;</span>, <span style=color:#1c01ce>1</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#2300ce>&#39;m&#39;</span>},
</span></span><span style=display:flex><span>    { <span style=color:#a90d91>NULL</span>, <span style=color:#1c01ce>0</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#1c01ce>0</span> }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>messagequeueid</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>msg_buffer</span> <span style=color:#000>buffer</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>buffer</span>.<span style=color:#000>mtype</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>len</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>char</span> <span style=color:#000>*</span> <span style=color:#000>message</span> <span style=color:#000>=</span> <span style=color:#a90d91>NULL</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>do</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>next_option</span> <span style=color:#000>=</span> <span style=color:#000>getopt_long</span> (<span style=color:#000>argc</span>, <span style=color:#000>argv</span>, <span style=color:#000>short_options</span>, <span style=color:#000>long_options</span>, <span style=color:#a90d91>NULL</span>);
</span></span><span style=display:flex><span>    <span style=color:#a90d91>switch</span> (<span style=color:#000>next_option</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#2300ce>&#39;i&#39;</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>messagequeueid</span> <span style=color:#000>=</span> <span style=color:#000>atoi</span>(<span style=color:#000>optarg</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#2300ce>&#39;t&#39;</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>buffer</span>.<span style=color:#000>mtype</span> <span style=color:#000>=</span> <span style=color:#000>atol</span>(<span style=color:#000>optarg</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#2300ce>&#39;m&#39;</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>message</span> <span style=color:#000>=</span> <span style=color:#000>optarg</span>;
</span></span><span style=display:flex><span>        <span style=color:#000>len</span> <span style=color:#000>=</span> <span style=color:#000>strlen</span>(<span style=color:#000>message</span>) <span style=color:#000>+</span> <span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>len</span> <span style=color:#000>&gt;</span> <span style=color:#1c01ce>1024</span>) {
</span></span><span style=display:flex><span>          <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;message too long.&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#000>exit</span>(<span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#000>memcpy</span>(<span style=color:#000>buffer</span>.<span style=color:#000>mtext</span>, <span style=color:#000>message</span>, <span style=color:#000>len</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#a90d91>default</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }<span style=color:#a90d91>while</span>(<span style=color:#000>next_option</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span>(<span style=color:#000>messagequeueid</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>buffer</span>.<span style=color:#000>mtype</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>len</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>message</span> <span style=color:#000>!=</span> <span style=color:#a90d91>NULL</span>){
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span>(<span style=color:#000>msgsnd</span>(<span style=color:#000>messagequeueid</span>, <span style=color:#000>&amp;</span><span style=color:#000>buffer</span>, <span style=color:#000>len</span>, <span style=color:#000>IPC_NOWAIT</span>) <span style=color:#000>==</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>){
</span></span><span style=display:flex><span>      <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;fail to send message.&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>exit</span>(<span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;arguments error&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#1c01ce>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>发送消息主要调用 msgsnd 函数。第一个参数是 message queue 的 id，第二个参数是消息的结构体，第三个参数是消息的长度，最后一个参数是 flag。这里 IPC_NOWAIT 表示发送的时候不阻塞，直接返回。
getopt_long、do-while 循环以及 switch，是用来解析命令行参数的。命令行参数的格式定义在 long_options 里面。每一项的第一个成员“id”“type”“message”是参数选项的全称，第二个成员都为 1，表示参数选项后面要跟参数，最后一个成员’i’‘t’'m’是参数选项的简称。</p><p>编译并运行这个发送程序</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>gcc -o send sendmessage.c
</span></span><span style=display:flex><span>./send -i <span style=color:#1c01ce>32768</span> -t <span style=color:#1c01ce>123</span> -m <span style=color:#c41a16>&#34;hello world&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=接收消息>接收消息</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;stdio.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;stdlib.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;sys/msg.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;getopt.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;string.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820></span>
</span></span><span style=display:flex><span><span style=color:#a90d91>struct</span> <span style=color:#3f6e75>msg_buffer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>long</span> <span style=color:#000>mtype</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>char</span> <span style=color:#000>mtext</span>[<span style=color:#1c01ce>1024</span>];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>main</span>(<span style=color:#a90d91>int</span> <span style=color:#000>argc</span>, <span style=color:#a90d91>char</span> <span style=color:#000>*</span><span style=color:#000>argv</span>[]) {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>next_option</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>const</span> <span style=color:#a90d91>char</span><span style=color:#000>*</span> <span style=color:#a90d91>const</span> <span style=color:#000>short_options</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;i:t:&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>const</span> <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>option</span> <span style=color:#000>long_options</span>[] <span style=color:#000>=</span> {
</span></span><span style=display:flex><span>    { <span style=color:#c41a16>&#34;id&#34;</span>, <span style=color:#1c01ce>1</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#2300ce>&#39;i&#39;</span>},
</span></span><span style=display:flex><span>    { <span style=color:#c41a16>&#34;type&#34;</span>, <span style=color:#1c01ce>1</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#2300ce>&#39;t&#39;</span>},
</span></span><span style=display:flex><span>    { <span style=color:#a90d91>NULL</span>, <span style=color:#1c01ce>0</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#1c01ce>0</span> }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>messagequeueid</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>msg_buffer</span> <span style=color:#000>buffer</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>long</span> <span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>do</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>next_option</span> <span style=color:#000>=</span> <span style=color:#000>getopt_long</span> (<span style=color:#000>argc</span>, <span style=color:#000>argv</span>, <span style=color:#000>short_options</span>, <span style=color:#000>long_options</span>, <span style=color:#a90d91>NULL</span>);
</span></span><span style=display:flex><span>    <span style=color:#a90d91>switch</span> (<span style=color:#000>next_option</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#2300ce>&#39;i&#39;</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>messagequeueid</span> <span style=color:#000>=</span> <span style=color:#000>atoi</span>(<span style=color:#000>optarg</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#2300ce>&#39;t&#39;</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#000>atol</span>(<span style=color:#000>optarg</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#a90d91>default</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }<span style=color:#a90d91>while</span>(<span style=color:#000>next_option</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span>(<span style=color:#000>messagequeueid</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>type</span> <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>){
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span>(<span style=color:#000>msgrcv</span>(<span style=color:#000>messagequeueid</span>, <span style=color:#000>&amp;</span><span style=color:#000>buffer</span>, <span style=color:#1c01ce>1024</span>, <span style=color:#000>type</span>, <span style=color:#000>IPC_NOWAIT</span>) <span style=color:#000>==</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>){
</span></span><span style=display:flex><span>      <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;fail to recv message.&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>exit</span>(<span style=color:#1c01ce>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>printf</span>(<span style=color:#c41a16>&#34;received message type : %d, text: %s.&#34;</span>, <span style=color:#000>buffer</span>.<span style=color:#000>mtype</span>, <span style=color:#000>buffer</span>.<span style=color:#000>mtext</span>);
</span></span><span style=display:flex><span>  } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>perror</span>(<span style=color:#c41a16>&#34;arguments error&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#1c01ce>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>收消息主要调用 msgrcv 函数，第一个参数是 message queue 的 id，第二个参数是消息的结构体，第三个参数是可接受的最大长度，第四个参数是消息类型, 最后一个参数是 flag，这里 IPC_NOWAIT 表示接收的时候不阻塞，直接返回。
编译并运行这个发送程序。可以看到，如果有消息，可以正确地读到消息；如果没有，则返回没有消息。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./recv -i <span style=color:#1c01ce>32768</span> -t <span style=color:#1c01ce>123</span>
</span></span><span style=display:flex><span>received message <span style=color:#a90d91>type</span> : 123, text: hello world.
</span></span><span style=display:flex><span>$ ./recv -i <span style=color:#1c01ce>32768</span> -t <span style=color:#1c01ce>123</span>
</span></span><span style=display:flex><span>fail to recv message.: No message of desired <span style=color:#a90d91>type</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=共享内存-share-memory>共享内存(share memory)</h1><p>共享内存也是 System V IPC 进程间通信机制体系中的。</p><h2 id=创建共享内存>创建共享内存</h2><p>创建一个共享内存，调用 shmget。在这个体系中，创建一个 IPC 对象都是 xxxget，第一个参数是 key，和 msgget 里面的 key 一样，都是唯一定位一个共享内存对象，也可以通过关联文件的方式实现唯一性。第二个参数是共享内存的大小。第三个参数如果是 IPC_CREAT，同样表示创建一个新的。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>int shmget<span style=color:#000>(</span>key_t key, size_t size, int flag<span style=color:#000>)</span>;
</span></span></code></pre></td></tr></table></div></div></div><p>创建完毕之后，可以通过 ipcs 命令查看这个共享内存。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ ipcs ­­--shmems
</span></span><span style=display:flex><span>------ Shared Memory Segments ------ ­­­­­­­­
</span></span><span style=display:flex><span>key        shmid    owner perms    bytes nattch status
</span></span><span style=display:flex><span>0x00000000 <span style=color:#1c01ce>19398656</span> marc  600    <span style=color:#1c01ce>1048576</span> 2      dest
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=访问共享内存>访问共享内存</h2><p>一个进程想要访问这一段共享内存，需要将内存加载到虚拟地址空间的某个位置，通过 shmat 函数，就是 attach 的意思。其中 addr 就是要指定 attach 到这个地方。这个地址的设定难度比较大，除非对于内存布局非常熟悉，否则可能会 attach 到一个非法地址。通常的做法是将 addr 设为 NULL，让内核选一个合适的地址。返回值就是真正被 attach 的地方。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>void *shmat<span style=color:#000>(</span>int shm_id, const void *addr, int flag<span style=color:#000>)</span>;
</span></span></code></pre></td></tr></table></div></div></div><h2 id=删除共享内存>删除共享内存</h2><p>共享内存使用完毕，可以通过 shmdt 解除绑定，然后通过 shmctl，将 cmd 设置为 IPC_RMID，从而删除这个共享内存对象。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>int shmdt<span style=color:#000>(</span>void *addr<span style=color:#000>)</span>; 
</span></span><span style=display:flex><span>int shmctl<span style=color:#000>(</span>int shm_id, int cmd, struct shmid_ds *buf<span style=color:#000>)</span>;
</span></span></code></pre></td></tr></table></div></div></div><h2 id=共享内存的创建和映射小结>共享内存的创建和映射小结</h2><p>1、调用 shmget 创建共享内存。</p><p>2、先通过 ipc_findkey 在基数树中查找 key 对应的共享内存对象 shmid_kernel 是否已经被创建过，如果已经被创建，就会被查询出来，例如 producer 创建过，在 consumer 中就会查询出来。</p><p>3、如果共享内存没有被创建过，则调用 shm_ops 的 newseg 方法，创建一个共享内存对象 shmid_kernel。例如，在 producer 中就会新建。</p><p>4、在 shmem 文件系统里面创建一个文件，共享内存对象 shmid_kernel 指向这个文件，这个文件用 struct file 表示，我们姑且称它为 file1。</p><p>5、调用 shmat，将共享内存映射到虚拟地址空间。</p><p>6、shm_obtain_object_check 先从基数树里面找到 shmid_kernel 对象。</p><p>7、创建用于内存映射到文件的 file 和 shm_file_data，这里的 struct file 我们姑且称为 file2。</p><p>8、关联内存区域 vm_area_struct 和用于内存映射到文件的 file，也即 file2，调用 file2 的 mmap 函数。</p><p>9、file2 的 mmap 函数 shm_mmap，会调用 file1 的 mmap 函数 shmem_mmap，设置 shm_file_data 和 vm_area_struct 的 vm_ops。</p><p>10、内存映射完毕之后，其实并没有真的分配物理内存，当访问内存的时候，会触发缺页异常 do_page_fault。</p><p>11、vm_area_struct 的 vm_ops 的 shm_fault 会调用 shm_file_data 的 vm_ops 的 shmem_fault。</p><p>12、在 page cache 中找一个空闲页，或者创建一个空闲页。</p><h1 id=信号量-semaphore>信号量(semaphore)</h1><p>如果两个进程 attach 同一个共享内存，很有可能冲突。</p><p>需要一种保护机制，使得同一个共享的资源，同时只能被一个进程访问。在 System V IPC 进程间通信机制体系中，早就想好了应对办法，就是信号量（Semaphore）。因此，<strong>信号量和共享内存往往要配合使用（常用模式）</strong>。</p><p>信号量其实是一个计数器，主要用于实现进程间的互斥与同步，而不是用于存储进程间通信数据。</p><p>将信号量初始化为一个数值，来代表某种资源的总体数量。对于信号量来讲，会定义两种原子操作，一个是<strong>P 操作</strong>，我们称为<strong>申请资源操作</strong>。这个操作会申请将信号量的数值减去 N，表示这些数量被他申请使用了，其他人不能用了。另一个是<strong>V 操作</strong>，我们称为<strong>归还资源操作</strong>，这个操作会申请将信号量加上 M，表示这些数量已经还给信号量了，其他人可以使用了。</p><h2 id=创建信号量>创建信号量</h2><p>创建信号量可以通过 semget 函数（都是 xxxget）。第一个参数 key 也是类似的，第二个参数 num_sems 不是指资源的数量，而是表示可以创建多少个信号量，形成一组信号量，也就是说，如果你有多种资源需要管理，可以创建一个信号量组。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>int semget<span style=color:#000>(</span>key_t key, int num_sems, int sem_flags<span style=color:#000>)</span>;
</span></span></code></pre></td></tr></table></div></div></div><p>接下来初始化信号量的总的资源数量。通过 semctl 函数，第一个参数 semid 是这个信号量组的 id，第二个参数 semnum 才是在这个信号量组中某个信号量的 id，第三个参数是命令，如果是初始化，则用 SETVAL，第四个参数是一个 union。如果初始化，应该用里面的 val 设置资源总量。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>int semctl<span style=color:#000>(</span>int semid, int semnum, int cmd, union semun args<span style=color:#000>)</span>;
</span></span><span style=display:flex><span>union semun
</span></span><span style=display:flex><span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>  int val;
</span></span><span style=display:flex><span>  struct semid_ds *buf;
</span></span><span style=display:flex><span>  unsigned short int *array;
</span></span><span style=display:flex><span>  struct seminfo *__buf;
</span></span><span style=display:flex><span><span style=color:#000>}</span>;
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=pv操作>pv操作</h2><p>无论是 P 操作还是 V 操作，统一用 semop 函数。第一个参数还是信号量组的 id，一次可以操作多个信号量。第三个参数 numops 就是有多少个操作，第二个参数将这些操作放在一个数组中。</p><p>数组的每一项是一个 struct sembuf，里面的第一个成员是这个操作的对象是哪个信号量。</p><p>第二个成员就是要对这个信号量做多少改变。如果 sem_op &lt; 0，就请求 sem_op 的绝对值的资源。如果相应的资源数可以满足请求，则将该信号量的值减去 sem_op 的绝对值，函数成功返回。</p><p>当相应的资源数不能满足请求时，就要看 sem_flg 了。如果把 sem_flg 设置为 IPC_NOWAIT，也就是没有资源也不等待，则 semop 函数出错返回 EAGAIN。如果 sem_flg 没有指定 IPC_NOWAIT，则进程挂起，直到当相应的资源数可以满足请求。若 sem_op > 0，表示进程归还相应的资源数，将 sem_op 的值加到信号量的值上。如果有进程正在休眠等待此信号量，则唤醒它们。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>int semop<span style=color:#000>(</span>int semid, struct sembuf semoparray<span style=color:#000>[]</span>, size_t numops<span style=color:#000>)</span>;
</span></span><span style=display:flex><span>struct sembuf 
</span></span><span style=display:flex><span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>  short sem_num; // 信号量组中对应的序号，0～sem_nums-1
</span></span><span style=display:flex><span>  short sem_op;  // 信号量值在一次操作中的改变量
</span></span><span style=display:flex><span>  short sem_flg; // IPC_NOWAIT, SEM_UNDO
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>信号量和共享内存都比较复杂，两者还要结合起来用，就更加复杂，它们内核的机制就更加复杂。</p><h2 id=信号量的机制小结>信号量的机制小结</h2><p><img src=../imgs/20220320_ipc_3.png alt=20220320_ipc_3.png></p><p>1、调用 semget 创建信号量集合。</p><p>2、ipc_findkey 会在基数树中，根据 key 查找信号量集合 sem_array 对象。如果已经被创建，就会被查询出来。例如 producer 被创建过，在 consumer 中就会查询出来。</p><p>3、如果信号量集合没有被创建过，则调用 sem_ops 的 newary 方法，创建一个信号量集合对象 sem_array。例如，在 producer 中就会新建。</p><p>4、调用 semctl(SETALL) 初始化信号量。</p><p>5、sem_obtain_object_check 先从基数树里面找到 sem_array 对象。</p><p>6、根据用户指定的信号量数组，初始化信号量集合，也即初始化 sem_array 对象的 struct sem sems[]成员。</p><p>7、调用 semop 操作信号量。</p><p>8、创建信号量操作结构 sem_queue，放入队列。</p><p>9、创建 undo 结构，放入链表。</p><h2 id=共享内存和信号量>共享内存和信号量</h2><p>共享内存和信号量的配合机制</p><ul><li>无论是共享内存还是信号量，创建与初始化都遵循同样流程，通过 ftok 得到 key，通过 xxxget 创建对象并生成 id；</li><li>生产者和消费者都通过 shmat 将共享内存映射到各自的内存空间，在不同的进程里面映射的位置不同；</li><li>为了访问共享内存，需要信号量进行保护，信号量需要通过 semctl 初始化为某个值；</li><li>接下来生产者和消费者要通过 semop(-1) 来竞争信号量，如果生产者抢到信号量则写入，然后通过 semop(+1) 释放信号量，如果消费者抢到信号量则读出，然后通过 semop(+1) 释放信号量；</li><li>共享内存使用完毕，可以通过 shmdt 来解除映射。
<img src=../imgs/20220320_ipc_4.png alt=20220320_ipc_4.png></li></ul><h1 id=信号-signal>信号(Signal)</h1><p>上面讲的进程间通信的方式，都是常规状态下的工作模式，对应到咱们平时的工作交接，收发邮件、联合开发等，其实还有一种异常情况下的工作模式。</p><p>例如出现线上系统故障，这个时候，什么流程都来不及了，不可能发邮件，也来不及开会，所有的架构师、开发、运维都要被通知紧急出动。所以，7 乘 24 小时不间断执行的系统都需要有告警系统，一旦出事情，就要通知到人，哪怕是半夜，也要电话叫起来，处理故障。</p><p>对应到操作系统中，就是信号。信号没有特别复杂的数据结构，就是用一个代号一样的数字。Linux 提供了几十种信号，分别代表不同的意义。信号之间依靠它们的值来区分。这就像咱们看警匪片，对于紧急的行动，都是说，“1 号作战任务”开始执行，警察就开始行动了。情况紧急，不能啰里啰嗦了。</p><p>信号可以在任何时候发送给某一进程，进程需要为这个信号配置信号处理函数。当某个信号发生的时候，就默认执行这个函数就可以了。这就相当于咱们运维一个系统应急手册，当遇到什么情况，做什么事情，都事先准备好，出了事情照着做就可以了。</p><h2 id=所有信号>所有信号</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ <span style=color:#a90d91>kill</span> -l <span style=color:#177500># 查看所有信号</span>
</span></span><span style=display:flex><span> 1<span style=color:#000>)</span> SIGHUP       2<span style=color:#000>)</span> SIGINT       3<span style=color:#000>)</span> SIGQUIT      4<span style=color:#000>)</span> SIGILL       5<span style=color:#000>)</span> SIGTRAP
</span></span><span style=display:flex><span> 6<span style=color:#000>)</span> SIGABRT      7<span style=color:#000>)</span> SIGBUS       8<span style=color:#000>)</span> SIGFPE       9<span style=color:#000>)</span> SIGKILL     10<span style=color:#000>)</span> SIGUSR1
</span></span><span style=display:flex><span>11<span style=color:#000>)</span> SIGSEGV     12<span style=color:#000>)</span> SIGUSR2     13<span style=color:#000>)</span> SIGPIPE     14<span style=color:#000>)</span> SIGALRM     15<span style=color:#000>)</span> SIGTERM
</span></span><span style=display:flex><span>16<span style=color:#000>)</span> SIGSTKFLT   17<span style=color:#000>)</span> SIGCHLD     18<span style=color:#000>)</span> SIGCONT     19<span style=color:#000>)</span> SIGSTOP     20<span style=color:#000>)</span> SIGTSTP
</span></span><span style=display:flex><span>21<span style=color:#000>)</span> SIGTTIN     22<span style=color:#000>)</span> SIGTTOU     23<span style=color:#000>)</span> SIGURG      24<span style=color:#000>)</span> SIGXCPU     25<span style=color:#000>)</span> SIGXFSZ
</span></span><span style=display:flex><span>26<span style=color:#000>)</span> SIGVTALRM   27<span style=color:#000>)</span> SIGPROF     28<span style=color:#000>)</span> SIGWINCH    29<span style=color:#000>)</span> SIGIO       30<span style=color:#000>)</span> SIGPWR
</span></span><span style=display:flex><span>31<span style=color:#000>)</span> SIGSYS      34<span style=color:#000>)</span> SIGRTMIN    35<span style=color:#000>)</span> SIGRTMIN+1  36<span style=color:#000>)</span> SIGRTMIN+2  37<span style=color:#000>)</span> SIGRTMIN+3
</span></span><span style=display:flex><span>38<span style=color:#000>)</span> SIGRTMIN+4  39<span style=color:#000>)</span> SIGRTMIN+5  40<span style=color:#000>)</span> SIGRTMIN+6  41<span style=color:#000>)</span> SIGRTMIN+7  42<span style=color:#000>)</span> SIGRTMIN+8
</span></span><span style=display:flex><span>43<span style=color:#000>)</span> SIGRTMIN+9  44<span style=color:#000>)</span> SIGRTMIN+10 45<span style=color:#000>)</span> SIGRTMIN+11 46<span style=color:#000>)</span> SIGRTMIN+12 47<span style=color:#000>)</span> SIGRTMIN+13
</span></span><span style=display:flex><span>48<span style=color:#000>)</span> SIGRTMIN+14 49<span style=color:#000>)</span> SIGRTMIN+15 50<span style=color:#000>)</span> SIGRTMAX-14 51<span style=color:#000>)</span> SIGRTMAX-13 52<span style=color:#000>)</span> SIGRTMAX-12
</span></span><span style=display:flex><span>53<span style=color:#000>)</span> SIGRTMAX-11 54<span style=color:#000>)</span> SIGRTMAX-10 55<span style=color:#000>)</span> SIGRTMAX-9  56<span style=color:#000>)</span> SIGRTMAX-8  57<span style=color:#000>)</span> SIGRTMAX-7
</span></span><span style=display:flex><span>58<span style=color:#000>)</span> SIGRTMAX-6  59<span style=color:#000>)</span> SIGRTMAX-5  60<span style=color:#000>)</span> SIGRTMAX-4  61<span style=color:#000>)</span> SIGRTMAX-3  62<span style=color:#000>)</span> SIGRTMAX-2
</span></span><span style=display:flex><span>63<span style=color:#000>)</span> SIGRTMAX-1  64<span style=color:#000>)</span> SIGRTMAX
</span></span></code></pre></td></tr></table></div></div></div><p>可以通过 <code>man 7 signal</code> 命令查看,<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>Signal     Value     Action   Comment
</span></span><span style=display:flex><span>──────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>SIGHUP        1       Term    Hangup detected on controlling terminal
</span></span><span style=display:flex><span>                              or death of controlling process
</span></span><span style=display:flex><span>SIGINT        2       Term    Interrupt from keyboard
</span></span><span style=display:flex><span>SIGQUIT       3       Core    Quit from keyboard
</span></span><span style=display:flex><span>SIGILL        4       Core    Illegal Instruction
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SIGABRT       6       Core    Abort signal from abort<span style=color:#000>(</span>3<span style=color:#000>)</span>
</span></span><span style=display:flex><span>SIGFPE        8       Core    Floating point exception
</span></span><span style=display:flex><span>SIGKILL       9       Term    Kill signal
</span></span><span style=display:flex><span>SIGSEGV      11       Core    Invalid memory reference
</span></span><span style=display:flex><span>SIGPIPE      13       Term    Broken pipe: write to pipe with no
</span></span><span style=display:flex><span>                              readers
</span></span><span style=display:flex><span>SIGALRM      14       Term    Timer signal from alarm<span style=color:#000>(</span>2<span style=color:#000>)</span>
</span></span><span style=display:flex><span>SIGTERM      15       Term    Termination signal
</span></span><span style=display:flex><span>SIGUSR1   30,10,16    Term    User-defined signal <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>SIGUSR2   31,12,17    Term    User-defined signal <span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>……
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>每个信号都有唯一的 ID，还有遇到信号的默认操作（Action）。</p><h2 id=信号处理方式>信号处理方式</h2><p>一旦有信号产生，用户进程对信号的处理方式：</p><p>1、执行默认操作。即上面列表中的 Action。如 Term 是终止进程的意思。 Core 是 Core Dump，终止进程后，通过Core Dump 将当前进程的运行状态保存在文件里面，方便事后分析。</p><p>2、捕捉信号。我们可以为信号定义一个信号处理函数。当信号发生时，我们就执行相应的信号处理函数。</p><p>3、忽略信号。但有两个信号是应用进程无法捕捉和忽略的，即 SIGKILL 和 SEGSTOP，它们用于在任何时候中断或结束某一进程。</p><h2 id=信号处理流程>信号处理流程</h2><p>信号处理最常见的流程。这个过程主要是分成两步，第一步是注册信号处理函数。第二步是发送信号。</p><h3 id=信号注册>信号注册</h3><h4 id=signal>signal</h4><p>如果不想让某个信号执行默认操作，一种方法就是对特定的信号注册相应的信号处理函数，设置号处理方式的是 <strong>signal</strong> 函数。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>typedef</span> <span style=color:#000>void</span> (<span style=color:#000>*</span><span style=color:#000>sighandler_t</span>)(<span style=color:#a90d91>int</span>);
</span></span><span style=display:flex><span><span style=color:#000>sighandler_t</span> <span style=color:#000>signal</span>(<span style=color:#a90d91>int</span> <span style=color:#000>signum</span>, <span style=color:#000>sighandler_t</span> <span style=color:#000>handler</span>);
</span></span></code></pre></td></tr></table></div></div></div><p>其实就是定义一个方法，并且将这个方法和某个信号关联起来。当这个进程遇到这个信号的时候，就执行这个方法。
signal 的 glibc 实现</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#633820>#  define signal __sysv_signal
</span></span></span><span style=display:flex><span><span style=color:#633820></span><span style=color:#000>__sighandler_t</span>
</span></span><span style=display:flex><span><span style=color:#000>__sysv_signal</span> (<span style=color:#a90d91>int</span> <span style=color:#000>sig</span>, <span style=color:#000>__sighandler_t</span> <span style=color:#000>handler</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>act</span>, <span style=color:#000>oact</span>;
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  <span style=color:#000>act</span>.<span style=color:#000>sa_handler</span> <span style=color:#000>=</span> <span style=color:#000>handler</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>__sigemptyset</span> (<span style=color:#000>&amp;</span><span style=color:#000>act</span>.<span style=color:#000>sa_mask</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>act</span>.<span style=color:#000>sa_flags</span> <span style=color:#000>=</span> <span style=color:#000>SA_ONESHOT</span> <span style=color:#000>|</span> <span style=color:#000>SA_NOMASK</span> <span style=color:#000>|</span> <span style=color:#000>SA_INTERRUPT</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>act</span>.<span style=color:#000>sa_flags</span> <span style=color:#000>&amp;=</span> <span style=color:#000>~</span><span style=color:#000>SA_RESTART</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>__sigaction</span> (<span style=color:#000>sig</span>, <span style=color:#000>&amp;</span><span style=color:#000>act</span>, <span style=color:#000>&amp;</span><span style=color:#000>oact</span>) <span style=color:#000>&lt;</span> <span style=color:#1c01ce>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>SIG_ERR</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#000>oact</span>.<span style=color:#000>sa_handler</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000>weak_alias</span> (<span style=color:#000>__sysv_signal</span>, <span style=color:#000>sysv_signal</span>)
</span></span></code></pre></td></tr></table></div></div></div><p>sa_flags 进行了默认的设置。SA_ONESHOT 意思就是设置的信号处理函数，仅仅起作用一次。用完了一次就设置回默认行为。
另外一个设置 SA_NOMASK。通过 __sigemptyset，将 sa_mask 设置为空。表示在这个信号处理函数执行过程中，如果再有其他信号（哪怕相同的信号），这个信号处理函数会被中断。</p><p>例如，如果是相同的信号，很可能操作的是同一个实例，同步、死锁等问题。一般的思路：某个信号的信号处理函数运行的时候，暂时屏蔽这个信号。屏蔽并不意味着信号一定丢失，而是暂存，这样能够做到信号处理函数对于相同的信号，处理完一个再处理下一个，信号处理函数的逻辑要简单很多。</p><p>还有一个设置就是设置了 SA_INTERRUPT，清除了 SA_RESTART。信号的到来时间是不可预期的，有可能程序正在调用某个漫长的系统调用的时候（可以在一台 Linux 机器上运行 man 7 signal 命令，在这里找 Interruption of system calls and library functions by signal handlers 的部分，里面说得非常详细），这个时候一个信号来了，会中断这个系统调用，去执行信号处理函数，那执行完后系统调用怎么处理？</p><p>有两种处理方法：一种是 SA_INTERRUPT，即系统调用被中断了，不再重试这个系统调用了，而是直接返回一个 -EINTR 常量，告诉调用方系统调用被信号中断了，但是怎么处理你看着办。这样调用方可以根据自己的逻辑，重新调用或直接返回，这会使得代码非常复杂，在所有系统调用的返回值判断里面，都要特殊判断一下这个值。</p><p>另外一种处理方法是 SA_RESTART。这个时候系统调用会被自动重新启动，不需要调用方自己写代码。（当然也可能存在问题，例如从终端读入一个字符'a'，处理'a'字符的时候被信号中断了，等信号处理完毕再次读入一个字符时，如果用户不再输入就阻塞，需要用户再次输入同一个字符。）</p><p>因此建议使用 sigaction 函数，根据需要定制参数。</p><h4 id=sigaction>sigaction</h4><p>如果在 Linux 下面执行 <code>man signal</code> 的话，会发现 Linux 不建议直接用这个方法，而是改用 sigaction。定义如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>sigaction</span>(<span style=color:#a90d91>int</span> <span style=color:#000>signum</span>, <span style=color:#a90d91>const</span> <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>*</span><span style=color:#000>act</span>,
</span></span><span style=display:flex><span>                     <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>*</span><span style=color:#000>oldact</span>);
</span></span></code></pre></td></tr></table></div></div></div><p>其实它还是将信号和一个动作进行关联，只不过这个动作由一个结构 struct sigaction 表示了。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> {
</span></span><span style=display:flex><span>  <span style=color:#000>__sighandler_t</span> <span style=color:#000>sa_handler</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>unsigned</span> <span style=color:#a90d91>long</span> <span style=color:#000>sa_flags</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>__sigrestore_t</span> <span style=color:#000>sa_restorer</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>sigset_t</span> <span style=color:#000>sa_mask</span>;    <span style=color:#177500>/* mask last for extensibility */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></div></p><p>和 signal 类似的是，这里面有 __sighandler_t。但是，其他成员变量可以更加细致地控制信号处理的行为。而 signal 函数没有机会设置这些。这里需要注意的是，signal 不是系统调用，而是 glibc 封装的一个函数。这样就像 man signal 里面写的一样，不同的实现方式，设置的参数会不同，会导致行为的不同。
glibc 里面有个文件 syscalls.list。定义了库函数调用哪些系统调用，这里包含 sigaction。</p><p>glibc 中，__sigaction 会调用 __libc_sigaction，并最终调用的系统调用是 rt_sigaction。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>int</span>
</span></span><span style=display:flex><span><span style=color:#000>__sigaction</span> (<span style=color:#a90d91>int</span> <span style=color:#000>sig</span>, <span style=color:#a90d91>const</span> <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>*</span><span style=color:#000>act</span>, <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>*</span><span style=color:#000>oact</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#000>__libc_sigaction</span> (<span style=color:#000>sig</span>, <span style=color:#000>act</span>, <span style=color:#000>oact</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>int</span>
</span></span><span style=display:flex><span><span style=color:#000>__libc_sigaction</span> (<span style=color:#a90d91>int</span> <span style=color:#000>sig</span>, <span style=color:#a90d91>const</span> <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>*</span><span style=color:#000>act</span>, <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>*</span><span style=color:#000>oact</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>result</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>kernel_sigaction</span> <span style=color:#000>kact</span>, <span style=color:#000>koact</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>act</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#000>kact</span>.<span style=color:#000>k_sa_handler</span> <span style=color:#000>=</span> <span style=color:#000>act</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_handler</span>;
</span></span><span style=display:flex><span>      <span style=color:#000>memcpy</span> (<span style=color:#000>&amp;</span><span style=color:#000>kact</span>.<span style=color:#000>sa_mask</span>, <span style=color:#000>&amp;</span><span style=color:#000>act</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_mask</span>, <span style=color:#a90d91>sizeof</span> (<span style=color:#000>sigset_t</span>));
</span></span><span style=display:flex><span>      <span style=color:#000>kact</span>.<span style=color:#000>sa_flags</span> <span style=color:#000>=</span> <span style=color:#000>act</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_flags</span> <span style=color:#000>|</span> <span style=color:#000>SA_RESTORER</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>kact</span>.<span style=color:#000>sa_restorer</span> <span style=color:#000>=</span> <span style=color:#000>&amp;</span><span style=color:#000>restore_rt</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>INLINE_SYSCALL</span> (<span style=color:#000>rt_sigaction</span>, <span style=color:#1c01ce>4</span>,
</span></span><span style=display:flex><span>                           <span style=color:#000>sig</span>, <span style=color:#000>act</span> <span style=color:#000>?</span> <span style=color:#000>&amp;</span><span style=color:#000>kact</span> : <span style=color:#a90d91>NULL</span>,
</span></span><span style=display:flex><span>                           <span style=color:#000>oact</span> <span style=color:#000>?</span> <span style=color:#000>&amp;</span><span style=color:#000>koact</span> : <span style=color:#a90d91>NULL</span>, <span style=color:#000>_NSIG</span> <span style=color:#000>/</span> <span style=color:#1c01ce>8</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>oact</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>result</span> <span style=color:#000>&gt;=</span> <span style=color:#1c01ce>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#000>oact</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_handler</span> <span style=color:#000>=</span> <span style=color:#000>koact</span>.<span style=color:#000>k_sa_handler</span>;
</span></span><span style=display:flex><span>      <span style=color:#000>memcpy</span> (<span style=color:#000>&amp;</span><span style=color:#000>oact</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_mask</span>, <span style=color:#000>&amp;</span><span style=color:#000>koact</span>.<span style=color:#000>sa_mask</span>, <span style=color:#a90d91>sizeof</span> (<span style=color:#000>sigset_t</span>));
</span></span><span style=display:flex><span>      <span style=color:#000>oact</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_flags</span> <span style=color:#000>=</span> <span style=color:#000>koact</span>.<span style=color:#000>sa_flags</span>;
</span></span><span style=display:flex><span>      <span style=color:#000>oact</span><span style=color:#000>-&gt;</span><span style=color:#000>sa_restorer</span> <span style=color:#000>=</span> <span style=color:#000>koact</span>.<span style=color:#000>sa_restorer</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#000>result</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>我们的库函数虽然调用的是 sigaction，到了系统调用层，调用的可不是系统调用 sigaction，而是系统调用 rt_sigaction。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>SYSCALL_DEFINE4</span>(<span style=color:#000>rt_sigaction</span>, <span style=color:#a90d91>int</span>, <span style=color:#000>sig</span>,
</span></span><span style=display:flex><span>    <span style=color:#a90d91>const</span> <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>__user</span> <span style=color:#000>*</span>, <span style=color:#000>act</span>,
</span></span><span style=display:flex><span>    <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigaction</span> <span style=color:#000>__user</span> <span style=color:#000>*</span>, <span style=color:#000>oact</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>size_t</span>, <span style=color:#000>sigsetsize</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>k_sigaction</span> <span style=color:#000>new_sa</span>, <span style=color:#000>old_sa</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>ret</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#000>EINVAL</span>;
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>act</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>copy_from_user</span>(<span style=color:#000>&amp;</span><span style=color:#000>new_sa</span>.<span style=color:#000>sa</span>, <span style=color:#000>act</span>, <span style=color:#a90d91>sizeof</span>(<span style=color:#000>new_sa</span>.<span style=color:#000>sa</span>)))
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>-</span><span style=color:#000>EFAULT</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>ret</span> <span style=color:#000>=</span> <span style=color:#000>do_sigaction</span>(<span style=color:#000>sig</span>, <span style=color:#000>act</span> <span style=color:#000>?</span> <span style=color:#000>&amp;</span><span style=color:#000>new_sa</span> : <span style=color:#a90d91>NULL</span>, <span style=color:#000>oact</span> <span style=color:#000>?</span> <span style=color:#000>&amp;</span><span style=color:#000>old_sa</span> : <span style=color:#a90d91>NULL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>ret</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>oact</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>copy_to_user</span>(<span style=color:#000>oact</span>, <span style=color:#000>&amp;</span><span style=color:#000>old_sa</span>.<span style=color:#000>sa</span>, <span style=color:#a90d91>sizeof</span>(<span style=color:#000>old_sa</span>.<span style=color:#000>sa</span>)))
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>-</span><span style=color:#000>EFAULT</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span><span style=color:#000>out</span>:
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#000>ret</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>在 rt_sigaction 里面将用户态的 struct sigaction 结构，拷贝为内核态的 k_sigaction，然后调用 do_sigaction。进程内核的数据结构里 struct task_struct 里面有一个成员 sighand，里面有一个 action。这是一个数组，下标是信号，内容就是信号处理函数，do_sigaction 就是设置 sighand 里的信号处理函数。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>do_sigaction</span>(<span style=color:#a90d91>int</span> <span style=color:#000>sig</span>, <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>k_sigaction</span> <span style=color:#000>*</span><span style=color:#000>act</span>, <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>k_sigaction</span> <span style=color:#000>*</span><span style=color:#000>oact</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>task_struct</span> <span style=color:#000>*</span><span style=color:#000>p</span> <span style=color:#000>=</span> <span style=color:#000>current</span>, <span style=color:#000>*</span><span style=color:#000>t</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>k_sigaction</span> <span style=color:#000>*</span><span style=color:#000>k</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>sigset_t</span> <span style=color:#000>mask</span>;
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  <span style=color:#000>k</span> <span style=color:#000>=</span> <span style=color:#000>&amp;</span><span style=color:#000>p</span><span style=color:#000>-&gt;</span><span style=color:#000>sighand</span><span style=color:#000>-&gt;</span><span style=color:#000>action</span>[<span style=color:#000>sig</span><span style=color:#000>-</span><span style=color:#1c01ce>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>spin_lock_irq</span>(<span style=color:#000>&amp;</span><span style=color:#000>p</span><span style=color:#000>-&gt;</span><span style=color:#000>sighand</span><span style=color:#000>-&gt;</span><span style=color:#000>siglock</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>oact</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>*</span><span style=color:#000>oact</span> <span style=color:#000>=</span> <span style=color:#000>*</span><span style=color:#000>k</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>act</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>sigdelsetmask</span>(<span style=color:#000>&amp;</span><span style=color:#000>act</span><span style=color:#000>-&gt;</span><span style=color:#000>sa</span>.<span style=color:#000>sa_mask</span>,
</span></span><span style=display:flex><span>            <span style=color:#000>sigmask</span>(<span style=color:#000>SIGKILL</span>) <span style=color:#000>|</span> <span style=color:#000>sigmask</span>(<span style=color:#000>SIGSTOP</span>));
</span></span><span style=display:flex><span>    <span style=color:#000>*</span><span style=color:#000>k</span> <span style=color:#000>=</span> <span style=color:#000>*</span><span style=color:#000>act</span>;
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>spin_unlock_irq</span>(<span style=color:#000>&amp;</span><span style=color:#000>p</span><span style=color:#000>-&gt;</span><span style=color:#000>sighand</span><span style=color:#000>-&gt;</span><span style=color:#000>siglock</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#1c01ce>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>至此，信号处理函数的注册已经完成了。
<strong>信号注册小结</strong></p><ul><li>在用户程序里面，有两个函数可以调用，一个是 signal，一个是 sigaction，推荐使用 sigaction。</li><li>用户程序调用的是 Glibc 里面的函数，signal 调用的是 __sysv_signal，里面默认设置了一些参数，使得 signal 的功能受到了限制，sigaction 调用的是 __sigaction，参数用户可以任意设定。</li><li>无论是 __sysv_signal 还是 __sigaction，调用的都是统一的一个系统调用 rt_sigaction。</li><li>在内核中，rt_sigaction 调用的是 do_sigaction 设置信号处理函数。在每一个进程的 task_struct 里面，都有一个 sighand 指向 struct sighand_struct，里面是一个数组，下标是信号，里面的内容是信号处理函数。
<img src=../imgs/20220320_ipc_5.png alt=20220320_ipc_5.png></li></ul><h3 id=信号发送处理>信号发送处理</h3><p>有时候，我们在终端输入某些组合键的时候，会给进程发送信号，例如，Ctrl+C 产生 SIGINT 信号，Ctrl+Z 产生 SIGTSTP 信号。</p><p>硬件异常也会产生信号。比如，执行了除以 0 的指令，CPU 就会产生异常，然后把 SIGFPE 信号发送给进程。再如，进程访问了非法内存，内存管理模块就会产生异常，然后把信号 SIGSEGV 发送给进程。</p><p>注意，同样是硬件产生的，中断和信号的区别：中断要注册中断处理函数，但是中断处理函数是在内核驱动里面的，信号也要注册信号处理函数，但是在用户态进程里面。</p><p>对于硬件触发的，无论是中断还是信号，肯定是先到内核的，然后内核对于中断和信号处理方式不同。一个是完全在内核里面处理完毕，一个是将信号放在对应的进程 task_struct 里信号相关的数据结构里面，然后等待进程在用户态去处理。当然有些严重的信号，内核会把进程干掉。中断和信号的严重程度不一样，信号影响的往往是某一个进程，处理慢了或最多也不过这个进程被干掉，而中断影响的是整个系统，一旦中断处理中有了 bug，可能整个 Linux 都挂了。</p><p>内核在某些情况下，也会给进程发送信号。例如，向读端已关闭的管道写数据时产生 SIGPIPE 信号，当子进程退出时，我们要给父进程发送 SIG_CHLD 信号等。</p><p>最直接的发送信号的方法就是，通过命令 kill 来发送信号了。例如，我们都知道的 <code>kill -9 pid</code> 可以发送信号给一个进程，杀死它。</p><p>另外，我们还可以通过 kill 或者 sigqueue 系统调用，发送信号给某个进程，也可以通过 tkill 或者 tgkill 发送信号给某个线程。虽然方式多种多样，但是最终都是调用了 do_send_sig_info 函数，将信号放在相应的 task_struct 的信号数据结构中。</p><p>各个命令调用链路如下：</p><ul><li>kill->kill_something_info->kill_pid_info->group_send_sig_info->do_send_sig_info</li><li>tkill->do_tkill->do_send_specific->do_send_sig_info</li><li>tgkill->do_tkill->do_send_specific->do_send_sig_info</li><li>rt_sigqueueinfo->do_rt_sigqueueinfo->kill_proc_info->kill_pid_info->group_send_sig_info->do_send_sig_info</li></ul><p>do_send_sig_info 会调用 send_signal，进而调用 __send_signal。</p><p>进程数据结构中 task_struct 里面的 sigpending。上面的代码先要决定应该用哪个 sigpending。取决于信号是给进程的还是线程的。如果是 kill 发送的，也就是发送给整个进程的，就应该发送给 t->signal->shared_pending。这里面是整个进程所有线程共享的信号。如果是 tkill 发送的，也就是发给某个线程的，应该发给 t->pending。这里面是这个线程的 task_struct 独享的。</p><p>struct sigpending 里面有两个成员，一个是集合 sigset_t，表示收到了哪些信号，另一个链表，也表示收到了哪些信号。结构如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#a90d91>struct</span> <span style=color:#3f6e75>sigpending</span> {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>struct</span> <span style=color:#3f6e75>list_head</span> <span style=color:#000>list</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>sigset_t</span> <span style=color:#000>signal</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></div><p>两者的区别
（细节较多，暂略）</p><p><strong>信号的发送与处理流程</strong></p><p>1、假设有一个进程 A，main 函数里面调用系统调用进入内核。</p><p>2、按照系统调用的原理，会将用户态栈的信息保存在 pt_regs 里面，也即记住原来用户态是运行到了 line A 的地方。</p><p>3、在内核中执行系统调用读取数据。</p><p>4、当发现没有什么数据可读取的时候，进入睡眠状态，并且调用 schedule 让出 CPU，这是进程调度第一定律。</p><p>5、将进程状态设置为 TASK_INTERRUPTIBLE，可中断的睡眠状态，也即如果有信号来的话，是可以唤醒它的。</p><p>6、其他的进程或者 shell 发送一个信号，有四个函数可以调用 kill、tkill、tgkill、rt_sigqueueinfo。</p><p>7、四个发送信号的函数，在内核中最终都是调用 do_send_sig_info。</p><p>8、do_send_sig_info 调用 send_signal 给进程 A 发送一个信号，其实就是找到进程 A 的 task_struct，或者加入信号集合，为不可靠信号，或者加入信号链表，为可靠信号。</p><p>9、do_send_sig_info 调用 signal_wake_up 唤醒进程 A。</p><p>10、进程 A 重新进入运行状态 TASK_RUNNING，根据进程调度第一定律，一定会接着 schedule 运行。</p><p>11、进程 A 被唤醒后，检查是否有信号到来，如果没有，重新循环到一开始，尝试再次读取数据，如果还是没有数据，再次进入 TASK_INTERRUPTIBLE，即可中断的睡眠状态。</p><p>12、当发现有信号到来的时候，就返回当前正在执行的系统调用，并返回一个错误表示系统调用被中断了。</p><p>13、系统调用返回的时候，会调用 exit_to_usermode_loop。这是一个处理信号的时机。</p><p>14、调用 do_signal 开始处理信号。</p><p>15、根据信号，得到信号处理函数 sa_handler，然后修改 pt_regs 中的用户态栈的信息，让 pt_regs 指向 sa_handler。同时修改用户态的栈，插入一个栈帧 sa_restorer，里面保存了原来的指向 line A 的 pt_regs，并且设置让 sa_handler 运行完毕后，跳到 sa_restorer 运行。</p><p>16、返回用户态，由于 pt_regs 已经设置为 sa_handler，则返回用户态执行 sa_handler。</p><p>17、sa_handler 执行完毕后，信号处理函数就执行完了，接着根据第 15 步对于用户态栈帧的修改，会跳到 sa_restorer 运行。</p><p>18、sa_restorer 会调用系统调用 rt_sigreturn 再次进入内核。</p><p>19、在内核中，rt_sigreturn 恢复原来的 pt_regs，重新指向 line A。</p><p>20、从 rt_sigreturn 返回用户态，还是调用 exit_to_usermode_loop。</p><p>21、这次因为 pt_regs 已经指向 line A 了，于是就到了进程 A 中，接着系统调用之后运行，当然这个系统调用返回的是它被中断了，没有执行完的错误。</p><h1 id=套接字-socket>套接字(socket)</h1><h1 id=reference>Reference</h1><p><a href=https://www.jianshu.com/p/c1015f5ffa74>https://www.jianshu.com/p/c1015f5ffa74</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-2f72ff9138894ca6f7c89ae54772e10e>5 - 文件系统</h1><h1 id=introduction>Introduction</h1><p>文件系统相关</p></div><div class=td-content><h1 id=pg-2ee2ec2642eaef42de79f646b1afbde5>5.1 - Linux文件系统-01设备</h1><h1 id=linux文件系统>Linux文件系统</h1><h2 id=简介>简介</h2><p>Linux有多种文件系统，不同的文件系统支持不同的体系。文件系统是管理数据的，而存储数据的物理设备有硬盘、 U盘、 SD卡、 NAND FLASH、 NOR FLASH、网络存储设备等。不同的存储设备有不同的物理结构，因此就需要不同的文件系统去管理，比如管理 NAND FLASH 使用YAFFS 文件系统，管理硬盘/SD卡使用ext文件系统等。</p><h2 id=分类>分类</h2><p>Linux支持很多文件系统格式，常见文件系统类型：</p><p>ext2 ： 早期linux中常用的文件系统</p><p>ext3 ： ext2的升级版，带日志功能</p><p>RAMFS ： 内存文件系统，速度很快</p><p>NFS ： 网络文件系统，由SUN发明，主要用于远程文件共享</p><p>MS-DOS ： MS-DOS文件系统</p><p>VFAT ： Windows 95/98 操作系统采用的文件系统</p><p>FAT ： Windows XP 操作系统采用的文件系统</p><p>NTFS： Windows NT/XP 操作系统采用的文件系统</p><p>HPFS ： OS/2 操作系统采用的文件系统</p><p>PROC : 虚拟的进程文件系统</p><p>ISO9660 ： 大部分光盘所采用的文件系统</p><p>ufsSun : OS 所采用的文件系统</p><p>NCPFS ： Novell 服务器所采用的文件系统</p><p>SMBFS ： Samba 的共享文件系统</p><p>XFS ： 由SGI开发的先进的日志文件系统，支持超大容量文件</p><p>JFS ：IBM的AIX使用的日志文件系统</p><p>ReiserFS : 基于平衡树结构的文件系统</p><p>udf: 可擦写的数据光盘文件系统</p><p>大体可分以下几类：</p><h3 id=磁盘文件系统>磁盘文件系统</h3><p>指本地主机中实际可以访问到的文件系统，包括硬盘、CD-ROM、DVD、USB存储器、磁盘阵列等。常见格式有：Ext2、Ext3、Ext4、JFS、NTFS、UFS、FAT、FAT16、FAT32等</p><h3 id=网络文件系统>网络文件系统</h3><p>是可以远程访问的文件系统，在服务器端仍是本地磁盘文件系统，客户机通过网络远程访问数据。 常见格式有：NFS、Samba等</p><h3 id=专有-虚拟文件系统>专有/虚拟文件系统</h3><p>不驻留在磁盘上的文件系统。常见格式有：TMPFS、PROCFS等。</p><h1 id=磁盘文件系统-1>磁盘文件系统</h1><p>目前Ext4（Extended File sytem，扩展文件系统）是广泛使用的一种磁盘文件系统格式。是在Ext3基础上发展起来的，对有效性保护、数据完整性、数据访问速度、向下兼容性等方面做了改进，其特点是日志文件系统：可将整个磁盘的写入动作完整地记录在磁盘的某个区域上，以便在必要时回溯追踪。</p><p>磁盘是一种计算机的外部存储器设备，由一个或多个覆盖有磁性材料的铝制或玻璃制的碟片组成，用来存储用户的信息，这种信息可以反复地被读取和改写。磁盘主要分为一下几类：</p><h2 id=ide磁盘>IDE磁盘</h2><p>Integrated Drive Electronics，价格低廉，兼容性强，性价比高，但是数据传输慢，不支持热插拔等。</p><h2 id=scsi磁盘>SCSI磁盘</h2><p>Small Computer System Interface，传输速率高，读写性能好，运行稳定，可连接多个设备，支持热插拔，占用CPU低，但是价格相对较贵，一般用于工作站或服务器上。</p><h2 id=sata磁盘>SATA磁盘</h2><p>Serial Advanced Technology Attachment，结构简单、支持热插拔。</p><h1 id=磁盘分区>磁盘分区</h1><p>为了便于管理和使用，通常会对磁盘进行分区。</p><p><img src=../imgs/file_sys_01_1.png alt=file_sys_01_1.png></p><h2 id=主分区>主分区</h2><p>必须要存在的分区，最多能创建4个，最少1个，编号只能是1 - 4 （比如sda1、sda2、sda3、sda4），可以直接格式化，然后安装系统直接存放文件。</p><h2 id=扩展分区>扩展分区</h2><p>会占用主分区位置，即主分区+扩展分区之和最多4个。相当于独立的磁盘，有独立的分区表，但不能独立的存放数据</p><h2 id=逻辑分区>逻辑分区</h2><p>扩展分区不能直接存放数据，必须经过再次分割成为逻辑分区后才能存放数据。一个扩展分区中的逻辑分区可以有任意多个，编号只能从5开始。</p><h2 id=交换分区>交换分区</h2><p>安装系统时建立的，一块特殊的硬盘空间，当实际内存不够用时，操作系统会从内存中取出部分暂时不用的数据，放在swap中，为当前程序腾出足够的内存空间。swap不会使用到目录树的挂载，无需指定挂载点（即cd无法进入）。</p><h1 id=设备>设备</h1><p>设备接入系统后都是以文件的形式存在</p><h2 id=设备文件名称>设备文件名称</h2><table><thead><tr><th style=text-align:left>设备类型</th><th style=text-align:left>文件名称</th></tr></thead><tbody><tr><td style=text-align:left>SATA/SAS/USB</td><td style=text-align:left>/dev/sda,/dev/sdb （s= SATA, d=DISK a=第几块）</td></tr><tr><td style=text-align:left>IDE</td><td style=text-align:left>/dev/hd0,/dev/hd1 （h= hard）</td></tr><tr><td style=text-align:left>VIRTIO-BLOCK</td><td style=text-align:left>/dev/vda,/dev/vdb （v=virtio）虚拟io输出</td></tr><tr><td style=text-align:left>M2（SSD）</td><td style=text-align:left>/dev/nvme0,/dev/nvme1（nvme=m2）</td></tr><tr><td style=text-align:left>SD/MMC/EMMC(卡)</td><td style=text-align:left>/dev/mmcblk0,/dev/mmcblk1（mmcblk=mmc卡 ）</td></tr><tr><td style=text-align:left>光驱</td><td style=text-align:left>/cdrom,/dev/sr0,/dev/sr1</td></tr></tbody></table><h2 id=设备命令规则>设备命令规则</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>/dev/sd  a  5
</span></span><span style=display:flex><span>-1   -2 -3 -4
</span></span><span style=display:flex><span>分别以数字代替上述位置
</span></span><span style=display:flex><span>-1：硬件设备所在目录
</span></span><span style=display:flex><span>-2：设备，sd表示SCSI设备，hd表示IDE设备
</span></span><span style=display:flex><span>-3：磁盘的顺序号以字母a、b、c...表示
</span></span><span style=display:flex><span>-4：分区的顺序号，以1、2、3...表示
</span></span></code></pre></td></tr></table></div></div></div><p>举例：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>/dev/sda  # 表示第一个SCSI硬盘
</span></span><span style=display:flex><span>/dev/sda1 # 表示第一个SCSI硬盘的第一个主分区
</span></span><span style=display:flex><span>/dev/sdb3 # 表示第二个SCSI硬盘的第3个主分区
</span></span><span style=display:flex><span>/dev/hdb  # 表示第二个IDE硬盘的第2个主分区
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=文件系统结构>文件系统结构</h1><p>除了swap分区外，其他主分区、扩展分区、逻辑分区都是在根分区（/）目录上操作的。Linux文件系统是一个树形的分层组织结构，根作为整个文件系统的唯一起点，其他所有目录都从该点出发。根分区下的一级目录有：</p><ul><li>bin</li><li>boot</li><li>dev</li><li>etc</li><li>home</li><li>lib</li><li>mnt</li><li>opt</li><li>proc</li><li>root</li><li>sbin</li><li>srv</li><li>sys</li><li>tmp</li><li>usr</li><li>var</li></ul><h1 id=操作命令>操作命令</h1><h2 id=fdisk>fdisk</h2><p>磁盘分区表操作工具。命令格式：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>fdisk <span style=color:#000>[</span>-l<span style=color:#000>]</span>
</span></span></code></pre></td></tr></table></div></div></div><p>常用选项：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-l: 输出后面接的装置所有的分区内容。
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=file>file</h2><p>file命令用于辨识文件类型。命令的格式为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>file <span style=color:#000>[</span>-b -c -L -v -z<span style=color:#000>][</span>-f &lt;名称文件&gt;<span style=color:#000>][</span>-m &lt;魔法数字文件&gt;...<span style=color:#000>][</span>文件或目录...<span style=color:#000>]</span>
</span></span></code></pre></td></tr></table></div></div></div><p>常用选项：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-b: 列出辨识结果时不显示文件名称
</span></span><span style=display:flex><span>-c: 详细列出指令执行过程
</span></span><span style=display:flex><span>-f &lt;名称文件&gt;: 执行名称文件
</span></span><span style=display:flex><span>-L: 直接显示符号链接所指向的文件的类别
</span></span><span style=display:flex><span>-m &lt;魔法数字文件&gt;: 执行魔法数字文件
</span></span><span style=display:flex><span>-v: 显示版本信息
</span></span><span style=display:flex><span>-z: 尝试解读压缩文件内容
</span></span><span style=display:flex><span><span style=color:#000>[</span>文件或目录...<span style=color:#000>]</span>: 要确定类型的文件列表，多个文件之间以空格隔开，也可以使用shell通配符匹配
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=ln>ln</h2><p>link files的缩写，是为某一个文件在另外一个位置建立一个同步的链接。</p><p>命令格式：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ln <span style=color:#000>[</span>参数<span style=color:#000>][</span>源文件或目录<span style=color:#000>][</span>目标文件或目录<span style=color:#000>]</span>
</span></span></code></pre></td></tr></table></div></div></div><p>常用选项：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-b: 删除、覆盖之前建立的链接
</span></span><span style=display:flex><span>-d: 允许超级用户制作目录的硬链接
</span></span><span style=display:flex><span>-f: 强制执行
</span></span><span style=display:flex><span>-i: 交互模式，文件存在则提示是否覆盖
</span></span><span style=display:flex><span>-n: 把符号连接视为一般目录
</span></span><span style=display:flex><span>-s: 软链接<span style=color:#000>(</span>符号链接<span style=color:#000>)</span>
</span></span><span style=display:flex><span>-v: 显示详细处理过程
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=mount>mount</h2><h3 id=挂载本地设备>挂载本地设备</h3><p>对分区/dev/sda3的操作命令：</p><p>1、挂载：mount /dev/sda1 /mnt/asd，这样挂载分区到文件系统上，才能看/mnt/asd里的东西。</p><p>2、查看：ls -hl /mnt/asd</p><p>3、卸载：umount /dev/sda1</p><p>文件系统：指定要卸载的文件系统或者其对应的设备文件名</p><p>(1)、通过设备名卸载：umount -v /dev/sda1</p><p>(2)、通过挂载点卸载：umount -v /mnt/mymount/</p><h3 id=挂载网络设备>挂载网络设备</h3><p>挂载 NFS 服务作为网络磁盘：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>sudo mount -t nfs &lt;NFS_server_IP&gt;:&lt;NFS_share_path&gt; &lt;mount_point&gt;
</span></span><span style=display:flex><span># sudo mount -t nfs 192.168.1.100:/nfs/share /mnt/nfs
</span></span></code></pre></td></tr></table></div></div></div><p>挂载后，可以在 <code>/mnt/nfs</code> 目录下查看 NFS 服务器上的文件。
要在系统启动时自动挂载 NFS，可以将以上命令添加到 <code>/etc/fstab</code> 文件中，例如：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>192.168.1.100:/nfs/share /mnt/nfs nfs defaults 0 0
</span></span></code></pre></td></tr></table></div></div></div><p>注意：在生产环境中，使用前需要调整访问安全性的设置，并确保挂载的代码的正确性。</p><h2 id=设备查看>设备查看</h2><table><thead><tr><th style=text-align:left>命令</th><th style=text-align:left>作用</th></tr></thead><tbody><tr><td style=text-align:left>fdisk -l</td><td style=text-align:left>查看磁盘分区情况</td></tr><tr><td style=text-align:left>lsblk</td><td style=text-align:left>设备使用情况</td></tr><tr><td style=text-align:left>blkid</td><td style=text-align:left>设备管理方式及设备ID</td></tr><tr><td style=text-align:left>df</td><td style=text-align:left>查看正在被系统挂载的设备</td></tr><tr><td style=text-align:left>cat /proc/partitions</td><td style=text-align:left>查看系统识别设备</td></tr></tbody></table><h1 id=reference>Reference</h1><p><a href=https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/device_naming.html>https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/device_naming.html</a></p><p><a href="https://blog.csdn.net/qq_43114229/article/details/120826140?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-120826140-blog-104561836.235%5Ev27%5Epc_relevant_3mothn_strategy_recovery&spm=1001.2101.3001.4242.2&utm_relevant_index=4">Linux存储设备管理</a></p><p><a href=https://blog.51cto.com/u_15467009/5575719>https://blog.51cto.com/u_15467009/5575719</a></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>