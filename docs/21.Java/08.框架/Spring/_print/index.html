<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/21.Java/08.%E6%A1%86%E6%9E%B6/Spring/><link rel=alternate type=application/rss+xml href=/docs/21.Java/08.%E6%A1%86%E6%9E%B6/Spring/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Spring | Herbdocs</title><meta name=description content="Introduction
Spring
"><meta property="og:title" content="Spring"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/21.Java/08.%E6%A1%86%E6%9E%B6/Spring/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="Spring"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/21.Java/08.%E6%A1%86%E6%9E%B6/Spring/>返回本页常规视图</a>.</p></div><h1 class=title>Spring</h1><ul><li>1: <a href=#pg-e5fa3a3c794bd62216b4bb2f437fb517>01.Spring基础知识</a></li><li>2: <a href=#pg-7144fc0a751d80de5708f7a7be741877>04.Spring定时任务</a></li><li>3: <a href=#pg-ba9770f805e030fca82b4c98203b9f64>12.Spring扩展</a></li><li>4: <a href=#pg-c161083b081805174f26cd6dd282eed1>50.Spring循环依赖</a></li><li>5: <a href=#pg-5522b0b12cce9daca154b5f96ba9bf59>51.SpringBean的加载源码</a></li><li>6: <a href=#pg-ec8796cf812c27585ba4cf97965e03ce>spring注解驱动+源码</a></li><li>7: <a href=#pg-6802cca9b8eff6f9b6a428f138062353>SpringBoot-01基础使用及原理</a></li><li>8: <a href=#pg-5f11e8e5c91cb55111c867fbba4c2de2>SpringBoot-02Web开发及请求响应处理</a></li><li>9: <a href=#pg-cc2dcb103f46678448ff073b15e743a7>SpringBoot-03Web组件</a></li><li>10: <a href=#pg-01f8ec66bc258c55f0bf36c2725581d4>SpringBoot-04数据访问</a></li><li>11: <a href=#pg-f753dfeb3bc6d6d6be7bce5bfe135395>SpringBoot-05单元测试</a></li><li>12: <a href=#pg-9a1dd6c86b4f3b0f8ce15d918c6efdf9>SpringBoot-06指标监控</a></li><li>13: <a href=#pg-ed23f0e04d04d0059598fbb2296af7cf>SpringBoot-07配置与加载过程</a></li></ul><div class=content><h1 id=introduction>Introduction</h1><p>Spring</p></div></div><div class=td-content><h1 id=pg-e5fa3a3c794bd62216b4bb2f437fb517>1 - 01.Spring基础知识</h1><h1 id=基础>基础</h1><h3 id=什么是-spring-boot-starters>什么是 Spring Boot Starters</h3><p>解决引用依赖配置繁琐的问题。</p><p>Spring Boot坚信“约定大于配置”理念。</p><p>使用ConfigurationProperties和AutoConfiguration配置。starter的ConfigurationProperties还使得所有的配置属性被聚集到一个文件中（一般在resources目录下的application.properties）</p><p><img src=../imgs/spring_basic_1.png alt=spring_basic_1.png></p><h3 id=spring-boot-支持哪些内嵌-servlet-容器>Spring Boot 支持哪些内嵌 Servlet 容器</h3><ul><li>tomcat</li><li>jetty</li><li>undertow</li></ul><h3 id=如何在spring容器中使用jetty而不是tomcat>如何在spring容器中使用Jetty而不是Tomcat</h3><p>在pom.xml中排除tomcat引入jetty即可</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#000>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#177500>&lt;!-- 使用Jetty，需要在spring-boot-starter-web排除spring-boot-starter-tomcat，因为SpringBoot默认使用tomcat --&gt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;exclusions&gt;</span>  
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;exclusion&gt;</span>  
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span style=color:#000>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/exclusion&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/exclusions&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>&lt;!-- Jetty适合长连接应用，就是聊天类的长连接 --&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-jetty<span style=color:#000>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span> 
</span></span></code></pre></td></tr></table></div></div></div><h3 id=介绍一下-springbootapplication注解>介绍一下@SpringBootApplication注解</h3><p>见注解专题</p><h3 id=springboot的自动装配是如何实现的>SpringBoot的自动装配是如何实现的</h3><p>见自动装配专题</p><h3 id=开发restful-web常用的注解有哪些>开发RESTful web常用的注解有哪些</h3><ul><li>@GetMapping</li><li>@PostMapping</li><li>@RequestMapping</li><li>@ResponseBody</li></ul><h3 id=springboot常用的两种配置文件>springboot常用的两种配置文件</h3><ul><li>properties</li><li>yaml</li></ul><h3 id=常见的bean映射工具>常见的Bean映射工具</h3><ul><li>BeanUtils</li><li>BeanCopier</li><li>Dozer</li><li>Orika</li></ul><p>Ref：<a href=https://www.cnblogs.com/songhaibin/p/13382799.html>https://www.cnblogs.com/songhaibin/p/13382799.html</a></p><h3 id=springboot如何监控系统运行状况>springboot如何监控系统运行状况</h3><p>Spring boot Actuator提供了一组基于HTTP和JMX内置的EndPoints用于在系统运行时监控系统的运行情况。详情可以参见<a href=https://docs.spring.io/spring-boot/docs/2.1.7.RELEASE/reference/html/production-ready-endpoints.html>Spring boot官网</a>在此列举一些常用的内置EndPoints</p><h3 id=springboot如何做请求参数校验>springboot如何做请求参数校验</h3><p>Bean Validation</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-validation<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>springboot的验证框架提供了一系列的注解用于验证参数，完整的注解可以去<code>javax.validation.constraints</code>这个包下看。这里整理一下：</p><table><thead><tr><th style=text-align:left>注解</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>@AssertFalse</td><td style=text-align:left>被注释的元素必须为 false</td></tr><tr><td style=text-align:left>@AssertTrue</td><td style=text-align:left>被注释的元素必须为 true</td></tr><tr><td style=text-align:left>@DecimalMax(value)</td><td style=text-align:left>被注释的元素必须是一个数字，其值必须小于等于指定的最大值</td></tr></tbody></table><p>Ref: <a href=https://blog.csdn.net/u013934408/article/details/108872775>如何使用springboot优雅地校验请求参数</a></p><h3 id=如何使用springboot实现全局异常处理>如何使用springboot实现全局异常处理</h3><p>SpringBoot中有一个<code>ControllerAdvice</code>的注解，使用该注解表示开启了全局异常的捕获，我们只需在自定义一个方法使用<code>ExceptionHandler</code>注解然后定义捕获异常的类型即可对这些捕获的异常进行统一的处理。</p><p>Ref: <a href=https://www.cnblogs.com/xuwujing/p/10933082.html>SpringBoot全局异常准备</a></p><h3 id=springboot中如何实现定时任务>springboot中如何实现定时任务</h3><ul><li>自带的定时任务处理器 @Scheduled 注解</li><li>第三方框架 Quartz 
Ref: <a href=https://www.cnblogs.com/lenve/p/10728897.html>Spring Boot 中实现定时任务的两种方式</a></li></ul><h3 id=classxmlaplicationcontext和filesystemxmlapplicationcontext的区别>ClassXmlAplicationContext和FileSystemXmlApplicationContext的区别</h3><p>Ref：https://www.cnblogs.com/sxdcgaq8080/p/5650404.html</p><h3 id=classpath与filepath>classpath与filepath</h3><p>Ref：
<a href="https://blog.csdn.net/shangmingtao/article/details/78311189?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control">https://blog.csdn.net/shangmingtao/article/details/78311189?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control</a></p><h1 id=spring容器>Spring容器</h1><h3 id=applicationcontext通常的实现是什么>ApplicationContext通常的实现是什么</h3><ul><li>FileSystemXmlApplicationContext</li><li>ClassPathXmlApplicationContext</li><li>WebXmlApplicationContext</li></ul><h3 id=beanfactory-和-applicationcontext有什么区别>BeanFactory 和 ApplicationContext有什么区别</h3><p>1、依赖关系</p><p>ApplicationContext接口作为BeanFactory的派生，除了提供BeanFactory所具有的功能外，还提供了更完整的框架功能：</p><ul><li>继承MessageSource，因此支持国际化。</li><li>统一的资源文件访问方式。</li><li>提供在监听器中注册bean的事件。</li><li>同时加载多个配置文件。</li><li>载入多个（有继承关系）上下文 ，使得每一个上下文都专注于一个特定的层次，比如应用的web层。</li></ul><p>2、加载方式</p><p>BeanFactory采用延迟加载的方式，只有在使用到某个Bean时(调用getBean())，才对该Bean进行加载实例化。这样，我们就不能发现一些存在的Spring的配置问题。如果Bean的某一个属性没有注入，BeanFacotry加载后，直至第一次使用调用getBean方法才会抛出异常。</p><p>ApplicationContext，它是在容器启动时，一次性创建了所有的Bean。这样，在容器启动时，我们就可以发现Spring中存在的配置错误，这样有利于检查所依赖属性是否注入。</p><p>3、创建方式</p><p>BeanFactory通常以编程的方式被创建，ApplicationContext还能以声明的方式创建，如使用ContextLoader。</p><p>4、注册方式</p><p>BeanFactory和ApplicationContext都支持BeanPostProcessor、BeanFactoryPostProcessor的使用，但两者之间的区别是：BeanFactory需要手动注册，而ApplicationContext则是自动注册。</p><h3 id=spring自动注册与自动装配>Spring自动注册与自动装配</h3><p><strong>1）context: annotation-config/></strong></p><p>这个标签会自动向Spring容器注册以下四个BeanPostProcessor， 让系统识别对应的注解从而支持相关的自动装配：</p><table><thead><tr><th style=text-align:left>BeanPostProcessor</th><th style=text-align:left>对应的注解</th></tr></thead><tbody><tr><td style=text-align:left>AutowiredAnnotationBeanPostProcessor </td><td style=text-align:left>@Autowired</td></tr><tr><td style=text-align:left>CommonAnnotationBeanPostProcessor </td><td style=text-align:left>@Resource<br>@PostConstruct<br>@PreDestroy</td></tr><tr><td style=text-align:left>PersistenceAnnotationBeanPostProcessor　</td><td style=text-align:left>@PersistenceUnit<br>@PersistenceContext</td></tr><tr><td style=text-align:left>RequiredAnnotationBeanPostProcessor</td><td style=text-align:left>@Required</td></tr></tbody></table><p>传统的注册方式：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>1 &lt;bean class=&#34;org.springframework.beans.factory.annotation. AutowiredAnnotationBeanPostProcessor&#34;/&gt;
</span></span><span style=display:flex><span>2 &lt;bean class=&#34;org.springframework.context.annotation.CommonAnnotationBeanPostProcessor&#34;/&gt;
</span></span><span style=display:flex><span>3 &lt;bean class=&#34;org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor&#34;/&gt;
</span></span><span style=display:flex><span>4 &lt;bean class=&#34;org.springframework.beans.factory.annotation.RequiredAnnotationBeanPostProcessor&#34;/&gt;
</span></span></code></pre></td></tr></table></div></div></div><p> 这个标签只支持自动装配，不支持自动注册（因为不能识别@Component, @Controller, @Service, @Repository；要想识别这四个注解，需要配置&lt;context: component-scan base-package="xxx.xxx"/>标签， 见2。）。
<strong>2）&lt;context: component-scan base-package="xxx.xxx"/></strong></p><p>这个标签包含了&lt;context: annotation-config/>的功能；既支持自动装配，又支持自动注册。</p><p>支持@Component, @Controller, @Service, @Repository, @RestController, @ControllerAdvice, @Configuration注解。</p><p>作用：扫描base-package并在application context中注册扫描到的使用了以上注解的beans。</p><p>注意：Spring容器默认关闭注解装配。可以使用1或2开启注解装配。</p><p><strong>3）mvc: annotation-driven</strong></p><p>这个标签会自动注册以下bean：</p><ul><li>DefaulAnnotationHandlerMapping</li><li>AnnotationMethodHandlerAdapter</li></ul><p>这是Spring MVC为@Controller, @RequestMapping分发请求所必需的。</p><p>Ref: <a href=https://www.cnblogs.com/huangzejun/p/8183730.html>Spring自动注册及自动装配</a></p><h3 id=自动装配的局限性>自动装配的局限性</h3><p><strong>重写</strong>：你仍需用 和 配置来定义依赖，意味着总要重写自动装配。</p><p><strong>基本数据类型</strong>：你不能自动装配简单的属性，如基本数据类型，String字符串，和类。</p><p><strong>模糊特性</strong>：自动装配不如显式装配精确，如果有可能，建议使用显式装配。</p><h1 id=heading></h1><h1 id=spring-beans>Spring Beans</h1><h3 id=spring支持的几种bean的作用域>Spring支持的几种bean的作用域</h3><p>Spring框架支持以下五种bean的作用域：</p><ul><li><p>singleton
bean在每个Spring ioc 容器中只有一个实例。</p></li><li><p>prototype
一个bean的定义可以有多个实例。</p></li><li><p>request
每次http请求都会创建一个bean，该作用域仅在基于web的Spring ApplicationContext情形下有效。</p></li><li><p>session
在一个HTTP Session中，一个bean定义对应一个实例。该作用域仅在基于web的Spring ApplicationContext情形下有效。</p></li><li><p>global-session
在一个全局的HTTP Session中，一个bean定义对应一个实例。该作用域仅在基于web的Spring ApplicationContext情形下有效。</p></li></ul><h3 id=spring框架中的单例bean是线程安全的吗>Spring框架中的单例bean是线程安全的吗</h3><p>不是，实际上大部分时候 spring bean 无状态的（比如 dao 类）。</p><h3 id=bean的生命周期>Bean的生命周期</h3><ul><li>创建对象</li><li>BeanDefinition</li><li>填充属性</li><li>回调aware方法</li><li>初始化（InitializingBean接口）</li><li>aop
单例池（Map）</li></ul><p><strong>Spring</strong>中的 <strong>bean</strong>生命周期**?**</p><p>生命周期图</p><p><img src=../imgs/spring_basic_2.png alt=spring_basic_2.png></p><p>周期流程图</p><p><img src=../imgs/spring_basic_3.png alt=spring_basic_3.png></p><p>Bean的声明周期流程</p><ul><li><p>Bean 容器找到配置文件中 Spring Bean 的定义。</p></li><li><p>Bean 容器利用 Java Reflection API 创建一个Bean的实例。</p></li><li><p>如果涉及到一些属性值 利用 set() 方法设置一些属性值。</p></li><li><p>如果 Bean 实现了 BeanNameAware 接口，调用 setBeanName() 方法，传入Bean的名字。 如果 Bean 实现了 BeanClassLoaderAware 接口，调用 setBeanClassLoader() 方法，传入ClassLoader 对象的实例。</p></li><li><p>与上面的类似，如果实现了其他 *.Aware 接口，就调用相应的方法。 如果有和加载这个 Bean 的 Spring 容器相关的 BeanPostProcessor 对象，执 行 postProcessBeforeInitialization() 方法</p></li><li><p>如果Bean实现了 InitializingBean 接口，执行 afterPropertiesSet() 方法。</p></li><li><p>如果 Bean 在配置文件中的定义包含 init-method 属性，执行指定的方法。</p></li><li><p>如果有和加载这个 Bean的 Spring 容器相关的 BeanPostProcessor 对象，执
行 postProcessAfterInitialization() 方法</p></li><li><p>当要销毁 Bean 的时候，如果 Bean 实现了 DisposableBean 接口，执行 destroy() 方法。 当要销毁 Bean 的时候，如果 Bean 在配置文件中的定义包含 destroy-method 属性，执行指 定的方法。 <br>Ref: <a href=https://www.cnblogs.com/zrtqsk/p/3735273.html>Spring Bean的声明周期（Demo）</a></p></li></ul><h3 id=spring的策略设计模式>spring的策略设计模式</h3><p>spring在初始化bean的过程中，需要大量调用BeanPostProcessor后置处理器，所有的后置处理器都有各自的实现方法</p><h3 id=spring循环依赖>spring循环依赖</h3><p>三级缓存，1、2、半成品的工厂（代理，用于定制bean）Map；3、三级缓存用于直接拿去成品的bean，不用重复之前复杂的过程</p><h3 id=单例池-singleobjects>单例池（singleObjects）</h3><p>单例对象只会实例化一次所以需要一个单例池来缓存</p><h3 id=单例构造函数依赖和原型构造函数依赖>单例构造函数依赖和原型构造函数依赖</h3><p>Ref: <a href=https://mp.weixin.qq.com/s/PmLWtSBr8PlmbZ0rOJ1ncw>https://mp.weixin.qq.com/s/PmLWtSBr8PlmbZ0rOJ1ncw</a></p><h3 id=factorybean和objectfactory>FactoryBean和ObjectFactory</h3><p>FactoryBean和ObjectFactory都是用来取得Bean，但使用的方法和地方不同，FactoryBean被配置好后，Spring调用getObject()方法来取得Bean，ObjectFactory配置好后，在Bean里面可以取得ObjectFactory实例，需要我们手动来调用getObject()来取得Bean。</p><p>Ref: <a href=https://mp.weixin.qq.com/s/BAS2T0XjWD0WN4EdBrg0fg>BeanFactory和Factory Bean的区别</a></p><h3 id=heading-1></h3><h3 id=spring如何实现单例>Spring如何实现单例</h3><p>单例注册表+锁</p><p><a href=https://www.cnblogs.com/twoheads/p/9723543.html>https://www.cnblogs.com/twoheads/p/9723543.html</a></p><h3 id=initializingbean接口>InitializingBean接口</h3><p>参考：<a href=https://blog.csdn.net/weixin_30808575/article/details/96162918>https://blog.csdn.net/weixin_30808575/article/details/96162918</a></p><p>其方法afterPropertiesSet是在init-method方法之前执行。</p><p>而BeanPostProcessor接口的postProcessBeforeInitialization方法在afterPropertiesSet方法之前执行</p><blockquote><p>BeanPostProcessor，针对所有Spring上下文中所有的bean，可以在配置文档applicationContext.xml中配置一个BeanPostProcessor，然后对所有的bean进行一个初始化之前和之后的代理。
BeanPostProcessor接口中有两个方法： postProcessBeforeInitialization和postProcessAfterInitialization。 postProcessBeforeInitialization方法在bean初始化之前执行， postProcessAfterInitialization方法在bean初始化之后执行。</p></blockquote><h3 id=postconstruct>@PostConstruct</h3><p>通过 debug 和调用栈找到类InitDestroyAnnotationBeanPostProcessor, 其中的核心方法，即 @PostConstruct 方法调用的入口：</p><p>从命名上，我们就可以得到某些信息——这是一个BeanPostProcessor。想到了什么？在<a href=http://sexycoding.iteye.com/blog/1046775>也谈Spring容器的生命周期</a>中，提到过BeanPostProcessor的postProcessBeforeInitialization是在Bean生命周期中afterPropertiesSet和init-method之前被调用的。另外通过跟踪，<code>@PostConstruct</code>方法的调用方式也是通过发射机制。</p><ol><li>spring bean的初始化执行顺序：构造方法 --> <code>@PostConstruct</code>注解的方法 --> <code>afterPropertiesSet</code>方法 --> <code>init-method</code>指定的方法。具体可以参考例子</li><li><code>afterPropertiesSet</code>通过接口实现方式调用（效率上高一点），<code>@PostConstruct</code>和<code>init-method</code>都是通过反射机制调用
<strong>构造方法 -> @Autowired -> @PostConstruct</strong></li></ol><h2 id=heading-2></h2><p><a href=https://www.cnblogs.com/pipicai96/p/11718761.html>https://www.cnblogs.com/pipicai96/p/11718761.html</a></p><p><img src=../imgs/spring_basic_4.png alt=spring_basic_4.png></p><h3 id=beanpostprocessor和beanfactorypostprocessor>BeanPostProcessor和BeanFactoryPostProcessor</h3><p>参考书P155</p><p>BeanFacotoryProcessor的处理要区分两种情况：</p><ul><li>通过硬编码方式的处理</li><li>通过配置文件方式的处理
不但要实现注册功能，还要实现对后处理器的激活操作，所以需要载入配置中的定义，并进行激活</li></ul><p>对于BeanPostProcessor并不需要马上调用，且硬编码的方式实现的功能是将后处理器提取并调用，这里不需要调用，当然不需要考虑硬编码的方式了，这里的功能只需要将配置文件的BeanPostProcessor提取出来并注册进入beanFacotry就可以了。</p><h3 id=applicationlistener>ApplicationListener</h3><p>参考：<a href=https://blog.csdn.net/wo541075754/article/details/71720984>https://blog.csdn.net/wo541075754/article/details/71720984</a></p><p>在一些业务场景中，当容器初始化完成之后，需要处理一些操作，比如一些数据的加载、初始化缓存、特定任务的注册等等。这个时候我们就可以使用Spring提供的ApplicationListener来进行操作。</p><h3 id=代理>代理</h3><p>【Spring IOC---AOP代理对象生成的时机_gongsenlin341的博客-CSDN博客_spring 代理对象什么时候生成】<a href=https://blog.csdn.net/gongsenlin341/article/details/111240114>https://blog.csdn.net/gongsenlin341/article/details/111240114</a></p><p>【在spring中获取代理对象代理的目标对象工具类 - 养眼大魔王 - 博客园】<a href=https://www.cnblogs.com/damowang/p/4172733.html>https://www.cnblogs.com/damowang/p/4172733.html</a></p><h1 id=事务>事务</h1><h3 id=spring支持两种类型的事务管理>Spring支持两种类型的事务管理</h3><p>编程式事务管理：这意味你通过编程的方式管理事务，给你带来极大的灵活性，但是难维护。</p><p>声明式事务管理：这意味着你可以将业务代码和事务管理分离，你只需用注解和XML配置来管理事务。</p><h3 id=spring事务不生效原因>spring事务不生效原因</h3><p><a href=https://zhuanlan.zhihu.com/p/101396825>https://zhuanlan.zhihu.com/p/101396825</a></p><p><a href=https://mp.weixin.qq.com/s/SW7vEoEZcvwzBERWDV7HUQ>https://mp.weixin.qq.com/s/SW7vEoEZcvwzBERWDV7HUQ</a></p><ul><li>调用自身方法</li><li>方法不是public</li><li>发生错误异常(默认回滚的是RuntimeException，如果是其他异常想要回滚，需要在@Transactional注解上加rollbackFor属性)</li><li>数据库不支持事务毕竟spring事务用的是数据库的事</li></ul><h3 id=如何保证事务获取同一个connection>如何保证事务获取同一个Connection</h3><p>ThreadLocal中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>DataSourceUtils</span><span style=color:#000>.</span><span style=color:#836c28>getConnection</span><span style=color:#000>(</span><span style=color:#000>obtainDataSource</span><span style=color:#000>());</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=spring的事务和数据库的事务隔离是一个概念吗>spring的事务和数据库的事务隔离是一个概念吗</h3><p>概念一样，数据库有四种隔离级别。spring在此基础上抽象出一种隔离级别为default，表示以数据库默认配置为主。</p><p>but如果spring配置的隔离级别与数据库不一致，以spring配置的为主。因为JDBC有一个接口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>setTransactionIsolation</span><span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>level</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>SQLException</span><span style=color:#000>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该接口用来设置事务的隔离级别。那么在DataSourceUtils中，有一段代码是这样的<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// Apply specific isolation level, if any.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>Integer</span> <span style=color:#000>previousIsolationLevel</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>definition</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>definition</span><span style=color:#000>.</span><span style=color:#836c28>getIsolationLevel</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#000>TransactionDefinition</span><span style=color:#000>.</span><span style=color:#836c28>ISOLATION_DEFAULT</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>int</span> <span style=color:#000>currentIsolation</span> <span style=color:#000>=</span> <span style=color:#000>con</span><span style=color:#000>.</span><span style=color:#836c28>getTransactionIsolation</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>currentIsolation</span> <span style=color:#000>!=</span> <span style=color:#000>definition</span><span style=color:#000>.</span><span style=color:#836c28>getIsolationLevel</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>previousIsolationLevel</span> <span style=color:#000>=</span> <span style=color:#000>currentIsolation</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>con</span><span style=color:#000>.</span><span style=color:#836c28>setTransactionIsolation</span><span style=color:#000>(</span><span style=color:#000>definition</span><span style=color:#000>.</span><span style=color:#836c28>getIsolationLevel</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=spring的事务传播行为>Spring的事务传播行为</h3><p>① PROPAGATION_REQUIRED：如果当前没有事务，就创建一个新事务，如果当前存在事务，就加入该事务，该设置是最常用的设置。</p><p>② PROPAGATION_SUPPORTS：支持当前事务，如果当前存在事务，就加入该事务，如果当前不存在事务，就以非事务执行。</p><p>③ PROPAGATION_MANDATORY：支持当前事务，如果当前存在事务，就加入该事务，如果当前不存在事务，就抛出异常。</p><p>④ PROPAGATION_REQUIRES_NEW：创建新事务，无论当前存不存在事务，都创建新事务。</p><p>⑤ PROPAGATION_NOT_SUPPORTED：以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</p><p>⑥ PROPAGATION_NEVER：以非事务方式执行，如果当前存在事务，则抛出异常。</p><p>⑦ PROPAGATION_NESTED：如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则按REQUIRED属性执行。</p><h3 id=事务传播机制>事务传播机制</h3><p>举例：一个方法开启了事务，调用另一开启事务的方法，当传播行为不一样时，事务怎么执行？有几个事务</p><h3 id=事务多线程如何生效>事务多线程如何生效</h3><p>参考：<a href=https://blog.csdn.net/u010963948/article/details/80367020>https://blog.csdn.net/u010963948/article/details/80367020</a></p><p>总结：事务里开多线程，事务不生效（只能手动设置线程setUncaughtExceptionHandler方法异常时手动回滚）线程中开事务生效。</p><h3 id=数据库连接和java多线程的关系>数据库连接和java多线程的关系</h3><p>参考：<a href=https://blog.csdn.net/luanlouis/article/details/90760372>https://blog.csdn.net/luanlouis/article/details/90760372</a></p><p>Java中，当然一个线程可以在整个生命周期独占一个java.sql.Connection，使用该对象完成各种数据库操作，因为一个线程内的所有操作都是同步的和线性的。然而，在实际的项目中，并不会这样做，原因有两个：</p><ul><li>Java中的线程数量可能远超数据库连接数量，会出现僧多粥少的情况</li><li>Java线程在工作过程中，真正访问JDBC数据库连接所占用的时间比例很短</li></ul><p>结合上述的两个症结，为了提高JDBC数据库连接的使用效率，目前普遍的解决方案是：<strong>当线程需要做数据库操作时，才会真正请求获取JDBC数据库连接,线程使用完了之后，立即释放，被释放的JDBC数据库连接等待下次分配使用</strong></p><p>基于这个结论，会衍生两个问题需要解决：</p><p>1、Java多线程访问同一个java.sql.Connection会有什么问题？如何解决？
1）事务错乱——锁解决</p><p>2）提交其它事务未提交的事务——<em>确保每个线程在使用Connection对象时，最终要明确对Connection做</em><code>commit</code> 或者<code>rollback</code>。</p><p>2、JDBC数据库连接 如何管理和分配？
连接池</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7144fc0a751d80de5708f7a7be741877>2 - 04.Spring定时任务</h1><h1 id=概述>概述</h1><p>有时候需要一些定时任务完成一些功能</p><p>@Scheduled注解用于定时计划完成一些任务。</p><h1 id=scheduled定时任务器>Scheduled定时任务器</h1><h2 id=scheduled简介>Scheduled简介</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>scheduling</span><span style=color:#000>.</span><span style=color:#836c28>annotation</span><span style=color:#000>.</span><span style=color:#836c28>Scheduled</span>
</span></span></code></pre></td></tr></table></div></div></div><p>spring.context依赖下的包org.springframework.scheduling，该包有4个子包：
1、annotation</p><p>定义了调度、异步任务相关的注解和解析类，常用的注解如@Async、@EnableAsync、@EnableScheduling和@Scheduled。</p><p>2、concurrent</p><p>定义了调度任务执行器和相对应的FactoryBean</p><p>3、config</p><p>定义了配置解析、任务具体实现类、调度任务<code>XML</code>配置文件解析相关的解析类。4、4、support</p><p>定义了反射支持类、Cron表达式解析器等工具类。</p><h2 id=scheduled使用>Scheduled使用</h2><p>1、依赖</p><p>如果想单独使用Scheduling，只需要引入spring-context这个依赖。</p><p>springboot引入spring-boot-starter-web已经集成了spring-context，可以直接使用Scheduling模块。</p><p>2、在需要定期执行的方法上标注 @Schduled</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ScheduledDemo</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Scheduled</span><span style=color:#000>(</span><span style=color:#000>cron</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;0/5 * * ? * *&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;this is scheduled &#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>3、开启Schedule
开启Scheduling模块支持只需要在某一个配置类中添加@EnableScheduling注解即可，一般为了明确模块的引入，建议在启动类中使用此注解。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 在启动类上标注</span>
</span></span><span style=display:flex><span>@EnableScheduling
</span></span><span style=display:flex><span>@SpringBootApplication
</span></span><span style=display:flex><span>public class BootdemoApplication <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   public static void main<span style=color:#000>(</span>String<span style=color:#000>[]</span> args<span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      SpringApplication.run<span style=color:#000>(</span>BootdemoApplication.class, args<span style=color:#000>)</span>;
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意：默认是单线程执行，即同一时刻只有一个定时任务。如果一个定时任务是一直在运行，则其它定时任务将被阻塞一直无法运行。</p><h2 id=触发规则>触发规则</h2><p>1、TriggerTask：动态定时任务。通过Trigger#nextExecutionTime 给定的触发上下文确定下一个执行时间。</p><p>2、CronTask：动态定时任务，TriggerTask子类。通过cron表达式确定的时间触发下一个任务执行。</p><p>3、IntervalTask：一定时间延迟之后，周期性执行的任务。</p><h2 id=多线程使用>多线程使用</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.annotation.Bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.annotation.Configuration</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.scheduling.TaskScheduler</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.ThreadPoolExecutor</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>TaskSchedule</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>TaskScheduler</span> <span style=color:#000>scheduledExecutorService</span><span style=color:#000>()</span> <span style=color:#000>{</span> <span style=color:#177500>// taskScheduler()
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>ThreadPoolTaskScheduler</span> <span style=color:#000>scheduler</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ThreadPoolTaskScheduler</span><span style=color:#000>();</span> 
</span></span><span style=display:flex><span>        <span style=color:#000>scheduler</span><span style=color:#000>.</span><span style=color:#836c28>setPoolSize</span><span style=color:#000>(</span><span style=color:#000>5</span><span style=color:#000>);</span> <span style=color:#177500>// 注意：默认只有一个线程
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>scheduler</span><span style=color:#000>.</span><span style=color:#836c28>setThreadNamePrefix</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;scheduled-thread-&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>scheduler</span><span style=color:#000>.</span><span style=color:#836c28>setWaitForTasksToCompleteOnShutdown</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>scheduler</span><span style=color:#000>.</span><span style=color:#836c28>setRejectedExecutionHandler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#000>.</span><span style=color:#836c28>CallerRunsPolicy</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>scheduler</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=注意事项>注意事项</h3><p>1、其它注入不同名的TaskScheduler的bean</p><p>2、自动注入扫描路径</p><p>3、注入优先级</p><p>4、注解方法为public</p><h1 id=quartz定时任务框架>Quartz定时任务框架</h1><h2 id=quartz的使用思路>Quartz的使用思路</h2><p>1、job：任务</p><p>2、Trigger：触发器</p><p>3、Scheduler：任务调度</p><h2 id=quartz使用>Quartz使用</h2><p>1、依赖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#177500>&lt;!-- https://mvnrepository.com/artifact/org.quartz-scheduler/quartz --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.quartz-scheduler<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>quartz<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>2.2.0<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、创建执行任务<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.quartz.*</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>QuartzDemo</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Job</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>execute</span><span style=color:#000>(</span><span style=color:#000>JobExecutionContext</span> <span style=color:#000>jobExecutionContext</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>JobExecutionException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;QuartzDemo execute&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>3、配置触发器并启动任务<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.quartz.*</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.quartz.impl.StdSchedulerFactory</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>QuartzMain</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 1、创建Job对象
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>JobDetail</span> <span style=color:#000>jobDetail</span> <span style=color:#000>=</span> <span style=color:#000>JobBuilder</span><span style=color:#000>.</span><span style=color:#836c28>newJob</span><span style=color:#000>(</span><span style=color:#000>QuartzDemo</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>).</span><span style=color:#836c28>build</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 2、创建Trigger对象
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>Trigger</span> <span style=color:#000>trigger</span> <span style=color:#000>=</span> <span style=color:#000>TriggerBuilder</span><span style=color:#000>.</span><span style=color:#836c28>newTrigger</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span><span style=color:#177500>//                .withSchedule(SimpleScheduleBuilder.repeatSecondlyForever())
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>.</span><span style=color:#836c28>withSchedule</span><span style=color:#000>(</span><span style=color:#000>CronScheduleBuilder</span><span style=color:#000>.</span><span style=color:#836c28>cronSchedule</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;0/5 * * ? * *&#34;</span><span style=color:#000>))</span>
</span></span><span style=display:flex><span>                <span style=color:#000>.</span><span style=color:#836c28>build</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 3、创建Scheduler对象
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>Scheduler</span> <span style=color:#000>scheduler</span> <span style=color:#000>=</span> <span style=color:#000>StdSchedulerFactory</span><span style=color:#000>.</span><span style=color:#836c28>getDefaultScheduler</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>scheduler</span><span style=color:#000>.</span><span style=color:#836c28>scheduleJob</span><span style=color:#000>(</span><span style=color:#000>jobDetail</span><span style=color:#000>,</span> <span style=color:#000>trigger</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>scheduler</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=springboot整合quartz使用>Springboot整合Quartz使用</h2><p>1、依赖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;groupId&gt;</span>org.quartz-scheduler<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;artifactId&gt;</span>quartz<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;version&gt;</span>2.2.0<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;groupId&gt;</span>org.springframework<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;artifactId&gt;</span>spring-context-support<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;version&gt;</span>4.3.17.RELEASE<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;groupId&gt;</span>org.springframework<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;artifactId&gt;</span>spring-tx<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>&lt;version&gt;</span>4.3.17.RELEASE<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、创建执行任务QuartzDemo
同上</p><p>3、配置触发器Bean</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.huangbo.bootdemo.scheduled</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.annotation.Bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.annotation.Configuration</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.scheduling.quartz.CronTriggerFactoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.scheduling.quartz.JobDetailFactoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.scheduling.quartz.SchedulerFactoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.scheduling.quartz.SimpleTriggerFactoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>@Configuration</span> <span style=color:#177500>//注意别写成了Component
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>QuartzConfig</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>JobDetailFactoryBean</span> <span style=color:#000>jobDetailFactoryBean</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>JobDetailFactoryBean</span> <span style=color:#000>factoryBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>JobDetailFactoryBean</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setJobClass</span><span style=color:#000>(</span><span style=color:#000>QuartzDemo</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>factoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>SimpleTriggerFactoryBean</span> <span style=color:#000>simpleTriggerFactoryBean</span><span style=color:#000>(</span><span style=color:#000>JobDetailFactoryBean</span> <span style=color:#000>jobDetailFactoryBean</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SimpleTriggerFactoryBean</span> <span style=color:#000>factoryBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SimpleTriggerFactoryBean</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setJobDetail</span><span style=color:#000>(</span><span style=color:#000>jobDetailFactoryBean</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setRepeatInterval</span><span style=color:#000>(</span><span style=color:#000>3000</span><span style=color:#000>);</span> <span style=color:#177500>// ms
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setRepeatCount</span><span style=color:#000>(</span><span style=color:#000>10</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>factoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>CronTriggerFactoryBean</span> <span style=color:#000>cronTriggerFactoryBean</span><span style=color:#000>(</span><span style=color:#000>JobDetailFactoryBean</span> <span style=color:#000>jobDetailFactoryBean</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>CronTriggerFactoryBean</span> <span style=color:#000>factoryBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CronTriggerFactoryBean</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setJobDetail</span><span style=color:#000>(</span><span style=color:#000>jobDetailFactoryBean</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setCronExpression</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;0/5 * * ? * *&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>factoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>SchedulerFactoryBean</span> <span style=color:#000>schedulerFactoryBean</span><span style=color:#000>(</span><span style=color:#000>CronTriggerFactoryBean</span> <span style=color:#000>cronTriggerFactoryBean</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SchedulerFactoryBean</span> <span style=color:#000>factoryBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SchedulerFactoryBean</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>factoryBean</span><span style=color:#000>.</span><span style=color:#836c28>setTriggers</span><span style=color:#000>(</span><span style=color:#000>cronTriggerFactoryBean</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>factoryBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>4、启动<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@EnableScheduling</span>
</span></span><span style=display:flex><span><span style=color:#000>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>BootdemoApplication</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>SpringApplication</span><span style=color:#000>.</span><span style=color:#836c28>run</span><span style=color:#000>(</span><span style=color:#000>BootdemoApplication</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=scheduled原理>Scheduled原理</h1><h2 id=scheduling模块工作流程>Scheduling模块工作流程</h2><p><img src=../imgs/20220105_scheduled_1.png alt=20220105_scheduled_1.png></p><p>Scheduling模块的核心逻辑在ScheduledAnnotationBeanPostProcessor和ScheduledTaskRegistrar两个类中</p><h2 id=入口>入口</h2><p>EnableScheduling注解</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Target</span><span style=color:#000>(</span><span style=color:#000>ElementType</span><span style=color:#000>.</span><span style=color:#836c28>TYPE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Retention</span><span style=color:#000>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#000>.</span><span style=color:#836c28>RUNTIME</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Import</span><span style=color:#000>(</span><span style=color:#000>SchedulingConfiguration</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>@interface</span> <span style=color:#000>EnableScheduling</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>然后看导入的类 SchedulingConfiguration
这里有个技巧：Spring内部加载的Bean一般会定义名称为internalXXX，Bean的role会定义为ROLE_INFRASTRUCTURE = 2</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.annotation.SchedulingConfiguration
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#000>@Role</span><span style=color:#000>(</span><span style=color:#000>BeanDefinition</span><span style=color:#000>.</span><span style=color:#836c28>ROLE_INFRASTRUCTURE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>SchedulingConfiguration</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>@Bean</span><span style=color:#000>(</span><span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>TaskManagementConfigUtils</span><span style=color:#000>.</span><span style=color:#836c28>SCHEDULED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>@Role</span><span style=color:#000>(</span><span style=color:#000>BeanDefinition</span><span style=color:#000>.</span><span style=color:#836c28>ROLE_INFRASTRUCTURE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>public</span> <span style=color:#000>ScheduledAnnotationBeanPostProcessor</span> <span style=color:#000>scheduledAnnotationProcessor</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>ScheduledAnnotationBeanPostProcessor</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>看 ScheduledAnnotationBeanPostProcessor 构造方法，初始化了 register<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ScheduledAnnotationBeanPostProcessor</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ScheduledTaskRegistrar</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=scheduledannotationbeanpostprocessor>ScheduledAnnotationBeanPostProcessor</h2><h3 id=实现的接口>实现的接口</h3><h4 id=scheduledtaskholder>ScheduledTaskHolder</h4><p>返回Set<scheduledtask>，表示持有的所有任务实例。</p><p>MergedBeanDefinitionPostProcessor接口：Bean定义合并时回调，预留空实现，暂时不做任何处理。</p><h4 id=beanpostprocessor>BeanPostProcessor</h4><p>也就是MergedBeanDefinitionPostProcessor的父接口，Bean实例初始化前后分别回调，其中，后回调的postProcessAfterInitialization()方法就是用于<strong>解析@Scheduled和装载ScheduledTask</strong>，需要重点关注此方法的逻辑。</p><h4 id=destructionawarebeanpostprocessor>DestructionAwareBeanPostProcessor</h4><p>具体的Bean实例销毁的时候回调，用于Bean实例销毁的时候移除和取消对应的任务实例。</p><p>Ordered接口：用于Bean加载时候的排序，主要是改变ScheduledAnnotationBeanPostProcessor在BeanPostProcessor执行链中的顺序。</p><h4 id=embeddedvalueresolveraware>EmbeddedValueResolverAware</h4><p>回调StringValueResolver实例，用于解析带占位符的环境变量属性值。</p><h4 id=beannameaware>BeanNameAware</h4><p>回调BeanName。</p><h4 id=beanfactoryaware>BeanFactoryAware</h4><p>回调BeanFactory实例，具体是DefaultListableBeanFactory，也就是熟知的IOC容器。</p><h4 id=applicationcontextaware>ApplicationContextAware</h4><p>回调ApplicationContext实例，也就是熟知的Spring上下文，它是IOC容器的门面，同时是事件广播器、资源加载器的实现等等。</p><h4 id=smartinitializingsingleton>SmartInitializingSingleton</h4><p>所有单例实例化完毕之后回调，作用是在持有的applicationContext为NULL的时候开始调度所有加载完成的任务，这个钩子接口十分有用，常用做一些资源初始化工作。</p><h4 id=applicationlistener>ApplicationListener</h4><p>监听Spring应用的事件，具体是ApplicationListener<contextrefreshedevent>，监听上下文刷新的事件，如果事件中携带的ApplicationContext实例和ApplicationContextAware回调的ApplicationContext实例一致，那么在此监听回调方法中开始调度所有加载完成的任务，也就是在ScheduledAnnotationBeanPostProcessor这个类中，SmartInitializingSingleton接口的实现和ApplicationListener接口的实现逻辑是互斥的。</p><h4 id=disposablebean>DisposableBean</h4><p>当前Bean实例销毁时候回调，也就是ScheduledAnnotationBeanPostProcessor自身被销毁的时候回调，用于取消和清理所有的ScheduledTask。</p><h3 id=scheduled注解解析>@Scheduled注解解析</h3><p>在postProcessAfterInitialization方法中</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor#postProcessAfterInitialization
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 忽略AopInfrastructureBean、TaskScheduler和ScheduledExecutorService三种类型的Bean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>AopInfrastructureBean</span> <span style=color:#000>||</span> <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>TaskScheduler</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>         <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ScheduledExecutorService</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Ignore AOP infrastructure such as scoped proxies.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 获取Bean的用户态类型，例如Bean有可能被CGLIB增强，这个时候要取其父类
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#000>=</span> <span style=color:#000>AopProxyUtils</span><span style=color:#000>.</span><span style=color:#836c28>ultimateTargetClass</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// nonAnnotatedClasses存放不包含@Scheduled注解的类型，缓存起来避免重复判断它是否携带@Scheduled注解的方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>nonAnnotatedClasses</span><span style=color:#000>.</span><span style=color:#836c28>contains</span><span style=color:#000>(</span><span style=color:#000>targetClass</span><span style=color:#000>)</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>AnnotationUtils</span><span style=color:#000>.</span><span style=color:#836c28>isCandidateClass</span><span style=color:#000>(</span><span style=color:#000>targetClass</span><span style=color:#000>,</span> <span style=color:#000>Arrays</span><span style=color:#000>.</span><span style=color:#836c28>asList</span><span style=color:#000>(</span><span style=color:#000>Scheduled</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>Schedules</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// JDK8之后支持重复注解，因此获取具体类型中Method -&gt; @Scheduled的集合，也就是有可能一个方法使用多个@Scheduled注解，最终会封装为多个Task
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>Method</span><span style=color:#000>,</span> <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>Scheduled</span><span style=color:#000>&gt;&gt;</span> <span style=color:#000>annotatedMethods</span> <span style=color:#000>=</span> <span style=color:#000>MethodIntrospector</span><span style=color:#000>.</span><span style=color:#836c28>selectMethods</span><span style=color:#000>(</span><span style=color:#000>targetClass</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>(</span><span style=color:#000>MethodIntrospector</span><span style=color:#000>.</span><span style=color:#836c28>MetadataLookup</span><span style=color:#000>&lt;</span><span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>Scheduled</span><span style=color:#000>&gt;&gt;)</span> <span style=color:#000>method</span> <span style=color:#000>-&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>Scheduled</span><span style=color:#000>&gt;</span> <span style=color:#000>scheduledMethods</span> <span style=color:#000>=</span> <span style=color:#000>AnnotatedElementUtils</span><span style=color:#000>.</span><span style=color:#836c28>getMergedRepeatableAnnotations</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>method</span><span style=color:#000>,</span> <span style=color:#000>Scheduled</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>Schedules</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>return</span> <span style=color:#000>(!</span><span style=color:#000>scheduledMethods</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>()</span> <span style=color:#000>?</span> <span style=color:#000>scheduledMethods</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>});</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 解析到类型中不包含@Scheduled注解的方法添加到nonAnnotatedClasses缓存中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>annotatedMethods</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>nonAnnotatedClasses</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>targetClass</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;No @Scheduled annotations found on bean class: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>targetClass</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Method -&gt; @Scheduled的集合遍历processScheduled()方法进行登记
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Non-empty set of methods
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>annotatedMethods</span><span style=color:#000>.</span><span style=color:#836c28>forEach</span><span style=color:#000>((</span><span style=color:#000>method</span><span style=color:#000>,</span> <span style=color:#000>scheduledMethods</span><span style=color:#000>)</span> <span style=color:#000>-&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#000>scheduledMethods</span><span style=color:#000>.</span><span style=color:#836c28>forEach</span><span style=color:#000>(</span><span style=color:#000>scheduled</span> <span style=color:#000>-&gt;</span> <span style=color:#000>processScheduled</span><span style=color:#000>(</span><span style=color:#000>scheduled</span><span style=color:#000>,</span> <span style=color:#000>method</span><span style=color:#000>,</span> <span style=color:#000>bean</span><span style=color:#000>)));</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#000>annotatedMethods</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; @Scheduled methods processed on bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                  <span style=color:#c41a16>&#34;&#39;: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>annotatedMethods</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>processScheduled方法就是具体的注解解析和Task封装的方法。
该方法主要做了4件事：</p><p>1、解析@Scheduled中的initialDelay、initialDelayString属性，适用于FixedDelayTask或者FixedRateTask的延迟执行</p><p>2、优先解析@Scheduled中的cron属性，封装为CronTask，通过ScheduledTaskRegistrar进行缓存</p><p>3、解析@Scheduled中的fixedDelay、fixedDelayString属性，封装为FixedDelayTask，通过ScheduledTaskRegistrar进行缓存</p><p>4、解析@Scheduled中的fixedRate、fixedRateString属性，封装为FixedRateTask，通过ScheduledTaskRegistrar进行缓存</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor#processScheduled
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>processScheduled</span><span style=color:#000>(</span><span style=color:#000>Scheduled</span> <span style=color:#000>scheduled</span><span style=color:#000>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 通过方法宿主Bean和目标方法封装Runnable适配器ScheduledMethodRunnable实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Runnable</span> <span style=color:#000>runnable</span> <span style=color:#000>=</span> <span style=color:#000>createRunnable</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>method</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>boolean</span> <span style=color:#000>processedSchedule</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>String</span> <span style=color:#000>errorMessage</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;Exactly one of the &#39;cron&#39;, &#39;fixedDelay(String)&#39;, or &#39;fixedRate(String)&#39; attributes is required&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 缓存已经装载的任务
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>ScheduledTask</span><span style=color:#000>&gt;</span> <span style=color:#000>tasks</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#000>&lt;&gt;(</span><span style=color:#000>4</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Determine initial delay
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// 解析初始化延迟执行时间，initialDelayString支持占位符配置，如果initialDelayString配置了，会覆盖initialDelay的值
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>long</span> <span style=color:#000>initialDelay</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>initialDelay</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>String</span> <span style=color:#000>initialDelayString</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>initialDelayString</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasText</span><span style=color:#000>(</span><span style=color:#000>initialDelayString</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(</span><span style=color:#000>initialDelay</span> <span style=color:#000>&lt;</span> <span style=color:#000>0</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Specify &#39;initialDelay&#39; or &#39;initialDelayString&#39;, not both&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>initialDelayString</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span><span style=color:#000>.</span><span style=color:#836c28>resolveStringValue</span><span style=color:#000>(</span><span style=color:#000>initialDelayString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasLength</span><span style=color:#000>(</span><span style=color:#000>initialDelayString</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>initialDelay</span> <span style=color:#000>=</span> <span style=color:#000>parseDelayAsLong</span><span style=color:#000>(</span><span style=color:#000>initialDelayString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>RuntimeException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;Invalid initialDelayString value \&#34;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>initialDelayString</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;\&#34; - cannot parse into long&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Check cron expression
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// 解析时区zone的值，支持支持占位符配置，判断cron是否存在，存在则装载为CronTask
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>String</span> <span style=color:#000>cron</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>cron</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasText</span><span style=color:#000>(</span><span style=color:#000>cron</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>String</span> <span style=color:#000>zone</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>zone</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>cron</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span><span style=color:#000>.</span><span style=color:#836c28>resolveStringValue</span><span style=color:#000>(</span><span style=color:#000>cron</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>zone</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span><span style=color:#000>.</span><span style=color:#836c28>resolveStringValue</span><span style=color:#000>(</span><span style=color:#000>zone</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasLength</span><span style=color:#000>(</span><span style=color:#000>cron</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(</span><span style=color:#000>initialDelay</span> <span style=color:#000>==</span> <span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;&#39;initialDelay&#39; not supported for cron triggers&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>processedSchedule</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>Scheduled</span><span style=color:#000>.</span><span style=color:#836c28>CRON_DISABLED</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#000>cron</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>TimeZone</span> <span style=color:#000>timeZone</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasText</span><span style=color:#000>(</span><span style=color:#000>zone</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>timeZone</span> <span style=color:#000>=</span> <span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>parseTimeZoneString</span><span style=color:#000>(</span><span style=color:#000>zone</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>timeZone</span> <span style=color:#000>=</span> <span style=color:#000>TimeZone</span><span style=color:#000>.</span><span style=color:#836c28>getDefault</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#177500>// 此方法虽然表面上是调度CronTask，实际上由于ScheduledTaskRegistrar不持有TaskScheduler，只是把任务添加到它的缓存中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#177500>// 返回的任务实例添加到宿主Bean的缓存中，然后最后会放入宿主Bean -&gt; List&lt;ScheduledTask&gt;映射中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#000>tasks</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>scheduleCronTask</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>CronTask</span><span style=color:#000>(</span><span style=color:#000>runnable</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>CronTrigger</span><span style=color:#000>(</span><span style=color:#000>cron</span><span style=color:#000>,</span> <span style=color:#000>timeZone</span><span style=color:#000>))));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// At this point we don&#39;t need to differentiate between initial delay set or not anymore
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// 修正小于0的初始化延迟执行时间值为0
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>initialDelay</span> <span style=color:#000>&lt;</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>initialDelay</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Check fixed delay
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// 解析fixedDelay和fixedDelayString，如果同时配置，fixedDelayString最终解析出来的整数值会覆盖fixedDelay，封装为FixedDelayTask
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>long</span> <span style=color:#000>fixedDelay</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>fixedDelay</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>fixedDelay</span> <span style=color:#000>&gt;=</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(!</span><span style=color:#000>processedSchedule</span><span style=color:#000>,</span> <span style=color:#000>errorMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>processedSchedule</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>tasks</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>scheduleFixedDelayTask</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>FixedDelayTask</span><span style=color:#000>(</span><span style=color:#000>runnable</span><span style=color:#000>,</span> <span style=color:#000>fixedDelay</span><span style=color:#000>,</span> <span style=color:#000>initialDelay</span><span style=color:#000>)));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>String</span> <span style=color:#000>fixedDelayString</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>fixedDelayString</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasText</span><span style=color:#000>(</span><span style=color:#000>fixedDelayString</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>fixedDelayString</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span><span style=color:#000>.</span><span style=color:#836c28>resolveStringValue</span><span style=color:#000>(</span><span style=color:#000>fixedDelayString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasLength</span><span style=color:#000>(</span><span style=color:#000>fixedDelayString</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(!</span><span style=color:#000>processedSchedule</span><span style=color:#000>,</span> <span style=color:#000>errorMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>processedSchedule</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>fixedDelay</span> <span style=color:#000>=</span> <span style=color:#000>parseDelayAsLong</span><span style=color:#000>(</span><span style=color:#000>fixedDelayString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>RuntimeException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;Invalid fixedDelayString value \&#34;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>fixedDelayString</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;\&#34; - cannot parse into long&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 此方法虽然表面上是调度FixedDelayTask，实际上由于ScheduledTaskRegistrar不持有TaskScheduler，只是把任务添加到它的缓存中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 返回的任务实例添加到宿主Bean的缓存中，然后最后会放入宿主Bean -&gt; List&lt;ScheduledTask&gt;映射中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>tasks</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>scheduleFixedDelayTask</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>FixedDelayTask</span><span style=color:#000>(</span><span style=color:#000>runnable</span><span style=color:#000>,</span> <span style=color:#000>fixedDelay</span><span style=color:#000>,</span> <span style=color:#000>initialDelay</span><span style=color:#000>)));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Check fixed rate
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// 解析fixedRate和fixedRateString，如果同时配置，fixedRateString最终解析出来的整数值会覆盖fixedRate，封装为FixedRateTask
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>long</span> <span style=color:#000>fixedRate</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>fixedRate</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>fixedRate</span> <span style=color:#000>&gt;=</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(!</span><span style=color:#000>processedSchedule</span><span style=color:#000>,</span> <span style=color:#000>errorMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>processedSchedule</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>tasks</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>scheduleFixedRateTask</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>FixedRateTask</span><span style=color:#000>(</span><span style=color:#000>runnable</span><span style=color:#000>,</span> <span style=color:#000>fixedRate</span><span style=color:#000>,</span> <span style=color:#000>initialDelay</span><span style=color:#000>)));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>String</span> <span style=color:#000>fixedRateString</span> <span style=color:#000>=</span> <span style=color:#000>scheduled</span><span style=color:#000>.</span><span style=color:#836c28>fixedRateString</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasText</span><span style=color:#000>(</span><span style=color:#000>fixedRateString</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>fixedRateString</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span><span style=color:#000>.</span><span style=color:#836c28>resolveStringValue</span><span style=color:#000>(</span><span style=color:#000>fixedRateString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasLength</span><span style=color:#000>(</span><span style=color:#000>fixedRateString</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(!</span><span style=color:#000>processedSchedule</span><span style=color:#000>,</span> <span style=color:#000>errorMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>processedSchedule</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>fixedRate</span> <span style=color:#000>=</span> <span style=color:#000>parseDelayAsLong</span><span style=color:#000>(</span><span style=color:#000>fixedRateString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>RuntimeException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;Invalid fixedRateString value \&#34;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>fixedRateString</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;\&#34; - cannot parse into long&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 此方法虽然表面上是调度FixedRateTask，实际上由于ScheduledTaskRegistrar不持有TaskScheduler，只是把任务添加到它的缓存中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 返回的任务实例添加到宿主Bean的缓存中，然后最后会放入宿主Bean -&gt; List&lt;ScheduledTask&gt;映射中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>tasks</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>scheduleFixedRateTask</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>FixedRateTask</span><span style=color:#000>(</span><span style=color:#000>runnable</span><span style=color:#000>,</span> <span style=color:#000>fixedRate</span><span style=color:#000>,</span> <span style=color:#000>initialDelay</span><span style=color:#000>)));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Check whether we had any attribute set
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>isTrue</span><span style=color:#000>(</span><span style=color:#000>processedSchedule</span><span style=color:#000>,</span> <span style=color:#000>errorMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Finally register the scheduled tasks
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledTasks</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 注册所有任务实例，这个映射Key为宿主Bean实例，Value为List&lt;ScheduledTask&gt;，后面用于调度所有注册完成的任务
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>ScheduledTask</span><span style=color:#000>&gt;</span> <span style=color:#000>regTasks</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledTasks</span><span style=color:#000>.</span><span style=color:#836c28>computeIfAbsent</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>key</span> <span style=color:#000>-&gt;</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#000>&lt;&gt;(</span><span style=color:#000>4</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>regTasks</span><span style=color:#000>.</span><span style=color:#836c28>addAll</span><span style=color:#000>(</span><span style=color:#000>tasks</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;Encountered invalid @Scheduled method &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>method</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39;: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>@Scheduled修饰的某个方法如果同时配置了cron、fixedDelay|fixedDelayString和fixedRate|fixedRateString属性，意味着此方法同时封装为三种任务CronTask、FixedDelayTask和FixedRateTask。解析xxString值的使用，用到了EmbeddedValueResolver解析字符串的值，支持占位符，这样可以直接获取环境配置中的占位符属性（基于SPEL的特性，甚至可以支持嵌套占位符）。解析成功的所有任务实例存放在ScheduledAnnotationBeanPostProcessor的一个映射scheduledTasks中</p><h3 id=finishregistration>finishRegistration</h3><p>解析和缓存工作完成之后，接着分析最终激活所有调度任务的逻辑，见互斥方法afterSingletonsInstantiated()和onApplicationEvent()，两者中一定只有一个方法能够调用finishRegistration()</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">98
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>  <span style=color:#177500>//所有单例实例化完毕之后回调
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>afterSingletonsInstantiated</span><span style=color:#000>()</span> <span style=color:#000>{</span> 
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>nonAnnotatedClasses</span><span style=color:#000>.</span><span style=color:#836c28>clear</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>finishRegistration</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>@Override</span>  <span style=color:#177500>// 上下文刷新完成之后回调
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>onApplicationEvent</span><span style=color:#000>(</span><span style=color:#000>ContextRefreshedEvent</span> <span style=color:#000>event</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>event</span><span style=color:#000>.</span><span style=color:#836c28>getApplicationContext</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>finishRegistration</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>finishRegistration</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 如果持有的scheduler对象不为null则设置ScheduledTaskRegistrar中的任务调度器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduler</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>setScheduler</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduler</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 这个判断一般会成立，得到的BeanFactory就是DefaultListableBeanFactory
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ListableBeanFactory</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 获取所有的调度配置器SchedulingConfigurer实例，并且都回调configureTasks()方法，这个很重要，它是用户动态装载调取任务的扩展钩子接口
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>SchedulingConfigurer</span><span style=color:#000>&gt;</span> <span style=color:#000>beans</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>ListableBeanFactory</span><span style=color:#000>)</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span><span style=color:#000>).</span><span style=color:#836c28>getBeansOfType</span><span style=color:#000>(</span><span style=color:#000>SchedulingConfigurer</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>SchedulingConfigurer</span><span style=color:#000>&gt;</span> <span style=color:#000>configurers</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ArrayList</span><span style=color:#000>&lt;&gt;(</span><span style=color:#000>beans</span><span style=color:#000>.</span><span style=color:#836c28>values</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// SchedulingConfigurer实例列表排序
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#000>.</span><span style=color:#836c28>sort</span><span style=color:#000>(</span><span style=color:#000>configurers</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>SchedulingConfigurer</span> <span style=color:#000>configurer</span> <span style=color:#000>:</span> <span style=color:#000>configurers</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>configurer</span><span style=color:#000>.</span><span style=color:#836c28>configureTasks</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 下面这一大段逻辑都是为了从BeanFactory取出任务调度器实例，主要判断TaskScheduler或者ScheduledExecutorService类型的Bean，包括尝试通过类型或者名字获取
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 获取成功后设置到ScheduledTaskRegistrar中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>hasTasks</span><span style=color:#000>()</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>getScheduler</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>state</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;BeanFactory must be set to find scheduler by type&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Search for TaskScheduler bean...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>setTaskScheduler</span><span style=color:#000>(</span><span style=color:#000>resolveSchedulerBean</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span><span style=color:#000>,</span> <span style=color:#000>TaskScheduler</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>NoUniqueBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Could not find unique TaskScheduler bean - attempting to resolve by name: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>setTaskScheduler</span><span style=color:#000>(</span><span style=color:#000>resolveSchedulerBean</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span><span style=color:#000>,</span> <span style=color:#000>TaskScheduler</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex2</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isInfoEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;More than one TaskScheduler bean exists within the context, and &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;none is named &#39;taskScheduler&#39;. Mark one of them as primary or name it &#39;taskScheduler&#39; &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;(possibly as an alias); or implement the SchedulingConfigurer interface and call &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>getBeanNamesFound</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Could not find default TaskScheduler bean - attempting to find ScheduledExecutorService: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Search for ScheduledExecutorService bean next...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>setScheduler</span><span style=color:#000>(</span><span style=color:#000>resolveSchedulerBean</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span><span style=color:#000>,</span> <span style=color:#000>ScheduledExecutorService</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>NoUniqueBeanDefinitionException</span> <span style=color:#000>ex2</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Could not find unique ScheduledExecutorService bean - attempting to resolve by name: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>ex2</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>setScheduler</span><span style=color:#000>(</span><span style=color:#000>resolveSchedulerBean</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span><span style=color:#000>,</span> <span style=color:#000>ScheduledExecutorService</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex3</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isInfoEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;More than one ScheduledExecutorService bean exists within the context, and &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#c41a16>&#34;none is named &#39;taskScheduler&#39;. Mark one of them as primary or name it &#39;taskScheduler&#39; &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#c41a16>&#34;(possibly as an alias); or implement the SchedulingConfigurer interface and call &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#c41a16>&#34;ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>ex2</span><span style=color:#000>.</span><span style=color:#836c28>getBeanNamesFound</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex2</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Could not find default ScheduledExecutorService bean - falling back to default: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>ex2</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// Giving up -&gt; falling back to default scheduler within the registrar...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;No TaskScheduler/ScheduledExecutorService bean found for scheduled processing&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 调用ScheduledTaskRegistrar的afterPropertiesSet()方法，装载所有的调度任务
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registrar</span><span style=color:#000>.</span><span style=color:#836c28>afterPropertiesSet</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>注意：
1、SchedulingConfigurer是调度模块提供给使用的进行扩展的钩子接口，用于在激活所有调度任务之前回调ScheduledTaskRegistrar实例，只要拿到ScheduledTaskRegistrar实例，我们就可以使用它注册和装载新的Task。</p><h3 id=scheduledtaskregistrar>ScheduledTaskRegistrar</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.config.ScheduledTaskRegistrar
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>scheduleTasks</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>@SuppressWarnings</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;deprecation&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>scheduleTasks</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 注意：如果找不到任务调度器实例，那么会用单个线程调度所有任务
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>taskScheduler</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>localExecutor</span> <span style=color:#000>=</span> <span style=color:#000>Executors</span><span style=color:#000>.</span><span style=color:#836c28>newSingleThreadScheduledExecutor</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>taskScheduler</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ConcurrentTaskScheduler</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>localExecutor</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 调度所有装载完毕的自定义触发器的任务实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerTasks</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>TriggerTask</span> <span style=color:#000>task</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerTasks</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addScheduledTask</span><span style=color:#000>(</span><span style=color:#000>scheduleTriggerTask</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 调度所有装载完毕的CronTask
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>cronTasks</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>CronTask</span> <span style=color:#000>task</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>cronTasks</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addScheduledTask</span><span style=color:#000>(</span><span style=color:#000>scheduleCronTask</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 调度所有装载完毕的FixedRateTask
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>fixedRateTasks</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>IntervalTask</span> <span style=color:#000>task</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>fixedRateTasks</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addScheduledTask</span><span style=color:#000>(</span><span style=color:#000>scheduleFixedRateTask</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 调度所有装载完毕的FixedDelayTask
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>fixedDelayTasks</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>IntervalTask</span> <span style=color:#000>task</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>fixedDelayTasks</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addScheduledTask</span><span style=color:#000>(</span><span style=color:#000>scheduleFixedDelayTask</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>注意：
1、如果没有配置TaskScheduler或者ScheduledExecutorService类型的Bean，那么调度模块只会创建一个线程（默认执行器 ScheduledExecutorService）去调度所有装载完毕的任务，如果任务比较多，执行密度比较大，很有可能会造成大量任务饥饿，表现为存在部分任务不会触发调度的场景（这个是调度模块生产中经常遇到的故障，需要重点排查是否没有设置TaskScheduler或者ScheduledExecutorService，或者设置了单默认线程数据为1）。</p><h3 id=schedule>schedule</h3><p>这里使用schedule作为例子分析，其它类似方法大同小异，默认 ConcurrentTaskScheduler 类</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.concurrent.ConcurrentTaskScheduler
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ScheduledFuture</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>schedule</span><span style=color:#000>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#000>,</span> <span style=color:#000>Trigger</span> <span style=color:#000>trigger</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>enterpriseConcurrentScheduler</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>EnterpriseConcurrentTriggerScheduler</span><span style=color:#000>().</span><span style=color:#836c28>schedule</span><span style=color:#000>(</span><span style=color:#000>decorateTask</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>),</span> <span style=color:#000>trigger</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>ErrorHandler</span> <span style=color:#000>errorHandler</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>               <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>errorHandler</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>errorHandler</span> <span style=color:#000>:</span> <span style=color:#000>TaskUtils</span><span style=color:#000>.</span><span style=color:#836c28>getDefaultErrorHandler</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 创建 ReschedulingRunnable 进行调度，并返回一个 ScheduledFuture
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>ReschedulingRunnable</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>,</span> <span style=color:#000>trigger</span><span style=color:#000>,</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>clock</span><span style=color:#000>,</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutor</span><span style=color:#000>,</span> <span style=color:#000>errorHandler</span><span style=color:#000>).</span><span style=color:#836c28>schedule</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>RejectedExecutionException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>TaskRejectedException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Executor [&#34;</span> <span style=color:#000>+</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutor</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;] did not accept task: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>task</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=reschedulingrunnable>ReschedulingRunnable</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.scheduling.concurrent.ReschedulingRunnable
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>ReschedulingRunnable</span><span style=color:#000>(</span><span style=color:#000>Runnable</span> <span style=color:#000>delegate</span><span style=color:#000>,</span> <span style=color:#000>Trigger</span> <span style=color:#000>trigger</span><span style=color:#000>,</span> <span style=color:#000>Clock</span> <span style=color:#000>clock</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ScheduledExecutorService</span> <span style=color:#000>executor</span><span style=color:#000>,</span> <span style=color:#000>ErrorHandler</span> <span style=color:#000>errorHandler</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 设置调度器的任务和错误处理器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#000>delegate</span><span style=color:#000>,</span> <span style=color:#000>errorHandler</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>trigger</span> <span style=color:#000>=</span> <span style=color:#000>trigger</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContext</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SimpleTriggerContext</span><span style=color:#000>(</span><span style=color:#000>clock</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>executor</span> <span style=color:#000>=</span> <span style=color:#000>executor</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ScheduledFuture</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>schedule</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContextMonitor</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 计算下次调用时间，会用到前面保存过的调用时间进行计算
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutionTime</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>trigger</span><span style=color:#000>.</span><span style=color:#836c28>nextExecutionTime</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutionTime</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>long</span> <span style=color:#000>initialDelay</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutionTime</span><span style=color:#000>.</span><span style=color:#836c28>getTime</span><span style=color:#000>()</span> <span style=color:#000>-</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContext</span><span style=color:#000>.</span><span style=color:#836c28>getClock</span><span style=color:#000>().</span><span style=color:#836c28>millis</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>//进行调度，调用这个类本身，而不是根据需要调用方法创建出来的调度对象
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>currentFuture</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>executor</span><span style=color:#000>.</span><span style=color:#836c28>schedule</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>,</span> <span style=color:#000>initialDelay</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>MILLISECONDS</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#a90d91>this</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 当前时间
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Date</span> <span style=color:#000>actualExecutionTime</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Date</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContext</span><span style=color:#000>.</span><span style=color:#836c28>getClock</span><span style=color:#000>().</span><span style=color:#836c28>millis</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 父类run方法，会调用需要调用方法创建出来的调度对象
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>run</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Date</span> <span style=color:#000>completionTime</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Date</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContext</span><span style=color:#000>.</span><span style=color:#836c28>getClock</span><span style=color:#000>().</span><span style=color:#836c28>millis</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContextMonitor</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>state</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutionTime</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;No scheduled execution&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 更新调用时间
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>triggerContext</span><span style=color:#000>.</span><span style=color:#836c28>update</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scheduledExecutionTime</span><span style=color:#000>,</span> <span style=color:#000>actualExecutionTime</span><span style=color:#000>,</span> <span style=color:#000>completionTime</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 检查方法是否取消
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>obtainCurrentFuture</span><span style=color:#000>().</span><span style=color:#836c28>isCancelled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 类本身的调度，刷新下次调用时间
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>schedule</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=reference>Reference</h1><p><a href=https://my.oschina.net/githubhty/blog/4925237>Scheduled的多线程实现</a></p><p><a href=https://sherry-02.github.io/2021/06/16/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5>Scheduled注解的原理分析</a></p><p><a href=https://www.cnblogs.com/throwable/p/12616945.html>Scheduled的实现原理</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ba9770f805e030fca82b4c98203b9f64>3 - 12.Spring扩展</h1><h2 id=spring启动流程>Spring启动流程</h2><p>Bean作为Spring Framework的核心，其生命周期可以分为五个主干流程：</p><p>1、容器启动阶段（严格来讲这个不属于Bean的生命周期）</p><p>2、Bean（单例非懒加载）的实例化阶段</p><p>3、Bean的属性注入阶段</p><p>4、Bean的初始化阶段</p><p>5、Bean的销毁阶段</p><p>Spring容器启动流程</p><p><img src=../imgs/20220104_extension_1.png alt=20220104_extension_1.png></p><h3 id=扩展接口启动调用顺序图>扩展接口启动调用顺序图</h3><p><img src=../imgs/20220104_extension_2.png alt=20220104_extension_2.png></p><h2 id=applicationcontextinitializer>ApplicationContextInitializer</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.context.ApplicationContextInitializer
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>interface</span> <span style=color:#3f6e75>ApplicationContextInitializer</span><span style=color:#000>&lt;</span><span style=color:#000>C</span> <span style=color:#a90d91>extends</span> <span style=color:#000>ConfigurableApplicationContext</span><span style=color:#000>&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>/**
</span></span></span><span style=display:flex><span><span style=color:#177500>    * Initialize the given application context.
</span></span></span><span style=display:flex><span><span style=color:#177500>    * @param applicationContext the application to configure
</span></span></span><span style=display:flex><span><span style=color:#177500>    */</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>void</span> <span style=color:#000>initialize</span><span style=color:#000>(</span><span style=color:#000>C</span> <span style=color:#000>applicationContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=功能>功能</h3><p>spring容器在刷新之前初始化 ConfigurableApplicationContext 的回调接口，简单来说，就是在容器刷新之前调用此类的 initialize 方法。 用户可以在整个spring容器还没被初始化之前做一些事情。</p><p>使用场景：</p><p>在最开始激活一些配置，或者利用这时候class还没被类加载器加载的时机，进行动态字节码注入等操作。</p><h3 id=代码示例>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyApplicationContextInitializer</span> <span style=color:#a90d91>implements</span> <span style=color:#000>ApplicationContextInitializer</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>initialize</span><span style=color:#000>(</span><span style=color:#000>ConfigurableApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;MyApplicationContextInitializer&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>因为这时候spring容器还没被初始化，所以想要自己的扩展的生效，有以下三种方式：
1、在启动类中用加入</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>springApplication</span><span style=color:#000>.</span><span style=color:#836c28>addInitializers</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>TestApplicationContextInitializer</span><span style=color:#000>())</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、配置文件配置<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>context.initializer.classes=com.example.demo.TestApplicationContextInitializer
</span></span></code></pre></td></tr></table></div></div></div></p><p>3、Spring SPI扩展，在spring.factories中加入<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>org.springframework.context.ApplicationContextInitializer=com.example.demo.TestApplicationContextInitializer
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=beandefinitionregistrypostprocessor>BeanDefinitionRegistryPostProcessor</h2><h3 id=功能-1>功能</h3><p>该接口在读取项目中的beanDefinition之后执行，提供一个补充的扩展点</p><p>使用场景：你可以在这里动态注册自己的beanDefinition，可以加载classpath之外的bean</p><h3 id=代码示例-1>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>TestBeanDefinitionRegistryPostProcessor</span> <span style=color:#a90d91>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#000>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[BeanDefinitionRegistryPostProcessor] postProcessBeanDefinitionRegistry&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>postProcessBeanFactory</span><span style=color:#000>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[BeanDefinitionRegistryPostProcessor] postProcessBeanFactory&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=beanfactorypostprocessor>BeanFactoryPostProcessor</h2><h3 id=功能-2>功能</h3><p>该接口是beanFactory的扩展接口，调用时机在spring在读取beanDefinition信息之后，实例化bean之前。</p><p>用户可以通过实现这个扩展接口来自行处理一些东西，比如修改已经注册的beanDefinition的元信息。</p><h3 id=代码示例-2>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000>public</span> <span style=color:#000>class</span> <span style=color:#000>MyBeanFactoryPostProcessor</span> <span style=color:#000>implements</span> <span style=color:#000>BeanFactoryPostProcessor</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#000>public</span> <span style=color:#000>void</span> <span style=color:#000>postProcessBeanFactory(ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory)</span> <span style=color:#000>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System.out.println(</span><span style=color:#000>&#34;MyBeanFactoryPostProcessor&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=instantiationawarebeanpostprocessor>InstantiationAwareBeanPostProcessor</h2><h2 id=功能-3>功能</h2><p>该接口继承了BeanPostProcess接口，区别如下 ：</p><p>BeanPostProcess接口只在bean的<strong>初始化阶段</strong>进行扩展（注入spring上下文前后），而InstantiationAwareBeanPostProcessor接口在此基础上增加了3个方法，把可扩展的范围增加了<strong>实例化阶段</strong>和<strong>属性注入阶段</strong>。</p><p>该类主要的扩展点有以下5个方法，主要在bean生命周期的两大阶段：实例化阶段和初始化阶段，下面一起进行说明，按调用顺序为：</p><p>1、postProcessBeforeInstantiation：实例化bean之前，相当于new这个bean之前</p><p>2、postProcessAfterInstantiation：实例化bean之后，相当于new这个bean之后</p><p>3、postProcessPropertyValues：bean已经实例化完成，在属性注入时阶段触发@Autowired, @Resource等注解原理基于此方法实现</p><p>4、postProcessBeforeInitialization：初始化bean之前，相当于把bean注入spring上下文之前</p><p>5、postProcessAfterInitialization：初始化bean之后，相当于把bean注入spring上下文之后</p><p>使用场景：</p><p>无论是写中间件和业务，都能利用这个特性。比如对实现了某一类接口的bean在各个生命期间进行收集，或者对某个类型的bean进行统一的设值等等。</p><h3 id=代码>代码</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyInstantiationAwareBeanPostProcessor</span> <span style=color:#a90d91>implements</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyInstantiationAwareBeanPostProcessor] postProcessBeforeInitialization &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyInstantiationAwareBeanPostProcessor] postProcessAfterInitialization &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInstantiation</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyInstantiationAwareBeanPostProcessor] postProcessBeforeInstantiation &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>postProcessAfterInstantiation</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyInstantiationAwareBeanPostProcessor] postProcessAfterInstantiation &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessPropertyValues</span><span style=color:#000>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#000>,</span> <span style=color:#000>PropertyDescriptor</span><span style=color:#000>[]</span> <span style=color:#000>pds</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyInstantiationAwareBeanPostProcessor] postProcessPropertyValues &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>pvs</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=smartinstantiationawarebeanpostprocessor>SmartInstantiationAwareBeanPostProcessor</h2><h3 id=功能-4>功能</h3><p>该扩展接口有3个触发点方法</p><p>1、predictBeanType</p><p>该触发点发生在postProcessBeforeInstantiation之前(在图上并没有标明，因为一般不太需要扩展这个点)，这个方法用于预测Bean的类型，返回第一个预测成功的Class类型，如果不能预测返回null；当你调用BeanFactory.getType(name)时当通过bean的名字无法得到bean类型信息时就调用该回调方法来决定类型信息。</p><p>2、determineCandidateConstructors</p><p>该触发点发生在postProcessBeforeInstantiation之后，用于确定该bean的构造函数之用，返回的是该bean的所有构造函数列表。用户可以扩展这个点，来自定义选择相应的构造器来实例化这个bean。</p><p>3、getEarlyBeanReference</p><p>该触发点发生在postProcessAfterInstantiation之后，当有循环依赖的场景，当bean实例化好之后，为了防止有循环依赖，会提前暴露回调方法，用于bean实例化的后置处理。这个方法就是在提前暴露的回调方法中触发。</p><h3 id=代码示例-3>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MySmartInstantiationAwareBeanPostProcessor</span> <span style=color:#a90d91>implements</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>predictBeanType</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MySmartInstantiationAwareBeanPostProcessor] predictBeanType &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>beanClass</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;[]</span> <span style=color:#000>determineCandidateConstructors</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MySmartInstantiationAwareBeanPostProcessor] determineCandidateConstructors &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MySmartInstantiationAwareBeanPostProcessor] getEarlyBeanReference &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=beanfactoryaware>BeanFactoryAware</h2><h3 id=功能-5>功能</h3><p>该类只有一个触发点，发生在bean的实例化之后，注入属性之前，也就是Setter之前。这个类的扩展点方法为 setBeanFactory，可以拿到BeanFactory这个属性。</p><p>使用场景：</p><p>可以在bean实例化之后，但还未初始化之前，拿到 BeanFactory，然后可以对每个bean作特殊化的定制。也或者可以把BeanFactory拿到进行缓存，日后使用。</p><h3 id=代码示例-4>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>BeanFactoryHolder</span> <span style=color:#a90d91>implements</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>setBeanFactory</span><span style=color:#000>(</span><span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span> <span style=color:#000>=</span> <span style=color:#000>beanFactory</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[BeanFactoryHolder] &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanFactory</span><span style=color:#000>.</span><span style=color:#836c28>getBean</span><span style=color:#000>(</span><span style=color:#000>TestBeanFactoryAware</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>).</span><span style=color:#836c28>getClass</span><span style=color:#000>().</span><span style=color:#836c28>getSimpleName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=applicationcontextawareprocessor>ApplicationContextAwareProcessor</h2><h3 id=environmentaware>EnvironmentAware</h3><h4 id=功能-6>功能</h4><p>用于获取EnviromentAware的一个扩展类，这个变量非常有用， 可以获得系统内的所有参数。当然个人认为这个Aware没必要去扩展，因为spring内部都可以通过注入的方式来直接获得。</p><h3 id=embeddedvalueresolveraware>EmbeddedValueResolverAware</h3><h4 id=功能-7>功能</h4><p>用于获取StringValueResolver的一个扩展类， StringValueResolver用于获取基于String类型的properties的变量，一般我们都用@Value的方式去获取，如果实现了这个Aware接口，把StringValueResolver缓存起来，通过这个类去获取String类型的变量，效果是一样的。</p><h3 id=resourceloaderaware>ResourceLoaderAware</h3><h4 id=功能-8>功能</h4><p>用于获取ResourceLoader的一个扩展类，ResourceLoader可以用于获取classpath内所有的资源对象，可以扩展此类来拿到ResourceLoader对象。</p><h3 id=applicationeventpublisheraware>ApplicationEventPublisherAware</h3><h4 id=功能-9>功能</h4><p>用于获取ApplicationEventPublisher的一个扩展类，ApplicationEventPublisher可以用来发布事件，结合ApplicationListener来共同使用，下文在介绍ApplicationListener时会详细提到。这个对象也可以通过spring注入的方式来获得。</p><h3 id=messagesourceaware>MessageSourceAware</h3><h4 id=功能-10>功能</h4><p>用于获取MessageSource的一个扩展类，MessageSource主要用来做国际化。</p><h3 id=applicationcontextaware>ApplicationContextAware</h3><h3 id=功能-11>功能</h3><p>实现该接口可获取到 ApplicationContext，ApplicationContext应该是很多人非常熟悉的一个类了，就是spring上下文管理器，可以手动的获取任何在spring上下文注册的bean，我们经常扩展这个接口来缓存spring上下文，包装成静态方法。同时ApplicationContext也实现了BeanFactory，MessageSource，ApplicationEventPublisher等接口，也可以用来做相关接口的事情。</p><h3 id=代码示例-5>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Demo</span> <span style=color:#a90d91>implements</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>setApplicationContext</span><span style=color:#000>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span> <span style=color:#000>=</span> <span style=color:#000>applicationContext</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理>原理</h3><p>由 ApplicationContextAwareProcessor 实现，在bean对象初始化之前判断bean是否是ApplicationContextAware类型</p><p>具体方法见：postProcessBeforeInitialization</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.context.support.ApplicationContextAwareProcessor
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>#</span><span style=color:#000>postProcessBeforeInitialization</span>
</span></span><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getSecurityManager</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#000>||</span> <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>EmbeddedValueResolverAware</span> <span style=color:#000>||</span> <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ResourceLoaderAware</span> <span style=color:#000>||</span> <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ApplicationEventPublisherAware</span> <span style=color:#000>||</span> <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>MessageSourceAware</span> <span style=color:#000>||</span> <span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ApplicationContextAware</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>acc</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>.</span><span style=color:#836c28>getBeanFactory</span><span style=color:#000>().</span><span style=color:#836c28>getAccessControlContext</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>acc</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>AccessController</span><span style=color:#000>.</span><span style=color:#836c28>doPrivileged</span><span style=color:#000>(()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>invokeAwareInterfaces</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>},</span> <span style=color:#000>acc</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>invokeAwareInterfaces</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该方法会调用 invokeAwareInterfaces 方法注入属性。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>invokeAwareInterfaces</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>Aware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>EnvironmentAware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>EnvironmentAware</span><span style=color:#000>)</span><span style=color:#000>bean</span><span style=color:#000>).</span><span style=color:#836c28>setEnvironment</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>.</span><span style=color:#836c28>getEnvironment</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#000>)</span><span style=color:#000>bean</span><span style=color:#000>).</span><span style=color:#836c28>setEmbeddedValueResolver</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>embeddedValueResolver</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ResourceLoaderAware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#000>)</span><span style=color:#000>bean</span><span style=color:#000>).</span><span style=color:#836c28>setResourceLoader</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#000>)</span><span style=color:#000>bean</span><span style=color:#000>).</span><span style=color:#836c28>setApplicationEventPublisher</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>MessageSourceAware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>MessageSourceAware</span><span style=color:#000>)</span><span style=color:#000>bean</span><span style=color:#000>).</span><span style=color:#836c28>setMessageSource</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ApplicationContextAware</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>((</span><span style=color:#000>ApplicationContextAware</span><span style=color:#000>)</span><span style=color:#000>bean</span><span style=color:#000>).</span><span style=color:#836c28>setApplicationContext</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><h2 id=beannameaware>BeanNameAware</h2><h3 id=功能-12>功能</h3><p>该类也是Aware扩展的一种，触发点在bean的初始化之前，也就是postProcessBeforeInitialization之前，触发点方法只有一个：setBeanName</p><p>使用场景：</p><p>用户可以扩展这个点，在初始化bean之前拿到spring容器中注册的的beanName，自行修改这个beanName的值。</p><h3 id=代码示例-6>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyBeanNameAware</span> <span style=color:#a90d91>implements</span> <span style=color:#000>BeanNameAware</span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>NormalBeanA</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;MyBeanNameAware constructor&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>setBeanName</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyBeanNameAware] setBeanName: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=postconstruct>@PostConstruct</h2><h3 id=功能-13>功能</h3><p>作用在bean的初始化阶段，如果对一个方法使用了@PostConstruct，会先调用这个方法。触发点是在postProcessBeforeInitialization之后，InitializingBean.afterPropertiesSet之前。</p><p>使用场景：</p><p>用户可以对某一方法进行标注，来进行初始化某一个属性</p><h3 id=代码示例-7>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyPostConstruct</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>MyPostConstruct</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyPostConstruct] constructor&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>init</span><span style=color:#000>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyPostConstruct] init&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span> 
</span></span></code></pre></td></tr></table></div></div></div><h2 id=initializingbean>InitializingBean</h2><h3 id=功能-14>功能</h3><p>用来初始化bean。InitializingBean接口为bean提供了初始化方法的方式，它只包括afterPropertiesSet方法，凡是继承该接口的类，在初始化bean的时候都会执行该方法。这个扩展点的触发时机在postProcessAfterInitialization之前。</p><p>使用场景：</p><p>用户实现此接口，来进行系统启动的时候一些业务指标的初始化工作。</p><h3 id=代码示例-8>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyInitializingBean</span> <span style=color:#a90d91>implements</span> <span style=color:#000>InitializingBean</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyInitializingBean] afterPropertiesSet&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=factorybean>FactoryBean</h2><h3 id=功能-15>功能</h3><p>创建FactoryBean</p><p>一般情况下，Spring通过反射机制利用bean的class属性指定支线类去实例化bean，在某些情况下，实例化Bean过程比较复杂，如果按照传统的方式，则需要在bean中提供大量的配置信息。配置方式的灵活性是受限的，这时采用编码的方式可能会得到一个简单的方案。Spring为此提供了一个org.springframework.bean.factory.FactoryBean的工厂类接口，用户可以通过实现该接口定制实例化Bean的逻辑。FactoryBean接口对于Spring框架来说占用重要的地位，Spring自身就提供了70多个FactoryBean的实现。它们隐藏了实例化一些复杂bean的细节，给上层应用带来了便利。从Spring3.0开始，FactoryBean开始支持泛型，即接口声明改为FactoryBean<t>的形式</p><p>使用场景：</p><p>用户可以扩展这个类，来为要实例化的bean作一个代理，比如为该对象的所有的方法作一个拦截，在调用前后输出一行log，模仿ProxyFactoryBean的功能。</p><h3 id=代码示例-9>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>CarFactoryBean</span> <span style=color:#a90d91>implements</span> <span style=color:#000>FactoryBean</span><span style=color:#000>&lt;</span><span style=color:#000>Car</span><span style=color:#000>&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#000>Car</span> <span style=color:#000>getObject</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>Car</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>Car</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>reutrn</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span> <span style=color:#177500>// true表示单实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=原理-1>原理</h3><p>参考spring bean的加载过程，FactoryBean获取到的实际是getObject方法得到的对象，如果要获取真实的FactoryBean对象，需要在bean的id加个"&"前缀，如"&carFactoryBean"。</p><h2 id=smartinitializingsingleton>SmartInitializingSingleton</h2><h3 id=功能-16>功能</h3><p>这个接口中只有一个方法afterSingletonsInstantiated，其作用是是 在spring容器管理的所有单例对象（非懒加载对象）初始化完成之后调用的回调接口。其触发时机为postProcessAfterInitialization之后。</p><p>使用场景：</p><p>用户可以扩展此接口在对所有单例对象初始化完毕后，做一些后置的业务处理。</p><h3 id=代码示例-10>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MySmartInitializingSingleton</span> <span style=color:#a90d91>implements</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>afterSingletonsInstantiated</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MySmartInitializingSingleton] afterSingletonsInstantiated &#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=commandlinerunner>CommandLineRunner</h2><h3 id=功能-17>功能</h3><p>接口只有一个方法：run(String... args)，触发时机为整个项目启动完毕后，自动执行。如果有多个CommandLineRunner，可以利用@Order来进行排序。</p><p>使用场景：</p><p>用户扩展此接口，进行启动项目之后一些业务的预处理。</p><h3 id=代码示例-11>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyCommandLineRunner</span> <span style=color:#a90d91>implements</span> <span style=color:#000>CommandLineRunner</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>...</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyCommandLineRunner] run &#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=disposablebean>DisposableBean</h2><h3 id=功能-18>功能</h3><p>扩展点也只有一个方法：destroy()，其触发时机为当此对象销毁时，会自动执行这个方法。比如说运行applicationContext.registerShutdownHook时，就会触发这个方法。</p><h3 id=代码示例-12>代码示例</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyDisposableBean</span> <span style=color:#a90d91>implements</span> <span style=color:#000>DisposableBean</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>destroy</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;[MyDisposableBean] destroy&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=applicationlistener>ApplicationListener</h2><h3 id=功能-19>功能</h3><p>ApplicationListener可以监听某个事件的event，触发时机可以穿插在业务方法执行过程中，用户可以自定义某个业务事件。但是spring内部也有一些内置事件，可以穿插在启动调用中。可以利用这个特性，来自己做一些内置事件的监听器来达到和前面一些触发点大致相同的事情。</p><p>spring主要的内置事件：</p><p>1、ContextRefreshedEventApplicationContext</p><p>被初始化或刷新时，该事件被发布。这也可以在 ConfigurableApplicationContext接口中使用 refresh() 方法来发生。此处的初始化是指：所有的Bean被成功装载，后处理Bean被检测并激活，所有Singleton Bean 被预实例化，ApplicationContext容器已就绪可用。</p><p>2、ContextStartedEvent</p><p>使用 ConfigurableApplicationContext （ApplicationContext子接口）接口中的 start() 方法启动 ApplicationContext 时，该事件被发布。你可以调查你的数据库，或者你可以在接受到这个事件后重启任何停止的应用程序。</p><p>3、ContextStoppedEvent</p><p>使用 ConfigurableApplicationContext 接口中的 stop() 停止 ApplicationContext 时，发布这个事件。你可以在接受到这个事件后做必要的清理的工作</p><p>4、ContextClosedEvent</p><p>使用 ConfigurableApplicationContext接口中的 close()方法关闭 ApplicationContext 时，该事件被发布。一个已关闭的上下文到达生命周期末端；它不能被刷新或重启</p><p>5、RequestHandledEvent</p><p>这是一个 web-specific 事件，告诉所有 bean HTTP 请求已经被服务。只能应用于使用DispatcherServlet的Web应用。在使用Spring作为前端的MVC控制器时，当Spring处理用户请求结束后，系统会自动触发该事件</p><h2 id=reference>Reference</h2><p><a href=https://segmentfault.com/a/1190000023033670>Spring启动扩展点</a></p><p><a href=https://www.jianshu.com/p/397c15cbf34a>https://www.jianshu.com/p/397c15cbf34a</a></p><p><a href=https://luyu05.github.io/2019/06/26/SpringFrame-Extension-Point/>https://luyu05.github.io/2019/06/26/SpringFrame-Extension-Point/</a></p><p><a href=https://segmentfault.com/a/1190000039097608>EventListener注解的使用</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c161083b081805174f26cd6dd282eed1>4 - 50.Spring循环依赖</h1><blockquote><p>本文主要讲解Spring循环依赖的缓存及其作用</p></blockquote><h2 id=三级缓存>三级缓存</h2><h3 id=一级缓存>一级缓存</h3><p>Map&lt;String, Object> singletonObjects = new ConCurrentHashMap&lt;>(256)</p><p>用于保存BeanName和创建bean实例之间的关系**（成品对象）**</p><h3 id=三级缓存-1>三级缓存</h3><p>Map&lt;String, ObjectFactory> singletonFactories = new HashMap&lt;>(16)</p><p>用于保存BeanName和创建bean的工厂之间的关系**（lambda表达式，完成代理对象的覆盖过程）**</p><p><strong>ObjectFactory是一个函数式接口，仅有一个方法，可以传入lambda表达式，可以是匿名内部类，通过调用getObject方法来执行具体的逻辑</strong></p><h3 id=二级缓存>二级缓存</h3><p>Map&lt;String, Object> earlySingletonObjects = new ConCurrentHashMap&lt;>(16)</p><p>保存BeanName和创建bean实例之间的关系，与singletonFactories的不同之处在于，当一个单例bean被放到这里之后，那么当bean还在就可以通过getBean方法获取到，可以方便进行循环依赖的检测**（半成品对象）**</p><p>set：可以解决</p><p>构造方法：没有办法解决</p><p><strong>实例化和初始化分开处理，提前暴露对象</strong></p><p>spring每次创建对象时都是先从容器中查找，找不到再创建</p><p>finishBeanFactoryInitialization(beanFactory)</p><p>beanFacatory.preInstantialteSingleton()</p><p>getBean() -> doGetBean() -> createBean() -> doCreateBean()</p><p>每次先按照顺序从一、二、三级缓存中寻找bean，当一级或二级中找到时，便移除二三级中的缓存（一级中存在时二三级都移除，二级存在时移除三级）。</p><h2 id=问题>问题</h2><h3 id=1-三级缓存解决循坏依赖问题的关键是什么-为什么通过提前暴露对象能解决>1、三级缓存解决循坏依赖问题的关键是什么？为什么通过提前暴露对象能解决？</h3><p>实例化和初始化分开操作，在中间过中给其他对象赋值的时候，并不是一个完整对象，而是把半成品对象赋值给了其他对象</p><h3 id=2-如果只使用一级缓存能不能解决问题>2、如果只使用一级缓存能不能解决问题？</h3><p>不能。在整个处理过程中，缓存中存放的是半成品的和成品对象，如果只有一级缓存，那么成品和半成品都会放到一级缓存中，有可能在获取过程中获取到半成品对象，此时半成品对象是无法使用的，不能直接进行相关的处理，因此要把半成品和成品和成品的存放空间分割开来。</p><h3 id=3-只使用二级缓存行不行-为什么需要三级缓存>3、只使用二级缓存行不行？为什么需要三级缓存？</h3><p>如果我能保证所有的bean对象都不去调用getEarlyBeanReference方法，使用二级缓存可以吗？</p><p><img src=../imgs/spring_loop_dependence_1.png alt=spring_loop_dependence_1.png></p><p>是的，如果保证所有的bean对象都不调用此方法，就可以只使用二级缓存！</p><p>使用三级缓存的本质在于使用AOP代理问题！！</p><h3 id=4-如果某个bean对象代理对象-那么会不会创建普通的bean对象>4、如果某个bean对象代理对象，那么会不会创建普通的bean对象？</h3><p>会！</p><h3 id=5-为什么使用了三级缓存就可以解决aop代理问题>5、为什么使用了三级缓存就可以解决AOP代理问题？</h3><p>当一个对象需要被代理的时候，在整个过程中包含两个对象。一个是普通对象，一个是代理生成的对象，bean默认都是单例，那么我们在整个生命周期的处理环节中，一个beanname能对应两个对象吗？不能，既然不能，保证我们在使用的时候加一层判断，判断一下是否需要进行代理的处理。</p><h3 id=6-怎么知道什么时候使用呢>6、怎么知道什么时候使用呢？</h3><p>因为不知道什么时候会调用，所以通过一个匿名内部类的方式，在使用的时候直接对原对象进行覆盖操作，保证全局唯一！</p><h3 id=7-为什么要包一层objectfactory对象>7、为什么要包一层ObjectFactory对象？</h3><p>如果创建的bean有对应的代理（前提），那么其他对象注入时，注入的应该是对应的代理对象；但是Spring无法提前知道这个对象是否有循环依赖的情况，而正常情况下（没有循环依赖），Spring都是在创建好完成品bean之后才创建对应的代理。这时候Spring有两个选择：</p><p>1）不管有没有循坏依赖，都提前创建好代理对象，并将代理对象放入缓存，出现循环依赖时，其他对象直接就可以取到代理对象并注入。</p><p>2）不提前创建好代理对象，在出现循坏依赖被其他对象注入时，才实时生成代理对象。这样在没有循环依赖的情况下，bean就可以按着Spring设计原则的步骤来创建。</p><p>Spring选择了第二种方式，那怎么做到提前曝光对象而又不生成代理呢？</p><p>Spring就是在对象外面包一层ObjectFactory，提前曝光的是ObjectFactory对象，在被注入时才在ObjectFactory.getObject方式内实时生成代理对象，并将生成好的代理对象放入到第二级缓存中。</p><p>为了防止对象在后面的初始化时重复代理，在创建代理时，第二级缓存会记录已代理的对象。</p><p>如果Spring选择了上面第一种方式，就会有以下不同的处理逻辑：</p><p>1、在提前曝光半成品时，直接执行getEarlyBeanReference创建到代理，并放入到二级缓存中。</p><p>2、有了上一步，就不需要通过ObjectFactory来延迟执行getEarlyBeanReference，也就不需要singletonFactory这一级缓存。</p><p>至于为什么不适用第一种方式在bean构造完之后就创建代理对象，是因为这违背了Spring的设计原则。Spring结合AOP跟bean的生命周期，是在bean创建完全之后通过AnnotationAwareAspectJAutoProxyCreator这个后置处理器来完成的，在这个后置处理的postProcessAfterInitialization方法中对初始化后的bean完成AOP代理。如果出现了循环依赖，那没有办法，只有给bean先创建代理，但是没有出现循环依赖的情况下，设计之初就是让bean在生命周期的最后一步完成代理而不是在实例化后（未初始化）就立马完成代理。</p><h2 id=构造器依赖注入>构造器依赖注入</h2><p>解决方法及原理探索，参考：<a href=https://www.jianshu.com/p/a178d84d2bcb>https://www.jianshu.com/p/a178d84d2bcb</a></p><p>使用@lazy注解，代理。</p><p>构造器注入源码分析，参考：<a href=https://cloud.tencent.com/developer/article/1461797>https://cloud.tencent.com/developer/article/1461797</a></p><p><a href=https://www.jianshu.com/p/885c2389b0e4>https://www.jianshu.com/p/885c2389b0e4</a></p><h2 id=reference>Reference</h2><p><a href=https://segmentfault.com/a/1190000023647227>Spring循环依赖是否可以去掉第三层缓存</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5522b0b12cce9daca154b5f96ba9bf59>5 - 51.SpringBean的加载源码</h1><blockquote><p>本文主要讲解Spring Bean的加载</p></blockquote><p>Spring源码阅读技巧</p><p>1、<strong>Spring源码中真正干活的都是以do开头的方法</strong></p><p>2、只找有正确返回结果的代码</p><p>3、条件断点</p><p>4、发挥想象分析、猜</p><h1 id=测试代码>测试代码</h1><p>resources/applicationContext.xml</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#633820>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;beans</span> <span style=color:#836c28>xmlns=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xmlns:xsi=</span><span style=color:#c41a16>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xsi:schemaLocation=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;bean</span> <span style=color:#836c28>id=</span><span style=color:#c41a16>&#34;taxCalDTO&#34;</span> <span style=color:#836c28>class=</span><span style=color:#c41a16>&#34;com.chnherb.cg.rebate.service.dto.common.TaxCalDTO&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;currency_code&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;USD&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/beans&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>BeanTest.java</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.chnherb.cg</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.chnherb.cg.rebate.service.dto.common.TaxCalDTO</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.ApplicationContext</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.support.ClassPathXmlApplicationContext</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.context.support.FileSystemXmlApplicationContext</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>BeanTest</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ApplicationContext</span> <span style=color:#000>ac</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FileSystemXmlApplicationContext</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;classpath:applicationContext.xml&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;classpath:applicationContext.xml&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>TaxCalDTO</span> <span style=color:#000>taxCalDTO</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>TaxCalDTO</span><span style=color:#000>)</span> <span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#836c28>getBean</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;taxCalDTO&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>taxCalDTO</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=bean的加载>Bean的加载</h1><p>参考Spring源码书P79</p><h2 id=整体流程图>整体流程图</h2><p><img src=../imgs/spring_bean_load_1.png alt=spring_bean_load_1.png></p><p><img src=../imgs/spring_bean_load_2.png alt=spring_bean_load_2.png></p><p><img src=../imgs/spring_bean_load_3.png alt=spring_bean_load_3.png></p><h2 id=bean的获取>bean的获取</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>doGetBean</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>&lt;</span><span style=color:#000>T</span><span style=color:#000>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getBean</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>,</span> <span style=color:#000>Class</span><span style=color:#000>&lt;</span><span style=color:#000>T</span><span style=color:#000>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>doGetBean</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>,</span> <span style=color:#000>requiredType</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>获取bean的bean的过程：</p><h3 id=1-转换对应的beanname>1、转换对应的beanName</h3><p>传入的参数name不一定是beanName，可能是别名，也可能是FactoryBean，需要进一步转换</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#000>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>去除FactoryBean的修饰符，也就是如果name="&aa"，那么首先去除&而使name="aa"</li><li>将别名alias转成最终的beanName</li></ul><h3 id=2-尝试从缓存中加载单例>2、尝试从缓存中加载单例</h3><p>单例在同一个容器中只会创建一次，先尝试加载单例，如果加载不成功则再次尝试从singletonFactories中加载。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 尝试从缓存获取 或 singletonFactories中的ObjectFactory中获取
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#000>=</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#177500>// 存在如BeanFactory的情况并不是直接返回实例本身，而是返回指定方法返回的实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>bean</span> <span style=color:#000>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#000>(</span><span style=color:#000>sharedInstance</span><span style=color:#000>,</span> <span style=color:#000>name</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>因为在创建单例bean的时候会存在依赖注入的情况，而在创建依赖的时候为了避免循环依赖，在Spring中创建bean的原则是不等bean创建完成就会将创建bean的ObjectFactory提早曝光加入到缓存中，一旦下一个bean创建时候需要依赖上一个bean则直接使用ObjectFactory（详细见循环依赖）</p><h3 id=3-bean的实例化>3、bean的实例化</h3><p>如果从缓存中得到了bean的原始状态，则需要对bean进行实例化。</p><p>强调：缓存中只是原始的bean状态，不一定是最终想要的bean。如需要对工厂bean进行处理，那么这里得到的其实是工厂bean的初始状态，但我们真正需要的是工厂bean中定义的factory-method方法中返回的bean，而getObjectBeanInstance就是完成这个工作的</p><h3 id=4-原型模式的依赖检查>4、原型模式的依赖检查</h3><p>只有在单例的情况下才会尝试解决循坏依赖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=5-检测parentbeanfactory>5、检测parentBeanFactory</h3><p>!containsBeanDefinition检测如果当前加载的XML配置文件中不包含beanName所对应的配置，就只能到parentBeanFactory尝试下，然后递归地调用getBean方法。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// Check if bean definition exists in this factory.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#000>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Not found -&gt; check parent.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#000>=</span> <span style=color:#000>originalBeanName</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>args</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Delegation to parent with explicit args.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>return</span> <span style=color:#000>(</span><span style=color:#000>T</span><span style=color:#000>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#000>.</span><span style=color:#836c28>getBean</span><span style=color:#000>(</span><span style=color:#000>nameToLookup</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// No args -&gt; delegate to standard getBean method.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#000>.</span><span style=color:#836c28>getBean</span><span style=color:#000>(</span><span style=color:#000>nameToLookup</span><span style=color:#000>,</span> <span style=color:#000>requiredType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=6-转换definition>6、转换Definition</h3><p>将存储XML配置文件的GernericBeanDifinition转换为RootBeanDifinition。</p><p>因为从XML配置文件中读取到的Bean信息是存储在GernericBeanDifinition中的，但是所有的Bean后续处理都是针对于RootBeanDefinition的，所以需要进行转换。转换的同时如果父类bean不为空的话，则会一并合并父类的属性。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#000>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=7-寻找依赖>7、寻找依赖</h3><p>因为bean的初始化过程中很可能会用到某些属性，某些属性很可能是动态配置的，并且配置成依赖于其他的bean，那么这个时候有必要先加载依赖的bean。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#000>=</span> <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getDependsOn</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=8-针对不同的scope进行bean的创建>8、针对不同的scope进行bean的创建</h3><p>Spring默认的scope是singleton，其他如prototype、request。该步骤根据不同的配置进行不同的初始化策略。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#000>=</span> <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getScope</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>scopes</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>scopeName</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=9-类型转换>9、类型转换</h3><p>该功能是将返回的bean转换为requiredType指定的类型。如将String转换成Integer，或者其他的转换器。用户也可以自己扩展转换器。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// Check if required type matches the type of the actual bean instance.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>requiredType</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>requiredType</span><span style=color:#000>.</span><span style=color:#836c28>isAssignableFrom</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>.</span><span style=color:#836c28>getClass</span><span style=color:#000>()))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#000>().</span><span style=color:#836c28>convertIfNecessary</span><span style=color:#000>(</span><span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>requiredType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>name</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39; to required type [&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>               <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>getQualifiedName</span><span style=color:#000>(</span><span style=color:#000>requiredType</span><span style=color:#000>)</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;]&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>,</span> <span style=color:#000>requiredType</span><span style=color:#000>,</span> <span style=color:#000>bean</span><span style=color:#000>.</span><span style=color:#836c28>getClass</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=1-factorybean的使用>1、FactoryBean的使用</h2><p>FactoryBean接口对于Spring框架来说占有重要的地位，Spring自身提供了70多个FactoryBean的实现。它们隐藏了实例化一些复杂的bean的细节，给上层应用带来了便利。</p><p><strong>当配置文件中<bean>的class属性配置的实现类是FactoryBean时，通过getBean()方法返回的不是FactoryBean本身，而是FactoryBean#getObject()方法所返回的对象，相当于FactoryBean#getObject()代理了getBean()方法。</strong></p><p>举个例子，使用逗号分隔将多个属性值配置在一个参数中，这种自定义的配置方式比较灵活。详细可见P84。</p><p>如果需要获取到XXFactoryBean的实例，则需要在使用getBean(beanName)方法时在beanName前显式地加上"&"前缀，例如getBean("&car")</p><h2 id=2-缓存中获取单例bean>2、缓存中获取单例bean</h2><p>因为在创建单例bean的过程中会存在依赖注入的情况，而在创建依赖的时候为了避免循坏依赖，Spring创建bean的原则是不等bean创建完成就会将创建bean的ObjectFactory提早曝光加入到缓存中，一旦下一个bean创建时需要依赖上个bean，则直接使用ObjectFactory。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 参数true设置标识允许早期依赖
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>return</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 检查缓存中是否存在实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 如果为空，则锁定全局变量并进行处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 如果此bean正在加载则不处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>singletonObject</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>earlySingletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 某些方法需要提前初始化则会调用addSingletonFactory方法将对应的ObjectFactory初始化策略存储在singletonFactories
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>ObjectFactory</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonFactories</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>singletonFactory</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#177500>// 调用预先设定的getObject方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#000>singletonObject</span> <span style=color:#000>=</span> <span style=color:#000>singletonFactory</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>               <span style=color:#177500>// 记录在缓存中，earlySingletonObjects和singletonFactories互斥
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>earlySingletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>singletonObject</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonFactories</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#000>?</span> <span style=color:#000>singletonObject</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>简单解释存储bean的不同map
1、singletonObjects：用于保存BeanName和创建bean实例之间的关系，bean name -> bean instance</p><p>2、singletonFactories：用于保存BeanName和创建bean的工厂之间的关系，bean name -> ObjectFactory</p><p>3、earlySingletonObjects：也是保存beanName和创建bean实例之间的关系，只不过这里的bean相当于半成品，其目的是用来检测循环引用。</p><p>4、registeredSingletons：用来保存当前所有已注册的bean。</p><h2 id=3-从bean的实例中获取对象>3、从bean的实例中获取对象</h2><p>在getBean方法中，getObjectForBeanInstance是个高频使用的方法，无论是从缓存中获得bean还是根据不同的scope策略加载bean，总之我们得到bean的实例后要做的第一步就是调用该方法检测正确性，其实就是用于检测当前bean是否是FactoryBean类型的bean，如果是，则调用该bean对应FactoryBean实例中的getObject()作为返回值。</p><p>无论是从缓存中获取到的bean还是通过不同的scope策略加载的bean都只是最原始的bean状态，并不一定是我们最终想要的bean。举个例子，假如我们需要对工厂bean进行处理，那么这里得到的其实是工厂bean的初始状态，但是我们真正需要的是工厂bean中定义的factory-method方法中返回的bean，而getObjectForBeanInstance方法就是完成这个工作的。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 如果指定的name是工厂相关(以&amp;为前缀)且beanInstance又不是FactoryBean类型则验证不通过
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#000>.</span><span style=color:#836c28>isFactoryDereference</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>)</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!(</span><span style=color:#000>beanInstance</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanIsNotAFactoryException</span><span style=color:#000>(</span><span style=color:#000>transformedBeanName</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>),</span> <span style=color:#000>beanInstance</span><span style=color:#000>.</span><span style=color:#836c28>getClass</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 实例可能是正常的bean也可能是FactoryBean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 如果是FactoryBean，如果用户想要直接获取工厂实例而不是工厂对应的getObject方法对应的实例那么传入的name应该加入前缀&amp;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!(</span><span style=color:#000>beanInstance</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#000>)</span> <span style=color:#000>||</span> <span style=color:#000>BeanFactoryUtils</span><span style=color:#000>.</span><span style=color:#836c28>isFactoryDereference</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>beanInstance</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 加载FactoryBean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mbd</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 尝试从缓存中加载bean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>getCachedObjectForFactoryBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 到这里已经明确知道beanInstance一定是FactoryBean实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>FactoryBean</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>FactoryBean</span><span style=color:#000>&lt;?&gt;)</span> <span style=color:#000>beanInstance</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// containsBeanDefinition检测beanDefinitionMap中也就是在所有已经加载的类中检测是否定义beanName
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mbd</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>containsBeanDefinition</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 将存储XML配置文件中的GernericBeanDefinition转换为RootBeanDefinition，如果指定BeanName是子Bean的话同时会合并父类的相关属性
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>mbd</span> <span style=color:#000>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 是否是用户定义的而不是应用程序本身定义的
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>boolean</span> <span style=color:#000>synthetic</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>mbd</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>isSynthetic</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 真正核心的代码
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#000>factory</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>!</span><span style=color:#000>synthetic</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>object</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>上述代码大多是辅助代码以及一些功能性的判断，真正的核心代码委托给了getObjectFromFactoryBean。
上述代码主要的工作：</p><p>1）对FactoryBean正确性的验证</p><p>2）对非FactoryBean不做任何处理</p><p>3）对bean进行转换</p><p>4）将从Factory中解析bean的工作委托给getObjectFromFactoryBean</p><p>getObjectFromFactoryBean方法只做了一件事，即返回的bean如果是单例的，就必须保证全局唯一，同时，如果是单例，不必重复创建，可以使用缓存来提高性能。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#000>FactoryBean</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>factory</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>shouldPostProcess</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>factory</span><span style=color:#000>.</span><span style=color:#836c28>isSingleton</span><span style=color:#000>()</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>containsSingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>getSingletonMutex</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>factoryBeanObjectCache</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#000>factory</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// Only post-process and store if not put there already during getObject() call above
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// (e.g. because of circular reference processing triggered by custom getBean calls)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>Object</span> <span style=color:#000>alreadyThere</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>factoryBeanObjectCache</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>alreadyThere</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>alreadyThere</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>shouldPostProcess</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                     <span style=color:#177500>// 调用后置处理器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                     <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>postProcessObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#000>object</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                  <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                     <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#c41a16>&#34;Post-processing of FactoryBean&#39;s singleton object failed&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>factoryBeanObjectCache</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span> <span style=color:#000>object</span> <span style=color:#000>:</span> <span style=color:#000>NULL_OBJECT</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#000>?</span> <span style=color:#000>object</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#000>factory</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>shouldPostProcess</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 调用后置处理器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>postProcessObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#000>object</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Post-processing of FactoryBean&#39;s object failed&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>object</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><blockquote><p>注意后置处理代码在不同的spring版本中位置不一样，有的放在getObjectFromFactoryBean中，有的放在doGetObjectFromFactoryBean中</p></blockquote><p>doGetObjectFromFactoryBean方法中就是最终的方法，即factory.getObject()。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#000>Object</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>FactoryBean</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>factory</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 需要权限验证
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getSecurityManager</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span> <span style=color:#000>=</span> <span style=color:#000>getAccessControlContext</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>AccessController</span><span style=color:#000>.</span><span style=color:#836c28>doPrivileged</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                     <span style=color:#a90d91>return</span> <span style=color:#000>factory</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000>},</span> <span style=color:#000>acc</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>PrivilegedActionException</span> <span style=color:#000>pae</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#000>pae</span><span style=color:#000>.</span><span style=color:#836c28>getException</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 直接调用getObject方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>object</span> <span style=color:#000>=</span> <span style=color:#000>factory</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>FactoryBeanNotInitializedException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>toString</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;FactoryBean threw exception on object creation&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Do not accept a null value for a FactoryBean that&#39;s not fully
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// initialized yet: Many FactoryBeans just return null then.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>object</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;FactoryBean which is currently in creation returned null from getObject&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>object</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>可以看到获取到bean之后，没有立即返回，而是接下来又进行了后处理的操作postProcessObjectFromFactoryBean
后处理规则：尽可能保证所有bean初始化后都会调用注册的BeanPostProcessor的postProcessAfterInitialization方法进行处理，在实际开发过程中大可以针对此特性设计自己的业务逻辑。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>existingBean</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>existingBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>beanProcessor</span> <span style=color:#000>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>beanProcessor</span><span style=color:#000>.</span><span style=color:#836c28>postProcessAfterInitialization</span><span style=color:#000>(</span><span style=color:#000>result</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>result</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#000>result</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>result</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><blockquote><p>注意：这里找代码涉及到子类方法的覆盖</p></blockquote><h2 id=4-获取单例>4、获取单例</h2><p>如果缓存中不存在已经加载过的单例bean就需要从头开始bean的加载过程了，而spring中使用getSingleton的重载方法实现bean的加载过程。</p><p>调用入口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>sharedInstance</span> <span style=color:#000>=</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#000>createBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Explicitly remove instance from singleton cache: It might have been put there
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// eagerly by the creation process, to allow for circular reference resolution.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// Also remove any beans that received a temporary reference to the bean.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>destroySingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>throw</span> <span style=color:#000>ex</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>});</span>
</span></span></code></pre></td></tr></table></div></div></div><p>getSingleton重载方法<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>notNull</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;&#39;beanName&#39; must not be null&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 全局变量需要同步  
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 首先检查对应的bean是否已经加载过，因为singleton模式其实就是复用以创建的bean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 如果为空才可以进行singleto的bean的初始化
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonsCurrentlyInDestruction</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationNotAllowedException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#c41a16>&#34;Singleton bean creation not allowed while the singletons of this factory are in destruction &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                  <span style=color:#c41a16>&#34;(Do not request a bean from a BeanFactory in a destroy method implementation!)&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Creating shared instance of singleton bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39;&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 前处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>beforeSingletonCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>boolean</span> <span style=color:#000>newSingleton</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>boolean</span> <span style=color:#000>recordSuppressedExceptions</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>suppressedExceptions</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>suppressedExceptions</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#000>&lt;</span><span style=color:#000>Exception</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 初始化bean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>singletonObject</span> <span style=color:#000>=</span> <span style=color:#000>singletonFactory</span><span style=color:#000>.</span><span style=color:#836c28>getObject</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>newSingleton</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// Has the singleton object implicitly appeared in the meantime -&gt;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// if yes, proceed with it since the exception indicates that state.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>singletonObject</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#000>ex</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>suppressedException</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>suppressedExceptions</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>addRelatedCause</span><span style=color:#000>(</span><span style=color:#000>suppressedException</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#000>ex</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>suppressedExceptions</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 后处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>afterSingletonCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>newSingleton</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 加入缓存
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>addSingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>singletonObject</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#000>?</span> <span style=color:#000>singletonObject</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>上述代码使用了回调方法，使得程序可以在单例创建的前后做一些准备及处理操作，而真正的获取单例bean的方法其实并不是在此方法中实现的，其实现逻辑是在ObjectFactory类型的实例singletonFactory中实现的。而这些准备及处理操作包括如下内容：
1）检查缓存是否已经加载过</p><p>2）若没有加载，则记录beanName的正在加载状态</p><p>3）加载单例前记录状态</p><p>beforeSingletonCreation不是空实现，做了很重要的操作：记录加载状态，即通过singletonsCurrentlyInCreation.add(beanName)将当前正要创建的bean记录在缓存中，这样便可以对循环依赖进行检测。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>beforeSingletonCreation</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>inCreationCheckExclusions</span><span style=color:#000>.</span><span style=color:#836c28>contains</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>)</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonsCurrentlyInCreation</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>4）通过调用参数传入的ObjectFactory的个体Object方法实例化bean
5）加载单例后的处理方法调用</p><p>与步骤3）相似，当bean加载结束后需要移除缓存中对该bean的正在加载状态的记录</p><p>6）将结果记录至缓存并删除加载bean过程中所记录的各种辅助状态</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>addSingleton</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>(</span><span style=color:#000>singletonObject</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span> <span style=color:#000>singletonObject</span> <span style=color:#000>:</span> <span style=color:#000>NULL_OBJECT</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>singletonFactories</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>earlySingletonObjects</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>registeredSingletons</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>7）返回处理结果
代码见上面的获取单例的调用入口getSingleton</p><h2 id=5-准备创建bean>5、准备创建bean</h2><p>即上述getSingleton中调用createBean方法</p><blockquote><p>注意源码溯源方法的重载覆盖</p></blockquote><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39;&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#000>=</span> <span style=color:#000>mbd</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 锁定class，根据设置的class属性或者className来解析Class
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#000>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>resolvedClass</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>hasBeanClass</span><span style=color:#000>()</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getBeanClassName</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mbdToUse</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mbdToUse</span><span style=color:#000>.</span><span style=color:#836c28>setBeanClass</span><span style=color:#000>(</span><span style=color:#000>resolvedClass</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 验证及准备覆盖的方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mbdToUse</span><span style=color:#000>.</span><span style=color:#836c28>prepareMethodOverrides</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#000>(</span><span style=color:#000>mbdToUse</span><span style=color:#000>.</span><span style=color:#836c28>getResourceDescription</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Validation of method overrides failed&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 给BeanPostProcessors一个机会来返回代理替代真正的实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#000>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbdToUse</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bean</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>mbdToUse</span><span style=color:#000>.</span><span style=color:#836c28>getResourceDescription</span><span style=color:#000>(),</span> <span style=color:#000>beanName</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#000>=</span> <span style=color:#000>doCreateBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbdToUse</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39;&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>beanInstance</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=处理override属性>处理override属性</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>mbdToUse</span><span style=color:#000>.</span><span style=color:#836c28>prepareMethodOverrides</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=实例化的前置处理>实例化的前置处理</h3><p><strong>当经过前置处理后返回的结如果不为空，那么会直接略过后序的Bean的创建而直接返回结果。这一特性起着至关重要的作用，AOP功能是基于这里判断的</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>resolveBeforeInstantiation</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=6-循环依赖>6、循环依赖</h2><h2 id=7-创建bean>7、创建bean</h2><p>createBean调用核心代码doCreateBean</p><p>整个函数的概要思路：</p><p>1）如果是单例需要首先清楚缓存</p><p>2）实例化bean，将BeanDefinition转换为BeanWrapper</p><p>3）MergedBeanDefinitionPostProcessor的应用</p><p>bean合并后的处理，Autowired注解正是通过此方法实现诸如类型的预解析</p><p>4）依赖处理</p><p>5）属性填充</p><p>6）循环依赖处理</p><p>7）注册DisposableBean</p><p>如果配置了destroy-method，需要注册以便于在销毁时候调用</p><p>8）完成创建并返回</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">97
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Instantiate the bean.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>isSingleton</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>instanceWrapper</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>factoryBeanInstanceCache</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 根据指定bean使用对应的策略创建新的实例，如：工厂方法、构造函数自动注入、简单初始化
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>instanceWrapper</span> <span style=color:#000>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#000>.</span><span style=color:#836c28>getWrappedInstance</span><span style=color:#000>()</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#000>.</span><span style=color:#836c28>getWrappedClass</span><span style=color:#000>()</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Allow post-processors to modify the merged bean definition.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>postProcessingLock</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>postProcessed</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 应用MergedBeanDefinitionPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>beanType</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>postProcessed</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 是否需要提早曝光：单例&amp;允许循环依赖&amp;当前bean正在创建中，检测循环依赖
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>isSingleton</span><span style=color:#000>()</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>allowCircularReferences</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>               <span style=color:#c41a16>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 为避免后期循环依赖，可以在bean初始化完成前将创建实例的ObjectFactory工厂
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>addSingletonFactory</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 对bean再一次循环依赖，主要应用SmartInstantiationAware BeanPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 其中我们熟悉的AOP就是在这里将advice动态织入bean中，若没有则直接返回bean，不做处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>bean</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>});</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Initialize the bean instance.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#000>=</span> <span style=color:#000>bean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 对bean进行填充，将各个属性值织入，其中，可能存在依赖于其他bean的属性，则会递归初始依赖bean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>populateBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>exposedObject</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 调用初始化方法，比如init-method
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>exposedObject</span> <span style=color:#000>=</span> <span style=color:#000>initializeBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>exposedObject</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>ex</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#000>)</span> <span style=color:#000>ex</span><span style=color:#000>).</span><span style=color:#836c28>getBeanName</span><span style=color:#000>()))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>throw</span> <span style=color:#000>(</span><span style=color:#000>BeanCreationException</span><span style=color:#000>)</span> <span style=color:#000>ex</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getResourceDescription</span><span style=color:#000>(),</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Initialization of bean failed&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#000>=</span> <span style=color:#000>getSingleton</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 只有在检测到有循环依赖的情况下才会不为空
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 如果exposedObject没有在初始化方法中被改变，也就是没有被增强
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>exposedObject</span> <span style=color:#000>==</span> <span style=color:#000>bean</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>exposedObject</span> <span style=color:#000>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>allowRawInjectionDespiteWrapping</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#000>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#000>.</span><span style=color:#836c28>length</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#000>:</span> <span style=color:#000>dependentBeans</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#177500>// 检测依赖
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#000>(</span><span style=color:#000>dependentBean</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>actualDependentBeans</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>dependentBean</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 因为bean创建后其所依赖的bean一定是已经创建的
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// actualDependentBeans不为空则表示当前bean创建后其依赖的bean却没有没全部创建，也就是说存在循环依赖
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;Bean with name &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>collectionToCommaDelimitedString</span><span style=color:#000>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#000>)</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#c41a16>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Register bean as disposable.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 根据scope注册bean
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>bean</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getResourceDescription</span><span style=color:#000>(),</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Invalid destruction signature&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>exposedObject</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=创建bean的实例>创建bean的实例</h3><p>实例化逻辑：</p><p>1）如果在RootBeanDefinition中存在factoryMethodName属性，或者在配置文件中配置了factory-method，那么Spring会尝试使用instantiateUsingFactoryMethod(beanName, mbd, args)方法根据RootBeanDefinition中的配置生成bean的实例</p><p>2）解析构造函数并进行构造函数的实例化。因为一个bean对应的类中可能会有多个构造函数，而每个构造函数的参数不同，Spring在根据参数及类型去判断最终会使用哪个构造函数进行实例化。但是，判断的过程是个比较消耗性能的步骤，所以采用缓存机制，如果已经解析过则不需要重复解析而是直接从RootBeanDefinition中的属性resolvedConstructorOrFacrotyMethod缓存的值去取，否则需要再次解析，并将解析的结果添加至RootBeanDefinition中的属性resolvedConstructorOrFactoryMethod中。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 解析class
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#000>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>beanClass</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>Modifier</span><span style=color:#000>.</span><span style=color:#836c28>isPublic</span><span style=color:#000>(</span><span style=color:#000>beanClass</span><span style=color:#000>.</span><span style=color:#836c28>getModifiers</span><span style=color:#000>())</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>isNonPublicAccessAllowed</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getResourceDescription</span><span style=color:#000>(),</span> <span style=color:#000>beanName</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanClass</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 如果工厂方法不为空则使用工厂方法初始化策略
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getFactoryMethodName</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span>  <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Shortcut when re-creating the same bean...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>boolean</span> <span style=color:#000>resolved</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>args</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>constructorArgumentLock</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 一个类有多个构造函数，每个构造函数都有不同的参数，所以调用前需要先根据参数锁定构造函数或对应的工厂方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>resolvedConstructorOrFactoryMethod</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>resolved</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>autowireNecessary</span> <span style=color:#000>=</span> <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>constructorArgumentsResolved</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 如果已经解析过则使用解析好的构造函数方法不需要再次锁定
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>resolved</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>autowireNecessary</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 构造函数自动注入
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 使用默认构造函数构造
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>return</span> <span style=color:#000>instantiateBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 需要根据参数解析构造函数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#000>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#000>(</span><span style=color:#000>beanClass</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>ctors</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>         <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getResolvedAutowireMode</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#000>.</span><span style=color:#836c28>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>         <span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>hasConstructorArgumentValues</span><span style=color:#000>()</span> <span style=color:#000>||</span> <span style=color:#000>!</span><span style=color:#000>ObjectUtils</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>))</span>  <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 构造函数自动注入
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>ctors</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 使用默认构造函数构造
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>return</span> <span style=color:#000>instantiateBean</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=1-autowireconstructor>1、autowireConstructor</h4><p>对于实例的创建Spring分成了两种情况，一种是通用的实例化，另一种是带有参数的实例化。带有参数的实例化过程相当复杂，因为存在着不确定性，所以在判断对应参数上做了大量工作。</p><blockquote><p>这里代码逻辑太长，略，见P105</p></blockquote><p>1）构造函数参数的确定</p><ul><li>根据explicitArgs参数判断</li><li>缓存中获取</li><li>配置文件中获取
2）构造函数的确定</li></ul><p>3）根据确定的构造函数转换对应的参数类型</p><p>4）构造函数不确定性的验证</p><p>5）根据实例化策略以及得到的构造函数及构造函数参数实例化Bean。</p><h4 id=2-instantiatebean>2、instantiateBean</h4><p>不带参数的构造函数的实例化过程</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getSecurityManager</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>beanInstance</span> <span style=color:#000>=</span> <span style=color:#000>AccessController</span><span style=color:#000>.</span><span style=color:#836c28>doPrivileged</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#000>().</span><span style=color:#836c28>instantiate</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>parent</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>beanInstance</span> <span style=color:#000>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#000>().</span><span style=color:#836c28>instantiate</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>parent</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#000>(</span><span style=color:#000>beanInstance</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>initBeanWrapper</span><span style=color:#000>(</span><span style=color:#000>bw</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>bw</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>getResourceDescription</span><span style=color:#000>(),</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Instantiation of bean failed&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=3-实例化策略>3、实例化策略</h4><p>经过前面的分析，已经得到了足以实例化的所有相关信息，完全可以使用最简单的反射方法直接反射来构造实例对象，但Spring却没有这么做</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#000>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 如果有需要覆盖或者动态替换的方法则当然需要使用cglib进行动态代理，因为可以再创建代理的同时将动态方法织入类中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 但是如果没有需要动态改变的方法，为了方便直接反射就可以了
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>bd</span><span style=color:#000>.</span><span style=color:#836c28>getMethodOverrides</span><span style=color:#000>().</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>bd</span><span style=color:#000>.</span><span style=color:#836c28>constructorArgumentLock</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>constructorToUse</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#000>.</span><span style=color:#836c28>resolvedConstructorOrFactoryMethod</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>constructorToUse</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>final</span> <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#000>=</span> <span style=color:#000>bd</span><span style=color:#000>.</span><span style=color:#836c28>getBeanClass</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>clazz</span><span style=color:#000>.</span><span style=color:#836c28>isInterface</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#000>(</span><span style=color:#000>clazz</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;Specified class is an interface&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getSecurityManager</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>constructorToUse</span> <span style=color:#000>=</span> <span style=color:#000>AccessController</span><span style=color:#000>.</span><span style=color:#836c28>doPrivileged</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#000>&lt;</span><span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>                     <span style=color:#a90d91>public</span> <span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>return</span> <span style=color:#000>clazz</span><span style=color:#000>.</span><span style=color:#836c28>getDeclaredConstructor</span><span style=color:#000>((</span><span style=color:#000>Class</span><span style=color:#000>[])</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>});</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>constructorToUse</span> <span style=color:#000>=</span> <span style=color:#000>clazz</span><span style=color:#000>.</span><span style=color:#836c28>getDeclaredConstructor</span><span style=color:#000>((</span><span style=color:#000>Class</span><span style=color:#000>[])</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>               <span style=color:#000>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000>bd</span><span style=color:#000>.</span><span style=color:#836c28>resolvedConstructorOrFactoryMethod</span> <span style=color:#000>=</span> <span style=color:#000>constructorToUse</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#000>(</span><span style=color:#000>clazz</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;No default constructor found&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>BeanUtils</span><span style=color:#000>.</span><span style=color:#836c28>instantiateClass</span><span style=color:#000>(</span><span style=color:#000>constructorToUse</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// Must generate CGLIB subclass.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#000>(</span><span style=color:#000>bd</span><span style=color:#000>,</span> <span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>owner</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>首先判断如果beanDefinition.getMethodOverrides()为空也就是用户没有使用replace或lookup的配置方法，那么直接使用反射的方式，简单快捷，但是如果使用了这两个特性，就直接使用反射的方式创建实例就不妥了，因为需要将这两个配置提供的功能切入进去，所以就必须使用动态代理的方式将包含两个特性对应的逻辑的拦截增强设置进去，这样百能保证在调用方法的时候会被相应的拦截器增强，返回值为包含拦截器的代理实例。</p><h3 id=记录创建bean的objectfactory>记录创建bean的ObjectFactory</h3><p>在doCreate函数中有这样一段代码</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>mbd</span><span style=color:#000>.</span><span style=color:#836c28>isSingleton</span><span style=color:#000>()</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>allowCircularReferences</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>beanName</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>            <span style=color:#c41a16>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 为避免后期循环依赖，可以在bean初始化完成前将创建实例的ObjectFactory加入工厂
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>addSingletonFactory</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 对bean再一次依赖引用，主要应用SmartInstantiationAware BeanPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// 其中我们熟知的AOP就是在这里将advice动态织入bean中，若没有则直接返回bean，不做任何处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#000>(</span><span style=color:#000>beanName</span><span style=color:#000>,</span> <span style=color:#000>mbd</span><span style=color:#000>,</span> <span style=color:#000>bean</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>});</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=属性注入>属性注入</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>populateBean</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=autowirebyname>autowireByName</h4><h4 id=autowirebytype>autowireByType</h4><p>autowireByType与autowireByName对于我们理解与使用来说复杂程度都很相似，但是其实现功能的复杂度却完全不一样。</p><h4 id=applypropertyvalues>applyPropertyValues</h4><h3 id=初始化bean>初始化bean</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>initalizeBean</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=注册disposablebean>注册DisposableBean</h3><p>除了熟知的配置属性destroy-method方法外，用户还可以注册后处理器DestructionAwareBeanPostProcessor来统一处理bean的销毁方法</p><h1 id=容器的功能扩展>容器的功能扩展</h1><p>BeanFactory接口以及它的默认实现类XmlBeanFactory，Spring还提供了另一个接口ApplicationContext，用于扩展BeanFactory的现有功能。</p><p>ApplicationContext和BeanFactory都是用于加载bean的，相比之下，ApplicationContext提供了更多的扩展功能，包含BeanFactory的所有功能，通常建议比BeanFactory优先（除非在一些限制的场合，如字节长度对内存有很大的影响时(Applet)）。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 使用BeanFactory方式加载xml
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>BeanFactory</span> <span style=color:#000>bf</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>XmlBeanFactory</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ClassPathResource</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;beanFacotryTest.xml&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#177500>// 使用ApplicationContext方式加载xml
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>ApplicationContext</span> <span style=color:#000>bf</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;beanFactoryText.xml&#34;</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=spring的扩展>Spring的扩展</h1><h2 id=preparerefresh>prepareRefresh</h2><p>iniPropertySources()</p><p>留给子类覆盖，初始化属性资源</p><p>getEnvironment().validateRequiredProperties()</p><p>创建并获取环境对象，验证需要的属性文件是否都已经放入环境中</p><h2 id=obtainfreshbeanfactory>obtainFreshBeanFactory</h2><p>加载xml配置文件的属性值到当前工厂中，最重要的就是BeanDefinition</p><h2 id=扩展实现customizebeanfactory方法>扩展实现customizeBeanFactory方法</h2><p>此方法是用来实现BeanFactory的属性设置，主要是设置两个属性：</p><p>allowBeanDefinitionOverriding：是否允许覆盖同名称的不同定义的对象</p><p>allowCircularReferences：是否允许bean之间的循环依赖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyClassPathXmlApplicationContext</span> <span style=color:#a90d91>extends</span> <span style=color:#000>ClassPathXmlApplicationContext</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>MyClassPathXmlApplicationContext</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>...</span> <span style=color:#000>locations</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#000>location</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>customizeBeanFactory</span><span style=color:#000>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>setAllowBeanDefinitionOverriding</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>setAllowCircularReference</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>customizeBeanFactory</span><span style=color:#000>(</span><span style=color:#000>beanFactory</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>适配器模式</p><p><img src=../imgs/spring_bean_load_4.png alt=spring_bean_load_4.png></p><h1 id=heading></h1><p>debug时调用toString()方法初始化加载文件</p><p><img src=../imgs/spring_bean_load_5.png alt=spring_bean_load_5.png></p><p>xml配置文件头信息</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#633820>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;beans</span> <span style=color:#836c28>xmlns=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xmlns:context=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/context&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xmlns:xsi=</span><span style=color:#c41a16>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xsi:schemaLocation=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        &#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>&lt;!-- 示意
</span></span></span><span style=display:flex><span><span style=color:#177500>    &lt;context:property-placeholder location=&#34;classpath:spring-mvc.xml&#34;&gt;&lt;/context:property-placeholder&gt;
</span></span></span><span style=display:flex><span><span style=color:#177500>    --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;bean</span> <span style=color:#836c28>id=</span><span style=color:#c41a16>&#34;user&#34;</span> <span style=color:#836c28>class=</span><span style=color:#c41a16>&#34;com.huangbo.pojo.User&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;name&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;zhangsan&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/beans&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=bean覆盖问题>bean覆盖问题</h2><p><a href=https://blog.csdn.net/f641385712/article/details/93777536>https://blog.csdn.net/f641385712/article/details/93777536</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ec8796cf812c27585ba4cf97965e03ce>6 - spring注解驱动+源码</h1><h2 id=组件注册>组件注册</h2><p>给容器中注入组件</p><h3 id=1-包扫描-组件标注注解>1）包扫描+组件标注注解</h3><p>（@Controller/@Service/@Repository/@Component）</p><h3 id=2-bean导入>2）@Bean导入</h3><p>[导入的第三方包里面的组件]</p><h3 id=3-import>3）@Import</h3><p>[快速给容器中导入一个组件]，查看源码，可以看到有三种导入方法</p><h4 id=3-1-import>3.1）@Import</h4><p>(要导入到容器中的组件)：容器找那个就会自动注册这个组件，id默认是全类名</p><h4 id=3-2-importselector>3.2）ImportSelector</h4><p>返回需要导入的全类名数组(注意：可以返回空数组，但不要返回null)</p><h4 id=3-3-importbeandefinitionregistrar>3.3）ImportBeanDefinitionRegistrar</h4><p>注：在Config的类上注，如下</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>@Import({Color.class,Red.class, MyImportSelector.class, MyImportBeanDefinitionRegistrar})
</span></span><span style=display:flex><span>//@Import(Color.class)
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span>public class Config{
</span></span><span style=display:flex><span>    @Lazy
</span></span><span style=display:flex><span>    @Bean(&#34;person&#34;)
</span></span><span style=display:flex><span>    public Person person() {
</span></span><span style=display:flex><span>        return new Person();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>public class MyImportSelector implements ImportSelector {
</span></span><span style=display:flex><span>    // 返回值，就是要导入到容器中的组件全类名
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    public String[] selectImports(AnnotationMetadata importingClassMetadata) {
</span></span><span style=display:flex><span>        // 不要返回null
</span></span><span style=display:flex><span>        return new String[]{&#34;com.xxx.xxx.Yellow&#34;,&#34;com.xxx.xxx.Blue&#34;}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>public class MyImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar {
</span></span><span style=display:flex><span>    // AnnotationMetadata: 当前类的注解信息
</span></span><span style=display:flex><span>    // BeanDefinitionRegistry: BeanDefinition注册类，把所有需要添加到容器中的类注册进去.
</span></span><span style=display:flex><span>    // 调用BeanDefinitionRegistry.registerBeanDefinition手工注册
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry beanDefinitionRegistry) {
</span></span><span style=display:flex><span>        boolean definition = registry.containBeanDefinition(&#34;red&#34;);
</span></span><span style=display:flex><span>        if (definition) {
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=4-使用factorybean-工厂bean>4）使用FactoryBean（工厂Bean）</h3><p>4.1）默认获取到的是工厂bean调用getObject创建的对象</p><p>4.2）要获取工厂Bean本身，需要在id前面加一个&（查看FactoryBean接口源码，定义了常量）</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>public class ColorFactoryBean implements FactoryBean&lt;Color&gt; {
</span></span><span style=display:flex><span>    // 返回一个对象，该对象会添加到容器中
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    public Color getObject() throws Exception {
</span></span><span style=display:flex><span>        return new Color();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    public Class&lt;?&gt; getObjectType() {
</span></span><span style=display:flex><span>        return Color.class;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    // ture：容器中只保留一份
</span></span><span style=display:flex><span>    // false: 多份
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    public boolean isSingleton() {
</span></span><span style=display:flex><span>        reutrn false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span>public class Config{
</span></span><span style=display:flex><span>    @Bean
</span></span><span style=display:flex><span>    public ColorFactoryBean colorFactoryBean() {
</span></span><span style=display:flex><span>        return new ColorFactoryBean();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=生命周期>生命周期</h2><h3 id=指定初始化和销毁方法>指定初始化和销毁方法</h3><p>1、指定初始化方法和销毁方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>@ComponentSan(&#34;com.xxx.bean&#34;)
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span>public class MainConfigOfLifeCycle {
</span></span><span style=display:flex><span>    // 指定car中定义的方法
</span></span><span style=display:flex><span>    @Bean(initMethod=&#34;init&#34;, destroyMethod=&#34;destroy&#34;)
</span></span><span style=display:flex><span>    public Car car() {
</span></span><span style=display:flex><span>        returen new Car();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>2、通过让Bean实现InitializingBean（定义初始化逻辑） 、DisposableBean（定义销毁逻辑）
3、可以使用JSR250，在bean定义的方法上加上以下注解 @PostConstruct：bean创建完成 @PreDestroy：容易移除bean之前</p><p>4、BeanPostProcessor接口，bean的后置处理器；在bean初始化前后进行一些处理工作； postProcessBeforeInitialization(Object object, xxx); postProcessAfterInittialization(Object object, xxx);</p><h3 id=instantiationawarebeanpostprocessor>InstantiationAwareBeanPostProcessor</h3><p>其方法postProcessAfterInstantiation，可以根本Object bean判断需要实例话的方法，或者全部不实例化</p><h2 id=aop>AOP</h2><h3 id=enableaspectjautoproxy>@EnableAspectJAutoProxy</h3><p>1、@Import(AspectJAutoProxyRegistrar.class 给容器中导入AspectJAutoProxyRegistrar，</p><p>利用AspectJAutoProxyRegistrar自定义给容器中注册bean。</p><p>internalAutoProxyCreator = AnnotationAwareAspectJAutoProxyCreator</p><p>给容器中注册一个AnnotationAwareAspectJAutoProxyCreator</p><p>2、AnnotationAwareAspectJAutoProxyCreator</p><p>类的继承关系</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>AnnotationAwareAspectJAutoProxyCreator</span>
</span></span><span style=display:flex><span>  <span style=color:#000>-&gt;</span><span style=color:#000>AspectJAwareAdvisorAutoProxyCreator</span>
</span></span><span style=display:flex><span>    <span style=color:#000>-&gt;</span><span style=color:#000>AbstractAdvisorAutoProxyCreator</span>
</span></span><span style=display:flex><span>      <span style=color:#000>-&gt;</span><span style=color:#000>AbstractAutoProxyCreator</span>
</span></span><span style=display:flex><span>      <span style=color:#000>impl</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#000>,</span> <span style=color:#000>BeanFactoryAware</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>//关注后置处理器、自动装配bean
</span></span></span></code></pre></td></tr></table></div></div></div><p>类的主要方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>AbstractAutoProxyCreator</span><span style=color:#000>.</span><span style=color:#836c28>setBeanFactory</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span><span style=color:#000>AbstractAutoProxyCreator</span><span style=color:#000>.</span><span style=color:#836c28>后置处理器逻辑</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>AbstractAdvisorAutoProxyCreator</span><span style=color:#000>.</span><span style=color:#836c28>setBeanFactory</span><span style=color:#000>()-&gt;</span><span style=color:#000>initBeanFactory</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>AnnotationAwareAspectJAutoProxyCreator</span><span style=color:#000>.</span><span style=color:#836c28>initBeanFactory</span><span style=color:#000>()</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=调用流程>调用流程</h3><p>1、传入配置类，创建ioc容器</p><p>2、注册配置类，调用refresh()刷新容器</p><p>3、registerBeanPostProcessors(beanFactory);注册bean的后置处理器来拦截bean的创建</p><p>3.1、先获取ioc容器已经定义了的需要创建对象的所有BeanPostProcessor</p><p>3.2、给容器中加别的BeanPostProcessor</p><p>3.3、优先注册实现了PriorityOrdered接口的BeanPostProcessor</p><p>3.4、再给容器中注册实现了Ordered接口的BeanPostProcessor</p><p>3.5、没实现优先级接口的BeanPostProcessor</p><p>3.6、注册BeanPostProcessor，实际上就是创建BeanPostProcessor对象，保存在容器中。</p><p>创建internalAutoProxyCreator的BeanPostProcessor【AnnotationAwareAspectJAutoProxyCreator】</p><p>3.6.1、创建bean的实例</p><p>3.6.2、populateBean：给bean各种属性赋值</p><p>3.6.3、initializeBean：初始化bean</p><p>3.6.3.1、invokeAwareMethods()：处理Aware接口的方法回调</p><p>3.6.3.2、applyBeanPostProcessorsBeforeInitialization()：应用后置处理器的BeforeInitialization</p><p>3.6.3.3、invokeInitMethods()：执行自定义的初始化方法</p><p>3.6.3.4、applyBeanPostProcessorsAfterInitialization()：执行后置处理器的postProcessAfterInitialization()</p><p>3.6.4、BeanPostProcessor(AnnotationAwareAspectJAutoProxyCreator)</p><p>3.7、把BeanPostProcessor注册到BeanFactory中：</p><p>beanFactory.addBeanPostProcessor(postProcessor);</p><p>===以上是创建和注册AnnotationAwareAspectJAutoProxyCreator的过程===</p><p>4、finishBeanFactoryInitialization(beanFactory);完成BeanFactory初始话工作，创建剩下的单实例bean</p><p>4.1、编译获取容器中所有的bean，依次创建对象getBean(beanName);</p><p>getBean->doGetBean()->getSingleton()</p><p>4.2、创建bean</p><p>【AnnotationAwareAspectJAutoProxyCreator在所有bean创建之前会有一个拦截，InstantiationAwareBeanPostProcessor，会调用postProcessBeforeInstantiation()】</p><p>4.2.1、先从缓存中获取当前bean，如果能获取到，说明bean是之前被创建过直接使用，否则再创建；只要创建好的bean都会被缓存起来</p><p>4.2.2、createBean(); 创建bean; AnnotationAwareAspectJAutoProxyCreator会在任何bean创建之前尝试返回bean的实例</p><p>【BeanPostProcessor是在Bean对象创建完成初始化前后调用的】</p><p>【InstantiationAwareBeanPostProcessor是在创建Bean实例之前先尝试用后置处理器返回对象的】</p><p>4.2.2.1、resolveBeforeInstantiation(beanName, mbdToUse); 解析BeforeInstantiation</p><p>希望后置处理器在次能返回一个代理对象，如果不能就继续</p><p>4.2.2.1.1、后置处理器先尝试返回对象；</p><p>bean=applyBeanPostProcessorsBeforeInstantiation()</p><p>拿到所有后置处理器，如果是InstanttiationAwareBeanPostProcessor，就执行postProcessBeforeInstantiation</p><p>if (bean != null) {</p><p>bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</p><p>}</p><p>4.2.2.2、doCreateBean(beanName, mbdToUse, args); 真正地去创建一个bean实例；和3.6流程一致</p><h3 id=processor的作用>processor的作用</h3><p>AnnotationAwareAspectJAutoProxyCreator【InstanttiationAwareBeanPostProcessor】的作用：</p><p>1、每一个bean创建之前，调用postProcessBeforeInstantiation();</p><p>关心MathCalculator和LogAspect的创建</p><p>1.1、判断当前bean是否在advisedBeans中（保存了所有需要增强bean）</p><p>1.2、判断当前bean是否是基本类型Advice/PointCut/Adivsor/AopInfrastructureBean，或者是否为切面(@Aspect)</p><p>1.3、是否需要跳过</p><p>1.3.1、获取候选的增强器（切面里面的通知方法）【List<advisor> candidateAdvisors】</p><p>每一个封装的通知方法的增强器是InstantiationModelAwarePointcutAdvisor;</p><p>判断每一个增强器是否是AspectJPointcutAdvisor类型的，返回true</p><p>1.3.2、永远返回false</p><p>2、创建对象</p><p>postProcessAfterInitialization;</p><p>return wrapIfNecessary(bean, beanName, cacheKey);//包装如果需要的情况下</p><p>2.1、获取当前bean的所有增强器（通知方法）Object[] specificInterceptors</p><p>2.1.1、找到能在当前bean使用的增强器（找哪些通知方法是需要切入当前bean方法的）</p><p>2.1.2、获取到能在bean使用的增强器。</p><p>2.1.3、给增强排序</p><p>2.2、保存当前bean在advisedBeans中</p><p>2.3、如果当前bean需要增强，创建当前bean的代理对象</p><p>2.3.1、获取所有增强器（通知方法）</p><p>2.3.2、保存到proxyFactory</p><p>2.3.3、创建代理对象，spring自动决定（jdk、cglib）</p><p>2.4、给容器中返回当前组件使用cglib增强了的代理对象</p><p>2.5、以后容器中获取到的就是这个组件的代理对象，执行目标方法的时候，代理对象就会执行通知方法的流程</p><p>3、目标方法的执行</p><p>容器中保存了组件的代理对象（cglib增强后的对象），这个对象里面保存了详细信息（比如增强器，目标对象，xxx）；</p><p>3.1、CglibAopProxy.intercept(); 拦截目标方法的执行</p><p>3.2、根据ProxyFactory对象获取将要执行的目标方法的拦截器链;</p><p>List<object> chain=this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</p><p>3.2.1、List<object> interceptroList保存所有拦截器5</p><p>1个默认的ExposeInvocationInterceptor和4个增强器</p><p>3.2.2、遍历所有的增强器，将其转为Interceptor;</p><p>registry.getInterceptors(advisor);</p><p>3.2.3、将增强器转为List<methodinterceptor>;</p><p>如果是MethodInterceptor，直接加入到集合中；如果不是使用AdvisorAdapter将增强器转为MethodInterceptor；转换完成返回MethodInterceptor数组；</p><p>3.3、如果没有拦截器链，直接执行目标方法</p><p>拦截器链（每一个通知方法又被包装成方法拦截器，利用MethodInterceptor机制）</p><p>3.4、如果有拦截器链，把需要执行的目标对象、目标方法、拦截器等信息传入创建一个CglibMethodInvocation对象，并调用Object retVal = mi.proceed();</p><p>3.5、拦截器的触发过程</p><p>3.5.1、如果没有拦截器执行目标方法，或者拦截器的索引和拦截器</p><p>3.5.2、链式获取每一个拦截器，拦截器执行invoke方法，每一个拦截器等待下一个拦截器执行完成返回以后来执行；</p><p>拦截器的机制，保证通知方法与目标方法的执行顺序</p><p>拦截器链</p><p><img src=../imgs/spring_zhujiequdong_source_1.png alt=spring_zhujiequdong_source_1.png></p><h3 id=总结>总结</h3><p>1、@EnableAspectJAutoProxy开启aop功能</p><p>2、@EnableAspectJAutoProxy会给容器中注册一个组件AnnotationAwareAspectJAutoProxyCreator</p><p>3、AnnotationAwareAspectJAutoProxyCreator是一个后置处理器</p><p>4、容器的创建流程</p><p>4.1、registerBeanPostProcessors()注册后置处理器，创建AnnotationAwareAspectJAutoProxyCreator对象</p><p>4.2、finishBeanFactoryInitailization()初始化剩下的单实例bean</p><p>4.2.1、创建业务逻辑组件和切面组件</p><p>4.2.2、AnnotationAwareAspectJAutoProxyCreator拦截组件的创建过程</p><p>4.2.3、组件创建完之后，判断组件是否需要增强</p><p>是：切面的通知方法，包装成增强器（Advisor）；给业务组件创建一个代理对象(cglib)</p><p>5、执行目标方法</p><p>5.1、代理对象执行目标方法</p><p>5.2、CglibAopProxy.intercept();</p><p>5.2.1、得到目标方法的拦截器链，（增强器包装成拦截器MethodInterceptor）</p><p>5.2.2、利用拦截器链式机制，依次进入每一个拦截器进行执行</p><p>5.2.3、效果：</p><p>正常执行：前置通知->目标方法->后置通知->返回通知</p><p>出现异常：前置通知->目标方法->后置通知->异常通知</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6802cca9b8eff6f9b6a428f138062353>7 - SpringBoot-01基础使用及原理</h1><h1 id=简介>简介</h1><h2 id=spring与springboot>Spring与SpringBoot</h2><h3 id=spring的能力>Spring的能力</h3><p>参考 Spring 官网（<a href=https://spring.io/>https://spring.io/</a>）：What Spring can do</p><ul><li>Microservices</li><li>Reactive</li><li>Cloud</li><li>Web apps</li><li>Serverless</li><li>Event Driven</li><li>Batch</li></ul><h3 id=spring的生态>Spring的生态</h3><p>参考 spring 官网：<a href=https://spring.io/projects/spring-boot>https://spring.io/projects/spring-boot</a></p><ul><li>web开发</li><li>数据访问</li><li>安全控制</li><li>分布式</li><li>消息服务</li><li>移动开发</li><li>批处理</li><li>....</li></ul><h3 id=spring5-重大升级>Spring5 重大升级</h3><h4 id=响应式编程>响应式编程</h4><p>参考：<a href=https://spring.io/reactive>https://spring.io/reactive</a></p><p><img src=../imgs/spring-boot-01-220918_1.png alt=spring-boot-01-220918_1.png></p><h4 id=支持java8新特性>支持Java8新特性</h4><p>基于 Java8 的一些新特性，如：接口默认实现。重新设计源码架构等。</p><h2 id=springboot优缺点>SpringBoot优缺点</h2><p>优点（Features）：</p><ul><li><p>Create stand-alone Spring applications
创建独立 Spring 应用</p></li><li><p>Embed Tomcat, Jetty or Undertow directly (no need to deploy WAR files)
内嵌 web 服务器</p></li><li><p>Provide opinionated 'starter' dependencies to simplify your build configuration
自动 starter 依赖，简化构建配置</p></li><li><p>Automatically configure Spring and 3rd party libraries whenever possible
自动配置 Spring 以及第三方功能</p></li><li><p>Provide production-ready features such as metrics, health checks, and externalized configuration
提供生产级别的监控、健康检查及外部化配置</p></li><li><p>Absolutely no code generation and no requirement for XML configuration
无代码生成、无需编写XML</p></li></ul><p>SpringBoot 是整合 Spring 技术的一站式框架。SpringBoot 是简化 Spring 技术栈的快速开发脚手架。</p><p>缺点：</p><ul><li>迭代快，人称版本帝，需要时刻关注变化</li><li>封装太深，内部原理复杂，理解成本高</li></ul><h2 id=时代背景>时代背景</h2><h3 id=微服务>微服务</h3><p><a href=https://martinfowler.com/articles/microservices.html>James Lewis and Martin Fowler (2014)</a> 提出微服务完整概念 <a href=https://martinfowler.com/microservices/>https://martinfowler.com/microservices/</a>。</p><ul><li>微服务是一种架构风格</li><li>一个应用拆分为一组小型服务</li><li>每个服务运行在自己的进程内，即可独立部署和升级</li><li>服务之间使用轻量级HTTP交互</li><li>服务围绕业务功能拆分</li><li>可以由全自动部署机制独立部署</li><li>去中心化，服务自治。服务可以使用不同的语言、不同的存储技术</li></ul><h3 id=分布式>分布式</h3><p>分布式的困难：</p><ul><li>远程调用</li><li>服务发现</li><li>负载均衡</li><li>服务容错</li><li>配置管理</li><li>服务监控</li><li>链路追踪</li><li>日志管理</li><li>任务调度</li><li>...
分布式解决方案：SpringBoot + SpringCloud</li></ul><h3 id=云原生>云原生</h3><p>原生应用如何上云：Cloud Native</p><p>上云的困难：</p><ul><li>服务自愈</li><li>弹性伸缩</li><li>服务隔离</li><li>自动化部署</li><li>灰度发布</li><li>流量治理</li><li>......</li></ul><h2 id=官方文档>官方文档</h2><p>SpringBoot 官网：<a href=https://spring.io/projects/spring-boot>https://spring.io/projects/spring-boot</a></p><p>Document 路径： <a href=https://spring.io/projects/spring-boot#learn>learn</a>（SpringBoot 主页面） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/>Documentation</a> （各类文档，<strong>重点</strong>） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/documentation.html#documentation>Documentation Overview</a></p><p>SpringBoot 发布日志：<a href=https://spring.io/projects/spring-boot#overview>overview</a> （SpringBoot 主页面）-> <a href=https://github.com/spring-projects/spring-boot/wiki#release-notes>release-notes</a>（Github Wiki）</p><p>查看版本新特性：<a href=https://github.com/spring-projects/spring-boot/wiki#release-notes>https://github.com/spring-projects/spring-boot/wiki#release-notes</a></p><h1 id=springboot2入门>SpringBoot2入门</h1><h2 id=系统要求>系统要求</h2><ul><li>Java8 & 兼容 Java14</li><li>Maven 3.3+</li><li>IDEA 2019.01.02+</li></ul><h3 id=maven设置>maven设置</h3><ul><li>配置阿里云镜像加速</li><li>profiles<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>  <span style=color:#000>&lt;mirrors&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;mirror&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;id&gt;</span>nexus-aliyun<span style=color:#000>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;mirrorOf&gt;</span>central<span style=color:#000>&lt;/mirrorOf&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;name&gt;</span>Nexus aliyun<span style=color:#000>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span style=color:#000>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;/mirror&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;/mirrors&gt;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#000>&lt;profile&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;id&gt;</span>jdk-1.8<span style=color:#000>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;activation&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>&lt;activeByDefault&gt;</span>true<span style=color:#000>&lt;/activeByDefault&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>&lt;jdk&gt;</span>1.8<span style=color:#000>&lt;/jdk&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;/activation&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>&lt;maven.compiler.source&gt;</span>1.8<span style=color:#000>&lt;/maven.compiler.source&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>&lt;maven.compiler.target&gt;</span>1.8<span style=color:#000>&lt;/maven.compiler.target&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>&lt;maven.compiler.compilerVersion&gt;</span>1.8<span style=color:#000>&lt;/maven.compiler.compilerVersion&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;/properties&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#000>&lt;/profile&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;/profiles&gt;</span>
</span></span></code></pre></td></tr></table></div></div></details><br></li></ul><h2 id=helloworld>HelloWorld</h2><p>参考官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started>getting-started</a></p><h3 id=创建maven工程>创建maven工程</h3><h3 id=引入依赖>引入依赖</h3><p>参考：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.first-application.pom>getting-started</a></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;parent&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-parent<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>2.3.0.RELEASE<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/parent&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=创建主程序>创建主程序</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MainApplication</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SpringApplication</span><span style=color:#000>.</span><span style=color:#836c28>run</span><span style=color:#000>(</span><span style=color:#000>MainApplication</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=编写业务代码>编写业务代码</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>//@ResponseBody
</span></span></span><span style=display:flex><span><span style=color:#177500>//@Controller
</span></span></span><span style=display:flex><span><span style=color:#177500>// RestController = ResponseBody + Controller
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>HelloController</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 可以直接配置在类上
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// @ResponseBody
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@RequestMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/hello&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;Hello World&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>RestController = ResponseBody + Controller</p><h3 id=测试>测试</h3><p>直接运行 main 方法</p><h3 id=简化配置>简化配置</h3><p>application.properties 配置可参考：</p><p>Document 路径： <a href=https://spring.io/projects/spring-boot#learn>learn</a>（SpringBoot 主页面） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/>Documentation</a> （各类文档，<strong>重点</strong>） -></p><p><a href=https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties>application-properties</a></p><blockquote><p>注意：配置文件不生效需要注意项目 packaging 类型（默认是 jar 类型）。此外生效时 IDEA 会有 LSP 提示。</p></blockquote><h3 id=简化部署>简化部署</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/plugins&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>把项目打成 jar 包，直接在目标服务器执行即可<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -jar xx.jar
</span></span></code></pre></td></tr></table></div></div></div></p><p>注意：Windows 终端需要取消 cmd 快速编辑模式，否则点击终端会卡住。</p><h1 id=自动配置原理>自动配置原理</h1><h2 id=依赖管理>依赖管理</h2><ul><li><p>依赖管理<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>该项目的 parent
</span></span><span style=display:flex><span><span style=color:#000>&lt;parent&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-parent<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>2.3.0.RELEASE<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/parent&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>它的 parent
</span></span><span style=display:flex><span><span style=color:#000>&lt;parent&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-dependencies<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;version&gt;</span>2.3.0.RELEASE<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/parent&gt;</span>
</span></span><span style=display:flex><span>spring-boot-dependencies pom 中声明了各种 properties，几乎包含开发中所有的jar
</span></span></code></pre></td></tr></table></div></div></div></p></li><li><p>starter
starter 文档路径： <a href=https://spring.io/projects/spring-boot#learn>learn</a>（SpringBoot 主页面） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/>Documentation</a> （各类文档，<strong>重点</strong>） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters>using Spring Boot</a></p></li></ul><ol><li>官方 starter 命令规则：spring-boot-starter-*</li><li>只要引入 starter，该场景常规需要的 jar 就自动引入</li><li>SpringBoot 所有支持的场景：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters>starters</a></li><li>第三方提供的简化开发的场景触发器：*-spring-boot-starter</li></ol><ul><li>修改版本号
在本 pom 中重写与 spring-boot-dependencies pom 相同的 properties，如：</li></ul><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;snakeyaml.version&gt;</span>1.30<span style=color:#000>&lt;/snakeyaml.version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/properties&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>分析依赖树
IDEA 中 pom 文件中右键菜单：Diagrams</li></ul><h2 id=自动配置>自动配置</h2><ul><li><p>自动配置 Tomcat</p><ul><li>引入 Tomcat 依赖</li><li>配置 Tomcat</li></ul></li><li><p>自动配置 SpringMVC</p><ul><li>引入 SpringMVC 依赖</li><li>配置 SpringMVC 常用组件，如 dispatcherServlet</li></ul></li><li><p>自动配置 Web 常见功能，如：字符编码问题</p><ul><li>配置如：characterEncodingFilter、*ViewResolver、multipartResolver</li></ul></li><li><p>默认的包结构</p><ul><li>默认包扫描规则：主程序所在的包及其下面所有子包里面的组件都会被扫描出来。官网文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.structuring-your-code.locating-the-main-class>Using Spring Boot # locating-the-main-class</a></li><li>指定扫描路径：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@SpringBootApplication</span><span style=color:#000>(</span><span style=color:#000>scanBasePackages</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;com.chnherb&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>或</span>
</span></span><span style=display:flex><span><span style=color:#000>@ComponentScan</span><span style=color:#000>(</span><span style=color:#000>xxx</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>其中</span> <span style=color:#000>ComponentScan</span> <span style=color:#000>与</span> <span style=color:#000>SpringBootApplication</span> <span style=color:#000>不能重复使用</span><span style=color:#000>：</span>
</span></span><span style=display:flex><span><span style=color:#000>@SpringBootApplication</span> 
</span></span><span style=display:flex><span><span style=color:#000>等同于</span>
</span></span><span style=display:flex><span><span style=color:#000>@SpringBootConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#000>@EnableAutoConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#000>@ComponentScan</span><span style=color:#000>(</span><span style=color:#000>xxx</span><span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul></li><li><p>配置各类默认值</p><ul><li>默认配置值最终都是映射到某个类上</li><li>配置文件的值会绑定到每个类上，类会在容器中创建对象</li></ul></li><li><p>按需加载所有自动配置项</p><ul><li>引入哪些场景的 starter 才会加载哪个场景的自动配置</li><li>所有的自动配置功能都在 spring-boot-autoconfigure 包中<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>路径：spring-boot-starter-* -&gt; spring-boot-starter -&gt; spring-boot-autoconfigure
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-autoconfigure<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;version&gt;</span>2.3.0.RELEASE<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;scope&gt;</span>compile<span style=color:#000>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul></li></ul><h1 id=组件与配置>组件与配置</h1><h2 id=组件添加>组件添加</h2><h3 id=configuration注解>Configuration注解</h3><ol><li><p>配置类里面使用 @Bean 标注在方法上给容器注册组件，默认是单实例的</p></li><li><p>配置类本身也是组件</p></li><li><p>proxyBeanMethods: 代理 bean 的方法</p></li></ol><ul><li><p>Full(proxyBeanMethods = true, 默认)
配置类组件之间有依赖关系，方法会被调用得到之前单实例组件</p></li><li><p>Lite(proxyBeanMethods = false)
配置类组件之间无依赖关系，加速容器启动过程，减少判断</p></li></ul><h3 id=其他主要注解>其他主要注解</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#000>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#000>@Service</span>
</span></span><span style=display:flex><span><span style=color:#000>@Repository</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=componentscan和import注解>ComponentScan和Import注解</h3><p>ComponentScan 包扫描使用主要注解如 @Component 等的文件自动注入。</p><p>Import 注解需要标注在 <strong>组件类</strong>（如 @Configuration 或 @Controller 等等）：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Import</span><span style=color:#000>({</span><span style=color:#000>User</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#000>@Configuration</span>
</span></span></code></pre></td></tr></table></div></div></div><p>Import 导入的对象 id 默认是<strong>全类名</strong>。</p><h3 id=条件装配>条件装配</h3><p>满足 Conditional 条件时则进行组件注入。可通过 ctrl + H 快捷键查看 Conditional 类的层次结构。</p><p><img src=../imgs/spring-boot-01-220918_2.png alt=spring-boot-01-220918_2.png></p><h2 id=xml配置文件引入>xml配置文件引入</h2><p>引入资源：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@ImportResource</span><span style=color:#000>(</span><span style=color:#000>locations</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;classpath:bean.xml&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>HelloConfig</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>bean.xml 文件</p><blockquote><p>IDEA 中新建 xml 文件选择“XML Configuration File” -> “Spring Config” 即可创建带有 schema 的 xml 文件</p></blockquote><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#633820>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;beans</span> <span style=color:#836c28>xmlns=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xmlns:xsi=</span><span style=color:#c41a16>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#836c28>xsi:schemaLocation=</span><span style=color:#c41a16>&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;bean</span> <span style=color:#836c28>id=</span><span style=color:#c41a16>&#34;user01&#34;</span> <span style=color:#836c28>class=</span><span style=color:#c41a16>&#34;com.chnherb.boot.bean.User&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;number&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;1001&#34;</span><span style=color:#000>&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;name&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;zhangsan&#34;</span><span style=color:#000>&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;age&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;20&#34;</span><span style=color:#000>&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/beans&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=配置绑定>配置绑定</h2><p>读取 properties 文件内容，并把它封装到 JavaBean 中。</p><p>原来的做法（代码读取文件逐步解析）：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>getProperties</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>     <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>FileNotFoundException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Properties</span> <span style=color:#000>pps</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Properties</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#000>pps</span><span style=color:#000>.</span><span style=color:#836c28>load</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>FileInputStream</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;a.properties&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Enumeration</span> <span style=color:#000>enum1</span> <span style=color:#000>=</span> <span style=color:#000>pps</span><span style=color:#000>.</span><span style=color:#836c28>propertyNames</span><span style=color:#000>();</span><span style=color:#177500>//得到配置文件的名字
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>while</span><span style=color:#000>(</span><span style=color:#000>enum1</span><span style=color:#000>.</span><span style=color:#836c28>hasMoreElements</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>             <span style=color:#000>String</span> <span style=color:#000>strKey</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>)</span> <span style=color:#000>enum1</span><span style=color:#000>.</span><span style=color:#836c28>nextElement</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>             <span style=color:#000>String</span> <span style=color:#000>strValue</span> <span style=color:#000>=</span> <span style=color:#000>pps</span><span style=color:#000>.</span><span style=color:#836c28>getProperty</span><span style=color:#000>(</span><span style=color:#000>strKey</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>             <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>strKey</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;=&#34;</span> <span style=color:#000>+</span> <span style=color:#000>strValue</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>             <span style=color:#177500>//封装到JavaBean。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>     <span style=color:#000>}</span>
</span></span><span style=display:flex><span> <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>SpringBoot 内置相关注解可自动解析配置文件。</p><blockquote><p>前提：只有容器中的组件，才能拥有 SpringBoot 提供的这些功能，所以需要配合其他注解使用，如 Component 注解等。</p></blockquote><p>使用方式有如下几种：</p><ol><li>Component等注解 + ConfigurationProperties 注解</li><li>EnableConfigurationProperties + ConfigurationProperties 注解</li></ol><h3 id=configurationproperties>ConfigurationProperties</h3><blockquote><p>Component等注解 + ConfigurationProperties 注解</p></blockquote><p>配置 application.propertites：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>mycar.brand=BYD
</span></span><span style=display:flex><span>mycar.price=200000
</span></span></code></pre></td></tr></table></div></div></div><p>Bean 中引入：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>prefix</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;mycar&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Car</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>brand</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>price</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=enableconfigurationproperties>EnableConfigurationProperties</h3><blockquote><p>EnableConfigurationProperties + ConfigurationProperties 注解</p></blockquote><p>场景：第三方包中的 Bean <strong>没有 Component 等相关注解</strong>时，需要绑定 properties。</p><p>在组件中使用 EnableConfigurationProperties 注解：</p><ol><li>开启配置绑定功能</li><li>将组件自动注入到容器中
使用方式：</li></ol><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@EnableConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>Car</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#177500>/**
</span></span></span><span style=display:flex><span><span style=color:#177500> * 1.开启 Car 配置绑定功能
</span></span></span><span style=display:flex><span><span style=color:#177500> * 2.将 Car 组件自动注入到容器中
</span></span></span><span style=display:flex><span><span style=color:#177500> */</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>xxConfig</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>Bean 文件：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>//@Component
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@ConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>prefix</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;mycar&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Car</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>brand</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>price</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=注解加载配置值>注解加载配置值</h3><p>@Value("${"xxx"}")</p><p>@ConfigurationProperties(prefix = "test")</p><p>yaml配置文件</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#1c01ce>test.name = wahaha</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>test.age = 27</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>test.tel = 18800118888</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Configuration</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@Value</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;${test.age}&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>int</span> <span style=color:#000>age</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>prefix</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;test&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Configuration</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>age</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>Long</span> <span style=color:#000>tel</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// setter getter
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=自动配置原理-1>自动配置原理</h1><h2 id=引导加载自动配置类>引导加载自动配置类</h2><p>首先看 SpringBootApplication 注解实现代码：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@SpringBootConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#000>@EnableAutoConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#000>@ComponentScan</span><span style=color:#000>(</span><span style=color:#000>excludeFilters</span> <span style=color:#000>=</span> <span style=color:#000>{</span> <span style=color:#000>@Filter</span><span style=color:#000>(</span><span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#000>FilterType</span><span style=color:#000>.</span><span style=color:#836c28>CUSTOM</span><span style=color:#000>,</span> <span style=color:#000>classes</span> <span style=color:#000>=</span> <span style=color:#000>TypeExcludeFilter</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>),</span>
</span></span><span style=display:flex><span>      <span style=color:#000>@Filter</span><span style=color:#000>(</span><span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#000>FilterType</span><span style=color:#000>.</span><span style=color:#836c28>CUSTOM</span><span style=color:#000>,</span> <span style=color:#000>classes</span> <span style=color:#000>=</span> <span style=color:#000>AutoConfigurationExcludeFilter</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span> <span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>@interface</span> <span style=color:#000>SpringBootApplication</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>核心是上面三个注解组成。</p><h3 id=springbootconfiguration>SpringBootConfiguration</h3><p>看该注解实现代码：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Target</span><span style=color:#000>(</span><span style=color:#000>ElementType</span><span style=color:#000>.</span><span style=color:#836c28>TYPE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Retention</span><span style=color:#000>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#000>.</span><span style=color:#836c28>RUNTIME</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>@interface</span> <span style=color:#000>SpringBootConfiguration</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>可以看出该注解核心就是一个 Configuration 注解，代表当前是一个配置类。</p><h3 id=componentscan>ComponentScan</h3><p>指定扫描哪些包。这里不深入解释。</p><h3 id=enableautoconfiguration>EnableAutoConfiguration</h3><p>看该注解实现代码：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Target</span><span style=color:#000>(</span><span style=color:#000>ElementType</span><span style=color:#000>.</span><span style=color:#836c28>TYPE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Retention</span><span style=color:#000>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#000>.</span><span style=color:#836c28>RUNTIME</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#000>@Inherited</span>
</span></span><span style=display:flex><span><span style=color:#000>@AutoConfigurationPackage</span>
</span></span><span style=display:flex><span><span style=color:#000>@Import</span><span style=color:#000>(</span><span style=color:#000>AutoConfigurationImportSelector</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>@interface</span> <span style=color:#000>EnableAutoConfiguration</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=autoconfigurationpackage>AutoConfigurationPackage</h4><p>自动配置包。（自动导入用户定义的组件）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Target</span><span style=color:#000>(</span><span style=color:#000>ElementType</span><span style=color:#000>.</span><span style=color:#836c28>TYPE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Retention</span><span style=color:#000>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#000>.</span><span style=color:#836c28>RUNTIME</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#000>@Inherited</span>
</span></span><span style=display:flex><span><span style=color:#000>@Import</span><span style=color:#000>(</span><span style=color:#000>AutoConfigurationPackages</span><span style=color:#000>.</span><span style=color:#836c28>Registrar</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>@interface</span> <span style=color:#000>AutoConfigurationPackage</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该注解的核心是导入 AutoConfigurationPackages.Registrar 类，而该类是利用 Register 给容器中导入一系列组件。
这里可以通过设置断点调试源码：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.AutoConfigurationPackages.Registrar#registerBeanDefinitions
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#000>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>metadata</span><span style=color:#000>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>register</span><span style=color:#000>(</span><span style=color:#000>registry</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>PackageImports</span><span style=color:#000>(</span><span style=color:#000>metadata</span><span style=color:#000>).</span><span style=color:#836c28>getPackageNames</span><span style=color:#000>().</span><span style=color:#836c28>toArray</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>String</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>]));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>metadata表示注解的原信息，这里就是指 SpringBoot 启动的 Main 类，具体是 MainApplication。
所以通过源码调试可以得出：Registrar 就是将制定的一个包下的所有组件导入（Main 所在的包）。</p><h4 id=autoconfigurationimportselector>AutoConfigurationImportSelector</h4><p>自动配置加载器。（自动导入各种自动配置器）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>//org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#selectImports
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>selectImports</span><span style=color:#000>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>annotationMetadata</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>isEnabled</span><span style=color:#000>(</span><span style=color:#000>annotationMetadata</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>NO_IMPORTS</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>AutoConfigurationEntry</span> <span style=color:#000>autoConfigurationEntry</span> <span style=color:#000>=</span> <span style=color:#000>getAutoConfigurationEntry</span><span style=color:#000>(</span><span style=color:#000>annotationMetadata</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>toStringArray</span><span style=color:#000>(</span><span style=color:#000>autoConfigurationEntry</span><span style=color:#000>.</span><span style=color:#836c28>getConfigurations</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该类利用 getAutoConfigurationEntry 方法给容器批量导入一些组件。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#getAutoConfigurationEntry
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#000>AutoConfigurationEntry</span> <span style=color:#000>getAutoConfigurationEntry</span><span style=color:#000>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>annotationMetadata</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>isEnabled</span><span style=color:#000>(</span><span style=color:#000>annotationMetadata</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>EMPTY_ENTRY</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>AnnotationAttributes</span> <span style=color:#000>attributes</span> <span style=color:#000>=</span> <span style=color:#000>getAttributes</span><span style=color:#000>(</span><span style=color:#000>annotationMetadata</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>configurations</span> <span style=color:#000>=</span> <span style=color:#000>getCandidateConfigurations</span><span style=color:#000>(</span><span style=color:#000>annotationMetadata</span><span style=color:#000>,</span> <span style=color:#000>attributes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>configurations</span> <span style=color:#000>=</span> <span style=color:#000>removeDuplicates</span><span style=color:#000>(</span><span style=color:#000>configurations</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>exclusions</span> <span style=color:#000>=</span> <span style=color:#000>getExclusions</span><span style=color:#000>(</span><span style=color:#000>annotationMetadata</span><span style=color:#000>,</span> <span style=color:#000>attributes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>checkExcludedClasses</span><span style=color:#000>(</span><span style=color:#000>configurations</span><span style=color:#000>,</span> <span style=color:#000>exclusions</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>configurations</span><span style=color:#000>.</span><span style=color:#836c28>removeAll</span><span style=color:#000>(</span><span style=color:#000>exclusions</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>configurations</span> <span style=color:#000>=</span> <span style=color:#000>getConfigurationClassFilter</span><span style=color:#000>().</span><span style=color:#836c28>filter</span><span style=color:#000>(</span><span style=color:#000>configurations</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>fireAutoConfigurationImportEvents</span><span style=color:#000>(</span><span style=color:#000>configurations</span><span style=color:#000>,</span> <span style=color:#000>exclusions</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>AutoConfigurationEntry</span><span style=color:#000>(</span><span style=color:#000>configurations</span><span style=color:#000>,</span> <span style=color:#000>exclusions</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>调用 getCandidateConfigurations 方法获取到所有需要导入到容器中的配置类。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>getCandidateConfigurations</span><span style=color:#000>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>metadata</span><span style=color:#000>,</span> <span style=color:#000>AnnotationAttributes</span> <span style=color:#000>attributes</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>configurations</span> <span style=color:#000>=</span> <span style=color:#000>SpringFactoriesLoader</span><span style=color:#000>.</span><span style=color:#836c28>loadFactoryNames</span><span style=color:#000>(</span><span style=color:#000>getSpringFactoriesLoaderFactoryClass</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>         <span style=color:#000>getBeanClassLoader</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Assert</span><span style=color:#000>.</span><span style=color:#836c28>notEmpty</span><span style=color:#000>(</span><span style=color:#000>configurations</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;No auto configuration classes found in META-INF/spring.factories. If you &#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>+</span> <span style=color:#c41a16>&#34;are using a custom packaging, make sure that file is correct.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>configurations</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>利用Spring工厂加载器加载得到所有的组件。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>loadFactoryNames</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>factoryType</span><span style=color:#000>,</span> <span style=color:#000>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>String</span> <span style=color:#000>factoryTypeName</span> <span style=color:#000>=</span> <span style=color:#000>factoryType</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>loadSpringFactories</span><span style=color:#000>(</span><span style=color:#000>classLoader</span><span style=color:#000>).</span><span style=color:#836c28>getOrDefault</span><span style=color:#000>(</span><span style=color:#000>factoryTypeName</span><span style=color:#000>,</span> <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>emptyList</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;&gt;</span> <span style=color:#000>loadSpringFactories</span><span style=color:#000>(</span><span style=color:#000>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>MultiValueMap</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>cache</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>result</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>result</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Enumeration</span><span style=color:#000>&lt;</span><span style=color:#000>URL</span><span style=color:#000>&gt;</span> <span style=color:#000>urls</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>classLoader</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// FACTORIES_RESOURCE_LOCATION = &#34;META-INF/spring.factories&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>classLoader</span><span style=color:#000>.</span><span style=color:#836c28>getResources</span><span style=color:#000>(</span><span style=color:#000>FACTORIES_RESOURCE_LOCATION</span><span style=color:#000>)</span> <span style=color:#000>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ClassLoader</span><span style=color:#000>.</span><span style=color:#836c28>getSystemResources</span><span style=color:#000>(</span><span style=color:#000>FACTORIES_RESOURCE_LOCATION</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedMultiValueMap</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>while</span> <span style=color:#000>(</span><span style=color:#000>urls</span><span style=color:#000>.</span><span style=color:#836c28>hasMoreElements</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#000>=</span> <span style=color:#000>urls</span><span style=color:#000>.</span><span style=color:#836c28>nextElement</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#000>UrlResource</span> <span style=color:#000>resource</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>UrlResource</span><span style=color:#000>(</span><span style=color:#000>url</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Properties</span> <span style=color:#000>properties</span> <span style=color:#000>=</span> <span style=color:#000>PropertiesLoaderUtils</span><span style=color:#000>.</span><span style=color:#836c28>loadProperties</span><span style=color:#000>(</span><span style=color:#000>resource</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>Map</span><span style=color:#000>.</span><span style=color:#836c28>Entry</span><span style=color:#000>&lt;?,</span> <span style=color:#000>?&gt;</span> <span style=color:#000>entry</span> <span style=color:#000>:</span> <span style=color:#000>properties</span><span style=color:#000>.</span><span style=color:#836c28>entrySet</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>factoryTypeName</span> <span style=color:#000>=</span> <span style=color:#000>((</span><span style=color:#000>String</span><span style=color:#000>)</span> <span style=color:#000>entry</span><span style=color:#000>.</span><span style=color:#836c28>getKey</span><span style=color:#000>()).</span><span style=color:#836c28>trim</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>factoryImplementationName</span> <span style=color:#000>:</span> <span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>commaDelimitedListToStringArray</span><span style=color:#000>((</span><span style=color:#000>String</span><span style=color:#000>)</span> <span style=color:#000>entry</span><span style=color:#000>.</span><span style=color:#836c28>getValue</span><span style=color:#000>()))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>result</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>factoryTypeName</span><span style=color:#000>,</span> <span style=color:#000>factoryImplementationName</span><span style=color:#000>.</span><span style=color:#836c28>trim</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>cache</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>classLoader</span><span style=color:#000>,</span> <span style=color:#000>result</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>result</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Unable to load factories from location [&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>            <span style=color:#000>FACTORIES_RESOURCE_LOCATION</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;]&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>从 META-INF/spring.factories 位置加载一个文件，默认扫描所有依赖包中该位置的文件。核心包：spring-boot-autoconfigure-2.3.0.RELEASE.jar，该包中包括所有自动配置的类（Auto Configure 类127个）。即该文件写死了 SpringBoot 启动需要给容器中加载的所有配置类。</p><h2 id=按需开启自动配置项>按需开启自动配置项</h2><p>虽然上面讲的 127 个场景的所有自动配置（<strong>xxxAutoConfiguration</strong>）启动时默认全部加载，但是按照条件装配规则（Conditional 注解），最终会按需配置。</p><p>比如 AopAutoConfiguration 类，仅当导入 aspectj 下面的 Advice 类才会配置。</p><h2 id=修改默认配置>修改默认配置</h2><p>举例（文件上传解析器）：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration.DispatcherServletConfiguration#multipartResolver
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnBean</span><span style=color:#000>(</span><span style=color:#000>MultipartResolver</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span> <span style=color:#177500>// 容器中有这个类型的组件
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@ConditionalOnMissingBean</span><span style=color:#000>(</span><span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>DispatcherServlet</span><span style=color:#000>.</span><span style=color:#836c28>MULTIPART_RESOLVER_BEAN_NAME</span><span style=color:#000>)</span> 
</span></span><span style=display:flex><span><span style=color:#177500>// 容器中没有 multipartResolver 这个名字的组件
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>MultipartResolver</span> <span style=color:#000>multipartResolver</span><span style=color:#000>(</span><span style=color:#000>MultipartResolver</span> <span style=color:#000>resolver</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Detect if the user has created a MultipartResolver but named it incorrectly
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 检测用户配置的文件上传解析器但名字不规范的情况。从容器中找该类型组件，并返回(改名)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>return</span> <span style=color:#000>resolver</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>SpringBoot 默认会在底层代码中配置好所有的组件，如果用户配置过了以用户的优先，不会加载默认配置的（ConditionalOnMissingBean）。</p><p>总结：</p><ul><li>SpringBoot 先加载所有的自动配置类（xxxAutoConfiguration）</li><li>每个自动配置类按照条件进行生效，默认绑定配置文件的值（xxxProperties绑定配置文件）</li><li>生效的配置会给容器中装配很多组件</li><li>容器中存在这些组件即代表相应功能存在</li><li>定制化配置<ul><li>优先使用用户创建的 Bean</li><li>修改组件配置文件的值
流程：</li></ul></li></ul><p>xxxAutoConfiguration -> 组件 -> xxxProperties -> application.properties</p><h2 id=最佳实践>最佳实践</h2><ul><li>引入场景依赖，参考 <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters>Using Spring Boot # starters</a></li><li>查看自动配置项<ul><li>一般引入的场景都自动配置了</li><li>application.properties 中配置 debug=true开启自动配置报告。Negative（不生效）、Positive（生效）</li></ul></li><li>自定义修改<ul><li>参考文档修改配置项<ul><li><a href=https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#common-application-properties>Application Properties</a></li><li>参考源码：xxxProperties</li></ul></li><li>自定义配置 Bean，使用 Bean/Component 等注解</li><li>自定义器：xxxCustomizer</li><li>...</li></ul></li></ul><h1 id=配置文件>配置文件</h1><h2 id=配置文件及提示>配置文件及提示</h2><h3 id=properties配置文件>properties配置文件</h3><p>同之前的 properties 配置文件用法</p><h3 id=yaml配置文件>yaml配置文件</h3><p>语法不太一样</p><h3 id=配置提示>配置提示</h3><p>文件路径： <a href=https://spring.io/projects/spring-boot#learn>learn</a>（SpringBoot 主页面） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/>Documentation</a> （各类文档，<strong>重点</strong>） -></p><p><a href=https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html#appendix.configuration-metadata.annotation-processor.configuring>Configuration Metadata # Configuring the Annotation Processor</a></p><p>增加配置文件的提示功能：</p><p>1、导入依赖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-configuration-processor<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;optional&gt;</span>true<span style=color:#000>&lt;/optional&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、重新启动程序或 maven 重新导包
3、打包时过滤该包</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;excludes&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;exclude&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-configuration-processor<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;/exclude&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/excludes&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/plugin&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=配置文件路径及优先级>配置文件路径及优先级</h2><h3 id=四个配置路径>四个配置路径</h3><ul><li>当前项目根目录下的 config 目录下</li><li>当前项目的根目录下</li><li>resources 目录下的 config 目录下</li><li>resources 目录下
<strong>优先级从高到底</strong></li></ul><p><img src=../imgs/spring-boot-01-220918_3.png alt=spring-boot-01-220918_3.png></p><h3 id=自定义配置路径>自定义配置路径</h3><p>另外我们也可以在启动项目的时候，指定配置文件的位置，这个的操作主要针对于已经打包好的项目，无法修改配置文件了</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>java -jar demo.jar --spring.config.location=classpath:/myconfig/
</span></span></code></pre></td></tr></table></div></div></div><h3 id=自定义配置文件名称>自定义配置文件名称</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -jar demo.jar --spring.config.name<span style=color:#000>=</span>myconfig
</span></span></code></pre></td></tr></table></div></div></div><p>多条命令<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -jar demo.jar --spring,config.name<span style=color:#000>=</span>myconfig;spring.config.location<span style=color:#000>=</span>classpath:/myconfig/
</span></span></code></pre></td></tr></table></div></div></div></p><blockquote><p>参考：<a href=https://m.yisu.com/zixun/14159.html>https://m.yisu.com/zixun/14159.html</a></p></blockquote><h2 id=多模块使用对应配置文件>多模块使用对应配置文件</h2><p>配置文件：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>spring.profiles</span>: <span style=color:#1c01ce>common-boei18n </span> <span style=color:#177500># 指定环境</span>
</span></span></code></pre></td></tr></table></div></div></div><p>激活环境：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 1.命令行添加参数</span>
</span></span><span style=display:flex><span>-Dspring.profiles.active<span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>PROFILE</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#177500># 2.application.properties配置激活</span>
</span></span><span style=display:flex><span>spring.profiles.active<span style=color:#000>=</span>corePro,webPro
</span></span></code></pre></td></tr></table></div></div></div></p><p>其他 module 的 yml 需要读取公共 module 的 yml，那么需要在其他 module 的 yml 配置:<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>profiles</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>include</span>: <span style=color:#1c01ce>utils</span>
</span></span></code></pre></td></tr></table></div></div></div></p><blockquote><p>参考：
<a href=https://blog.csdn.net/cw_hello1/article/details/79639448>https://blog.csdn.net/cw_hello1/article/details/79639448</a>
<a href=https://blog.csdn.net/xue_mind/article/details/106494732>https://blog.csdn.net/xue_mind/article/details/106494732</a></p></blockquote><h2 id=yml依赖>yml依赖</h2><p>使用外部yml文件的两种方法。</p><blockquote><p>参考：<a href=https://blog.csdn.net/Lonely_Devil/article/details/81875890>https://blog.csdn.net/Lonely_Devil/article/details/81875890</a></p></blockquote><h2 id=application-yml与bootstrap-yml的区别>application.yml与bootstrap.yml的区别</h2><blockquote><p>参考：<a href=https://www.jianshu.com/p/c955c44ae534>https://www.jianshu.com/p/c955c44ae534</a></p></blockquote><h1 id=开发小技巧>开发小技巧</h1><h2 id=lombok>Lombok</h2><p>简化开发：</p><ul><li>简化 JavaBean 开发</li><li>简化 log 开发（Slf4j 注解）
引入 pom 依赖：</li></ul><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>        &lt;dependency&gt;
</span></span><span style=display:flex><span>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
</span></span><span style=display:flex><span>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
</span></span><span style=display:flex><span>        &lt;/dependency&gt;
</span></span></code></pre></td></tr></table></div></div></div><p>IDEA 中搜索安装 lombok 插件即可。</p><h2 id=dev-tools>dev-tools</h2><p>热更新开发工具。</p><p>引入 pom 依赖：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>        &lt;dependency&gt;
</span></span><span style=display:flex><span>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style=display:flex><span>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
</span></span><span style=display:flex><span>            &lt;optional&gt;true&lt;/optional&gt;
</span></span><span style=display:flex><span>        &lt;/dependency&gt;
</span></span></code></pre></td></tr></table></div></div></div><p>项目或者页面修改以后：Ctrl+F9；</p><h1 id=reference>Reference</h1><p><a href=https://github.com/chnherb/spring-boot-demo>spring-boot-demo</a></p><p><a href=https://github.com/javastacks/spring-boot-best-practice>https://github.com/javastacks/spring-boot-best-practice</a></p><p>加载配置文件源码：</p><p><a href=https://blog.csdn.net/chengkui1990/article/details/79866499>https://blog.csdn.net/chengkui1990/article/details/79866499</a></p><p><a href=https://juejin.cn/post/6844903985913004045>https://juejin.cn/post/6844903985913004045</a></p><p><a href=https://blog.csdn.net/q610376681/article/details/88578155>Spring自动注入原理初解与实现</a></p><p><a href=https://mp.weixin.qq.com/s/R6Ps4hgmNniC_Zw8v1F6FA>自己动手写一个 starter</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5f11e8e5c91cb55111c867fbba4c2de2>8 - SpringBoot-02Web开发及请求响应处理</h1><h1 id=简介>简介</h1><p>Spring Boot is well suited for web application development. You can create a self-contained HTTP server by using embedded Tomcat, Jetty, Undertow, or Netty. Most web applications use the <code>spring-boot-starter-web</code> module to get up and running quickly. You can also choose to build reactive web applications by using the <code>spring-boot-starter-webflux</code> module.</p><p>文档路径：文档路径： <a href=https://spring.io/projects/spring-boot#learn>learn</a>（SpringBoot 主页面） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/>Documentation</a> （各类文档，<strong>重点</strong>） -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc>Web</a></p><h1 id=springmvc自动配置简介>SpringMVC自动配置简介</h1><p>SpringBoot 为 SpringMVC 提供了大多数场景的自动配置，这些自动配置添加了如下 Spring 的默认特性：</p><ul><li>包括 <code>ContentNegotiatingViewResolver</code> (内容协商视图解析器)和 <code>BeanNameViewResolver</code> (BeanName视图解析器) 等 bean</li><li>支持静态资源包括 WebJars (covered <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.static-content>later in this document</a>)</li><li>自动注册<code>Converter</code>、<code>GenericConverter</code>和<code>Formatter</code> 等 bean</li><li>支持 <code>HttpMessageConverters</code> (covered <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.message-converters>later in this document</a>)</li><li>自动注册<code>MessageCodesResolver</code> (国际化使用)(covered <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.message-codes>later in this document</a>)</li><li>静态 <code>index.html</code> 支持</li><li>自定义 Favicon</li><li>自动使用 <code>ConfigurableWebBindingInitializer</code> bean (DataBind 负责将请求数据绑定到 JavaBean ) (covered <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.binding-initializer>later in this document</a>)
自定义 <a href=https://docs.spring.io/spring-framework/docs/5.3.23/reference/html/web.html#mvc>MVC customizations</a> (interceptors, formatters, view controllers, and other features)，可以通过添加 <code>WebMvcConfigurer</code> 类型的 <code>@Configuration</code> 而不是<code>@EnableWebMvc</code></li></ul><p>如果提供自定义的</p><p><code>RequestMappingHandlerMapping</code>, <code>RequestMappingHandlerAdapter</code>, 或 <code>ExceptionHandlerExceptionResolver</code>, 并定制化Spring Boot MVC，可以声明 <code>WebMvcRegistrations</code> 类型的 bean 并使用其提供这些自定义组件的实例。</p><p>完全接管 SpringMVC，可以添加<code>@Configuration</code> 和 <code>@EnableWebMvc</code>注解或另外添加 <code>@Configuration</code> 和<code>DelegatingWebMvcConfiguration</code> 。</p><h1 id=基础功能介绍>基础功能介绍</h1><h2 id=静态资源访问>静态资源访问</h2><p>文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.static-content>spring-mvc # static-content</a></p><h3 id=静态资源目录>静态资源目录</h3><p>只要静态资源放在类路径的 resources 下：<code>/static</code> 或<code>/public</code> 或 <code>/resources</code> 或 <code>/META-INF/resources</code>中即可。</p><p>访问方式：当前项目 + 根路径/ + 静态资源名称（无需增加目录名）</p><p>原理：静态资源映射 /**，请求到达先查找 controller ，不能匹配然后交给静态资源处理器，没找到就 404。</p><h3 id=静态资源前缀>静态资源前缀</h3><p>一般配置静态资源带有前缀，为了方便做权限控制。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>mvc</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>static-path-pattern</span>: <span style=color:#1c01ce>/res/** </span> <span style=color:#177500># 默认 /**</span>
</span></span></code></pre></td></tr></table></div></div></div><p>访问方式：当前项目 + static-path-pattern + 静态资源名称</p><h3 id=静态资源路径>静态资源路径</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>static-locations</span>: [<span style=color:#1c01ce>classpath:/abc]</span> <span style=color:#177500># 表示 resources 下的 abc 文件夹</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=webjars>webjars</h3><p>自动映射 /<a href=http://localhost:8080/webjars/jquery/3.5.1/jquery.js>webjars</a>/**</p><p><a href=https://www.webjars.org/>https://www.webjars.org/</a></p><p>引入依赖：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.webjars<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>jquery<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>3.5.1<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>访问方式：当前项目 + /webjars/jquery/3.5.1/jquery.js （即依赖包的内容路径，可直接查看）</p><h2 id=欢迎页>欢迎页</h2><ul><li>静态资源路径下<ul><li>可以配置静态资源路径</li><li>不能配置静态资源前缀</li></ul></li></ul><h2 id=自定义favicon>自定义Favicon</h2><p>favicon.ico 放在静态资源目录下即可。</p><p>配置静态资源前缀会影响该功能。</p><h2 id=静态资源配置原理>静态资源配置原理</h2><p>上文讲过 SpringBoot 启动时会默认加载 xxxAutoConfiguration类（自动配置类），如 spring-boot-autoconfigure jar 包中的自动配置类，这里 web 启动会加载其中的 web 包中的相关配置类，如加载 WebMvcAutoConfiguration</p><p>具体配置项：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration.WebMvcAutoConfigurationAdapter
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Configuration</span><span style=color:#000>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@Import</span><span style=color:#000>(</span><span style=color:#000>EnableWebMvcConfiguration</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@EnableConfigurationProperties</span><span style=color:#000>({</span> <span style=color:#000>WebMvcProperties</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>ResourceProperties</span><span style=color:#000>.</span><span style=color:#836c28>class</span> <span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#000>@Order</span><span style=color:#000>(</span><span style=color:#000>0</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>WebMvcAutoConfigurationAdapter</span> <span style=color:#a90d91>implements</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意 EnableConfigurationProperties 注解，配置文件的相关属性 WebMvcProperties（spring.mvc）、ResourceProperties（spring.resources）。
配置类只有一个有参构造器</p><blockquote><p>注意这里 jar 版本 2.3.0-RELEASE 没有最后两个参数，升级到 2.3.7-RELEASE 即可。</p></blockquote><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 有参构造器的所有参数值都会从容器中获取
</span></span></span><span style=display:flex><span><span style=color:#177500>// ResourceProperties resourceProperties 获取和 spring.resources 绑定的所有值的对象
</span></span></span><span style=display:flex><span><span style=color:#177500>// WebMvcProperties mvcProperties 获取和 spring.mvc 绑定的所有值的对象
</span></span></span><span style=display:flex><span><span style=color:#177500>// ListableBeanFactory beanFactory spring 的 beanFactory
</span></span></span><span style=display:flex><span><span style=color:#177500>// messageConvertersProvider 找到所有的 HttpMessageConverters
</span></span></span><span style=display:flex><span><span style=color:#177500>// resourceHandlerRegistrationCustomizerProvider 找到资源处理器的自定义器
</span></span></span><span style=display:flex><span><span style=color:#177500>// dispatcherServletPath dispatcherServlet 处理路径
</span></span></span><span style=display:flex><span><span style=color:#177500>// servletRegistrations 给应用注册 Servlet、Fileter、Listener 等
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>WebMvcAutoConfigurationAdapter</span><span style=color:#000>(</span><span style=color:#000>ResourceProperties</span> <span style=color:#000>resourceProperties</span><span style=color:#000>,</span> <span style=color:#000>WebMvcProperties</span> <span style=color:#000>mvcProperties</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#000>,</span> <span style=color:#000>ObjectProvider</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverters</span><span style=color:#000>&gt;</span> <span style=color:#000>messageConvertersProvider</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ObjectProvider</span><span style=color:#000>&lt;</span><span style=color:#000>ResourceHandlerRegistrationCustomizer</span><span style=color:#000>&gt;</span> <span style=color:#000>resourceHandlerRegistrationCustomizerProvider</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ObjectProvider</span><span style=color:#000>&lt;</span><span style=color:#000>DispatcherServletPath</span><span style=color:#000>&gt;</span> <span style=color:#000>dispatcherServletPath</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ObjectProvider</span><span style=color:#000>&lt;</span><span style=color:#000>ServletRegistrationBean</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>servletRegistrations</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceProperties</span> <span style=color:#000>=</span> <span style=color:#000>resourceProperties</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>mvcProperties</span> <span style=color:#000>=</span> <span style=color:#000>mvcProperties</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>beanFactory</span> <span style=color:#000>=</span> <span style=color:#000>beanFactory</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConvertersProvider</span> <span style=color:#000>=</span> <span style=color:#000>messageConvertersProvider</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceHandlerRegistrationCustomizer</span> <span style=color:#000>=</span> <span style=color:#000>resourceHandlerRegistrationCustomizerProvider</span><span style=color:#000>.</span><span style=color:#836c28>getIfAvailable</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>dispatcherServletPath</span> <span style=color:#000>=</span> <span style=color:#000>dispatcherServletPath</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>servletRegistrations</span> <span style=color:#000>=</span> <span style=color:#000>servletRegistrations</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=资源处理默认规则>资源处理默认规则</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>addResourceHandlers</span><span style=color:#000>(</span><span style=color:#000>ResourceHandlerRegistry</span> <span style=color:#000>registry</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 是否禁用 properties 映射
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceProperties</span><span style=color:#000>.</span><span style=color:#836c28>isAddMappings</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Default resource handling disabled&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 缓存时间
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Duration</span> <span style=color:#000>cachePeriod</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceProperties</span><span style=color:#000>.</span><span style=color:#836c28>getCache</span><span style=color:#000>().</span><span style=color:#836c28>getPeriod</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>CacheControl</span> <span style=color:#000>cacheControl</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceProperties</span><span style=color:#000>.</span><span style=color:#836c28>getCache</span><span style=color:#000>().</span><span style=color:#836c28>getCachecontrol</span><span style=color:#000>().</span><span style=color:#836c28>toHttpCacheControl</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// webjars 规则
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>hasMappingForPattern</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/webjars/**&#34;</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>customizeResourceHandlerRegistration</span><span style=color:#000>(</span><span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>addResourceHandler</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/webjars/**&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>.</span><span style=color:#836c28>addResourceLocations</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;classpath:/META-INF/resources/webjars/&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 如果设置了缓存时间，可以观察浏览器请求为 304，并带有过期时间
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>.</span><span style=color:#836c28>setCachePeriod</span><span style=color:#000>(</span><span style=color:#000>getSeconds</span><span style=color:#000>(</span><span style=color:#000>cachePeriod</span><span style=color:#000>)).</span><span style=color:#836c28>setCacheControl</span><span style=color:#000>(</span><span style=color:#000>cacheControl</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 静态资源路径规则
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>String</span> <span style=color:#000>staticPathPattern</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>mvcProperties</span><span style=color:#000>.</span><span style=color:#836c28>getStaticPathPattern</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>hasMappingForPattern</span><span style=color:#000>(</span><span style=color:#000>staticPathPattern</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>customizeResourceHandlerRegistration</span><span style=color:#000>(</span><span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>addResourceHandler</span><span style=color:#000>(</span><span style=color:#000>staticPathPattern</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>.</span><span style=color:#836c28>addResourceLocations</span><span style=color:#000>(</span><span style=color:#000>getResourceLocations</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceProperties</span><span style=color:#000>.</span><span style=color:#836c28>getStaticLocations</span><span style=color:#000>()))</span>
</span></span><span style=display:flex><span>            <span style=color:#000>.</span><span style=color:#836c28>setCachePeriod</span><span style=color:#000>(</span><span style=color:#000>getSeconds</span><span style=color:#000>(</span><span style=color:#000>cachePeriod</span><span style=color:#000>)).</span><span style=color:#836c28>setCacheControl</span><span style=color:#000>(</span><span style=color:#000>cacheControl</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=欢迎页处理规则>欢迎页处理规则</h3><p>HandlerMapping：处理器映射，保存了每一个 Handler 能处理的请求。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>WelcomePageHandlerMapping</span> <span style=color:#000>welcomePageHandlerMapping</span><span style=color:#000>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>FormattingConversionService</span> <span style=color:#000>mvcConversionService</span><span style=color:#000>,</span> <span style=color:#000>ResourceUrlProvider</span> <span style=color:#000>mvcResourceUrlProvider</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>WelcomePageHandlerMapping</span> <span style=color:#000>welcomePageHandlerMapping</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>WelcomePageHandlerMapping</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>new</span> <span style=color:#000>TemplateAvailabilityProviders</span><span style=color:#000>(</span><span style=color:#000>applicationContext</span><span style=color:#000>),</span> <span style=color:#000>applicationContext</span><span style=color:#000>,</span> <span style=color:#000>getWelcomePage</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>mvcProperties</span><span style=color:#000>.</span><span style=color:#836c28>getStaticPathPattern</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>welcomePageHandlerMapping</span><span style=color:#000>.</span><span style=color:#836c28>setInterceptors</span><span style=color:#000>(</span><span style=color:#000>getInterceptors</span><span style=color:#000>(</span><span style=color:#000>mvcConversionService</span><span style=color:#000>,</span> <span style=color:#000>mvcResourceUrlProvider</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>welcomePageHandlerMapping</span><span style=color:#000>.</span><span style=color:#836c28>setCorsConfigurations</span><span style=color:#000>(</span><span style=color:#000>getCorsConfigurations</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>welcomePageHandlerMapping</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>WelcomePageHandlerMapping</span><span style=color:#000>(</span><span style=color:#000>TemplateAvailabilityProviders</span> <span style=color:#000>templateAvailabilityProviders</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#000>,</span> <span style=color:#000>Optional</span><span style=color:#000>&lt;</span><span style=color:#000>Resource</span><span style=color:#000>&gt;</span> <span style=color:#000>welcomePage</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>staticPathPattern</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 必须使用 /** 才能使用欢迎页
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>welcomePage</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>()</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#c41a16>&#34;/**&#34;</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#000>staticPathPattern</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Adding welcome page: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>welcomePage</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>      <span style=color:#000>setRootViewName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;forward:index.html&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 调用 Controller 处理 /index
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>welcomeTemplateExists</span><span style=color:#000>(</span><span style=color:#000>templateAvailabilityProviders</span><span style=color:#000>,</span> <span style=color:#000>applicationContext</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Adding welcome page template: index&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>setRootViewName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;index&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=请求参数处理>请求参数处理</h1><h2 id=请求映射>请求映射</h2><p>@xxxMapping 如 RequestMapping 注解</p><p>Rest 风格支持（使用 HTTP 请求方式来表示对资源的操作）。</p><p>核心 Filter：HiddenHttpMethodFilter。</p><p>用法：表单 method=post，隐藏域 _method=put</p><h3 id=rest使用>Rest使用</h3><p>Rest 接口：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 测试 REST
</span></span></span><span style=display:flex><span><span style=color:#177500>// @RequestMapping(value = &#34;/user&#34;, method = RequestMethod.GET)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@GetMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/user&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>getUser</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;GET-USER&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#177500>// @RequestMapping(value = &#34;/user&#34;, method = RequestMethod.POST)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@PostMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/user&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>saveUser</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;POST-USER&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#177500>// @RequestMapping(value = &#34;/user&#34;, method = RequestMethod.PUT)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@PutMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/user&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>updateUser</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;PUT-USER&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#177500>// @RequestMapping(value = &#34;/user&#34;, method = RequestMethod.DELETE)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@DeleteMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/user&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>delUser</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;DELETE-USER&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>HTML 访问页面：<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>测试 REST：
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/user&#34;</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;get&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;REST-GET SUBMIT&#34;</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/user&#34;</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;post&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;REST-POST SUBMIT&#34;</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span><span style=display:flex><span>无效：
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/user&#34;</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;put&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;REST-PUT SUBMIT&#34;</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/user&#34;</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;delete&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;REST-DELETE SUBMIT&#34;</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span><span style=display:flex><span>有效：
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/user&#34;</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;post&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;_method&#34;</span><span style=color:#000>,</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;hidden&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;PUT&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;REST-PUT SUBMIT&#34;</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/user&#34;</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;post&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;_method&#34;</span><span style=color:#000>,</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;hidden&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;DELETE&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;REST-DELETE SUBMIT&#34;</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>手动开启：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>mvc</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>hiddenmethod</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>filter</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=rest原理>Rest原理</h3><p>背景知识：</p><p>HTML4 / XHTML1 仅允许以表格形式进行 GET 和 POST 请求。<code>&lt;form method="put"></code>是无效的HTML，将被视为<code>&lt;form></code> ，即发送一个GET请求。</p><p>为了解决这个问题，SpringBoot 做了一些适配功能，步骤如下：</p><ul><li>表单提交会带上 _method=PUT</li><li>接受请求被 HiddenHttpMethodFilter 拦截<ul><li>请求是否正常且是 POST 方式<ul><li>获取到 _method 的值</li><li>允许的请求方式：PUT/DELETE/PATCH</li><li>原生 request（post），包装模式 requestWarpper 重写 getMethod 方式</li><li>过滤器链放行使用的是 warpper 对象
注意：<strong>如果是使用 Rest 客户端工具，直接发送 Put、delete 等请求，无需配置 filter。</strong></li></ul></li></ul></li></ul><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnMissingBean</span><span style=color:#000>(</span><span style=color:#000>HiddenHttpMethodFilter</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnProperty</span><span style=color:#000>(</span><span style=color:#000>prefix</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;spring.mvc.hiddenmethod.filter&#34;</span><span style=color:#000>,</span> <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;enabled&#34;</span><span style=color:#000>,</span> <span style=color:#000>matchIfMissing</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>OrderedHiddenHttpMethodFilter</span> <span style=color:#000>hiddenHttpMethodFilter</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>OrderedHiddenHttpMethodFilter</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该类继承了 HiddenHttpMethodFilter 类<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>OrderedHiddenHttpMethodFilter</span> <span style=color:#a90d91>extends</span> <span style=color:#000>HiddenHttpMethodFilter</span> <span style=color:#a90d91>implements</span> <span style=color:#000>OrderedFilter</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>核心逻辑：HiddenHttpMethodFilter 的 doFilterInternal 方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.filter.HiddenHttpMethodFilter#doFilterInternal
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>doFilterInternal</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>FilterChain</span> <span style=color:#000>filterChain</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>ServletException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HttpServletRequest</span> <span style=color:#000>requestToUse</span> <span style=color:#000>=</span> <span style=color:#000>request</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#c41a16>&#34;POST&#34;</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getMethod</span><span style=color:#000>())</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getAttribute</span><span style=color:#000>(</span><span style=color:#000>WebUtils</span><span style=color:#000>.</span><span style=color:#836c28>ERROR_EXCEPTION_ATTRIBUTE</span><span style=color:#000>)</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>String</span> <span style=color:#000>paramValue</span> <span style=color:#000>=</span> <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getParameter</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>methodParam</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>hasLength</span><span style=color:#000>(</span><span style=color:#000>paramValue</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>String</span> <span style=color:#000>method</span> <span style=color:#000>=</span> <span style=color:#000>paramValue</span><span style=color:#000>.</span><span style=color:#836c28>toUpperCase</span><span style=color:#000>(</span><span style=color:#000>Locale</span><span style=color:#000>.</span><span style=color:#836c28>ENGLISH</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>ALLOWED_METHODS</span><span style=color:#000>.</span><span style=color:#836c28>contains</span><span style=color:#000>(</span><span style=color:#000>method</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>requestToUse</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HttpMethodRequestWrapper</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>method</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>filterChain</span><span style=color:#000>.</span><span style=color:#836c28>doFilter</span><span style=color:#000>(</span><span style=color:#000>requestToUse</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>request 请求被包装成 HttpMethodRequestWrapper（继承了 HttpServletRequest），替换了新的 method。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>HttpMethodRequestWrapper</span> <span style=color:#a90d91>extends</span> <span style=color:#000>HttpServletRequestWrapper</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>method</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>public</span> <span style=color:#000>HttpMethodRequestWrapper</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>method</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>method</span> <span style=color:#000>=</span> <span style=color:#000>method</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>自定义 rest methodParam</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#177500>// 自定义修改 rest methodParam
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>HiddenHttpMethodFilter</span> <span style=color:#000>hiddenHttpMethodFilter</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>HiddenHttpMethodFilter</span> <span style=color:#000>methodFilter</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HiddenHttpMethodFilter</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>methodFilter</span><span style=color:#000>.</span><span style=color:#836c28>setMethodParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;_method&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        methodFilter.setMethodParam(&#34;_m&#34;);
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>return</span> <span style=color:#000>methodFilter</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=请求映射原理>请求映射原理</h2><p>类的继承关系（快捷键：ctrl + H）</p><p>DispatcherServlet：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>DispatcherServlet</span> <span style=color:#a90d91>extends</span> <span style=color:#000>FrameworkServlet</span> <span style=color:#000>{}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>abstract</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>FrameworkServlet</span> <span style=color:#a90d91>extends</span> <span style=color:#000>HttpServletBean</span> <span style=color:#a90d91>implements</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#000>{}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>abstract</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>HttpServletBean</span> <span style=color:#a90d91>extends</span> <span style=color:#000>HttpServlet</span> <span style=color:#a90d91>implements</span> <span style=color:#000>EnvironmentCapable</span><span style=color:#000>,</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=../imgs/spring-boot-02-220925_1.png alt=spring-boot-02-220925_1.png></p><p>方法的调用关系：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>HttpServlet</span><span style=color:#000>.</span><span style=color:#836c28>doGet</span>
</span></span><span style=display:flex><span>  <span style=color:#000>HttpServletBean</span>
</span></span><span style=display:flex><span>    <span style=color:#000>FrameworkServlet</span><span style=color:#000>.</span><span style=color:#836c28>processRequest</span> <span style=color:#000>-&gt;</span> <span style=color:#000>doService</span>
</span></span><span style=display:flex><span>      <span style=color:#000>DispatchServlet</span><span style=color:#000>.</span><span style=color:#836c28>doService</span> <span style=color:#000>-&gt;</span> <span style=color:#000>doDispatch</span>
</span></span></code></pre></td></tr></table></div></div></div><p>核心方法：doDispatch（可断点查看）<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#doDispatch
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>doDispatch</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HttpServletRequest</span> <span style=color:#000>processedRequest</span> <span style=color:#000>=</span> <span style=color:#000>request</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HandlerExecutionChain</span> <span style=color:#000>mappedHandler</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>boolean</span> <span style=color:#000>multipartRequestParsed</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>WebAsyncManager</span> <span style=color:#000>asyncManager</span> <span style=color:#000>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#000>.</span><span style=color:#836c28>getAsyncManager</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ModelAndView</span> <span style=color:#000>mv</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Exception</span> <span style=color:#000>dispatchException</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 检查文件上传请求
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>processedRequest</span> <span style=color:#000>=</span> <span style=color:#000>checkMultipart</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>multipartRequestParsed</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>processedRequest</span> <span style=color:#000>!=</span> <span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Determine handler for the current request.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// 找到当前请求处理的 handler
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>mappedHandler</span> <span style=color:#000>=</span> <span style=color:#000>getHandler</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mappedHandler</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>noHandlerFound</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Determine handler adapter for the current request.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// handler 适配器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>HandlerAdapter</span> <span style=color:#000>ha</span> <span style=color:#000>=</span> <span style=color:#000>getHandlerAdapter</span><span style=color:#000>(</span><span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>getHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Process last-modified header, if supported by the handler.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>String</span> <span style=color:#000>method</span> <span style=color:#000>=</span> <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getMethod</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>boolean</span> <span style=color:#000>isGet</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;GET&#34;</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#000>method</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>isGet</span> <span style=color:#000>||</span> <span style=color:#c41a16>&#34;HEAD&#34;</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#000>method</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>long</span> <span style=color:#000>lastModified</span> <span style=color:#000>=</span> <span style=color:#000>ha</span><span style=color:#000>.</span><span style=color:#836c28>getLastModified</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>getHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ServletWebRequest</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>).</span><span style=color:#836c28>checkNotModified</span><span style=color:#000>(</span><span style=color:#000>lastModified</span><span style=color:#000>)</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>isGet</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>applyPreHandle</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Actually invoke the handler.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>mv</span> <span style=color:#000>=</span> <span style=color:#000>ha</span><span style=color:#000>.</span><span style=color:#836c28>handle</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>getHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>asyncManager</span><span style=color:#000>.</span><span style=color:#836c28>isConcurrentHandlingStarted</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>applyDefaultViewName</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>mv</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>applyPostHandle</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>mv</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>其中 HandleMapping 包含 5 个
<img src=../imgs/spring-boot-02-220925_2.png alt=spring-boot-02-220925_2.png></p><p>RequestMappingHandlerMapping：保存了所有 @RequestMapping 和 handler 的映射规则。其 mappingRegistry.registry 保存了 RequestMapping 所有的路径匹配信息。</p><p>小结：</p><p>所有请求映射都在HandlerMapping 中：</p><ul><li>SpingBoot 自动配置了欢迎页的 HandlerMapping，访问 / 能访问到 index.html</li><li>处理请求时会遍历所有的 HanlderMapping 匹配请求信息<ul><li>匹配上则返回该 HanlderMapping 的 handler</li><li>没有匹配上则继续遍历下一个 HandlerMapping</li></ul></li><li>自定义映射处理时，往容器中注入 HandlerMapping 即可，即自定义 HanlderMapping</li></ul><h2 id=常用参数注解>常用参数注解</h2><h3 id=注解>注解</h3><p>@PathVariable、@RequestHeader、@ModelAttribute、@RequestParam、@MatrixVariable、@CookieValue、@RequestBody</p><p>测试 demo：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.chnherb.boot.controller</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.springframework.web.bind.annotation.*</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.servlet.http.Cookie</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.HashMap</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.List</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.Map</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ParameterController</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 请求：/user/1001/name/zhangsan?age=20&amp;number=1234&amp;interest=ball&amp;interest=game
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@GetMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/user/{id}/name/{username}&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>getUser</span><span style=color:#000>(</span><span style=color:#000>@PathVariable</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;id&#34;</span><span style=color:#000>)</span> <span style=color:#000>Integer</span> <span style=color:#000>id</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@PathVariable</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;username&#34;</span><span style=color:#000>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@PathVariable</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>pv</span><span style=color:#000>,</span> <span style=color:#177500>// PathVariable 注解注释中说明会将所有参数放入 Map 中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                                       <span style=color:#000>@RequestHeader</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;User-Agent&#34;</span><span style=color:#000>)</span> <span style=color:#000>String</span> <span style=color:#000>userAgent</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@RequestHeader</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>header</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@RequestParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;age&#34;</span><span style=color:#000>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@RequestParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;interest&#34;</span><span style=color:#000>)</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>interests</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@RequestParam</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>params</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@CookieValue</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;_ga&#34;</span><span style=color:#000>)</span> <span style=color:#000>String</span> <span style=color:#000>_ga</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>@CookieValue</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;_ga&#34;</span><span style=color:#000>)</span> <span style=color:#000>Cookie</span> <span style=color:#000>cookie</span>
</span></span><span style=display:flex><span>    <span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>map</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HashMap</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;id&#34;</span><span style=color:#000>,</span> <span style=color:#000>id</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;name&#34;</span><span style=color:#000>,</span> <span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;pv&#34;</span><span style=color:#000>,</span> <span style=color:#000>pv</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;userAgent&#34;</span><span style=color:#000>,</span> <span style=color:#000>userAgent</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;header&#34;</span><span style=color:#000>,</span> <span style=color:#000>header</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;age&#34;</span><span style=color:#000>,</span> <span style=color:#000>age</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;interests&#34;</span><span style=color:#000>,</span> <span style=color:#000>interests</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;params&#34;</span><span style=color:#000>,</span> <span style=color:#000>params</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;_ga&#34;</span><span style=color:#000>,</span> <span style=color:#000>_ga</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;cookie&#34;</span><span style=color:#000>,</span> <span style=color:#000>cookie</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>map</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@PostMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/save&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>save</span><span style=color:#000>(</span><span style=color:#000>@RequestBody</span> <span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>map</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HashMap</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;content&#34;</span><span style=color:#000>,</span> <span style=color:#000>content</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>map</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 1、语法：/cars/sell;low=23;brand=byd,audi,dazhong
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// 2、SpringBoot 默认关闭矩阵变量
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// 手动开启原理：
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// WebMvcAutoConfiguration.WebMvcAutoConfigurationAdapter 类中的 configurePathMatch 方法，
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// UrlPathHelper 中 removeSemicolonContent 变量默认 true，默认移除分号后的内容
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@GetMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;cars/{path}&#34;</span><span style=color:#000>)</span> <span style=color:#177500>// 3、注意矩阵变量是绑定到路径变量中的，这里不能直接写成 cars/sell
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>public</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>carsSell</span><span style=color:#000>(</span><span style=color:#000>@MatrixVariable</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;low&#34;</span><span style=color:#000>)</span> <span style=color:#000>Integer</span> <span style=color:#000>low</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>@MatrixVariable</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;brand&#34;</span><span style=color:#000>)</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>brands</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>@PathVariable</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;path&#34;</span><span style=color:#000>)</span> <span style=color:#000>String</span> <span style=color:#000>path</span>
</span></span><span style=display:flex><span>    <span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>map</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HashMap</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;low&#34;</span><span style=color:#000>,</span> <span style=color:#000>low</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;brands&#34;</span><span style=color:#000>,</span> <span style=color:#000>brands</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;path&#34;</span><span style=color:#000>,</span> <span style=color:#000>path</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>map</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// /boss/2;age=20/3;age=30
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@GetMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/boss/{bossId}/{empId}&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>boos</span><span style=color:#000>(</span><span style=color:#000>@MatrixVariable</span><span style=color:#000>(</span><span style=color:#000>value</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;age&#34;</span><span style=color:#000>,</span> <span style=color:#000>pathVar</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;bossId&#34;</span><span style=color:#000>)</span> <span style=color:#000>Integer</span> <span style=color:#000>bossAge</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000>@MatrixVariable</span><span style=color:#000>(</span><span style=color:#000>value</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;age&#34;</span><span style=color:#000>,</span> <span style=color:#000>pathVar</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;empId&#34;</span><span style=color:#000>)</span> <span style=color:#000>Integer</span> <span style=color:#000>empAge</span>
</span></span><span style=display:flex><span>    <span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>map</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HashMap</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;bossAge&#34;</span><span style=color:#000>,</span> <span style=color:#000>bossAge</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>map</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;empAge&#34;</span><span style=color:#000>,</span> <span style=color:#000>empAge</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>map</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>package com.chnherb.boot.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>import org.springframework.stereotype.Controller;
</span></span><span style=display:flex><span>import org.springframework.web.bind.annotation.GetMapping;
</span></span><span style=display:flex><span>import org.springframework.web.bind.annotation.RequestAttribute;
</span></span><span style=display:flex><span>import org.springframework.web.bind.annotation.ResponseBody;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>import javax.servlet.http.HttpServletRequest;
</span></span><span style=display:flex><span>import java.util.HashMap;
</span></span><span style=display:flex><span>import java.util.Map;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Controller
</span></span><span style=display:flex><span>public class RequestController {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @GetMapping(&#34;goto&#34;)
</span></span><span style=display:flex><span>    public String gotoPage(HttpServletRequest request) {
</span></span><span style=display:flex><span>        request.setAttribute(&#34;code&#34;, 301);
</span></span><span style=display:flex><span>        request.setAttribute(&#34;msg&#34;, &#34;this is msg&#34;);
</span></span><span style=display:flex><span>        return &#34;forward:success&#34;; // 转发到 /success 请求
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @ResponseBody
</span></span><span style=display:flex><span>    @GetMapping(&#34;/success&#34;)
</span></span><span style=display:flex><span>    public Map&lt;String, Object&gt; success(@RequestAttribute(&#34;code&#34;) int code,
</span></span><span style=display:flex><span>                                       @RequestAttribute(&#34;msg&#34;) String msg,
</span></span><span style=display:flex><span>                                       HttpServletRequest request
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        Object msg1 = request.getAttribute(&#34;msg&#34;);
</span></span><span style=display:flex><span>        Object code1 = request.getAttribute(&#34;code&#34;);
</span></span><span style=display:flex><span>        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
</span></span><span style=display:flex><span>        map.put(&#34;requestAttributeMsg&#34;, msg1);
</span></span><span style=display:flex><span>        map.put(&#34;requestAttributeCode&#34;, code1);
</span></span><span style=display:flex><span>        map.put(&#34;msg&#34;, msg);
</span></span><span style=display:flex><span>        map.put(&#34;code&#34;, code);
</span></span><span style=display:flex><span>        return map;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>测试 html：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>测试基本注解：
</span></span><span style=display:flex><span><span style=color:#000>&lt;ul&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;a</span> <span style=color:#836c28>href=</span><span style=color:#c41a16>&#34;user/1001/name/zhangsan?age=20&amp;number=1234&amp;interest=ball&amp;interest=game&#34;</span><span style=color:#000>&gt;</span>user/{id}/name/{username}<span style=color:#000>&lt;/a&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@PathVariable（路径变量）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@RequestHeader（获取请求头）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@RequestParam（获取请求头参数）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@CookieValue（获取 cookie 值）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@RequestBody（获取请求体 POST ）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@RequestAttribute（获取 request 域属性）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;li&gt;</span>@MatrixVariable（矩阵变量）<span style=color:#000>&lt;/li&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/ul&gt;</span>
</span></span><span style=display:flex><span>@RequestBody（获取请求体 POST ）
</span></span><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/save&#34;</span><span style=color:#000>,</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;post&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    @RequestBody（获取请求体 POST ）<span style=color:#000>&lt;br&gt;</span>
</span></span><span style=display:flex><span>    用户：<span style=color:#000>&lt;input</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;usernmae&#34;</span> <span style=color:#000>/&gt;</span> <span style=color:#000>&lt;br&gt;</span>
</span></span><span style=display:flex><span>    邮箱：<span style=color:#000>&lt;input</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;email&#34;</span><span style=color:#000>/&gt;</span> <span style=color:#000>&lt;br&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;提交&#34;</span><span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span><span style=display:flex><span>矩阵变量
</span></span><span style=display:flex><span><span style=color:#000>&lt;a</span> <span style=color:#836c28>href=</span><span style=color:#c41a16>&#34;/cars/sell;low=21;brand=byd,dazhong,aodi&#34;</span><span style=color:#000>&gt;</span>MatrixVariable<span style=color:#000>&lt;/a&gt;</span> <span style=color:#000>&lt;br&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;a</span> <span style=color:#836c28>href=</span><span style=color:#c41a16>&#34;/cars/sell;low=21;brand=byd;brand=baoma;brand=aodi&#34;</span><span style=color:#000>&gt;</span>MatrixVariable<span style=color:#000>&lt;/a&gt;</span> <span style=color:#000>&lt;br&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;a</span> <span style=color:#836c28>href=</span><span style=color:#c41a16>&#34;/boss/1;age=22/3;age=18&#34;</span><span style=color:#000>&gt;</span>MatrixVariable /boos/{boosId}/{empId}<span style=color:#000>&lt;/a&gt;</span> <span style=color:#000>&lt;br&gt;</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>SpringBoot 默认关闭矩阵变量，开启方式：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Configuration</span><span style=color:#000>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>)</span> <span style=color:#177500>// 没有依赖可以配置成 false
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>WebConfig</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        implements WebMvcConfigurer
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 开启矩阵变量
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Bean</span> <span style=color:#177500>// 1、注入 WebMvcConfigurer
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>public</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#000>webMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>WebMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>configurePathMatch</span><span style=color:#000>(</span><span style=color:#000>PathMatchConfigurer</span> <span style=color:#000>configurer</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>UrlPathHelper</span> <span style=color:#000>urlPathHelper</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>UrlPathHelper</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>urlPathHelper</span><span style=color:#000>.</span><span style=color:#836c28>setRemoveSemicolonContent</span><span style=color:#000>(</span><span style=color:#a90d91>false</span><span style=color:#000>);</span> <span style=color:#177500>// 不移除分号后面的内容
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>configurer</span><span style=color:#000>.</span><span style=color:#836c28>setUrlPathHelper</span><span style=color:#000>(</span><span style=color:#000>urlPathHelper</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>};</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#177500>//    // 2、实现 WebMvcConfigurer
</span></span></span><span style=display:flex><span><span style=color:#177500>//    @Override
</span></span></span><span style=display:flex><span><span style=color:#177500>//    public void configurePathMatch(PathMatchConfigurer configurer) {
</span></span></span><span style=display:flex><span><span style=color:#177500>//        UrlPathHelper urlPathHelper = new UrlPathHelper();
</span></span></span><span style=display:flex><span><span style=color:#177500>//        urlPathHelper.setRemoveSemicolonContent(false); // 不移除分号后面的内容
</span></span></span><span style=display:flex><span><span style=color:#177500>//        configurer.setUrlPathHelper(urlPathHelper);
</span></span></span><span style=display:flex><span><span style=color:#177500>//    }
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>开启原理：
查看 WebMvcAutoConfiguration.WebMvcAutoConfigurationAdapter 类中的 configurePathMatch 方法，</p><p>UrlPathHelper 中 removeSemicolonContent 变量默认 true，默认移除分号后的内容，即默认关闭矩阵变量功能。</p><h3 id=servlet-api>Servlet API</h3><p>除了上面常见的注解，还支持内置的 Servlet API 对象：</p><p>WebRequest、ServletRequest、MultipartRequest、 HttpSession、javax.servlet.http.PushBuilder、Principal、InputStream、Reader、HttpMethod、Locale、TimeZone、ZoneId</p><p>如 ServletRequestMethodArgumentResolver 能够解析以上部分参数（见下文参数处理原理 debug 得到）</p><h3 id=复杂参数>复杂参数</h3><p>Map</p><p>Model（map、model里面的数据会被放在request的请求域 request.setAttribute）Errors/BindingResult</p><p>RedirectAttributes（ 重定向携带数据）</p><p>ServletResponse（response）</p><p>SessionStatus</p><p>UriComponentsBuilder</p><p>ServletUriComponentsBuilder</p><p>Map 和 Model 类型的参数，会返回 mavContainer.getModel()，其类型为 BindingAwareModelMap，既是 Model 也是 Map。</p><h2 id=参数处理原理>参数处理原理</h2><ul><li>HandlerMapping 中找到能处理请求的 Hanlder（Controller.method）</li><li>为当前 Handler 找到 HandlerAdapter</li></ul><h3 id=handleradapter>HandlerAdapter</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#doDispatch
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>HandlerAdapter</span> <span style=color:#000>ha</span> <span style=color:#000>=</span> <span style=color:#000>getHandlerAdapter</span><span style=color:#000>(</span><span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>getHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>HandlerAdapter</span> <span style=color:#000>getHandlerAdapter</span><span style=color:#000>(</span><span style=color:#000>Object</span> <span style=color:#000>handler</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>ServletException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>handlerAdapters</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>HandlerAdapter</span> <span style=color:#000>adapter</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>handlerAdapters</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>adapter</span><span style=color:#000>.</span><span style=color:#836c28>supports</span><span style=color:#000>(</span><span style=color:#000>handler</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#000>adapter</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=../imgs/spring-boot-02-220925_3.png alt=spring-boot-02-220925_3.png></p><p>介绍下几个 HandlerAdapter：</p><ul><li>0 - 支持方法上标注 @RequestMapping</li><li>1 - 支持函数式编程的</li><li>...<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#doDispatch
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>mv</span> <span style=color:#000>=</span> <span style=color:#000>ha</span><span style=color:#000>.</span><span style=color:#836c28>handle</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>getHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter#handle
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>handle</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>handler</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>handleInternal</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>(</span><span style=color:#000>HandlerMethod</span><span style=color:#000>)</span> <span style=color:#000>handler</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><p>RequestMappingHandlerAdapter 处理：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#handleInternal
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>handleInternal</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>HandlerMethod</span> <span style=color:#000>handlerMethod</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ModelAndView</span> <span style=color:#000>mav</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>checkRequest</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#000>mav</span> <span style=color:#000>=</span> <span style=color:#000>invokeHandlerMethod</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>handlerMethod</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>mav</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=执行目标方法>执行目标方法</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>invokeHandlerMethod</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>HandlerMethod</span> <span style=color:#000>handlerMethod</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#000>ServletWebRequest</span> <span style=color:#000>webRequest</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServletWebRequest</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>WebDataBinderFactory</span> <span style=color:#000>binderFactory</span> <span style=color:#000>=</span> <span style=color:#000>getDataBinderFactory</span><span style=color:#000>(</span><span style=color:#000>handlerMethod</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ModelFactory</span> <span style=color:#000>modelFactory</span> <span style=color:#000>=</span> <span style=color:#000>getModelFactory</span><span style=color:#000>(</span><span style=color:#000>handlerMethod</span><span style=color:#000>,</span> <span style=color:#000>binderFactory</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ServletInvocableHandlerMethod</span> <span style=color:#000>invocableMethod</span> <span style=color:#000>=</span> <span style=color:#000>createInvocableHandlerMethod</span><span style=color:#000>(</span><span style=color:#000>handlerMethod</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>argumentResolvers</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>invocableMethod</span><span style=color:#000>.</span><span style=color:#836c28>setHandlerMethodArgumentResolvers</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>argumentResolvers</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>returnValueHandlers</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>invocableMethod</span><span style=color:#000>.</span><span style=color:#836c28>setHandlerMethodReturnValueHandlers</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>returnValueHandlers</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=参数解析器>参数解析器</h3><p>this.argumentResolvers</p><p><img src=../imgs/spring-boot-02-220925_4.png alt=spring-boot-02-220925_4.png></p><p>该参数解析器实现的接口（cmd+F12 查看所有方法）：</p><p><img src=../imgs/spring-boot-02-220925_5.png alt=spring-boot-02-220925_5.png></p><ul><li>当前解析器是否支持解析参数</li><li>支持就调用 resolveArgument</li></ul><h3 id=调用并处理>调用并处理</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>invocableMethod</span><span style=color:#000>.</span><span style=color:#836c28>invokeAndHandle</span><span style=color:#000>(</span><span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>invokeAndHandle</span><span style=color:#000>(</span><span style=color:#000>ServletWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span><span style=color:#000>...</span> <span style=color:#000>providedArgs</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 真正执行目标方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Object</span> <span style=color:#000>returnValue</span> <span style=color:#000>=</span> <span style=color:#000>invokeForRequest</span><span style=color:#000>(</span><span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>providedArgs</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>执行目标方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.method.support.InvocableHandlerMethod#invokeForRequest
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>invokeForRequest</span><span style=color:#000>(</span><span style=color:#000>NativeWebRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>@Nullable</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span><span style=color:#000>...</span> <span style=color:#000>providedArgs</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 获取请求参数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span> <span style=color:#000>=</span> <span style=color:#000>getMethodArgumentValues</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>providedArgs</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isTraceEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>trace</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Arguments: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>Arrays</span><span style=color:#000>.</span><span style=color:#836c28>toString</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 利用反射调用目标方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>return</span> <span style=color:#000>doInvoke</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=获取方法参数值>获取方法参数值</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.method.support.InvocableHandlerMethod#getMethodArgumentValues
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>getMethodArgumentValues</span><span style=color:#000>(</span><span style=color:#000>NativeWebRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>@Nullable</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Object</span><span style=color:#000>...</span> <span style=color:#000>providedArgs</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 获取所有方法参数声明(参数类型、索引值)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>MethodParameter</span><span style=color:#000>[]</span> <span style=color:#000>parameters</span> <span style=color:#000>=</span> <span style=color:#000>getMethodParameters</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>ObjectUtils</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>(</span><span style=color:#000>parameters</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>EMPTY_ARGS</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Object</span><span style=color:#000>[</span><span style=color:#000>parameters</span><span style=color:#000>.</span><span style=color:#836c28>length</span><span style=color:#000>];</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>i</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span> <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>parameters</span><span style=color:#000>.</span><span style=color:#836c28>length</span><span style=color:#000>;</span> <span style=color:#000>i</span><span style=color:#000>++)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>MethodParameter</span> <span style=color:#000>parameter</span> <span style=color:#000>=</span> <span style=color:#000>parameters</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>];</span>
</span></span><span style=display:flex><span>      <span style=color:#000>parameter</span><span style=color:#000>.</span><span style=color:#836c28>initParameterNameDiscovery</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>parameterNameDiscoverer</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>args</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>=</span> <span style=color:#000>findProvidedArgument</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#000>providedArgs</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>continue</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 判断参数解析器是否支持解析该参数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resolvers</span><span style=color:#000>.</span><span style=color:#836c28>supportsParameter</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#000>(</span><span style=color:#000>formatArgumentError</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;No suitable resolver&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>args</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resolvers</span><span style=color:#000>.</span><span style=color:#836c28>resolveArgument</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>dataBinderFactory</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// Leave stack trace for later, exception may actually be resolved and handled...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>exMsg</span> <span style=color:#000>=</span> <span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>exMsg</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>exMsg</span><span style=color:#000>.</span><span style=color:#836c28>contains</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>.</span><span style=color:#836c28>getExecutable</span><span style=color:#000>().</span><span style=color:#836c28>toGenericString</span><span style=color:#000>()))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#000>formatArgumentError</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#000>exMsg</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>throw</span> <span style=color:#000>ex</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>args</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=遍历判断参数解析器是否支持>遍历判断参数解析器是否支持</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#000>HandlerMethodArgumentResolver</span> <span style=color:#000>getArgumentResolver</span><span style=color:#000>(</span><span style=color:#000>MethodParameter</span> <span style=color:#000>parameter</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HandlerMethodArgumentResolver</span> <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>argumentResolverCache</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>result</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>HandlerMethodArgumentResolver</span> <span style=color:#000>resolver</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>argumentResolvers</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>resolver</span><span style=color:#000>.</span><span style=color:#836c28>supportsParameter</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>resolver</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 缓存起来，第一次运行较慢，后面有了缓存会越来越快！！
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>argumentResolverCache</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#000>result</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>result</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=解析参数值>解析参数值</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>resolveArgument</span><span style=color:#000>(</span><span style=color:#000>MethodParameter</span> <span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#000>@Nullable</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>NativeWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>@Nullable</span> <span style=color:#000>WebDataBinderFactory</span> <span style=color:#000>binderFactory</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HandlerMethodArgumentResolver</span> <span style=color:#000>resolver</span> <span style=color:#000>=</span> <span style=color:#000>getArgumentResolver</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>resolver</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Unsupported parameter type [&#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>            <span style=color:#000>parameter</span><span style=color:#000>.</span><span style=color:#836c28>getParameterType</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;]. supportsParameter should be called first.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>resolver</span><span style=color:#000>.</span><span style=color:#836c28>resolveArgument</span><span style=color:#000>(</span><span style=color:#000>parameter</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>binderFactory</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=自定义参数类型>自定义参数类型</h4><p>ServletModelAttributeMethodProcessor 参数处理器支持</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>WebDataBinder</span> <span style=color:#000>binder</span> <span style=color:#000>=</span> <span style=color:#000>binderFactory</span><span style=color:#000>.</span><span style=color:#836c28>createBinder</span><span style=color:#000>(</span><span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#000>namedValueInfo</span><span style=color:#000>.</span><span style=color:#836c28>name</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>WebDataBinder：web数据绑定器，将请求参数的值绑定到指定的 JavaBean 里面。
GenericConversionService：设置每个属性值时，使用 converter 转换数据类型。</p><h4 id=自定义参数转换器>自定义参数转换器</h4><p>在 WebDataBinder 中添加自定义的 Converter 可以自定义类型转换器：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Bean</span> <span style=color:#177500>// 1、注入 WebMvcConfigurer
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#000>webMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>WebMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 自定义类型转换器，用作请求参数转换
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>addFormatters</span><span style=color:#000>(</span><span style=color:#000>FormatterRegistry</span> <span style=color:#000>registry</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>addConverter</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>Converter</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Car</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>public</span> <span style=color:#000>Car</span> <span style=color:#000>convert</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>source</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#177500>// byd,200000
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>(</span><span style=color:#000>source</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>split</span> <span style=color:#000>=</span> <span style=color:#000>source</span><span style=color:#000>.</span><span style=color:#836c28>split</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;,&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>split</span><span style=color:#000>.</span><span style=color:#836c28>length</span> <span style=color:#000>!=</span> <span style=color:#000>2</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>Car</span> <span style=color:#000>car</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Car</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>car</span><span style=color:#000>.</span><span style=color:#836c28>setBrand</span><span style=color:#000>(</span><span style=color:#000>split</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>]);</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>car</span><span style=color:#000>.</span><span style=color:#836c28>setPrice</span><span style=color:#000>(</span><span style=color:#000>Integer</span><span style=color:#000>.</span><span style=color:#836c28>parseInt</span><span style=color:#000>(</span><span style=color:#000>split</span><span style=color:#000>[</span><span style=color:#000>1</span><span style=color:#000>]));</span>
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>return</span> <span style=color:#000>car</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>});</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>};</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=目标方法执行完成>目标方法执行完成</h3><p>将所有的数据都放在 ModelAndViewContainer，包含要去的页面地址 View 和 Model 数据。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>return</span> <span style=color:#000>getModelAndView</span><span style=color:#000>(</span><span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>modelFactory</span><span style=color:#000>,</span> <span style=color:#000>webRequest</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#getModelAndView
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>getModelAndView</span><span style=color:#000>(</span><span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ModelFactory</span> <span style=color:#000>modelFactory</span><span style=color:#000>,</span> <span style=color:#000>NativeWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>modelFactory</span><span style=color:#000>.</span><span style=color:#836c28>updateModel</span><span style=color:#000>(</span><span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>isRequestHandled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ModelMap</span> <span style=color:#000>model</span> <span style=color:#000>=</span> <span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>getModel</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ModelAndView</span> <span style=color:#000>mav</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ModelAndView</span><span style=color:#000>(</span><span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>getViewName</span><span style=color:#000>(),</span> <span style=color:#000>model</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>getStatus</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>isViewReference</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mav</span><span style=color:#000>.</span><span style=color:#836c28>setView</span><span style=color:#000>((</span><span style=color:#000>View</span><span style=color:#000>)</span> <span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>getView</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>model</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>RedirectAttributes</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>?&gt;</span> <span style=color:#000>flashAttributes</span> <span style=color:#000>=</span> <span style=color:#000>((</span><span style=color:#000>RedirectAttributes</span><span style=color:#000>)</span> <span style=color:#000>model</span><span style=color:#000>).</span><span style=color:#836c28>getFlashAttributes</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span> <span style=color:#000>=</span> <span style=color:#000>webRequest</span><span style=color:#000>.</span><span style=color:#836c28>getNativeRequest</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>request</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>RequestContextUtils</span><span style=color:#000>.</span><span style=color:#836c28>getOutputFlashMap</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>).</span><span style=color:#836c28>putAll</span><span style=color:#000>(</span><span style=color:#000>flashAttributes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>mav</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=处理派发结果>处理派发结果</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#doDispatch
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>processDispatchResult</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>mappedHandler</span><span style=color:#000>,</span> <span style=color:#000>mv</span><span style=color:#000>,</span> <span style=color:#000>dispatchException</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=数据响应与内容协商>数据响应与内容协商</h1><p>数据响应</p><ul><li>响应页面</li><li>响应数据<ul><li>JSON</li><li>XML</li><li>xls</li><li>图片、音视频...</li><li>自定义协议数据
内容协商：浏览器以请求头的方式告诉服务器能接受什么类型的内容。</li></ul></li></ul><h2 id=响应json>响应JSON</h2><p>web starter 自动引入了 json 相关包。</p><p>实现条件：</p><p>1、json 相关包</p><p>2、@ResponseBody</p><h2 id=响应处理原理>响应处理原理</h2><p>基本大的流程同上文请求参数处理</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>#</span> <span style=color:#000>doDispatch</span>
</span></span><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>servlet</span><span style=color:#000>.</span><span style=color:#836c28>DispatcherServlet</span><span style=color:#000>#</span><span style=color:#000>doDispatch</span>
</span></span><span style=display:flex><span><span style=color:#000>#</span> <span style=color:#000>handle</span>
</span></span><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>servlet</span><span style=color:#000>.</span><span style=color:#836c28>mvc</span><span style=color:#000>.</span><span style=color:#836c28>method</span><span style=color:#000>.</span><span style=color:#836c28>AbstractHandlerMethodAdapter</span><span style=color:#000>#</span><span style=color:#000>handle</span>
</span></span><span style=display:flex><span><span style=color:#000>#</span> <span style=color:#000>handleInternal</span>
</span></span><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>servlet</span><span style=color:#000>.</span><span style=color:#836c28>mvc</span><span style=color:#000>.</span><span style=color:#836c28>method</span><span style=color:#000>.</span><span style=color:#836c28>annotation</span><span style=color:#000>.</span><span style=color:#836c28>RequestMappingHandlerAdapter</span><span style=color:#000>#</span><span style=color:#000>handleInternal</span>
</span></span><span style=display:flex><span><span style=color:#000>#</span> <span style=color:#000>invokeHandlerMethod</span>
</span></span><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>servlet</span><span style=color:#000>.</span><span style=color:#836c28>mvc</span><span style=color:#000>.</span><span style=color:#836c28>method</span><span style=color:#000>.</span><span style=color:#836c28>annotation</span><span style=color:#000>.</span><span style=color:#836c28>RequestMappingHandlerAdapter</span><span style=color:#000>#</span><span style=color:#000>invokeHandlerMethod</span>
</span></span><span style=display:flex><span><span style=color:#000>#</span> <span style=color:#000>invokeAndHandle</span>
</span></span><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>servlet</span><span style=color:#000>.</span><span style=color:#836c28>mvc</span><span style=color:#000>.</span><span style=color:#836c28>method</span><span style=color:#000>.</span><span style=color:#836c28>annotation</span><span style=color:#000>.</span><span style=color:#836c28>ServletInvocableHandlerMethod</span><span style=color:#000>#</span><span style=color:#000>invokeAndHandle</span>
</span></span><span style=display:flex><span><span style=color:#000>#</span> <span style=color:#000>handleReturnValue</span>
</span></span><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>method</span><span style=color:#000>.</span><span style=color:#836c28>support</span><span style=color:#000>.</span><span style=color:#836c28>HandlerMethodReturnValueHandlerComposite</span><span style=color:#000>#</span><span style=color:#000>handleReturnValue</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=返回值处理器>返回值处理器</h3><p><img src=../imgs/spring-boot-02-220925_6.png alt=spring-boot-02-220925_6.png></p><p>处理返回值方法</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>returnValueHandlers</span><span style=color:#000>.</span><span style=color:#836c28>handleReturnValue</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>         <span style=color:#000>returnValue</span><span style=color:#000>,</span> <span style=color:#000>getReturnValueType</span><span style=color:#000>(</span><span style=color:#000>returnValue</span><span style=color:#000>),</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>webRequest</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite#handleReturnValue
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>handleReturnValue</span><span style=color:#000>(</span><span style=color:#000>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>returnValue</span><span style=color:#000>,</span> <span style=color:#000>MethodParameter</span> <span style=color:#000>returnType</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>NativeWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HandlerMethodReturnValueHandler</span> <span style=color:#000>handler</span> <span style=color:#000>=</span> <span style=color:#000>selectHandler</span><span style=color:#000>(</span><span style=color:#000>returnValue</span><span style=color:#000>,</span> <span style=color:#000>returnType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>handler</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Unknown return value type: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>returnType</span><span style=color:#000>.</span><span style=color:#836c28>getParameterType</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>handler</span><span style=color:#000>.</span><span style=color:#836c28>handleReturnValue</span><span style=color:#000>(</span><span style=color:#000>returnValue</span><span style=color:#000>,</span> <span style=color:#000>returnType</span><span style=color:#000>,</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>webRequest</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#000>HandlerMethodReturnValueHandler</span> <span style=color:#000>selectHandler</span><span style=color:#000>(</span><span style=color:#000>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#000>,</span> <span style=color:#000>MethodParameter</span> <span style=color:#000>returnType</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>boolean</span> <span style=color:#000>isAsyncValue</span> <span style=color:#000>=</span> <span style=color:#000>isAsyncReturnValue</span><span style=color:#000>(</span><span style=color:#000>value</span><span style=color:#000>,</span> <span style=color:#000>returnType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>HandlerMethodReturnValueHandler</span> <span style=color:#000>handler</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>returnValueHandlers</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>isAsyncValue</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!(</span><span style=color:#000>handler</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>AsyncHandlerMethodReturnValueHandler</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>continue</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>handler</span><span style=color:#000>.</span><span style=color:#836c28>supportsReturnType</span><span style=color:#000>(</span><span style=color:#000>returnType</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span> <span style=color:#000>handler</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>返回值处理器先判断是否支持该类型返回值，支持则调用 handleReturnValue 方法处理，同处理请求参数。</p><h3 id=methodprocessor>MethodProcessor</h3><p>因为业务代码标注了 ResponseBody 注解，所以是使用 RequestResponseBodyMethodProcessor</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor#handleReturnValue
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>handleReturnValue</span><span style=color:#000>(</span><span style=color:#000>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>returnValue</span><span style=color:#000>,</span> <span style=color:#000>MethodParameter</span> <span style=color:#000>returnType</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#000>,</span> <span style=color:#000>NativeWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>HttpMediaTypeNotAcceptableException</span><span style=color:#000>,</span> <span style=color:#000>HttpMessageNotWritableException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>mavContainer</span><span style=color:#000>.</span><span style=color:#836c28>setRequestHandled</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ServletServerHttpRequest</span> <span style=color:#000>inputMessage</span> <span style=color:#000>=</span> <span style=color:#000>createInputMessage</span><span style=color:#000>(</span><span style=color:#000>webRequest</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ServletServerHttpResponse</span> <span style=color:#000>outputMessage</span> <span style=color:#000>=</span> <span style=color:#000>createOutputMessage</span><span style=color:#000>(</span><span style=color:#000>webRequest</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Try even with null return value. ResponseBodyAdvice could get involved.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>writeWithMessageConverters</span><span style=color:#000>(</span><span style=color:#000>returnValue</span><span style=color:#000>,</span> <span style=color:#000>returnType</span><span style=color:#000>,</span> <span style=color:#000>inputMessage</span><span style=color:#000>,</span> <span style=color:#000>outputMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>MessageConverters<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor#writeWithMessageConverters
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#000>&lt;</span><span style=color:#000>T</span><span style=color:#000>&gt;</span> <span style=color:#a90d91>void</span> <span style=color:#000>writeWithMessageConverters</span><span style=color:#000>(</span><span style=color:#000>@Nullable</span> <span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#000>,</span> <span style=color:#000>MethodParameter</span> <span style=color:#000>returnType</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ServletServerHttpRequest</span> <span style=color:#000>inputMessage</span><span style=color:#000>,</span> <span style=color:#000>ServletServerHttpResponse</span> <span style=color:#000>outputMessage</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>HttpMediaTypeNotAcceptableException</span><span style=color:#000>,</span> <span style=color:#000>HttpMessageNotWritableException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#000>MediaType</span> <span style=color:#000>selectedMediaType</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>MediaType</span> <span style=color:#000>contentType</span> <span style=color:#000>=</span> <span style=color:#000>outputMessage</span><span style=color:#000>.</span><span style=color:#836c28>getHeaders</span><span style=color:#000>().</span><span style=color:#836c28>getContentType</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>boolean</span> <span style=color:#000>isContentTypePreset</span> <span style=color:#000>=</span> <span style=color:#000>contentType</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>contentType</span><span style=color:#000>.</span><span style=color:#836c28>isConcrete</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>isContentTypePreset</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Found &#39;Content-Type:&#34;</span> <span style=color:#000>+</span> <span style=color:#000>contentType</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39; in response&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>selectedMediaType</span> <span style=color:#000>=</span> <span style=color:#000>contentType</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span> <span style=color:#000>=</span> <span style=color:#000>inputMessage</span><span style=color:#000>.</span><span style=color:#836c28>getServletRequest</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 获取浏览器接受的数据类型，浏览器请求头 Accept 字段
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>MediaType</span><span style=color:#000>&gt;</span> <span style=color:#000>acceptableTypes</span> <span style=color:#000>=</span> <span style=color:#000>getAcceptableMediaTypes</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 获取服务器能够处理的数据类型
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>MediaType</span><span style=color:#000>&gt;</span> <span style=color:#000>producibleTypes</span> <span style=color:#000>=</span> <span style=color:#000>getProducibleMediaTypes</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>valueType</span><span style=color:#000>,</span> <span style=color:#000>targetType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>body</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>producibleTypes</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>HttpMessageNotWritableException</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>               <span style=color:#c41a16>&#34;No converter found for return value of type: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>valueType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 可以使用的媒体类型
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>MediaType</span><span style=color:#000>&gt;</span> <span style=color:#000>mediaTypesToUse</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ArrayList</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 浏览器和服务器的数据类型进行匹配
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>MediaType</span> <span style=color:#000>requestedType</span> <span style=color:#000>:</span> <span style=color:#000>acceptableTypes</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>MediaType</span> <span style=color:#000>producibleType</span> <span style=color:#000>:</span> <span style=color:#000>producibleTypes</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>requestedType</span><span style=color:#000>.</span><span style=color:#836c28>isCompatibleWith</span><span style=color:#000>(</span><span style=color:#000>producibleType</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>mediaTypesToUse</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>getMostSpecificMediaType</span><span style=color:#000>(</span><span style=color:#000>requestedType</span><span style=color:#000>,</span> <span style=color:#000>producibleType</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mediaTypesToUse</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>body</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>HttpMediaTypeNotAcceptableException</span><span style=color:#000>(</span><span style=color:#000>producibleTypes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;No match for &#34;</span> <span style=color:#000>+</span> <span style=color:#000>acceptableTypes</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;, supported: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>producibleTypes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>sortBySpecificityAndQuality</span><span style=color:#000>(</span><span style=color:#000>mediaTypesToUse</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>MediaType</span> <span style=color:#000>mediaType</span> <span style=color:#000>:</span> <span style=color:#000>mediaTypesToUse</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mediaType</span><span style=color:#000>.</span><span style=color:#836c28>isConcrete</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>selectedMediaType</span> <span style=color:#000>=</span> <span style=color:#000>mediaType</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>mediaType</span><span style=color:#000>.</span><span style=color:#836c28>isPresentIn</span><span style=color:#000>(</span><span style=color:#000>ALL_APPLICATION_MEDIA_TYPES</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>selectedMediaType</span> <span style=color:#000>=</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>APPLICATION_OCTET_STREAM</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Using &#39;&#34;</span> <span style=color:#000>+</span> <span style=color:#000>selectedMediaType</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;&#39;, given &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>               <span style=color:#000>acceptableTypes</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; and supported &#34;</span> <span style=color:#000>+</span> <span style=color:#000>producibleTypes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><h3 id=httpmessageconverter>HttpMessageConverter</h3><p>HttpMessageConverter 判断是否支持将当前类型转换为 MediaType 类型的数据。如对象转 JSON 或 JSON 转对象，具体调用该接口的方法。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#177500>// 代码接上文
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>selectedMediaType</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>     <span style=color:#000>selectedMediaType</span> <span style=color:#000>=</span> <span style=color:#000>selectedMediaType</span><span style=color:#000>.</span><span style=color:#836c28>removeQualityValue</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>     <span style=color:#177500>// 遍历容器所有的 HttpMessageConverter
</span></span></span><span style=display:flex><span><span style=color:#177500></span>     <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>converter</span> <span style=color:#000>:</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>GenericHttpMessageConverter</span> <span style=color:#000>genericConverter</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>converter</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>GenericHttpMessageConverter</span> <span style=color:#000>?</span>
</span></span><span style=display:flex><span>              <span style=color:#000>(</span><span style=color:#000>GenericHttpMessageConverter</span><span style=color:#000>&lt;?&gt;)</span> <span style=color:#000>converter</span> <span style=color:#000>:</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>genericConverter</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>?</span>
</span></span><span style=display:flex><span>              <span style=color:#000>((</span><span style=color:#000>GenericHttpMessageConverter</span><span style=color:#000>)</span> <span style=color:#000>converter</span><span style=color:#000>).</span><span style=color:#836c28>canWrite</span><span style=color:#000>(</span><span style=color:#000>targetType</span><span style=color:#000>,</span> <span style=color:#000>valueType</span><span style=color:#000>,</span> <span style=color:#000>selectedMediaType</span><span style=color:#000>)</span> <span style=color:#000>:</span>
</span></span><span style=display:flex><span>              <span style=color:#000>converter</span><span style=color:#000>.</span><span style=color:#836c28>canWrite</span><span style=color:#000>(</span><span style=color:#000>valueType</span><span style=color:#000>,</span> <span style=color:#000>selectedMediaType</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>           <span style=color:#000>body</span> <span style=color:#000>=</span> <span style=color:#000>getAdvice</span><span style=color:#000>().</span><span style=color:#836c28>beforeBodyWrite</span><span style=color:#000>(</span><span style=color:#000>body</span><span style=color:#000>,</span> <span style=color:#000>returnType</span><span style=color:#000>,</span> <span style=color:#000>selectedMediaType</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?</span> <span style=color:#a90d91>extends</span> <span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;)</span> <span style=color:#000>converter</span><span style=color:#000>.</span><span style=color:#836c28>getClass</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                 <span style=color:#000>inputMessage</span><span style=color:#000>,</span> <span style=color:#000>outputMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>           <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>body</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>Object</span> <span style=color:#000>theBody</span> <span style=color:#000>=</span> <span style=color:#000>body</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>LogFormatUtils</span><span style=color:#000>.</span><span style=color:#836c28>traceDebug</span><span style=color:#000>(</span><span style=color:#000>logger</span><span style=color:#000>,</span> <span style=color:#000>traceOn</span> <span style=color:#000>-&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#c41a16>&#34;Writing [&#34;</span> <span style=color:#000>+</span> <span style=color:#000>LogFormatUtils</span><span style=color:#000>.</span><span style=color:#836c28>formatValue</span><span style=color:#000>(</span><span style=color:#000>theBody</span><span style=color:#000>,</span> <span style=color:#000>!</span><span style=color:#000>traceOn</span><span style=color:#000>)</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;]&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>              <span style=color:#000>addContentDispositionHeader</span><span style=color:#000>(</span><span style=color:#000>inputMessage</span><span style=color:#000>,</span> <span style=color:#000>outputMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>              <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>genericConverter</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                 <span style=color:#000>genericConverter</span><span style=color:#000>.</span><span style=color:#836c28>write</span><span style=color:#000>(</span><span style=color:#000>body</span><span style=color:#000>,</span> <span style=color:#000>targetType</span><span style=color:#000>,</span> <span style=color:#000>selectedMediaType</span><span style=color:#000>,</span> <span style=color:#000>outputMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>              <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>write</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.http.converter.AbstractHttpMessageConverter#write
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>void</span> <span style=color:#000>write</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>T</span> <span style=color:#000>t</span><span style=color:#000>,</span> <span style=color:#000>@Nullable</span> <span style=color:#000>MediaType</span> <span style=color:#000>contentType</span><span style=color:#000>,</span> <span style=color:#000>HttpOutputMessage</span> <span style=color:#000>outputMessage</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>HttpMessageNotWritableException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>      <span style=color:#000>writeInternal</span><span style=color:#000>(</span><span style=color:#000>t</span><span style=color:#000>,</span> <span style=color:#000>outputMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>writeInternal<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.http.converter.AbstractGenericHttpMessageConverter#writeInternal(T, org.springframework.http.HttpOutputMessage)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>writeInternal</span><span style=color:#000>(</span><span style=color:#000>T</span> <span style=color:#000>t</span><span style=color:#000>,</span> <span style=color:#000>HttpOutputMessage</span> <span style=color:#000>outputMessage</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>HttpMessageNotWritableException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>writeInternal</span><span style=color:#000>(</span><span style=color:#000>t</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#000>outputMessage</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>AbstractJackson2HttpMessageConverter （该类子类 MappingJackson2HttpMessageConverter）
该类利用底层的 jackson 的 objectMapper 进行转换。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter#writeInternal
</span></span></span></code></pre></td></tr></table></div></div></div><p>小结：</p><ul><li>返回值处理器判断是否支持该类型</li><li>返回值处理器调用 handleReturnValue 进行处理</li><li>RequestResponseBodyMethodProcessor 处理标记 ResponseBody 注解的方法<ul><li>MessageConverters 处理：将数据写为 JSON<ul><li>内容协商（浏览器请求头带有自身接受数据类型）</li><li>服务器根据自身能力决定生产出什么类型的数据<ul><li>利用 MappingJackson2HttpMessageConverter 将对象写为 json</li></ul></li></ul></li></ul></li></ul><h2 id=内容协商>内容协商</h2><h3 id=xml响应>XML响应</h3><p>默认的请求是以 JSON 方式响应，如果想使用 XML 方式响应方法如下：</p><p>引入依赖：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>com.fasterxml.jackson.dataformat<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>jackson-dataformat-xml<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>浏览器请求时响应的是 XML，原因：引入 XML 处理依赖包表示服务端可以处理 XML，浏览器 Request Headers 的 Accpet 字段为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span></code></pre></td></tr></table></div></div></div><p>表示 XML 优先于 JSON（没有 JSON）。
注意：如果 Accept 为 <em>/</em>，那么返回是 JSON。</p><h3 id=内容协商原理>内容协商原理</h3><ul><li>判断当前响应头中是否存在已经确定的媒体类型 MediaType</li><li>获取客户端支持接受的内容类型（请求头 Accept 字段）</li><li>遍历所有的 MessageConverter，判断是否支持操作当前类型的对象</li><li>找到支持当前类型对象的 converter，统计其支持的媒体类型</li><li>获取客户端需要的媒体类型和服务端支持的媒体类型</li><li>进行内容协商，匹配最佳媒体类型</li><li>调用支持将对象转为最佳匹配媒体类型的 converter 进行转换</li></ul><h4 id=导入默认messageconverter>导入默认MessageConverter</h4><p>WebMvcAutoConfiguration 自动配置类启动时会配置 MessageConverters</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration.WebMvcAutoConfigurationAdapter#configureMessageConverters
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>configureMessageConverters</span><span style=color:#000>(</span><span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>converters</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConvertersProvider</span>
</span></span><span style=display:flex><span>         <span style=color:#000>.</span><span style=color:#836c28>ifAvailable</span><span style=color:#000>((</span><span style=color:#000>customConverters</span><span style=color:#000>)</span> <span style=color:#000>-&gt;</span> <span style=color:#000>converters</span><span style=color:#000>.</span><span style=color:#836c28>addAll</span><span style=color:#000>(</span><span style=color:#000>customConverters</span><span style=color:#000>.</span><span style=color:#836c28>getConverters</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>HttpMessageConverters 初始化会给 converters 赋值</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.http.HttpMessageConverters#HttpMessageConverters
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>HttpMessageConverters</span><span style=color:#000>(</span><span style=color:#a90d91>boolean</span> <span style=color:#000>addDefaultConverters</span><span style=color:#000>,</span> <span style=color:#000>Collection</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>converters</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>combined</span> <span style=color:#000>=</span> <span style=color:#000>getCombinedConverters</span><span style=color:#000>(</span><span style=color:#000>converters</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addDefaultConverters</span> <span style=color:#000>?</span> <span style=color:#000>getDefaultConverters</span><span style=color:#000>()</span> <span style=color:#000>:</span> <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>emptyList</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>combined</span> <span style=color:#000>=</span> <span style=color:#000>postProcessConverters</span><span style=color:#000>(</span><span style=color:#000>combined</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>converters</span> <span style=color:#000>=</span> <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>unmodifiableList</span><span style=color:#000>(</span><span style=color:#000>combined</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>获取默认的 Converters</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>getDefaultConverters</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>      <span style=color:#000>converters</span><span style=color:#000>.</span><span style=color:#836c28>addAll</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>WebMvcConfigurationSupport</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>public</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>defaultMessageConverters</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>getMessageConverters</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}.</span><span style=color:#836c28>defaultMessageConverters</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>默认的 Converter 从父类获取<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#getMessageConverters
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>final</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>getMessageConverters</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ArrayList</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>configureMessageConverters</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addDefaultHttpMessageConverters</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>extendMessageConverters</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messageConverters</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>更多的 converter 就在 addDefaultHttpMessageConverters 方法中<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#addDefaultHttpMessageConverters
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>void</span> <span style=color:#000>addDefaultHttpMessageConverters</span><span style=color:#000>(</span><span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>messageConverters</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ByteArrayHttpMessageConverter</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>		<span style=color:#000>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>StringHttpMessageConverter</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>		<span style=color:#000>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ResourceHttpMessageConverter</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>		<span style=color:#000>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ResourceRegionHttpMessageConverter</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>jackson2XmlPresent</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>			<span style=color:#000>Jackson2ObjectMapperBuilder</span> <span style=color:#000>builder</span> <span style=color:#000>=</span> <span style=color:#000>Jackson2ObjectMapperBuilder</span><span style=color:#000>.</span><span style=color:#836c28>xml</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>			<span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>				<span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>			<span style=color:#000>}</span>
</span></span><span style=display:flex><span>			<span style=color:#000>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>MappingJackson2XmlHttpMessageConverter</span><span style=color:#000>(</span><span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>build</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>		<span style=color:#000>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>jaxb2Present</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>			<span style=color:#000>messageConverters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>Jaxb2RootElementHttpMessageConverter</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>		<span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>...</span>				
</span></span><span style=display:flex><span>	<span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>初始化用于判断的 present 变量：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>static</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span> <span style=color:#000>=</span> <span style=color:#000>WebMvcConfigurationSupport</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>getClassLoader</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>romePresent</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.rometools.rome.feed.WireFeed&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>jaxb2Present</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;javax.xml.bind.Binder&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>jackson2Present</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.fasterxml.jackson.databind.ObjectMapper&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>)</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.fasterxml.jackson.core.JsonGenerator&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>jackson2XmlPresent</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.fasterxml.jackson.dataformat.xml.XmlMapper&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>jackson2SmilePresent</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.fasterxml.jackson.dataformat.smile.SmileFactory&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>jackson2CborPresent</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.fasterxml.jackson.dataformat.cbor.CBORFactory&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>gsonPresent</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.google.gson.Gson&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>jsonbPresent</span> <span style=color:#000>=</span> <span style=color:#000>ClassUtils</span><span style=color:#000>.</span><span style=color:#836c28>isPresent</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;javax.json.bind.Jsonb&#34;</span><span style=color:#000>,</span> <span style=color:#000>classLoader</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>可以发现自动导入各种 converter 是通过类工具判断项目中是否导入对应的 class。</p><h3 id=开启参数方式内容协商>开启参数方式内容协商</h3><p>默认的内容协商管理器 contentNegotationManager 只有一个策略根据请求的 Accept 来决定，可以增加根据请求参数来进行内容协商。方法如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>spring:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>mvc</span><span style=color:#000>:</span>  
</span></span><span style=display:flex><span>    <span style=color:#000>contentnegotiation</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>      <span style=color:#000>favor</span><span style=color:#000>-</span><span style=color:#000>parameter</span><span style=color:#000>:</span> <span style=color:#a90d91>true</span> 
</span></span></code></pre></td></tr></table></div></div></div><p>发起请求时带上参数 format=xml 或 format=json 即可（仅支持这两种）。</p><h2 id=自定义messageconverter>自定义MessageConverter</h2><p>实现多协议数据兼容。</p><ul><li><p>标记 ResponseBody 注解，调用 RequestResponseBodyMethodProcessor 处理</p></li><li><p>Processor 处理方法返回值，通过 MessageConverter 处理</p></li><li><p>所有 MessageConverter 组织起来可以支持各种媒体类型的数据操作（读写）</p></li><li><p>内容协商找到最佳的 MessageConverter
自定义步骤：</p></li><li><p>添加自定义的 MessageConverter 到系统容器中</p></li><li><p>系统会自动统计出所有 MessageConverter 支持操作的数据类型</p></li><li><p>客户端内容协商</p></li></ul><h3 id=herbmessageconverter>HerbMessageConverter</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.chnherb.boot.converter</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>HerbConverter</span> <span style=color:#a90d91>implements</span> <span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;</span><span style=color:#000>Car</span><span style=color:#000>&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// @ResponseBody 能读能写，这里不关注读功能，都为 false
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>canRead</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span> <span style=color:#000>mediaType</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>canWrite</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span> <span style=color:#000>mediaType</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>clazz</span><span style=color:#000>.</span><span style=color:#836c28>isAssignableFrom</span><span style=color:#000>(</span><span style=color:#000>Car</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 服务器统计所有 MessageConverter 支持的媒体类型
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>MediaType</span><span style=color:#000>&gt;</span> <span style=color:#000>getSupportedMediaTypes</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>parseMediaTypes</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;application/x-herb&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Car</span> <span style=color:#000>read</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?</span> <span style=color:#a90d91>extends</span> <span style=color:#000>Car</span><span style=color:#000>&gt;</span> <span style=color:#000>clazz</span><span style=color:#000>,</span> <span style=color:#000>HttpInputMessage</span> <span style=color:#000>inputMessage</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>HttpMessageNotReadableException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>write</span><span style=color:#000>(</span><span style=color:#000>Car</span> <span style=color:#000>car</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span> <span style=color:#000>contentType</span><span style=color:#000>,</span> <span style=color:#000>HttpOutputMessage</span> <span style=color:#000>outputMessage</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>HttpMessageNotWritableException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 自定义协议数据的写
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>String</span> <span style=color:#000>data</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;yyds: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>car</span><span style=color:#000>.</span><span style=color:#836c28>getBrand</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;; &#34;</span> <span style=color:#000>+</span> <span style=color:#000>car</span><span style=color:#000>.</span><span style=color:#836c28>getPrice</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 写出去
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>OutputStream</span> <span style=color:#000>body</span> <span style=color:#000>=</span> <span style=color:#000>outputMessage</span><span style=color:#000>.</span><span style=color:#836c28>getBody</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>body</span><span style=color:#000>.</span><span style=color:#836c28>write</span><span style=color:#000>(</span><span style=color:#000>data</span><span style=color:#000>.</span><span style=color:#836c28>getBytes</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=webmvcconfigurer配置类>WebMvcConfigurer配置类</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.chnherb.boot.config</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@Configuration</span><span style=color:#000>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>)</span> <span style=color:#177500>// 没有依赖可以配置成 false
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>WebConfig</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span> <span style=color:#177500>// 1、注入 WebMvcConfigurer
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>public</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#000>webMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>WebMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 扩展 MessageConverters，注意不是配置 configureMessageConverters 覆盖
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 请求方式
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// curl &#39;http://localhost:8888/getCar&#39; \
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>//       -H &#39;Accept: application/x-herb&#39;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>extendMessageConverters</span><span style=color:#000>(</span><span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#000>&lt;?&gt;&gt;</span> <span style=color:#000>converters</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>converters</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>HerbConverter</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>};</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=调用方式>调用方式</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl <span style=color:#c41a16>&#39;http://localhost:8888/getCar&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>  -H <span style=color:#c41a16>&#39;Accept: application/x-herb&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意这里不支持基于参数的请求方式：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl <span style=color:#c41a16>&#39;http://localhost:8888/getCar?format=x-herb&#39;</span> <span style=color:#177500># 无响应</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=自定义内容协商协议>自定义内容协商协议</h3><p>为了解决上面说的自定义 MessageConverter 不支持基于参数的请求方式，在 WebMvcConfigurer 配置中覆盖 configureContentNegotiation 方法即可</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 自定义内容协商策略，默认只有 json 和 xml
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#000>webMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>WebMvcConfigurer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span>      <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>configureContentNegotiation</span><span style=color:#000>(</span><span style=color:#000>ContentNegotiationConfigurer</span> <span style=color:#000>configurer</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span><span style=color:#000>&gt;</span> <span style=color:#000>mediaTypes</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HashMap</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>          <span style=color:#000>mediaTypes</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;json&#34;</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>APPLICATION_JSON</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>          <span style=color:#000>mediaTypes</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;xml&#34;</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>APPLICATION_XML</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>          <span style=color:#000>mediaTypes</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;x-herb&#34;</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>parseMediaType</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;application/x-herb&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>          <span style=color:#177500>// 指定支持解析哪些参数对应的媒体类型 mediaType
</span></span></span><span style=display:flex><span><span style=color:#177500></span>          <span style=color:#000>ParameterContentNegotiationStrategy</span> <span style=color:#000>parameterStrategy</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ParameterContentNegotiationStrategy</span><span style=color:#000>(</span><span style=color:#000>mediaTypes</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>          <span style=color:#000>HeaderContentNegotiationStrategy</span> <span style=color:#000>headerStrategy</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HeaderContentNegotiationStrategy</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>          <span style=color:#000>configurer</span><span style=color:#000>.</span><span style=color:#836c28>strategies</span><span style=color:#000>(</span><span style=color:#000>Arrays</span><span style=color:#000>.</span><span style=color:#836c28>asList</span><span style=color:#000>(</span><span style=color:#000>parameterStrategy</span><span style=color:#000>,</span> <span style=color:#000>headerStrategy</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>...</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这里请求参数加上 format 可以发现有自定义响应。
注意事项：自定义功能可能会导致默认功能失效，如这里的 HeaderContentNegotiationStrategy，如果自定义就无法支持请求头的转换方式。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cc2dcb103f46678448ff073b15e743a7>9 - SpringBoot-03Web组件</h1><h1 id=视图解析与模板引擎>视图解析与模板引擎</h1><h2 id=视图解析>视图解析</h2><p>视图处理处理方式</p><ul><li>转发</li><li>重定向</li><li>自定义视图</li></ul><h3 id=视图解析原理流程>视图解析原理流程</h3><p>核心方法：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>org</span><span style=color:#000>.</span><span style=color:#836c28>springframework</span><span style=color:#000>.</span><span style=color:#836c28>web</span><span style=color:#000>.</span><span style=color:#836c28>servlet</span><span style=color:#000>.</span><span style=color:#836c28>DispatcherServlet</span><span style=color:#000>#</span><span style=color:#000>doDispatch</span>
</span></span></code></pre></td></tr></table></div></div></div><ol><li>目标方法处理过程中，所有数据都会放在 ModelAndViewContainer 中，包括数据和视图地址。</li><li>方法的参数是自定义类型对象（从请求参数中确定），会重新放在 ModelAndViewContainer 中。</li><li>任何目标方法执行完成后都会返回 ModelAndView（数据和视图地址）</li><li>processDispatchResult 处理派发结果（页面如何响应）<ol><li>render(mv, request, response); 进行页面渲染逻辑，根据方法的String返回值得到View对象<ol><li>遍历所有的视图解析器能否支持根据当前返回值得到View对象</li><li>创建RedirectView 对象（org.thymeleaf.spring5.view.ThymeleafViewResolver#createView）</li><li>view.render(mv.getModelInternal(), request, response)
视图解析：</li></ol></li></ol></li></ol><ul><li>返回值以 forward: 开始： new InternalResourceView(forwardUrl); 转发request.getRequestDispatcher(path).forward(request, response);</li><li>返回值以 redirect: 开始： new RedirectView() ， render就是重定向</li><li>返回值是普通字符串： new ThymeleafView（）</li></ul><h2 id=模板引擎-thymeleaf>模板引擎-Thymeleaf</h2><h3 id=thymeleaf简介>thymeleaf简介</h3><p><strong>Thymeleaf</strong> is a modern server-side Java template engine for both web and standalone environments.</p><p><strong>服务端Java模板引擎</strong></p><p>thymeleaf 官网地址：<a href=https://www.thymeleaf.org/>https://www.thymeleaf.org/</a></p><p>doc：<a href=https://www.thymeleaf.org/documentation.html>documentation</a> ->(Read online) <a href=https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html>usingthymeleaf</a></p><h3 id=基本语法>基本语法</h3><h4 id=表达式>表达式</h4><p><a href=https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#standard-expression-syntax>https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#standard-expression-syntax</a></p><table><thead><tr><th style=text-align:left>表达式名字</th><th style=text-align:left>语法</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left>变量取值</td><td style=text-align:left>${...}</td><td style=text-align:left>获取请求域、session域、对象等值</td></tr><tr><td style=text-align:left>选择变量</td><td style=text-align:left>*{...}</td><td style=text-align:left>获取上下文对象值</td></tr><tr><td style=text-align:left>消息</td><td style=text-align:left>#{...}</td><td style=text-align:left>获取国际化等值</td></tr><tr><td style=text-align:left>链接</td><td style=text-align:left>@{...}</td><td style=text-align:left>生成链接</td></tr><tr><td style=text-align:left>片段表达式</td><td style=text-align:left>~{...}</td><td style=text-align:left>jsp:include作用，引入公共页面片段</td></tr></tbody></table><h4 id=字面量>字面量</h4><p>文本值: **'one text' , 'Another one!' ,…**数字: **0 , 34 , 3.0 , 12.3 ,…**布尔值: <strong>true , false</strong></p><p>空值: <strong>null</strong></p><p>变量： one，two，.... 变量不能有空格</p><h4 id=文本操作>文本操作</h4><p>字符串拼接: <strong>+</strong></p><p>变量替换: <strong>|The name is ${name}|</strong></p><h4 id=数学运算>数学运算</h4><p>运算符: + , - , * , / , %</p><h4 id=布尔运算>布尔运算</h4><p>运算符: <strong>and , or</strong></p><p>一元运算: <strong>! , not</strong></p><h4 id=比较运算>比较运算</h4><p>比较: **> , &lt; , >= , &lt;= ( gt , lt , ge , le )**等式: <strong>== , != ( eq , ne )</strong></p><h4 id=条件运算>条件运算</h4><p>If-then: <strong>(if) ? (then)</strong></p><p>If-then-else: <strong>(if) ? (then) : (else)</strong></p><p>Default: (value) <strong>?: (defaultvalue)</strong></p><h4 id=特殊操作>特殊操作</h4><p>无操作： _</p><h3 id=设置属性值>设置属性值</h3><p>-th:attr</p><p>设置单个值</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;form action=&#34;subscribe.html&#34; th:attr=&#34;action=@{/subscribe}&#34;&gt;
</span></span><span style=display:flex><span>  &lt;fieldset&gt;
</span></span><span style=display:flex><span>    &lt;input type=&#34;text&#34; name=&#34;email&#34; /&gt;
</span></span><span style=display:flex><span>    &lt;input type=&#34;submit&#34; value=&#34;Subscribe!&#34; th:attr=&#34;value=#{subscribe.submit}&#34;/&gt;
</span></span><span style=display:flex><span>  &lt;/fieldset&gt;
</span></span><span style=display:flex><span>&lt;/form&gt;
</span></span></code></pre></td></tr></table></div></div></div><p>设置多个值<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;img src=&#34;../../images/gtvglogo.png&#34;  th:attr=&#34;src=@{/images/gtvglogo.png},title=#{logo},alt=#{logo}&#34; /&gt;
</span></span></code></pre></td></tr></table></div></div></div></p><p>以上两个的代替写法 th:xxxx</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;input type=&#34;submit&#34; value=&#34;Subscribe!&#34; th:value=&#34;#{subscribe.submit}&#34;/&gt;
</span></span><span style=display:flex><span>&lt;form action=&#34;subscribe.html&#34; th:action=&#34;@{/subscribe}&#34;&gt;
</span></span></code></pre></td></tr></table></div></div></div><p>所有h5兼容的标签写法</p><p><a href=https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#setting-value-to-specific-attributes>https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#setting-value-to-specific-attributes</a></p><h3 id=迭代>迭代</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;tr</span> <span style=color:#836c28>th:each=</span><span style=color:#c41a16>&#34;prod : ${prods}&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;td</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${prod.name}&#34;</span><span style=color:#000>&gt;</span>Onions<span style=color:#000>&lt;/td&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;td</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${prod.price}&#34;</span><span style=color:#000>&gt;</span>2.41<span style=color:#000>&lt;/td&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;td</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${prod.inStock}? #{true} : #{false}&#34;</span><span style=color:#000>&gt;</span>yes<span style=color:#000>&lt;/td&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/tr&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;tr</span> <span style=color:#836c28>th:each=</span><span style=color:#c41a16>&#34;prod,iterStat : ${prods}&#34;</span> <span style=color:#836c28>th:class=</span><span style=color:#c41a16>&#34;${iterStat.odd}? &#39;odd&#39;&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;td</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${prod.name}&#34;</span><span style=color:#000>&gt;</span>Onions<span style=color:#000>&lt;/td&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;td</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${prod.price}&#34;</span><span style=color:#000>&gt;</span>2.41<span style=color:#000>&lt;/td&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;td</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${prod.inStock}? #{true} : #{false}&#34;</span><span style=color:#000>&gt;</span>yes<span style=color:#000>&lt;/td&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/tr&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=条件运算-1>条件运算</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;a</span> <span style=color:#836c28>href=</span><span style=color:#c41a16>&#34;comments.html&#34;</span>
</span></span><span style=display:flex><span><span style=color:#836c28>th:href=</span><span style=color:#c41a16>&#34;@{/product/comments(prodId=${prod.id})}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#836c28>th:if=</span><span style=color:#c41a16>&#34;${not #lists.isEmpty(prod.comments)}&#34;</span><span style=color:#000>&gt;</span>view<span style=color:#000>&lt;/a&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;div</span> <span style=color:#836c28>th:switch=</span><span style=color:#c41a16>&#34;${user.role}&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;p</span> <span style=color:#836c28>th:case=</span><span style=color:#c41a16>&#34;&#39;admin&#39;&#34;</span><span style=color:#000>&gt;</span>User is an administrator<span style=color:#000>&lt;/p&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;p</span> <span style=color:#836c28>th:case=</span><span style=color:#c41a16>&#34;#{roles.manager}&#34;</span><span style=color:#000>&gt;</span>User is a manager<span style=color:#000>&lt;/p&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;p</span> <span style=color:#836c28>th:case=</span><span style=color:#c41a16>&#34;*&#34;</span><span style=color:#000>&gt;</span>User is some other thing<span style=color:#000>&lt;/p&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/div&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=属性优先级>属性优先级</h3><p><a href=https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#attribute-precedence>https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#attribute-precedence</a></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>Feature</th><th style=text-align:left>Attributes</th></tr></thead><tbody><tr><td style=text-align:left>1</td><td style=text-align:left>Fragment inclusion</td><td style=text-align:left>th:insert<br>th:replace</td></tr><tr><td style=text-align:left>2</td><td style=text-align:left>Fragment iteration</td><td style=text-align:left>th:each</td></tr><tr><td style=text-align:left>3</td><td style=text-align:left>Conditional evaluation</td><td style=text-align:left>th:if<br>th:unless<br>th:switch<br>th:case</td></tr><tr><td style=text-align:left>4</td><td style=text-align:left>Local variable definition</td><td style=text-align:left>th:object<br>th:with</td></tr><tr><td style=text-align:left>5</td><td style=text-align:left>General attribute modification</td><td style=text-align:left>th:attr<br>th:attrprepend<br>th:attrappend</td></tr><tr><td style=text-align:left>6</td><td style=text-align:left>Specific attribute modification</td><td style=text-align:left>th:value<br>th:href<br>th:src<br>...</td></tr><tr><td style=text-align:left>7</td><td style=text-align:left>Text (tag body modification)</td><td style=text-align:left>th:text<br>th:utext</td></tr><tr><td style=text-align:left>8</td><td style=text-align:left>Fragment specification</td><td style=text-align:left>th:fragment</td></tr><tr><td style=text-align:left>9</td><td style=text-align:left>Fragment removal</td><td style=text-align:left>th:remove</td></tr></tbody></table><h2 id=thymeleaf使用>thymeleaf使用</h2><h3 id=引入starter>引入starter</h3><p><a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters>using spring boot # build-systems.starters</a></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=自动配置原理>自动配置原理</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Configuration</span><span style=color:#000>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@EnableConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>ThymeleafProperties</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnClass</span><span style=color:#000>({</span> <span style=color:#000>TemplateMode</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>SpringTemplateEngine</span><span style=color:#000>.</span><span style=color:#836c28>class</span> <span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#000>@AutoConfigureAfter</span><span style=color:#000>({</span> <span style=color:#000>WebMvcAutoConfiguration</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>WebFluxAutoConfiguration</span><span style=color:#000>.</span><span style=color:#836c28>class</span> <span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ThymeleafAutoConfiguration</span> <span style=color:#000>{</span> <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>自动配置的策略：</p><p>1、所有的配置值都在 ThymeleafProperties</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>DEFAULT_PREFIX</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;classpath:/templates/&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>DEFAULT_SUFFIX</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;.html&#34;</span><span style=color:#000>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、配置了 SpringTemplateEngine
3、配置了 ThymeleafViewResolver</p><p>用户只要导入依赖包自动配置然后直接开发页面即可。</p><h3 id=页面开发>页面开发</h3><p>controller</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ViewController</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@GetMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/thyinfo&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>thyInfo</span><span style=color:#000>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// model 中的数据会被放在请求域中 request.setAttribute(&#34;msg&#34;, aa)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>model</span><span style=color:#000>.</span><span style=color:#836c28>addAttribute</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;msg&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;hello thyinfo&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;thyinfo&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>模板页面<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#633820>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;html</span> <span style=color:#836c28>lang=</span><span style=color:#c41a16>&#34;en&#34;</span> <span style=color:#836c28>xmlns:th=</span><span style=color:#c41a16>&#34;http://www.thymeleaf.org&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;head&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;meta</span> <span style=color:#836c28>charset=</span><span style=color:#c41a16>&#34;UTF-8&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;title&gt;</span>thyinfo<span style=color:#000>&lt;/title&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/head&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;body&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;h1</span> <span style=color:#836c28>th:text=</span><span style=color:#c41a16>&#34;${msg}&#34;</span><span style=color:#000>&gt;</span>info<span style=color:#000>&lt;/h1&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/body&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/html&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=拦截器>拦截器</h1><h2 id=handlerinterceptor接口>HandlerInterceptor接口</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>LoginInterceptor</span> <span style=color:#a90d91>implements</span> <span style=color:#000>HandlerInterceptor</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Logger</span> <span style=color:#000>log</span> <span style=color:#000>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#000>.</span><span style=color:#836c28>getLogger</span><span style=color:#000>(</span><span style=color:#000>LoginInterceptor</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 目标方法执行之前
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>preHandle</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>handler</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>requestURI</span> <span style=color:#000>=</span> <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getRequestURI</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;preHandle拦截的请求路径是{}&#34;</span><span style=color:#000>,</span> <span style=color:#000>requestURI</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>//登录检查逻辑
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>HttpSession</span> <span style=color:#000>session</span> <span style=color:#000>=</span> <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getSession</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Object</span> <span style=color:#000>loginUser</span> <span style=color:#000>=</span> <span style=color:#000>session</span><span style=color:#000>.</span><span style=color:#836c28>getAttribute</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;loginUser&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>loginUser</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>//放行
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>//拦截住。未登录。跳转到登录页
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>setAttribute</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;msg&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;请先登录&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        re.sendRedirect(&#34;/&#34;);
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#836c28>getRequestDispatcher</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/error&#34;</span><span style=color:#000>).</span><span style=color:#836c28>forward</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 目标方法执行完成以后
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>postHandle</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>handler</span><span style=color:#000>,</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>modelAndView</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;postHandle执行{}&#34;</span><span style=color:#000>,</span> <span style=color:#000>modelAndView</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 页面渲染完成之后
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>afterCompletion</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>handler</span><span style=color:#000>,</span> <span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;afterCompletion Exception={}&#34;</span><span style=color:#000>,</span> <span style=color:#000>ex</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=配置拦截器>配置拦截器</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>InterceptorConfig</span> <span style=color:#a90d91>implements</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>addInterceptors</span><span style=color:#000>(</span><span style=color:#000>InterceptorRegistry</span> <span style=color:#000>registry</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>registry</span><span style=color:#000>.</span><span style=color:#836c28>addInterceptor</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>LoginInterceptor</span><span style=color:#000>())</span>
</span></span><span style=display:flex><span>                <span style=color:#000>.</span><span style=color:#836c28>addPathPatterns</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/**&#34;</span><span style=color:#000>)</span>   <span style=color:#177500>//  /** 默认拦截所有路径
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>.</span><span style=color:#836c28>excludePathPatterns</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;/error&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=拦截器原理>拦截器原理</h2><p>核心代码入口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#doDispatch
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>mappedHandler</span> <span style=color:#000>=</span> <span style=color:#000>getHandler</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>);</span> <span style=color:#177500>// 类型 HandlerExecutionChain
</span></span></span></code></pre></td></tr></table></div></div></div><ol><li>根据当前请求找到 HandlerExecutionChain，即 handler 及其所有拦截器。mappedHandler 中包含了 HandlerInterceptor 列表</li><li>顺序执行 所有拦截器的 preHandle 方法<ol><li>如果返回为 true 则执行下一个拦截器的 preHandle</li><li>如果返回为 false 则倒序执行已经执行拦截器的 afterCompletion 方法</li></ol></li><li>任何一个拦截器返回 false，直接跳出不会执行目标方法</li><li>所有拦截器都返回 true，执行目标方法</li><li>倒序执行所有拦截器的 postHandle 方法</li><li>前面步骤任何异常都会直接倒序触发已经执行了拦截器的 afterCompletion 方法</li><li>页面成功渲染之后，也会倒序触发 afterCompletion 方法
流程图如下：</li></ol><p><img src=../imgs/spring-boot-03-221015_1.png alt=spring-boot-03-221015_1.png></p><h1 id=文件上传>文件上传</h1><h2 id=页面表单>页面表单</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;form</span> <span style=color:#836c28>method=</span><span style=color:#c41a16>&#34;post&#34;</span> <span style=color:#836c28>action=</span><span style=color:#c41a16>&#34;/upload&#34;</span> <span style=color:#836c28>enctype=</span><span style=color:#c41a16>&#34;multipart/form-data&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;file&#34;</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;file&#34;</span><span style=color:#000>&gt;&lt;br&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;input</span> <span style=color:#836c28>type=</span><span style=color:#c41a16>&#34;submit&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;提交&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/form&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=文件上传-1>文件上传</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@ResponseBody</span>
</span></span><span style=display:flex><span><span style=color:#000>@PostMapping</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/upload&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>String</span> <span style=color:#000>upload</span><span style=color:#000>(</span><span style=color:#000>@RequestParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;email&#34;</span><span style=color:#000>)</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>@RequestParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;username&#34;</span><span style=color:#000>)</span> <span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>@RequestParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;header&#34;</span><span style=color:#000>)</span> <span style=color:#000>MultipartFile</span> <span style=color:#000>header</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>@RequestParam</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;photos&#34;</span><span style=color:#000>)</span> <span style=color:#000>MultipartFile</span><span style=color:#000>[]</span> <span style=color:#000>photos</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>originFilename</span> <span style=color:#000>=</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getOriginalFilename</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>transferTo</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>File</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/Users/bo/code/spring-boot-demo/&#34;</span> <span style=color:#000>+</span> <span style=color:#000>originFilename</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>photos</span><span style=color:#000>.</span><span style=color:#836c28>length</span> <span style=color:#000>&gt;</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>MultipartFile</span> <span style=color:#000>photo</span> <span style=color:#000>:</span> <span style=color:#000>photos</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>photo</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>String</span> <span style=color:#000>originFilename</span> <span style=color:#000>=</span> <span style=color:#000>photo</span><span style=color:#000>.</span><span style=color:#836c28>getOriginalFilename</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>photo</span><span style=color:#000>.</span><span style=color:#836c28>transferTo</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>File</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/Users/bo/code/spring-boot-demo/&#34;</span> <span style=color:#000>+</span> <span style=color:#000>originFilename</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;upload success&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=自动配置原理-1>自动配置原理</h2><p>文件上传自动配置类 MultipartAutoConfiguration 自动配置了 StandardServletMultipartResolver（文件上传解析器）和 MultipartProperties</p><p>自动配置代码：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration
</span></span></span></code></pre></td></tr></table></div></div></div><p>文件上传源码入口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>processedRequest</span> <span style=color:#000>=</span> <span style=color:#000>checkMultipart</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>原理步骤：</p><ol><li>请求进来使用文件上传解析器判断（isMultipart）并封装（resolveMultipart，返回MultipartHttpServletRequest）文件上传请求</li><li>参数解析器来解析请求中的文件内容封装成 MultipartFile</li><li>将request中文件信息封装为一个Map；MultiValueMap&lt;String, MultipartFile>
FileCopyUtils。实现文件流的拷贝。</li></ol><h1 id=异常处理>异常处理</h1><p>官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.reactive.webflux.error-handling>web # error-handling</a></p><h2 id=错误处理>错误处理</h2><h3 id=默认规则>默认规则</h3><ul><li><p>默认情况下，Spring Boot提供<code>/error</code>处理所有错误的映射</p></li><li><p>对于机器客户端，它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息。对于浏览器客户端，响应一个“ whitelabel”错误视图，以HTML格式呈现相同的数据<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#177500>// json格式：(页面可直接取该变量值进行显示)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>{
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;timestamp&#34;</span>: <span style=color:#c41a16>&#34;xxx&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;status&#34;</span>: <span style=color:#1c01ce>404</span>,
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;error&#34;</span>: <span style=color:#c41a16>&#34;xxxx&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;message&#34;</span>: <span style=color:#c41a16>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;path&#34;</span>: <span style=color:#c41a16>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p></li><li><p>要完全替换默认行为，可以实现 <code>ErrorController</code>并注册该类型的Bean定义，或添加<code>ErrorAttributes类型的组件</code>以使用现有机制但替换其内容。</p></li><li><p>error/下的4xx，5xx页面会被自动解析；</p></li></ul><h2 id=定制错误处理逻辑>定制错误处理逻辑</h2><ul><li>自定义错误页<ul><li>error/404.html error/5xx.html；有精确的错误状态码页面就匹配精确，没有就找 4xx.html；如果都没有就触发白页</li></ul></li><li>@ControllerAdvice+@ExceptionHandler处理全局异常；底层是 <strong>ExceptionHandlerExceptionResolver 支持的</strong></li><li>@ResponseStatus+自定义异常 ；底层是 <strong>ResponseStatusExceptionResolver ，把responsestatus注解的信息底层调用 response.sendError(statusCode, resolvedReason)；tomcat发送的/error</strong></li><li>Spring底层的异常，如 参数类型转换异常；<strong>DefaultHandlerExceptionResolver 处理框架底层的异常。</strong><ul><li>response.sendError(HttpServletResponse.<strong>SC_BAD_REQUEST</strong>, ex.getMessage()); </li></ul></li><li>自定义实现 HandlerExceptionResolver 处理异常；可以作为默认的全局异常处理规则</li><li><strong>ErrorViewResolver</strong> 实现自定义处理异常；<ul><li>response.sendError 。error请求就会转给controller</li><li>异常没有任何人能处理。tomcat底层 response.sendError。error请求就会转给controller</li><li>basicErrorController 要去的页面地址是 ErrorViewResolver ；</li></ul></li></ul><h2 id=异常处理自动配置原理>异常处理自动配置原理</h2><p>自动配置类：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ErrorMvcAutoConfiguration</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该类用于自动配置异常处理规则。
容器中的组件：</p><p>1、DefaultErrorAttributes</p><p>定义错误页面中可以包含哪些数据，如 timestamp、error、message 等</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.web.servlet.error.DefaultErrorAttributes#getErrorAttributes
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>getErrorAttributes</span><span style=color:#000>(</span><span style=color:#000>WebRequest</span> <span style=color:#000>webRequest</span><span style=color:#000>,</span> <span style=color:#000>ErrorAttributeOptions</span> <span style=color:#000>options</span><span style=color:#000>)</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、BasicErrorController</p><p>处理默认 /error 路径的请求。</p><p>根据请求的不同（produces = MediaType.TEXT_HTML_VALUE）响应页面或者 json。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController#errorHtml
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@RequestMapping</span><span style=color:#000>(</span><span style=color:#000>produces</span> <span style=color:#000>=</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>TEXT_HTML_VALUE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>errorHtml</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>HttpStatus</span> <span style=color:#000>status</span> <span style=color:#000>=</span> <span style=color:#000>getStatus</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>model</span> <span style=color:#000>=</span> <span style=color:#000>Collections</span>
</span></span><span style=display:flex><span>         <span style=color:#000>.</span><span style=color:#836c28>unmodifiableMap</span><span style=color:#000>(</span><span style=color:#000>getErrorAttributes</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>getErrorAttributeOptions</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>MediaType</span><span style=color:#000>.</span><span style=color:#836c28>TEXT_HTML</span><span style=color:#000>)));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>response</span><span style=color:#000>.</span><span style=color:#836c28>setStatus</span><span style=color:#000>(</span><span style=color:#000>status</span><span style=color:#000>.</span><span style=color:#836c28>value</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ModelAndView</span> <span style=color:#000>modelAndView</span> <span style=color:#000>=</span> <span style=color:#000>resolveErrorView</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>status</span><span style=color:#000>,</span> <span style=color:#000>model</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>(</span><span style=color:#000>modelAndView</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>?</span> <span style=color:#000>modelAndView</span> <span style=color:#000>:</span> <span style=color:#a90d91>new</span> <span style=color:#000>ModelAndView</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;error&#34;</span><span style=color:#000>,</span> <span style=color:#000>model</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>@RequestMapping</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ResponseEntity</span><span style=color:#000>&lt;</span><span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;&gt;</span> <span style=color:#000>error</span><span style=color:#000>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>3、BeanNameViewResolver</p><p>视图解析器，按照返回的视图名作为组件的 id 去容器中寻找 View 对象。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration.WhitelabelErrorViewConfiguration#beanNameViewResolver
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>BeanNameViewResolver</span> <span style=color:#000>beanNameViewResolver</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>BeanNameViewResolver</span> <span style=color:#000>resolver</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>BeanNameViewResolver</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#000>resolver</span><span style=color:#000>.</span><span style=color:#836c28>setOrder</span><span style=color:#000>(</span><span style=color:#000>Ordered</span><span style=color:#000>.</span><span style=color:#836c28>LOWEST_PRECEDENCE</span> <span style=color:#000>-</span> <span style=color:#000>10</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>resolver</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>4、DefaultErrorViewResolver</p><p>如果发生错误，会以HTTP的状态码 作为视图页地址（viewName），寻找真正的页面如：error/404、5xx.html</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration.DefaultErrorViewResolverConfiguration#conventionErrorViewResolver
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnBean</span><span style=color:#000>(</span><span style=color:#000>DispatcherServlet</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnMissingBean</span><span style=color:#000>(</span><span style=color:#000>ErrorViewResolver</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>DefaultErrorViewResolver</span> <span style=color:#000>conventionErrorViewResolver</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>DefaultErrorViewResolver</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>applicationContext</span><span style=color:#000>,</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>resourceProperties</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=异常处理流程>异常处理流程</h2><p>1、执行目标方法，目标方法任何异常都会被 catch 且标记请求结束，并用 <strong>dispatchException</strong></p><p>保存异常信息。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#doDispatch
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>mv</span> <span style=color:#000>=</span> <span style=color:#000>ha</span><span style=color:#000>.</span><span style=color:#836c28>handle</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>mappedHandler</span><span style=color:#000>.</span><span style=color:#836c28>getHandler</span><span style=color:#000>());</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、进入视图解析流程<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>processDispatchResult</span><span style=color:#000>(</span><span style=color:#000>processedRequest</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>mappedHandler</span><span style=color:#000>,</span> <span style=color:#000>mv</span><span style=color:#000>,</span> <span style=color:#000>dispatchException</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>3、处理 handler 异常</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.web.servlet.DispatcherServlet#processDispatchResult
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>mv</span> <span style=color:#000>=</span> <span style=color:#000>processHandlerException</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>,</span> <span style=color:#000>response</span><span style=color:#000>,</span> <span style=color:#000>handler</span><span style=color:#000>,</span> <span style=color:#000>exception</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>1）遍历所有的处理器异常解析器 handlerExceptionResolvers
2）系统默认的异常解析器 DefaultErrorAttributes 先处理异常，会把异常信息保存到 request 域中且返回 null。</p><ul><li>没有能处理的最终底层会发送 /error 请求，继而被 BasicErrorController 处理</li><li>解析错误试图，遍历所有的 ErrorViewResolver</li><li>默认的 DefaultErrorViewResolver 将响应状态码作为错误页的地址</li><li>模板引擎最终响应 error/xxx.html</li></ul><h1 id=web原生组件注入>Web原生组件注入</h1><p>官方参考文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.embedded-container>web # web.servlet.embedded-container</a></p><p>Servlets, Filters, and listeners</p><p>根据官方文档描述，有如下两种方式可以注入上述组件。</p><h2 id=servlet-api>Servlet API</h2><p>1、编写自定义 MyServlet</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@WebServlet</span><span style=color:#000>(</span><span style=color:#000>urlPatterns</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;/my&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyServlet</span> <span style=color:#a90d91>extends</span> <span style=color:#000>HttpServlet</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、启动类配置 @ServletComponentScan(basePackages = "com.chnherb.boot")
3、编写自定义 MyFilter</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@WebFilter</span><span style=color:#000>(</span><span style=color:#000>urlPatterns</span> <span style=color:#000>=</span> <span style=color:#000>{</span><span style=color:#c41a16>&#34;/css/*&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;/images/*&#34;</span><span style=color:#000>})</span>  
</span></span><span style=display:flex><span><span style=color:#177500>// * 是servlet的写法，** 是spring的写法
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyFilter</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Filter</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>4、编写自定义 MyListener<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@WebListener</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyListener</span> <span style=color:#a90d91>implements</span> <span style=color:#000>ServletContextListener</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=registrationbean>RegistrationBean</h2><p><code>ServletRegistrationBean</code>, <code>FilterRegistrationBean</code>, and <code>ServletListenerRegistrationBean</code> 。</p><p>推荐使用该方式。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyRegistConfig</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>ServletRegistrationBean</span> <span style=color:#000>myServlet</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>MyServlet</span> <span style=color:#000>myServlet</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>MyServlet</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServletRegistrationBean</span><span style=color:#000>(</span><span style=color:#000>myServlet</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;/my&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;/my2&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>FilterRegistrationBean</span> <span style=color:#000>myFilter</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>MyFilter</span> <span style=color:#000>myFilter</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>MyFilter</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        // 第一种写法：配置拦截 servlet
</span></span></span><span style=display:flex><span><span style=color:#177500>//        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(myFilter, myServlet());
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#177500>// 第二种写法：自定义 urlPatterns
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>FilterRegistrationBean</span> <span style=color:#000>filterRegistrationBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FilterRegistrationBean</span><span style=color:#000>(</span><span style=color:#000>myFilter</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>filterRegistrationBean</span><span style=color:#000>.</span><span style=color:#836c28>setUrlPatterns</span><span style=color:#000>(</span><span style=color:#000>Arrays</span><span style=color:#000>.</span><span style=color:#836c28>asList</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/images/*&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>return</span> <span style=color:#000>filterRegistrationBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>ServletListenerRegistrationBean</span> <span style=color:#000>myListener</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>MyListener</span> <span style=color:#000>myListener</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>MyListener</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServletListenerRegistrationBean</span><span style=color:#000>(</span><span style=color:#000>myListener</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=扩展-dispatcherservlet注册>扩展：DispatcherServlet注册</h2><p>问：为什么上文 servlet 路径 /my 等没有被 spring 的 DispatchServlet 拦截？</p><p>DispatcherServlet 通过 DispatcherServletAutoConfiguration 注册：</p><ul><li>容器中自动配置了 DispatcherServlet 属性绑定到 WebMvcProperties；对应的配置文件配置项是 <strong>spring.mvc。</strong></li><li><strong>通过 ServletRegistrationBean</strong><dispatcherservlet> 把 DispatcherServlet 配置进来。</li><li>默认映射的是 / 路径。
Tomcat-Servlet 精准优先匹配原则：</li></ul><p>多个Servlet都能处理到同一层路径，精确优选匹配原则，即能匹配到 /my 就不会匹配 /。</p><p><img src=../imgs/spring-boot-03-221015_2.png alt=spring-boot-03-221015_2.png></p><h1 id=嵌入式servlet容器>嵌入式Servlet容器</h1><p>根据官方文档 <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.embedded-container>web # web.servlet.embedded-container</a> 介绍，支持的嵌入式 Servlet 容器有 Tomcat、Jetty 和 Undertow.</p><h2 id=基本原理>基本原理</h2><p>（参考 <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.embedded-container.application-context>web # web.servlet.embedded-container.application-context</a>）</p><ul><li>SpringBoot 应用启动发现当前是 Web 应用则会导入 tomcat</li><li>Web 应用会创建一个 web 版的 ioc 容器 ServletWebServerApplicationContext</li><li>ServletWebServerApplicationContext 容器启动寻找 ServletWebServerFactory（Servlet 的服务器工厂） 并引导创建 Servlet 服务器。</li><li>SpringBoot 底层默认有很多 WebServer 工厂如 TomcatServletWebServerFactory、JettyServletWebServerFactory、UndertowServletWebServerFactory<ul><li>底层会有一个自动配置类 ServletWebServerFactoryAutoConfiguration，该类有 Import 了 ServletWebServerFactoryConfiguration</li><li>ServletWebServerFactoryConfiguration 条件装配（根据导入的包）上面三个 XxxWebServerFactory</li><li>以 TomcatServletWebServerFactory 为例会创建出 TomcatWebServer
其实就是将手动启动服务器自动化实现。</li></ul></li></ul><p>创建 WebServer 代码流程</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#createWebServer
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>createWebServer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>WebServer</span> <span style=color:#000>webServer</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>webServer</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span> <span style=color:#000>=</span> <span style=color:#000>getServletContext</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>webServer</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>servletContext</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 找不到或找到多个会抛出异常
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>ServletWebServerFactory</span> <span style=color:#000>factory</span> <span style=color:#000>=</span> <span style=color:#000>getWebServerFactory</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>webServer</span> <span style=color:#000>=</span> <span style=color:#000>factory</span><span style=color:#000>.</span><span style=color:#836c28>getWebServer</span><span style=color:#000>(</span><span style=color:#000>getSelfInitializer</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>      <span style=color:#000>getBeanFactory</span><span style=color:#000>().</span><span style=color:#836c28>registerSingleton</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;webServerGracefulShutdown&#34;</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>new</span> <span style=color:#000>WebServerGracefulShutdownLifecycle</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>webServer</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>getBeanFactory</span><span style=color:#000>().</span><span style=color:#836c28>registerSingleton</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;webServerStartStop&#34;</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>new</span> <span style=color:#000>WebServerStartStopLifecycle</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>,</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>webServer</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>=</span>   
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#000>initPropertySources</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=切换服务器>切换服务器</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-undertow<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=自定义servlet容器>自定义Servlet容器</h2><ul><li>修改配置文件 server.xxx</li><li>直接自定义 ConfigurableServletWebServerFactory（ServletWebServerFactory）</li><li>实现 WebServerFactoryCustomizer<configurableservletwebserverfactory>，把配置文件的值和 ServletWebServerFactory 进行绑定 （参考：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.embedded-container.customizing.programmatic>web # web.servlet.embedded-container.customizing.programmatic</a>）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyWebServerFactoryCustomizer</span> <span style=color:#a90d91>implements</span> <span style=color:#000>WebServerFactoryCustomizer</span><span style=color:#000>&lt;</span><span style=color:#000>ConfigurableServletWebServerFactory</span><span style=color:#000>&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>customize</span><span style=color:#000>(</span><span style=color:#000>ConfigurableServletWebServerFactory</span> <span style=color:#000>server</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>server</span><span style=color:#000>.</span><span style=color:#836c28>setPort</span><span style=color:#000>(</span><span style=color:#000>9000</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><h1 id=定制化总结>定制化总结</h1><p>参考 <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.auto-configuration>web # web.servlet.spring-mvc.auto-configuration</a></p><p>基本思路是：</p><ol><li>导入场景 starter</li><li>xxxAutoConfiguration</li><li>自动配置类导入相关组件</li><li>绑定 xxxProperties</li><li>绑定配置文件</li></ol><h2 id=定制化方法>定制化方法</h2><ul><li>修改配置文件</li><li>自定义配置类 xxxConfiguration + Bean 注入（替换或增加默认组件）</li><li>自定义配置类并实现 WebMvcConfigurer + Bean 注入</li><li>自定义 Customizer</li><li>使用注解@EnableWebMvc + 实现 WebMvcConfigurer + bean 全面接管 SpringMVC，所有规则重新配置（慎用）</li></ul><h2 id=enablewebmvc注解原理>EnableWebMvc注解原理</h2><p>前提：WebMvcAutoConfiguration 默认的SpringMVC的自动配置功能类。包含静态资源、欢迎页等。</p><p>@EnableWebMvc 注解会 @Import(DelegatingWebMvcConfiguration.class)。</p><p>DelegatingWebMvcConfiguration 只保证 SpringMVC 最基本的使用：</p><ul><li>将系统中所有的 WebMvcConfigurer 合并一起作用生效</li><li>该类继承 WebMvcConfigurationSupport</li><li>WebMvcConfigurationSupport 会自动配置一些非常底层的组件，如 RequestMappingHandlerMapping
但是 WebMvcAutoConfiguration 类条件配置生效是</li></ul><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@ConditionalOnMissingBean</span><span style=color:#000>(</span><span style=color:#000>WebMvcConfigurationSupport</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>所以当开启 @EnableWebMvc 注解时，WebMvcAutoConfiguration 就不满足条件配置了。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-01f8ec66bc258c55f0bf36c2725581d4>10 - SpringBoot-04数据访问</h1><h1 id=hikaridatasource>HikariDataSource</h1><h2 id=导入jdbc>导入JDBC</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#177500>&lt;!-- jdbc --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-data-jdbc<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#177500>&lt;!-- mysql 驱动 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>mysql<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>mysql-connector-java<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>jdbc maven 包：</p><p><img src=../imgs/20221029db_1.png alt=20221029db_1.png></p><p>注意：mysql 驱动版本要和实际安装的数据库版本一致。比如本文中 mysql 驱动默认的版本在 spring-boot-starter-parent -> spring-boot-dependencies 中默认为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;mysql.version&gt;</span>8.0.22<span style=color:#000>&lt;/mysql.version&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>如果机器上实际安装的版本不一样就需要修改，方法如下：
1、直接依赖引入具体版本（maven的就近依赖原则）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>mysql<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>mysql-connector-java<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>xxx<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、重新声明版本（maven的属性的就近优先原则）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#000>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;mysql.version&gt;</span>xxx<span style=color:#000>&lt;/mysql.version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/properties&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=自动配置>自动配置</h2><p>自动配置包 spring-boot-autoconfigure 下的 jdbc 目录下，主要的自动配置类有：</p><ul><li>DataSourceAutoConfiguration<ul><li>数据源相关配置：spring.datasource</li><li>容器中没有DataSource才会自动配置</li><li>本场景会自动配置 HikariDataSource</li></ul></li><li>DataSourceTransactionManagerAutoConfiguration： 事务管理器的自动配置</li><li>JdbcTemplateAutoConfiguration： JdbcTemplate的自动配置，可以来对数据库进行crud<ul><li>配置项@ConfigurationProperties(prefix = "spring.jdbc")</li><li>@Bean@Primary JdbcTemplate；容器中有这个组件</li></ul></li><li>JndiDataSourceAutoConfiguration： jndi的自动配置</li><li>XADataSourceAutoConfiguration： 分布式事务相关的</li></ul><h2 id=datasource配置>Datasource配置</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#177500># 导入相关包不配置启动会报错</span>
</span></span><span style=display:flex><span><span style=color:#000>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>url</span>: <span style=color:#1c01ce>jdbc:mysql://localhost:3306/Demo</span>
</span></span><span style=display:flex><span>    <span style=color:#000>username</span>: <span style=color:#1c01ce>root</span>
</span></span><span style=display:flex><span>    <span style=color:#000>password</span>: <span style=color:#1c01ce>root1234</span>
</span></span><span style=display:flex><span>    <span style=color:#000>driver-class-name</span>: <span style=color:#1c01ce>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>#    type: com.zaxxer.hikari.HikariDataSource</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=单测>单测</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#000>@RunWith</span><span style=color:#000>(</span><span style=color:#000>SpringRunner</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@SpringBootTest</span><span style=color:#000>(</span><span style=color:#000>classes</span> <span style=color:#000>=</span> <span style=color:#000>MainApplication</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MainApplicationTest</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#000>JdbcTemplate</span> <span style=color:#000>jdbcTemplate</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>contextLoads</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#177500>//        jdbcTemplate.queryForObject(&#34;select * from user&#34;);
</span></span></span><span style=display:flex><span><span style=color:#177500>//        jdbcTemplate.queryForList(&#34;select * from user&#34;, )
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>Long</span> <span style=color:#000>count</span> <span style=color:#000>=</span> <span style=color:#000>jdbcTemplate</span><span style=color:#000>.</span><span style=color:#836c28>queryForObject</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;select count(*) from user&#34;</span><span style=color:#000>,</span> <span style=color:#000>Long</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;count: {}&#34;</span><span style=color:#000>,</span> <span style=color:#000>count</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=druid数据源>Druid数据源</h1><p>官方Github地址：<a href=https://github.com/alibaba/druid>https://github.com/alibaba/druid</a></p><p>整合第三方技术的两种方式</p><ul><li>自定义</li><li>starter</li></ul><h2 id=自定义使用>自定义使用</h2><h3 id=导入依赖>导入依赖</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>com.alibaba<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>druid<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>1.1.17<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=数据源配置>数据源配置</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;bean</span> <span style=color:#836c28>id=</span><span style=color:#c41a16>&#34;dataSource&#34;</span> <span style=color:#836c28>class=</span><span style=color:#c41a16>&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#836c28>destroy-method=</span><span style=color:#c41a16>&#34;close&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;url&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;${jdbc.url}&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;username&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;${jdbc.username}&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;password&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;${jdbc.password}&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;maxActive&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;20&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;initialSize&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;1&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;maxWait&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;60000&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;minIdle&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;1&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;timeBetweenEvictionRunsMillis&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;60000&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;minEvictableIdleTimeMillis&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;300000&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;testWhileIdle&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;true&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;testOnBorrow&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;false&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;testOnReturn&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;false&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;poolPreparedStatements&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;true&#34;</span> <span style=color:#000>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;maxOpenPreparedStatements&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;20&#34;</span> <span style=color:#000>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>转成config配置<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyDataSourceConfig</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@ConfigurationProperties</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;spring.datasource&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>SQLException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>DruidDataSource</span> <span style=color:#000>druidDataSource</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>DruidDataSource</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>druidDataSource</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxx</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=statviewservlet>StatViewServlet</h3><p>StatViewServlet的用途包括：</p><ul><li>提供监控信息展示的html页面</li><li>提供监控信息的JSON API
xml配置：</li></ul><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#000>&lt;servlet&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;servlet-name&gt;</span>DruidStatView<span style=color:#000>&lt;/servlet-name&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;servlet-class&gt;</span>com.alibaba.druid.support.http.StatViewServlet<span style=color:#000>&lt;/servlet-class&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#000>&lt;/servlet&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#000>&lt;servlet-mapping&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;servlet-name&gt;</span>DruidStatView<span style=color:#000>&lt;/servlet-name&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>&lt;url-pattern&gt;</span>/druid/*<span style=color:#000>&lt;/url-pattern&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#000>&lt;/servlet-mapping&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>转成config配置：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>ServletRegistrationBean</span> <span style=color:#000>statViewServlet</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>StatViewServlet</span> <span style=color:#000>statViewServlet</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>StatViewServlet</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ServletRegistrationBean</span> <span style=color:#000>servletRegistrationBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServletRegistrationBean</span><span style=color:#000>(</span><span style=color:#000>statViewServlet</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;/druid/*&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>servletRegistrationBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=statfilter>StatFilter</h3><p>用于统计监控信息；如SQL监控、URI监控</p><p>xml配置：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>// 需要给数据源中配置如下属性；可以允许多个filter，多个用，分割；如：
</span></span><span style=display:flex><span><span style=color:#000>&lt;property</span> <span style=color:#836c28>name=</span><span style=color:#c41a16>&#34;filters&#34;</span> <span style=color:#836c28>value=</span><span style=color:#c41a16>&#34;stat,slf4j&#34;</span> <span style=color:#000>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>转成config配置：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@ConfigurationProperties</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;spring.datasource&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>SQLException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>DruidDataSource</span> <span style=color:#000>druidDataSource</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>DruidDataSource</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>druidDataSource</span><span style=color:#000>.</span><span style=color:#836c28>setFilters</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;stat,wall&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>druidDataSource</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>FilterRegistrationBean</span> <span style=color:#000>webStatFilter</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>WebStatFilter</span> <span style=color:#000>webStatFilter</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>WebStatFilter</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>FilterRegistrationBean</span><span style=color:#000>&lt;</span><span style=color:#000>WebStatFilter</span><span style=color:#000>&gt;</span> <span style=color:#000>filterRegistrationBean</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FilterRegistrationBean</span><span style=color:#000>&lt;&gt;(</span><span style=color:#000>webStatFilter</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>filterRegistrationBean</span><span style=color:#000>.</span><span style=color:#836c28>setUrlPatterns</span><span style=color:#000>(</span><span style=color:#000>Arrays</span><span style=color:#000>.</span><span style=color:#836c28>asList</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/*&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000>filterRegistrationBean</span><span style=color:#000>.</span><span style=color:#836c28>addInitParameter</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;exclusions&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>filterRegistrationBean</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=starter使用>starter使用</h2><h3 id=引入依赖>引入依赖</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>com.alibaba<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>druid-spring-boot-starter<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>1.1.17<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=自动配置-1>自动配置</h3><ul><li>扩展配置项 spring.datasource.druid</li><li>DruidSpringAopConfiguration.class, 监控SpringBean的；配置项：spring.datasource.druid.aop-patterns</li><li>DruidStatViewServletConfiguration.class, 监控页的配置：spring.datasource.druid.stat-view-servlet；默认开启</li><li>DruidWebStatFilterConfiguration.class, web监控配置；spring.datasource.druid.web-stat-filter；默认开启</li><li>DruidFilterConfiguration.class}) 所有Druid自己filter的配置</li></ul><h3 id=配置示例>配置示例</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>url</span>: <span style=color:#1c01ce>jdbc:mysql://localhost:3306/db_account</span>
</span></span><span style=display:flex><span>    <span style=color:#000>username</span>: <span style=color:#1c01ce>root</span>
</span></span><span style=display:flex><span>    <span style=color:#000>password</span>: <span style=color:#1c01ce>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#000>driver-class-name</span>: <span style=color:#1c01ce>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>druid</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>aop-patterns</span>: <span style=color:#1c01ce>com.atguigu.admin.* </span> <span style=color:#177500>#监控SpringBean</span>
</span></span><span style=display:flex><span>      <span style=color:#000>filters</span>: <span style=color:#1c01ce>stat,wall     # 底层开启功能，stat（sql监控），wall（防火墙）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#1c01ce>stat-view-servlet:   # 配置监控页功能</span>
</span></span><span style=display:flex><span>        <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>        <span style=color:#000>login-username</span>: <span style=color:#1c01ce>admin</span>
</span></span><span style=display:flex><span>        <span style=color:#000>login-password</span>: <span style=color:#1c01ce>admin</span>
</span></span><span style=display:flex><span>        <span style=color:#000>resetEnable</span>: <span style=color:#a90d91>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#1c01ce>web-stat-filter: </span> <span style=color:#177500># 监控web</span>
</span></span><span style=display:flex><span>        <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>        <span style=color:#000>urlPattern</span>: <span style=color:#1c01ce>/*</span>
</span></span><span style=display:flex><span>        <span style=color:#000>exclusions</span>: <span style=color:#c41a16>&#39;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>filter</span>:
</span></span><span style=display:flex><span>        <span style=color:#1c01ce>stat:   </span> <span style=color:#177500># 对上面filters里面的stat的详细配置</span>
</span></span><span style=display:flex><span>          <span style=color:#000>slow-sql-millis</span>: <span style=color:#1c01ce>1000</span>
</span></span><span style=display:flex><span>          <span style=color:#000>logSlowSql</span>: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>          <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>        <span style=color:#000>wall</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>          <span style=color:#000>config</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>drop-table-allow</span>: <span style=color:#a90d91>false</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=mybatis整合>Mybatis整合</h1><p>官方地址：<a href=https://github.com/mybatis>https://github.com/mybatis</a></p><p>springboot官方starter：spring-boot-starter-*</p><p>第三方starter：xx-spring-boot-starter</p><p>在 github 中自行寻找</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.mybatis.spring.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>2.1.4<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=配置模式>配置模式</h2><p>全局配置文件：</p><ul><li>SqlSessionFactory: 自动配置</li><li>SqlSession：自动配置了 SqlSessionTemplate 组合了SqlSession</li><li>@Import(AutoConfiguredMapperScannerRegistrar.class）；</li><li>Mapper： 只要操作MyBatis接口标注了 @Mapper 就会被自动扫描进来<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@org.springframework.context.annotation.Configuration</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnClass</span><span style=color:#000>({</span> <span style=color:#000>SqlSessionFactory</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#000>.</span><span style=color:#836c28>class</span> <span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#000>@ConditionalOnSingleCandidate</span><span style=color:#000>(</span><span style=color:#000>DataSource</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@EnableConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>MybatisProperties</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>@AutoConfigureAfter</span><span style=color:#000>({</span> <span style=color:#000>DataSourceAutoConfiguration</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>MybatisLanguageDriverAutoConfiguration</span><span style=color:#000>.</span><span style=color:#836c28>class</span> <span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MybatisAutoConfiguration</span> <span style=color:#a90d91>implements</span> <span style=color:#000>InitializingBean</span> <span style=color:#000>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@ConfigurationProperties</span><span style=color:#000>(</span><span style=color:#000>prefix</span> <span style=color:#000>=</span> <span style=color:#000>MybatisProperties</span><span style=color:#000>.</span><span style=color:#836c28>MYBATIS_PREFIX</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MybatisProperties</span> <span style=color:#000>{}</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><h2 id=配置mybatis规则>配置mybatis规则</h2><p>application.yml文件中配置：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>mybatis</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>config-location</span>: <span style=color:#1c01ce>classpath:mybatis/mybatis-config.xml </span> <span style=color:#177500>#全局配置文件位置</span>
</span></span><span style=display:flex><span>  <span style=color:#000>mapper-locations</span>: <span style=color:#1c01ce>classpath:mybatis/mapper/*.xml </span> <span style=color:#177500>#sql映射文件位置</span>
</span></span></code></pre></td></tr></table></div></div></div><p>查看 MybatisProperties 代码可以发现其中有个 private Configuration configuration。那么mybatis.configuration就是相当于改mybatis全局配置文件中的值。即不配置 mybatis.config-location 指定全局配置文件的内容。(注意：不要同时存在）</p><p>书写代码：controller->service->mapper->xml</p><h2 id=注解模式>注解模式</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Mapper</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>interface</span> <span style=color:#3f6e75>CityMapper</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Select</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Select * from city where id=#{id}&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>City</span> <span style=color:#000>getByID</span><span style=color:#000>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Insert</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;insert into City(`name`, `country`) values (#{name}, #{country})&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Options</span><span style=color:#000>(</span><span style=color:#000>useGeneratedKeys</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>,</span> <span style=color:#000>keyProperty</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;id&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>insert</span><span style=color:#000>(</span><span style=color:#000>City</span> <span style=color:#000>city</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=混合模式>混合模式</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Mapper</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>interface</span> <span style=color:#3f6e75>CityMapper</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Select</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Select * from city where id=#{id}&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>City</span> <span style=color:#000>getByID</span><span style=color:#000>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>insert</span><span style=color:#000>(</span><span style=color:#000>City</span> <span style=color:#000>city</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>mapper.xml<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;mapper</span> <span style=color:#836c28>namespace=</span><span style=color:#c41a16>&#34;com.chnherb.boot.mapper.CityMapper&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;insert</span> <span style=color:#836c28>id=</span><span style=color:#c41a16>&#34;insert&#34;</span> <span style=color:#836c28>useGeneratedKeys=</span><span style=color:#c41a16>&#34;true&#34;</span> <span style=color:#836c28>keyProperty=</span><span style=color:#c41a16>&#34;id&#34;</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>        insert into City(`name`, `country`) values (#{name}, #{country})
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/insert&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/mapper&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=最佳实战>最佳实战</h2><ul><li>引入 starter</li><li>配置application.yml</li><li>编写 mapper 接口并标注 @Mapper 注解</li><li>简单方法直接使用注解方式</li><li>复杂方法编写 mapper.xml 进行绑定映射</li><li>@MapperScan("com.chnherb.boot.mapper") 简化，其他接口可以不使用 @Mapper 注解标注</li></ul><h1 id=整合mybatis-plus>整合MyBatis-Plus</h1><h2 id=mybatis-plus简介>MyBatis-Plus简介</h2><p><a href=https://github.com/baomidou/mybatis-plus>MyBatis-Plus</a> 是一个 <a href=http://www.mybatis.org/mybatis-3/>MyBatis</a> 增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p><p><a href=https://baomidou.com/>mybatis plus 官网</a>，建议安装 <strong>MybatisX</strong>插件。</p><h2 id=引入依赖-1>引入依赖</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>com.baomidou<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>3.4.1<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=自动配置-2>自动配置</h2><p>自动配置</p><ul><li><p>MybatisPlusAutoConfiguration 配置类，MybatisPlusProperties 配置项绑定。mybatis-plus：xxx 就是对mybatis-plus的定制</p></li><li><p>SqlSessionFactory 自动配置好。底层是容器中默认的数据源</p></li><li><p>mapperLocations 自动配置好的。有默认值。classpath*:/mapper/**/*.xml；任意包的类路径下的所有mapper文件夹下任意路径下的所有xml都是sql映射文件。 建议以后sql映射文件，放在 mapper下</p></li><li><p>容器中也自动配置好了 SqlSessionTemplate</p></li><li><p>@Mapper 标注的接口也会被自动扫描；建议直接 @MapperScan("com.atguigu.admin.mapper") 批量扫描就行
优点：</p></li><li><p>只需要Mapper继承 BaseMapper 就可以拥有CRUD能力</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f753dfeb3bc6d6d6be7bce5bfe135395>11 - SpringBoot-05单元测试</h1><h1 id=junit5>JUnit5</h1><h2 id=简介>简介</h2><p><strong>Spring Boot 2.2.0 版本开始引入 JUnit 5 作为单元测试默认库</strong></p><p>作为最新版本的JUnit框架，JUnit5与之前版本的Junit框架有很大的不同。JUnit5旨在发展成一个测试平台，而非仅仅一个测试框架工具，由三个不同子项目的几个不同模块组成。</p><blockquote><p>JUnit 5 = JUnit Platform + JUnit Jupiter + JUnit Vintage</p></blockquote><p><strong>JUnit Platform</strong>: Junit Platform是在JVM上启动测试框架的基础，不仅支持Junit自制的测试引擎，其他测试引擎也都可以接入。</p><p><strong>JUnit Jupiter</strong>: JUnit Jupiter提供了JUnit5的新的编程模型，是JUnit5新特性的核心。内部 包含了一个测试引擎，用于在Junit Platform上运行。</p><p><strong>JUnit Vintage</strong>: 由于JUint已经发展多年，为了照顾老的项目，JUnit Vintage提供了兼容JUnit4.x,Junit3.x的测试引擎。</p><p>注意：</p><p>SpringBoot 2.4 以上版本移除了默认对 Vintage 的依赖。如果需要兼容junit4需要自行引入（不能使用junit4的功能 @Test）</p><p>JUnit 5’s Vintage Engine Removed from spring-boot-starter-test,如果需要继续兼容junit4需要自行引入vintage</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.junit.vintage<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>junit-vintage-engine<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;scope&gt;</span>test<span style=color:#000>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;groupId&gt;</span>org.hamcrest<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;artifactId&gt;</span>hamcrest-core<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=引入依赖>引入依赖</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;scope&gt;</span>test<span style=color:#000>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=使用>使用</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>Boot05WebAdminApplicationTests</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>void</span> <span style=color:#000>contextLoads</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>以前的用法：
@SpringBootTest + @RunWith(SpringTest.class)</p><p>SpringBoot整合Junit以后。</p><ul><li>编写测试方法：@Test标注（注意需要使用junit5版本的注解）</li><li>Junit类具有Spring的功能，@Autowired、比如 @Transactional 标注测试方法，测试完成后自动回滚</li></ul><h2 id=junit5常用注解>JUnit5常用注解</h2><p>JUnit5的注解与JUnit4的注解有所变化</p><p><a href=https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations>https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations</a></p><ul><li>@Test :表示方法是测试方法。但是与JUnit4的@Test不同，他的职责非常单一不能声明任何属性，拓展的测试将会由Jupiter提供额外测试</li><li>@ParameterizedTest :表示方法是参数化测试，下方会有详细介绍</li><li>@RepeatedTest :表示方法可重复执行，下方会有详细介绍</li><li>@DisplayName :为测试类或者测试方法设置展示名称</li><li>@BeforeEach :表示在每个单元测试之前执行</li><li>@AfterEach :表示在每个单元测试之后执行</li><li>@BeforeAll :表示在所有单元测试之前执行</li><li>@AfterAll :表示在所有单元测试之后执行</li><li>@Tag :表示单元测试类别，类似于JUnit4中的@Categories</li><li>@Disabled :表示测试类或测试方法不执行，类似于JUnit4中的@Ignore</li><li>@Timeout :表示测试方法运行如果超过了指定时间将会返回错误</li><li>@ExtendWith :为测试类或测试方法提供扩展类引用</li></ul><h2 id=断言>断言</h2><p>断言（assertions）是测试方法中的核心部分，用来对测试需要满足的条件进行验证。这些断言方法都是 org.junit.jupiter.api.Assertions 的静态方法。用来检查业务逻辑返回的数据是否合理。所有的测试运行结束以后，会有一个详细的测试报告。JUnit 5 内置的断言可以分成如下几个类别。</p><h3 id=简单断言>简单断言</h3><p>用来对单个值进行简单的验证。如：</p><table><thead><tr><th style=text-align:left>方法</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>assertEquals</td><td style=text-align:left>判断两个对象或两个原始类型是否相等</td></tr><tr><td style=text-align:left>assertNotEquals</td><td style=text-align:left>判断两个对象或两个原始类型是否不相等</td></tr><tr><td style=text-align:left>assertSame</td><td style=text-align:left>判断两个对象引用是否指向同一个对象</td></tr><tr><td style=text-align:left>assertNotSame</td><td style=text-align:left>判断两个对象引用是否指向不同的对象</td></tr><tr><td style=text-align:left>assertTrue</td><td style=text-align:left>判断给定的布尔值是否为 true</td></tr><tr><td style=text-align:left>assertFalse</td><td style=text-align:left>判断给定的布尔值是否为 false</td></tr><tr><td style=text-align:left>assertNull</td><td style=text-align:left>判断给定的对象引用是否为 null</td></tr><tr><td style=text-align:left>assertNotNull</td><td style=text-align:left>判断给定的对象引用是否不为 null</td></tr></tbody></table><h3 id=数组断言>数组断言</h3><p>通过 assertArrayEquals 方法来判断两个对象或原始类型的数组是否相等</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Test</span>
</span></span><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;array assertion&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>array</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>assertArrayEquals</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#a90d91>int</span><span style=color:#000>[]{</span><span style=color:#000>1</span><span style=color:#000>,</span> <span style=color:#000>2</span><span style=color:#000>},</span> <span style=color:#a90d91>new</span> <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>{</span><span style=color:#000>1</span><span style=color:#000>,</span> <span style=color:#000>2</span><span style=color:#000>});</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=组合断言>组合断言</h3><p>assertAll 方法接受多个 org.junit.jupiter.api.Executable 函数式接口的实例作为要验证的断言，可以通过 lambda 表达式很容易的提供这些断言</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Test</span>
</span></span><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;assert all&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>all</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span> <span style=color:#000>assertAll</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Math&#34;</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>assertEquals</span><span style=color:#000>(</span><span style=color:#000>2</span><span style=color:#000>,</span> <span style=color:#000>1</span> <span style=color:#000>+</span> <span style=color:#000>1</span><span style=color:#000>),</span>
</span></span><span style=display:flex><span>    <span style=color:#000>()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>assertTrue</span><span style=color:#000>(</span><span style=color:#000>1</span> <span style=color:#000>&gt;</span> <span style=color:#000>0</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span> <span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=异常断言>异常断言</h3><p>JUnit4想要测试方法的异常情况时，需要用@Rule注解的ExpectedException变量，比较麻烦。而JUnit5提供了一种新的断言方式Assertions.assertThrows() ，配合函数式编程就可以进行使用。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Test</span>
</span></span><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;异常测试&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>exceptionTest</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ArithmeticException</span> <span style=color:#000>exception</span> <span style=color:#000>=</span> <span style=color:#000>Assertions</span><span style=color:#000>.</span><span style=color:#836c28>assertThrows</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>           <span style=color:#177500>//扔出断言异常
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>ArithmeticException</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>1</span> <span style=color:#000>%</span> <span style=color:#000>0</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=超时断言>超时断言</h3><p>Assertions.assertTimeout() 为测试方法设置了超时时间</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Test</span>
</span></span><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;超时测试&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>timeoutTest</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>//如果测试方法时间超过1s将会异常
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>Assertions</span><span style=color:#000>.</span><span style=color:#836c28>assertTimeout</span><span style=color:#000>(</span><span style=color:#000>Duration</span><span style=color:#000>.</span><span style=color:#836c28>ofMillis</span><span style=color:#000>(</span><span style=color:#000>1000</span><span style=color:#000>),</span> <span style=color:#000>()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>Thread</span><span style=color:#000>.</span><span style=color:#836c28>sleep</span><span style=color:#000>(</span><span style=color:#000>500</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=快速失败>快速失败</h3><p>通过 fail 方法直接使得测试失败</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Test</span>
</span></span><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;fail&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>shouldFail</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>fail</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;This should fail&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=前置条件>前置条件</h2><p>JUnit 5 中的前置条件（assumptions【假设】）类似于断言，不同之处在于不满足的断言会使得测试方法失败，而不满足的前置条件只会使得测试方法的执行终止。前置条件可以看成是测试方法执行的前提，当该前提不满足时，就没有继续执行的必要。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;前置条件&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>AssumptionsTest</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>environment</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;DEV&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span> <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;simple&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>simpleAssume</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>assumeTrue</span><span style=color:#000>(</span><span style=color:#000>Objects</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>environment</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;DEV&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>assumeFalse</span><span style=color:#000>(()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>Objects</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>environment</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;PROD&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span> <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;assume then do&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>assumeThenDo</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>assumingThat</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Objects</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>environment</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;DEV&#34;</span><span style=color:#000>),</span>
</span></span><span style=display:flex><span>       <span style=color:#000>()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;In DEV&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>);</span>
</span></span><span style=display:flex><span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>assumeTrue 和 assumFalse 确保给定的条件为 true 或 false，不满足条件会使得测试执行终止。assumingThat 的参数是表示条件的布尔值和对应的 Executable 接口的实现对象。只有条件满足时，Executable 对象才会被执行；当条件不满足时，测试执行并不会终止。</p><h2 id=嵌套测试>嵌套测试</h2><p>JUnit 5 可以通过 Java 中的内部类和@Nested 注解实现嵌套测试，从而可以更好地把相关的测试方法组织在一起。在内部类中可以使用@BeforeEach 和@AfterEach 注解，且嵌套的层次没有限制。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;A stack&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>TestingAStackDemo</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Stack</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>stack</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;is instantiated with new Stack()&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>void</span> <span style=color:#000>isInstantiatedWithNew</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>new</span> <span style=color:#000>Stack</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Nested</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;when new&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>class</span> <span style=color:#3f6e75>WhenNew</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>@BeforeEach</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>void</span> <span style=color:#000>createNewStack</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>stack</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Stack</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;is empty&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>void</span> <span style=color:#000>isEmpty</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>assertTrue</span><span style=color:#000>(</span><span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;throws EmptyStackException when popped&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>void</span> <span style=color:#000>throwsExceptionWhenPopped</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>assertThrows</span><span style=color:#000>(</span><span style=color:#000>EmptyStackException</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>stack</span><span style=color:#000>::</span><span style=color:#000>pop</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;throws EmptyStackException when peeked&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>void</span> <span style=color:#000>throwsExceptionWhenPeeked</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>assertThrows</span><span style=color:#000>(</span><span style=color:#000>EmptyStackException</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>,</span> <span style=color:#000>stack</span><span style=color:#000>::</span><span style=color:#000>peek</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Nested</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;after pushing an element&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>class</span> <span style=color:#3f6e75>AfterPushing</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>anElement</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;an element&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>@BeforeEach</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>void</span> <span style=color:#000>pushAnElement</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>push</span><span style=color:#000>(</span><span style=color:#000>anElement</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;it is no longer empty&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>void</span> <span style=color:#000>isNotEmpty</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>assertFalse</span><span style=color:#000>(</span><span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;returns the element when popped and is empty&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>void</span> <span style=color:#000>returnElementWhenPopped</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>assertEquals</span><span style=color:#000>(</span><span style=color:#000>anElement</span><span style=color:#000>,</span> <span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>pop</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>                <span style=color:#000>assertTrue</span><span style=color:#000>(</span><span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;returns the element when peeked but remains not empty&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>void</span> <span style=color:#000>returnElementWhenPeeked</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>assertEquals</span><span style=color:#000>(</span><span style=color:#000>anElement</span><span style=color:#000>,</span> <span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>peek</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>                <span style=color:#000>assertFalse</span><span style=color:#000>(</span><span style=color:#000>stack</span><span style=color:#000>.</span><span style=color:#836c28>isEmpty</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=参数化测试>参数化测试</h2><p>参数化测试是JUnit5很重要的一个新特性，它使得用不同的参数多次运行测试成为了可能，也为单元测试带来许多便利。</p><p>利用@ValueSource等注解指定入参，可以使用不同的参数进行多次单元测试，而不需要每新增一个参数就新增一个单元测试，省去了很多冗余代码。</p><p>@ValueSource: 为参数化测试指定入参来源，支持八大基础类以及String类型,Class类型</p><p>@NullSource: 表示为参数化测试提供一个null的入参</p><p>@EnumSource: 表示为参数化测试提供一个枚举入参</p><p>@CsvFileSource：表示读取指定CSV文件内容作为参数化测试入参</p><p>@MethodSource：表示读取指定方法的返回值作为参数化测试入参(注意方法返回需要是一个流)</p><p>如果参数化测试仅仅只能做到指定普通的入参还达不到让人惊艳的地步。它的强大之处还在于可以支持外部的各类入参。如：CSV,YML,JSON 文件甚至方法的返回值也可以作为入参。只需要去实现ArgumentsProvider接口，任何外部文件都可以作为它的入参。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@ParameterizedTest</span>
</span></span><span style=display:flex><span><span style=color:#000>@ValueSource</span><span style=color:#000>(</span><span style=color:#000>strings</span> <span style=color:#000>=</span> <span style=color:#000>{</span><span style=color:#c41a16>&#34;one&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;two&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;three&#34;</span><span style=color:#000>})</span>
</span></span><span style=display:flex><span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;参数化测试1&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>parameterizedTest1</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>string</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>string</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Assertions</span><span style=color:#000>.</span><span style=color:#836c28>assertTrue</span><span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>isNotBlank</span><span style=color:#000>(</span><span style=color:#000>string</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@ParameterizedTest</span>
</span></span><span style=display:flex><span><span style=color:#000>@MethodSource</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;method&#34;</span><span style=color:#000>)</span>    <span style=color:#177500>//指定方法名
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@DisplayName</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;方法来源参数&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>testWithExplicitLocalMethodSource</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Assertions</span><span style=color:#000>.</span><span style=color:#836c28>assertNotNull</span><span style=color:#000>(</span><span style=color:#000>name</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>static</span> <span style=color:#000>Stream</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>method</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>Stream</span><span style=color:#000>.</span><span style=color:#836c28>of</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;apple&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;banana&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=迁移指南><strong>迁移指南</strong></h2><p>迁移时需要注意如下的变化：</p><ul><li>注解在 org.junit.jupiter.api 包中，断言在 org.junit.jupiter.api.Assertions 类中，前置条件在 org.junit.jupiter.api.Assumptions 类中。</li><li>把@Before 和@After 替换成@BeforeEach 和@AfterEach。</li><li>把@BeforeClass 和@AfterClass 替换成@BeforeAll 和@AfterAll。</li><li>把@Ignore 替换成@Disabled。</li><li>把@Category 替换成@Tag。</li><li>把@RunWith、@Rule 和@ClassRule 替换成@ExtendWith。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9a1dd6c86b4f3b0f8ce15d918c6efdf9>12 - SpringBoot-06指标监控</h1><h1 id=springboot-actuator>SpringBoot Actuator</h1><h2 id=简介>简介</h2><p>未来每一个微服务在云上部署以后，我们都需要对其进行监控、追踪、审计、控制等。SpringBoot就抽取了Actuator场景，使得每个微服务快速引用即可获得生产级别的应用监控、审计等功能。</p><p>官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.packaging-for-production>using.htm l# using.packaging-for-production</a> -> <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator>actuator</a></p><h2 id=1-x与2-x对比>1.x与2.x对比</h2><p>SpringBoot 1.x引入的Actuator是1.x版本，2.x同理。</p><p>SpringBoot Actuator 1.x：</p><ul><li><p>支持SpringMVC</p></li><li><p>基于继承方式进行扩展</p></li><li><p>层级Metrics配置</p></li><li><p>自定义Metrics收集</p></li><li><p>默认较少的安全策略
SpringBoot Actuator 2.x：</p></li><li><p>支持SpringMVC、JAX-RS以及Webflux</p></li><li><p>注解驱动进行扩展</p></li><li><p>层级&名称空间Metrics</p></li><li><p>底层使用MicroMeter，强大、便捷</p></li><li><p>默认丰富的安全策略</p></li></ul><h2 id=使用>使用</h2><p>导入依赖包：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>配置：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>endpoints</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>enabled-by-default</span>: <span style=color:#a90d91>true</span> <span style=color:#177500>#暴露所有端点信息</span>
</span></span><span style=display:flex><span>    <span style=color:#000>web</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>exposure</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>include</span>: <span style=color:#c41a16>&#39;*&#39;</span>  <span style=color:#177500>#以web方式暴露</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=endpoints>Endpoints</h2><p>具体 Endpoints 见官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints>actuator # actuator.endpoints</a></p><p><a href=http://localhost:8888/actuator/beans>http://localhost:8888/actuator/beans</a>：所有注入bean</p><p><a href=http://localhost:8888/actuator/conditions>http://localhost:8888/actuator/conditions</a>：positiveMatches（开启的条件）；negativeMatches（未开启的条件）；</p><p><a href=http://localhost:8888/actuator/configprops>http://localhost:8888/actuator/configprops</a>：生效的配置属性值</p><p><a href=http://localhost:8888/actuator/env>http://localhost:8888/actuator/env</a>：环境变量</p><p>语法：</p><p><a href=http://localhost:8888/actuator/%7BendpointName%7D/detailPath>http://localhost:8888/actuator/{endpointName}/detailPath</a></p><p>常用的Endpoint：</p><ul><li>Health：健康检查</li><li>Metrics：运行时指标</li><li>Loggers：日志记录</li></ul><h2 id=可视化>可视化</h2><p><a href=https://github.com/codecentric/spring-boot-admin>https://github.com/codecentric/spring-boot-admin</a></p><h1 id=actuator-endpoint>Actuator Endpoint</h1><h2 id=health-endpoint>Health Endpoint</h2><p>健康检查端点，一般用于在云平台，平台会定时的检查应用的健康状况，需要Health Endpoint可以为平台返回当前应用的一系列组件健康状况的集合。</p><p>注意：</p><ul><li>health endpoint返回的结果，应该是一系列健康检查后的一个汇总报告</li><li>很多健康检查默认已经自动配置，比如：数据库、redis等</li><li>比较容易添加自定义的健康检查机制</li></ul><h2 id=metrics-endpoint>Metrics Endpoint</h2><p>提供详细的、层级的、空间指标信息，这些信息可以被pull（主动推送）或者push（被动获取）方式得到：</p><ul><li>通过Metrics对接多种监控系统</li><li>简化核心Metrics开发</li><li>添加自定义Metrics或者扩展已有Metrics</li></ul><h2 id=管理endpoints>管理Endpoints</h2><h3 id=开启与禁用endpoints><strong>开启与禁用Endpoints</strong></h3><ul><li><p>默认所有的Endpoint除过shutdown都是开启的。</p></li><li><p>需要开启或者禁用某个Endpoint。配置模式为 management.endpoint.<endpointname>.enabled = true<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>endpoint</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>beans</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div></p></li><li><p>或者禁用所有的Endpoint然后手动开启指定的Endpoint<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>endpoints</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>enabled-by-default</span>: <span style=color:#a90d91>false</span>
</span></span><span style=display:flex><span>  <span style=color:#000>endpoint</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>beans</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>    <span style=color:#000>health</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div></p></li></ul><h3 id=暴露endpoints>暴露Endpoints</h3><p>支持的暴露方式</p><ul><li>HTTP：默认只暴露health和info Endpoint</li><li>JMX：默认暴露所有Endpoint</li><li>除过health和info，剩下的Endpoint都应该进行保护访问。如果引入SpringSecurity，则会默认配置安全访问规则</li></ul><h3 id=jmx方式><strong>JMX方式</strong></h3><p>Java消息服务，简单的说就是java 提供了一批消息发送的接口，通过JMS提供的接口， 可以实现不同系统之间消息的发送。</p><p>actuator 默认使用 JMS 方式暴露了 endPoints，但没有通过 Web 的方式。具体可见：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.exposing>actuator # actuator.endpoints.exposing</a></p><p>使用方法：</p><ol><li>启动应用程序</li><li>终端输入 jconsole 命令</li><li>选择对应的应用程序</li></ol><h1 id=定制endpoint>定制EndPoint</h1><h2 id=定制health>定制Health</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyComHealthIndicator</span> <span style=color:#a90d91>extends</span> <span style=color:#000>AbstractHealthIndicator</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// http://localhost:8888/actuator/health 可以查看到 myCom
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>doHealthCheck</span><span style=color:#000>(</span><span style=color:#000>Health</span><span style=color:#000>.</span><span style=color:#836c28>Builder</span> <span style=color:#000>builder</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>infos</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>HashMap</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 建立连接判断是否监控
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>0</span> <span style=color:#000>==</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#177500>//            builder.up();
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>status</span><span style=color:#000>(</span><span style=color:#000>Status</span><span style=color:#000>.</span><span style=color:#836c28>UP</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>infos</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;code&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;200&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>infos</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;msg&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;xxx&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#177500>//            builder.down();
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>status</span><span style=color:#000>(</span><span style=color:#000>Status</span><span style=color:#000>.</span><span style=color:#836c28>OUT_OF_SERVICE</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>infos</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;code&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;500&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>infos</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;msg&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;this is error!!!&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>withDetail</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;ms&#34;</span><span style=color:#000>,</span> <span style=color:#000>300</span><span style=color:#000>).</span><span style=color:#836c28>withDetails</span><span style=color:#000>(</span><span style=color:#000>infos</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>yaml配置：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>endpoint</span>: <span style=color:#177500># 对某个端点的具体配置</span>
</span></span><span style=display:flex><span>    <span style=color:#000>health</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>show-details</span>: <span style=color:#1c01ce>always</span>
</span></span><span style=display:flex><span>      <span style=color:#000>enabled</span>: <span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=定制info>定制Info</h2><p>一般常用两种方式。</p><h3 id=配置文件>配置文件</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#177500># 默认访问 /actuator/info 没有任何信息，这里定制才会有对应信息</span>
</span></span><span style=display:flex><span><span style=color:#000>info</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>appName</span>: <span style=color:#1c01ce>boot-web</span>
</span></span><span style=display:flex><span>  <span style=color:#000>appVersion</span>: <span style=color:#1c01ce>1.0.1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>mavenProjectName</span>: @<span style=color:#1c01ce>project.artifactId@</span> <span style=color:#177500># 使用@xx@可以获取maven的pom信息</span>
</span></span><span style=display:flex><span>  <span style=color:#000>mavenProjectVersion</span>: @<span style=color:#1c01ce>project.version@</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=实现infocontributor>实现InfoContributor</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>AppInfoInfoContributor</span> <span style=color:#a90d91>implements</span> <span style=color:#000>InfoContributor</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>contribute</span><span style=color:#000>(</span><span style=color:#000>Info</span><span style=color:#000>.</span><span style=color:#836c28>Builder</span> <span style=color:#000>builder</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>withDetail</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;msg&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;hello world&#34;</span><span style=color:#000>).</span><span style=color:#836c28>withDetails</span><span style=color:#000>(</span><span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>singletonMap</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;hhah&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;xixixi&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=定制metrics>定制Metrics</h2><h3 id=springboot自动适配metrics>SpringBoot自动适配Metrics</h3><ul><li>JVM metrics, report utilization of:<ul><li>Various memory and buffer pools</li><li>Statistics related to garbage collection</li><li>Threads utilization</li><li>Number of classes loaded/unloaded</li></ul></li><li>CPU metrics</li><li>File descriptor metrics</li><li>Kafka consumer and producer metrics</li><li>Log4j2 metrics: record the number of events logged to Log4j2 at each level</li><li>Logback metrics: record the number of events logged to Logback at each level</li><li>Uptime metrics: report a gauge for uptime and a fixed gauge representing the application’s absolute start time</li><li>Tomcat metrics (server.tomcat.mbeanregistry.enabled must be set to true for all Tomcat metrics to be registered)</li><li><a href=https://docs.spring.io/spring-integration/docs/5.4.1/reference/html/system-management.html#micrometer-integration>Spring Integration</a> metrics</li></ul><h3 id=增加定制metrics>增加定制Metrics</h3><p>目的：增加业务打点，如接口方法访问次数等。</p><p>方法一：在业务代码中注册 MeterRegistry 并调用相应方法。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Service</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>CityService</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>CityMapper</span> <span style=color:#000>cityMapper</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Counter</span> <span style=color:#000>counter</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>CityService</span><span style=color:#000>(</span><span style=color:#000>MeterRegistry</span> <span style=color:#000>meterRegistry</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>counter</span> <span style=color:#000>=</span> <span style=color:#000>meterRegistry</span><span style=color:#000>.</span><span style=color:#836c28>counter</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;cityService.getCityByID.count&#34;</span><span style=color:#000>);</span> <span style=color:#177500>//注册
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>City</span> <span style=color:#000>getCityByID</span><span style=color:#000>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>counter</span><span style=color:#000>.</span><span style=color:#836c28>increment</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>cityMapper</span><span style=color:#000>.</span><span style=color:#836c28>getByID</span><span style=color:#000>(</span><span style=color:#000>id</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>方法二：直接注入 MeterBinder 的Bean<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#000>MeterBinder</span> <span style=color:#000>queueSize</span><span style=color:#000>(</span><span style=color:#000>Queue</span> <span style=color:#000>queue</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>(</span><span style=color:#000>registry</span><span style=color:#000>)</span> <span style=color:#000>-&gt;</span> <span style=color:#000>Gauge</span><span style=color:#000>.</span><span style=color:#836c28>builder</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;queueSize&#34;</span><span style=color:#000>,</span> <span style=color:#000>queue</span><span style=color:#000>::</span><span style=color:#000>size</span><span style=color:#000>).</span><span style=color:#836c28>register</span><span style=color:#000>(</span><span style=color:#000>registry</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>使用方法：</p><ol><li>访问 /actuator/metrics 可以发现多了一个 cityService.getCityByID.count 指标</li><li>访问 /actuator/metrics/cityService.getCityByID.count 可以看到 COUNT 为0</li><li>调用 /car?id=1，访问上一步的连接，可以看到 COUNT 数值</li></ol><h2 id=定制endpoint-1>定制Endpoint</h2><p>场景：开发ReadinessEndpoint来管理程序是否就绪，或者LivenessEndpoint来管理程序是否存活。如Kubernetes Probes。可参考：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.kubernetes-probes>actuator # actuator.endpoints.kubernetes-probes</a></p><p>代码如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Component</span>
</span></span><span style=display:flex><span><span style=color:#000>@Endpoint</span><span style=color:#000>(</span><span style=color:#000>id</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;myservice&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyServiceEndpoint</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 端点的读操作：访问 /actuator/myservice 可得到该信息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>@ReadOperation</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Map</span> <span style=color:#000>myServiceInfo</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>singletonMap</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;serviceInfo&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;serviceInfo: say hello&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@WriteOperation</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>stopMyService</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;my service stopped...&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>使用方式：</p><ul><li>读操作<ul><li>web 访问 /actuator/myservice</li><li>jconsole 打开界面选择 MBeans -> {应用} -> Endpoint -> Myservice -> Operations -> myServiceInfo</li></ul></li><li>写操作<ul><li>jconsole 打开界面选择 MBeans -> {应用} -> Endpoint -> Myservice -> Operations -> stopMyService（可以看到应用程序控制台输出内容）</li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ed23f0e04d04d0059598fbb2296af7cf>13 - SpringBoot-07配置与加载过程</h1><h1 id=profile>Profile</h1><h2 id=application-profile>application-profile</h2><p>为了方便多个环境适配，SpringBoot简化了 profile 功能。</p><h2 id=profile条件装配>Profile条件装配</h2><ul><li>默认配置文件 application.yaml；任何时候都会加载</li><li>指定环境配置文件 application-{env}.yaml</li><li>激活指定环境<ul><li>配置文件激活</li><li>命令行激活：java -jar xxx.jar --spring.profiles.active=prod --person.name=haha<ul><li>修改配置文件的任意值，命令行优先</li></ul></li></ul></li><li>默认配置与环境配置同时生效</li><li>同名配置项，profile配置优先</li></ul><h2 id=profile分组>Profile分组</h2><p>参考官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.profiles>features # features.profiles</a></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#1c01ce>spring.profiles.group.production[0]=proddb</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>spring.profiles.group.production[1]=prodmq</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>使用：--spring.profiles.active=production  激活</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=配置加载>配置加载</h1><p>官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config>features # features.external-config</a></p><h2 id=外部配置源>外部配置源</h2><p>常用：Java属性文件、YAML文件、环境变量、命令行参数；</p><h2 id=配置文件路径>配置文件路径</h2><ul><li>classpath 根路径</li><li>classpath 根路径下的 config 目录</li><li>jar 包当前目录</li><li>jar 包当前目录的 config 目录</li><li>/config 子目录的直接子目录</li></ul><h2 id=配置文件加载顺序>配置文件加载顺序</h2><ol><li>当前 jar 包内部的 application.properites 和 application.yml</li><li>当前 jar 包内部的 application-{profile}.properties 和 application-{profile}.yml</li><li>引用的外部 jar 包的 application.properties 和 application.yml</li><li>引用的外部 jar 包的 application-{profile}.properties 和 application-{profile}.yml
指定环境优先，外部优先，后面的可以覆盖前面的同名配置项。</li></ol><h1 id=自定义starter>自定义starter</h1><p>官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters>using # using.build-systems.starters</a></p><h2 id=starter启动原理>starter启动原理</h2><ul><li>starter-pom 引入 autoconfigurer 包</li><li>autoconfigurer 包中配置使用 META-INF/spring.factories 中 EnableAutoConfiguration 的值，使得项目启动加载指定的自动配置类</li><li>编写自动配置类 xxAutoConfiguration -> xxProperties
starter模块：</li></ul><h2 id=自定义starter-1>自定义starter</h2><p>xxx-spring-boot-starter（启动器）</p><p>xxx-spring-boot-starter-autoconfigure（自动配置包）</p><h1 id=springboot原理>SpringBoot原理</h1><h2 id=springboot启动过程>SpringBoot启动过程</h2><ul><li>创建 SpringApplication<ul><li>保存一些信息。</li><li>判定当前应用的类型：ClassUtils、Servlet</li><li>bootstrappers：初始启动引导器（List<bootstrapper>）：去spring.factories文件中找 org.springframework.boot.Bootstrapper</li><li>找 ApplicationContextInitializer；spring.factories 中找 ApplicationContextInitializer<ul><li>List&lt;ApplicationContextInitializer> initializers</li></ul></li><li>找 ApplicationListener 应用监听器。spring.factories 中找 ApplicationListener<ul><li>List&lt;ApplicationListener> listeners</li></ul></li></ul></li><li>运行 SpringApplication<ul><li>StopWatch</li><li>记录应用的启动时间</li><li>创建引导上下文（Context环境）createBootstrapContext()<ul><li>获取到所有之前的 bootstrappers 挨个执行 intitialize() 来完成对引导启动器上下文环境设置</li></ul></li><li>让当前应用进入headless模式。java.awt.headless</li><li>获取所有 RunListener（运行监听器）【为了方便所有Listener进行事件感知】<ul><li>getSpringFactoriesInstances 去spring.factories找 SpringApplicationRunListener.</li></ul></li><li>遍历 SpringApplicationRunListener 调用 starting 方法；（相当于通知所有系统项目正在启动。）</li><li>保存命令行参数；ApplicationArguments</li><li>准备环境 prepareEnvironment（）;<ul><li>返回或者创建基础环境信息对象。StandardServletEnvironment</li><li>配置环境信息对象。（读取所有的配置源的配置属性值。）</li><li>绑定环境信息</li><li>监听器调用 listener.environmentPrepared()；通知所有的监听器当前环境准备完成</li></ul></li><li>创建IOC容器（createApplicationContext）<ul><li>根据项目类型（Servlet）创建容器，</li><li>当前会创建 AnnotationConfigServletWebServerApplicationContext</li></ul></li><li>准备ApplicationContext IOC容器的基本信息 prepareContext()<ul><li>保存环境信息</li><li>IOC容器的后置处理流程</li><li>应用初始化器 applyInitializers<ul><li>遍历所有的 ApplicationContextInitializer 。调用 initialize.。来对ioc容器进行初始化扩展功能</li><li>遍历所有的 listener 调用 contextPrepared。EventPublishRunListenr；通知所有的监听器contextPrepared</li></ul></li><li>所有的监听器 调用 contextLoaded。通知所有的监听器 contextLoaded；</li></ul></li><li>刷新IOC容器。refreshContext<ul><li>创建容器中的所有组件（Spring注解）</li></ul></li><li>容器刷新完成后工作 afterRefresh</li><li>所有监听 器 调用 listeners.started(context); 通知所有的监听器 started</li><li>调用所有runners；callRunners()<ul><li>获取容器中的 ApplicationRunner</li><li>获取容器中的 CommandLineRunner</li><li>合并所有runner并且按照@Order进行排序</li><li>遍历所有的runner。调用 run 方法</li></ul></li><li>如果以上有异常，调用Listener 的 failed</li><li>调用所有监听器的 running 方法 listeners.running(context)，通知所有的监听器 running</li><li>running如果有问题继续通知 failed。调用所有 Listener 的 failed，通知所有的监听器 failed</li></ul></li></ul><h2 id=application-events-and-listeners>Application Events and Listeners</h2><p>官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-application-events-and-listeners>spring-boot-features # boot-features-application-events-and-listeners</a></p><p><strong>ApplicationContextInitializer</strong></p><p><strong>ApplicationListener</strong></p><p><strong>SpringApplicationRunListener</strong></p><h2 id=applicationrunner与commandlinerunner>ApplicationRunner与CommandLineRunner</h2><h1 id=heading></h1></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>