<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/12.IO/><link rel=alternate type=application/rss+xml href=/docs/12.IO/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>IO | Herbdocs</title><meta name=description content="Introduction
I/O知识介绍
"><meta property="og:title" content="IO"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/12.IO/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="IO"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="IO"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/12.IO/>返回本页常规视图</a>.</p></div><h1 class=title>IO</h1><ul><li>1: <a href=#pg-0cb7ae31d32bcfffb592b0a63a03c2e6>Java NIO核心知识</a></li><li>2: <a href=#pg-b9e16ec0238c418553119ef426476e8b>Netty服务器启动源码分析</a></li><li>3: <a href=#pg-458f28d41ef5c5b97b3da14b3d50a0e9>IO模型</a></li></ul><div class=content><h1 id=introduction>Introduction</h1><p>I/O知识介绍</p></div></div><div class=td-content><h1 id=pg-0cb7ae31d32bcfffb592b0a63a03c2e6>1 - Java NIO核心知识</h1><h1 id=简介>简介</h1><p>NIO（Non-blocking I/O，在Java领域，也称为New I/O），是一种同步非阻塞的I/O模型，也是I/O多路复用的基础。IO多路复用，一言以蔽之，就是**"复用"一个线程或一个进程，同时监测若干个（"多路"）文件描述符是否可以执行IO操作的能力。** 在I/O编程过程中，当需要同时处理多个客户端接入请求时，可以利用多线程或者I/O多路复用技术进行处理。**I/O多路复用技术通过把多个I/O的阻塞复用到同一个select的阻塞上，从而使得系统在单线程的情况下可以同时处理多个客户端请求。**与传统的多线程/多进程模型比，I/O多路复用的最大优势是系统开销小，系统不需要创建新的额外进程或者线程，也不需要维护这些进程和线程的运行，降低了系统维护的工作量，节省了系统资源。</p><p>IO多路复用的优势并不是对于单个连接能处理得更快，而是在于能处理更多的连接。如果处理的连接数不是很高的话，使用select/epoll的web server不一定比使用multi-threading + blocking IO的web server性能更好，可能延迟还更大。</p><p>关于 Java NIO 相关的核心，总的来看包含以下三点，分别是：</p><ul><li>Channel</li><li>Buffer</li><li>Selector</li></ul><h1 id=bio>BIO</h1><p><strong>通过 socket 通信，实际上就是通过文件描述符 fd 读写文件</strong></p><h2 id=c10k问题>C10k问题</h2><p>C10K 就是 Client 10000 问题，即「在同时连接到服务器的客户端数量超过 10000 个的环境中，即便硬件性能足够， 依然无法正常提供服务」，简而言之，就是单机1万个并发连接问题。这个概念最早由 Dan Kegel 提出并发布于其个人站点（ <a href=http://www.kegel.com/c10k.html>http://www.kegel.com/c10k.html</a> ）</p><blockquote><p>设计 Unix 的 PID 的时候，采用了有符号的16位整数，这就导致一台计算机上能够创建出来的进程无法超过32767个。</p></blockquote><h1 id=channel>Channel</h1><p>Channel 就是通道。可以往通道里写数据、读数据。它是双向的，与之配套的是 Buffer，即要往一个通道里写数据，必须要将数据写到一个 Buffer 中，然后写到通道里。同样，从通道里读数据，必须将通道的数据先读取到一个 Buffer 中，然后再操作。</p><p>在 NIO 中 Channel 有多种类型：</p><ul><li>SocketChannel</li><li>ServerSocketChannel</li><li>DatagramChannel</li><li>FileChannel</li></ul><h2 id=socketchannel>SocketChannel</h2><p>对标 Socket，可以直接将它看做所建立的连接。通过 SocketChannel ，可以利用 TCP 协议进行读写网络数据。</p><p>SocketChannel 主要在两个地方出现：</p><ul><li>客户端，客户端创建一个 SocketChannel 用于连接至远程的服务端。</li><li>服务端，服务端利用 ServerSocketChannel 接收新连接之后，为其创建一个 SocketChannel 。
随后，客户端和服务端就可以通过这两个 SocketChannel 相互发送和接收数据。</li></ul><h2 id=serversocketchannel>ServerSocketChannel</h2><p>服务端创建的 Socket，可以对标 ServerSocket。</p><p>主要是用来接待新连接，监听新建连的 TCP 连接，为新进一个连接创建对应的 SocketChannel。然后通过新建的 SocketChannel 可以进行网络数据的读写，与对端交互。</p><p>ServerSocketChannel 主要出现在一个地方：服务端。</p><p>服务端需要绑定一个端口，然后监听新连接的到来，这个活儿就由 ServerSocketChannel 来干。</p><p>服务端内常常会利用一个线程，一个死循环，不断地接收新连接的到来。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ServerSocketChannel</span> <span style=color:#000>serverSocketChannel</span> <span style=color:#000>=</span> <span style=color:#000>ServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>open</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>while</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// 接收新的连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>SocketChannel</span> <span style=color:#000>socketChannel</span> <span style=color:#000>=</span> <span style=color:#000>serverSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>accept</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=datagramchannel>DatagramChannel</h2><p>Datagram（数据报），即 UDP 协议，是无连接协议。利用 DatagramChannel 可以直接通过 UDP 进行网络数据的读写。</p><h2 id=filechannel>FileChannel</h2><p>文件通道，用来进行文件的数据读写。</p><p>我们日常开发主要是基于 TCP 协议，所以我们把精力放在  SocketChannel 和  ServerSocketChannel 上即可。</p><h1 id=buffer>Buffer</h1><p>Buffer 就是内存中可以读写的一块地方，叫缓冲区，用于缓存数据。</p><p>其并没有太多原理可介绍，主要关注 Java NIO Buffer 的 API 即可。当然其 API 有很多优化之处，所以 Netty 没用 Java NIO Buffer 而是自行实现了一个 Buffer，叫 ByteBuf。</p><p>为什么 Channel 必须和 Buffer 搭配使用？</p><blockquote><p>其实网络数据是面向字节的，但是读写的数据往往是多字节的，假设不用 Buffer 那需要一个字节一个字节的调用读和调用写，非常麻烦。
所以搞个 Buffer 将数据拢一拢，这样之后的调用才能更好地处理完整的数据，方便异步的处理等等。</p></blockquote><h1 id=selector>Selector</h1><p>Selector 是 I/O 多路复用的核心组件。</p><p>一个 Selector 上可以注册多个 Channel ，从上面已经知道一个 Channel 就对应了一个连接，因此一个 Selector 可以管理多个 Channel 。</p><p>当任意 Channel 发生读写事件时，通过 <code>Selector.select()</code> 就可以捕捉到事件的发生，因此可以利用一个线程，死循环的调用 <code>Selector.select()</code>，这样可以利用一个线程管理多个连接，减少了线程数，减少了线程的上下文切换和节省了线程资源。这就是 Selector 的核心功能。</p><p>具体详细步骤：</p><ol><li><p>创建一个 Selector<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Selector</span> <span style=color:#000>selector</span> <span style=color:#000>=</span> <span style=color:#000>Selector</span><span style=color:#000>.</span><span style=color:#836c28>open</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div></p></li><li><p>将要被管理的 Channel 注册到 Selector 上，并声明感兴趣的事件<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#000>=</span> <span style=color:#000>channel</span><span style=color:#000>.</span><span style=color:#836c28>register</span><span style=color:#000>(</span><span style=color:#000>selector</span><span style=color:#000>,</span> <span style=color:#000>Selectionkey</span><span style=color:#000>.</span><span style=color:#836c28>OP_READ</span> <span style=color:#000>|</span> <span style=color:#000>Selectionkey</span><span style=color:#000>.</span><span style=color:#836c28>OP_WRITE</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div></p></li></ol><p>事件类型：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>in</span> <span style=color:#000>OP_READ</span> <span style=color:#000>=</span> <span style=color:#000>1</span> <span style=color:#000>&lt;&lt;</span> <span style=color:#000>0</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>in</span> <span style=color:#000>OP_WRITE</span> <span style=color:#000>=</span> <span style=color:#000>1</span> <span style=color:#000>&lt;&lt;</span> <span style=color:#000>2</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>in</span> <span style=color:#000>OP_CONNECT</span> <span style=color:#000>=</span> <span style=color:#000>1</span> <span style=color:#000>&lt;&lt;</span> <span style=color:#000>3</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>in</span> <span style=color:#000>OP_ACCEPT</span> <span style=color:#000>=</span> <span style=color:#000>1</span> <span style=color:#000>&lt;&lt;</span> <span style=color:#000>4</span><span style=color:#000>;</span>
</span></span></code></pre></td></tr></table></div></div></div></p><ol start=3><li><p>当 Channel 发生读或写事件，调用 <code>Selector.select()</code> 就可以得知有事件发生。
该函数具体有3个重载方法：</p><ul><li>int selectNow()：不论是否有误事件发生，立即返回</li><li>int select(long timeout)：至多阻塞 timeout 时间（或被唤醒），如果提前有事件发生则提前返回</li><li>int select()：一直阻塞，直到有事件发生（或被唤醒）。
返回值就是就绪的通道数，一般判断大于 0 即可后续的操作，即调用：</li></ul></li></ol><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Set</span> <span style=color:#000>selectedKeys</span> <span style=color:#000>=</span> <span style=color:#000>selector</span><span style=color:#000>.</span><span style=color:#836c28>selectedKeys</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><ol start=4><li>获得一个类型为 Set 的 selectedKeys 集合。
可以通过 selectedKey 得知当前发生的是什么事件，有 isAcceptable、isReadable 等等。</li></ol><p>还能获得对应 channel 进行相应的读写操作，还有获取 attachment 等等。</p><p>所以得到了 selectedKeys 就可以通过迭代器遍历所有发生事件的连接，然后进行操作：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>while</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>int</span> <span style=color:#000>readyNum</span> <span style=color:#000>=</span> <span style=color:#000>selector</span><span style=color:#000>.</span><span style=color:#836c28>select</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>readyNum</span> <span style=color:#000>==</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>continue</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span> <span style=color:#000>Set</span> <span style=color:#000>selectedKeys</span> <span style=color:#000>=</span> <span style=color:#000>selector</span><span style=color:#000>.</span><span style=color:#836c28>selectedKeys</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span> <span style=color:#000>Iterator</span> <span style=color:#000>keyIterator</span> <span style=color:#000>=</span> <span style=color:#000>selectedKeys</span><span style=color:#000>.</span><span style=color:#836c28>iterator</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span> <span style=color:#a90d91>while</span><span style=color:#000>(</span><span style=color:#000>keyIterator</span><span style=color:#000>.</span><span style=color:#836c28>hasNext</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#000>=</span> <span style=color:#000>keyIterator</span><span style=color:#000>.</span><span style=color:#836c28>next</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span><span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>.</span><span style=color:#836c28>isAcceptable</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// a connection was accepted by a ServerSocketChannel.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>.</span><span style=color:#836c28>isConnectable</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// a connection was established with a remote server.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>.</span><span style=color:#836c28>isReadable</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// a channel is ready for reading
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>.</span><span style=color:#836c28>isWritable</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// a channel is ready for writing
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>keyIterator</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>();</span> <span style=color:#177500>//执行完毕之后，需要在循环内移除自己
</span></span></span><span style=display:flex><span><span style=color:#177500></span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>还有个方法是 Selector.wakeup()，可以唤醒阻塞着的 Selector。</p><p>前提：如果 Channel 要和 Selector 搭配，那它必须得是非阻塞的，即配置：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>channel</span><span style=color:#000>.</span><span style=color:#836c28>configureBlocking</span><span style=color:#000>(</span><span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>从上面的分析，可以得知 Selector 处理事件的时候必须快，如果长时间处理某个事件，那么注册到 Selector 上的其他连接的事件就不会被及时处理，造成客户端阻塞。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b9e16ec0238c418553119ef426476e8b>2 - Netty服务器启动源码分析</h1><h1 id=tips>Tips</h1><p>netty-xxx-sources.jar包中会有个example文件夹，里面有netty的使用案例。本文可以以 EchoServer为例</p><h2 id=idea查看xx-sources-jar>IDEA查看xx-sources.jar</h2><p>sources.jar包可以通过 Moudels -> 添加 -> 右键菜单 -> Copy to Module Libraries -> Copy library files to -> 项目的lib中可以看到该jar包</p><p><img src=../imgs/netty_source211215_1.png alt=netty_source211215_1.png></p><p><img src=../imgs/netty_source211215_2.png alt=netty_source211215_2.png></p><p>可以将demo的代码拷贝到项目中运行debug源码</p><h1 id=demo>Demo</h1><h2 id=echoserver-demo>EchoServer Demo</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// Configure SSL.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>final</span> <span style=color:#000>SslContext</span> <span style=color:#000>sslCtx</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>SSL</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SelfSignedCertificate</span> <span style=color:#000>ssc</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SelfSignedCertificate</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sslCtx</span> <span style=color:#000>=</span> <span style=color:#000>SslContextBuilder</span><span style=color:#000>.</span><span style=color:#836c28>forServer</span><span style=color:#000>(</span><span style=color:#000>ssc</span><span style=color:#000>.</span><span style=color:#836c28>certificate</span><span style=color:#000>(),</span> <span style=color:#000>ssc</span><span style=color:#000>.</span><span style=color:#836c28>privateKey</span><span style=color:#000>()).</span><span style=color:#836c28>build</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sslCtx</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// Configure the server.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#000>(</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>bossGroup</span><span style=color:#000>,</span> <span style=color:#000>workerGroup</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>         <span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// option添加TCP参数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>.</span><span style=color:#836c28>option</span><span style=color:#000>(</span><span style=color:#000>ChannelOption</span><span style=color:#000>.</span><span style=color:#836c28>SO_BACKLOG</span><span style=color:#000>,</span> <span style=color:#000>100</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>         <span style=color:#000>.</span><span style=color:#836c28>handler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>LoggingHandler</span><span style=color:#000>(</span><span style=color:#000>LogLevel</span><span style=color:#000>.</span><span style=color:#836c28>INFO</span><span style=color:#000>))</span>
</span></span><span style=display:flex><span>         <span style=color:#000>.</span><span style=color:#836c28>childHandler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#000>&lt;</span><span style=color:#000>SocketChannel</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>             <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>             <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>initChannel</span><span style=color:#000>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>ch</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                 <span style=color:#000>ChannelPipeline</span> <span style=color:#000>p</span> <span style=color:#000>=</span> <span style=color:#000>ch</span><span style=color:#000>.</span><span style=color:#836c28>pipeline</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                 <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>sslCtx</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>p</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#000>sslCtx</span><span style=color:#000>.</span><span style=color:#836c28>newHandler</span><span style=color:#000>(</span><span style=color:#000>ch</span><span style=color:#000>.</span><span style=color:#836c28>alloc</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>                 <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                 <span style=color:#177500>//p.addLast(new LoggingHandler(LogLevel.INFO));
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                 <span style=color:#000>p</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>EchoServerHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>             <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#000>});</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// Start the server.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#000>=</span> <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#000>PORT</span><span style=color:#000>).</span><span style=color:#836c28>sync</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// Wait until the server socket is closed.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>f</span><span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>().</span><span style=color:#836c28>closeFuture</span><span style=color:#000>().</span><span style=color:#836c28>sync</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// Shut down all event loops to terminate all threads.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>bossGroup</span><span style=color:#000>.</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>workerGroup</span><span style=color:#000>.</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=普通demo>普通Demo</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#000>(</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>bossGroup</span><span style=color:#000>,</span> <span style=color:#000>workerGroup</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>.</span><span style=color:#836c28>handler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>SimpleServerHandler</span><span style=color:#000>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>.</span><span style=color:#836c28>childHandler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>SimpleServerInitializer</span><span style=color:#000>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>.</span><span style=color:#836c28>option</span><span style=color:#000>(</span><span style=color:#000>ChannelOption</span><span style=color:#000>.</span><span style=color:#836c28>SO_BACKLOG</span><span style=color:#000>,</span> <span style=color:#000>128</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>.</span><span style=color:#836c28>childOption</span><span style=color:#000>(</span><span style=color:#000>ChannelOption</span><span style=color:#000>.</span><span style=color:#836c28>SO_KEEPALIVE</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#000>=</span> <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#000>8989</span><span style=color:#000>).</span><span style=color:#836c28>sync</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>f</span><span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>().</span><span style=color:#836c28>closeFuture</span><span style=color:#000>().</span><span style=color:#836c28>sync</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>bossGroup</span><span style=color:#000>.</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>workerGroup</span><span style=color:#000>.</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>以下源码以 netty-4.1.1-Final.jar为例</p><h1 id=nioeventloopgroup>NioEventLoopGroup</h1><p>以下根据 EchoServer 的main 的入口源码进行分析</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.example.echo.EchoServer#main
</span></span></span><span style=display:flex><span><span style=color:#177500>// Configure the server.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#000>(</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=multithreadeventexecutorgroup>MultithreadEventExecutorGroup</h2><p>NioEventLoopGroup继承了该类，其初始化主要该类的初始化过程。</p><h2 id=默认线程个数>默认线程个数</h2><p>通过对 NioEventLoopGroup() 的跟踪，发现如果未指定线程个数，会调用MultithreadEventLoopGroup构造函数，默认使用 DEFAULT_EVENT_LOOP_THREADS ，而该参数的初始化是：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.MultithreadEventLoopGroup#
</span></span></span><span style=display:flex><span><span style=color:#177500>// MultithreadEventLoopGroup(int, java.util.concurrent.Executor, java.lang.Object...)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>int</span> <span style=color:#000>DEFAULT_EVENT_LOOP_THREADS</span> <span style=color:#000>=</span> <span style=color:#000>Math</span><span style=color:#000>.</span><span style=color:#836c28>max</span><span style=color:#000>(</span><span style=color:#000>1</span><span style=color:#000>,</span> <span style=color:#000>SystemPropertyUtil</span><span style=color:#000>.</span><span style=color:#836c28>getInt</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;io.netty.eventLoopThreads&#34;</span><span style=color:#000>,</span> <span style=color:#000>Runtime</span><span style=color:#000>.</span><span style=color:#836c28>getRuntime</span><span style=color:#000>().</span><span style=color:#836c28>availableProcessors</span><span style=color:#000>()</span> <span style=color:#000>*</span> <span style=color:#000>2</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>MultithreadEventLoopGroup</span><span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>nThreads</span><span style=color:#000>,</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>...</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#000>nThreads</span> <span style=color:#000>==</span> <span style=color:#000>0</span> <span style=color:#000>?</span> <span style=color:#000>DEFAULT_EVENT_LOOP_THREADS</span> <span style=color:#000>:</span> <span style=color:#000>nThreads</span><span style=color:#000>,</span> <span style=color:#000>executor</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=参数说明>参数说明</h2><p>该类的构造方法才是 NioEventLoopGroup 真正的构造方法，这里可以看做是一个<strong>模板方法（设计模式）。</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.util.concurrent.MultithreadEventExecutorGroup
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#177500>/**
</span></span></span><span style=display:flex><span><span style=color:#177500> * Create a new instance.
</span></span></span><span style=display:flex><span><span style=color:#177500> *
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param nThreads          the number of threads that will be used by this instance.
</span></span></span><span style=display:flex><span><span style=color:#177500> 使用的线程数，默认 处理器个数*2
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param executor          the Executor to use, or {@code null} if the default should be used.
</span></span></span><span style=display:flex><span><span style=color:#177500> 执行器，如果传入null，则采用Netty默认的线程工厂和默认的执行器ThreadPerTaskExecutor
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param chooserFactory    the {@link EventExecutorChooserFactory} to use.
</span></span></span><span style=display:flex><span><span style=color:#177500> 单例new DefaultEventExecutorChooserFactory()
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param args              arguments which will passed to each {@link #newChild(Executor, Object...)} call
</span></span></span><span style=display:flex><span><span style=color:#177500> 在创建执行器的时候传入固定参数
</span></span></span><span style=display:flex><span><span style=color:#177500> */</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>MultithreadEventExecutorGroup</span><span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>nThreads</span><span style=color:#000>,</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>EventExecutorChooserFactory</span> <span style=color:#000>chooserFactory</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>...</span> <span style=color:#000>args</span><span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=初始化过程>初始化过程</h2><p>往下可以看到会创建 EventExecutor 数组 children</p><p>可以通过快捷键 ctrl + H（mac系统）查看类的 EventExecutor 类的层次结构，可以发现 EventExecutor &lt;- SingleThreadEventLoop &lt;- NioEventLoop，这里每个元素的类型是 NioEventLoop。</p><p>该函数中还对每个元素加了监听器</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#000>MultithreadEventExecutorGroup</span><span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>nThreads</span><span style=color:#000>,</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>EventExecutorChooserFactory</span> <span style=color:#000>chooserFactory</span><span style=color:#000>,</span> <span style=color:#000>Object</span><span style=color:#000>...</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>nThreads</span> <span style=color:#000>&lt;=</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>.</span><span style=color:#836c28>format</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;nThreads: %d (expected: &gt; 0)&#34;</span><span style=color:#000>,</span> <span style=color:#000>nThreads</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>executor</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>executor</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ThreadPerTaskExecutor</span><span style=color:#000>(</span><span style=color:#000>newDefaultThreadFactory</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 创建指定线程数的执行器数组
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>children</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>EventExecutor</span><span style=color:#000>[</span><span style=color:#000>nThreads</span><span style=color:#000>];</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 初始化线程数组
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>i</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span> <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>nThreads</span><span style=color:#000>;</span> <span style=color:#000>i</span> <span style=color:#000>++)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>boolean</span> <span style=color:#000>success</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 创建 new NioEventLoop
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>children</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>=</span> <span style=color:#000>newChild</span><span style=color:#000>(</span><span style=color:#000>executor</span><span style=color:#000>,</span> <span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>success</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// TODO: Think about if this is a good exception type
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;failed to create a child event loop&#34;</span><span style=color:#000>,</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 创建失败，优雅关闭之前几个成功创建的 NioEventLoop
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>success</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>j</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span> <span style=color:#000>j</span> <span style=color:#000>&lt;</span> <span style=color:#000>i</span><span style=color:#000>;</span> <span style=color:#000>j</span> <span style=color:#000>++)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>children</span><span style=color:#000>[</span><span style=color:#000>j</span><span style=color:#000>].</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>j</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span> <span style=color:#000>j</span> <span style=color:#000>&lt;</span> <span style=color:#000>i</span><span style=color:#000>;</span> <span style=color:#000>j</span> <span style=color:#000>++)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>EventExecutor</span> <span style=color:#000>e</span> <span style=color:#000>=</span> <span style=color:#000>children</span><span style=color:#000>[</span><span style=color:#000>j</span><span style=color:#000>];</span>
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>while</span> <span style=color:#000>(!</span><span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>isTerminated</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>awaitTermination</span><span style=color:#000>(</span><span style=color:#000>Integer</span><span style=color:#000>.</span><span style=color:#836c28>MAX_VALUE</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>SECONDS</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>interrupted</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#177500>// Let the caller handle the interruption.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                        <span style=color:#000>Thread</span><span style=color:#000>.</span><span style=color:#836c28>currentThread</span><span style=color:#000>().</span><span style=color:#836c28>interrupt</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>chooser</span> <span style=color:#000>=</span> <span style=color:#000>chooserFactory</span><span style=color:#000>.</span><span style=color:#836c28>newChooser</span><span style=color:#000>(</span><span style=color:#000>children</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>FutureListener</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>terminationListener</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FutureListener</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>operationComplete</span><span style=color:#000>(</span><span style=color:#000>Future</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>future</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>terminatedChildren</span><span style=color:#000>.</span><span style=color:#836c28>incrementAndGet</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#000>children</span><span style=color:#000>.</span><span style=color:#836c28>length</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>terminationFuture</span><span style=color:#000>.</span><span style=color:#836c28>setSuccess</span><span style=color:#000>(</span><span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>};</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 为每个单例线程池添加一个关闭监听器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>EventExecutor</span> <span style=color:#000>e</span><span style=color:#000>:</span> <span style=color:#000>children</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>terminationFuture</span><span style=color:#000>().</span><span style=color:#836c28>addListener</span><span style=color:#000>(</span><span style=color:#000>terminationListener</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Set</span><span style=color:#000>&lt;</span><span style=color:#000>EventExecutor</span><span style=color:#000>&gt;</span> <span style=color:#000>childrenSet</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#000>&lt;</span><span style=color:#000>EventExecutor</span><span style=color:#000>&gt;(</span><span style=color:#000>children</span><span style=color:#000>.</span><span style=color:#836c28>length</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 将所有的单例线程池添加到一个 HashSet 中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>addAll</span><span style=color:#000>(</span><span style=color:#000>childrenSet</span><span style=color:#000>,</span> <span style=color:#000>children</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>readonlyChildren</span> <span style=color:#000>=</span> <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>unmodifiableSet</span><span style=color:#000>(</span><span style=color:#000>childrenSet</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>分析说明：
1、如果 executor 是null，创建一个默认的 ThreadPerTaskExecutor，使用Netty默认的线程工厂</p><p>2、根据传入的线程数（CPU*2）创建一个线程池的（单例线程池）数组</p><p>3、循环填充数组中元素。如果异常，则关闭所有的单例线程池</p><p>4、根据线程选择工程创建一个 线程选择器</p><p>5、为每一个单例线程池添加一个关闭监听器</p><p>6、将所有单例线程池添加到一个 HashSet 中</p><h2 id=nioeventloop>NioEventLoop</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.nio.NioEventLoop#NioEventLoop
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>NioEventLoop</span><span style=color:#000>(</span><span style=color:#000>NioEventLoopGroup</span> <span style=color:#000>parent</span><span style=color:#000>,</span> <span style=color:#000>ThreadFactory</span> <span style=color:#000>threadFactory</span><span style=color:#000>,</span> <span style=color:#000>SelectorProvider</span> <span style=color:#000>selectorProvider</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#000>parent</span><span style=color:#000>,</span> <span style=color:#000>threadFactory</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>selectorProvider</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;selectorProvider&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>provider</span> <span style=color:#000>=</span> <span style=color:#000>selectorProvider</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>selector</span> <span style=color:#000>=</span> <span style=color:#000>openSelector</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=heading></h3><h3 id=父类singlethreadeventexecutor>父类SingleThreadEventExecutor</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 
</span></span></span></code></pre></td></tr></table></div></div></div><p>该初始化函数主要做了两件事：
1、利用ThreadFactory创建来一个Thread，传入了一个Runnable对象，该Runnable重写的run代码比较长，不过重点仅仅是调用NioEventLoop类的run方法。</p><p>2、使用LinkedBlockingQueue类初始化taskQueue 。</p><h1 id=绑定group>绑定group</h1><p>用于后期引导使用</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.ServerBootstrap#
</span></span></span><span style=display:flex><span><span style=color:#177500>// group(io.netty.channel.EventLoopGroup, io.netty.channel.EventLoopGroup)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>ServerBootstrap</span> <span style=color:#000>group</span><span style=color:#000>(</span><span style=color:#000>EventLoopGroup</span> <span style=color:#000>parentGroup</span><span style=color:#000>,</span> <span style=color:#000>EventLoopGroup</span> <span style=color:#000>childGroup</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>parentGroup</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>childGroup</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;childGroup&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>childGroup</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;childGroup set already&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>childGroup</span> <span style=color:#000>=</span> <span style=color:#000>childGroup</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#a90d91>this</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=添加channel>添加channel</h1><p>其中参数一个Class对象，引导类将通过这个Class对象反射创建 ChannelFactory。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.AbstractBootstrap#channel
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>B</span> <span style=color:#000>channel</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?</span> <span style=color:#a90d91>extends</span> <span style=color:#000>C</span><span style=color:#000>&gt;</span> <span style=color:#000>channelClass</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>channelClass</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;channelClass&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>channelFactory</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ReflectiveChannelFactory</span><span style=color:#000>&lt;</span><span style=color:#000>C</span><span style=color:#000>&gt;(</span><span style=color:#000>channelClass</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>channel的创建<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.AbstractBootstrap#initAndRegister
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>final</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>initAndRegister</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span> <span style=color:#000>=</span> <span style=color:#000>channelFactory</span><span style=color:#000>.</span><span style=color:#836c28>newChannel</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>init</span><span style=color:#000>(</span><span style=color:#000>channel</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></td></tr></table></div></div></div></p><p>可以通过 debug 或 查看 initAndRegister 方法调用层次</p><h1 id=日志处理器handler>日志处理器handler</h1><p>添加服务器专属日志处理器handler。</p><p>注意是 ServerSocketChannel</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>.</span><span style=color:#836c28>handler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>LoggingHandler</span><span style=color:#000>(</span><span style=color:#000>LogLevel</span><span style=color:#000>.</span><span style=color:#836c28>INFO</span><span style=color:#000>))</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=heading-1></h3><h1 id=xxserverhandler>xxServerHandler</h1><p>添加SocketChannel的handler</p><p>注意不是 ServerSocketChannel</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>.childHandler<span style=color:#000>(</span>xx<span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这是一个普通的处理器类，用于处理客户端发送来的消息，入口函数中在 ServerBootstrap 的 .chanldHanlder 中添加该hanlder。</p><p>这里处理主要分析客户端发送内容来解析、打印、响应发送字符串给客户端的过程。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.example.echo.EchoServerHandler
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Sharable</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>EchoServerHandler</span> <span style=color:#a90d91>extends</span> <span style=color:#000>ChannelInboundHandlerAdapter</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>channelRead</span><span style=color:#000>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#000>,</span> <span style=color:#000>Object</span> <span style=color:#000>msg</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ctx</span><span style=color:#000>.</span><span style=color:#836c28>write</span><span style=color:#000>(</span><span style=color:#000>msg</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>channelReadComplete</span><span style=color:#000>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ctx</span><span style=color:#000>.</span><span style=color:#836c28>flush</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>exceptionCaught</span><span style=color:#000>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#000>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// Close the connection when an exception is raised.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>cause</span><span style=color:#000>.</span><span style=color:#836c28>printStackTrace</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ctx</span><span style=color:#000>.</span><span style=color:#836c28>close</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=serverbootstrap>ServerBootstrap</h1><p>try块中创建了一个 ServerBootstrap 对象，它是一个引导类，用于启动服务器和引导整个程序的初始化。它和 ServerChannel 关联，而 ServerChannel 继承了 Channel。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>bossGroup</span><span style=color:#000>,</span> <span style=color:#000>workerGroup</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>.</span><span style=color:#836c28>option</span><span style=color:#000>(</span><span style=color:#000>ChannelOption</span><span style=color:#000>.</span><span style=color:#836c28>SO_BACKLOG</span><span style=color:#000>,</span> <span style=color:#000>100</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>.</span><span style=color:#836c28>handler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>LoggingHandler</span><span style=color:#000>(</span><span style=color:#000>LogLevel</span><span style=color:#000>.</span><span style=color:#836c28>INFO</span><span style=color:#000>))</span>
</span></span><span style=display:flex><span>     <span style=color:#000>.</span><span style=color:#836c28>childHandler</span><span style=color:#000>(</span><span style=color:#000>xxxxx</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=类的继承关系>类的继承关系</h2><p>ServerBootstrap -> AbstractBootstrap --> Cloneable</p><h2 id=空构造函数>空构造函数</h2><p>但是有默认的成员变量，会直接初始化</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.ServerBootstrap
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>ChannelOption</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>childOptions</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#000>&lt;</span><span style=color:#000>ChannelOption</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>AttributeKey</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>childAttrs</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#000>&lt;</span><span style=color:#000>AttributeKey</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#177500>// config很重要，后面会用到
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>ServerBootstrapConfig</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrapConfig</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>volatile</span> <span style=color:#000>EventLoopGroup</span> <span style=color:#000>childGroup</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>volatile</span> <span style=color:#000>ChannelHandler</span> <span style=color:#000>childHandler</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>()</span> <span style=color:#000>{</span> <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=构造过程>构造过程</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>bossGroup</span><span style=color:#000>,</span> <span style=color:#000>workerGroup</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span> <span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span> <span style=color:#000>.</span><span style=color:#836c28>option</span><span style=color:#000>(</span><span style=color:#000>ChannelOption</span><span style=color:#000>.</span><span style=color:#836c28>SO_BACKLOG</span><span style=color:#000>,</span> <span style=color:#000>100</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span> <span style=color:#000>.</span><span style=color:#836c28>handler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>LoggingHandler</span><span style=color:#000>(</span><span style=color:#000>LogLevel</span><span style=color:#000>.</span><span style=color:#836c28>INFO</span><span style=color:#000>))</span>
</span></span><span style=display:flex><span> <span style=color:#000>.</span><span style=color:#836c28>childHandler</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#000>&lt;</span><span style=color:#000>SocketChannel</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>     <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>     <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>initChannel</span><span style=color:#000>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>ch</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>ChannelPipeline</span> <span style=color:#000>p</span> <span style=color:#000>=</span> <span style=color:#000>ch</span><span style=color:#000>.</span><span style=color:#836c28>pipeline</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>sslCtx</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>             <span style=color:#000>p</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#000>sslCtx</span><span style=color:#000>.</span><span style=color:#836c28>newHandler</span><span style=color:#000>(</span><span style=color:#000>ch</span><span style=color:#000>.</span><span style=color:#836c28>alloc</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>//p.addLast(new LoggingHandler(LogLevel.INFO));
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>p</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>EchoServerHandler</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>     <span style=color:#000>}</span>
</span></span><span style=display:flex><span> <span style=color:#000>});</span>
</span></span></code></pre></td></tr></table></div></div></div><p>分析说明：
1、链式调用：group 方法，将boss和worker传入，boss赋值给parentGroup属性，worker赋值给childGroup属性</p><p>2、channel 方法传入 NioServerSocketChannel.class 对象。会根据这个创建 channel 对象</p><p>3、option 方法传入TCP参数，放在一个LinkedHashMap中</p><p>4、handler 方法传入一个hanlder，该hanler专属于 ServerSocketChannel 而不是 SocketChannel</p><p>5、childHandler 传入一个handler，这个handler将会在每个客户端连接的时候调用。供 SocketChannel 使用。</p><h1 id=绑定端口>绑定端口</h1><p>服务器在bind方法中启动完成的</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.example.echo.EchoServer#main
</span></span></span><span style=display:flex><span><span style=color:#177500>// Start the server.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#000>=</span> <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#000>PORT</span><span style=color:#000>).</span><span style=color:#836c28>sync</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=bind方法>bind方法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.AbstractBootstrap
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>bind</span><span style=color:#000>(</span><span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>validate</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>localAddress</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;localAddress&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>doBind</span><span style=color:#000>(</span><span style=color:#000>localAddress</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>核心代码为doBind方法</p><h3 id=validate方法>validate方法</h3><p>该方法主要检查了两个参数，一个是group，一个是channelFactory。</p><p>这两个将bossGroup赋值给了group，将BootstrapChannelFactory赋值给了channelFactory。赋值如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>bossGroup</span><span style=color:#000>,</span> <span style=color:#000>workerGroup</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=dobind方法>doBind方法</h2><p>核心是两个方法 initAndRegister 和 doBind0</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.AbstractBootstrap#doBind
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>doBind</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>regFuture</span> <span style=color:#000>=</span> <span style=color:#000>initAndRegister</span><span style=color:#000>();</span> <span style=color:#177500>// 1
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span> <span style=color:#000>=</span> <span style=color:#000>regFuture</span><span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>regFuture</span><span style=color:#000>.</span><span style=color:#836c28>cause</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span> <span style=color:#177500>// 2
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>return</span> <span style=color:#000>regFuture</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>regFuture</span><span style=color:#000>.</span><span style=color:#836c28>isDone</span><span style=color:#000>())</span> <span style=color:#000>{</span> <span style=color:#177500>// 3
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#177500>// At this point we know that the registration was complete and successful.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span> <span style=color:#000>=</span> <span style=color:#000>channel</span><span style=color:#000>.</span><span style=color:#836c28>newPromise</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>doBind0</span><span style=color:#000>(</span><span style=color:#000>regFuture</span><span style=color:#000>,</span> <span style=color:#000>channel</span><span style=color:#000>,</span> <span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>promise</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span> <span style=color:#177500>// 4
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#177500>// Registration future is almost always fulfilled already, but just in case it&#39;s not.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>final</span> <span style=color:#000>PendingRegistrationPromise</span> <span style=color:#000>promise</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>PendingRegistrationPromise</span><span style=color:#000>(</span><span style=color:#000>channel</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>regFuture</span><span style=color:#000>.</span><span style=color:#836c28>addListener</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>operationComplete</span><span style=color:#000>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>Throwable</span> <span style=color:#000>cause</span> <span style=color:#000>=</span> <span style=color:#000>future</span><span style=color:#000>.</span><span style=color:#836c28>cause</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>cause</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#177500>// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                    <span style=color:#177500>// IllegalStateException once we try to access the EventLoop of the Channel.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                    <span style=color:#000>promise</span><span style=color:#000>.</span><span style=color:#836c28>setFailure</span><span style=color:#000>(</span><span style=color:#000>cause</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#177500>// Registration was successful, so set the correct executor to use.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                    <span style=color:#177500>// See https://github.com/netty/netty/issues/2586
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                    <span style=color:#000>promise</span><span style=color:#000>.</span><span style=color:#836c28>registered</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>doBind0</span><span style=color:#000>(</span><span style=color:#000>regFuture</span><span style=color:#000>,</span> <span style=color:#000>channel</span><span style=color:#000>,</span> <span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>});</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>promise</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>doBind函数是分析重点，主要工作如下：
1、initAndRegister()方法得到一个ChannelFuture的实例regFuture。</p><p>2、regFuture.cause()方法判断是否在执行initAndRegister方法时产生来异常。如果产生异常直接返回，如果没有则进行第3步。</p><p>3、通过regFuture.isDone()来判断initAndRegister方法是否执行完毕，如果执行完成返回true，然后调用doBind0进行socket绑定。如果没有执行完成则返回false进行第4步。</p><p>4、regFuture会添加一个ChannelFutureListener监听，当initAndRegister执行完成时，调用operationComplete方法并执行doBind0进行socket绑定。</p><p>第3、4步同一个目的：调用doBind0方法进行socket绑定。</p><h3 id=initandregister>initAndRegister</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.bootstrap.AbstractBootstrap#initAndRegister
</span></span><span style=display:flex><span>final ChannelFuture initAndRegister() {
</span></span><span style=display:flex><span>    final Channel channel = channelFactory.newChannel();
</span></span><span style=display:flex><span>    try {
</span></span><span style=display:flex><span>        init(channel);
</span></span><span style=display:flex><span>    } catch (Throwable t) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ChannelFuture regFuture = group().register(channel);
</span></span></code></pre></td></tr></table></div></div></div><p>这里初始化 children channel。</p><h4 id=newchannel分析>newChannel分析</h4><p>上面介绍过，channelFactory 是通过如下方式赋值的</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>group</span><span style=color:#000>(</span><span style=color:#000>bossGroup</span><span style=color:#000>,</span> <span style=color:#000>workerGroup</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>channelFactory.newChannel() 方法的作用是通过 ServerBootstrap 的通道工厂反射创建一个 NioServerSocketChannel。
分析 NioServerSocketChannel 的构造函数：</p><p>0、继承关系</p><p><strong>NioServerSocketChannel -> AbstractNioMessageChannel -> AbstractNioChannel -> AbstractChannel</strong></p><p>1、通过NIO的 SelectorProvider 的 openServerSocketChannel 方法可以得到JDK的 channel，目的是让Netty包装JDK的channel</p><p>2、调用父类设置到ch属性中，并设置为非阻塞</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>// io.netty.channel.nio.AbstractNioChannel#AbstractNioChannel
</span></span><span style=display:flex><span>protected AbstractNioChannel<span style=color:#000>(</span>Channel parent, SelectableChannel ch, int readInterestOp<span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    super<span style=color:#000>(</span>parent<span style=color:#000>)</span>;
</span></span><span style=display:flex><span>    this.ch <span style=color:#000>=</span> ch;
</span></span><span style=display:flex><span>    this.readInterestOp <span style=color:#000>=</span> readInterestOp;
</span></span><span style=display:flex><span>    try <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        ch.configureBlocking<span style=color:#000>(</span><span style=color:#a90d91>false</span><span style=color:#000>)</span>;
</span></span></code></pre></td></tr></table></div></div></div><p>3、设置config属性<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.channel.socket.nio.NioServerSocketChannel#NioServerSocketChannel
</span></span><span style=display:flex><span>public NioServerSocketChannel(ServerSocketChannel channel) {
</span></span><span style=display:flex><span>    super(null, channel, SelectionKey.OP_ACCEPT);
</span></span><span style=display:flex><span>    config = new NioServerSocketChannelConfig(this, javaChannel().socket());
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p><p>NioServerSocketChannelConfig 对象，用于对外展示一些配置。
4、调用父构造函数设置unsafe属性、pipeline属性、ChannelId等</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.AbstractChannel#AbstractChannel
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#000>AbstractChannel</span><span style=color:#000>(</span><span style=color:#000>Channel</span> <span style=color:#000>parent</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>parent</span> <span style=color:#000>=</span> <span style=color:#000>parent</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>id</span> <span style=color:#000>=</span> <span style=color:#000>newId</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>unsafe</span> <span style=color:#000>=</span> <span style=color:#000>newUnsafe</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>pipeline</span> <span style=color:#000>=</span> <span style=color:#000>newChannelPipeline</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>NioMessageUnsafe 是在 AbstractNioMessageChannel 中创建的，用于操作消息。（cmd+F12查看NioServerSocketChannel及其父类的newUnsafe方法）
DefaultChannelPipeline 管道，是个双向链表结构，用于过滤所有的进出的消息。</p><h4 id=init分析>init分析</h4><p>1、init方法是AbstractBootstrap的抽象方法，具体由 ServerBootstrap 实现（上面分析b对象是new ServerBootstrap）</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.ServerBootstrap#init
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>init</span><span style=color:#000>(</span><span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>ChannelOption</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>options</span> <span style=color:#000>=</span> <span style=color:#000>options0</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>options</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>channel</span><span style=color:#000>.</span><span style=color:#836c28>config</span><span style=color:#000>().</span><span style=color:#836c28>setOptions</span><span style=color:#000>(</span><span style=color:#000>options</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>AttributeKey</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>attrs</span> <span style=color:#000>=</span> <span style=color:#000>attrs0</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>attrs</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>Entry</span><span style=color:#000>&lt;</span><span style=color:#000>AttributeKey</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>e</span><span style=color:#000>:</span> <span style=color:#000>attrs</span><span style=color:#000>.</span><span style=color:#836c28>entrySet</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@SuppressWarnings</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;unchecked&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>AttributeKey</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;</span> <span style=color:#000>key</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>AttributeKey</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;)</span> <span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>getKey</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>channel</span><span style=color:#000>.</span><span style=color:#836c28>attr</span><span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>).</span><span style=color:#836c28>set</span><span style=color:#000>(</span><span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>getValue</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ChannelPipeline</span> <span style=color:#000>p</span> <span style=color:#000>=</span> <span style=color:#000>channel</span><span style=color:#000>.</span><span style=color:#836c28>pipeline</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>EventLoopGroup</span> <span style=color:#000>currentChildGroup</span> <span style=color:#000>=</span> <span style=color:#000>childGroup</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>ChannelHandler</span> <span style=color:#000>currentChildHandler</span> <span style=color:#000>=</span> <span style=color:#000>childHandler</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Entry</span><span style=color:#000>&lt;</span><span style=color:#000>ChannelOption</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;[]</span> <span style=color:#000>currentChildOptions</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Entry</span><span style=color:#000>&lt;</span><span style=color:#000>AttributeKey</span><span style=color:#000>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#000>&gt;[]</span> <span style=color:#000>currentChildAttrs</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>childOptions</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>currentChildOptions</span> <span style=color:#000>=</span> <span style=color:#000>childOptions</span><span style=color:#000>.</span><span style=color:#836c28>entrySet</span><span style=color:#000>().</span><span style=color:#836c28>toArray</span><span style=color:#000>(</span><span style=color:#000>newOptionArray</span><span style=color:#000>(</span><span style=color:#000>childOptions</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>synchronized</span> <span style=color:#000>(</span><span style=color:#000>childAttrs</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>currentChildAttrs</span> <span style=color:#000>=</span> <span style=color:#000>childAttrs</span><span style=color:#000>.</span><span style=color:#836c28>entrySet</span><span style=color:#000>().</span><span style=color:#836c28>toArray</span><span style=color:#000>(</span><span style=color:#000>newAttrArray</span><span style=color:#000>(</span><span style=color:#000>childAttrs</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>p</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#000>&lt;</span><span style=color:#000>Channel</span><span style=color:#000>&gt;()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>initChannel</span><span style=color:#000>(</span><span style=color:#000>Channel</span> <span style=color:#000>ch</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ChannelPipeline</span> <span style=color:#000>pipeline</span> <span style=color:#000>=</span> <span style=color:#000>ch</span><span style=color:#000>.</span><span style=color:#836c28>pipeline</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ChannelHandler</span> <span style=color:#000>handler</span> <span style=color:#000>=</span> <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>handler</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>handler</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>pipeline</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#000>handler</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>pipeline</span><span style=color:#000>.</span><span style=color:#836c28>addLast</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>ServerBootstrapAcceptor</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>currentChildGroup</span><span style=color:#000>,</span> <span style=color:#000>currentChildHandler</span><span style=color:#000>,</span> <span style=color:#000>currentChildOptions</span><span style=color:#000>,</span> <span style=color:#000>currentChildAttrs</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>});</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>2、设置 NioServerSocketChannel 的TCP属性，options
3、由于 LinkedHashMap 是非线程安全的，使用同步进行处理</p><p>4、对 NioServerSocketChannel 的 ChannelPipeline 添加 ChannelInitializer 处理器，重写 initChannel 方法，该方法通过 addList 向 serverChannel 的流水线处理器重加了一个 ServerBootstrapAcceptor，这是一个接入器，专门接受新请求，并扔给某个事件循环器</p><p>5、可以分析出，init 方法的核心作用是和 ChannelPipeline 相关</p><p>6、从 NioServerSocketChannel 的初始化过程可以分析出：pipeline是一个双向链表，并且本身初始化了 head 和 tail。ChannelPipeline 的 addLast 方法是将 hanlder 插入到 tail 的前面，tail永远在后面，用于做一些系统的固定工作。</p><p>总结</p><p>init只是初始化一些基本的配置和属性，以及在pipeline加入一个接入器，用来专门接受新请求，而并没有启动服务。</p><p><strong>分析addLast方法</strong></p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.channel.DefaultChannelPipeline#addLast(io.netty.util.concurrent.EventExecutorGroup, java.lang.String, io.netty.channel.ChannelHandler)
</span></span><span style=display:flex><span>@Override
</span></span><span style=display:flex><span>public final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {
</span></span><span style=display:flex><span>    final AbstractChannelHandlerContext newCtx;
</span></span><span style=display:flex><span>    synchronized (this) {
</span></span><span style=display:flex><span>        checkMultiplicity(handler);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        newCtx = newContext(group, filterName(name, handler), handler);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        addLast0(newCtx);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        if (!registered) {
</span></span><span style=display:flex><span>            callHandlerCallbackLater(newCtx, true);
</span></span><span style=display:flex><span>            return this;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        EventExecutor executor = newCtx.executor();
</span></span><span style=display:flex><span>        if (!executor.inEventLoop()) {
</span></span><span style=display:flex><span>            executor.execute(new OneTimeTask() {
</span></span><span style=display:flex><span>                @Override
</span></span><span style=display:flex><span>                public void run() {
</span></span><span style=display:flex><span>                    callHandlerAdded0(newCtx);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>            return this;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    callHandlerAdded0(newCtx);
</span></span><span style=display:flex><span>    return this;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>addLast 最终会调用 addLast0 方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.channel.DefaultChannelPipeline#addLast0
</span></span><span style=display:flex><span>private void addLast0(AbstractChannelHandlerContext newCtx) {
</span></span><span style=display:flex><span>    AbstractChannelHandlerContext prev = tail.prev;
</span></span><span style=display:flex><span>    newCtx.prev = prev;
</span></span><span style=display:flex><span>    newCtx.next = tail;
</span></span><span style=display:flex><span>    prev.next = newCtx;
</span></span><span style=display:flex><span>    tail.prev = newCtx;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p><p>addList结论：
1、addLast 方法在 DefaultChannelPipeline 类中</p><p>2、addList 方法是 pipeline 方法的核心</p><p>3、检查该 handler 是否符合标准</p><p>4、创建一个 AbstractChannelHandlerContext 对象</p><p>说明：ChannelHandlerContext 对象是 ChannelHandler 和 ChannelPipeline 之间的关联，每当有 ChannelHandler 添加到 Pipeline 中时，都会创建Context。</p><p>Context的主要功能是管理他所关联的 Handler 和同一个 Pipeline 中的其他 Handler 之间的交互。</p><p>5、将 Context 添加到链表中。也就是追加到 tail 节点的前面</p><p>6、最后，同步或异步或晚点异步的调用 callHandlerAdded 方法</p><h4 id=register-channel>register channel</h4><p>继续看 initAndRegister 中的 register</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.bootstrap.AbstractBootstrap#initAndRegister
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>ChannelFuture</span> <span style=color:#000>regFuture</span> <span style=color:#000>=</span> <span style=color:#000>group</span><span style=color:#000>().</span><span style=color:#836c28>register</span><span style=color:#000>(</span><span style=color:#000>channel</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>由上文知道这里group为MultithreadEventLoopGroup，其register方法为<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.MultithreadEventLoopGroup#register
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>register</span><span style=color:#000>(</span><span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>next</span><span style=color:#000>().</span><span style=color:#836c28>register</span><span style=color:#000>(</span><span style=color:#000>channel</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>这里 next() 可以跟踪到父类初始化 chooser 根据是 executors.length 选择，next方法对length做了一点区别处理。
next的主要作用是因为 NioEventLoopGroup 中维护着多个 NioEventLoop，next方法回调用chooser策略找到下一个 NioEventLoop，并执行该对象的register方法进行注册。</p><p>register 实际调用 SingleThreadEventLoop</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.SingleThreadEventLoop#register
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>register</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ObjectUtil</span><span style=color:#000>.</span><span style=color:#836c28>checkNotNull</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;promise&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>promise</span><span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>().</span><span style=color:#836c28>unsafe</span><span style=color:#000>().</span><span style=color:#836c28>register</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>,</span> <span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>promise</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>unsafe上文分析了是 NioMessageUnsafe，unsafe().register方法实际调用 AbstractUnsafe 的方法<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.AbstractChannel.AbstractUnsafe#register
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>void</span> <span style=color:#000>register</span><span style=color:#000>(</span><span style=color:#000>EventLoop</span> <span style=color:#000>eventLoop</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>eventLoop</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;eventLoop&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 判断该 channel 是否已经被注册到 EventLoop 中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>isRegistered</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>promise</span><span style=color:#000>.</span><span style=color:#836c28>setFailure</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;registered to an event loop already&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>isCompatible</span><span style=color:#000>(</span><span style=color:#000>eventLoop</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>promise</span><span style=color:#000>.</span><span style=color:#836c28>setFailure</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;incompatible event loop type: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>eventLoop</span><span style=color:#000>.</span><span style=color:#836c28>getClass</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 将 eventLoop 设置到 NioServerSocketChannel 中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>AbstractChannel</span><span style=color:#000>.</span><span style=color:#836c28>this</span><span style=color:#000>.</span><span style=color:#836c28>eventLoop</span> <span style=color:#000>=</span> <span style=color:#000>eventLoop</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 判断当前线程是否为该 EventLoop 中拥有的线程，
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// 如果是直接注册，否则添加一个任务到该线程中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>eventLoop</span><span style=color:#000>.</span><span style=color:#836c28>inEventLoop</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>register0</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 非常重要
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>eventLoop</span><span style=color:#000>.</span><span style=color:#836c28>execute</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>OneTimeTask</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>register0</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>});</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#c41a16>&#34;Force-closing a channel whose registration task was not accepted by an event loop: {}&#34;</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>AbstractChannel</span><span style=color:#000>.</span><span style=color:#836c28>this</span><span style=color:#000>,</span> <span style=color:#000>t</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>closeForcibly</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>closeFuture</span><span style=color:#000>.</span><span style=color:#836c28>setClosed</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>safeSetFailure</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>,</span> <span style=color:#000>t</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>基本逻辑如下：
1、通过 eventLoop.inEventLoop() 判断当前线程是否为该 EventLoop 中拥有的线程，如果是直接注册，否则说明该 EventLoop 在等待并没有执行权。</p><p>2、提交一个任务到该线程中，等该 EventLoop 的线程有执行权就会执行该任务（负责调用调用 register0 方法）</p><p>重点为 register0 方法。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.channel.AbstractChannel.AbstractUnsafe#register0
</span></span><span style=display:flex><span>private void register0(ChannelPromise promise) {
</span></span><span style=display:flex><span>    try {
</span></span><span style=display:flex><span>        xxxx
</span></span><span style=display:flex><span>        doRegister();
</span></span><span style=display:flex><span>        neverRegistered = false;
</span></span><span style=display:flex><span>        registered = true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        safeSetSuccess(promise);
</span></span><span style=display:flex><span>        pipeline.fireChannelRegistered();
</span></span><span style=display:flex><span>        xxx
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>doRegister方法<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.channel.nio.AbstractNioChannel#doRegister
</span></span><span style=display:flex><span>@Override
</span></span><span style=display:flex><span>protected void doRegister() throws Exception {
</span></span><span style=display:flex><span>    boolean selected = false;
</span></span><span style=display:flex><span>    for (;;) {
</span></span><span style=display:flex><span>        try {
</span></span><span style=display:flex><span>            selectionKey = javaChannel().register(eventLoop().selector, 0, this);
</span></span><span style=display:flex><span>            return;
</span></span><span style=display:flex><span>        } catch (CancelledKeyException e) {
</span></span><span style=display:flex><span>            if (!selected) {
</span></span><span style=display:flex><span>                // Force the Selector to select now as the &#34;canceled&#34; SelectionKey may still be
</span></span><span style=display:flex><span>                // cached and not removed because no Select.select(..) operation was called yet.
</span></span><span style=display:flex><span>                eventLoop().selectNow();
</span></span><span style=display:flex><span>                selected = true;
</span></span><span style=display:flex><span>            } else {
</span></span><span style=display:flex><span>                // We forced a select operation on the selector before but the SelectionKey is still cached
</span></span><span style=display:flex><span>                // for whatever reason. JDK bug ?
</span></span><span style=display:flex><span>                throw e;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>经上文 newChannel 分析，知道这里javaChannel方法返回的ch为实例化NioServerSocketChannel时产生的 SocketChannelImpl实例，并设置为非阻塞的。</p><h4 id=总结>总结</h4><p>1、initAndRegister 初始化 NioServerSocketChannel 通道并注册各个 handler，返回一个 future</p><p>2、通过 ServerBootrap 的通道工厂反射创建一个 NioServerSocketChannel</p><p>3、init初始化 NioServerSocketChannel</p><p>4、group().register(channel) 通过 ServerBootstrap 的 bossGroup 注册 NioServerSocketChannel</p><p>5、最后返回这个异步执行的占位符 regFuture</p><h3 id=dobind0方法>dobind0方法</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.bootstrap.AbstractBootstrap#doBind0
</span></span><span style=display:flex><span>private static void doBind0(
</span></span><span style=display:flex><span>        final ChannelFuture regFuture, final Channel channel,
</span></span><span style=display:flex><span>        final SocketAddress localAddress, final ChannelPromise promise) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    // This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up
</span></span><span style=display:flex><span>    // the pipeline in its channelRegistered() implementation.
</span></span><span style=display:flex><span>    channel.eventLoop().execute(new OneTimeTask() {
</span></span><span style=display:flex><span>        @Override
</span></span><span style=display:flex><span>        public void run() {
</span></span><span style=display:flex><span>            if (regFuture.isSuccess()) {
</span></span><span style=display:flex><span>                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);
</span></span><span style=display:flex><span>            } else {
</span></span><span style=display:flex><span>                promise.setFailure(regFuture.cause());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>这里主要是提交了一个任务到 NioEventLoop 线程中。
提交的任务执行后，然后执行 channel.bind 方法并添加事件，完成 channel 与端口的绑定</p><h4 id=executor方法>executor方法</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.util.concurrent.SingleThreadEventExecutor#execute
</span></span><span style=display:flex><span>@Override
</span></span><span style=display:flex><span>public void execute(Runnable task) {
</span></span><span style=display:flex><span>    if (task == null) {
</span></span><span style=display:flex><span>        throw new NullPointerException(&#34;task&#34;);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    boolean inEventLoop = inEventLoop();
</span></span><span style=display:flex><span>    if (inEventLoop) {
</span></span><span style=display:flex><span>        addTask(task);
</span></span><span style=display:flex><span>    } else {
</span></span><span style=display:flex><span>        startThread();
</span></span><span style=display:flex><span>        addTask(task);
</span></span><span style=display:flex><span>        if (isShutdown() &amp;&amp; removeTask(task)) {
</span></span><span style=display:flex><span>            reject();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    if (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) {
</span></span><span style=display:flex><span>        wakeup(inEventLoop);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>inEventLoop 方法判断当前线程是否为该 NioEventLoop 关联的线程，如果是添加任务到任务队列中，不是则先启动线程，然后添加任务到任务队列中去</p><h4 id=channel-bind>channel.bind</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.AbstractChannelHandlerContext#bind
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>bind</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>localAddress</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;localAddress&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>validatePromise</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// cancelled
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>return</span> <span style=color:#000>promise</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>AbstractChannelHandlerContext</span> <span style=color:#000>next</span> <span style=color:#000>=</span> <span style=color:#000>findContextOutbound</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>EventExecutor</span> <span style=color:#000>executor</span> <span style=color:#000>=</span> <span style=color:#000>next</span><span style=color:#000>.</span><span style=color:#836c28>executor</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>executor</span><span style=color:#000>.</span><span style=color:#836c28>inEventLoop</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>next</span><span style=color:#000>.</span><span style=color:#836c28>invokeBind</span><span style=color:#000>(</span><span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>safeExecute</span><span style=color:#000>(</span><span style=color:#000>executor</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>OneTimeTask</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>next</span><span style=color:#000>.</span><span style=color:#836c28>invokeBind</span><span style=color:#000>(</span><span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>},</span> <span style=color:#000>promise</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>promise</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>findContextOutbound 就是在pipeline所持有的以 AbstractChannelHandlerContext 为节点的双向链表中从尾节点tail开始向前寻找第一个outbound=true的handler节点。
DefaultChannelPipeline 构造器中, 会实例化head和tail两个对象，形成了双向链表的头和尾。 head 是 HeadContext 的实例，实现了 ChannelOutboundHandler 接口和 ChannelInboundHandler 接口，它的 outbound 字段为 true。而tail 是 TailContext 的实例，实现了ChannelInboundHandler 接口，它的 outbound 字段为 false，inbound 字段为true。 因此 findContextOutbound方法 找到的 AbstractChannelHandlerContext 对象其实就是 head。</p><p>然后调用 next.invokeBind 方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// io.netty.channel.AbstractChannelHandlerContext#invokeBind
</span></span><span style=display:flex><span>private void invokeBind(SocketAddress localAddress, ChannelPromise promise) {
</span></span><span style=display:flex><span>    if (isAdded()) {
</span></span><span style=display:flex><span>        try {
</span></span><span style=display:flex><span>            ((ChannelOutboundHandler) handler()).bind(this, localAddress, promise);
</span></span><span style=display:flex><span>        } catch (Throwable t) {
</span></span><span style=display:flex><span>            notifyOutboundHandlerException(t, promise);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } else {
</span></span><span style=display:flex><span>        bind(localAddress, promise);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>继续看 bind 方法，这里是 HeadContext 的</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.DefaultChannelPipeline.HeadContext#bind
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>bind</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#000>,</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>unsafe</span><span style=color:#000>.</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这里的 unsafe 是在 HeadContext 构造函数中赋值的<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.DefaultChannelPipeline.HeadContext#HeadContext
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>HeadContext</span><span style=color:#000>(</span><span style=color:#000>DefaultChannelPipeline</span> <span style=color:#000>pipeline</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#000>pipeline</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#000>HEAD_NAME</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>unsafe</span> <span style=color:#000>=</span> <span style=color:#000>pipeline</span><span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>().</span><span style=color:#836c28>unsafe</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>setAdded</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>上文分析了，unsafe 实际上就是 NioMessageUnsafe。
分析 NioMessageUnsafe 的 bind 方法，实际上是 AbstractUnsafe 的方法</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// io.netty.channel.AbstractChannel.AbstractUnsafe#bind
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>void</span> <span style=color:#000>bind</span><span style=color:#000>(</span><span style=color:#a90d91>final</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#a90d91>final</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>boolean</span> <span style=color:#000>wasActive</span> <span style=color:#000>=</span> <span style=color:#000>isActive</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>doBind</span><span style=color:#000>(</span><span style=color:#000>localAddress</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>safeSetFailure</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>,</span> <span style=color:#000>t</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>closeIfClosed</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>wasActive</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>isActive</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>invokeLater</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>OneTimeTask</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>pipeline</span><span style=color:#000>.</span><span style=color:#836c28>fireChannelActive</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>});</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>safeSetSuccess</span><span style=color:#000>(</span><span style=color:#000>promise</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>核心代码为 doBind 方法，该方法是 NioServerSocketChannel 中的<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>doBind</span><span style=color:#000>(</span><span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>javaChannel</span><span style=color:#000>().</span><span style=color:#836c28>socket</span><span style=color:#000>().</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#000>localAddress</span><span style=color:#000>,</span> <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getBacklog</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>javaChannel()方法返回的是NioServerSocketChannel实例初始化时所产生的Java NIO ServerSocketChannel实例（具体为ServerSocketChannelImple实例）。 等价于语句serverSocketChannel.socket().bind(localAddress)完成了指定端口的绑定，然后开始监听此端口。
绑定端口成功后，这里调用了我们自己定义的handler channelActive方法，绑定之前，isActive()方法返回false，绑定之后返回true。</p><h1 id=main线程阻塞等待关闭>main线程阻塞等待关闭</h1><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// Wait until the server socket is closed.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>f</span><span style=color:#000>.</span><span style=color:#836c28>channel</span><span style=color:#000>().</span><span style=color:#836c28>closeFuture</span><span style=color:#000>().</span><span style=color:#836c28>sync</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=优雅关闭所有资源>优雅关闭所有资源</h1><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>}</span> <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// Shut down all event loops to terminate all threads.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>bossGroup</span><span style=color:#000>.</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>workerGroup</span><span style=color:#000>.</span><span style=color:#836c28>shutdownGracefully</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-458f28d41ef5c5b97b3da14b3d50a0e9>3 - IO模型</h1><h1 id=基本概念>基本概念</h1><h2 id=同步异步阻塞非阻塞>同步异步阻塞非阻塞</h2><p>同步：当前线程接收返回结果</p><p>异步：另外一个线程接收返回结果，多个线程</p><p>阻塞：一直等待直到结果返回</p><p>非阻塞：干其它事，不用一直等</p><blockquote><p>注意：没有 异步阻塞 这种</p></blockquote><h2 id=io模型同步异步>IO模型同步异步</h2><p>通常会说到同步阻塞IO、同步非阻塞IO，异步IO几种术语，所谓阻塞就是发起读取数据请求的时，当数据还没准备就绪的时候，这时请求是即刻返回，还是在这里等待数据的就绪，如果需要等待的话就是阻塞，反之如果即刻返回就是非阻塞。</p><p>区分了阻塞和非阻塞后再来分别下同步和异步，在IO模型里面如果请求方从发起请求到数据最后完成的这一段过程中都需要自己参与，那么这种称为同步请求；反之，如果应用发送完指令后就不再参与过程了，只需要等待最终完成结果的通知，那么这就属于异步。</p><p>再看同步阻塞、同步非阻塞，他们不同的只是发起读取请求的时候一个请求阻塞，一个请求不阻塞，但是相同的是，他们都需要应用自己监控整个数据完成的过程。而为什么只有异步非阻塞 而没有异步阻塞呢，因为异步模型下请求指定发送完后就即刻返回了，没有任何后续流程了，所以它注定不会阻塞，所以也就只会有异步非阻塞模型了。</p><h1 id=5种io模型>5种IO模型</h1><p><img src=../imgs/io_model_basic_1.png alt=io_model_basic_1.png></p><h2 id=阻塞io>阻塞IO</h2><h2 id=非阻塞io>非阻塞IO</h2><h2 id=多路复用io>多路复用IO</h2><p>Java NIO就是多路复用IO</p><p>另外多路复用IO为何比非阻塞IO模型的效率高是因为在非阻塞IO中，不断地询问socket状态时通过用户线程去进行的，而在多路复用IO中，轮询每个socket状态是内核在进行的，这个效率要比用户线程要高的多。</p><p>单线程可以配合Selector完成对多个Channel可读写事件的监控，这称之为多路复用</p><blockquote><p>单线程+事件</p></blockquote><ul><li>多路复用仅针对网络IO、普通文件IO没法利用多路复用</li><li>如果不用Selector的非阻塞模式，线程大部分事件都在做无用功，而Selector能够保证<ul><li>有可连接事件时才去连接</li><li>有可读事件才去读取</li><li>有可写事件才去写入<ul><li>限于网络传输能力，Channel未必时时可写，一旦Channel可写，会触发Selector的可写事件</li></ul></li></ul></li></ul><h2 id=信号驱动io>信号驱动IO</h2><h2 id=异步io>异步IO</h2><h1 id=2种高性能设计模式>2种高性能设计模式</h1><ul><li>Reactor</li><li>Proactor</li></ul><h1 id=io复用模型>IO复用模型</h1><h2 id=select>Select</h2><p>函数签名：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>int</span> <span style=color:#000>select</span><span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>nfds</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>fd_set</span> <span style=color:#000>*</span><span style=color:#000>restrict</span> <span style=color:#000>readfds</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>fd_set</span> <span style=color:#000>*</span><span style=color:#000>restrict</span> <span style=color:#000>writefds</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>fd_set</span> <span style=color:#000>*</span><span style=color:#000>restrict</span> <span style=color:#000>errorfds</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>struct</span> <span style=color:#000>timeval</span> <span style=color:#000>*</span><span style=color:#000>restrict</span> <span style=color:#000>timeout</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>传递给select函数的参数会告诉内核：</p><ol><li>我们所关心的文件描述符（三类，读、写、异常）</li><li>对每个描述符，我们所关心的状态</li><li>我们要等待多长时间
fd_set是bitmap结构，默认长度为1024，由内核中一个常量定义，因此select最多处理的fd长度就是1024，要修改该长度，需要重新编译内核。 fd_set 的使用涉及以下几个 API：</li></ol><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span> #include &lt;sys/select.h&gt;
</span></span><span style=display:flex><span>int FD_ZERO(int fd, fd_set *fdset);  // 将 fd_set 所有位置 0
</span></span><span style=display:flex><span>int FD_CLR(int fd, fd_set *fdset);   // 将 fd_set 某一位置 0
</span></span><span style=display:flex><span>int FD_SET(int fd, fd_set *fd_set);  // 将 fd_set 某一位置 1
</span></span><span style=display:flex><span>int FD_ISSET(int fd, fd_set *fdset); // 检测 fd_set 某一位是否为 1
</span></span></code></pre></td></tr></table></div></div></div><p>从select函数返回后，内核告诉我们以下信息：</p><ol><li>对我们的要求已经做好准备的描述符的个数</li><li>对于三种条件（读、写、异常），哪些描述符已经做好准备
有了这些信息，我们可以调用合适的I/O函数，并且这些函数不会再阻塞。</li></ol><p><img src=../imgs/io_model_basic_2.png alt=io_model_basic_2.png></p><p>select的缺点</p><ul><li>fd_set中的bitmap是固定1024位的，也就是说最多只能监听1024个套接字。当然也可以改内核源码，不过代价比较大；</li><li>fd_set每次传入内核之后，都会被改写，导致不可重用，每次调用select都需要重新初始化fd_set；</li><li>每次调用select都需要拷贝新的fd_set到内核空间，这里会做一个用户态到内核态的切换；</li><li>拿到fd_set的结果后，应用进程需要遍历整个fd_set，才知道哪些文件描述符有数据可以处理。</li></ul><h2 id=poll>Poll</h2><p>poll 和 select 几乎没有区别。poll 采用链表的方式存储文件描述符，没有最大存储数量的限制。 从性能开销上看，poll 和 select 的差别不大。</p><h2 id=epoll>epoll</h2><p>epoll 是对 select 和 poll 的改进，避免了“性能开销大”和“文件描述符数量少”两个缺点。即：</p><ul><li><p>每次 select 需要把监控的 fds 传输到内核里，没有在内核中维护</p></li><li><p>socket 只唤醒 select，不能告诉它是哪个 socket 
改进策略：</p></li><li><p>在内核里维护了 epoll 管理的 socket 集合，不用每次调用时都把所有管理的 fds 拷贝到内核</p></li><li><p>引入一个 ready_list 双向链表，callback 里面会把当前的 socket 加入到 ready_list 然后唤醒 epoll，被唤醒的 epoll 只需要遍历 ready_list 即可，这个链表里一定是有数据可读的 socket，相比于 select 就不会做无用的遍历
简而言之，epoll 有以下几个特点：</p></li><li><p>使用红黑树存储文件描述符集合</p></li><li><p>使用队列存储就绪的文件描述符</p></li><li><p>每个文件描述符只需在添加时传入一次；通过事件更改文件描述符状态</p></li></ul><p>select、poll 模型都只使用一个函数，而 epoll 模型使用三个函数：epoll_create、epoll_ctl 和 epoll_wait，我们分开介绍。</p><h3 id=epoll-create>epoll_create</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>int epoll_create(int size);
</span></span></code></pre></td></tr></table></div></div></div><p>epoll_create 会创建一个 epoll 实例，同时返回一个引用该实例的文件描述符。 返回的文件描述符仅仅指向对应的 epoll 实例，并不表示真实的磁盘文件节点。其他 API 如 epoll_ctl、epoll_wait 会使用这个文件描述符来操作相应的 epoll 实例。 当创建好 epoll 句柄后，它会占用一个 fd 值，在 linux 下查看 /proc/进程id/fd/，就能够看到这个 fd。所以在使用完 epoll 后，必须调用 close(epfd) 关闭对应的文件描述符，否则可能导致 fd 被耗尽。当指向同一个 epoll 实例的所有文件描述符都被关闭后，操作系统会销毁这个 epoll 实例。 epoll 实例内部存储：</p><ul><li><strong>监听列表：所有要监听的文件描述符，使用****红黑树</strong></li><li><strong>就绪列表：所有就绪的文件描述符，使用****链表</strong></li></ul><h3 id=epoll-ctl>epoll_ctl</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
</span></span></code></pre></td></tr></table></div></div></div><p>epoll_ctl 会监听文件描述符 fd 上发生的 event 事件。 参数说明：</p><ul><li>epfd 即 epoll_create 返回的文件描述符，指向一个 epoll 实例</li><li>fd 表示要监听的目标文件描述符</li><li>event 表示要监听的事件（可读、可写、发送错误…）</li><li>op 表示要对 fd 执行的操作，有以下几种：<ul><li>EPOLL_CTL_ADD：为 fd 添加一个监听事件 event</li><li>EPOLL_CTL_MOD：Change the event event associated with the target file descriptor fd（event 是一个结构体变量，这相当于变量 event 本身没变，但是更改了其内部字段的值）</li><li>EPOLL_CTL_DEL：删除 fd 的所有监听事件，这种情况下 event 参数没用</li></ul></li></ul><p>返回值 0 或 -1，表示上述操作成功与否。 epoll_ctl 会将文件描述符 fd 添加到 epoll 实例的监听列表里，同时为 fd 设置一个回调函数，并监听事件 event。当 fd 上发生相应事件时，会调用回调函数，将 fd 添加到 epoll 实例的就绪队列上。</p><h3 id=epoll-wait>epoll_wait</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>int epoll_wait(int epfd, struct epoll_event *events,
</span></span><span style=display:flex><span>               int maxevents, int timeout);
</span></span></code></pre></td></tr></table></div></div></div><p>这是 epoll 模型的主要函数，功能相当于 select。 参数说明：</p><ul><li>epfd 即 epoll_create 返回的文件描述符，指向一个 epoll 实例</li><li>events 是一个数组，保存就绪状态的文件描述符，其空间由调用者负责申请</li><li>maxevents 指定 events 的大小</li><li>timeout 类似于 select 中的 timeout。如果没有文件描述符就绪，即就绪队列为空，则 epoll_wait 会阻塞 timeout 毫秒。如果 timeout 设为 -1，则 epoll_wait 会一直阻塞，直到有文件描述符就绪；如果 timeout 设为 0，则 epoll_wait 会立即返回</li></ul><p>返回值表示 events 中存储的就绪描述符个数，最大不超过 maxevents。</p><h3 id=epoll-的优点>epoll 的优点</h3><p>一开始说，epoll 是对 select 和 poll 的改进，避免了“性能开销大”和“文件描述符数量少”两个缺点。 对于“文件描述符数量少”，select 使用整型数组存储文件描述符集合，而 epoll 使用红黑树存储，数量较大。 对于“性能开销大”，epoll_ctl 中为每个文件描述符指定了回调函数，并在就绪时将其加入到就绪列表，因此 epoll 不需要像 select 那样遍历检测每个文件描述符，只需要判断就绪列表是否为空即可。这样，在没有描述符就绪时，epoll 能更早地让出系统资源。</p><blockquote><p>相当于时间复杂度从 O(n) 降为 O(1)</p></blockquote><p>此外，每次调用 select 时都需要向内核拷贝所有要监听的描述符集合，而 epoll 对于每个描述符，只需要在 epoll_ctl 传递一次，之后 epoll_wait 不需要再次传递。这也大大提高了效率。</p><h3 id=水平触发和边缘触发>水平触发和边缘触发</h3><p>水平触发（LT，Level Trigger）：当文件描述符就绪时，会触发通知，如果用户程序没有一次性把数据读/写完，下次还会发出可读/可写信号进行通知。</p><p>边缘触发（ET，Edge Trigger）：仅当描述符从未就绪变为就绪时，通知一次，之后不会再通知。</p><p>select 只支持水平触发，epoll 支持水平触发和边缘触发。</p><p>区别：边缘触发效率更高，减少了事件被重复触发的次数，函数不会返回大量用户程序可能不需要的文件描述符。</p><blockquote><p>水平触发、边缘触发的名称来源：数字电路当中的电位水平，高低电平切换瞬间的触发动作叫边缘触发，而处于高电平的触发动作叫做水平触发。</p></blockquote><p>举例：</p><p>如果一个客户端同时发来了 5 个数据包，正常的逻辑只需要唤醒一次 epoll ，把当前 socket 加一次到 ready_list 就行了，不需要加 5 次。然后用户程序可以把 socket 接收队列的所有数据包都读完。</p><p>但假设用户程序只读了一个包，然后处理报错了，后面不读了，那后面的 4 个包怎么处理？</p><p>如果是 ET 模式，就无法读取，因为没有把 socket 加入到 ready_list 的触发条件。除非该客户端发了新数据包过来，才会再把当前 socket 加入到 ready_list，在新包过来之前，这 4 个数据包都不会被读到。</p><p>而 LT 模式不一样，因为每次读完有感兴趣的事件发生之后，会把当前 socket 再加入到 ready_list，所以下次肯定能读到这个 socket，所以后面的 4 个数据包会被访问到，不论客户端是否发送新包。</p><h1 id=reference>Reference</h1><p><a href=https://tech.meituan.com/2016/11/04/nio.html>美团技术团队-NIO</a></p><p><a href=https://www.cnblogs.com/dolphin0520/p/3916526.html>Java NIO：浅析I/O模型</a></p><p><a href=https://tech.bytedance.net/articles/6941691923572719630#heading18>字节 I/O 模型介绍</a></p><p><a href=https://www.itzhai.com/articles/thoroughly-understand-io-reuse-take-you-in-depth-understanding-of-select-poll-epoll.html>IO复用：IO处理杀手锏，带您深入了解select，poll，epoll</a></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>