<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/><link rel=alternate type=application/rss+xml href=/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>分布式 | Herbdocs</title><meta name=description content="Introduction
分布式
"><meta property="og:title" content="分布式"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="分布式"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="分布式"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/41.%E5%88%86%E5%B8%83%E5%BC%8F/>返回本页常规视图</a>.</p></div><h1 class=title>分布式</h1><ul><li>1: <a href=#pg-fb0b21d8269bf0dfbee3ff1c52aec1e2>Zookeeper基本使用</a></li><li>2: <a href=#pg-8afb1d57ba3110c0d17706be9d39e916>zookeeper启动源码分析</a></li><li>3: <a href=#pg-c1a323d1e65891778ae8e6421dfccb25>分布式一致性算法</a></li><li>4: <a href=#pg-97c9858c4816a8645713da8d5e786794>Quorum机制</a></li><li>5: <a href=#pg-354a2e6929181b174505bfd39fc0cf3a>Raft-01.基础理论</a></li><li>6: <a href=#pg-c47657362d3648a3025539f23e067ed6>Raft-02.raftexample源码分析</a></li><li>7: <a href=#pg-3e6b3129369c76f5da7c1d42173a1586>分布式锁实现及方案比较</a></li><li>8: <a href=#pg-345f73fab4bf2c5b06a1ab1a28636e27>常见分布式拓扑结构</a></li></ul><div class=content><h1 id=introduction>Introduction</h1><p>分布式</p></div></div><div class=td-content><h1 id=pg-fb0b21d8269bf0dfbee3ff1c52aec1e2>1 - Zookeeper基本使用</h1><h1 id=安装>安装</h1><h2 id=单机坏境安装>单机坏境安装</h2><p>1、安装jdk</p><p>2、上传压缩包到linux系统</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>put /xxxx/zookeeper-xxx.tar.gz
</span></span><span style=display:flex><span>rz
</span></span></code></pre></td></tr></table></div></div></div><p>3、解压缩<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>tar -zxvf zookeeper-xxx.tar.gz
</span></span></code></pre></td></tr></table></div></div></div></p><p>4、进去zookeeper-xx目录，创建data文件夹<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>mddir data
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> conf
</span></span><span style=display:flex><span>mv zoo_sample.cfg zoo.cfg
</span></span></code></pre></td></tr></table></div></div></div></p><p>5、修改zoo.cfg中的data属性<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>dataDir</span><span style=color:#000>=</span>/root/zookeeper-xx/data
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=集群环境安装>集群环境安装</h2><p>通常搭建伪集群，用端口进行区分</p><p><strong>准备工作</strong></p><p>1、安装JDK</p><p>2、上传压缩包</p><p>3、将zookeeper解压到/usr/local/zkcluster，复制3份文件，并分别创建data目录，将conf下zoo_sample.cfg复制三份文件并改名为zoo1.cfg、zoo2.cfg、zoo3.cfg</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>tar -zxvf zookeeper-xxx.tar.gz -C /root/zkclouster/
</span></span></code></pre></td></tr></table></div></div></div><p>4、在解压后的zookeeper目录下创建data目录，并分别创建三个子目录data1、data2、data3
5、修改zoo.cfg中的data属性和端口信息</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>dataDir</span><span style=color:#000>=</span>/root/zookeeper-01/data
</span></span><span style=display:flex><span><span style=color:#000>clientPort</span><span style=color:#000>=</span><span style=color:#1c01ce>2181</span>
</span></span></code></pre></td></tr></table></div></div></div><p><strong>配置集群</strong>
(1) 在每个zookeeper的data目录下创建一个myid文件, 内容分别是1、2、3。这个文件就是记录</p><p>每个服务器的ID</p><p>(2) 在每一个zookeeper的zoo. cfg配置客户端访问端口〔(clientPort) 和集群服务器IP列表。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>Server.1= 192.168.25.129:2881:3881
</span></span><span style=display:flex><span>Server.2= 192.168.25.129:2882:3882
</span></span><span style=display:flex><span>Server.3= 192.168.25.129:2883:3883
</span></span><span style=display:flex><span>Server.服务器ID=服务器IP地址:服务器之间通信端口:服务器之间投票选举端口
</span></span></code></pre></td></tr></table></div></div></div><p><strong>启动集群</strong>
依次启动三个zk实例，其中有一个leader和两个follower</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> bin/
</span></span><span style=display:flex><span>./zkServer.sh start
</span></span><span style=display:flex><span><span style=color:#177500># 查看状态</span>
</span></span><span style=display:flex><span>./zkServer.sh status
</span></span><span style=display:flex><span><span style=color:#177500># 关闭</span>
</span></span><span style=display:flex><span>./zkServer.sh stop
</span></span></code></pre></td></tr></table></div></div></div><h1 id=zookeeper基本使用>zookeeper基本使用</h1><p>数据结构</p><p>Zookeeper数据模型的结构与Unix文件系统很类似，整体上可以看做是一棵树，每个节点称作一个ZNode，每个ZNode都可以通过其路径唯一标识</p><p><img src=../imgs/zookeeper_tutorial_211219_1.png alt=zookeeper_tutorial_211219_1.png></p><h2 id=znode节点类型>ZNode节点类型</h2><h3 id=持久节点>持久节点</h3><p>持久化目录节点（PRESISTENT）</p><p>客户端与zookeeper断开连接后，该节点依旧存在</p><h3 id=持久顺序节点>持久顺序节点</h3><p>持久化顺序编号目录节点（PRESISTENT_SEQUENTIAL）</p><p>客户端与zookeeper断开连接后，该节点依旧存在，Zookeeper会给该节点按照顺序编号</p><h3 id=临时节点>临时节点</h3><p>临时目录节点（EPHENERAL）</p><p>客户端与zookeeper断开连接后，该节点被删除</p><h3 id=临时顺序节点>临时顺序节点</h3><p>临时顺序编号目录节点（EPHENERAL_SEQUENTIAL）</p><p>客户端与zookeeper断开连接后，该节点被删除，Zookeeper会给该节点按照顺序编号</p><p>实战经验：</p><p>当被用作注册中心时，对于服务节点是永久节点，服务下的机器是临时节点</p><p><img src=../imgs/zookeeper_tutorial_211219_2.png alt=zookeeper_tutorial_211219_2.png></p><h2 id=命令行使用>命令行使用</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>./zkCli.sh  <span style=color:#177500># 进入zk命令行</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>help</span>
</span></span><span style=display:flex><span><span style=color:#177500># {path}为路径</span>
</span></span><span style=display:flex><span>ls <span style=color:#000>{</span>path<span style=color:#000>}</span> <span style=color:#000>[</span>watch<span style=color:#000>]</span>  <span style=color:#177500># 查看当前znode中所包含的内容，监听该节点下面节点的变化</span>
</span></span><span style=display:flex><span>ls2 <span style=color:#000>{</span>path<span style=color:#000>}</span> <span style=color:#000>[</span>watch<span style=color:#000>]</span>   <span style=color:#177500># 查看当前节点数据并能看到更新次数等数据</span>
</span></span><span style=display:flex><span>create <span style=color:#000>{</span>path<span style=color:#000>}</span> <span style=color:#000>{</span>value<span style=color:#000>}</span>  <span style=color:#177500># 创建节点-s含有序列-e临时</span>
</span></span><span style=display:flex><span>get <span style=color:#000>{</span>path<span style=color:#000>}</span> <span style=color:#000>[</span>watch<span style=color:#000>]</span>   <span style=color:#177500># 获得节点的值，监听该节点的变化</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>set</span>                  <span style=color:#177500># 设置节点的值</span>
</span></span><span style=display:flex><span>stat <span style=color:#000>{</span>path<span style=color:#000>}</span>          <span style=color:#177500># 查看节点状态</span>
</span></span><span style=display:flex><span>delte <span style=color:#000>{</span>path<span style=color:#000>}</span>         <span style=color:#177500># 删除节点</span>
</span></span><span style=display:flex><span>rmr <span style=color:#000>{</span>path<span style=color:#000>}</span>           <span style=color:#177500># 递归删除节点</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=api使用>API使用</h2><p>导入依赖包</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>org.apache.zookeeper<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>zookeeper<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>3.4.7<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.huangbo</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.apache.zookeeper.*</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.apache.zookeeper.data.Stat</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.testng.annotations.Test</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.List</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ZkApiDemo</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>test</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 1、创建连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>ZooKeeper</span> <span style=color:#000>zooKeeper</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ZooKeeper</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;192.xxx.xxx.xxx.5181&#34;</span><span style=color:#000>,</span> <span style=color:#000>2000</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>Watcher</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>process</span><span style=color:#000>(</span><span style=color:#000>WatchedEvent</span> <span style=color:#000>watchedEvent</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;触发&#34;</span> <span style=color:#000>+</span> <span style=color:#000>watchedEvent</span><span style=color:#000>.</span><span style=color:#836c28>getType</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;事件&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>});</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 2、创建父节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>String</span> <span style=color:#000>path</span> <span style=color:#000>=</span> <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/ripple&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;rippleValue&#34;</span><span style=color:#000>.</span><span style=color:#836c28>getBytes</span><span style=color:#000>(),</span> <span style=color:#000>ZooDefs</span><span style=color:#000>.</span><span style=color:#836c28>Ids</span><span style=color:#000>.</span><span style=color:#836c28>OPEN_ACL_UNSAFE</span><span style=color:#000>,</span> <span style=color:#000>CreateMode</span><span style=color:#000>.</span><span style=color:#836c28>EPHEMERAL</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>path</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 3、创建子节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>String</span> <span style=color:#000>chaildrenPath</span> <span style=color:#000>=</span> <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/ripple/children&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;rippleValue&#34;</span><span style=color:#000>.</span><span style=color:#836c28>getBytes</span><span style=color:#000>(),</span> <span style=color:#000>ZooDefs</span><span style=color:#000>.</span><span style=color:#836c28>Ids</span><span style=color:#000>.</span><span style=color:#836c28>OPEN_ACL_UNSAFE</span><span style=color:#000>,</span> <span style=color:#000>CreateMode</span><span style=color:#000>.</span><span style=color:#836c28>EPHEMERAL</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>chaildrenPath</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 4、获取节点中的值(父节点和子节点)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>data</span> <span style=color:#000>=</span> <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>getData</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/ripple&#34;</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>String</span><span style=color:#000>(</span><span style=color:#000>data</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>children</span> <span style=color:#000>=</span> <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>getChildren</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;/ripple&#34;</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>child</span> <span style=color:#000>:</span> <span style=color:#000>children</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>child</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 5、修改节点的值
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>setData</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;ripple&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;rippleUpdate&#34;</span><span style=color:#000>.</span><span style=color:#836c28>getBytes</span><span style=color:#000>(),</span> <span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 6、判断节点是否存在
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>Stat</span> <span style=color:#000>exists</span> <span style=color:#000>=</span> <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>exists</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;ripple&#34;</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>exists</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 7、删除节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>delete</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;ripple/children&#34;</span><span style=color:#000>,</span> <span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=zookeeper应用场景>zookeeper应用场景</h1><h2 id=配置中心>配置中心</h2><p>在平常的业务开发过程中, 我们通常需要将系统的一些通用的全局配置, 例如机器列表配置, 运行时开关配置, 数据库配置信息等统一集中存储, 让集群所有机器共享配置信息, 系统在启动会首先从配置中心读取配置信息, 进行初始化。传统的实现方式将配置存储在本地文件和内存中, 一旦机器规模更大, 配置变更频繁情况下, 本地文件和内存方式的配置维护成本较高, 使用zookeeper作为分布式的配置中心就可以解决这个问题。</p><p>我们将配置信息存在zk中的一个节点中, 同时给该节点注册一个数据节点变更的watcher监听, 一旦节点数据发生变更, 所有的订阅该节点的客户端都可以获取数据变更通知。</p><h2 id=负载均衡>负载均衡</h2><p>Nginx，如果服务器列表产生更新，如何让反向代理服务器知道服务器列表的变更，从而更新负载均衡算法。</p><p>建立server节点, 并建立监听器监视servers子节点的状态(用于在服务器增添时及时同步当前集群中服务器列表) 。在每个服务器启动时, 在Servers节点下建立具体服务器地址的子节点, 并在对应的字节点下存入服务器的相关信息。这样, 我们在zookeeper服务器上可以获取当前集群中的服务器列表及相关信息, 可以自定义一个负载均衡算法, 在每个请求过来时从zookeeper服务器中获取当前集群服务器列表, 根据算法选出其中一个服务器来处理请求。</p><h2 id=命名服务>命名服务</h2><p>命名服务是分布式系统中的基本功能之一。裤命名的实体通常可以是集群中的机器、提供的服务地址或者远程对象, 这些都可以称作为名字。常见的就是一些分布式服务框架(RPC、RMI) 中的服务地址列表, 通过使用名称服务客户端可以获取资源的实体、服务地址和提供者信息。命名服务就是通过一个资源引用的方式来实现对资源的定位和使用。在分布式环境中, 上层应用仅仅需要一个全局唯一名称, 就像数据库中的主键。</p><p>在单库单表系统中可以通过自增ID来标识每一条记录, 但是随着规模变大分库分表很常见, 那么自增ID有仅能针对单一表生成ID, 所以在这种情况下无法依靠这个来标识唯一D。UUID就是一种全局唯一标识符。但是长度过长不易识别。</p><h2 id=dns服务>DNS服务</h2><h3 id=1-域名配置>1、域名配置</h3><p>在分布式系统应用中, 每一个应用都需要分配一个域名, 日常开发中, 往往使用本地HOST绑定域名解析, 开发阶段可以随时修改域名和IP的映射, 大大提高开发的调试效率。如果应用的机器规模达到一定程度后, 需要频繁更新域名节点来进行域名配置, 需要在规模的集群中变更, 无法保证实时性。所有我们在zk上创建一个节点来进行域名配置</p><h3 id=2-域名解析>2、域名解析</h3><p>应用解析时, 首先从zk域名节点中获取域名映射的IP和端口。</p><h3 id=3-域名变更>3、域名变更</h3><p>每个应用都会在在对应的域名节点注册一个数据变更的watcher监听, 一旦监听的域名节点数据变更, zk会向所有订阅的客户端发送域名变更通知。</p><h3 id=4-集群管理>4、集群管理</h3><p>1、集群控制：对集群中节点进行操作与控制</p><p>2、集群监控：对集群节点运行状态的收集</p><p>在日常开发和运维过程中, 我们经常会有类似于如下的需求：</p><p>1）希望知道当前集群中究竟有多少机器在工作。</p><p>2）对集群中每台机器的运行时状态进行数据收集。</p><p>3）对集群中机器进行上下线操作</p><p>在传统的基于Agent的分布式集群管理体系中, 都是通过在集群中的每台机嘴上部罪一个Agent, 由这个Agent负责主动向指定的一个监控中心系统(监控中心系统负责案所有数据进行集中处理, 形成一系列报表, 并负责实时报警, 以下简称“监控中心“) 汇报自己所在机器的状态。在集群规模适中的场景下, 这确实是一种在生产实践中广泛使用的解决方案, 能够快速有效地实现分家集群监控, 但是一旦系统的业务场景增多, 集群规模变大之后, 该解决方案的弊端也就显现出来了。</p><p><img src=../imgs/zookeeper_tutorial_211219_3.png alt=zookeeper_tutorial_211219_3.png></p><p>弊端：大规模升级困难（Agent也需要升级）、编程语言多样性</p><p>随着分布式系统规模日益扩大，集群中机器的数量越来越多。有效的集群管理越来越重要，zookeeper集群管理主要利用了watcher机制和创建临时节点来实现。以机器上下线和机器监控为例：</p><p>1、机器上下线</p><p>新增机器的时候, 将Agent部署到新增的机器上, 当Agent部署启动时, 会向zookeeper指定的节</p><p>点下创建一个临时子节点, 当Agent在zk上创建完这个临时节点后, 当关注的节点</p><p>zookeeperymachines下的子节点新加入新的节点时或删除郭会发送譬知, 这样就对机器的上下线进行监控。</p><p>2、机器监控</p><p>在机器运行过程中, Agent会定时将主机的的运行状态信息写入到/ machines/ host主机节点, 监控中心通过订阅这些节点的数据变化来获取主机的运行信息。</p><h1 id=reference>Reference</h1><p><a href=https://mp.weixin.qq.com/s/iSU3BO-_57v1V5THF4sNdQ>Zookeeper 的五个核心知识点</a></p><p><a href=https://mp.weixin.qq.com/s/1PieoXY8IMucUWV7yMMEhQ>zookeeper连环9问</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8afb1d57ba3110c0d17706be9d39e916>2 - zookeeper启动源码分析</h1><p>zookeeper github地址：<a href=https://github.com/apache/zookeeper>https://github.com/apache/zookeeper</a></p><p>本文拉取分支后以3.5.7版本为例</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>git checkout -b branch-3.5.7 remotes/origin/branch-3.5.7
</span></span></code></pre></td></tr></table></div></div></div><h1 id=基本知识>基本知识</h1><p>1、zk中的数据模型是一棵树 DataTree，每个节点叫做 DataNode</p><p>2、zk集群中的 DataTree 时刻保持状态同步</p><p>3、<strong>Zookeeper 集群中的每个zk节点中，数据在内存和磁盘中都有一份完整的数据。</strong></p><ul><li>内存数据：DataTree</li><li>磁盘数据：快照文件 + 编辑日志</li></ul><h1 id=总体流程>总体流程</h1><p><img src=../imgs/zookeeper_source_211220_1.png alt=zookeeper_source_211220_1.png></p><h2 id=heading></h2><h1 id=启动入口>启动入口</h1><p>根据bin目录下的启动脚本zkServer.sh中加载启动类QuorumPeerMain类</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeerMain
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QuorumPeerMain</span> <span style=color:#000>main</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>QuorumPeerMain</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>main</span><span style=color:#000>.</span><span style=color:#836c28>initializeAndRun</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xxx</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Exiting normally&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ServiceUtils</span><span style=color:#000>.</span><span style=color:#836c28>requestSystemExit</span><span style=color:#000>(</span><span style=color:#000>ExitCode</span><span style=color:#000>.</span><span style=color:#836c28>EXECUTION_FINISHED</span><span style=color:#000>.</span><span style=color:#836c28>getValue</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>然后进入到 initailizeAndRun方法中<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeerMain#initializeAndRun
</span></span></span><span style=display:flex><span><span style=color:#177500>// 1.加载配置文件
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>QuorumPeerConfig</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>QuorumPeerConfig</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>.</span><span style=color:#836c28>length</span> <span style=color:#000>==</span> <span style=color:#000>1</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 解析参数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>parse</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>]);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#177500>// 2.启动定时清除任务，主要清除旧的快照和日志文件，默认关闭
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>DatadirCleanupManager</span> <span style=color:#000>purgeMgr</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>DatadirCleanupManager</span><span style=color:#000>(</span><span style=color:#000>config</span>
</span></span><span style=display:flex><span>        <span style=color:#000>.</span><span style=color:#836c28>getDataDir</span><span style=color:#000>(),</span> <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getDataLogDir</span><span style=color:#000>(),</span> <span style=color:#000>config</span>
</span></span><span style=display:flex><span>        <span style=color:#000>.</span><span style=color:#836c28>getSnapRetainCount</span><span style=color:#000>(),</span> <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getPurgeInterval</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span><span style=color:#000>purgeMgr</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// 3.启动zk zookeeper启动方式分为两种：单机启动和集群启动
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>.</span><span style=color:#836c28>length</span> <span style=color:#000>==</span> <span style=color:#000>1</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>servers</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>()</span> <span style=color:#000>&gt;</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>runFromConfig</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Either no config or no quorum defined in config, running &#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>+</span> <span style=color:#c41a16>&#34; in standalone mode&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// there is only server in the quorum -- run as standalone
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// 单机启动
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>ZooKeeperServerMain</span><span style=color:#000>.</span><span style=color:#836c28>main</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><h1 id=解析参数>解析参数</h1><p>这里path默认是 zoo.cfg，可以查看启动脚本</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeerConfig#parse
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>parse</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>ConfigException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>File</span> <span style=color:#000>configFile</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>VerifyingFileFactory</span><span style=color:#000>.</span><span style=color:#836c28>Builder</span><span style=color:#000>(</span><span style=color:#000>LOG</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>.</span><span style=color:#836c28>warnForRelativePath</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000>.</span><span style=color:#836c28>failForNonExistingPath</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000>.</span><span style=color:#836c28>build</span><span style=color:#000>()).</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>path</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Properties</span> <span style=color:#000>cfg</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Properties</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>(</span><span style=color:#000>FileInputStream</span> <span style=color:#000>in</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FileInputStream</span><span style=color:#000>(</span><span style=color:#000>configFile</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>cfg</span><span style=color:#000>.</span><span style=color:#836c28>load</span><span style=color:#000>(</span><span style=color:#000>in</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>configFileStr</span> <span style=color:#000>=</span> <span style=color:#000>path</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>/* Read entire config file as initial configuration */</span>
</span></span><span style=display:flex><span>        <span style=color:#000>initialConfig</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>String</span><span style=color:#000>(</span><span style=color:#000>Files</span><span style=color:#000>.</span><span style=color:#836c28>readAllBytes</span><span style=color:#000>(</span><span style=color:#000>configFile</span><span style=color:#000>.</span><span style=color:#836c28>toPath</span><span style=color:#000>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#000>parseProperties</span><span style=color:#000>(</span><span style=color:#000>cfg</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>parseProperties函数中可以看到常用的属性值，这里重点介绍其调用的setupQuorumPeerConfig方法</p><h2 id=setupquorumpeerconfig>setupQuorumPeerConfig</h2><p>这里setupMyId方法初始化了服务的serverId</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeerConfig#setupQuorumPeerConfig
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>void</span> <span style=color:#000>setupQuorumPeerConfig</span><span style=color:#000>(</span><span style=color:#000>Properties</span> <span style=color:#000>prop</span><span style=color:#000>,</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>configBackwardCompatibilityMode</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>ConfigException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>quorumVerifier</span> <span style=color:#000>=</span> <span style=color:#000>parseDynamicConfig</span><span style=color:#000>(</span><span style=color:#000>prop</span><span style=color:#000>,</span> <span style=color:#000>electionAlg</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>,</span> <span style=color:#000>configBackwardCompatibilityMode</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 初始化myid，zkData目录有个文件 myid
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>setupMyId</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>setupClientPort</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>setupPeerType</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>checkValidity</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=过期快照删除>过期快照删除</h1><h2 id=任务启动>任务启动</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.DatadirCleanupManager#start
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>start</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>PurgeTaskStatus</span><span style=color:#000>.</span><span style=color:#836c28>STARTED</span> <span style=color:#000>==</span> <span style=color:#000>purgeTaskStatus</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Purge task is already running.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// Don&#39;t schedule the purge task with zero or negative purge interval.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>purgeInterval</span> <span style=color:#000>&lt;=</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Purge task is not scheduled.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>timer</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Timer</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;PurgeTask&#34;</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimerTask</span> <span style=color:#000>task</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>PurgeTask</span><span style=color:#000>(</span><span style=color:#000>dataLogDir</span><span style=color:#000>,</span> <span style=color:#000>snapDir</span><span style=color:#000>,</span> <span style=color:#000>snapRetainCount</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>timer</span><span style=color:#000>.</span><span style=color:#836c28>scheduleAtFixedRate</span><span style=color:#000>(</span><span style=color:#000>task</span><span style=color:#000>,</span> <span style=color:#000>0</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>HOURS</span><span style=color:#000>.</span><span style=color:#836c28>toMillis</span><span style=color:#000>(</span><span style=color:#000>purgeInterval</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>purgeTaskStatus</span> <span style=color:#000>=</span> <span style=color:#000>PurgeTaskStatus</span><span style=color:#000>.</span><span style=color:#836c28>STARTED</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=定时任务>定时任务</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.DatadirCleanupManager.PurgeTask#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Purge task started.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>PurgeTxnLog</span><span style=color:#000>.</span><span style=color:#836c28>purge</span><span style=color:#000>(</span><span style=color:#000>logsDir</span><span style=color:#000>,</span> <span style=color:#000>snapsDir</span><span style=color:#000>,</span> <span style=color:#000>snapRetainCount</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>error</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Error occurred while purging.&#34;</span><span style=color:#000>,</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Purge task completed.&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=小结>小结</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getSnapRetainCount</span><span style=color:#000>()</span> <span style=color:#177500>// 默认3，表示最少保留的快照个数
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getPurgeInterval</span><span style=color:#000>()</span> <span style=color:#177500>// 默认0，表示关闭该任务
</span></span></span></code></pre></td></tr></table></div></div></div><h1 id=通信初始化>通信初始化</h1><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeerMain#runFromConfig
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>runFromConfig</span><span style=color:#000>(</span><span style=color:#000>QuorumPeerConfig</span> <span style=color:#000>config</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>AdminServerException</span>
</span></span><span style=display:flex><span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ManagedUtil</span><span style=color:#000>.</span><span style=color:#836c28>registerLog4jMBeans</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>JMException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Unable to register log4j JMX control&#34;</span><span style=color:#000>,</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Starting quorum peer&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ServerCnxnFactory</span> <span style=color:#000>cnxnFactory</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ServerCnxnFactory</span> <span style=color:#000>secureCnxnFactory</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getClientPortAddress</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>          <span style=color:#177500>// 获取工厂
</span></span></span><span style=display:flex><span><span style=color:#177500></span>          <span style=color:#000>cnxnFactory</span> <span style=color:#000>=</span> <span style=color:#000>ServerCnxnFactory</span><span style=color:#000>.</span><span style=color:#836c28>createFactory</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>          <span style=color:#177500>// 配置工厂，绑定通信端口等
</span></span></span><span style=display:flex><span><span style=color:#177500></span>          <span style=color:#000>cnxnFactory</span><span style=color:#000>.</span><span style=color:#836c28>configure</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getClientPortAddress</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getMaxClientCnxns</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                  <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getSecureClientPortAddress</span><span style=color:#000>()</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>secureCnxnFactory</span> <span style=color:#000>=</span> <span style=color:#000>ServerCnxnFactory</span><span style=color:#000>.</span><span style=color:#836c28>createFactory</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>          <span style=color:#000>secureCnxnFactory</span><span style=color:#000>.</span><span style=color:#836c28>configure</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getSecureClientPortAddress</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>getMaxClientCnxns</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                  <span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>quorumPeer</span> <span style=color:#000>=</span> <span style=color:#000>getQuorumPeer</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>xxx</span>
</span></span><span style=display:flex><span>      <span style=color:#000>quorumPeer</span><span style=color:#000>.</span><span style=color:#836c28>initialize</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 启动zk
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>quorumPeer</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>quorumPeer</span><span style=color:#000>.</span><span style=color:#836c28>join</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=创建工厂>创建工厂</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.ServerCnxnFactory#createFactory()
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>ZOOKEEPER_SERVER_CNXN_FACTORY</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;zookeeper.serverCnxnFactory&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>static</span> <span style=color:#a90d91>public</span> <span style=color:#000>ServerCnxnFactory</span> <span style=color:#000>createFactory</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>String</span> <span style=color:#000>serverCnxnFactoryName</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getProperty</span><span style=color:#000>(</span><span style=color:#000>ZOOKEEPER_SERVER_CNXN_FACTORY</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>serverCnxnFactoryName</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>serverCnxnFactoryName</span> <span style=color:#000>=</span> <span style=color:#000>NIOServerCnxnFactory</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ServerCnxnFactory</span> <span style=color:#000>serverCnxnFactory</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>ServerCnxnFactory</span><span style=color:#000>)</span> <span style=color:#000>Class</span><span style=color:#000>.</span><span style=color:#836c28>forName</span><span style=color:#000>(</span><span style=color:#000>serverCnxnFactoryName</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000>.</span><span style=color:#836c28>getDeclaredConstructor</span><span style=color:#000>().</span><span style=color:#836c28>newInstance</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Using {} as server connection factory&#34;</span><span style=color:#000>,</span> <span style=color:#000>serverCnxnFactoryName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>serverCnxnFactory</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>IOException</span> <span style=color:#000>ioe</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>IOException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Couldn&#39;t instantiate &#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>+</span> <span style=color:#000>serverCnxnFactoryName</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ioe</span><span style=color:#000>.</span><span style=color:#836c28>initCause</span><span style=color:#000>(</span><span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#000>ioe</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>查找zookeeperAdmin.md文件<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:699
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>*</span> <span style=color:#000>*</span><span style=color:#000>serverCnxnFactory</span><span style=color:#000>*</span> <span style=color:#000>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>(</span><span style=color:#000>Java</span> <span style=color:#000>system</span> <span style=color:#000>property</span><span style=color:#000>:</span> <span style=color:#000>**</span><span style=color:#000>zookeeper</span><span style=color:#000>.</span><span style=color:#836c28>serverCnxnFactory</span><span style=color:#000>**)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Specifies</span> <span style=color:#000>ServerCnxnFactory</span> <span style=color:#000>implementation</span><span style=color:#000>.</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>This</span> <span style=color:#000>should</span> <span style=color:#000>be</span> <span style=color:#000>set</span> <span style=color:#000>to</span> <span style=color:#000>`</span><span style=color:#000>NettyServerCnxnFactory</span><span style=color:#000>`</span> <span style=color:#000>in</span> <span style=color:#000>order</span> <span style=color:#000>to</span> <span style=color:#000>use</span> <span style=color:#000>TLS</span> <span style=color:#000>based</span> <span style=color:#000>server</span> <span style=color:#000>communication</span><span style=color:#000>.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Default</span> <span style=color:#000>is</span> <span style=color:#000>`</span><span style=color:#000>NIOServerCnxnFactory</span><span style=color:#000>`</span><span style=color:#000>.</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>定义了 serverCnxnFactory 为 NIOServerCnxnFactory</p><h2 id=工厂配置>工厂配置</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.NIOServerCnxnFactory#configure
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>configure</span><span style=color:#000>(</span><span style=color:#000>InetSocketAddress</span> <span style=color:#000>addr</span><span style=color:#000>,</span> <span style=color:#a90d91>int</span> <span style=color:#000>maxcc</span><span style=color:#000>,</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>secure</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>ss</span> <span style=color:#000>=</span> <span style=color:#000>ServerSocketChannel</span><span style=color:#000>.</span><span style=color:#836c28>open</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ss</span><span style=color:#000>.</span><span style=color:#836c28>socket</span><span style=color:#000>().</span><span style=color:#836c28>setReuseAddress</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;binding to port &#34;</span> <span style=color:#000>+</span> <span style=color:#000>addr</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ss</span><span style=color:#000>.</span><span style=color:#836c28>socket</span><span style=color:#000>().</span><span style=color:#836c28>bind</span><span style=color:#000>(</span><span style=color:#000>addr</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ss</span><span style=color:#000>.</span><span style=color:#836c28>configureBlocking</span><span style=color:#000>(</span><span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>acceptThread</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>AcceptThread</span><span style=color:#000>(</span><span style=color:#000>ss</span><span style=color:#000>,</span> <span style=color:#000>addr</span><span style=color:#000>,</span> <span style=color:#000>selectorThreads</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=启动zk>启动zk</h1><h2 id=总体流程-1>总体流程</h2><p><img src=../imgs/zookeeper_source_211220_2.png alt=zookeeper_source_211220_2.png></p><p>启动 zk 代码在 runFromConfig中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeerMain#runFromConfig
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>runFromConfig</span><span style=color:#000>(</span><span style=color:#000>QuorumPeerConfig</span> <span style=color:#000>config</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>AdminServerException</span>
</span></span><span style=display:flex><span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// 启动zk
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>quorumPeer</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>quorumPeer</span><span style=color:#000>.</span><span style=color:#836c28>join</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=启动函数>启动函数</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#start
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>synchronized</span> <span style=color:#a90d91>void</span> <span style=color:#000>start</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>getView</span><span style=color:#000>().</span><span style=color:#836c28>containsKey</span><span style=color:#000>(</span><span style=color:#000>myid</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>RuntimeException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;My id &#34;</span> <span style=color:#000>+</span> <span style=color:#000>myid</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; not in the peer list&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 加载数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>loadDataBase</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>startServerCnxnFactory</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>adminServer</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>AdminServerException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Problem starting AdminServer&#34;</span><span style=color:#000>,</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 启动Leader选举
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>startLeaderElection</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=加载数据>加载数据</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.persistence.FileTxnSnapLog#restore
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>long</span> <span style=color:#000>restore</span><span style=color:#000>(</span><span style=color:#000>DataTree</span> <span style=color:#000>dt</span><span style=color:#000>,</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>Long</span><span style=color:#000>,</span> <span style=color:#000>Integer</span><span style=color:#000>&gt;</span> <span style=color:#000>sessions</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>PlayBackListener</span> <span style=color:#000>listener</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 反序列化磁盘中的数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>long</span> <span style=color:#000>deserializeResult</span> <span style=color:#000>=</span> <span style=color:#000>snapLog</span><span style=color:#000>.</span><span style=color:#836c28>deserialize</span><span style=color:#000>(</span><span style=color:#000>dt</span><span style=color:#000>,</span> <span style=color:#000>sessions</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>FileTxnLog</span> <span style=color:#000>txnLog</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FileTxnLog</span><span style=color:#000>(</span><span style=color:#000>dataDir</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>RestoreFinalizer</span> <span style=color:#000>finalizer</span> <span style=color:#000>=</span> <span style=color:#000>()</span> <span style=color:#000>-&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 从编辑日志中恢复数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>long</span> <span style=color:#000>highestZxid</span> <span style=color:#000>=</span> <span style=color:#000>fastForwardFromEdits</span><span style=color:#000>(</span><span style=color:#000>dt</span><span style=color:#000>,</span> <span style=color:#000>sessions</span><span style=color:#000>,</span> <span style=color:#000>listener</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>highestZxid</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>};</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=恢复快照>恢复快照</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.persistence.FileSnap#deserialize
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>long</span> <span style=color:#000>deserialize</span><span style=color:#000>(</span><span style=color:#000>DataTree</span> <span style=color:#000>dt</span><span style=color:#000>,</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>Long</span><span style=color:#000>,</span> <span style=color:#000>Integer</span><span style=color:#000>&gt;</span> <span style=color:#000>sessions</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// we run through 100 snapshots (not all of them)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// if we cannot get it running within 100 snapshots
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// we should  give up
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>File</span><span style=color:#000>&gt;</span> <span style=color:#000>snapList</span> <span style=color:#000>=</span> <span style=color:#000>findNValidSnapshots</span><span style=color:#000>(</span><span style=color:#000>100</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>snapList</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>-</span><span style=color:#000>1L</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>File</span> <span style=color:#000>snap</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>boolean</span> <span style=color:#000>foundValid</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 循环编译每一个快照文件
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>i</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>,</span> <span style=color:#000>snapListSize</span> <span style=color:#000>=</span> <span style=color:#000>snapList</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>();</span> <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>snapListSize</span><span style=color:#000>;</span> <span style=color:#000>i</span><span style=color:#000>++)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>snap</span> <span style=color:#000>=</span> <span style=color:#000>snapList</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>i</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Reading snapshot &#34;</span> <span style=color:#000>+</span> <span style=color:#000>snap</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>(</span><span style=color:#000>InputStream</span> <span style=color:#000>snapIS</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>FileInputStream</span><span style=color:#000>(</span><span style=color:#000>snap</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>             <span style=color:#000>CheckedInputStream</span> <span style=color:#000>crcIn</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CheckedInputStream</span><span style=color:#000>(</span><span style=color:#000>snapIS</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>Adler32</span><span style=color:#000>()))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>InputArchive</span> <span style=color:#000>ia</span> <span style=color:#000>=</span> <span style=color:#000>BinaryInputArchive</span><span style=color:#000>.</span><span style=color:#836c28>getArchive</span><span style=color:#000>(</span><span style=color:#000>crcIn</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 反序列化
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>deserialize</span><span style=color:#000>(</span><span style=color:#000>dt</span><span style=color:#000>,</span> <span style=color:#000>sessions</span><span style=color:#000>,</span> <span style=color:#000>ia</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>long</span> <span style=color:#000>checkSum</span> <span style=color:#000>=</span> <span style=color:#000>crcIn</span><span style=color:#000>.</span><span style=color:#836c28>getChecksum</span><span style=color:#000>().</span><span style=color:#836c28>getValue</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>long</span> <span style=color:#000>val</span> <span style=color:#000>=</span> <span style=color:#000>ia</span><span style=color:#000>.</span><span style=color:#836c28>readLong</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;val&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>val</span> <span style=color:#000>!=</span> <span style=color:#000>checkSum</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IOException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;CRC corruption in snapshot :  &#34;</span> <span style=color:#000>+</span> <span style=color:#000>snap</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>foundValid</span> <span style=color:#000>=</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;problem reading snap file &#34;</span> <span style=color:#000>+</span> <span style=color:#000>snap</span><span style=color:#000>,</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>foundValid</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IOException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Not able to find valid snapshots in &#34;</span> <span style=color:#000>+</span> <span style=color:#000>snapDir</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>lastProcessedZxid</span> <span style=color:#000>=</span> <span style=color:#000>Util</span><span style=color:#000>.</span><span style=color:#836c28>getZxidFromName</span><span style=color:#000>(</span><span style=color:#000>snap</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>(),</span> <span style=color:#000>SNAPSHOT_FILE_PREFIX</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>lastProcessedZxid</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>更详细代码不一一贴出，可自行查看</p><h3 id=heading-1></h3><h3 id=恢复日志>恢复日志</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.persistence.FileTxnSnapLog#fastForwardFromEdits
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>long</span> <span style=color:#000>fastForwardFromEdits</span><span style=color:#000>(</span><span style=color:#000>DataTree</span> <span style=color:#000>dt</span><span style=color:#000>,</span> <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>Long</span><span style=color:#000>,</span> <span style=color:#000>Integer</span><span style=color:#000>&gt;</span> <span style=color:#000>sessions</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#000>PlayBackListener</span> <span style=color:#000>listener</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TxnIterator</span> <span style=color:#000>itr</span> <span style=color:#000>=</span> <span style=color:#000>txnLog</span><span style=color:#000>.</span><span style=color:#836c28>read</span><span style=color:#000>(</span><span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>lastProcessedZxid</span><span style=color:#000>+</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>long</span> <span style=color:#000>highestZxid</span> <span style=color:#000>=</span> <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>lastProcessedZxid</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TxnHeader</span> <span style=color:#000>hdr</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>while</span> <span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// iterator points to
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// the first valid txn when initialized
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>hdr</span> <span style=color:#000>=</span> <span style=color:#000>itr</span><span style=color:#000>.</span><span style=color:#836c28>getHeader</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>hdr</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#177500>//empty logs
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#a90d91>return</span> <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>lastProcessedZxid</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getZxid</span><span style=color:#000>()</span> <span style=color:#000>&lt;</span> <span style=color:#000>highestZxid</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>highestZxid</span> <span style=color:#000>!=</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>error</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;{}(highestZxid) &gt; {}(next log) for type {}&#34;</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>highestZxid</span><span style=color:#000>,</span> <span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getZxid</span><span style=color:#000>(),</span> <span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getType</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>highestZxid</span> <span style=color:#000>=</span> <span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getZxid</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#177500>// 处理datatree的事务
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>processTransaction</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>,</span><span style=color:#000>dt</span><span style=color:#000>,</span><span style=color:#000>sessions</span><span style=color:#000>,</span> <span style=color:#000>itr</span><span style=color:#000>.</span><span style=color:#836c28>getTxn</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span> <span style=color:#a90d91>catch</span><span style=color:#000>(</span><span style=color:#000>KeeperException</span><span style=color:#000>.</span><span style=color:#836c28>NoNodeException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>               <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IOException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Failed to process transaction type: &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getType</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; error: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>(),</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>listener</span><span style=color:#000>.</span><span style=color:#836c28>onTxnLoaded</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>,</span> <span style=color:#000>itr</span><span style=color:#000>.</span><span style=color:#836c28>getTxn</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>itr</span><span style=color:#000>.</span><span style=color:#836c28>next</span><span style=color:#000>())</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>itr</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>itr</span><span style=color:#000>.</span><span style=color:#836c28>close</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>highestZxid</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=处理datatree的事务>处理DataTree的事务</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.persistence.FileTxnSnapLog#processTransaction
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>processTransaction</span><span style=color:#000>(</span><span style=color:#000>TxnHeader</span> <span style=color:#000>hdr</span><span style=color:#000>,</span><span style=color:#000>DataTree</span> <span style=color:#000>dt</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#000>&lt;</span><span style=color:#000>Long</span><span style=color:#000>,</span> <span style=color:#000>Integer</span><span style=color:#000>&gt;</span> <span style=color:#000>sessions</span><span style=color:#000>,</span> <span style=color:#000>Record</span> <span style=color:#000>txn</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>throws</span> <span style=color:#000>KeeperException</span><span style=color:#000>.</span><span style=color:#836c28>NoNodeException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ProcessTxnResult</span> <span style=color:#000>rc</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>switch</span> <span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getType</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>OpCode</span><span style=color:#000>.</span><span style=color:#836c28>createSession</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sessions</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getClientId</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                <span style=color:#000>((</span><span style=color:#000>CreateSessionTxn</span><span style=color:#000>)</span> <span style=color:#000>txn</span><span style=color:#000>).</span><span style=color:#836c28>getTimeOut</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// give dataTree a chance to sync its lastProcessedZxid
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>rc</span> <span style=color:#000>=</span> <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>processTxn</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>,</span> <span style=color:#000>txn</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>OpCode</span><span style=color:#000>.</span><span style=color:#836c28>closeSession</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sessions</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>.</span><span style=color:#836c28>getClientId</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span> <span style=color:#000>=</span> <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>processTxn</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>,</span> <span style=color:#000>txn</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>default</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span> <span style=color:#000>=</span> <span style=color:#000>dt</span><span style=color:#000>.</span><span style=color:#836c28>processTxn</span><span style=color:#000>(</span><span style=color:#000>hdr</span><span style=color:#000>,</span> <span style=color:#000>txn</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=processtxn>processTxn</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.DataTree#processTxn
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>ProcessTxnResult</span> <span style=color:#000>processTxn</span><span style=color:#000>(</span><span style=color:#000>TxnHeader</span> <span style=color:#000>header</span><span style=color:#000>,</span> <span style=color:#000>Record</span> <span style=color:#000>txn</span><span style=color:#000>,</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>isSubTxn</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ProcessTxnResult</span> <span style=color:#000>rc</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ProcessTxnResult</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>clientId</span> <span style=color:#000>=</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getClientId</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>cxid</span> <span style=color:#000>=</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getCxid</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>zxid</span> <span style=color:#000>=</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getZxid</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>type</span> <span style=color:#000>=</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getType</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>err</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>multiResult</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>switch</span> <span style=color:#000>(</span><span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getType</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>case</span> <span style=color:#000>OpCode</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>CreateTxn</span> <span style=color:#000>createTxn</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>CreateTxn</span><span style=color:#000>)</span> <span style=color:#000>txn</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>path</span> <span style=color:#000>=</span> <span style=color:#000>createTxn</span><span style=color:#000>.</span><span style=color:#836c28>getPath</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#177500>// 创建节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>createNode</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>createTxn</span><span style=color:#000>.</span><span style=color:#836c28>getPath</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>createTxn</span><span style=color:#000>.</span><span style=color:#836c28>getData</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>createTxn</span><span style=color:#000>.</span><span style=color:#836c28>getAcl</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>createTxn</span><span style=color:#000>.</span><span style=color:#836c28>getEphemeral</span><span style=color:#000>()</span> <span style=color:#000>?</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getClientId</span><span style=color:#000>()</span> <span style=color:#000>:</span> <span style=color:#000>0</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>createTxn</span><span style=color:#000>.</span><span style=color:#836c28>getParentCVersion</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getZxid</span><span style=color:#000>(),</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getTime</span><span style=color:#000>(),</span> <span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>case</span> <span style=color:#000>OpCode</span><span style=color:#000>.</span><span style=color:#836c28>create2</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>CreateTxn</span> <span style=color:#000>create2Txn</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>CreateTxn</span><span style=color:#000>)</span> <span style=color:#000>txn</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>path</span> <span style=color:#000>=</span> <span style=color:#000>create2Txn</span><span style=color:#000>.</span><span style=color:#836c28>getPath</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>Stat</span> <span style=color:#000>stat</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Stat</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>createNode</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>create2Txn</span><span style=color:#000>.</span><span style=color:#836c28>getPath</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>create2Txn</span><span style=color:#000>.</span><span style=color:#836c28>getData</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>create2Txn</span><span style=color:#000>.</span><span style=color:#836c28>getAcl</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>create2Txn</span><span style=color:#000>.</span><span style=color:#836c28>getEphemeral</span><span style=color:#000>()</span> <span style=color:#000>?</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getClientId</span><span style=color:#000>()</span> <span style=color:#000>:</span> <span style=color:#000>0</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>create2Txn</span><span style=color:#000>.</span><span style=color:#836c28>getParentCVersion</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getZxid</span><span style=color:#000>(),</span> <span style=color:#000>header</span><span style=color:#000>.</span><span style=color:#836c28>getTime</span><span style=color:#000>(),</span> <span style=color:#000>stat</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>rc</span><span style=color:#000>.</span><span style=color:#836c28>stat</span> <span style=color:#000>=</span> <span style=color:#000>stat</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=createnode>createNode</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.DataTree#createNode
</span></span></span></code></pre></td></tr></table></div></div></div><h1 id=选举准备>选举准备</h1><h2 id=基本概念>基本概念</h2><p>SID：服务器ID，用来标识唯一一台ZooKeeper集群中的机器，每台机器不能重复，和myid一致。</p><p>ZXID：事务ID。ZXID是一个事务ID，用来标识一次服务器状态的变更。在某一个时刻，集群中的每台机器ZXID值不一定完全一致，这和ZooKeeper服务器对于客户端“更新请求”的处理逻辑有关。</p><p>Epoch：每个Leader任期的代号。没有Leader时统一轮投票过程中的逻辑时钟值是相同的。每投完一次票这个数据就会增加</p><p>一般投票是 (EPOCH, ZXID, SID) 【任期，事务ID，服务器ID】</p><p>选举Leader规则：</p><p>1、EPOCH 大的直接胜出</p><p>2、EPOCH 相同，事务id大的胜出</p><p>3、事务id相同，服务器id大的胜出</p><h2 id=基本流程>基本流程</h2><p><img src=../imgs/zookeeper_source_211220_3.png alt=zookeeper_source_211220_3.png></p><h2 id=开始选举准备>开始选举准备</h2><p>接上，加载完数据之后，开始Leader选举</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#start
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>synchronized</span> <span style=color:#a90d91>void</span> <span style=color:#000>start</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>getView</span><span style=color:#000>().</span><span style=color:#836c28>containsKey</span><span style=color:#000>(</span><span style=color:#000>myid</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>RuntimeException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;My id &#34;</span> <span style=color:#000>+</span> <span style=color:#000>myid</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; not in the peer list&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>loadDataBase</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>startServerCnxnFactory</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>adminServer</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>AdminServerException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Problem starting AdminServer&#34;</span><span style=color:#000>,</span> <span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>startLeaderElection</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=开始leader选举准备>开始Leader选举准备</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#startLeaderElection
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>synchronized</span> <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>startLeaderElection</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>       <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>getPeerState</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#000>ServerState</span><span style=color:#000>.</span><span style=color:#836c28>LOOKING</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>           <span style=color:#177500>// 创建选票
</span></span></span><span style=display:flex><span><span style=color:#177500></span>           <span style=color:#000>currentVote</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Vote</span><span style=color:#000>(</span><span style=color:#000>myid</span><span style=color:#000>,</span> <span style=color:#000>getLastLoggedZxid</span><span style=color:#000>(),</span> <span style=color:#000>getCurrentEpoch</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>       <span style=color:#000>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span> <span style=color:#a90d91>catch</span><span style=color:#000>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>electionType</span> <span style=color:#000>==</span> <span style=color:#000>0</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>udpSocket</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>DatagramSocket</span><span style=color:#000>(</span><span style=color:#000>getQuorumAddress</span><span style=color:#000>().</span><span style=color:#836c28>getPort</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>            <span style=color:#000>responder</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ResponderThread</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>responder</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>SocketException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 创建选票实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>electionAlg</span> <span style=color:#000>=</span> <span style=color:#000>createElectionAlgorithm</span><span style=color:#000>(</span><span style=color:#000>electionType</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=创建选票实例>创建选票实例</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#createElectionAlgorithm
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#000>Election</span> <span style=color:#000>createElectionAlgorithm</span><span style=color:#000>(</span><span style=color:#a90d91>int</span> <span style=color:#000>electionAlgorithm</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Election</span> <span style=color:#000>le</span><span style=color:#000>=</span><span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>//TODO: use a factory rather than a switch
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>switch</span> <span style=color:#000>(</span><span style=color:#000>electionAlgorithm</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>0</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>le</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LeaderElection</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>1</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>le</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>AuthFastLeaderElection</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>2</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>le</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>AuthFastLeaderElection</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>,</span> <span style=color:#a90d91>true</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>3</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 创建CnxnManager
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>QuorumCnxManager</span> <span style=color:#000>qcm</span> <span style=color:#000>=</span> <span style=color:#000>createCnxnManager</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QuorumCnxManager</span> <span style=color:#000>oldQcm</span> <span style=color:#000>=</span> <span style=color:#000>qcmRef</span><span style=color:#000>.</span><span style=color:#836c28>getAndSet</span><span style=color:#000>(</span><span style=color:#000>qcm</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>oldQcm</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>warn</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Clobbering already-set QuorumCnxManager (restarting leader election?)&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>oldQcm</span><span style=color:#000>.</span><span style=color:#836c28>halt</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QuorumCnxManager</span><span style=color:#000>.</span><span style=color:#836c28>Listener</span> <span style=color:#000>listener</span> <span style=color:#000>=</span> <span style=color:#000>qcm</span><span style=color:#000>.</span><span style=color:#836c28>listener</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span><span style=color:#000>(</span><span style=color:#000>listener</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 启动监听线程
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>listener</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 准备开始选举
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>FastLeaderElection</span> <span style=color:#000>fle</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FastLeaderElection</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>,</span> <span style=color:#000>qcm</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>fle</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>le</span> <span style=color:#000>=</span> <span style=color:#000>fle</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>error</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Null listener when initializing cnx manager&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>x</span><span style=color:#2300ce>&#39;x&#39;</span><span style=color:#000>x</span>    
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>default</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>assert</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>le</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=创建cnxnmanage>创建CnxnManage</h3><p>负责选举过程中网络通信</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#createCnxnManager
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>QuorumCnxManager</span> <span style=color:#000>createCnxnManager</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#a90d91>new</span> <span style=color:#000>QuorumCnxManager</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>getId</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>getView</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>authServer</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>authLearner</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>tickTime</span> <span style=color:#000>*</span> <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>syncLimit</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>getQuorumListenOnAllIPs</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>quorumCnxnThreadsSize</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>isQuorumSaslAuthEnabled</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>new QuorumCnxManager创建各种队列</p><h3 id=启动监听线程>启动监听线程</h3><p>client = ss.accept()</p><p>阻塞，等待请求处理</p><h3 id=准备开始选举>准备开始选举</h3><p>初始化各种队列</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.FastLeaderElection#FastLeaderElection
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>FastLeaderElection</span><span style=color:#000>(</span><span style=color:#000>QuorumPeer</span> <span style=color:#000>self</span><span style=color:#000>,</span> <span style=color:#000>QuorumCnxManager</span> <span style=color:#000>manager</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>stop</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>manager</span> <span style=color:#000>=</span> <span style=color:#000>manager</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>starter</span><span style=color:#000>(</span><span style=color:#000>self</span><span style=color:#000>,</span> <span style=color:#000>manager</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.FastLeaderElection#starter
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>starter</span><span style=color:#000>(</span><span style=color:#000>QuorumPeer</span> <span style=color:#000>self</span><span style=color:#000>,</span> <span style=color:#000>QuorumCnxManager</span> <span style=color:#000>manager</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>self</span> <span style=color:#000>=</span> <span style=color:#000>self</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>proposedLeader</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>proposedZxid</span> <span style=color:#000>=</span> <span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>sendqueue</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>ToSend</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>recvqueue</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>Notification</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>messenger</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Messenger</span><span style=color:#000>(</span><span style=color:#000>manager</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=leader选举>Leader选举</h1><h2 id=整体结构>整体结构</h2><p><img src=../imgs/zookeeper_source_211220_4.png alt=zookeeper_source_211220_4.png></p><h2 id=基本流程-1>基本流程</h2><p><img src=../imgs/zookeeper_source_211220_5.png alt=zookeeper_source_211220_5.png></p><h2 id=开始选举执行>开始选举执行</h2><p>入口在上一节 开始Leader选举准备的 QuorumPeer 的 start方法中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#start
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>synchronized</span> <span style=color:#a90d91>void</span> <span style=color:#000>start</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxx</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>因为 QuorumPeer -> ZooKeeperThread -> Thread，所以super.start方法执行的是 QuorumPeer 的run方法。直接看run方法。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>xxxx</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>while</span> <span style=color:#000>(</span><span style=color:#000>running</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>switch</span> <span style=color:#000>(</span><span style=color:#000>getPeerState</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>LOOKING</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>          <span style=color:#000>xxx</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>          <span style=color:#177500>// 更新当前选票，lookForLeader进行选举
</span></span></span><span style=display:flex><span><span style=color:#177500></span>          <span style=color:#000>setCurrentVote</span><span style=color:#000>(</span><span style=color:#000>makeLEStrategy</span><span style=color:#000>().</span><span style=color:#836c28>lookForLeader</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>          <span style=color:#177500>// leader的选举在org.apache.zookeeper.server.quorum.FastLeaderElection#lookForLeader中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=lookforleader>lookForLeader</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.FastLeaderElection#lookForLeader
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>Vote</span> <span style=color:#000>lookForLeader</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxxxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>synchronized</span><span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 更新逻辑时钟,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>logicalclock</span><span style=color:#000>.</span><span style=color:#836c28>incrementAndGet</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 更新选票，给自己投票
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>updateProposal</span><span style=color:#000>(</span><span style=color:#000>getInitId</span><span style=color:#000>(),</span> <span style=color:#000>getInitLastLoggedZxid</span><span style=color:#000>(),</span> <span style=color:#000>getPeerEpoch</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 发送选票通知
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>sendNotifications</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Notification</span> <span style=color:#000>n</span> <span style=color:#000>=</span> <span style=color:#000>recvqueue</span><span style=color:#000>.</span><span style=color:#836c28>poll</span><span style=color:#000>(</span><span style=color:#000>notTimeout</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>MILLISECONDS</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>lookForLeader方法中，有两个变量, <strong>一个recvset, 用来保存当前server的接受其他server的本轮投票信息, key为当前server的id</strong>, 也即是我们在配置文件中配置的myid, 而另外一个变量<strong>outofelection保存选举结束以后法定的server的投票信息</strong>, 这里的法定指的是FOLLOWING和LEADING状态的server, 不包活OBSERVING状态的server。
更新逻辑时钟，此处逻辑时钟是为了在选举leader时比较其他选票中的server中的epoch和本地谁最新, 然后将自己的选票proposal|发送给其他所有server。</p><p>选出的选票信息封装在一个Notification对象中，如果取出的选票为null我们通过</p><p>QuorumCnxManager 检查发送队列中是否投递过选票, 如果投递过说明连接并没有断开，则重新发送选票到其他sever，否则说明连接断开，重连所有Server即可。那么连接没有断开，为什么会收不到选票信息呢，有可能是选票超时时限导致没有收到选票, 所有将选票时限延长了一倍。</p><p>如果选出的选票Notification不为null, 校验投票server和选举leader是否合法, 然后根据选票状态执行不同分支, 选举过程定LOOKING分支, 接下来比较选票epoch和当前逻辑时钟。</p><p>如果选票epoch > 逻辑时钟, 说明选票是最新的, 自己的选票这一轮已经过时, 应该更新当前自己 Server的逻辑时钟, 并清空当前收到的其他server的选票, 然后比较自己和选票中谁更适合做leader, 发送新的投票给其他所有server。</p><h4 id=updateproposal>updateProposal</h4><h4 id=sendnotifications>sendNotifications</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>sendNotifications</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#a90d91>long</span> <span style=color:#000>sid</span> <span style=color:#000>:</span> <span style=color:#000>self</span><span style=color:#000>.</span><span style=color:#836c28>getCurrentAndNextConfigVoters</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QuorumVerifier</span> <span style=color:#000>qv</span> <span style=color:#000>=</span> <span style=color:#000>self</span><span style=color:#000>.</span><span style=color:#836c28>getQuorumVerifier</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ToSend</span> <span style=color:#000>notmsg</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ToSend</span><span style=color:#000>(</span><span style=color:#000>ToSend</span><span style=color:#000>.</span><span style=color:#836c28>mType</span><span style=color:#000>.</span><span style=color:#836c28>notification</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>proposedLeader</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>proposedZxid</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>logicalclock</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                <span style=color:#000>QuorumPeer</span><span style=color:#000>.</span><span style=color:#836c28>ServerState</span><span style=color:#000>.</span><span style=color:#836c28>LOOKING</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sid</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>proposedEpoch</span><span style=color:#000>,</span> <span style=color:#000>qv</span><span style=color:#000>.</span><span style=color:#836c28>toString</span><span style=color:#000>().</span><span style=color:#836c28>getBytes</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sendqueue</span><span style=color:#000>.</span><span style=color:#836c28>offer</span><span style=color:#000>(</span><span style=color:#000>notmsg</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>此方法遍历所有投票参与者集合，将选票信息构造成一个ToSend对象，分别发送消息放置到队列 sendqueue 中。同理集群中每一个server节点都会将自己的选票发送给其他servgqr。既然有发送选票，肯定存在接受选票信息。下文 WorkerRecv将介绍</p><h4 id=workersender发送消息>WorkerSender发送消息</h4><p>上文将发送消息放置到队列 sendqueue 中后，由WorkerSender发送消息。它是一个线程，直接看run方法</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.FastLeaderElection.Messenger.WorkerSender
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>WorkerSender</span> <span style=color:#a90d91>extends</span> <span style=color:#000>ZooKeeperThread</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>volatile</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>stop</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QuorumCnxManager</span> <span style=color:#000>manager</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>WorkerSender</span><span style=color:#000>(</span><span style=color:#000>QuorumCnxManager</span> <span style=color:#000>manager</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>super</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;WorkerSender&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>stop</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>manager</span> <span style=color:#000>=</span> <span style=color:#000>manager</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>while</span> <span style=color:#000>(!</span><span style=color:#000>stop</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>ToSend</span> <span style=color:#000>m</span> <span style=color:#000>=</span> <span style=color:#000>sendqueue</span><span style=color:#000>.</span><span style=color:#836c28>poll</span><span style=color:#000>(</span><span style=color:#000>3000</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>MILLISECONDS</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>if</span><span style=color:#000>(</span><span style=color:#000>m</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#a90d91>continue</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>process</span><span style=color:#000>(</span><span style=color:#000>m</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;WorkerSender is down&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>    
</span></span></code></pre></td></tr></table></div></div></details><br><p>处理消息
process方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.FastLeaderElection.Messenger.WorkerSender#process
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>void</span> <span style=color:#000>process</span><span style=color:#000>(</span><span style=color:#000>ToSend</span> <span style=color:#000>m</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ByteBuffer</span> <span style=color:#000>requestBuffer</span> <span style=color:#000>=</span> <span style=color:#000>buildMsg</span><span style=color:#000>(</span><span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>state</span><span style=color:#000>.</span><span style=color:#836c28>ordinal</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>leader</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>zxid</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>electionEpoch</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>peerEpoch</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>configData</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>manager</span><span style=color:#000>.</span><span style=color:#836c28>toSend</span><span style=color:#000>(</span><span style=color:#000>m</span><span style=color:#000>.</span><span style=color:#836c28>sid</span><span style=color:#000>,</span> <span style=color:#000>requestBuffer</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>manager.toSend方法<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumCnxManager#toSend
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>toSend</span><span style=color:#000>(</span><span style=color:#000>Long</span> <span style=color:#000>sid</span><span style=color:#000>,</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>b</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>/*
</span></span></span><span style=display:flex><span><span style=color:#177500>     * If sending message to myself, then simply enqueue it (loopback).
</span></span></span><span style=display:flex><span><span style=color:#177500>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>mySid</span> <span style=color:#000>==</span> <span style=color:#000>sid</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>position</span><span style=color:#000>(</span><span style=color:#000>0</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>addToRecvQueue</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>Message</span><span style=color:#000>(</span><span style=color:#000>b</span><span style=color:#000>.</span><span style=color:#836c28>duplicate</span><span style=color:#000>(),</span> <span style=color:#000>sid</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>ArrayBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#000>&gt;</span> <span style=color:#000>bq</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ArrayBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#000>&gt;(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>SEND_CAPACITY</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>ArrayBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#000>&gt;</span> <span style=color:#000>oldq</span> <span style=color:#000>=</span> <span style=color:#000>queueSendMap</span><span style=color:#000>.</span><span style=color:#836c28>putIfAbsent</span><span style=color:#000>(</span><span style=color:#000>sid</span><span style=color:#000>,</span> <span style=color:#000>bq</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>oldq</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>             <span style=color:#000>addToSendQueue</span><span style=color:#000>(</span><span style=color:#000>oldq</span><span style=color:#000>,</span> <span style=color:#000>b</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>             <span style=color:#000>addToSendQueue</span><span style=color:#000>(</span><span style=color:#000>bq</span><span style=color:#000>,</span> <span style=color:#000>b</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>}</span>
</span></span><span style=display:flex><span>         <span style=color:#177500>// 同对应的服务建议连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>connectOne</span><span style=color:#000>(</span><span style=color:#000>sid</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>如果发送的服务器id和myid相同，直接添加到自己的 recvQueue 中。否则往外发送消息，发给谁先发给对应的队列中。</p><h4 id=建立连接>建立连接</h4><p>connectOne</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumCnxManager#connectOne(long)
</span></span></span><span style=display:flex><span><span style=color:#177500>// 嵌套
</span></span></span><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumCnxManager#connectOne(long, java.net.InetSocketAddress)
</span></span></span><span style=display:flex><span><span style=color:#177500>// 同步或异步
</span></span></span><span style=display:flex><span><span style=color:#177500>// 创建socket连接
</span></span></span></code></pre></td></tr></table></div></div></div><p>各种嵌套，这里选择其中同步的建立连接分析<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumCnxManager#startConnection
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>startConnection</span><span style=color:#000>(</span><span style=color:#000>Socket</span> <span style=color:#000>sock</span><span style=color:#000>,</span> <span style=color:#000>Long</span> <span style=color:#000>sid</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// If lost the challenge, then drop the new connection
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>sid</span> <span style=color:#000>&gt;</span> <span style=color:#000>self</span><span style=color:#000>.</span><span style=color:#836c28>getId</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Have smaller server identifier, so dropping the &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#c41a16>&#34;connection: (&#34;</span> <span style=color:#000>+</span> <span style=color:#000>sid</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;, &#34;</span> <span style=color:#000>+</span> <span style=color:#000>self</span><span style=color:#000>.</span><span style=color:#836c28>getId</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;)&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>closeSocket</span><span style=color:#000>(</span><span style=color:#000>sock</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// Otherwise proceed with the connection
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>SendWorker</span> <span style=color:#000>sw</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SendWorker</span><span style=color:#000>(</span><span style=color:#000>sock</span><span style=color:#000>,</span> <span style=color:#000>sid</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>RecvWorker</span> <span style=color:#000>rw</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>RecvWorker</span><span style=color:#000>(</span><span style=color:#000>sock</span><span style=color:#000>,</span> <span style=color:#000>din</span><span style=color:#000>,</span> <span style=color:#000>sid</span><span style=color:#000>,</span> <span style=color:#000>sw</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sw</span><span style=color:#000>.</span><span style=color:#836c28>setRecv</span><span style=color:#000>(</span><span style=color:#000>rw</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>SendWorker</span> <span style=color:#000>vsw</span> <span style=color:#000>=</span> <span style=color:#000>senderWorkerMap</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(</span><span style=color:#000>sid</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span><span style=color:#000>(</span><span style=color:#000>vsw</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000>vsw</span><span style=color:#000>.</span><span style=color:#836c28>finish</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>senderWorkerMap</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#000>sid</span><span style=color:#000>,</span> <span style=color:#000>sw</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>queueSendMap</span><span style=color:#000>.</span><span style=color:#836c28>putIfAbsent</span><span style=color:#000>(</span><span style=color:#000>sid</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>ArrayBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#000>&gt;(</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>SEND_CAPACITY</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sw</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>rw</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xxx</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>这里如果自己的id小于sid（对方的服务器id），则不发送消息。</p><h4 id=sendworker>SendWorker</h4><p>因为这也是个线程类，直接找run方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumCnxManager.SendWorker#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>调用send方法</span><span style=color:#000>，</span><span style=color:#000>不断往外写</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=recvworker>RecvWorker</h4><p>同上也是个线程类，直接找run方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumCnxManager.RecvWorker#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>addToRecvQueue</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>Message</span><span style=color:#000>(</span><span style=color:#000>message</span><span style=color:#000>.</span><span style=color:#836c28>duplicate</span><span style=color:#000>(),</span> <span style=color:#000>sid</span><span style=color:#000>));</span>
</span></span></code></pre></td></tr></table></div></div></div><p>添加消息到recvQueue中</p><h4 id=workerrecv接受消息>WorkerRecv接受消息</h4><p>因为该类为线程，直接看其run方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.FastLeaderElection.Messenger.WorkerReceiver#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>response</span> <span style=color:#000>=</span> <span style=color:#000>manager</span><span style=color:#000>.</span><span style=color:#836c28>pollRecvQueue</span><span style=color:#000>(</span><span style=color:#000>3000</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>MILLISECONDS</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></td></tr></table></div></div></div><h1 id=follower和leader状态同步>Follower和Leader状态同步</h1><p>选举结束后，每个节点都需要根据自己的角色更新自己的状态。</p><p>Leader更新状态入口：leader.lead()</p><p>Follower更新状态入口：follower.followerLeader()</p><p>同步策略：</p><p>1、DIFF（差异化同步）</p><p>2、TRUNC（回滚同步）</p><p>3、SNAP（全量同步）</p><p>同步过程中，有可能重复提议或提交</p><p>注意事项：</p><p>1、follower必须要让leader知道自己的状态：epoch/zxid/sid</p><p>2、leader得知follower状态后，要确定以何种方式的数据同步DIFF、TRUNC、SNAP</p><p>3、执行数据同步</p><p>4、当leader接收到超过半数follower的ack之后，进入正常工作状态，集群启动完成</p><p>最终同步的方式：</p><p>1、DIFF一样，无需任何动作</p><p>2、TRUNC follower的zxid比leader的zxid大，follower要回滚</p><p>3、COMMIT leader的zxid比follower的zxid大，发送Proposal给follower提交执行</p><p>4、如果follower没有任何数据，直接使用SNAP的方式同步数据（直接把数据全部序列同步给follower）</p><h2 id=基本流程-2>基本流程</h2><p><img src=../imgs/zookeeper_source_211220_6.png alt=zookeeper_source_211220_6.png></p><h2 id=入口>入口</h2><p>还是在QuorumPeer的run方法中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.QuorumPeer#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>case</span> <span style=color:#000>FOLLOWING</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;FOLLOWING&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>setFollower</span><span style=color:#000>(</span><span style=color:#000>makeFollower</span><span style=color:#000>(</span><span style=color:#000>logFactory</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000>follower</span><span style=color:#000>.</span><span style=color:#836c28>followLeader</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>case</span> <span style=color:#000>LEADING</span><span style=color:#000>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;LEADING&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>setLeader</span><span style=color:#000>(</span><span style=color:#000>makeLeader</span><span style=color:#000>(</span><span style=color:#000>logFactory</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000>leader</span><span style=color:#000>.</span><span style=color:#836c28>lead</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>setLeader</span><span style=color:#000>(</span><span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=lead方法>lead方法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.Leader#lead
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>void</span> <span style=color:#000>lead</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>cnxAcceptor</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><p>调用线程start方法，直接看本类run方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.Leader.LearnerCnxAcceptor#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>while</span> <span style=color:#000>(!</span><span style=color:#000>stop</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Socket</span> <span style=color:#000>s</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>boolean</span> <span style=color:#000>error</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>s</span> <span style=color:#000>=</span> <span style=color:#000>ss</span><span style=color:#000>.</span><span style=color:#836c28>accept</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=followlead方法>followLead方法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.Follower#followLeader
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>void</span> <span style=color:#000>followLeader</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 找leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>QuorumServer</span> <span style=color:#000>leaderServer</span> <span style=color:#000>=</span> <span style=color:#000>findLeader</span><span style=color:#000>();</span>            
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 连接leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>connectToLeader</span><span style=color:#000>(</span><span style=color:#000>leaderServer</span><span style=color:#000>.</span><span style=color:#836c28>addr</span><span style=color:#000>,</span> <span style=color:#000>leaderServer</span><span style=color:#000>.</span><span style=color:#836c28>hostname</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 注册到leader，同步信息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>long</span> <span style=color:#000>newEpochZxid</span> <span style=color:#000>=</span> <span style=color:#000>registerWithLeader</span><span style=color:#000>(</span><span style=color:#000>Leader</span><span style=color:#000>.</span><span style=color:#836c28>FOLLOWERINFO</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>while</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>isRunning</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 读取 packet
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>readPacket</span><span style=color:#000>(</span><span style=color:#000>qp</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 处理 packet
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>processPacket</span><span style=color:#000>(</span><span style=color:#000>qp</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>      
</span></span></code></pre></td></tr></table></div></div></div><h1 id=服务端leader启动>服务端Leader启动</h1><h2 id=基本流程-3>基本流程</h2><p><img src=../imgs/zookeeper_source_211220_7.png alt=zookeeper_source_211220_7.png></p><h2 id=startzkserver>startZkServer</h2><p>该方法调用在上文介绍的lead方法中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.Leader#startZkServer
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>synchronized</span> <span style=color:#a90d91>void</span> <span style=color:#000>startZkServer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>startup</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><p>startup方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.ZooKeeperServer#startup
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>synchronized</span> <span style=color:#a90d91>void</span> <span style=color:#000>startup</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>sessionTracker</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>createSessionTracker</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>startSessionTracker</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 接收请求处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>setupRequestProcessors</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>registerJMX</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>setState</span><span style=color:#000>(</span><span style=color:#000>State</span><span style=color:#000>.</span><span style=color:#836c28>RUNNING</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>notifyAll</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>继续分析 setupRequestProcessors，((PrepRequestProcessor)firstProcessor).start();<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.PrepRequestProcessor#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 真正处理请求
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>pRequest</span><span style=color:#000>(</span><span style=color:#000>request</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h1 id=服务端follower启动>服务端Follower启动</h1><h2 id=基本流程-4>基本流程</h2><p><img src=../imgs/zookeeper_source_211220_8.png alt=zookeeper_source_211220_8.png></p><p>入口在上文分析的followLeader方法中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.server.quorum.Follower#followLeader
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>void</span> <span style=color:#000>followLeader</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>while</span> <span style=color:#000>(</span><span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>isRunning</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 接收请求
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>readPacket</span><span style=color:#000>(</span><span style=color:#000>qp</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// 处理请求
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>processPacket</span><span style=color:#000>(</span><span style=color:#000>qp</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxx</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=客户端启动>客户端启动</h1><h2 id=基本流程-5>基本流程</h2><p><img src=../imgs/zookeeper_source_211220_9.png alt=zookeeper_source_211220_9.png></p><h2 id=启动入口-1>启动入口</h2><p>客户端是通过 ZkCli.sh 脚本启动的，调用了 org.apache.zookeeper.ZooKeeperMain 函数</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ZooKeeperMain#main
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>args</span><span style=color:#000>[])</span> <span style=color:#a90d91>throws</span> <span style=color:#000>CliException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>InterruptedException</span>
</span></span><span style=display:flex><span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ZooKeeperMain</span> <span style=color:#000>main</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ZooKeeperMain</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>main</span><span style=color:#000>.</span><span style=color:#836c28>run</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ZooKeeperMain<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// org.apache.zookeeper.ZooKeeperMain#ZooKeeperMain(java.lang.String[])
</span></span><span style=display:flex><span>public ZooKeeperMain(String args[]) throws IOException, InterruptedException {
</span></span><span style=display:flex><span>    cl.parseOptions(args);
</span></span><span style=display:flex><span>    System.out.println(&#34;Connecting to &#34; + cl.getOption(&#34;server&#34;));
</span></span><span style=display:flex><span>    // 连接zk
</span></span><span style=display:flex><span>    connectToZK(cl.getOption(&#34;server&#34;));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=连接zk>连接zk</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ZooKeeperMain#connectToZK
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>void</span> <span style=color:#000>connectToZK</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>newHost</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>zk</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ZooKeeperAdmin</span><span style=color:#000>(</span><span style=color:#000>host</span><span style=color:#000>,</span> <span style=color:#000>Integer</span><span style=color:#000>.</span><span style=color:#836c28>parseInt</span><span style=color:#000>(</span><span style=color:#000>cl</span><span style=color:#000>.</span><span style=color:#836c28>getOption</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;timeout&#34;</span><span style=color:#000>)),</span> <span style=color:#a90d91>new</span> <span style=color:#000>MyWatcher</span><span style=color:#000>(),</span> <span style=color:#000>readOnly</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>创建ZooKeeperAdmin，继续递归super调用<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ZooKeeper#ZooKeeper
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>ZooKeeper</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>connectString</span><span style=color:#000>,</span> <span style=color:#a90d91>int</span> <span style=color:#000>sessionTimeout</span><span style=color:#000>,</span> <span style=color:#000>Watcher</span> <span style=color:#000>watcher</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>boolean</span> <span style=color:#000>canBeReadOnly</span><span style=color:#000>,</span> <span style=color:#000>HostProvider</span> <span style=color:#000>aHostProvider</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ZKClientConfig</span> <span style=color:#000>clientConfig</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Initiating client connection, connectString=&#34;</span> <span style=color:#000>+</span> <span style=color:#000>connectString</span>
</span></span><span style=display:flex><span>            <span style=color:#000>+</span> <span style=color:#c41a16>&#34; sessionTimeout=&#34;</span> <span style=color:#000>+</span> <span style=color:#000>sessionTimeout</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; watcher=&#34;</span> <span style=color:#000>+</span> <span style=color:#000>watcher</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>clientConfig</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>clientConfig</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ZKClientConfig</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>clientConfig</span> <span style=color:#000>=</span> <span style=color:#000>clientConfig</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>watchManager</span> <span style=color:#000>=</span> <span style=color:#000>defaultWatchManager</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 设置watcher
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>watchManager</span><span style=color:#000>.</span><span style=color:#836c28>defaultWatcher</span> <span style=color:#000>=</span> <span style=color:#000>watcher</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ConnectStringParser</span> <span style=color:#000>connectStringParser</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ConnectStringParser</span><span style=color:#000>(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>connectString</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hostProvider</span> <span style=color:#000>=</span> <span style=color:#000>aHostProvider</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 创建连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>cnxn</span> <span style=color:#000>=</span> <span style=color:#000>createConnection</span><span style=color:#000>(</span><span style=color:#000>connectStringParser</span><span style=color:#000>.</span><span style=color:#836c28>getChrootPath</span><span style=color:#000>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>hostProvider</span><span style=color:#000>,</span> <span style=color:#000>sessionTimeout</span><span style=color:#000>,</span> <span style=color:#a90d91>this</span><span style=color:#000>,</span> <span style=color:#000>watchManager</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>getClientCnxnSocket</span><span style=color:#000>(),</span> <span style=color:#000>canBeReadOnly</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 启动
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>cnxn</span><span style=color:#000>.</span><span style=color:#836c28>start</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><h3 id=创建连接>创建连接</h3><p>接上文 createConnection</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ClientCnxn#ClientCnxn
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#000>ClientCnxn</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>chrootPath</span><span style=color:#000>,</span> <span style=color:#000>HostProvider</span> <span style=color:#000>hostProvider</span><span style=color:#000>,</span> <span style=color:#a90d91>int</span> <span style=color:#000>sessionTimeout</span><span style=color:#000>,</span> <span style=color:#000>ZooKeeper</span> <span style=color:#000>zooKeeper</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ClientWatchManager</span> <span style=color:#000>watcher</span><span style=color:#000>,</span> <span style=color:#000>ClientCnxnSocket</span> <span style=color:#000>clientCnxnSocket</span><span style=color:#000>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>long</span> <span style=color:#000>sessionId</span><span style=color:#000>,</span> <span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>sessionPasswd</span><span style=color:#000>,</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>canBeReadOnly</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 发送消息线程
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>sendThread</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SendThread</span><span style=color:#000>(</span><span style=color:#000>clientCnxnSocket</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>eventThread</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>EventThread</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>clientConfig</span><span style=color:#000>=</span><span style=color:#000>zooKeeper</span><span style=color:#000>.</span><span style=color:#836c28>getClientConfig</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>initRequestTimeout</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>继续找当前类run方法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ClientCnxn.SendThread#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 开始连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>startConnect</span><span style=color:#000>(</span><span style=color:#000>serverAddress</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxxx</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 处理消息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>clientCnxnSocket</span><span style=color:#000>.</span><span style=color:#836c28>doTransport</span><span style=color:#000>(</span><span style=color:#000>to</span><span style=color:#000>,</span> <span style=color:#000>pendingQueue</span><span style=color:#000>,</span> <span style=color:#000>ClientCnxn</span><span style=color:#000>.</span><span style=color:#836c28>this</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=开始连接>开始连接</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ClientCnxn.SendThread#startConnect
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>startConnect</span><span style=color:#000>(</span><span style=color:#000>InetSocketAddress</span> <span style=color:#000>addr</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>xxx</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>clientCnxnSocket</span><span style=color:#000>.</span><span style=color:#836c28>connect</span><span style=color:#000>(</span><span style=color:#000>addr</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这里注册并连接</p><h3 id=处理消息>处理消息</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ClientCnxnSocketNIO#doTransport
</span></span></span><span style=display:flex><span><span style=color:#177500>// 主要是数据处理应答等
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=main-run方法>main.run方法</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ZooKeeperMain#run
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>void</span> <span style=color:#000>run</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>CliException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>while</span> <span style=color:#000>((</span><span style=color:#000>line</span> <span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>)</span><span style=color:#000>readLine</span><span style=color:#000>.</span><span style=color:#836c28>invoke</span><span style=color:#000>(</span><span style=color:#000>console</span><span style=color:#000>,</span> <span style=color:#000>getPrompt</span><span style=color:#000>()))</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>executeLine</span><span style=color:#000>(</span><span style=color:#000>line</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=执行命令>执行命令</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ZooKeeperMain#executeLine
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>executeLine</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>line</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>CliException</span><span style=color:#000>,</span> <span style=color:#000>InterruptedException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>(!</span><span style=color:#000>line</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>cl</span><span style=color:#000>.</span><span style=color:#836c28>parseCommand</span><span style=color:#000>(</span><span style=color:#000>line</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>addToHistory</span><span style=color:#000>(</span><span style=color:#000>commandCount</span><span style=color:#000>,</span><span style=color:#000>line</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 处理命令
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>processCmd</span><span style=color:#000>(</span><span style=color:#000>cl</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>commandCount</span><span style=color:#000>++;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=处理命令>处理命令</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// org.apache.zookeeper.ZooKeeperMain#processCmd
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>protected</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>processCmd</span><span style=color:#000>(</span><span style=color:#000>MyCommandOptions</span> <span style=color:#000>co</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>CliException</span><span style=color:#000>,</span> <span style=color:#000>IOException</span><span style=color:#000>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>boolean</span> <span style=color:#000>watch</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>watch</span> <span style=color:#000>=</span> <span style=color:#000>processZKCmd</span><span style=color:#000>(</span><span style=color:#000>co</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>exitCode</span> <span style=color:#000>=</span> <span style=color:#000>0</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>CliException</span> <span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>watch</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>processZKCmd即处理服务端发来的命令</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c1a323d1e65891778ae8e6421dfccb25>3 - 分布式一致性算法</h1><h1 id=基本概念>基本概念</h1><h2 id=cap>CAP</h2><p>C：一致性</p><p>A：可用性</p><p>P：分区容错性</p><p>CP或者AP</p><h2 id=base-理论><strong>BASE 理论</strong></h2><p>BASE理论指的是基本可用 Basically Available，软状态Soft State，最终一致性 Eventual Consistency，核心思想是即便无法做到强一致性，但应该采用适合的方式保证最终一致性。</p><p>BASE，Basically Available Soft State Eventual Consistency 的简写：</p><p><strong>BA</strong>：Basically Available 基本可用，分布式系统在出现故障的时候，允许损失部分可用性，即保证核心可用。</p><p><strong>S</strong>：Soft State 软状态，允许系统存在中间状态，而该中间状态不会影响系统整体可用性。</p><p><strong>E</strong>：Consistency 最终一致性，系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。</p><p>BASE 理论本质上是对 CAP 理论的延伸，是对 CAP 中 AP 方案的一个补充。</p><h2 id=xa简单介绍>XA简单介绍</h2><p>XA是由X / Open发布的规范，用于DTP（分布式事务处理）。</p><p>DTP分布式模型主要含有</p><ul><li>AP： 应用程序</li><li>TM: 事务管理器</li><li>RM: 资源管理器(如数据库)</li><li>CRM: 通讯资源管理器（如消息队列）</li></ul><p><strong>XA主要就是TM和RM之间的通讯桥梁。</strong></p><h2 id=分布式一致性算法前提>分布式一致性算法前提</h2><h3 id=拜占庭将军问题>拜占庭将军问题</h3><p>士兵（信息通道）可以伪造虚假信息</p><h2 id=分布式一致性算法考虑的原则><strong>分布式一致性算法考虑的原则</strong></h2><ul><li>safety : 在非拜占庭的情况下，不会返回错误的结果</li><li>available: 在大多数server运行且可以和别的server以及client通信的情况下，系统保证可用</li><li>不依赖时间来保证一致性，时钟错误，信息延迟会导致可用性不好</li></ul><h1 id=2pc-二阶段提交>2PC 二阶段提交</h1><p>两阶段提交协议（The two-phase commit protocol，2PC）是 XA 用于在全局事务中协调多个资源的机制</p><p><img src=../imgs/distributed_consistency_211219_1.png alt=distributed_consistency_211219_1.png></p><h2 id=1-阶段一提交事务请求>1、阶段一提交事务请求</h2><p>1、协调者向所有的参与者节点发送事务内容,询问是否可以执行事务操作,并等待其他参与者节点的反馈</p><p>2、各参与者节点执行事务操作</p><p>3、各参与者节点反馈给协调者,事务是否可以执行</p><h2 id=2-阶段二事务提交>2、阶段二事务提交</h2><p>根据一阶段各个参与者节点反馈的ack如果所有参与者节点反馈ack,则执行事务提交,否则中断事务</p><h3 id=事务提交>事务提交:</h3><p>1、协调者向各个参与者节点发送commit请求</p><p>2、参与者节点接受到commit请求后,执行事务的提交操作</p><p>3、各参与者节点完成事务提交后,向协调者返送提交commit成功确认消息</p><p>4、协调者接受各个参与者节点的ack后,完成事务commit</p><h3 id=中断事务>中断事务:</h3><p>1、发送回滚请求</p><p>2、各个参与者节点回滚事务</p><p>3、反馈给协调者事务回滚结果</p><p>4、协调者接受各参与者节点ack后回滚事务</p><h2 id=二阶段提交存在的问题>二阶段提交存在的问题:</h2><h3 id=1-同步阻塞>1、同步阻塞</h3><p>二阶段提交过程中,所有参与事务操作的节点处于同步阻塞状态,无法进行其他的操作</p><h3 id=2-单点问题>2、单点问题</h3><p>一旦协调者出现单点故障,无法保证事务的一致性操作</p><h3 id=3-数据不一致>3、数据不一致</h3><p>如果分布式节点出现网络分区,标些参与者未收到Commit提交命令。则出现部分参与者完成数据提交。未收到commit的命令的参与者则无法进行事务提交,整个分布式系统便出现了数据不一致性现象。</p><p>总结三种场景：协调者挂了；参与者挂了；两者都挂了。问题：不知道执行到哪一步才挂的，事物是否提交。所以多增加一个阶段提交，这样好歹知道是在事物提交之前挂的。</p><p>2PC不考虑超时回滚的情况下它是安全的, 2PC可以保证safety但是不保证liveness.</p><h1 id=3pc-三阶段提交>3PC 三阶段提交</h1><p>3PC是2PC的改进版,实质是将2PC中提交事务请求拆分为两步,形成了anCommit、PreCommit、doCommit三个阶段的事务一致性协议</p><p><img src=../imgs/distributed_consistency_211219_2.png alt=distributed_consistency_211219_2.png></p><h2 id=阶段一-cancommit>阶段一: CanCommit</h2><p>1、事务询问</p><p>2、各参与者节点向协调者反馈事务询问的响应</p><h2 id=阶段二-preccommit>阶段二: PreCcommit</h2><p>根据阶段一的反馈结果分为两种情况</p><h3 id=1-执行事务预提交>1、执行事务预提交</h3><p>1）发送预提交请求</p><p>协调者创沂有参与者节点发送preCcommit请求,进入prepared阶段</p><p>2）事务预提交</p><p>各参与者节点接受到preCommit请求后,执行事务操作</p><p>3)各参与者节点向协调者反馈事务执行</p><h3 id=2-中断事务>2、中断事务</h3><p>任意一个参与者节点反馈给协调者响应No时,或者在等待超时后,协调者还未收到参与者的反</p><p>馈,就中断事务,中断事务分为两步:</p><p>1)协调者向各个参与者节点发送abort请求</p><p>2)参与者收到abort请求,或者等待超时时间后,中断事务</p><h2 id=阶段三-docommit>阶段三: doCommit</h2><h3 id=1-执行提交>1、执行提交</h3><ol><li>发送提交请求</li></ol><p>协调者向所有参与者节点发送doCommit请求</p><ol start=2><li>事务提交</li></ol><p>各参与者节点接受到doCommit请求后,执行事务提交操作</p><ol start=3><li>反馈事务提交结果</li></ol><p>各参与者节点完成事务提交以后,向协调者发送ack</p><ol start=4><li>事务完成</li></ol><p>协调者接受各个参与者反馈的ack后,完成事务</p><h3 id=2-中断事务-1>2、中断事务</h3><ol><li><p>参与者接受到abort请求后,执行事务回滚</p></li><li><p>参与者完成事务回滚以后,向协调者发送ack</p></li><li><p>协调者接受回滚ack后,回滚事务</p></li></ol><h2 id=三阶段解决的问题>三阶段解决的问题</h2><p>1、引入超时时间，解决了同步阻塞</p><p>2、参与者长时间接收不到协调者响应，就会将事务进行提交，使用这个机制解决了单点问题</p><p>3PC是2PC的改进版, 实质是将2PC中提交事务请求拆分为两步, 形成了CanCommit、PreCommit、doCommit三个阶段的事务一致性协议（减少同步阻塞的发生范围）</p><p><strong>简单概括一下就是，如果挂掉的那台机器已经执行了commit，那么协调者可以从所有未挂掉的参与者的状态中分析出来，并执行commit。如果挂掉的那个参与者执行了rollback，那么协调者和其他的参与者执行的肯定也是rollback操作。</strong></p><p>所以，再多引入一个阶段之后，3PC解决了2PC中存在的那种由于协调者和参与者同时挂掉有可能导致的数据一致性问题。</p><h3 id=3pc存在的问题>3PC存在的问题</h3><p>在doCommit阶段，如果参与者无法及时接收到来自协调者的doCommit或者rebort请求时，会在等待超时之后，会继续进行事务的提交。</p><p>所以，由于网络原因，协调者发送的abort响应没有及时被参与者接收到，那么参与者在等待超时之后执行了commit操作。这样就和其他接到abort命令并执行回滚的参与者之间存在数据不一致的情况</p><p>参考：<a href="https://blog.csdn.net/yyd19921214/article/details/68953629?utm_source=app&app_version=4.6.1">分布式事务中2PC与3PC的区别</a></p><h1 id=pc的应用>PC的应用</h1><h2 id=注意>注意</h2><p>一般的主从同步并不涉及相关的分布式协议，基本都是异步使用日志或镜像进行主从同步，达成最终一致性。比如：DHFS的namenode，redis的主从同步以及MySQL的主从同步。不要把2pc，3pc，paxos等分布式一致性算法想象为处理主从复制这个过程的算法。</p><h2 id=mysql的2pc应用>mysql的2pc应用</h2><p>参考：<a href=https://www.cnblogs.com/hustcat/p/3577584.html>https://www.cnblogs.com/hustcat/p/3577584.html</a></p><h2 id=flink的2pc应用>flink的2pc应用</h2><p>参考：<a href=https://www.cnblogs.com/zhipeng-wang/p/14082806.html>https://www.cnblogs.com/zhipeng-wang/p/14082806.html</a></p><h1 id=补偿事务-tcc>补偿事务（TCC）</h1><p>TCC（<strong>Try-Confirm-Cancel</strong>）又称补偿事务。其核心思想是："针对每个操作都要注册一个与其对应的确认和补偿（撤销操作）"。它分为三个操作：</p><ul><li>Try阶段：主要是对业务系统做检测及资源预留。</li><li>Confirm阶段：确认执行业务操作。</li><li>Cancel阶段：取消执行业务操作。</li></ul><p>TCC是应用层的2PC实现</p><p>TCC事务的处理流程与2PC两阶段提交类似，不过2PC通常都是在跨库的DB层面，而TCC本质上就是一个应用层面的2PC，<strong>需要通过业务逻辑来实现</strong>。这种分布式事务的实现方式的优势在于，可以让<strong>应用自己定义数据库操作的粒度，使得降低锁冲突、提高吞吐量成为可能</strong>。</p><p>而不足之处则在于<strong>对应用的侵入性非常强</strong>，业务逻辑的每个分支都需要实现try、confirm、cancel三个操作。此外，其实现难度也比较大，需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。为了满足一致性的要求，<strong>confirm和cancel接口还必须实现幂等</strong>。</p><p>TCC的具体原理图如👇：</p><p><img src=../imgs/distributed_consistency_211219_3.png alt=distributed_consistency_211219_3.png></p><h2 id=2pc比较-数据库vs应用>2PC比较：数据库VS应用</h2><p>比较容易取得共识的结论：不同业务系统之间使用2PC。</p><p>那剩下的问题就简单了, 相同业务系统之间是使用数据访问层2PC还是TCC？一般而言，基于研发成本考虑，会建议：新系统由数据库层来实现统一的分布式事务。</p><p>但对热点数据，例如商品（票券等）库存，建议使用TCC方案，因为TCC的主要优势正是可以避免长时间锁定数据库资源进而提高并发性。</p><p>2PC、3PC、TCC都是基于XA协议思想，TCC是应用层/业务层，TCC实际上为2PC的变种。</p><h2 id=2pc与paxos>2PC与Paxos</h2><p>有一种广为流传的观点:"2PC到3PC到Paxos到Raft"，即认为:</p><p>• 2PC是Paxos的残次版本</p><p>• 3PC是2PC的改进</p><p>上述2个观点都是我所不认同的，更倾向于如下认知：</p><p>• 2PC与Paxos解决的问题不同：2PC是用于解决数据分片后，不同数据之间的分布式事务问题；而Paxos是解决相同数据多副本下的数据一致性问题。例如，UP-2PC的数据存储节点可以使用MGR来管理统一数据分片的高可用</p><p>• 3PC只是2PC的一个实践方法：一方面并没有完整解决事务管理器宕机和资源管理器宕机等异常，反而因为增加了一个处理阶段让问题更加复杂</p><h1 id=paxos算法>Paxos算法</h1><p>读音：/pakses/</p><p>Paxos算法是LeslieLamport1990年提出的一种一致性算法, 该算法是一种提高分布式系统容错性的一致性算法, 解决了3PC中网络分区的问题, paxos算法可以在节点失效、网络分区、网络延迟等各种异常情况下保证所有节点都处于同一状态, 同时paxos算法引入了“过半“理念, 即少数服从多数原则。</p><p><strong>paxos有三个版本:</strong></p><ul><li>BasicPaxos</li><li>MultiPaxos</li><li>FastPaxos</li></ul><h2 id=四种角色>四种角色</h2><p>在paxos算法中, 有四种种角色, 分别具有三种不同的行为, 但多数情况, 一个进程可能同时充当多种角色。</p><ul><li>client: 系统外部角色, 请求发起者, 不参与决策</li><li>proposer: 提案提议者</li><li>acceptor: 提案的表决者, 即是否accept该提案, 只有超过半数以上的acceptor接受了提案, 该提案才被认为被“选定“</li><li>learners: 提案的学习者, 当提案被选定后, 其同步执行提案, 不参与决策</li></ul><h2 id=两个阶段>两个阶段</h2><p>prepare阶段（准备解决）、accept阶段（同意阶段）</p><p>1、prepare阶段</p><p>&lt;1> proposer提出一个提案, 编号为N, 发送给所有的acceptor。</p><p>&lt;2> 每个表决者都保存自己的accept的最大提案编号maxN, 当表决者收到prepare(N) 请求时, 会比较N与maxN的值, 若N小于maxN, 则提案已过时, 拒绝prepare(N) 请求。若N大于等于maxN, 则接受提案, 并将该表决者曾经接受过的编号最大的提案Proposal(myid, maxN, wvalue) 反馈给提议者: 其中myid表示表决者acceptor的标识id, maxN表示接受过的最大提案编号maxN, value表示提案内容。若当前表决者未曾accept任何提议, 会将proposal(myid, nullnull) 反馈给提议者。</p><p>2、accept阶段</p><p>&lt;1> 提议者proposa|发出prepare(N) , 若收到超过半数表决者acceptor的反馈, proposal将真正的提案内容proposal(N, wvalue) 发送给所有表决者。</p><p>&lt;2> 表决者aCCeptor接受提议者发送的proposal提案后, 会将自己曾经accept过的最大</p><p>提案编号maxN和反馈过的prepare的最大编号, 若N大于这两个编号, 则当前表决者accept该提</p><p>案, 并反馈给提议者。否则拒绝该提议。</p><p>&lt;3> 若提议者没有收到半数以上的表决者accept反馈, 则重新进入prepare阶段, 递增提案编号, </p><p>重新提出prepare请求。若收到半数以上的accept, 则其他未向提议者反馈的表决者称为</p><p>learner, 主动同步提议者的提案。</p><p>正常流程</p><p><img src=../imgs/distributed_consistency_211219_4.png alt=distributed_consistency_211219_4.png></p><p>单点故障，部分节点失败</p><p><img src=../imgs/distributed_consistency_211219_5.png alt=distributed_consistency_211219_5.png></p><p>proposer失败</p><p><img src=../imgs/distributed_consistency_211219_6.png alt=distributed_consistency_211219_6.png></p><p><img src=../imgs/distributed_consistency_211219_7.png alt=distributed_consistency_211219_7.png></p><p>Basic Paxos算法存在活锁问题（liveness）或全序问题</p><blockquote><p>活锁：并发导致的你让我我让你，如对面走路互相让路还是会冲突。避免活锁：执行时间错开。
注意Basic Paxos的活锁原因是proposer1在发送请求给accepter之后挂掉了，然后proposer2又向accepter发送了新的请求，然后导致的活锁问题。更深层proposer可以有多个，所以mutil paxos采用了leader（单个）替代proposer（多个）解决活锁问题，如果leader挂掉就重新选举，都是leader说了算就不会产生活锁问题了。</p></blockquote><h2 id=消化理解>消化理解</h2><h3 id=paxos算法-1>paxos算法</h3><p>基于消息传递一关有高度容错性的一种算法, 是目前公认的解决分布式一致性问题最有效的算法</p><h3 id=重要概念>重要概念</h3><p>半数原则: 少数服从多数</p><h3 id=解决问题>解决问题</h3><p>在分布式系统中, 如果产生容机或者网络异常情况, 快速的正确的在集群内部对染个数据的信达成一致, 并玟不管发生任何异常, 都不会破坏整个系统的一致性</p><h4 id=复杂度问题>复杂度问题</h4><p>为了解决活锁问题，出现了multi-paxos；</p><p>为了解决通信次数较多的问题，出现了fast-paxos；</p><p>为了尽量减少冲突，出现了epaxos。</p><p>可以看到，工业级实现需要考虑更多的方面，诸如性能，异常等等。这也是许多分布式的一致性框架并非真正基于paxos来实现的原因。</p><h4 id=全序问题>全序问题</h4><p>对于paxos算法来说，不能保证两次提交最终的顺序，而zookeeper需要做到这点。</p><h3 id=理解basic-paxos细节>理解basic paxos细节</h3><ul><li>proposer是可以有多个，所以他叫做proposer，而不叫leader</li><li>proposer并不强制要发送propose到全部acceptor，也可以发送70%的acceptor，只要通过的有半数以上，就认为协议是成功的</li><li>容易看出，第二阶段的时候client仍需要等着，只有在第二阶段大半acceptor返回accepted后，client才能得到成功的信息</li><li>有一些错误场景中，proposer会互相锁住对方的递交，详细可以看wiki，这里不多阐述：<a href=https://en.wikipedia.org/wiki/Paxos_(computer_science)>Paxos (computer science)</a></li></ul><h2 id=multi-paxos>Multi Paxos</h2><h3 id=改进点>改进点</h3><ul><li>Multi Paxos中采用了 Leader election 保证了只有一个Proposer，避免了活锁的问题</li><li>Basic Paxos中只有Proposer知道 选择了哪个value，如果其他server想知道选择了哪个，那么就得按照paxos协议发起请求。</li><li>multi paxos 目标是实现复制日志序列；实现的时候我们在Prepare和accept的时候，加上日志记录的序号即可。</li></ul><h2 id=fast-paxos><strong>Fast Paxos</strong></h2><p>在Multi Paxos中，<strong>proposer -> leader -> acceptor -> learner</strong>，从提议到完成决议共经过3次通信，能不能减少通信步骤？</p><p>对Multi Paxos phase2a，如果可以自由提议value，则可以让proposer直接发起提议、leader退出通信过程，变为<strong>proposer -> acceptor -> learner</strong>，这就是Fast Paxos[2]的由来。</p><p>Multi Paxos里提议都由leader提出，因而不存在一次决议出现多个value，Fast Paxos里由proposer直接提议，一次决议里可能有多个proposer提议、出现多个value，即出现提议冲突(collision)。<strong>leader起到初始化决议进程(progress)和解决冲突的作用，当冲突发生时leader重新参与决议过程、回退到3次通信步骤。</strong></p><p>Paxos自身隐含的一个特性也可以达到减少通信步骤的目标，如果acceptor上一次确定(chosen)的提议来自proposerA，则当次决议proposerA可以直接提议减少一次通信步骤。如果想实现这样的效果，需要在proposer、acceptor记录上一次决议确定(chosen)的历史，用以在提议前知道哪个proposer的提议上一次被确定、当次决议能不能节省一次通信步骤。</p><h2 id=epaxos><strong>EPaxos</strong></h2><p>除了从减少通信步骤的角度提高Paxos决议效率外，还有其他方面可以降低Paxos决议时延，比如Generalized Paxos[3]提出不冲突的提议(例如对不同key的写请求)可以同时决议、以降低Paxos时延。</p><p>更进一步地，EPaxos[4](Egalitarian Paxos)提出一种既支持不冲突提议同时提交降低时延、还均衡各节点负载、同时将通信步骤减少到最少的Paxos优化方法。</p><p>为达到这些目标，EPaxos的实现有几个要点：</p><ul><li>一是EPaxos中没有全局的leader，而是每一次提议发起提议的proposer作为当次提议的leader(command leader)；</li><li>二是不相互影响(interfere)的提议可以同时提交；</li><li>三是跳过prepare，直接进入accept阶段。</li></ul><h1 id=zab协议>ZAB协议</h1><p>由于paxos算法窍现起来较难, 存在活锁和全序问题(无法保证两次最终提交的顺序) , 所以zookeeper并没有使用paxos作为一致性协议, 而是使用了ZAB协议。</p><p>ZAB（zookeeper atomic broadcast) : 是一种支持崖溃恢复的原子广播协议, 基于<strong>multi</strong> <strong>paxos</strong>实现</p><p>ZooKeeper使用<strong>单一主进程Leader用于处理客户端所有事务请求, , 即写请求</strong>。当服务器数据发生变更好, 集群采用ZAB原子广播协议, 以事务提交proposal的形式广播到所有的副本进程, 每一个事务分配一个全局的递增的事务编号xid。</p><p><strong>若客户端提交的请求为读请求时, 则接受请求的节点直接根据自己保存的数据响应</strong>。**若是写请求, 且当前节点不是leader, 那么该节点就会将请求转发给leader, leader会以提案的方式广播此写请求, 如果超过半数的节点同意写请求, 则该写请求就会提交。**leader会通知所有的订阅者同步数据。</p><p><img src=../imgs/distributed_consistency_211219_8.png alt=distributed_consistency_211219_8.png></p><h2 id=三种角色>三种角色</h2><ul><li><p>leader
负责处理集群的写请求，并发起投票，只有超过半数的节点同意后才会提交该写请求</p></li><li><p>follower
处理读请求，响应结果。转发写请求到leader，在选举leader过程中参与投票</p></li><li><p>observer
可以理解为没有投票权的follower，主要职责是协助follower处理读请求。那么当整个zk集群读请求负载很高时（此时会使用observer缓解读请求压力），为什么不直接增加follow节点而是增加observer节点呢？原因是增加follower节点会让leader在提出写请求提案时，需要半数以上的follower投票节点同意，这样会增加leader和foloower的通信压力，降低写操作效率</p></li></ul><h2 id=两种模式>两种模式</h2><h3 id=恢复模式>恢复模式</h3><p>当服务启动或领导崩溃后, zk进入恢复状态, 选举leader, leader选出后, 将完成leader别其他机器的数据同步, 当大多数server完成和leader的同步后, 恢复模式结束</p><h3 id=广播模式>广播模式</h3><p><strong>一旦Leader已经和多数的Follower进行了状态同步后, 进入广播模式</strong>。进入广播模式后, 如果有</p><p>新加入的服务器, 会自动从leader中同步数据。leader在接收客户端请求后, 会生成事务提案广播</p><p>给其他机器, 有超过半数以上的follower同意该提议后, 再提交事务。</p><p><strong>注意在ZAB的事务的二阶段提交中, 移除了事务中断的逻辑, follower要么ack, 要么放弃, leader无需等待所有的follower的ack。</strong></p><h2 id=zxid>zxid</h2><p>zxid是64位长度的Long类型, 其中高32位表示纪元epoch, 低32位表示事务标识xid。即zxid由两部分构成: epoch和xid</p><p>每个leader都会具有不同的epoch值, 表示一个纪元, 每一个新的选举开启时都会生成一个新的</p><p>epoch, 新的leader产生, 会更新所有的zKServer的zxid的epoch, xid是一个依次递增的事务编号。</p><h2 id=leader选举算法>leader选举算法</h2><h3 id=三个核心选举原则>三个核心选举原则</h3><p>1、集群中只有超过了半数以上的服务器启动，集群才能正常工作</p><p>2、在集群正常工作之前，myid小的服务器会给myid大的服务器进行，持续到集群正常工作，选出leader</p><p>3、选择leader之后，之前的服务器状态由looking改变为following，以后的服务器都是follower</p><p><img src=../imgs/distributed_consistency_211219_9.png alt=distributed_consistency_211219_9.png></p><h3 id=启动过程>启动过程</h3><ul><li>每一个server发出一个投票给集群中其他节点</li><li>收到各个服务器的投票后, 判断该投票有效性, 比如是否是本轮投票（解决活锁问题）, 是否是looking状态</li><li>处理投票, pk别人的投票和自己的投票比较规则xid > myid“取大原则“</li><li>统计是否超过半数的接受相同的选票</li><li>确认leader, 改变服务器状态</li><li>添加新server, leader已经选举出来, 只能以follower身份加入集群中</li></ul><h3 id=崩溃恢复过程>崩溃恢复过程</h3><ul><li>leader挂掉后, 集群中其他follower会将状态从FOLLOWING变为LOOKING, 重新进入leader选举</li><li>同上启动过程</li></ul><h3 id=消息广播算法>消息广播算法</h3><p>一旦进入广播模式, 集群中非leader节点接受到事务请求, 首先会将事务请求转发给服务器, leader服务器为其生成对应的事务提案proposal，并发送给集群中其他节点，如果过半则事务提交；</p><p><img src=../imgs/distributed_consistency_211219_10.png alt=distributed_consistency_211219_10.png></p><ul><li>leader接收到消息后, 消息通过全局唯一的64位自增事务id，zxid标识</li><li>leader发送给follower的提案是有序的, leader会创建一个FIFFO队列, 将提案顺序写入队列中发送给follower</li><li>follower接受到提案后, 会比较提案zxid和本地事务日志最大的zxid, 若提案zxid比本地事务id大（保证全序）, 将提案记录到本地日志中, 反馈ack给leader, 否则拒绝</li><li>leader接收到过半ack后, leader向所有的follower发送commit, 通知每个follower执行本地事务</li></ul><h2 id=zab与paxos比较>ZAB与Paxos比较</h2><p>ZAB和Paxos最大的不同是，<strong>ZAB主要是为分布式主备系统设计的，而Paxos的实现是一致性状态机(state machine replication)</strong></p><p>尽管ZAB不是Paxos的实现，但是ZAB也参考了一些Paxos的一些设计思想，比如：</p><ul><li>leader向follows提出提案(proposal)</li><li>leader 需要在达到法定数量(半数以上)的follows确认之后才会进行commit</li><li>每一个proposal都有一个纪元(epoch)号，类似于Paxos中的选票(ballot)</li></ul><h1 id=reference>Reference</h1><p><a href=https://www.cnblogs.com/raphael5200/p/5285583.html>zookeeper工作原理</a></p><p><a href=https://b23.tv/UpL9jf>Paxos基本入门</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-97c9858c4816a8645713da8d5e786794>4 - Quorum机制</h1><h1 id=简介>简介</h1><p>Quorum（多数派）机制，是一种分布式系统中常用的，用来保证数据冗余和最终一致性的投票算法，其主要数学思想来源于鸽巢原理。</p><p>除了 <strong>Quorum机制</strong> 以外，最简单的机制是采用<strong>主从复制机制</strong>。</p><h1 id=waro机制>WARO机制</h1><p>分布式系统利用多台计算机协同解决单台计算机无法解决的计算存储等问题，但系统运行过程中，网络异常、节点宕机等异常情况的发生几乎是避免不了的。</p><p>为了保证系统正常运行，提供可靠服务，分布式系统对于数据的存储采用了多份数据副本来保证可靠性。副本不仅可以用于备份，还可以提供服务。</p><p>副本的引入带来的问题是怎么保证每个节点的数据一致性。</p><p>最简单的方法就是 WARO（Write All Read Only）机制。WARO是一种简单的副本控制协议。当客户端请求向某副本更新数据时，只有当所有的副本都更新成功之后，这次写操作才算成功，否则视为失败。而读取数据时，只需要查询其中一个副本数据就可以返回。</p><p>WARO机制对于频繁更新数据的系统不够友好，写操作时延现象非常明显，在并发较高或连续执行等场景下效率更低。可以看出写服务和读服务承受的压力不均衡， WARO牺牲了写服务的可用性，最大程度地增强了读服务的可用性。而 Quorum 就是写服务和读服务之间进行一个折中。</p><h1 id=quorum机制>Quorum机制</h1><h2 id=介绍>介绍</h2><p>分布式系统中的每一份数据拷贝对象都被赋予一票。每一个读操作获得的票数必须大于最小读票数（read quorum）（Vr），每个写操作获得的票数必须大于最小写票数（write quorum）(Vw）才能读或者写。如果系统有V票（意味着一个数据对象有V份冗余拷贝），那么最小读写票数(quorum)应满足如下限制：</p><ol><li>Vr + Vw > V</li><li>Vw > V/2
第一条规则保证了一个数据不会被同时读写。当一个写操作请求过来的时候，它必须要获得Vw个冗余拷贝的许可。而剩下的数量是V-Vw 不够Vr，因此不能再有读请求过来了。同理，当读请求获得了 Vr 个冗余拷贝的许可时，写请求就无法获得许可。</li></ol><p>第二条规则保证了数据的串行化修改。一份数据的冗余拷贝不可能同时被两个写请求修改。</p><h2 id=机制分析>机制分析</h2><p><strong>无法保证强一致性</strong></p><p>强一致性就是：<strong>任何时刻任何用户或节点都可以读到最近一次成功提交的副本数据</strong>。强一致性是程度最高的一致性要求，也是实践中最难实现的。</p><p>读取最新的数据：</p><p>因此当读取数据时，如果读取到数据版本较低不满足要求时，需要继续再去其它节点上读取数据。在已经知道最近成功提交的数据版本号的前提下，最多读 Vr 个副本就可以读到最新数据了。</p><p>如何确定读到最高版本号的数据：继续读副本，直到读到的最高版本号副本出现了 Vw 次。</p><h1 id=heading></h1></div><div class=td-content style=page-break-before:always><h1 id=pg-354a2e6929181b174505bfd39fc0cf3a>5 - Raft-01.基础理论</h1><h1 id=简介>简介</h1><p>Raft 算法可以说是目前最成功的分布式共识算法，包括 TiDB、FaunaDB、Redis 等都使用了这种技术。原因是 Multi-Paxos 没有具体的实现细节，虽然它给了开发者想象空间，但共识算法一般居于核心位置，一旦存在潜在问题必然带给系统灾难性的后果。而 Raft 算法给出了大量的实现细节，且处理方式相比于 Multi-Paxos 有两点优势。</p><h2 id=相关术语>相关术语</h2><table><thead><tr><th style=text-align:left>英文</th><th style=text-align:left>中文</th></tr></thead><tbody><tr><td style=text-align:left>Term</td><td style=text-align:left>选举任期，每次选举之后递增1</td></tr><tr><td style=text-align:left>Vote</td><td style=text-align:left>选举投票(的ID)</td></tr><tr><td style=text-align:left>Entry</td><td style=text-align:left>Raft算法的日志数据条目</td></tr><tr><td style=text-align:left>candidate</td><td style=text-align:left>候选人</td></tr><tr><td style=text-align:left>leader</td><td style=text-align:left>领导者</td></tr><tr><td style=text-align:left>follower</td><td style=text-align:left>跟随者</td></tr><tr><td style=text-align:left>commit</td><td style=text-align:left>提交</td></tr><tr><td style=text-align:left>propose</td><td style=text-align:left>提议</td></tr></tbody></table><h1 id=raft-基本原理>Raft 基本原理</h1><h2 id=对比paxos>对比Paxos</h2><p>Zookeeper的ZAB，Viewstamped Replication（VR），raft，multi-paxos，这些都可以被称之为Leader-based一致性协议。不同的是，multi-paxos leader是作为对经典 paxos 的优化而提出，通过选择一个 proposer 作为 leader 降低多个 proposer 引起冲突的频率，提升性能将一次决议的平均消息代价缩小到最优的两次，实际上就算有多个leader存在，算法还是安全的，只是退化为经典的paxos算法。</p><p>相同点：</p><p>1、Multi-paxos和Raft都用一个数字来标识leader的合法性，multi-paxos中叫proposer-id，Raft叫term</p><p>2、法定数量(半数以上)的follows确认之后才会进行commit</p><p>不同点：</p><p>1、proposer & leader</p><p>Paxos 的 proposer是可以有多个，所以他叫做proposer，而不叫 Leader。Raft协议比Paxos的优点是 容易理解，容易实现。它强化了leader的地位，把整个协议可以清楚的分割成两个部分，并利用日志的连续性做了一些简化：</p><p>（1）Leader在时。由Leader向Follower同步日志</p><p>（2）Leader挂掉了，选一个新Leader，Leader选举算法。</p><p>2、日志的连续性</p><p>Raft协议强调日志的连续性，multi-paxos 则允许日志有空洞。 日志的连续性蕴含了这样一条性质：如果两个不同节点上相同序号的日志，term相同，那么这和这之前的日志必然也相同的。</p><p>Raft 可以看成是 Multi-Paxos 的改进算法。相比而言 Raft 算法给出了大量的实现细节，且处理方式相比于 Multi-Paxos 有两点优势。</p><ol><li>发送的请求的是连续的，也就是说 Raft 的写日志操作必须是连续的；而 Multi-Paxos 可以并发修改日志，这也体现了“Multi”的特点。</li><li>选主必须是最新、最全的日志节点才可以当选，这一点与 ZAB 算法有相同的原则；而 Multi-Paxo 是随机的。因此 Raft 可以看成是简化版本的 Multi-Paxos，正是这个简化，造就了 Raft 的流行。</li></ol><h2 id=定义问题>定义问题</h2><ol><li>输入：输入命令</li><li>输出：所有节点最终处于相同状态</li><li>约束<ol><li>网络不确定性：在非拜占庭情况下（即非受信网络），出现网络 分区/冗余/丢失/乱序 等问题下要保证数据状态正确</li><li>基本可用性：集群中大部分节点能够保持相互通信，集群就应该能够正确响应客户端</li><li>不依赖时序：不依赖物理时钟或极端的消息延迟来保证一致性</li><li>快速响应：对客户端请求的响应不能依赖集群中最慢的节点</li></ol></li></ol><h2 id=拆解问题>拆解问题</h2><p>raft 将一致性问题分解为3个子问题：</p><ol><li>领导者选举</li></ol><blockquote><p>现有领导者失效时，需要选举新的领导者</p></blockquote><ol start=2><li>日志复制</li></ol><blockquote><p>领导者需要通过复制保持所有服务器的日志与自己的同步</p></blockquote><ol start=3><li>安全性</li></ol><blockquote><p>如果其中一个服务器在特定索引上提交了日志条目，那么其它服务器不能在该索引应用不同的日志条目</p></blockquote><h2 id=一个可行解>一个可行解</h2><ol><li>初始化时有一个领导者节点，负责发送日志到其他跟随者，并决定日志的顺序</li><li>当读请求到来时，在任意节点都可以读，而写请求只能重定向到领导者处理</li><li>领导者先写入自身的日志，然后同步给半数以上节点，跟随者成功复制日志，领导者才提交日志</li><li>日志最终由领导者先按顺序应用于状态机，其它跟随者随机应用到状态机</li><li>当领导者崩溃后，其它跟随者通过心跳感知并选举出新的领导者继续集群的正常运转</li><li>当有新的节点加入或退出集群，需要将配置信息同步给整个集群</li></ol><h1 id=raft-选举>Raft 选举</h1><h2 id=状态机>状态机</h2><p>在 raft 算法中，任意时刻每个服务器节点都处于这三个状态之一：</p><ul><li>Follower：追随者</li></ul><blockquote><p>跟随者都是被动的，不会发送任何请求，只是简单的响应来自领导者或候选人的请求</p></blockquote><ul><li>Candidate：候选人</li></ul><blockquote><p>如果跟随者接收不到消息，那么它就会变成候选人并发起一次选举，获得集群中大多数选票的候选人将成为领导者</p></blockquote><ul><li>Leader：领导者</li></ul><blockquote><p>系统中只有一个领导者并且其它节点全部都是跟随者，领导者处理所有的客户端请求（如果一个客户端和跟随者联系，那么跟随者会把请求重定向给领导者）</p></blockquote><p><img src=../imgs/raft_base20220904_1.png alt=raft_base20220904_1.png></p><h2 id=任期>任期</h2><p>Raft 将时间划分为任意长度的任期，每个任期都以一次选举开始。如果一个候选者赢得选举，在剩下的任期时间内都是领导者。每个任期最多有一个领导者（投票出现分歧则没有领导者）。</p><p>任期号单调递增，每个服务器存储当前任期号，并在每次通信中交换该任期编号。</p><p>如果一个服务器的当前任期号小于其他服务器，那么它将把当前任期更新为更大的值。如果候选人或领导者发现其任期已过期，则立即转化为追随者状态。如果服务器接收到带有过期任期号的请求，将拒绝请求。</p><h2 id=leader-选举>Leader 选举</h2><p>领导者定期向跟随者发送心跳来维持自己的 Leader 角色。如果跟随者在一定的时间内没有接收到任何的消息，也就是选举超时，那么它就会认为系统中没有可用的领导者，并且发起选举以选出新的领导者。</p><p>开始一次选举，跟随者先要增加自己的当前任期号并且转换到候选人状态。然后并行地向集群中的其它服务器节点发送请求投票的 RPCs 来给自己投票。</p><p>候选人的选举会有下面三种结果：</p><p>1、候选人自己成为 Leader；</p><p>2、其他服务成为 Leader</p><p>3、候选人没有选出 Leader，可能是多个跟随者同时成为候选人，然后选票被瓜分导致没有候选人能获得最大的票数。</p><p>对于选举过程选票被瓜分的情况，Raft 算法使用随机候选超时时间的方法来确保很少会发生选票瓜分的情况，就算发生也能很快地解决。如下选举的随机算法：</p><ol><li>为了防止选票期初就被瓜分，候选超时时间是从一个固定的区间（如：150-300ms）随机选择；</li><li>这个候选超时时间就是 Follower 要等待成为 Candidate 的时间；</li><li>每个候选人在开始一次选举时会重置一个随机候选的时间，也就是 150-300ms 中的随机值；</li><li>这个时间结束后 Follower 变成 Candidate 开始选举，不同时间苏醒竞争 Leader，苏醒时间早就有竞争优势；</li><li>这样大大减少选票被瓜分的情况，如果选票还是被瓜分就继续从第 1 步开始。</li></ol><h2 id=日志复制>日志复制</h2><p>一旦 Leader 被选举成功，就可以对客户端提供服务。客户端提交的每一条命令都会被顺序记录到 Leader 的命令中，每一条命令都包含 Term 编号和顺序索引，然后向其它节点并行发送 AppendEntries RPC 命令用以复制命令（如果命令丢失会不断重发），当大多数节点复制成功后，Leader 就会提交命令，即执行该命令并且将执行结果返回给客户端，Raft 保证已经提交的命令最终也会被其它节点成功执行。</p><p>具体流程如下：</p><ol><li>所有请求都先经过 Leader，每个请求首先以日志的形式保存在 Leader 中，然后日志的状态是 uncommited 状态；</li><li>Leader 将这些更改的请求发送到 Follower；</li><li>Leader 等待大多数的 Follower 确定提交；</li><li>Leader 在等待大多数的 Follower 确定提交后，commit 这些更改，提交这个信息到自己的状态机中，然后通知客户端更新的结果；</li><li>同时 Leader 会不断的尝试通知 Follower 去存储所有更新的信息。
<img src=../imgs/raft_base20220904_2.png alt=raft_base20220904_2.png></li></ol><p>日志由有序编号（log index）的日志条目组成。每个日志包含它被创建时的任期号（term），和用于状态机执行的命令。如果一个日志条目被复制到大多数服务器上，就被认为可以提交（commit）了。</p><p><img src=../imgs/raft_base20220904_3.png alt=raft_base20220904_3.png></p><p>Raft 日志同步保证如下两点：</p><ul><li>如果不同日志中的两个条目有相同的索引和任期号，则它们所储存的命令是相同的</li><li>如果不同日志中的两个条目有相同的索引和任期号，则它们之前的所有日志条目都是相同的
第一条特性源于Leader在一个 term 内在给定的一个 log index 最多创建一条日志条目，同时该条目在日志中的位置也从来不会改变。</li></ul><p>第二条特性：Raft算法在发送日志复制请求时会携带前置日志的 term 和 logIndex 值（即 prevLogTerm 和 prevLogIndex），只有在 prevLogTerm 和 prevLogIndex 匹配的情况下才能成功响应请求。如果 prevLogTerm 和 prevLogIndex 不匹配，则说明当前节点可能是新加入的、或者之前服从于其它 Leader，亦或当前节点之前是 Leader 节点。为了兑现承诺二，Leader 节点需要与该 Follower 节点向前追溯找到 term 和 logIndex 匹配的那条日志，并使用Leader节点的日志强行覆盖该 Follower 此后的日志数据。</p><h1 id=raft-详细实现>Raft 详细实现</h1><h2 id=数据结构>数据结构</h2><p><img src=../imgs/raft_base20220904_4.png alt=raft_base20220904_4.png></p><h2 id=各类状态>各类状态</h2><h3 id=通用持久性状态>通用持久性状态</h3><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>currentTerm</td><td style=text-align:left>服务器已知最新任期（服务器首次启动时初始化为0，单调递增）</td></tr><tr><td style=text-align:left>votedFor</td><td style=text-align:left>当前任期内收到选票的候选者id，如果没有投给任何候选者则为空</td></tr><tr><td style=text-align:left>log[]</td><td style=text-align:left>日志条目；每个条目包含用于状态机的命令，以及领导者接收到该条目时的任期（第一个索引为1）</td></tr></tbody></table><h3 id=通用易失性状态>通用易失性状态</h3><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>commitIndex</td><td style=text-align:left>已知已提交的最高的日志条目的索引（初始值为0，单调递增）</td></tr><tr><td style=text-align:left>lastApplied</td><td style=text-align:left>已知被应用到状态机的最高的日志条目的索引（初始值为0，单调递增）</td></tr></tbody></table><h3 id=领导者上的易失性状态>领导者上的易失性状态</h3><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>nextIndex[]</td><td style=text-align:left>对于每一台服务器，发送到该服务的下一个日志条目的索引（初始值为领导者最后的日志条目的索引+1）</td></tr><tr><td style=text-align:left>matchIndex[]</td><td style=text-align:left>对于每一台服务器，已知的已经复制到该服务器的最高日志条目的索引（初始值为0，单调递增）</td></tr></tbody></table><h2 id=rpc>RPC</h2><p>候选人发起选举投票RPC到跟随者或候选人</p><p>由领导者发起RPC到跟随者</p><p>a. 日志追加</p><p>b. 心跳通知</p><h3 id=请求投票>请求投票</h3><ol><li>跟随者变更为候选人后</li><li>选举超时后</li></ol><h4 id=请求参数>请求参数</h4><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>term</td><td style=text-align:left>候选人的任期号</td></tr><tr><td style=text-align:left>candidateId</td><td style=text-align:left>请求选票的候选人的id</td></tr><tr><td style=text-align:left>lastLogIndex</td><td style=text-align:left>候选人的最后日志条目的索引值</td></tr><tr><td style=text-align:left>lastLogTerm</td><td style=text-align:left>候选人最后日志条目的任期号</td></tr></tbody></table><h4 id=返回值>返回值</h4><table><thead><tr><th style=text-align:left>返回值</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>term</td><td style=text-align:left>当前任期号，以便于候选人去更新自己的任期号</td></tr><tr><td style=text-align:left>voteGranted</td><td style=text-align:left>候选人赢得了此张选票时为真</td></tr></tbody></table><h3 id=追加日志-心跳-领导者调用>追加日志&心跳（领导者调用）</h3><blockquote><ol><li>客户端发起写命令请求时</li><li>发送心跳时</li><li>日志匹配失败时</li></ol></blockquote><h4 id=请求参数-1>请求参数</h4><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>term</td><td style=text-align:left>当前领导者的任期</td></tr><tr><td style=text-align:left>leaderId</td><td style=text-align:left>领导者ID，因此跟随者可以对客户端进行重定向</td></tr><tr><td style=text-align:left>prevLogIndex</td><td style=text-align:left>紧邻新日志条目之前的那个日志条目的索引</td></tr><tr><td style=text-align:left>prevLogTerm</td><td style=text-align:left>紧邻新日志条目之前的那个日志条目的任期</td></tr><tr><td style=text-align:left>entries[]</td><td style=text-align:left>需要被保存的日志条目（被当做心跳使用时 则日志条目内容为空；为了提高效率可能一次性发送多个）</td></tr><tr><td style=text-align:left>leaderCommit</td><td style=text-align:left>领导者的已知已提交的最高的日志条目的索引</td></tr></tbody></table><h4 id=返回值-1>返回值</h4><table><thead><tr><th style=text-align:left>返回值</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>term</td><td style=text-align:left>当前任期，对于领导者而言会更新自己的任期</td></tr><tr><td style=text-align:left>success</td><td style=text-align:left>结果为真，如果跟随者所含有的条目和prevLogIndex以及prevLogTerm匹配上了</td></tr></tbody></table><h1 id=raft-算法原理与证明>Raft 算法原理与证明</h1><h2 id=基本原则与特性>基本原则与特性</h2><h3 id=选举安全特性>选举安全特性</h3><p>对于一个给定的任期号，最多只会有一个领导人被选举出来</p><blockquote><p>在一个任期内半数以上的票数才能当选，保证每个任期要么0个领导要么1个领导</p></blockquote><p><img src=../imgs/raft_base20220904_5.png alt=raft_base20220904_5.png></p><h3 id=领导人只附加原则>领导人只附加原则</h3><p>领导人绝对不会删除或者覆盖自己的日志，只会增加</p><h3 id=日志匹配原则>日志匹配原则</h3><p>如果两个日志在相同的索引位置的日志条目的任期号相同，那么就认为这个日志从头到这个索引位置之间全部完全相同</p><ol><li>因为 集群在任意时刻最多有一个 leader 存在，leader在一个任期内只会在同一个索引处写入一次日志</li><li>又因为 领导者从来不会删除或者覆盖自己的日志，并且日志一旦写入就不允许修改</li><li>所以 只要任期和索引相同，那么在任何节点上的日志也都相同</li><li>因为跟随者每次只会从与 leader 的 PreLog 匹配出追加日志，如果不匹配则 nextIndex-1 重试</li><li>所以 由递归的性质可知一旦跟随者和 leader 在 PreLog 处匹配，那么之前的所有日志就都是匹配的</li><li>所以 只要把 PreLog 之后的日志全部按此次 Leader 同步 RPC 的日志顺序覆盖即可保证二者的一致性</li></ol><h3 id=领导人完全特性>领导人完全特性</h3><p>如果某个日志条目在某个任期号中已经被提交，那么这个条目必然出现在更大任期号的所有领导者中</p><h3 id=状态机安全特性>状态机安全特性</h3><p>如果一个领导者已经将给定的索引值位置的日志条目应用到状态机中，那么其它任何的服务器在这个索引位置不会应用到一个不同的日志</p><h2 id=安全性>安全性</h2><p>每一任的领导者是否一定会有所有任期内领导者的全部已提交日志？</p><h3 id=选举限制>选举限制</h3><p>选民只会投票给任期比自己大，最后一条日志比自己新（任期大于 或 等于时索引更大）的候选人。</p><p>这个存在一个问题，如下图示：</p><p><img src=../imgs/raft_base20220904_6.png alt=raft_base20220904_6.png></p><ol><li>时刻a，S1 是任期2的领导者并且想部分节点（S1和S2）复制了2号位置的日志条目，然后宕机</li><li>时刻b，S5 获得了 S3、S4（S5 的日志与 S3 和 S4 的一样新，最新的日志的任期号都是1）和自己的选票赢得了选举，成了3号任期的领导者，并且在2号位置上写入了一个任期号为3的日志条目。在新日志条目复制到其他节点之前，S5 宕机了。</li><li>时刻c，S1 重启，并且通过 S2、S3、S4 和自己的选票赢得了选举，成了4号任期的领导人，并且继续向 S3 复制2号位置的日志。此时，任期2的日志条目已经在大多数节点上完成了复制。</li><li>时刻d，S1 发生故障，S5 通过 S2、S3 的选票再次成为领导者（因为 S5 最后一条日制条目的任期号是 3，比 S2、S3、S4 中任意一个节点上日志都更加新些），任期号为5。然后 S5 用自己的本地日志也写了其它节点上的日志</li><li>上面这个例子生动地说明了，即使日志条目被半数以上的节点写盘（复制）了，也并不代表它已经被提交了（commited）到 Raft 集群了——因为一旦某条日志被提交，那么它将永远没法被删除或修改。这个例子同时也说明了，领导人无法单纯地依靠之前任期的日志条目信息判断它的提交状态</li><li>因此针对以上场景，Raft算法对日志提交条件增加了一个额外的限制：要求Leader在当前任期至少有一条日志被提交，即被超过半数的节点写盘。</li><li>正如上图中e描述的那样，S1 作为 Leader，在崩溃之前，将3号位置的日志（任期号为4）在大多数节点上复制了一条日志条目（指的是条目3，term 4），那么即使这时 S1 宕机了，S5 也不可能赢得票。无法赢得选举，这就意味着2号位置的日志条目不会被覆写。
<strong>所以新上任的领导者在接受客户端写入命令之前，需要提交一个 no-op（空命令），携带自己任期号的日志复制到大多数集群节点上才能真正的保证选举限制的成立。</strong></li></ol><h3 id=状态机安全性证明-三段论>状态机安全性证明(三段论)</h3><ol><li>定义 A为上个任期最后一条已提交日志，B为当前任期的 leader</li><li>因为 A必然同步到了集群中的半数以上节点</li><li>又因为 B只有获得集群中半数以上节点的选票后才能成为 leader</li><li>所以 B的选民必然存在拥有A日志的节点</li><li>又因为 选举限制，B成为leader的前提是比给它投票的所有选民都要新</li><li>所以 B的日志中必然要包含A</li><li>又因为 日志完全匹配规则，如果A被包含，那么比A小的所有日志都被B包含</li><li>因为 lastAppied &lt;= commitIndex</li><li>又因为 raft保证已提交日志在所有集群节点上的顺序一致</li><li>所以 应用日志必然在所有节点上顺序一致</li><li>因为 状态机只能按序执行应用日志部分</li><li>得证 状态机在整个集群所有节点上必然 最终一致</li></ol><h3 id=状态机安全性证明-反证法>状态机安全性证明(反证法)</h3><ol><li>当日志条目L被同步给半数以上节点时，leader A会移动 commitIndex 指针提交日志，此时的日志被提交</li><li>当 leader 崩溃后，由一个新节点成为 leader B，假设 leader B 是第一个未包含 leader A 最后已提交日志的领导者</li><li>选举过程中，只有获得半数以上节点认可才能成为 leader，因此至少有一个投票给当前 leader B 的节点中含有已经提交的那条日志L。</li><li>那么根据选举限制，节点只会将选票投给至少与自己一样新的节点<ol><li>节点C作为包含 leader A 最后提交日志条目的投票者，如果 leader B 与节点 C 的最后一条日志的任期号一样大时，节点 C 的条目数一定大于 leader B，因为 leader B 是第一个未包含最后一条 leader A 日志的领导者。这与选举限制相矛盾，节点 C 不会投票给 leader B</li><li>如果 leader B 最后一条日志的任期号大于节点 C 最后一条日志的任期号，那么 leader B 的前任领导中必然包含了 leader A 已经提交的日志（leader B 是第一个不包含 leader A 已提交日志的领导者 这一假设）。根据日志匹配特性 leader B 也必包含 leader A 最后的已提交日志，这与假设矛盾。</li></ol></li><li>所以证明 未来所有的临高这必然包含过去领导者已提交的日志，并且日志匹配原则，所有已提交日志的顺序一定是一致的。</li><li>又因为 任意节点仅会将已提交日志按顺序应用于自身的状态机，更新 lastApplied 指针，因此所有节点的状态机都会最终顺序一致。</li><li>得证 raft 算法能够保证节点之间的协同工作。</li></ol><h3 id=常见问题>常见问题</h3><h4 id=新leader未同步前任committed数据>新Leader未同步前任committed数据</h4><p>问题描述：</p><blockquote><p>Leader 宕机后选出的新 Leader 没有同步前任 committed 数据，新leader节点会强行覆盖集群中其它节点与自己冲突的日志数据。</p></blockquote><p>解决方法：</p><blockquote><p>这种情况 Raft 会对参加选举的节点进行限制，只有包含已经 committed 日志的节点才有机会竞选成功。</p><ol><li>参选节点的 term 值大于等于投票节点的 term 值</li><li>如果 term 值相等，则参选节点的 lastLogIndex 大于等于投票节点的 lastLogIndex 值</li></ol></blockquote><h4 id=leader在将日志复制给follower节点之前宕机>Leader在将日志复制给Follower节点之前宕机</h4><p>如果在复制之前宕机，这时消息处于uncommitted状态，新选出的 Leader 一定不包含这些日志信息，所以新的 Leader 会强制覆盖 Follower 中跟自己冲突的日志，也就是刚刚宕机的Leader，如果变成follower，它未同步的信息会被新的 Leader 覆盖掉。</p><h4 id=leader在将日志复制给follower节点之间宕机>Leader在将日志复制给Follower节点之间宕机</h4><p>在复制的过程中宕机，会有两种情况：</p><ol><li>只有少数的 Follower 被同步到了；</li></ol><blockquote><p>如果只有少数的 Follower 被同步了，新的 Leader 不会包含这些信息，新的 Leader 会覆盖那些已经同步的节点的信息。</p></blockquote><ol start=2><li>大多数的 Follower 被同步到了。</li></ol><blockquote><p>Leader 在复制的过程中宕机，消息肯定没有 commit ，新的 Leader 需要再次尝试将其复制给各个 Follower 节点，并依据自己的复制状态决定是否提交这些日志。</p></blockquote><h4 id=leader在响应客户端之前宕机>Leader在响应客户端之前宕机</h4><p>这种情况根据上面的同步机制可以知道，消息肯定是 committed 状态，新的 Leader 肯定包含这个信息，但是新任 Leader 可能还未被通知该日志已经被提交，不过这个信息在之后一定会被新任 Leader 标记为 committed。</p><p>不过对于客户端可能超时拿不到结果，认为本次消息失败了，客户端需要考虑幂等性。</p><h2 id=时间和可用性>时间和可用性</h2><p>Raft 的要求之一就是安全性不能依赖时间：整个系统不能因为某些事件运行的比预期快一点或者慢一点就产生了错误的结果。但是可用性（系统可以及时的响应客户端）不可避免的要依赖于时间。</p><p>领导人选举是 Raft 中对时间要求最为关键的方面。Raft 可以选举并维持一个稳定的领导人，只要系统满足下面的时间要求：</p><blockquote><p>广播时间（broadcastTime） &lt;&lt; 候选超时时间（electionTimeout） &lt;&lt; 平均故障间隔时间（MTBF）</p></blockquote><h1 id=工程优化>工程优化</h1><h2 id=容错性>容错性</h2><ol><li>领导者崩溃通过选举可以解决，但跟随者与候选人崩溃呢？</li></ol><blockquote><p>基础的 raft 算法，通过无限次幂等的附加复制 rpc 进行重试来解决</p></blockquote><ol start=2><li>当平均故障时间大于信息交换时间，系统将没有一个稳定的领导者，集群无法工作</li></ol><blockquote><p>广播时间 &lt;&lt; 心跳超时时间 &lt;&lt; 平均故障时间</p></blockquote><ol start=3><li>客户端如何连接 raft 的 server 节点？</li></ol><blockquote><p>客户端随机选择一个节点去访问，如果是跟随者，跟随者会把自己知道的领导者告知客户端</p></blockquote><ol start=4><li>领导者提交后返回时崩溃，客户端重试不就导致相同的命令反复执行了吗？</li></ol><blockquote><p>客户端为每次请求标记唯一序列号，服务端在状态中维护客户端最新的序列号标记，进行幂等处理</p></blockquote><ol start=5><li>客户端给领导者 set a=3 并进行了提交，此时客户端如果从一个未被同步的节点读取a读不到写后的值</li></ol><blockquote><p>每个客户端应该维持一个 latestIdx 值，每个节点在接受请求的时候与自己的 lastApplied 值比较，如果这个值大于自己的 lastApplied，则拒绝此次请求，客户端重定向到一个 lastApplied 大于等于自己 latestIdx 的请求，并且每次读取请求都会返回这个节点的 lastApplied 值，客户端将 lastestIdx 更新为此值，保证读取的线性一致。</p></blockquote><ol start=6><li>如果 leader 被孤立，其它跟随者选举出 leader，但是当前 leader 还是向外提供脏数据怎么办？</li></ol><blockquote><p>写入数据由于无法提交，因此会立即失败，但无法防止读到脏数据。
解决办法是：心跳超过半数失败，leader 感知到自己处于少数分区而被孤立进而拒绝提供读写服务</p></blockquote><ol start=7><li>当出现网络分区后，被孤立少数集合的节点无法选举，只会不断地增加自己的任期，分区恢复后由于失联的节点任期更大，会强行更新所有节点的任期，触发一次重新选举，而又因为其日志不够新，被孤立的节点不可能成为新的 leader 。所以其状态机是安全的，只是触发了一次重新选举，使得集群有一定时间的不可用。这是完全可以避免的。</li></ol><blockquote><p>在跟随者成为候选人时，先发送一轮 pre-vote rpc 来判断自己是否在大多数分区内（是否有半数节点回应自己），如果是则任期加 1 进行选举。否则的话就不断尝试 pre-vote 请求。</p></blockquote><h2 id=扩展性>扩展性</h2><ol><li><p>集群的成员发生变化时，存在某一时刻新老配置共存，进而有选举出两个领导者的可能
<img src=../imgs/raft_base20220904_7.png alt=raft_base20220904_7.png></p></li><li><p>新集群节点在配置变更期间必须获得老配置的多数派投票才能成为 leader</p></li><li><p>发送新配置 c-new 给集群的领导者</p></li><li><p>领导者将自己的 c-old 配置与 c-new 合并为一个 c-old-new 配置【123-45】</p></li><li><p>然后下发给其他所有跟随者</p><ol><li>当 c-old-new 被同步给半数以上节点后，那么此配置已经提交，遵循 raft 安全性机制</li><li>当 leader 在将 c-old-new 写入半数以上跟随者之前崩溃了，那么选举出来的新 leader 会退回到老的配置，此时重试更新配置即可</li></ol></li><li><p>当 c-old-new 被提交之后，leader 会真正的提交 c-new 配置</p><ol><li>如果提交给了半数节点，则 c-new 真正地被提交</li><li>如果未提交给半数节点时崩溃，则新选举的 leader 必定包含已提交的 c-old-new 那么接着更新配置即可
<strong>集群变更过于复杂，因此可以简化这一过程，使用单节点变更机制，即每一次只添加或删除一个节点</strong></li></ol></li></ol><p><img src=../imgs/raft_base20220904_8.png alt=raft_base20220904_8.png></p><ol><li>单节点变更时，如果 leader 挂了造成一致性问题（丢失已提交日志）如何处理？</li></ol><blockquote><p>新 leader 先发一条 no-op 日志再开始配置变更
可参考：<a href=https://zhuanlan.zhihu.com/p/359206808>Raft成员变更的工程实践</a></p></blockquote><ol start=2><li>单节点变更时偶数节点遇到网络分区，则没有办法选举 leader 了怎么办？</li></ol><blockquote><p>重新定义偶数节点情况下的 法定人数模型下的大多数情况(n/2 或 n/2-1)
可参考：
<a href=https://blog.openacid.com/distributed/raft-bug/>TiDB 在 Raft 成员变更上踩的坑</a>
<a href=https://blog.openacid.com/algo/quorum/>后分布式时代: 多数派读写的’少数派’实现</a></p></blockquote><ol start=3><li>新的服务器没有存储任何日志，领导要复制很长一段时间，此时不能参加选举否则会使得整体不可用</li></ol><blockquote><p>新加入的节点设置一个保护期，再次保护期内不会参加选举与日志提交决策，只用来同步日志</p></blockquote><ol start=4><li>如果集群的领导不是新集群中的一员，该如何处理？</li></ol><blockquote><p>在提交 c-new 时，不将自己算作半数提交，并且在提交后要主动退位</p></blockquote><ol start=5><li>被移除的节点如果不及时关闭，会导致选举超时后强行发起投票请求干扰在线集群</li></ol><blockquote><p>每个节点如果未达到最小心跳时间，则不会进行投票</p></blockquote><h2 id=性能提升>性能提升</h2><ol><li>生成快照
1）日志如果无线增长会将本地磁盘打满，会造成可用性问题</li></ol><blockquote><p>定期地将状态机中的状态生成快照，而将之前的日志全部删除，是一种常见的压缩方式</p><ol><li>将节点的状态保存为 LSM Tree，然后存储最后应用日志的索引与任期，以保证日志匹配特性</li><li>为支持集群的配置更新，快照中也要将最后应用的集群配置也当做状态保存下来</li><li>当跟随者需要的日志已经在领导者上面被删除时（netxtIndex--），需要将快照通过RPC发送过去</li></ol><blockquote><p>注意：由领导人调用以将快照的分块发送给跟随者。领导者总是按顺序发送分块。</p></blockquote></blockquote><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>term</td><td style=text-align:left>领导人的任期号</td></tr><tr><td style=text-align:left>leaderId</td><td style=text-align:left>领导人的Id，以便于跟随者重定向请求</td></tr><tr><td style=text-align:left>lastIncludedIndex</td><td style=text-align:left>快照中包含的最后日志条目的索引值</td></tr><tr><td style=text-align:left>lastincludedTerm</td><td style=text-align:left>快照中包含的最后日志条目的任期号</td></tr><tr><td style=text-align:left>offset</td><td style=text-align:left>分块在快照中的字节偏移量</td></tr><tr><td style=text-align:left>data[]</td><td style=text-align:left>从偏移量开始的快照分块的原始字节</td></tr><tr><td style=text-align:left>done</td><td style=text-align:left>如果这时最后一个分块则为 true</td></tr></tbody></table><table><thead><tr><th style=text-align:left>结果</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>term</td><td style=text-align:left>当前任期号（currentTerm），便于领导人更新自己</td></tr></tbody></table><p>2）快照何时创建？过于频繁会浪费性能，过于低频日志占用磁盘的量更大，重建时间更长。</p><blockquote><p>限定日志文件大小到达某一个阈值后立刻生成快照</p></blockquote><p>3）写入快照花费的时间昂贵如何处理？如何保证不影响节点的正常工作？</p><blockquote><p>使用写时复制技术，状态机的函数式顺序性天然支持</p></blockquote><ol start=2><li>调节参数</li></ol><blockquote><ol><li>心跳的随机时间，过快会增加网络负载，过慢则会导致告知领导者崩溃的时间更长</li><li>选举的随机事件，如果大部分跟随者同时变为候选人则会导致选票被瓜分</li></ol></blockquote><ol start=3><li>流批组合</li></ol><blockquote><p>首先可以做的就是 batch，很多情况下 batch 可以明显提升性能，譬如对于 RocksDB 的写入来说，通过不会每次写入一个值，而是会用一个 WriteBatch 缓存一批修改，然后再整个写入。对于 Raft 来说，Leader 可以一次收集多个 requests，然后一批发送给 Follower。当然需要有一个最大发送 size 来限制每次最多可以发送数据</p><blockquote><p>如果只是用 batch，Leader 还是需要等待 Follower 返回才能继续后面的流程，这里还可以使用 Pipeline 来进行加速。大家知道，Leader 会维护一个 NextIndex 的变量来表示下一个给 Follower 发送的 log 位置，通常情况下只要 Leader 跟 Follower 建立起了连接，都会认为网络是稳定互通的。所以只要当 Leader 给 Follower 发送了一批 log 后，可以直接更新 NextIndex，并且立刻发送后面的 log，不需要等待 Follower 的返回。如果网络出现了错误，或者 Follower 返回一些错误，Leader 就需要重新调整 NextIndex，然后重新发送 log 了。</p></blockquote></blockquote><ol start=4><li>并行追加</li></ol><blockquote><p>对于上面提到的一次 request 简易 Raft 流程来说，Leader 可以先并行地将 log 发送给 Followers，然后再将 log append。这么做的原因主要是因为在 Raft 里面，如果一个 log 被大多数的节点 append，我们就可以认为这个 log 是被 committed 了，所以即使 Leader 再给 Follower 发送 log 之后，自己 append log 失败 panic 了，只要 N/2+1 个 Follower 能接收都这个 log 并成功 append，仍然认为这个 log 是被 commited 了，被 commited 的 log 后续就一定能被成功 apply。</p><blockquote><p>这么做的原因主要是因为 append log 会涉及到落盘，有开销，所以完全可以在 Leader 落盘的同时让 Follower 也尽快地收到 log 并 append
这里还需要注意，虽然 Leader 能在 append log 之前给 Follower 发 log，但是 Follower 却不能在 append log 之前告诉 Leader 已经成功 append 这个 log。如果 Follower 提前告诉 Leader 说已经成功 append，但实际后面 append log 时失败了，Leader 仍然会认为这个 log 是被 committed 了，这样系统就有丢失数据的风险了。</p></blockquote></blockquote><ol start=5><li>异步应用</li></ol><blockquote><p>上面提到，当一个 log 被大部分节点 append 后，就可以认为这个 log 被 committed 了，被 committed 的 log 在什么时候被 apply 都不会再影响数据的一致性。所以当一个 log 被 committed 之后，可以用另一个线程去异步地 apply 这个 log。
所以整个 Raft 流程就可以变成：</p><ol><li>Leader 接收一个 client 发送的 request</li><li>Leader 将对应的 log 发送给其他 follower 并本地 append</li><li>Leader 继续接受其他 client 的 requests，持续进行步骤2</li><li>Leader 发现 log 已经被 committed，在另外一个线程 apply</li><li>Leader 异步 apply log 之后，返回结果给对应的 client
使用 asychronous apply 的好处在于现在可以完全地并行处理 append log 和 apply log，虽然对于一个 client 来说，它的一次 request 仍然要走完完整的 Raft 流程，但对于多个 clients 来说，整体的并发和吞吐量是提升了。</li></ol></blockquote><h1 id=reference>Reference</h1><p><a href=https://raft.github.io/>Raft 官网</a></p><p><a href=http://thesecretlivesofdata.com/raft/#election>Raft 算法动画演示</a></p><p><a href=https://ongardie.github.io/raft-talk-archive/2015/buildstuff/raftscope-replay/>Raft 算法演示</a></p><p><a href=https://www.cnblogs.com/ricklz/p/15094389.html>etcd学习(5)-etcd的Raft一致性算法原理</a></p><p><a href=https://pingcap.com/zh/blog/optimizing-raft-in-tikv>TiKV 功能介绍 - Raft 的优化</a></p><p><a href=https://blog.openacid.com/distributed/raft-bug/>TiDB 在 Raft 成员变更上踩的坑</a></p><p><a href=https://www.codedump.info/post/20180921-raft/>Raft算法原理</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c47657362d3648a3025539f23e067ed6>6 - Raft-02.raftexample源码分析</h1><h1 id=前言>前言</h1><p>本文源码分析代码参考 etcd v3.5.0 中 raft 代码：</p><p><a href=https://github.com/etcd-io/etcd/tree/v3.5.0/contrib/raftexample>https://github.com/etcd-io/etcd/tree/v3.5.0/contrib/raftexample</a></p><p>Etcd 将 raft 协议实现为一个 library，然后本身作为一个应用使用它。此外，etcd 还提供了一个叫 raftexample 的示例程序。</p><p>在 etcd 中，raft 作为底层的共识模块，运行在一个 goroutine 里，通过 channel 接受上层（etcdserver）的消息，并将处理结果通过另一个 channel 返回给上层应用，交互过程大致如下：</p><p><img src=../imgs/raft_sourcecode20220904_1.png alt=raft_sourcecode20220904_1.png></p><p>这种全异步地交互方式好处是提高了性能，坏处是难以测试，增加代码阅读难度。</p><h1 id=基本概念>基本概念</h1><p>源码中定义的一些变量概念</p><ul><li><p>Node: 对 etcd-raft 模块具体实现的一层封装，方便上层模块使用 etcd-raft 模块；</p></li><li><p>上层模块: etcd-raft 的调用者，上层模块通过Node提供的API与底层的 etcd-raft 模块进行交互；</p></li><li><p>Cluster: 表示一个集群,其中记录了该集群的基础信息；</p></li><li><p>Member: 组层Cluster的元素之一，其中封装了一个节点的基本信息；</p></li><li><p>Peer: 集群中某个节点对集群中另一个节点的称呼；</p></li><li><p>Entry记录: 节点之间的传递是通过 message 进行的，每条消息中可以携带多条 Entry 记录,每条Entry对应一条一个独立的操作<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>type</span> <span style=color:#000>Entry</span> <span style=color:#a90d91>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// Term：表示该Entry所在的任期。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Term</span>  <span style=color:#a90d91>uint64</span>    <span style=color:#c41a16>`protobuf:&#34;varint,2,opt,name=Term&#34; json:&#34;Term&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// Index:当前这个entry在整个raft日志中的位置索引,有了Term和Index之后，一个`log entry`就能被唯一标识。  
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Index</span> <span style=color:#a90d91>uint64</span>    <span style=color:#c41a16>`protobuf:&#34;varint,3,opt,name=Index&#34; json:&#34;Index&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 当前entry的类型
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// 目前etcd支持两种类型：EntryNormal和EntryConfChange 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// EntryNormaln表示普通的数据操作
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// EntryConfChange表示集群的变更操作
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Type</span>  <span style=color:#000>EntryType</span> <span style=color:#c41a16>`protobuf:&#34;varint,1,opt,name=Type,enum=raftpb.EntryType&#34; json:&#34;Type&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 序列化后的具体操作数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Data</span>  []<span style=color:#a90d91>byte</span>    <span style=color:#c41a16>`protobuf:&#34;bytes,4,opt,name=Data&#34; json:&#34;Data,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p></li><li><p>Message: 是所有消息的抽象，包括各种消息所需要的字段，raft集群中各个节点之前的通讯都是通过这个message进行的。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>type</span> <span style=color:#000>Message</span> <span style=color:#a90d91>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// 该字段定义了不同的消息类型，etcd-raft就是通过不同的消息类型来进行处理的，etcd中一共定义了19种类型
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Type</span> <span style=color:#000>MessageType</span> <span style=color:#c41a16>`protobuf:&#34;varint,1,opt,name=type,enum=raftpb.MessageType&#34; json:&#34;type&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 消息的目标节点 ID，在急群中每个节点都有一个唯一的id作为标识
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>To</span>   <span style=color:#a90d91>uint64</span>      <span style=color:#c41a16>`protobuf:&#34;varint,2,opt,name=to&#34; json:&#34;to&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 发送消息的节点ID
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>From</span> <span style=color:#a90d91>uint64</span>      <span style=color:#c41a16>`protobuf:&#34;varint,3,opt,name=from&#34; json:&#34;from&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 整个消息发出去时，所处的任期
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Term</span> <span style=color:#a90d91>uint64</span>      <span style=color:#c41a16>`protobuf:&#34;varint,4,opt,name=term&#34; json:&#34;term&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 该消息携带的第一条Entry记录的的Term值
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>LogTerm</span>    <span style=color:#a90d91>uint64</span>   <span style=color:#c41a16>`protobuf:&#34;varint,5,opt,name=logTerm&#34; json:&#34;logTerm&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 索引值，该索引值和消息的类型有关,不同的消息类型代表的含义不同
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Index</span>      <span style=color:#a90d91>uint64</span>   <span style=color:#c41a16>`protobuf:&#34;varint,6,opt,name=index&#34; json:&#34;index&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 需要存储的日志信息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Entries</span>    []<span style=color:#000>Entry</span>  <span style=color:#c41a16>`protobuf:&#34;bytes,7,rep,name=entries&#34; json:&#34;entries&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 已经提交的日志的索引值，用来向别人同步日志的提交信息。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Commit</span>     <span style=color:#a90d91>uint64</span>   <span style=color:#c41a16>`protobuf:&#34;varint,8,opt,name=commit&#34; json:&#34;commit&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 在传输快照时，该字段保存了快照数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Snapshot</span>   <span style=color:#000>Snapshot</span> <span style=color:#c41a16>`protobuf:&#34;bytes,9,opt,name=snapshot&#34; json:&#34;snapshot&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 主要用于响应类型的消息，表示是否拒绝收到的消息。  
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Reject</span>     <span style=color:#a90d91>bool</span>     <span style=color:#c41a16>`protobuf:&#34;varint,10,opt,name=reject&#34; json:&#34;reject&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// Follower 节点拒绝 eader 节点的消息之后，会在该字段记录 一个Entry索引值供Leader节点。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>RejectHint</span> <span style=color:#a90d91>uint64</span>   <span style=color:#c41a16>`protobuf:&#34;varint,11,opt,name=rejectHint&#34; json:&#34;rejectHint&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 携带的一些上下文的信息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>Context</span>    []<span style=color:#a90d91>byte</span>   <span style=color:#c41a16>`protobuf:&#34;bytes,12,opt,name=context&#34; json:&#34;context,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p></li><li><p>raftLog: Raft中日志同步的核心就是集群中leader如何同步日志到各个follower。日志的管理是在raftLog结构上完成的。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>type</span> <span style=color:#000>raftLog</span> <span style=color:#a90d91>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// 用于保存自从最后一次snapshot之后提交的数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>storage</span> <span style=color:#000>Storage</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 用于保存还没有持久化的数据和快照，这些数据最终都会保存到storage中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>unstable</span> <span style=color:#000>unstable</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 当天提交的日志数据索引
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>committed</span> <span style=color:#a90d91>uint64</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// committed保存是写入持久化存储中的最高index，而applied保存的是传入状态机中的最高index
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// 即一条日志首先要提交成功（即committed），才能被applied到状态机中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// 因此以下不等式一直成立：applied &lt;= committed
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>applied</span> <span style=color:#a90d91>uint64</span>
</span></span><span style=display:flex><span>	<span style=color:#000>logger</span> <span style=color:#000>Logger</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 调用 nextEnts 时，返回的日志项集合的最大的大小
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// nextEnts 函数返回应用程序已经可以应用到状态机的日志项集合
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>maxNextEntsSize</span> <span style=color:#a90d91>uint64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p></li></ul><h1 id=raftexample>raftexample</h1><h2 id=简介>简介</h2><p>raftexample 是一个 etcd raft library 的使用示例。它为Raft一致性算法的键值对集群存储提供了一个简单的 REST API。</p><h2 id=总体架构图>总体架构图</h2><p><img src=../imgs/raft_sourcecode20220904_2.png alt=raft_sourcecode20220904_2.png></p><h2 id=启动>启动</h2><p>该包提供了goreman启动集群的方式，按照 README 使用 goreman start 启动，可以很清楚的看到 raft 在启动过程中的选举过程，能够很好的帮助理解 raft 的选举过程。</p><p>程序入口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>contrib</span><span style=color:#000>/</span><span style=color:#000>raftexample</span><span style=color:#000>/</span><span style=color:#000>main</span>.<span style=color:#a90d91>go</span>:<span style=color:#1c01ce>24</span>
</span></span></code></pre></td></tr></table></div></div></div><p>下面介绍主要的函数</p><h2 id=newraftnode>newRaftNode</h2><p>在该函数中主要完成了 raftNode 的初始化 。在该方法中会使用上层模块传入的配置信息（其中包括 proposeC 通道和 confChangeC 通道）来创建raftNode实例，同时会创建 commitC 通道和 errorC 通道返回给上层模块使用 。这样上层模块就可以通过这几个通道与 rafeNode 实例进行交互。另外，newRaftNode() 函数中还会启动一个独立的后台 goroutine 来完成回放 WAL 日志、 启动网络组件等初始化操作。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#177500>// contrib/raftexample/raft.go:87
</span></span></span><span style=display:flex><span><span style=color:#177500>// raftNode 初始化
</span></span></span><span style=display:flex><span><span style=color:#177500>// 使用上层模块传入的配置信息来创建 raftNode 实例，
</span></span></span><span style=display:flex><span><span style=color:#177500>// 同时创建 commitC 通道和 errorC 通道返回给上层模块使用
</span></span></span><span style=display:flex><span><span style=color:#177500>// 上层应用通过这几个 channel 就能和 raftNode 进行交互
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> <span style=color:#000>newRaftNode</span>(<span style=color:#000>id</span> <span style=color:#a90d91>int</span>, <span style=color:#000>peers</span> []<span style=color:#a90d91>string</span>, <span style=color:#000>join</span> <span style=color:#a90d91>bool</span>, <span style=color:#000>getSnapshot</span> <span style=color:#a90d91>func</span>() ([]<span style=color:#a90d91>byte</span>, <span style=color:#a90d91>error</span>), <span style=color:#000>proposeC</span> <span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#a90d91>string</span>,
</span></span><span style=display:flex><span>   <span style=color:#000>confChangeC</span> <span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#000>raftpb</span>.<span style=color:#000>ConfChange</span>) (<span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#000>*</span><span style=color:#000>commit</span>, <span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#a90d91>error</span>, <span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#000>*</span><span style=color:#000>snap</span>.<span style=color:#000>Snapshotter</span>) {
</span></span><span style=display:flex><span>   <span style=color:#177500>// channel，主要传输 Entry 记录
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// raftNode 会将 etcd-raft 模块返回的待应用 Entry 记录（封装在Ready实例中〉写入commitC通道，
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 另一方面，kvstore 会从 commitC 通道中读取这些待应用的 Entry 记录井保存其中的键值对信息。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>commitC</span> <span style=color:#000>:=</span> <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#000>*</span><span style=color:#000>commit</span>)
</span></span><span style=display:flex><span>   <span style=color:#000>errorC</span> <span style=color:#000>:=</span> <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#a90d91>error</span>)
</span></span><span style=display:flex><span>   <span style=color:#000>rc</span> <span style=color:#000>:=</span> <span style=color:#000>&amp;</span><span style=color:#000>raftNode</span>{
</span></span><span style=display:flex><span>      <span style=color:#000>proposeC</span>:    <span style=color:#000>proposeC</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>confChangeC</span>: <span style=color:#000>confChangeC</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>commitC</span>:     <span style=color:#000>commitC</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>errorC</span>:      <span style=color:#000>errorC</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>id</span>:          <span style=color:#000>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>peers</span>:       <span style=color:#000>peers</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>join</span>:        <span style=color:#000>join</span>,
</span></span><span style=display:flex><span>      <span style=color:#177500>// 初始化存放 WAL 日志和 Snapshot 文件的的目录
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>waldir</span>:      <span style=color:#000>fmt</span>.<span style=color:#000>Sprintf</span>(<span style=color:#c41a16>&#34;raftexample-%d&#34;</span>, <span style=color:#000>id</span>),
</span></span><span style=display:flex><span>      <span style=color:#000>snapdir</span>:     <span style=color:#000>fmt</span>.<span style=color:#000>Sprintf</span>(<span style=color:#c41a16>&#34;raftexample-%d-snap&#34;</span>, <span style=color:#000>id</span>),
</span></span><span style=display:flex><span>      <span style=color:#000>getSnapshot</span>: <span style=color:#000>getSnapshot</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>snapCount</span>:   <span style=color:#000>defaultSnapshotCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>stopc</span>:       <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#a90d91>struct</span>{}),
</span></span><span style=display:flex><span>      <span style=color:#000>httpstopc</span>:   <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#a90d91>struct</span>{}),
</span></span><span style=display:flex><span>      <span style=color:#000>httpdonec</span>:   <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#a90d91>struct</span>{}),
</span></span><span style=display:flex><span>      <span style=color:#000>logger</span>: <span style=color:#000>zap</span>.<span style=color:#000>NewExample</span>(),
</span></span><span style=display:flex><span>      <span style=color:#000>snapshotterReady</span>: <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#000>*</span><span style=color:#000>snap</span>.<span style=color:#000>Snapshotter</span>, <span style=color:#1c01ce>1</span>),
</span></span><span style=display:flex><span>      <span style=color:#177500>// rest of structure populated after WAL replay
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 启动一个goroutine，完成剩余的初始化工作
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>go</span> <span style=color:#000>rc</span>.<span style=color:#000>startRaft</span>()
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#000>commitC</span>, <span style=color:#000>errorC</span>, <span style=color:#000>rc</span>.<span style=color:#000>snapshotterReady</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=startraft>startRaft</h2><ol><li>创建 Snapshotter，并将该 Snapshotter 实例返回给上层模块；</li><li>创建 WAL 实例，然后加载快照并回放 WAL 日志；</li><li>创建 raft.Config 实例，其中包含了启动 etcd-raft 模块的所有配置；</li><li>初始化底层 etcd-raft 模块，得到 node 实例；</li><li>创建 Transport 实例，该实例负责集群中各个节点之间的网络通信，其具体实现在 raft-http 包中；</li><li>建立与集群中其他节点的网络连接；</li><li>启动网络组件，其中会监听当前节点与集群中其他节点之间的网络连接，并进行节点之间的消息读写；</li><li>启动两个后台的 goroutine，它们主要工作是处理上层模块与底层 etcd-raft 模块的交互，但处理的具体内容不同，后面会详细介绍这两个 goroutine 的处理流程。</li></ol><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>rc</span> <span style=color:#000>*</span><span style=color:#000>raftNode</span>) <span style=color:#000>startRaft</span>() {
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> !<span style=color:#000>fileutil</span>.<span style=color:#000>Exist</span>(<span style=color:#000>rc</span>.<span style=color:#000>snapdir</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>os</span>.<span style=color:#000>Mkdir</span>(<span style=color:#000>rc</span>.<span style=color:#000>snapdir</span>, <span style=color:#1c01ce>0750</span>); <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>         <span style=color:#000>log</span>.<span style=color:#000>Fatalf</span>(<span style=color:#c41a16>&#34;raftexample: cannot create dir for snapshot (%v)&#34;</span>, <span style=color:#000>err</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#000>rc</span>.<span style=color:#000>snapshotter</span> = <span style=color:#000>snap</span>.<span style=color:#000>New</span>(<span style=color:#000>zap</span>.<span style=color:#000>NewExample</span>(), <span style=color:#000>rc</span>.<span style=color:#000>snapdir</span>)
</span></span><span style=display:flex><span>   <span style=color:#177500>// 创建 WAL 实例，然后加载快照并回放 WAL 日志
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>oldwal</span> <span style=color:#000>:=</span> <span style=color:#000>wal</span>.<span style=color:#000>Exist</span>(<span style=color:#000>rc</span>.<span style=color:#000>waldir</span>)
</span></span><span style=display:flex><span>   <span style=color:#177500>// replayWAL() 方法首先会读取快照数据，
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 在快照数据中记录了该快照包含的最后一条 Entry 记录的 Term 值 和 索引值。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// 然后根据 Term 值 和 索引值确定读取 WAL 日志文件的位置，读取日志记录。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>rc</span>.<span style=color:#000>wal</span> = <span style=color:#000>rc</span>.<span style=color:#000>replayWAL</span>()
</span></span><span style=display:flex><span>   <span style=color:#177500>// signal replay has finished
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>rc</span>.<span style=color:#000>snapshotterReady</span> <span style=color:#000>&lt;-</span> <span style=color:#000>rc</span>.<span style=color:#000>snapshotter</span>
</span></span><span style=display:flex><span>   <span style=color:#000>rpeers</span> <span style=color:#000>:=</span> <span style=color:#a90d91>make</span>([]<span style=color:#000>raft</span>.<span style=color:#000>Peer</span>, <span style=color:#a90d91>len</span>(<span style=color:#000>rc</span>.<span style=color:#000>peers</span>))
</span></span><span style=display:flex><span>   <span style=color:#a90d91>for</span> <span style=color:#000>i</span> <span style=color:#000>:=</span> <span style=color:#a90d91>range</span> <span style=color:#000>rpeers</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>rpeers</span>[<span style=color:#000>i</span>] = <span style=color:#000>raft</span>.<span style=color:#000>Peer</span>{<span style=color:#000>ID</span>: <span style=color:#a90d91>uint64</span>(<span style=color:#000>i</span> <span style=color:#000>+</span> <span style=color:#1c01ce>1</span>)}
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 创建 raft.Config 实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>c</span> <span style=color:#000>:=</span> <span style=color:#000>&amp;</span><span style=color:#000>raft</span>.<span style=color:#000>Config</span>{
</span></span><span style=display:flex><span>      <span style=color:#000>ID</span>:                        <span style=color:#a90d91>uint64</span>(<span style=color:#000>rc</span>.<span style=color:#000>id</span>),
</span></span><span style=display:flex><span>      <span style=color:#177500>// 选举超时
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>ElectionTick</span>:              <span style=color:#1c01ce>10</span>,
</span></span><span style=display:flex><span>      <span style=color:#177500>// 心跳超时
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>HeartbeatTick</span>:             <span style=color:#1c01ce>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>Storage</span>:                   <span style=color:#000>rc</span>.<span style=color:#000>raftStorage</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>MaxSizePerMsg</span>:             <span style=color:#1c01ce>1024</span> <span style=color:#000>*</span> <span style=color:#1c01ce>1024</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>MaxInflightMsgs</span>:           <span style=color:#1c01ce>256</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>MaxUncommittedEntriesSize</span>: <span style=color:#1c01ce>1</span> <span style=color:#000>&lt;&lt;</span> <span style=color:#1c01ce>30</span>,
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 初始化底层的 etcd-raft 模块，根据 WAL 日志回放情况判断首次启动还是重新启动
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>oldwal</span> <span style=color:#000>||</span> <span style=color:#000>rc</span>.<span style=color:#000>join</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>rc</span>.<span style=color:#000>node</span> = <span style=color:#000>raft</span>.<span style=color:#000>RestartNode</span>(<span style=color:#000>c</span>)
</span></span><span style=display:flex><span>   } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#177500>// 首次启动 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>rc</span>.<span style=color:#000>node</span> = <span style=color:#000>raft</span>.<span style=color:#000>StartNode</span>(<span style=color:#000>c</span>, <span style=color:#000>rpeers</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 创建 Transport 实例并启动，其负责 raft 节点之间的网络通信服务
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>rc</span>.<span style=color:#000>transport</span> = <span style=color:#000>&amp;</span><span style=color:#000>rafthttp</span>.<span style=color:#000>Transport</span>{
</span></span><span style=display:flex><span>      <span style=color:#000>Logger</span>:      <span style=color:#000>rc</span>.<span style=color:#000>logger</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>ID</span>:          <span style=color:#000>types</span>.<span style=color:#000>ID</span>(<span style=color:#000>rc</span>.<span style=color:#000>id</span>),
</span></span><span style=display:flex><span>      <span style=color:#000>ClusterID</span>:   <span style=color:#1c01ce>0x1000</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>Raft</span>:        <span style=color:#000>rc</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>ServerStats</span>: <span style=color:#000>stats</span>.<span style=color:#000>NewServerStats</span>(<span style=color:#c41a16>&#34;&#34;</span>, <span style=color:#c41a16>&#34;&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#000>LeaderStats</span>: <span style=color:#000>stats</span>.<span style=color:#000>NewLeaderStats</span>(<span style=color:#000>zap</span>.<span style=color:#000>NewExample</span>(), <span style=color:#000>strconv</span>.<span style=color:#000>Itoa</span>(<span style=color:#000>rc</span>.<span style=color:#000>id</span>)),
</span></span><span style=display:flex><span>      <span style=color:#000>ErrorC</span>:      <span style=color:#a90d91>make</span>(<span style=color:#a90d91>chan</span> <span style=color:#a90d91>error</span>),
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 启动网络服务相关组件
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>rc</span>.<span style=color:#000>transport</span>.<span style=color:#000>Start</span>()
</span></span><span style=display:flex><span>   <span style=color:#177500>// 建立与集群中其它节点的连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>for</span> <span style=color:#000>i</span> <span style=color:#000>:=</span> <span style=color:#a90d91>range</span> <span style=color:#000>rc</span>.<span style=color:#000>peers</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>i</span><span style=color:#000>+</span><span style=color:#1c01ce>1</span> <span style=color:#000>!=</span> <span style=color:#000>rc</span>.<span style=color:#000>id</span> {
</span></span><span style=display:flex><span>         <span style=color:#000>rc</span>.<span style=color:#000>transport</span>.<span style=color:#000>AddPeer</span>(<span style=color:#000>types</span>.<span style=color:#000>ID</span>(<span style=color:#000>i</span><span style=color:#000>+</span><span style=color:#1c01ce>1</span>), []<span style=color:#a90d91>string</span>{<span style=color:#000>rc</span>.<span style=color:#000>peers</span>[<span style=color:#000>i</span>]})
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 启动协程，监听当前节点与集群中其他节点之间的网络连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>go</span> <span style=color:#000>rc</span>.<span style=color:#000>serveRaft</span>()
</span></span><span style=display:flex><span>   <span style=color:#177500>// 启动后台协程，处理上层应用与底层 etcd-raft 模块的交互
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>go</span> <span style=color:#000>rc</span>.<span style=color:#000>serveChannels</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=servechannels>serveChannels</h2><p>用于处理上次应用于底层 etcd-raft 模块的交互</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#177500>// 单独启动一个后台协程负责上层模块传递给 etcd-raft 模块的数据
</span></span></span><span style=display:flex><span><span style=color:#177500>// 主要是 proposeC、confChangeC 两个通道
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>rc</span> <span style=color:#000>*</span><span style=color:#000>raftNode</span>) <span style=color:#000>serveChannels</span>() {
</span></span><span style=display:flex><span>   <span style=color:#177500>// 获取快照数据和快照元数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>snap</span>, <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>rc</span>.<span style=color:#000>raftStorage</span>.<span style=color:#000>Snapshot</span>()
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>panic</span>(<span style=color:#000>err</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#000>rc</span>.<span style=color:#000>confState</span> = <span style=color:#000>snap</span>.<span style=color:#000>Metadata</span>.<span style=color:#000>ConfState</span>
</span></span><span style=display:flex><span>   <span style=color:#000>rc</span>.<span style=color:#000>snapshotIndex</span> = <span style=color:#000>snap</span>.<span style=color:#000>Metadata</span>.<span style=color:#000>Index</span>
</span></span><span style=display:flex><span>   <span style=color:#000>rc</span>.<span style=color:#000>appliedIndex</span> = <span style=color:#000>snap</span>.<span style=color:#000>Metadata</span>.<span style=color:#000>Index</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>defer</span> <span style=color:#000>rc</span>.<span style=color:#000>wal</span>.<span style=color:#000>Close</span>()
</span></span><span style=display:flex><span>   <span style=color:#177500>// 定时器，推进逻辑时钟。100ms 是 etcd-raft 组件的最小时间单位
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>ticker</span> <span style=color:#000>:=</span> <span style=color:#000>time</span>.<span style=color:#000>NewTicker</span>(<span style=color:#1c01ce>100</span> <span style=color:#000>*</span> <span style=color:#000>time</span>.<span style=color:#000>Millisecond</span>)
</span></span><span style=display:flex><span>   <span style=color:#a90d91>defer</span> <span style=color:#000>ticker</span>.<span style=color:#000>Stop</span>()
</span></span><span style=display:flex><span>   <span style=color:#177500>// 单独的协程负责接收 proposeC、confChangeC 的数据传递给 etcd-raft 组件处理 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// send proposals over raft
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>go</span> <span style=color:#a90d91>func</span>() {
</span></span><span style=display:flex><span>      <span style=color:#000>confChangeCount</span> <span style=color:#000>:=</span> <span style=color:#a90d91>uint64</span>(<span style=color:#1c01ce>0</span>)
</span></span><span style=display:flex><span>      <span style=color:#a90d91>for</span> <span style=color:#000>rc</span>.<span style=color:#000>proposeC</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>rc</span>.<span style=color:#000>confChangeC</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>         <span style=color:#a90d91>select</span> {
</span></span><span style=display:flex><span>         <span style=color:#a90d91>case</span> <span style=color:#000>prop</span>, <span style=color:#000>ok</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>rc</span>.<span style=color:#000>proposeC</span>:
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> !<span style=color:#000>ok</span> {
</span></span><span style=display:flex><span>               <span style=color:#177500>// 异常时将 proposeC 置空
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#000>rc</span>.<span style=color:#000>proposeC</span> = <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>            } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>               <span style=color:#177500>// 阻塞知道消息处理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#177500>// blocks until accepted by raft state machine
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#000>rc</span>.<span style=color:#000>node</span>.<span style=color:#000>Propose</span>(<span style=color:#000>context</span>.<span style=color:#000>TODO</span>(), []<span style=color:#a90d91>byte</span>(<span style=color:#000>prop</span>))
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         <span style=color:#177500>// 接收上层应用通过 confChangeC 传递的数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>case</span> <span style=color:#000>cc</span>, <span style=color:#000>ok</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>rc</span>.<span style=color:#000>confChangeC</span>:
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> !<span style=color:#000>ok</span> {
</span></span><span style=display:flex><span>               <span style=color:#177500>// 异常时将 confChangeC 置空
</span></span></span><span style=display:flex><span><span style=color:#177500></span>               <span style=color:#000>rc</span>.<span style=color:#000>confChangeC</span> = <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>            } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>               <span style=color:#000>confChangeCount</span><span style=color:#000>++</span>
</span></span><span style=display:flex><span>               <span style=color:#000>cc</span>.<span style=color:#000>ID</span> = <span style=color:#000>confChangeCount</span>
</span></span><span style=display:flex><span>               <span style=color:#000>rc</span>.<span style=color:#000>node</span>.<span style=color:#000>ProposeConfChange</span>(<span style=color:#000>context</span>.<span style=color:#000>TODO</span>(), <span style=color:#000>cc</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#177500>// 关闭 stopc 通道，触发调用 rafeNode.stop()
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// client closed channel; shutdown raft if not already
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>close</span>(<span style=color:#000>rc</span>.<span style=color:#000>stopc</span>)
</span></span><span style=display:flex><span>   }()
</span></span><span style=display:flex><span>   <span style=color:#177500>// 处理 etcd-raft 模块返回给上层模块的数据及其他相关操作
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// event loop on raft state machine updates
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>for</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>select</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>&lt;-</span><span style=color:#000>ticker</span>.<span style=color:#000>C</span>:
</span></span><span style=display:flex><span>         <span style=color:#177500>// 触发 tricker 定时器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>rc</span>.<span style=color:#000>node</span>.<span style=color:#000>Tick</span>()
</span></span><span style=display:flex><span>      <span style=color:#177500>// 读取 node.readyc 通道(etcd-raft组件与上层应用交互的主要channel之一)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// Ready 实例封装了很多信息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// store raft entries to wal, then publish over commit channel
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>case</span> <span style=color:#000>rd</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>rc</span>.<span style=color:#000>node</span>.<span style=color:#000>Ready</span>():
</span></span><span style=display:flex><span>         <span style=color:#177500>// 将当前组件状态信息和待持久化的 Entry 记录保存到 WAL 日志文件中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// 这样即使宕机，信息也可以在节点下次启动时，通过前面回放 WAL 日志的方式恢复
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>rc</span>.<span style=color:#000>wal</span>.<span style=color:#000>Save</span>(<span style=color:#000>rd</span>.<span style=color:#000>HardState</span>, <span style=color:#000>rd</span>.<span style=color:#000>Entries</span>)
</span></span><span style=display:flex><span>         <span style=color:#177500>// 检测组件生成新的快照数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>if</span> !<span style=color:#000>raft</span>.<span style=color:#000>IsEmptySnap</span>(<span style=color:#000>rd</span>.<span style=color:#000>Snapshot</span>) {
</span></span><span style=display:flex><span>            <span style=color:#177500>// 新的快照数据写入到快照文件中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>rc</span>.<span style=color:#000>saveSnap</span>(<span style=color:#000>rd</span>.<span style=color:#000>Snapshot</span>)
</span></span><span style=display:flex><span>            <span style=color:#177500>// 将新快照持久化到 raftStorage
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>rc</span>.<span style=color:#000>raftStorage</span>.<span style=color:#000>ApplySnapshot</span>(<span style=color:#000>rd</span>.<span style=color:#000>Snapshot</span>)
</span></span><span style=display:flex><span>            <span style=color:#177500>// 通知上层应用加载新快照
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>rc</span>.<span style=color:#000>publishSnapshot</span>(<span style=color:#000>rd</span>.<span style=color:#000>Snapshot</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#177500>// 将待持久化的 Entry 记录追加到 raftStorage 中完成初始化
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>rc</span>.<span style=color:#000>raftStorage</span>.<span style=color:#000>Append</span>(<span style=color:#000>rd</span>.<span style=color:#000>Entries</span>)
</span></span><span style=display:flex><span>         <span style=color:#177500>// 将待发送消息发送到指定节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>rc</span>.<span style=color:#000>transport</span>.<span style=color:#000>Send</span>(<span style=color:#000>rd</span>.<span style=color:#000>Messages</span>)
</span></span><span style=display:flex><span>         <span style=color:#177500>// 将已提交、待应用的 Entry 记录应用到上层应用的状态机中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>applyDoneC</span>, <span style=color:#000>ok</span> <span style=color:#000>:=</span> <span style=color:#000>rc</span>.<span style=color:#000>publishEntries</span>(<span style=color:#000>rc</span>.<span style=color:#000>entriesToApply</span>(<span style=color:#000>rd</span>.<span style=color:#000>CommittedEntries</span>))
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> !<span style=color:#000>ok</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>rc</span>.<span style=color:#000>stop</span>()
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span>
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#177500>// WAL 日志量和 raftLog.storage 中的 Entry 记录会不断增加
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// 节点每处理 1000 条(默认值) Entry 记录会触发一次创建快照的记录
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#177500>// 同时 WAL 会释放一些日志文件的句柄，raftLog.storage 也会压缩其保存的 Entry 记录
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>rc</span>.<span style=color:#000>maybeTriggerSnapshot</span>(<span style=color:#000>applyDoneC</span>)
</span></span><span style=display:flex><span>         <span style=color:#177500>// 上层应用处理完该 Ready 实例，通知组件准备返回下一个 Ready 实例
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#000>rc</span>.<span style=color:#000>node</span>.<span style=color:#000>Advance</span>()
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>rc</span>.<span style=color:#000>transport</span>.<span style=color:#000>ErrorC</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>rc</span>.<span style=color:#000>writeError</span>(<span style=color:#000>err</span>)
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>&lt;-</span><span style=color:#000>rc</span>.<span style=color:#000>stopc</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>rc</span>.<span style=color:#000>stop</span>()
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=领导者选举>领导者选举</h1><h2 id=启动节点>启动节点</h2><p>Node 初始化时是 Follower 状态，集群的节点初次启动时会通过 StartNode() 启动创建对应的 node 实例和底层的 raft 实例。StartNode() 方法根据传入的 config 配置创建 raft 实例并初始raft 使用的相关组件。</p><p>代码入口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>newRaftNode() -&gt; startRaft() -&gt; StartNode()
</span></span></code></pre></td></tr></table></div></div></div><p>StartNode 启动节点<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>// raft/node.go:218
</span></span><span style=display:flex><span>// Peer封装了节点 ID, 且记录了当前集群中全部节点 ID
</span></span><span style=display:flex><span>func StartNode(c *Config, peers []Peer) Node {
</span></span><span style=display:flex><span>   if len(peers) == 0 {
</span></span><span style=display:flex><span>      panic(&#34;no peers given; use RestartNode instead&#34;)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   // 根据 config 初始化 RawNode，并且也初始化一个 raft
</span></span><span style=display:flex><span>   rn, err := NewRawNode(c)
</span></span><span style=display:flex><span>   if err != nil {
</span></span><span style=display:flex><span>      panic(err)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   // 第一次使用初始化 RawNode
</span></span><span style=display:flex><span>   err = rn.Bootstrap(peers)
</span></span><span style=display:flex><span>   if err != nil {
</span></span><span style=display:flex><span>      c.Logger.Warningf(&#34;error occurred during starting a new node: %v&#34;, err)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   // 初始化 node 实例
</span></span><span style=display:flex><span>   n := newNode(rn)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   go n.run()
</span></span><span style=display:flex><span>   return &amp;n
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func NewRawNode(config *Config) (*RawNode, error) {
</span></span><span style=display:flex><span>   // 调用初始化 newRaft
</span></span><span style=display:flex><span>   r := newRaft(config)
</span></span><span style=display:flex><span>   rn := &amp;RawNode{
</span></span><span style=display:flex><span>      raft: r,
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   rn.prevSoftSt = r.softState()
</span></span><span style=display:flex><span>   rn.prevHardSt = r.hardState()
</span></span><span style=display:flex><span>   return rn, nil
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func newRaft(c *Config) *raft {
</span></span><span style=display:flex><span>   if err := c.validate(); err != nil {
</span></span><span style=display:flex><span>      panic(err.Error())
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   raftlog := newLogWithSize(c.Storage, c.Logger, c.MaxCommittedSizePerReady)
</span></span><span style=display:flex><span>   hs, cs, err := c.Storage.InitialState()
</span></span><span style=display:flex><span>   if err != nil {
</span></span><span style=display:flex><span>      panic(err) // TODO(bdarnell)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   r := &amp;raft{
</span></span><span style=display:flex><span>      id:                        c.ID,
</span></span><span style=display:flex><span>      lead:                      None,
</span></span><span style=display:flex><span>      isLearner:                 false,
</span></span><span style=display:flex><span>      raftLog:                   raftlog,
</span></span><span style=display:flex><span>      maxMsgSize:                c.MaxSizePerMsg,
</span></span><span style=display:flex><span>      maxUncommittedSize:        c.MaxUncommittedEntriesSize,
</span></span><span style=display:flex><span>      prs:                       tracker.MakeProgressTracker(c.MaxInflightMsgs),
</span></span><span style=display:flex><span>      electionTimeout:           c.ElectionTick,
</span></span><span style=display:flex><span>      heartbeatTimeout:          c.HeartbeatTick,
</span></span><span style=display:flex><span>      logger:                    c.Logger,
</span></span><span style=display:flex><span>      checkQuorum:               c.CheckQuorum,
</span></span><span style=display:flex><span>      preVote:                   c.PreVote,
</span></span><span style=display:flex><span>      readOnly:                  newReadOnly(c.ReadOnlyOption),
</span></span><span style=display:flex><span>      disableProposalForwarding: c.DisableProposalForwarding,
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   ...
</span></span><span style=display:flex><span>   // 启动时都是 Follower 状态
</span></span><span style=display:flex><span>   r.becomeFollower(r.Term, None)
</span></span><span style=display:flex><span>   var nodesStrs []string
</span></span><span style=display:flex><span>   for _, n := range r.prs.VoterNodes() {
</span></span><span style=display:flex><span>      nodesStrs = append(nodesStrs, fmt.Sprintf(&#34;%x&#34;, n))
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   r.logger.Infof(&#34;newRaft %x [peers: [%s], term: %d, commit: %d, applied: %d, lastindex: %d, lastterm: %d]&#34;,
</span></span><span style=display:flex><span>      r.id, strings.Join(nodesStrs, &#34;,&#34;), r.Term, r.raftLog.committed, r.raftLog.applied, r.raftLog.lastIndex(), r.raftLog.lastTerm())
</span></span><span style=display:flex><span>   return r
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>node 节点初始化时，所有 node 开始都被初始化为 Follower 状态。
run方法调用：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>StartNode() -&gt; go n.run()
</span></span></code></pre></td></tr></table></div></div></div><p>run方法：<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>n</span> <span style=color:#000>*</span><span style=color:#000>node</span>) <span style=color:#000>run</span>() {
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>for</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>select</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>pm</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>propc</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>...</span>
</span></span><span style=display:flex><span>         <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>Step</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>         <span style=color:#000>...</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>m</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>n</span>.<span style=color:#000>recvc</span>:
</span></span><span style=display:flex><span>         <span style=color:#177500>// filter out response message from unknown From.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>         <span style=color:#a90d91>if</span> <span style=color:#000>pr</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>prs</span>.<span style=color:#000>Progress</span>[<span style=color:#000>m</span>.<span style=color:#000>From</span>]; <span style=color:#000>pr</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> <span style=color:#000>||</span> !<span style=color:#000>IsResponseMsg</span>(<span style=color:#000>m</span>.<span style=color:#000>Type</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>r</span>.<span style=color:#000>Step</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>cc</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>n</span>.<span style=color:#000>confc</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>...</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>&lt;-</span><span style=color:#000>n</span>.<span style=color:#000>tickc</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>n</span>.<span style=color:#000>rn</span>.<span style=color:#000>Tick</span>()
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>readyc</span> <span style=color:#000>&lt;-</span> <span style=color:#000>rd</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>n</span>.<span style=color:#000>rn</span>.<span style=color:#000>acceptReady</span>(<span style=color:#000>rd</span>)
</span></span><span style=display:flex><span>         <span style=color:#000>advancec</span> = <span style=color:#000>n</span>.<span style=color:#000>advancec</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>&lt;-</span><span style=color:#000>advancec</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>n</span>.<span style=color:#000>rn</span>.<span style=color:#000>Advance</span>(<span style=color:#000>rd</span>)
</span></span><span style=display:flex><span>         <span style=color:#000>rd</span> = <span style=color:#000>Ready</span>{}
</span></span><span style=display:flex><span>         <span style=color:#000>advancec</span> = <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>c</span> <span style=color:#000>:=</span> <span style=color:#000>&lt;-</span><span style=color:#000>n</span>.<span style=color:#000>status</span>:
</span></span><span style=display:flex><span>         <span style=color:#000>c</span> <span style=color:#000>&lt;-</span> <span style=color:#000>getStatus</span>(<span style=color:#000>r</span>)
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#000>&lt;-</span><span style=color:#000>n</span>.<span style=color:#000>stop</span>:
</span></span><span style=display:flex><span>         <span style=color:#a90d91>close</span>(<span style=color:#000>n</span>.<span style=color:#000>done</span>)
</span></span><span style=display:flex><span>         <span style=color:#a90d91>return</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>这里主要是通过 for - select - channel 监听 channel 信息来处理不同请求。
其中 propc 和 recvc 拿到上层应用传来的消息会提交给 raft 层的 Step 函数处理。</p><p>Step 函数是 etcd-raft 模块负责各类信息的入口。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>Step</span>(<span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>   <span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgHup</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgVote</span>, <span style=color:#000>pb</span>.<span style=color:#000>MsgPreVote</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>default</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>step</span>(<span style=color:#000>r</span>, <span style=color:#000>m</span>)
</span></span><span style=display:flex><span>      <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>Step 函数中最后的 default 里的 step 被实现为一个状态机，其 step 属性是一个函数指针，根据当前节点的不同角色指向不同的消息处理函数：stepLeader/stepFollower/stepCandidate。同样还有一个 tick 函数指针，根据角色不同也有有不同的处理函数 tickHeartbeat 和 tickElection，分别用来触发定时心跳和选举检测。</p><h2 id=发送心跳包>发送心跳包</h2><h3 id=leader>Leader</h3><p>当一个节点成为 Leader 时，会将节点的定时器设置为 tickHearbeat，然后周期性调用以维持 Leader 地位。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#177500>// raft/raft.go:724
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>becomeLeader</span>() {
</span></span><span style=display:flex><span>   <span style=color:#177500>// 检测当前节点的状态，禁止从 Follower 状态切换成 Leader 状态
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// TODO(xiangli) remove the panic when the raft implementation is stable
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>state</span> <span style=color:#000>==</span> <span style=color:#000>StateFollower</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>panic</span>(<span style=color:#c41a16>&#34;invalid transition [follower -&gt; leader]&#34;</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#177500>// 将 step 设置为 stepLeader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>r</span>.<span style=color:#000>step</span> = <span style=color:#000>stepLeader</span>
</span></span><span style=display:flex><span>   <span style=color:#000>r</span>.<span style=color:#000>reset</span>(<span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>   <span style=color:#177500>// 设置心跳函数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>r</span>.<span style=color:#000>tick</span> = <span style=color:#000>r</span>.<span style=color:#000>tickHeartbeat</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 设置 lead 的 id
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>r</span>.<span style=color:#000>lead</span> = <span style=color:#000>r</span>.<span style=color:#000>id</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 更新当前角色
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>r</span>.<span style=color:#000>state</span> = <span style=color:#000>StateLeader</span>   
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>tickHeartbeat</span>() {
</span></span><span style=display:flex><span>   <span style=color:#177500>// 心跳计数器递增
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>r</span>.<span style=color:#000>heartbeatElapsed</span><span style=color:#000>++</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// 选举计数器递增
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span><span style=color:#000>++</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span> <span style=color:#000>&gt;=</span> <span style=color:#000>r</span>.<span style=color:#000>electionTimeout</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span> = <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// 检测当前节点时大多数节点保持连通
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>checkQuorum</span> {
</span></span><span style=display:flex><span>         <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>Step</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>From</span>: <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgCheckQuorum</span>}); <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Debugf</span>(<span style=color:#c41a16>&#34;error occurred during checking sending heartbeat: %v&#34;</span>, <span style=color:#000>err</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#177500>// If current leader cannot transfer leadership in electionTimeout, it becomes leader again.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>state</span> <span style=color:#000>==</span> <span style=color:#000>StateLeader</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>r</span>.<span style=color:#000>leadTransferee</span> <span style=color:#000>!=</span> <span style=color:#000>None</span> {
</span></span><span style=display:flex><span>         <span style=color:#000>r</span>.<span style=color:#000>abortLeaderTransfer</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>state</span> <span style=color:#000>!=</span> <span style=color:#000>StateLeader</span> {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>heartbeatElapsed</span> <span style=color:#000>&gt;=</span> <span style=color:#000>r</span>.<span style=color:#000>heartbeatTimeout</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>r</span>.<span style=color:#000>heartbeatElapsed</span> = <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>Step</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>From</span>: <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgBeat</span>}); <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>         <span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Debugf</span>(<span style=color:#c41a16>&#34;error occurred during checking sending heartbeat: %v&#34;</span>, <span style=color:#000>err</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>becomeLeader 中 step 被设置成 stepLeader，所以会调用 stepLeader 来处理 leader 中对应的消息。然后调用 bcastHeartbeat 向所有节点发送心跳。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepLeader</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// These message types do not require any progress for m.From.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgBeat</span>:
</span></span><span style=display:flex><span>		<span style=color:#177500>// 向所有节点发送心跳
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>r</span>.<span style=color:#000>bcastHeartbeat</span>()
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgCheckQuorum</span>:
</span></span><span style=display:flex><span>		<span style=color:#177500>// 检测是否和大部分节点保持连通
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#177500>// 如果不连通则切换到 Follower 状态
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>if</span> !<span style=color:#000>r</span>.<span style=color:#000>prs</span>.<span style=color:#000>QuorumActive</span>() {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Warningf</span>(<span style=color:#c41a16>&#34;%x stepped down to follower since quorum is not active&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>)
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>becomeFollower</span>(<span style=color:#000>r</span>.<span style=color:#000>Term</span>, <span style=color:#000>None</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// bcastHeartbeat sends RPC, without entries to all the peers.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>bcastHeartbeat</span>() {
</span></span><span style=display:flex><span>   <span style=color:#000>lastCtx</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>readOnly</span>.<span style=color:#000>lastPendingRequestCtx</span>()
</span></span><span style=display:flex><span>   <span style=color:#177500>// 下面函数都会调用 sendHeartbeat
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#a90d91>if</span> <span style=color:#a90d91>len</span>(<span style=color:#000>lastCtx</span>) <span style=color:#000>==</span> <span style=color:#1c01ce>0</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>r</span>.<span style=color:#000>bcastHeartbeatWithCtx</span>(<span style=color:#a90d91>nil</span>)
</span></span><span style=display:flex><span>   } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>r</span>.<span style=color:#000>bcastHeartbeatWithCtx</span>([]<span style=color:#a90d91>byte</span>(<span style=color:#000>lastCtx</span>))
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// 向指定的节点发送消息
</span></span></span><span style=display:flex><span><span style=color:#177500>// sendHeartbeat sends a heartbeat RPC to the given peer.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>sendHeartbeat</span>(<span style=color:#000>to</span> <span style=color:#a90d91>uint64</span>, <span style=color:#000>ctx</span> []<span style=color:#a90d91>byte</span>) {
</span></span><span style=display:flex><span>   <span style=color:#177500>// Attach the commit as min(to.matched, r.committed).
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// When the leader sends out heartbeat message,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// the receiver(follower) might not be matched with the leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// or it might not have all the committed entries.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// The leader MUST NOT forward the follower&#39;s commit to
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>// an unmatched index.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>commit</span> <span style=color:#000>:=</span> <span style=color:#000>min</span>(<span style=color:#000>r</span>.<span style=color:#000>prs</span>.<span style=color:#000>Progress</span>[<span style=color:#000>to</span>].<span style=color:#000>Match</span>, <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>committed</span>)
</span></span><span style=display:flex><span>   <span style=color:#000>m</span> <span style=color:#000>:=</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>{
</span></span><span style=display:flex><span>      <span style=color:#000>To</span>:      <span style=color:#000>to</span>,
</span></span><span style=display:flex><span>      <span style=color:#177500>// 发送 MsgHeartbeat 类型的数据
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>Type</span>:    <span style=color:#000>pb</span>.<span style=color:#000>MsgHeartbeat</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>Commit</span>:  <span style=color:#000>commit</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>Context</span>: <span style=color:#000>ctx</span>,
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>最终的心跳通过 MsgHeartbeat 的消息类型进行发送，通知它们目前 Leader 的存活状态，重置所有 Follower 持有的超时计时器。</p><h3 id=follower>Follower</h3><p>Follower 节点行为：</p><ol><li>接收来自 Leader 的 RPC 消息 MsgHearbeat；</li><li>重置当前节点的选举超时时间；</li><li>回复 Leader 自己存活。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>nc</span> <span style=color:#000>stepFollower</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgProp</span>:
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgHeartbeat</span>:
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span> = <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>lead</span> = <span style=color:#000>m</span>.<span style=color:#000>From</span>
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>handleHeartbeat</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>handleHeartbeat</span>(<span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>commitTo</span>(<span style=color:#000>m</span>.<span style=color:#000>Commit</span>)
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>To</span>: <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgHeartbeatResp</span>, <span style=color:#000>Context</span>: <span style=color:#000>m</span>.<span style=color:#000>Context</span>})
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></li></ol><h3 id=candidate>Candidate</h3><p>Candidate 来处理 MsgHeartbeat 的信息，是先把自己变成 Follower，然后和上面的 Follower 一样，回复 Leader 自己存活。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#177500>// stepCandidate is shared by StateCandidate and StatePreCandidate; the difference is
</span></span></span><span style=display:flex><span><span style=color:#177500>// whether they respond to MsgVoteResp or MsgPreVoteResp.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> <span style=color:#000>stepCandidate</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgHeartbeat</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>r</span>.<span style=color:#000>becomeFollower</span>(<span style=color:#000>m</span>.<span style=color:#000>Term</span>, <span style=color:#000>m</span>.<span style=color:#000>From</span>) <span style=color:#177500>// always m.Term == r.Term
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>r</span>.<span style=color:#000>handleHeartbeat</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#000>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>handleHeartbeat</span>(<span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) {
</span></span><span style=display:flex><span>   <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>commitTo</span>(<span style=color:#000>m</span>.<span style=color:#000>Commit</span>)
</span></span><span style=display:flex><span>   <span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>To</span>: <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgHeartbeatResp</span>, <span style=color:#000>Context</span>: <span style=color:#000>m</span>.<span style=color:#000>Context</span>})
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>当 Leader 收到返回信息时，会将对应节点设置为 RecentActive，表示该节点目前存活。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepLeader</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 根据 from，取出当前的 Follower 的 Progress
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#000>pr</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>prs</span>.<span style=color:#000>Progress</span>[<span style=color:#000>m</span>.<span style=color:#000>From</span>]
</span></span><span style=display:flex><span>	<span style=color:#a90d91>if</span> <span style=color:#000>pr</span> <span style=color:#000>==</span> <span style=color:#a90d91>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Debugf</span>(<span style=color:#c41a16>&#34;%x no progress available for %x&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>m</span>.<span style=color:#000>From</span>)
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgHeartbeatResp</span>:
</span></span><span style=display:flex><span>		<span style=color:#000>pr</span>.<span style=color:#000>RecentActive</span> = <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></p><p>如果 Follower 在一定的时间内，没有收到 Leader 节点的消息，就会发起新一轮的选举，重新选一个 Leader 节点。</p><h2 id=leader-选举>Leader 选举</h2><h3 id=接收心跳>接收心跳</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>becomeFollower</span>(<span style=color:#000>term</span> <span style=color:#a90d91>uint64</span>, <span style=color:#000>lead</span> <span style=color:#a90d91>uint64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>step</span> = <span style=color:#000>stepFollower</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>reset</span>(<span style=color:#000>term</span>)
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>tick</span> = <span style=color:#000>r</span>.<span style=color:#000>tickElection</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>lead</span> = <span style=color:#000>lead</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>state</span> = <span style=color:#000>StateFollower</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x became follower at term %d&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// follower以及candidate的tick函数，在r.electionTimeout之后被调用
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>tickElection</span>() {
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span><span style=color:#000>++</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// promotable返回是否可以被提升为leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// pastElectionTimeout检测当前的候选超时间是否过期
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>promotable</span>() <span style=color:#000>&amp;&amp;</span> <span style=color:#000>r</span>.<span style=color:#000>pastElectionTimeout</span>() {
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span> = <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>		<span style=color:#177500>// 发起选举
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>r</span>.<span style=color:#000>Step</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>From</span>: <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgHup</span>})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>小结：</p><ol><li>如果可以成为 Leader</li><li>当没有收到 Leader 心跳且候选超时时间过期；</li><li>则重新发起新的选举请求；</li></ol><h3 id=发起竞选>发起竞选</h3><p>Step 函数接收 MsgHup 这个类型的消息后会调用 campaign 函数，进入竞选状态。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>Step</span>(<span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>//...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgHup</span>:
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>preVote</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>hup</span>(<span style=color:#000>campaignPreElection</span>)
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>hup</span>(<span style=color:#000>campaignElection</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>hup</span>(<span style=color:#000>t</span> <span style=color:#000>CampaignType</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>campaign</span>(<span style=color:#000>t</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>campaign</span>(<span style=color:#000>t</span> <span style=color:#000>CampaignType</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>if</span> <span style=color:#000>t</span> <span style=color:#000>==</span> <span style=color:#000>campaignPreElection</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>becomePreCandidate</span>()
</span></span><span style=display:flex><span>		<span style=color:#000>voteMsg</span> = <span style=color:#000>pb</span>.<span style=color:#000>MsgPreVote</span>
</span></span><span style=display:flex><span>		<span style=color:#177500>// PreVote RPCs are sent for the next term before we&#39;ve incremented r.Term.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>term</span> = <span style=color:#000>r</span>.<span style=color:#000>Term</span> <span style=color:#000>+</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>	} <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#177500>// 切换到Candidate状态
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>r</span>.<span style=color:#000>becomeCandidate</span>()
</span></span><span style=display:flex><span>		<span style=color:#000>voteMsg</span> = <span style=color:#000>pb</span>.<span style=color:#000>MsgVote</span>
</span></span><span style=display:flex><span>		<span style=color:#000>term</span> = <span style=color:#000>r</span>.<span style=color:#000>Term</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#177500>// 统计当前节点收到的选票 并统计其得票数是否超过半数，这次检测主要是为单节点设置的
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// 判断是否是单节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>if</span> <span style=color:#000>_</span>, <span style=color:#000>_</span>, <span style=color:#000>res</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>poll</span>(<span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>voteRespMsgType</span>(<span style=color:#000>voteMsg</span>), <span style=color:#a90d91>true</span>); <span style=color:#000>res</span> <span style=color:#000>==</span> <span style=color:#000>quorum</span>.<span style=color:#000>VoteWon</span> {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>t</span> <span style=color:#000>==</span> <span style=color:#000>campaignPreElection</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>campaign</span>(<span style=color:#000>campaignElection</span>)
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#177500>// 是单节点的话直接变成 Leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#000>r</span>.<span style=color:#000>becomeLeader</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#177500>// 向集群中的所有节点发送信息请求投票
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>for</span> <span style=color:#000>_</span>, <span style=color:#000>id</span> <span style=color:#000>:=</span> <span style=color:#a90d91>range</span> <span style=color:#000>ids</span> {
</span></span><span style=display:flex><span>		<span style=color:#177500>// 跳过自身的节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>if</span> <span style=color:#000>id</span> <span style=color:#000>==</span> <span style=color:#000>r</span>.<span style=color:#000>id</span> {
</span></span><span style=display:flex><span>			<span style=color:#a90d91>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x [logterm: %d, index: %d] sent %s request to %x at term %d&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastTerm</span>(), <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastIndex</span>(), <span style=color:#000>voteMsg</span>, <span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>		<span style=color:#a90d91>var</span> <span style=color:#000>ctx</span> []<span style=color:#a90d91>byte</span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>t</span> <span style=color:#000>==</span> <span style=color:#000>campaignTransfer</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>ctx</span> = []<span style=color:#a90d91>byte</span>(<span style=color:#000>t</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>Term</span>: <span style=color:#000>term</span>, <span style=color:#000>To</span>: <span style=color:#000>id</span>, <span style=color:#000>Type</span>: <span style=color:#000>voteMsg</span>, <span style=color:#000>Index</span>: <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastIndex</span>(), <span style=color:#000>LogTerm</span>: <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastTerm</span>(), <span style=color:#000>Context</span>: <span style=color:#000>ctx</span>})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>切换到 campaign 状态，然后发送自己的 term 消息，请求投票。
campaignPreElection 的作用：</p><blockquote><p>当系统之前出现分区，在分区消失后恢复时，可能会造成某个被 split 的 Followe r的 Term 数值很大。
对服务器进行分区时，它将不会收到 heartbeat 包，每次 electionTimeout 后成为 Candidate 都会递增 Term。
服务器在一段时间后恢复连接时，Term 的值将会变得很大，然后引入的重新选举会导致导致临时的延迟与可用性问题。
PreElection 阶段并不会真正增加当前节点的 Term，它的主要作用是得到当前集群能否成功选举出一个 Leader 的答案，避免上面这种情况的发生。</p></blockquote><h3 id=接受消息并投票>接受消息并投票</h3><p>投票需要满足的条件：</p><ol><li><strong>当前节点没有给任何节点投票</strong>或者 <strong>投票的节点 term 大于本节点的</strong>或者 <strong>是之前已经投票的节点</strong>；</li><li>该节点的消息是最新的。</li></ol><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>Step</span>(<span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgVote</span>, <span style=color:#000>pb</span>.<span style=color:#000>MsgPreVote</span>:
</span></span><span style=display:flex><span>		<span style=color:#177500>// We can vote if this is a repeat of a vote we&#39;ve already cast...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>canVote</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>Vote</span> <span style=color:#000>==</span> <span style=color:#000>m</span>.<span style=color:#000>From</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>			<span style=color:#177500>// ...we haven&#39;t voted and we don&#39;t think there&#39;s a leader yet in this term...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			(<span style=color:#000>r</span>.<span style=color:#000>Vote</span> <span style=color:#000>==</span> <span style=color:#000>None</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>r</span>.<span style=color:#000>lead</span> <span style=color:#000>==</span> <span style=color:#000>None</span>) <span style=color:#000>||</span>
</span></span><span style=display:flex><span>			<span style=color:#177500>// ...or this is a PreVote for a future term...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			(<span style=color:#000>m</span>.<span style=color:#000>Type</span> <span style=color:#000>==</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgPreVote</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>m</span>.<span style=color:#000>Term</span> &gt; <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>		<span style=color:#177500>// ...and we believe the candidate is up to date.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>if</span> <span style=color:#000>canVote</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>isUpToDate</span>(<span style=color:#000>m</span>.<span style=color:#000>Index</span>, <span style=color:#000>m</span>.<span style=color:#000>LogTerm</span>) {
</span></span><span style=display:flex><span>			<span style=color:#177500>// 如果当前没有给任何节点投票（r.Vote == None） 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 或者 投票的节点 term 大于本节点的（m.Term &gt; r.Term）
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#177500>// 或者 是之前已经投票的节点（r.Vote == m.From）
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#177500>// 同时还满足该节点的消息是最新的（r.raftLog.isUpToDate(m.Index, m.LogTerm)），
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 那么就接收这个节点的投票
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x [logterm: %d, index: %d, vote: %x] cast %s for %x [logterm: %d, index: %d] at term %d&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastTerm</span>(), <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastIndex</span>(), <span style=color:#000>r</span>.<span style=color:#000>Vote</span>, <span style=color:#000>m</span>.<span style=color:#000>Type</span>, <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>m</span>.<span style=color:#000>LogTerm</span>, <span style=color:#000>m</span>.<span style=color:#000>Index</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>To</span>: <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>Term</span>: <span style=color:#000>m</span>.<span style=color:#000>Term</span>, <span style=color:#000>Type</span>: <span style=color:#000>voteRespMsgType</span>(<span style=color:#000>m</span>.<span style=color:#000>Type</span>)})
</span></span><span style=display:flex><span>			<span style=color:#a90d91>if</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> <span style=color:#000>==</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgVote</span> {
</span></span><span style=display:flex><span>				<span style=color:#177500>// 保存给哪个节点投票
</span></span></span><span style=display:flex><span><span style=color:#177500></span>				<span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span> = <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>				<span style=color:#000>r</span>.<span style=color:#000>Vote</span> = <span style=color:#000>m</span>.<span style=color:#000>From</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x [logterm: %d, index: %d, vote: %x] rejected %s from %x [logterm: %d, index: %d] at term %d&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastTerm</span>(), <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>lastIndex</span>(), <span style=color:#000>r</span>.<span style=color:#000>Vote</span>, <span style=color:#000>m</span>.<span style=color:#000>Type</span>, <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>m</span>.<span style=color:#000>LogTerm</span>, <span style=color:#000>m</span>.<span style=color:#000>Index</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>To</span>: <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>Term</span>: <span style=color:#000>r</span>.<span style=color:#000>Term</span>, <span style=color:#000>Type</span>: <span style=color:#000>voteRespMsgType</span>(<span style=color:#000>m</span>.<span style=color:#000>Type</span>), <span style=color:#000>Reject</span>: <span style=color:#a90d91>true</span>})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=candidate-统计投票>Candidate 统计投票</h3><p>Candidate 节点接收到投票信息，然后统计投票数量</p><ol><li>如果投票数大于节点数的一半，成为 Leader；</li><li>如果不满足则变成 Follower；</li></ol><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepCandidate</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// Only handle vote responses corresponding to our candidacy (while in
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// StateCandidate, we may get stale MsgPreVoteResp messages in this term from
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#177500>// our pre-candidate state).
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>var</span> <span style=color:#000>myVoteRespType</span> <span style=color:#000>pb</span>.<span style=color:#000>MessageType</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>state</span> <span style=color:#000>==</span> <span style=color:#000>StatePreCandidate</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>myVoteRespType</span> = <span style=color:#000>pb</span>.<span style=color:#000>MsgPreVoteResp</span>
</span></span><span style=display:flex><span>	} <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>myVoteRespType</span> = <span style=color:#000>pb</span>.<span style=color:#000>MsgVoteResp</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>myVoteRespType</span>:
</span></span><span style=display:flex><span>		<span style=color:#177500>// 计算当前集群中给自己投票的节点数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>gr</span>, <span style=color:#000>rj</span>, <span style=color:#000>res</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>poll</span>(<span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>m</span>.<span style=color:#000>Type</span>, !<span style=color:#000>m</span>.<span style=color:#000>Reject</span>)
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x has received %d %s votes and %d vote rejections&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>gr</span>, <span style=color:#000>m</span>.<span style=color:#000>Type</span>, <span style=color:#000>rj</span>)
</span></span><span style=display:flex><span>		<span style=color:#a90d91>switch</span> <span style=color:#000>res</span> {
</span></span><span style=display:flex><span>		<span style=color:#177500>// 大多数得票
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>case</span> <span style=color:#000>quorum</span>.<span style=color:#000>VoteWon</span>:
</span></span><span style=display:flex><span>			<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>state</span> <span style=color:#000>==</span> <span style=color:#000>StatePreCandidate</span> {
</span></span><span style=display:flex><span>				<span style=color:#000>r</span>.<span style=color:#000>campaign</span>(<span style=color:#000>campaignElection</span>)
</span></span><span style=display:flex><span>			} <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#177500>// 如果进行投票的节点数量正好是半数以上节点数量
</span></span></span><span style=display:flex><span><span style=color:#177500></span>				<span style=color:#000>r</span>.<span style=color:#000>becomeLeader</span>()
</span></span><span style=display:flex><span>				<span style=color:#177500>// 向集群中其他节点广播 MsgApp 消息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>				<span style=color:#000>r</span>.<span style=color:#000>bcastAppend</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#177500>// 票数不够
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>case</span> <span style=color:#000>quorum</span>.<span style=color:#000>VoteLost</span>:
</span></span><span style=display:flex><span>			<span style=color:#177500>// pb.MsgPreVoteResp contains future term of pre-candidate
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#177500>// m.Term &gt; r.Term; reuse r.Term
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#177500>// 切换到 Follower
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#000>r</span>.<span style=color:#000>becomeFollower</span>(<span style=color:#000>r</span>.<span style=color:#000>Term</span>, <span style=color:#000>None</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>每当收到一个 MsgVoteResp 类型的消息时，就会设置当前节点持有的 votes 数组，更新其中存储的节点投票状态，如果收到大多数的节点票数，切换成 Leader，向其他的节点发送当前节点当选的消息，通知其余节点更新 Raft 结构体中的 Term 等信息。
状态切换：</p><p><img src=../imgs/raft_sourcecode20220904_3.png alt=raft_sourcecode20220904_3.png></p><p>PreCandidate 是为了防止在分区的情况下，某个 split 的 Follower 的 Term 数值变得很大。</p><p>不同节点之间的切换，调用对应的 bacome* 方法就可以。需要注意每个 bacome* 中的 step 和 tick。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>becomeFollower</span>(<span style=color:#000>term</span> <span style=color:#a90d91>uint64</span>, <span style=color:#000>lead</span> <span style=color:#a90d91>uint64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>step</span> = <span style=color:#000>stepFollower</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>reset</span>(<span style=color:#000>term</span>)
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>tick</span> = <span style=color:#000>r</span>.<span style=color:#000>tickElection</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>lead</span> = <span style=color:#000>lead</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>state</span> = <span style=color:#000>StateFollower</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x became follower at term %d&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>becomeCandidate</span>() {
</span></span><span style=display:flex><span>	<span style=color:#177500>// TODO(xiangli) remove the panic when the raft implementation is stable
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>state</span> <span style=color:#000>==</span> <span style=color:#000>StateLeader</span> {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>panic</span>(<span style=color:#c41a16>&#34;invalid transition [leader -&gt; candidate]&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>step</span> = <span style=color:#000>stepCandidate</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>reset</span>(<span style=color:#000>r</span>.<span style=color:#000>Term</span> <span style=color:#000>+</span> <span style=color:#1c01ce>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>tick</span> = <span style=color:#000>r</span>.<span style=color:#000>tickElection</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>Vote</span> = <span style=color:#000>r</span>.<span style=color:#000>id</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>state</span> = <span style=color:#000>StateCandidate</span>
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x became candidate at term %d&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>step 属性是一个函数指针，根据当前节点的不同角色，指向不同的消息处理函数，如 stepLeader/stepFollower/stepCandidate。
tick 也是一个函数指针，根据角色的不同，也会在 tickHeartbeat 和 tickElection 之间来回切换，分别用来触发定时心跳和选举检测。</p><h1 id=日志同步>日志同步</h1><h2 id=wal-日志>WAL 日志</h2><p>WAL（Write Ahead Log）主要的作用是记录整个数据变化的全部历程。etcd 中所有数据的修改在提交前，都要先写入到 WAL 中。这使得etcd拥有两个重要功能：</p><ul><li>故障快速恢复</li></ul><blockquote><p>数据遭到破坏时，可以通过执行所有 WAL 中记录的修改操作，快速从最原始的数据恢复到数据损坏前的状态。</p></blockquote><ul><li>数据回滚（undo）/重做（redo）</li></ul><blockquote><p>所有的修改操作都被记录在 WAL 中，需要回滚或重做，只需要反向或正向执行日志中的操作即可，类似 MySQL 。</p></blockquote><p>etcd中处理 Entry 记录的流程图（摘自【etcd技术内幕】)</p><p><img src=../imgs/raft_sourcecode20220904_4.png alt=raft_sourcecode20220904_4.png></p><p>具体流程如下：</p><ol><li>客户端向 etcd 集群发起一次请求，请求中封装的 Entry 首先会交给 etcd-raft 处理，etcd-raft 会将 Entry 记录保存到 raftLog.unstable 中；</li><li>etcd-raft 将 Entry 记录封装到 Ready 实例中，返回给上层模块进行持久化；</li><li>上层模块收到持久化的 Ready 记录后，会记录到 WAL 文件中然后持久化，最后通知 etcd-raft 模块进行处理；</li><li>etcd-raft 将该 Entry 记录从 unstable 中移到 storage 中保存；</li><li>当 Entry 记录被复制到集群中的半数以上节点时，该记录会被 Leader 节点认为已经提交，封装到 Ready 实例中通知上层模块；</li><li>此时上层模块将该 Ready 实例封装的 Entry 记录应用到状态机上。</li></ol><h2 id=同步日志>同步日志</h2><p>etcd 中 Leader 节点数据 同步 到 Follower 流程图：</p><p><img src=../imgs/raft_sourcecode20220904_5.png alt=raft_sourcecode20220904_5.png></p><p>etcd 日志保存的总体流程如下：</p><p>1、集群某个节点收到 client 的 put 请求要求修改数据。节点会生成一个 Type 为 MsgProp 的Message，发送给 Leader。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#177500>// 生成MsgProp消息
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>n</span> <span style=color:#000>*</span><span style=color:#000>node</span>) <span style=color:#000>Propose</span>(<span style=color:#000>ctx</span> <span style=color:#000>context</span>.<span style=color:#000>Context</span>, <span style=color:#000>data</span> []<span style=color:#a90d91>byte</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#000>n</span>.<span style=color:#000>stepWait</span>(<span style=color:#000>ctx</span>, <span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgProp</span>, <span style=color:#000>Entries</span>: []<span style=color:#000>pb</span>.<span style=color:#000>Entry</span>{{<span style=color:#000>Data</span>: <span style=color:#000>data</span>}}})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepFollower</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgProp</span>:
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>lead</span> <span style=color:#000>==</span> <span style=color:#000>None</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x no leader at term %d; dropping proposal&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>			<span style=color:#a90d91>return</span> <span style=color:#000>ErrProposalDropped</span>
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>disableProposalForwarding</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Infof</span>(<span style=color:#c41a16>&#34;%x not forwarding to leader %x at term %d; dropping proposal&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>r</span>.<span style=color:#000>lead</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>			<span style=color:#a90d91>return</span> <span style=color:#000>ErrProposalDropped</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#177500>// 设置发送的目标为leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#177500>// 将信息发送给leader
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>m</span>.<span style=color:#000>To</span> = <span style=color:#000>r</span>.<span style=color:#000>lead</span>
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>2、Leader 收到 Message 后，会处理 Message 中的日志条目，将其 append 到 raftLog 的unstable 的日志中，并且调用 bcastAppend() 广播 append 日志的消息。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepLeader</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// These message types do not require any progress for m.From.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgProp</span>:
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>		<span style=color:#177500>// 将Entry记录追加到当前节点的raftlog中
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>if</span> !<span style=color:#000>r</span>.<span style=color:#000>appendEntry</span>(<span style=color:#000>m</span>.<span style=color:#000>Entries</span><span style=color:#000>...</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a90d91>return</span> <span style=color:#000>ErrProposalDropped</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#177500>// 向其他节点复制Entry记录
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#000>r</span>.<span style=color:#000>bcastAppend</span>()
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>maybeSendAppend</span>(<span style=color:#000>to</span> <span style=color:#a90d91>uint64</span>, <span style=color:#000>sendIfEmpty</span> <span style=color:#a90d91>bool</span>) <span style=color:#a90d91>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>pr</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>prs</span>.<span style=color:#000>Progress</span>[<span style=color:#000>to</span>]
</span></span><span style=display:flex><span>	<span style=color:#a90d91>if</span> <span style=color:#000>pr</span>.<span style=color:#000>IsPaused</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000>m</span> <span style=color:#000>:=</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>{}
</span></span><span style=display:flex><span>	<span style=color:#000>m</span>.<span style=color:#000>To</span> = <span style=color:#000>to</span>
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#000>m</span>.<span style=color:#000>Type</span> = <span style=color:#000>pb</span>.<span style=color:#000>MsgApp</span>
</span></span><span style=display:flex><span>	<span style=color:#000>m</span>.<span style=color:#000>Index</span> = <span style=color:#000>pr</span>.<span style=color:#000>Next</span> <span style=color:#000>-</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>	<span style=color:#000>m</span>.<span style=color:#000>LogTerm</span> = <span style=color:#000>term</span>
</span></span><span style=display:flex><span>	<span style=color:#000>m</span>.<span style=color:#000>Entries</span> = <span style=color:#000>ents</span>
</span></span><span style=display:flex><span>	<span style=color:#000>m</span>.<span style=color:#000>Commit</span> = <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>committed</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>if</span> <span style=color:#000>n</span> <span style=color:#000>:=</span> <span style=color:#a90d91>len</span>(<span style=color:#000>m</span>.<span style=color:#000>Entries</span>); <span style=color:#000>n</span> <span style=color:#000>!=</span> <span style=color:#1c01ce>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>switch</span> <span style=color:#000>pr</span>.<span style=color:#000>State</span> {
</span></span><span style=display:flex><span>		<span style=color:#177500>// optimistically increase the next when in StateReplicate
</span></span></span><span style=display:flex><span><span style=color:#177500></span>		<span style=color:#a90d91>case</span> <span style=color:#000>tracker</span>.<span style=color:#000>StateReplicate</span>:
</span></span><span style=display:flex><span>			<span style=color:#000>last</span> <span style=color:#000>:=</span> <span style=color:#000>m</span>.<span style=color:#000>Entries</span>[<span style=color:#000>n</span><span style=color:#000>-</span><span style=color:#1c01ce>1</span>].<span style=color:#000>Index</span>
</span></span><span style=display:flex><span>			<span style=color:#000>pr</span>.<span style=color:#000>OptimisticUpdate</span>(<span style=color:#000>last</span>)
</span></span><span style=display:flex><span>			<span style=color:#000>pr</span>.<span style=color:#000>Inflights</span>.<span style=color:#000>Add</span>(<span style=color:#000>last</span>)
</span></span><span style=display:flex><span>		<span style=color:#a90d91>case</span> <span style=color:#000>tracker</span>.<span style=color:#000>StateProbe</span>:
</span></span><span style=display:flex><span>			<span style=color:#000>pr</span>.<span style=color:#000>ProbeSent</span> = <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#000>r</span>.<span style=color:#000>logger</span>.<span style=color:#000>Panicf</span>(<span style=color:#c41a16>&#34;%x is sending append in unhandled state %s&#34;</span>, <span style=color:#000>r</span>.<span style=color:#000>id</span>, <span style=color:#000>pr</span>.<span style=color:#000>State</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>3、Leader 中的消息最终会以 MsgApp 类型的消息通知 Follower，Follower 收到信息之后，同 Leader 一样先将缓存中的日志条目持久化到磁盘中，并将当前已经持久化的最新日志 index 返回给 Leader。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepFollower</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgApp</span>:
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>electionElapsed</span> = <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>lead</span> = <span style=color:#000>m</span>.<span style=color:#000>From</span>
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>handleAppendEntries</span>(<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>handleAppendEntries</span>(<span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>.
</span></span><span style=display:flex><span>	<span style=color:#a90d91>if</span> <span style=color:#000>mlastIndex</span>, <span style=color:#000>ok</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>maybeAppend</span>(<span style=color:#000>m</span>.<span style=color:#000>Index</span>, <span style=color:#000>m</span>.<span style=color:#000>LogTerm</span>, <span style=color:#000>m</span>.<span style=color:#000>Commit</span>, <span style=color:#000>m</span>.<span style=color:#000>Entries</span><span style=color:#000>...</span>); <span style=color:#000>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>r</span>.<span style=color:#000>send</span>(<span style=color:#000>pb</span>.<span style=color:#000>Message</span>{<span style=color:#000>To</span>: <span style=color:#000>m</span>.<span style=color:#000>From</span>, <span style=color:#000>Type</span>: <span style=color:#000>pb</span>.<span style=color:#000>MsgAppResp</span>, <span style=color:#000>Index</span>: <span style=color:#000>mlastIndex</span>})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// maybeAppend returns (0, false) if the entries cannot be appended. Otherwise,
</span></span></span><span style=display:flex><span><span style=color:#177500>// it returns (last index of new entries, true).
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>l</span> <span style=color:#000>*</span><span style=color:#000>raftLog</span>) <span style=color:#000>maybeAppend</span>(<span style=color:#000>index</span>, <span style=color:#000>logTerm</span>, <span style=color:#000>committed</span> <span style=color:#a90d91>uint64</span>, <span style=color:#000>ents</span> <span style=color:#000>...</span><span style=color:#000>pb</span>.<span style=color:#000>Entry</span>) (<span style=color:#000>lastnewi</span> <span style=color:#a90d91>uint64</span>, <span style=color:#000>ok</span> <span style=color:#a90d91>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#000>l</span>.<span style=color:#000>commitTo</span>(<span style=color:#000>min</span>(<span style=color:#000>committed</span>, <span style=color:#000>lastnewi</span>))
</span></span><span style=display:flex><span>	<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#1c01ce>0</span>, <span style=color:#a90d91>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>func</span> (<span style=color:#000>l</span> <span style=color:#000>*</span><span style=color:#000>raftLog</span>) <span style=color:#000>commitTo</span>(<span style=color:#000>tocommit</span> <span style=color:#a90d91>uint64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#177500>// never decrease commit
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>if</span> <span style=color:#000>l</span>.<span style=color:#000>committed</span> &lt; <span style=color:#000>tocommit</span> {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>l</span>.<span style=color:#000>lastIndex</span>() &lt; <span style=color:#000>tocommit</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>l</span>.<span style=color:#000>logger</span>.<span style=color:#000>Panicf</span>(<span style=color:#c41a16>&#34;tocommit(%d) is out of range [lastIndex(%d)]. Was the raft log corrupted, truncated, or lost?&#34;</span>, <span style=color:#000>tocommit</span>, <span style=color:#000>l</span>.<span style=color:#000>lastIndex</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>l</span>.<span style=color:#000>committed</span> = <span style=color:#000>tocommit</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>4、最后leader收到大多数的follower的确认，commit自己的log，同时再次广播通知follower自己已经提交了。<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>func</span> <span style=color:#000>stepLeader</span>(<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>, <span style=color:#000>m</span> <span style=color:#000>pb</span>.<span style=color:#000>Message</span>) <span style=color:#a90d91>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// These message types do not require any progress for m.From.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>switch</span> <span style=color:#000>m</span>.<span style=color:#000>Type</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>case</span> <span style=color:#000>pb</span>.<span style=color:#000>MsgAppResp</span>:
</span></span><span style=display:flex><span>		<span style=color:#000>pr</span>.<span style=color:#000>RecentActive</span> = <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>r</span>.<span style=color:#000>maybeCommit</span>() {
</span></span><span style=display:flex><span>			<span style=color:#000>releasePendingReadIndexMessages</span>(<span style=color:#000>r</span>)
</span></span><span style=display:flex><span>			<span style=color:#177500>// 如果可以commit日志，那么广播append消息
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#000>r</span>.<span style=color:#000>bcastAppend</span>()
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> <span style=color:#000>oldPaused</span> {
</span></span><span style=display:flex><span>			<span style=color:#177500>// 如果该节点之前状态是暂停，继续发送append消息给它
</span></span></span><span style=display:flex><span><span style=color:#177500></span>			<span style=color:#000>r</span>.<span style=color:#000>sendAppend</span>(<span style=color:#000>m</span>.<span style=color:#000>From</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#a90d91>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 尝试提交索引，如果已经提交返回true
</span></span></span><span style=display:flex><span><span style=color:#177500>// 然后应该调用bcastAppend通知所有的follower
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>r</span> <span style=color:#000>*</span><span style=color:#000>raft</span>) <span style=color:#000>maybeCommit</span>() <span style=color:#a90d91>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>mci</span> <span style=color:#000>:=</span> <span style=color:#000>r</span>.<span style=color:#000>prs</span>.<span style=color:#000>Committed</span>()
</span></span><span style=display:flex><span>	<span style=color:#a90d91>return</span> <span style=color:#000>r</span>.<span style=color:#000>raftLog</span>.<span style=color:#000>maybeCommit</span>(<span style=color:#000>mci</span>, <span style=color:#000>r</span>.<span style=color:#000>Term</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 提交修改committed就可以了
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>func</span> (<span style=color:#000>l</span> <span style=color:#000>*</span><span style=color:#000>raftLog</span>) <span style=color:#000>commitTo</span>(<span style=color:#000>tocommit</span> <span style=color:#a90d91>uint64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#177500>// never decrease commit
</span></span></span><span style=display:flex><span><span style=color:#177500></span>	<span style=color:#a90d91>if</span> <span style=color:#000>l</span>.<span style=color:#000>committed</span> &lt; <span style=color:#000>tocommit</span> {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> <span style=color:#000>l</span>.<span style=color:#000>lastIndex</span>() &lt; <span style=color:#000>tocommit</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>l</span>.<span style=color:#000>logger</span>.<span style=color:#000>Panicf</span>(<span style=color:#c41a16>&#34;tocommit(%d) is out of range [lastIndex(%d)]. Was the raft log corrupted, truncated, or lost?&#34;</span>, <span style=color:#000>tocommit</span>, <span style=color:#000>l</span>.<span style=color:#000>lastIndex</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#000>l</span>.<span style=color:#000>committed</span> = <span style=color:#000>tocommit</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br></p><h1 id=实战>实战</h1><p>利用 raft 算法库实现一个分布式存储，此算法库已被广泛应用在 etcd、cockroachdb、dgraph 等开源项目中。</p><p>总体架构：</p><p><img src=../imgs/raft_sourcecode20220904_6.png alt=raft_sourcecode20220904_6.png></p><h2 id=api-设计>API 设计</h2><p>API 由一组接口定义和协议组成，设计 API 会考虑如下因素：</p><ul><li><p>性能
如 etcd v2 使用的是 HTTP/1.x，性能上无法满足大规模 Kubernetes 集群等场景的诉求，etcd v3 使用的是基于 HTTP/2 的 gRPC 协议</p></li><li><p>易用性、可调试性
有的内部高并发服务为了性能会使用 UDP 协议，相比 HTTP 协议，UDP 协议在易用性、可调试性存在一定差距</p></li><li><p>开发效率、跨平台、可移植性
相比基于裸 UDP、TCP 协议设计的接口，如果使用 Protobuf 等 IDL 语言，支持跨平台、代码自动生成，开发效率更高。</p></li><li><p>安全性
使用 HTTPS 协议可对通信数据加密更安全，可适用于不安全的网络环境（比如公网传输）</p></li><li><p>接口幂等性
基于 raftexample 定制开发，因此日志持久化存储、网络都使用的是 etcd 自带的 WAL 和 rafthttp 模块。</p></li></ul><p>WAL模块中提供了核心的保存未持久化的日志条目和快照功能接口；rafthttp模块基于 HTTP 协议提供了各个节点间的消息发送能力</p><h2 id=复制状态机>复制状态机</h2><p>复制状态机由共识模块、日志模块、状态机组成。</p><p><img src=../imgs/raft_sourcecode20220904_7.png alt=raft_sourcecode20220904_7.png></p><p>复制状态机的写请求流程：</p><ul><li>client 发起一个写请求；</li><li>server 向 Raft 共识模块提交请求，共识模块生成一个写提案日志条目。若 server 是 Leader，则把日志条目广播给其他节点，并持久化日志条目到 WAL 中；</li><li>当一半以上节点持久化日志条目后，Leader 的共识模块将此日志条目标记为已提交（committed），并通知其他节点提交；</li><li>server 从共识模块获取已经提交的日志条目，异步应用到状态机存储中（boltdb/leveldb/memory），然后返回给 client。</li></ul><h2 id=多存储引擎>多存储引擎</h2><p>raftexample 本身只支持内存存储。通过将 KV 存储接口进行抽象化设计，实现支持多存储引擎。KVStore interface 的定义如下所示。</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a90d91>type</span> <span style=color:#000>KVStore</span> <span style=color:#a90d91>interface</span> {
</span></span><span style=display:flex><span>   <span style=color:#177500>// LookUp get key value
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Lookup</span>(<span style=color:#000>key</span> <span style=color:#a90d91>string</span>) (<span style=color:#a90d91>string</span>, <span style=color:#a90d91>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Propose propose kv request into raft state machine
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Propose</span>(<span style=color:#000>k</span>, <span style=color:#000>v</span> <span style=color:#a90d91>string</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// ReadCommits consume entry from raft state machine into KvStore map until error
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>ReadCommits</span>(<span style=color:#000>commitC</span> <span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#000>*</span><span style=color:#a90d91>string</span>, <span style=color:#000>errorC</span> <span style=color:#000>&lt;-</span><span style=color:#a90d91>chan</span> <span style=color:#a90d91>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Snapshot return KvStore snapshot
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Snapshot</span>() ([]<span style=color:#a90d91>byte</span>, <span style=color:#a90d91>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// RecoverFromSnapshot recover data from snapshot
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>RecoverFromSnapshot</span>(<span style=color:#000>snapshot</span> []<span style=color:#a90d91>byte</span>) <span style=color:#a90d91>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#177500>// Close close backend databases
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>Close</span>() <span style=color:#000>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><br><p>存储引擎的选型及基本原理</p><h3 id=boltdb>boltdb</h3><p>github 链接：<a href=https://github.com/etcd-io/bbolt>https://github.com/etcd-io/bbolt</a></p><p>boltdb 是一个基于 B+ tree 实现的存储引擎库。</p><p>boltdb 适用于读多写少，一般情况下可直接从内存中基于 B+ tree 遍历，快速获取数据返回给 client，不涉及经过磁盘 I/O。</p><p>对于写请求，基于 B+ tree 查找写入位置，更新 key-value。事务提交时，写请求包括 B+ tree 重平衡、分裂、持久化 dirty page、持久化 freelist、持久化 meta page 流程。同时，dirty page 分布位置可能分散，这里是随机写磁盘 I/O。</p><h3 id=leveldb>leveldb</h3><p>github 链接：<a href=https://github.com/google/leveldb>https://github.com/google/leveldb</a> 和 <a href=https://github.com/syndtr/goleveldb>https://github.com/syndtr/goleveldb</a></p><p>写多读少最简单的自然就是通过写内存最快，但是内存空间有限，无法支撑大容量的数据存储，且不持久化数据会丢失。</p><p>可以通过将数据顺序追加到文件末尾（AOF）来提升写速度。<a href=https://en.wikipedia.org/wiki/Bitcask>Bitcask</a>存储模型就是采用 AOF 模式，把写请求顺序追加到文件。Facebook 的图片存储<a href=https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Beaver.pdf>Haystack</a>也是使用类似的方案来解决大规模写入痛点。</p><p><a href=https://en.wikipedia.org/wiki/Bitcask>Bitcask</a>存储模型通过内存哈希表维护各个 key-value 数据的索引，实现了快速查找 key-value 数据。虽然内存只保存 key 索引信息，但是当 key 较多时对内存要求依然较高。</p><p>leveldb 是基于 LSM tree(log-structured merge-tree) 实现的 key-value 存储（架构可参考：<a href=https://microsoft.github.io/MLOS/notebooks/LevelDbTuning/>https://microsoft.github.io/MLOS/notebooks/LevelDbTuning/</a>），提升写性能的核心思路同样是将随机写转化为顺序写磁盘 WAL 文件和内存。</p><h2 id=读写流程>读写流程</h2><p>写流程：</p><ul><li>client 通过 curl 发送 HTTP PUT 请求到 server；</li><li>server 收到后，将消息写入到 KVStore 的 ProposeC 管道；</li><li>raftNode 循环逻辑将消息通过 Raft 模块的 Propose 接口提交；</li><li>Raft 模块输出 Ready 结构，server 将日志条目持久化后，并发送给其他节点；</li><li>集群多数节点持久化此日志条目后，这个日志条目被提交给存储状态机 KVStore 执行；</li><li>KVStore 根据启动的 backend 存储引擎名称，调用对应的 Put 接口即可。
<img src=../imgs/raft_sourcecode20220904_8.png alt=raft_sourcecode20220904_8.png></li></ul><p>读流程：</p><ul><li>client 通过 curl 发送 HTTP Get 请求到 server；</li><li>server 收到后，根据 KVStore 的存储引擎，从后端查询出对应的 key-value 数据。
<img src=../imgs/raft_sourcecode20220904_9.png alt=raft_sourcecode20220904_9.png></li></ul><h1 id=总结>总结</h1><ol><li>etcd 中的 raft 是作为一个 library 被使用的。这个库仅仅实现了对应的 raft 算法；</li><li>etcd-raft 这种实现的过程，其中的 step 和 tick 被设计成了函数指针，根据不同的角色来防止不同的函数；</li><li>为了防止出现网络分区 Term 数值变得很大的场景，引入了 PreCandidate；</li><li>etcd 中所有的数据都是通过 Leader 分发到 Follower，通过日志的复制确认机制，保证绝大多数的 Follower 都能同步到消息。</li></ol><h1 id=reference>Reference</h1><p><a href=https://blog.betacat.io/post/raft-implementation-in-etcd/>Raft 在 etcd 中的实现</a></p><p><a href=https://www.codedump.info/post/20180922-etcd-raft/>etcd Raft库解析</a></p><p><a href=https://github.com/lichuang/etcd-3.1.10-codedump>etcd Raft 源码注释解析</a></p><p><a href=https://www.cnblogs.com/ricklz/p/15155095.html>etcd学习(6)-etcd实现raft源码解读</a></p><p>《etcd技术内幕》</p><p><a href=https://zhuanlan.zhihu.com/p/91314329>raftexample 源码解读</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3e6b3129369c76f5da7c1d42173a1586>7 - 分布式锁实现及方案比较</h1><h1 id=背景>背景</h1><p>单机中可以利用语言自身提供的能力或者借助第三方包来实现对资源的安全并发访问。随着微服务的流行，各种服务都慢慢演变成了分布式架构，部署在不同机器上。这样会使得一些资源在共享上也需要保证安全性问题，需要用到特殊的锁——分布式锁。</p><h1 id=实现方案>实现方案</h1><h2 id=数据库方案>数据库方案</h2><h3 id=数据表简单分布式锁><strong>数据表简单分布式锁</strong></h3><p>基于数据库来实现分布式锁需要依赖一张数据表，表结构如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a90d91>CREATE</span> <span style=color:#a90d91>TABLE</span> <span style=color:#000>`</span><span style=color:#000>methodLock</span><span style=color:#000>`</span> (
</span></span><span style=display:flex><span><span style=color:#000>`</span><span style=color:#000>id</span><span style=color:#000>`</span> <span style=color:#a90d91>int</span>(<span style=color:#1c01ce>11</span>) <span style=color:#a90d91>NOT</span> <span style=color:#a90d91>NULL</span> <span style=color:#000>AUTO_INCREMENT</span> <span style=color:#a90d91>COMMENT</span> <span style=color:#c41a16>&#39;Primary Key&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#000>`</span><span style=color:#000>method_name</span><span style=color:#000>`</span> <span style=color:#a90d91>varchar</span>(<span style=color:#1c01ce>64</span>) <span style=color:#a90d91>NOT</span> <span style=color:#a90d91>NULL</span> <span style=color:#a90d91>DEFAULT</span> <span style=color:#c41a16>&#39;&#39;</span> <span style=color:#a90d91>COMMENT</span> <span style=color:#c41a16>&#39;Locked Method Name&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#000>`</span><span style=color:#a90d91>desc</span><span style=color:#000>`</span> <span style=color:#a90d91>varchar</span>(<span style=color:#1c01ce>1024</span>) <span style=color:#a90d91>NOT</span> <span style=color:#a90d91>NULL</span> <span style=color:#a90d91>DEFAULT</span> <span style=color:#c41a16>&#39;Note Information&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#000>`</span><span style=color:#000>update_time</span><span style=color:#000>`</span> <span style=color:#a90d91>timestamp</span> <span style=color:#a90d91>NOT</span> <span style=color:#a90d91>NULL</span> <span style=color:#a90d91>DEFAULT</span> <span style=color:#a90d91>CURRENT_TIMESTAMP</span> <span style=color:#a90d91>ON</span> <span style=color:#a90d91>UPDATE</span> <span style=color:#a90d91>CURRENT_TIMESTAMP</span> <span style=color:#a90d91>COMMENT</span> <span style=color:#c41a16>&#39;save data time, automatic generation&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#a90d91>PRIMARY</span> <span style=color:#a90d91>KEY</span> (<span style=color:#000>`</span><span style=color:#000>id</span><span style=color:#000>`</span>),
</span></span><span style=display:flex><span><span style=color:#a90d91>UNIQUE</span> <span style=color:#a90d91>KEY</span> <span style=color:#000>`</span><span style=color:#000>uidx_method_name</span><span style=color:#000>`</span>(<span style=color:#000>`</span><span style=color:#000>method_name</span><span style=color:#000>`</span>) <span style=color:#a90d91>USING</span> <span style=color:#000>BTREE</span>) <span style=color:#000>ENGINE</span> <span style=color:#000>=</span> <span style=color:#000>InnoDB</span> <span style=color:#a90d91>DEFAULT</span> <span style=color:#000>CHARSET</span> <span style=color:#000>=</span> <span style=color:#000>utf8</span> <span style=color:#a90d91>COMMENT</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;method in lock&#39;</span>;
</span></span></code></pre></td></tr></table></div></div></div><p>对方法“method_A”添加锁时，可以采用下面的SQL语句往上表中插入一条记录<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a90d91>insert</span> <span style=color:#a90d91>into</span> <span style=color:#000>methodLock</span>(<span style=color:#000>method_name</span>,<span style=color:#a90d91>desc</span>) <span style=color:#a90d91>values</span> (<span style=color:#000>‘</span><span style=color:#000>method_A</span><span style=color:#c41a16>&#39;,‘desc&#39;</span>)
</span></span></code></pre></td></tr></table></div></div></div></p><p>因为数据表在method_name字段上创建了唯一索引，如果同时有多个插入请求提交，数据库会保证只会有一条记录插入成功。这样就可以认为插入记录成功的这个线程获取到了分布式锁，它可以执行后续的方法逻辑。
当方法执行完成后，需要执行下面的SQL语句来释放锁</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a90d91>delete</span> <span style=color:#a90d91>from</span> <span style=color:#000>methodLock</span> <span style=color:#a90d91>where</span> <span style=color:#000>method_name</span> <span style=color:#000>=</span><span style=color:#c41a16>&#39;method_A&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>上面利用数据库表简单实现了分布式锁的获取和释放，但是其存在多方面的问题：</p><ul><li><p><strong>对数据库是强依赖，存在单点问题，一旦数据库挂起，业务系统将不可用</strong></p></li><li><p><strong>没有失效时间，一旦释放锁操作失败，将会一直持有锁，导致其他线程无法获取到锁</strong></p></li><li><p><strong>非阻塞式，因为插入操作一旦失败数据库会直接返回错误信息，线程未获取到锁也不会进入等待重试队列，要再次获取锁，需要再次触发插入操作</strong></p></li><li><p><strong>非可重入锁，同一线程在未释放锁前无法再次获取该锁，因为数据表中的数据已经存在了</strong></p></li><li><p><strong>非公平锁，所有等待锁的线程会同时争抢锁，最终谁能够获取到锁，就要看谁比较幸运数据能够插入成功</strong>
当然，上述几个问题也有相应的解决方案</p></li><li><p><strong>数据库单点？可以建立数据库集群，在集群间进行数据同步，一旦主库挂掉，可以快速切到备库，保证分布式锁服务可用</strong></p></li><li><p><strong>没有失效时间？只需要额外建立一个定时任务，定时清理超时数据</strong></p></li><li><p><strong>非阻塞？可以通过while循环，在代码中添加重试逻辑，直到获取锁成功</strong></p></li><li><p><strong>不可重入？在数据库中添加一个字段，记录当前获取到锁的主机和线程信息，下一次在获取锁前，先查询这个字段的信息，如果与当前获取锁的线程信息一致，则可以直接为该线程返回锁</strong></p></li><li><p><strong>不公平？我们可以创建一张中间表来记录所有获取锁的线程，这张表就充当了队列的作用，按照插入时间排序，只有排在第一位的线程有机会获取锁</strong></p></li></ul><h3 id=数据库排他锁分布式锁><strong>数据库排他锁分布式锁</strong></h3><p>除了可以通过增删操作数据表中的记录以外，其实还可以借助数据中自带的锁来实现分布式锁。</p><p>仍然借助上面创建的数据表，在MySQL数据库的InnoDB引擎模式下，可以通过下面的方法来实现分布式锁操作，伪代码如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>lock</span><span style=color:#000>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#000>connection</span><span style=color:#000>.</span><span style=color:#836c28>setAutoCommit</span><span style=color:#000>(</span><span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>while</span><span style=color:#000>(</span><span style=color:#a90d91>true</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>select</span> <span style=color:#000>*</span> <span style=color:#000>from</span> <span style=color:#000>methodLock</span> <span style=color:#000>where</span> <span style=color:#000>method_name</span><span style=color:#000>=</span><span style=color:#000>xxx</span> <span style=color:#a90d91>for</span> <span style=color:#000>update</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span><span style=color:#000>(</span><span style=color:#000>result</span><span style=color:#000>==</span><span style=color:#a90d91>null</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span><span style=color:#a90d91>catch</span><span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>sleep</span><span style=color:#000>(</span><span style=color:#000>1000</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>在查询语句后面添加“for update”语句，数据库会在查询过程中向数据库表添加独占锁，其他线程就无法再对这行记录加锁了。
我们可以假定一个线程获取了独占锁就获取了分布式锁，获取到锁以后，就可以执行后续业务逻辑。使用这种方式要注意进行事务的手动管理，在事务提交前执行业务逻辑，执行完成后手动提交事务来释放锁。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>unlock</span><span style=color:#000>(){</span> <span style=color:#000>connection</span><span style=color:#000>.</span><span style=color:#836c28>commit</span><span style=color:#000>();</span> <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>通过上面的这种方式可以高效解决上面提到的解锁和阻塞锁的问题。
针对解锁问题，在获取锁以后，如果服务突然宕机，不用担心锁不会释放，数据库连接会在在服务宕机后自动断开并释放锁。</p><p>针对阻塞问题，采用for update语句，其会保持阻塞状态，在成功执行或者执行失败后立即返回。</p><p>上述方案虽然解决了阻塞和解锁问题，但是数据库的单点、可重入、公平锁等问题仍需要进行额外处理。</p><h3 id=小结><strong>小结</strong></h3><p>基于数据库实现分布式锁都依赖于一个数据库表。一种是通过表中记录的存在来确定当前是否存在锁，另一种是通过数据库的排他锁来实现分布式锁。</p><p>优点就是简单明了，容易理解；缺点也很明显，为了实现一个功能完善的分布式锁，需要一堆额外的优化措施，使得整个方案变得愈加复杂，同时操作数据库需要一定的开销，性能问题不容忽视。</p><h2 id=redis方案>redis方案</h2><p>setnx对应api有诸如setIfAbsent(key)</p><p>可能存在死锁，如果处理的线程抛出异常无法释放锁</p><p>setnx expire增加超时时间</p><p>redis实现分布式锁主要使用setnx这个命令实现，该命令的语义为如果该键不存在就设置该键的值，保证只有一个客户端能设置成功。</p><h3 id=实现1><strong>实现1</strong></h3><p>加锁：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>setnx key value；
</span></span><span style=display:flex><span>expire key expireTime;
</span></span></code></pre></td></tr></table></div></div></div><p>解锁：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>delete key
</span></span></code></pre></td></tr></table></div></div></div></p><p>问题：setnx执行成功，而expire失败后机器宕机，会导致锁永远无法被释放。该方案基本不会被使用。</p><h3 id=实现2><strong>实现2</strong></h3><p>redis从2.6.12版本开始，SET命令开始支持超时参数，并且保证整个操作是原子的。</p><p>加锁:</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>SET key value NX PX expireMillSeconds
</span></span></code></pre></td></tr></table></div></div></div><p>解锁:<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>delete key
</span></span></code></pre></td></tr></table></div></div></div></p><p>问题:
1、持有锁的线程挂掉后，其他线程必须等待锁超时失效后才能重新争抢；</p><p>2、不能保证删除锁的线程是锁的拥有者。</p><h3 id=实现3><strong>实现3</strong></h3><p>加锁:</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>tryLock</span><span style=color:#000>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>SET</span> <span style=color:#000>key</span> <span style=color:#000>expireTime</span> <span style=color:#000>NX</span> <span style=color:#000>PX</span> <span style=color:#000>expireMillSeconds</span> <span style=color:#000>是否成功</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Date</span> <span style=color:#000>expireTime</span> <span style=color:#000>=</span> <span style=color:#000>get</span><span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>expireTime</span> <span style=color:#000>&lt;</span> <span style=color:#000>currentTime</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>cas</span> <span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>,</span><span style=color:#000>expireTime</span><span style=color:#000>,</span><span style=color:#000>currentExpireTime</span> <span style=color:#000>是否成功</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>else</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>解锁:<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>delete key
</span></span></code></pre></td></tr></table></div></div></div></p><p>问题:不能保证删除锁的线程是锁的拥有者。</p><h3 id=实现4-防盗抢><strong>实现4（防盗抢）</strong></h3><p>加锁:</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>SET key value NX PX expireMillSeconds
</span></span></code></pre></td></tr></table></div></div></div><p>value设置为一个独特的token。
解锁:</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>compareAndDelete<span style=color:#000>(</span>key, token<span style=color:#000>)</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=小结-1><strong>小结</strong></h3><p>redis实现的原理是通过一致性哈希将不同key的散列到不同的机器进行处理，最终也是由master处理写。</p><p>redis实现的分布式锁性能最优，缺点是超时时间的设定比较困难。</p><p>如果需要保证只有锁的持有者才能释放锁，建议使用方案实现4，否则使用方案实现3，实现3可以减少锁持有者宕机后其他线程的等待时间。</p><h2 id=redisson方案>redisson方案</h2><h3 id=背景-1>背景</h3><p>redis实现分布式锁存在的问题, 为了解决redis单点问题, 我们会部署redis集群, 在Sentinel集群中, 主节点突然挂掉了。同时主节点中有把锁还没有来得及同步到从节点。这样就会导致系统中同样一把锁被两个客户端同时持有, 不安全性由此产生。redis官方为了解决这个问题, 推出了Redlock算法解决这个问题。但是带来的网络消耗较大。</p><h3 id=简介>简介</h3><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p><h3 id=实现>实现</h3><p>分布式锁的redisson实现: </p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependency&gt;</span> 
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;groupId&gt;</span>org.redisson<span style=color:#000>&lt;/groupId&gt;</span> 
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;artifactId&gt;</span>redisson<span style=color:#000>&lt;/artifactId&gt;</span> 
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;version&gt;</span>3.6.5<span style=color:#000>&lt;/version&gt;</span> 
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>获取锁释放锁</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// 程序化配置
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>Config</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>config</span><span style=color:#000>();</span> 
</span></span><span style=display:flex><span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>useSingleServer</span><span style=color:#000>().</span><span style=color:#836c28>setAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34; redis://127.0.0.1:6379&#34;</span><span style=color:#000>).</span><span style=color:#836c28>setDatabase</span><span style=color:#000>(</span><span style=color:#000>0</span><span style=color:#000>);</span> 
</span></span><span style=display:flex><span><span style=color:#000>Redisson</span> <span style=color:#000>redisson</span><span style=color:#000>=</span> <span style=color:#000>(</span><span style=color:#000>Redisson</span><span style=color:#000>)</span><span style=color:#000>Redisson</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span> 
</span></span><span style=display:flex><span><span style=color:#000>RLockmylock</span> <span style=color:#000>=</span> <span style=color:#000>redisson</span><span style=color:#000>.</span><span style=color:#836c28>getLock</span><span style=color:#000>(</span><span style=color:#000>key</span><span style=color:#000>);</span> 
</span></span><span style=display:flex><span><span style=color:#177500>// 获取锁mylock.TockC; …资源操作
</span></span></span><span style=display:flex><span><span style=color:#177500>// 释放锁mylock.unlock(); 
</span></span></span><span style=display:flex><span><span style=color:#177500>// 文件方式配置
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>Config</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#000>Config</span><span style=color:#000>.</span><span style=color:#836c28>fromJSON</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>File</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;config-file.json&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#000>RedissonClient</span> <span style=color:#000>redisson</span> <span style=color:#000>=</span> <span style=color:#000>Redisson</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#177500>// yaml配置
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>Config</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#000>Config</span><span style=color:#000>.</span><span style=color:#836c28>fromYAML</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>File</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;config-file.yaml&#34;</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span><span style=color:#000>RedissonClient</span> <span style=color:#000>redisson</span> <span style=color:#000>=</span> <span style=color:#000>Redisson</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>集群模式<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Config</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Config</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>useClusterServers</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span>   <span style=color:#000>.</span><span style=color:#836c28>setScanInterval</span><span style=color:#000>(</span><span style=color:#000>2000</span><span style=color:#000>)</span> <span style=color:#177500>// 集群状态扫描间隔时间，单位是毫秒
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#177500>//可以用&#34;rediss://&#34;来启用SSL连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>.</span><span style=color:#836c28>addNodeAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;redis://127.0.0.1:7000&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;redis://127.0.0.1:7001&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>.</span><span style=color:#836c28>addNodeAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;redis://127.0.0.1:7002&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#000>RedissonClient</span> <span style=color:#000>redisson</span> <span style=color:#000>=</span> <span style=color:#000>Redisson</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>主从模式</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Config</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Config</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>useMasterSlaveServers</span><span style=color:#000>()</span>
</span></span><span style=display:flex><span>   <span style=color:#177500>//可以用&#34;rediss://&#34;来启用SSL连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>   <span style=color:#000>.</span><span style=color:#836c28>setMasterAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;redis://127.0.0.1:6379&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>.</span><span style=color:#836c28>addSlaveAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;redis://127.0.0.1:6389&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;redis://127.0.0.1:6332&#34;</span><span style=color:#000>,</span> <span style=color:#c41a16>&#34;redis://127.0.0.1:6419&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>.</span><span style=color:#836c28>addSlaveAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;redis://127.0.0.1:6399&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>RedissonClient</span> <span style=color:#000>redisson</span> <span style=color:#000>=</span> <span style=color:#000>Redisson</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>使用：</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>RedissonLock</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>RedissonClient</span> <span style=color:#000>redissonClient</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>static</span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Config</span> <span style=color:#000>config</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Config</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>config</span><span style=color:#000>.</span><span style=color:#836c28>useSingleServer</span><span style=color:#000>().</span><span style=color:#836c28>setAddress</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;redis://127.0.0.1:6379&#34;</span><span style=color:#000>).</span><span style=color:#836c28>setPassword</span><span style=color:#000>(</span><span style=color:#a90d91>null</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>//			config.useSingleServer().setAddress(&#34;redis://192.168.188.4:6380&#34;).setPassword(&#34;ty3foGTrNiKi&#34;);
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>redissonClient</span> <span style=color:#000>=</span> <span style=color:#000>Redisson</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#000>RedissonClient</span> <span style=color:#000>getRedisson</span><span style=color:#000>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span> <span style=color:#000>redissonClient</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#000>{</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  	<span style=color:#000>RLock</span> <span style=color:#000>fairLock</span> <span style=color:#000>=</span> <span style=color:#000>getRedisson</span><span style=color:#000>().</span><span style=color:#836c28>getLock</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;TEST_KEY&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>fairLock</span><span style=color:#000>.</span><span style=color:#836c28>toString</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>//		fairLock.lock(); 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#177500>// 尝试加锁，最多等待10秒，上锁以后10秒自动解锁
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#a90d91>boolean</span> <span style=color:#000>res</span> <span style=color:#000>=</span> <span style=color:#000>fairLock</span><span style=color:#000>.</span><span style=color:#836c28>tryLock</span><span style=color:#000>(</span><span style=color:#000>10</span><span style=color:#000>,</span> <span style=color:#000>10</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>SECONDS</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>res</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>fairLock</span><span style=color:#000>.</span><span style=color:#836c28>unlock</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	
</span></span><span style=display:flex><span>  	<span style=color:#177500>//有界阻塞队列
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#000>RBoundedBlockingQueue</span><span style=color:#000>&lt;</span><span style=color:#000>JSONObject</span><span style=color:#000>&gt;</span> <span style=color:#000>queue</span> <span style=color:#000>=</span> <span style=color:#000>getRedisson</span><span style=color:#000>().</span><span style=color:#836c28>getBoundedBlockingQueue</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;anyQueue&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#177500>// 如果初始容量（边界）设定成功则返回`真（true）`，
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#177500>// 如果初始容量（边界）已近存在则返回`假（false）`。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>trySetCapacity</span><span style=color:#000>(</span><span style=color:#000>10</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>JSONObject</span> <span style=color:#000>o</span><span style=color:#000>=</span><span style=color:#a90d91>new</span> <span style=color:#000>JSONObject</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>o</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;name&#34;</span><span style=color:#000>,</span> <span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#a90d91>if</span><span style=color:#000>(!</span><span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>contains</span><span style=color:#000>(</span><span style=color:#000>o</span><span style=color:#000>)){</span>
</span></span><span style=display:flex><span>  		<span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>offer</span><span style=color:#000>(</span><span style=color:#000>o</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>}</span>
</span></span><span style=display:flex><span>  	
</span></span><span style=display:flex><span>  	<span style=color:#000>JSONObject</span> <span style=color:#000>o2</span><span style=color:#000>=</span><span style=color:#a90d91>new</span> <span style=color:#000>JSONObject</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>o2</span><span style=color:#000>.</span><span style=color:#836c28>put</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;name&#34;</span><span style=color:#000>,</span> <span style=color:#000>2</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#177500>// 此时容量已满，下面代码将会被阻塞，直到有空闲为止。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	
</span></span><span style=display:flex><span>  	<span style=color:#a90d91>if</span><span style=color:#000>(!</span><span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>contains</span><span style=color:#000>(</span><span style=color:#000>o2</span><span style=color:#000>)){</span>
</span></span><span style=display:flex><span>  		<span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>offer</span><span style=color:#000>(</span><span style=color:#000>o2</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>}</span>
</span></span><span style=display:flex><span>  	
</span></span><span style=display:flex><span>  	<span style=color:#177500>//  获取但不移除此队列的头；如果此队列为空，则返回 null。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#000>JSONObject</span> <span style=color:#000>obj</span> <span style=color:#000>=</span> <span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>peek</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	<span style=color:#177500>//获取并移除此队列的头部，在指定的等待时间前等待可用的元素（如果有必要）。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	<span style=color:#000>JSONObject</span> <span style=color:#000>ob</span> <span style=color:#000>=</span> <span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>poll</span><span style=color:#000>(</span><span style=color:#000>10</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span><span style=color:#000>.</span><span style=color:#836c28>MINUTES</span><span style=color:#000>);</span>                                                    
</span></span><span style=display:flex><span>  	
</span></span><span style=display:flex><span>  	<span style=color:#177500>//获取并移除此队列的头，如果此队列为空，则返回 null。
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  	 <span style=color:#000>Iterator</span><span style=color:#000>&lt;</span><span style=color:#000>JSONObject</span><span style=color:#000>&gt;</span> <span style=color:#000>iterator</span><span style=color:#000>=</span><span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>iterator</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	 <span style=color:#a90d91>while</span> <span style=color:#000>(</span><span style=color:#000>iterator</span><span style=color:#000>.</span><span style=color:#836c28>hasNext</span><span style=color:#000>()){</span>
</span></span><span style=display:flex><span>  		  <span style=color:#000>JSONObject</span> <span style=color:#000>i</span> <span style=color:#000>=</span><span style=color:#000>iterator</span><span style=color:#000>.</span><span style=color:#836c28>next</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	      <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>i</span><span style=color:#000>.</span><span style=color:#836c28>toJSONString</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  	      <span style=color:#000>iterator</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	    
</span></span><span style=display:flex><span>  	  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  		<span style=color:#a90d91>while</span><span style=color:#000>(</span><span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>size</span><span style=color:#000>()&gt;</span><span style=color:#000>0</span><span style=color:#000>){</span>
</span></span><span style=display:flex><span>  			<span style=color:#000>JSONObject</span> <span style=color:#000>obs</span> <span style=color:#000>=</span> <span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>poll</span><span style=color:#000>();</span>     
</span></span><span style=display:flex><span>  			<span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>obs</span><span style=color:#000>.</span><span style=color:#836c28>toJSONString</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  		<span style=color:#000>}</span>
</span></span><span style=display:flex><span>  	
</span></span><span style=display:flex><span>  	<span style=color:#000>JSONObject</span> <span style=color:#000>someObj</span> <span style=color:#000>=</span> <span style=color:#000>queue</span><span style=color:#000>.</span><span style=color:#836c28>poll</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>  	<span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>someObj</span><span style=color:#000>.</span><span style=color:#836c28>toJSONString</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=zookeeper方案>zookeeper方案</h2><h3 id=基础知识>基础知识</h3><p>基于ZooKeeper，是使用它的临时有序节点来实现的分布式锁。</p><p>节点类型：</p><p>1、<strong>持久节点</strong>：创建后一直存在，直到主动删除；</p><p>2、<strong>临时节点</strong>：临时节点的生命周期和客户端会话绑定，客户端节点失效后，这个节点会自动被清除；</p><p>3、<strong>持久顺序节点</strong>：基本特性和持久节点一致，只是在创建节点时路径名后面增加一个自增的数字后缀；数字后缀的值记录在父节点的一个4bytes的字段中。</p><p>4、<strong>临时顺序节点</strong>：基本特性同临时节点，同样节点路径名带有自增数字。</p><h3 id=实现原理>实现原理</h3><p>加锁流程:</p><p>1、创建永久节点如 resourcex 代表争抢的资源；</p><p>2、所有想获取锁的客户端都到 resourcex 目录下创建临时顺序节点；</p><p>3、客户端获取当前目录下所有子节点，判断自己的节点是否位于子节点第一个；</p><p>4、如果是第一个，则获取到锁，返回成功；</p><p>5、如果不是第一个，则说明前面已经有客户端获取到锁了，那么需要获取自己节点的前一个节点，并监听前一个节点的状态，当监听到前一个节点被删除后返回步骤3。</p><p>解锁的流程:</p><p>删除当前客户端注册的临时节点即可。</p><p>锁超时：</p><p>Zookeeper不需要配置锁超时，创建临时节点的客户端维护着一个和服务端的session，服务端通过session判断客户端是否在线，当客户端机器宕机时，服务端会删除对应的临时节点。</p><h3 id=原生使用>原生使用</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.huangbo</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.apache.zookeeper.*</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>org.apache.zookeeper.data.Stat</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.List</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.TreeSet</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.locks.Condition</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.locks.Lock</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ZkLock</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Lock</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>ZooKeeper</span> <span style=color:#000>zk</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>root</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;/locks&#34;</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>lockName</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 当前线程创建的序列node
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>private</span> <span style=color:#000>ThreadLocal</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>nodeId</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ThreadLocal</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 用来同步等待zkclient连接到了服务端
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>private</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>connectedSignal</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#000>(</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>int</span> <span style=color:#000>sessionTimeout</span> <span style=color:#000>=</span> <span style=color:#000>3000</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>data</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#a90d91>byte</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>];</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>ZkLock</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>config</span><span style=color:#000>,</span> <span style=color:#000>String</span> <span style=color:#000>lockName</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>lockName</span> <span style=color:#000>=</span> <span style=color:#000>lockName</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>zk</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ZooKeeper</span><span style=color:#000>(</span><span style=color:#000>config</span><span style=color:#000>,</span> <span style=color:#000>sessionTimeout</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>Watcher</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>process</span><span style=color:#000>(</span><span style=color:#000>WatchedEvent</span> <span style=color:#000>event</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#177500>//建立连接
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>event</span><span style=color:#000>.</span><span style=color:#836c28>getState</span><span style=color:#000>()</span> <span style=color:#000>==</span> <span style=color:#000>Event</span><span style=color:#000>.</span><span style=color:#836c28>KeeperState</span><span style=color:#000>.</span><span style=color:#836c28>SyncConnected</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>connectedSignal</span><span style=color:#000>.</span><span style=color:#836c28>countDown</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>});</span>
</span></span><span style=display:flex><span>            <span style=color:#000>connectedSignal</span><span style=color:#000>.</span><span style=color:#836c28>await</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Stat</span> <span style=color:#000>stat</span> <span style=color:#000>=</span> <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>exists</span><span style=color:#000>(</span><span style=color:#000>root</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>null</span> <span style=color:#000>==</span> <span style=color:#000>stat</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>root</span><span style=color:#000>,</span> <span style=color:#000>data</span><span style=color:#000>,</span> <span style=color:#000>ZooDefs</span><span style=color:#000>.</span><span style=color:#836c28>Ids</span><span style=color:#000>.</span><span style=color:#836c28>OPEN_ACL_UNSAFE</span><span style=color:#000>,</span> <span style=color:#000>CreateMode</span><span style=color:#000>.</span><span style=color:#836c28>PERSISTENT</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>RuntimeException</span><span style=color:#000>(</span><span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 添加watch监听临时顺序节点的删除
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>class</span> <span style=color:#3f6e75>LockWatcher</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Watcher</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>private</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#000>LockWatcher</span><span style=color:#000>(</span><span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>latch</span> <span style=color:#000>=</span> <span style=color:#000>latch</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>process</span><span style=color:#000>(</span><span style=color:#000>WatchedEvent</span> <span style=color:#000>event</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>lock</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 创建临时节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>String</span> <span style=color:#000>myNode</span> <span style=color:#000>=</span> <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>root</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;/&#34;</span> <span style=color:#000>+</span> <span style=color:#000>lockName</span><span style=color:#000>,</span> <span style=color:#000>data</span><span style=color:#000>,</span> <span style=color:#000>ZooDefs</span><span style=color:#000>.</span><span style=color:#836c28>Ids</span><span style=color:#000>.</span><span style=color:#836c28>OPEN_ACL_UNSAFE</span><span style=color:#000>,</span> <span style=color:#000>CreateMode</span><span style=color:#000>.</span><span style=color:#836c28>EPHEMERAL_SEQUENTIAL</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>Thread</span><span style=color:#000>.</span><span style=color:#836c28>currentThread</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#000>myNode</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;created&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 取出所有子节点
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>subNodes</span> <span style=color:#000>=</span> <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>getChildren</span><span style=color:#000>(</span><span style=color:#000>root</span><span style=color:#000>,</span> <span style=color:#a90d91>false</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>TreeSet</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>sortedNodes</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>TreeSet</span><span style=color:#000>&lt;&gt;();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>node</span> <span style=color:#000>:</span> <span style=color:#000>subNodes</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sortedNodes</span><span style=color:#000>.</span><span style=color:#836c28>add</span><span style=color:#000>(</span><span style=color:#000>root</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;/&#34;</span> <span style=color:#000>+</span> <span style=color:#000>node</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>smallNode</span> <span style=color:#000>=</span> <span style=color:#000>sortedNodes</span><span style=color:#000>.</span><span style=color:#836c28>first</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>myNode</span><span style=color:#000>.</span><span style=color:#836c28>equals</span><span style=color:#000>(</span><span style=color:#000>smallNode</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#177500>// 如果是最小的节点，则表示取得锁
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>Thread</span><span style=color:#000>.</span><span style=color:#836c28>currentThread</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#000>myNode</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;get lock&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>nodeId</span><span style=color:#000>.</span><span style=color:#836c28>set</span><span style=color:#000>(</span><span style=color:#000>myNode</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>return</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>preNode</span> <span style=color:#000>=</span> <span style=color:#000>sortedNodes</span><span style=color:#000>.</span><span style=color:#836c28>lower</span><span style=color:#000>(</span><span style=color:#000>myNode</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#000>(</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Stat</span> <span style=color:#000>stat</span> <span style=color:#000>=</span> <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>exists</span><span style=color:#000>(</span><span style=color:#000>preNode</span><span style=color:#000>,</span> <span style=color:#a90d91>new</span> <span style=color:#000>LockWatcher</span><span style=color:#000>(</span><span style=color:#000>latch</span><span style=color:#000>));</span> <span style=color:#177500>// 同时注册监听
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// 判断比自己小一个数的节点是否存在，如果不存在则无需等待锁，同时注册监听
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>stat</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>Thread</span><span style=color:#000>.</span><span style=color:#836c28>currentThread</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#000>myNode</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; waiting for &#34;</span> <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>root</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;/&#34;</span> <span style=color:#000>+</span> <span style=color:#000>preNode</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34; released lock&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>latch</span><span style=color:#000>.</span><span style=color:#836c28>wait</span><span style=color:#000>();</span> <span style=color:#177500>// 等待，这里应该一直等待其他线程释放锁
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>nodeId</span><span style=color:#000>.</span><span style=color:#836c28>set</span><span style=color:#000>(</span><span style=color:#000>myNode</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>latch</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>RuntimeException</span><span style=color:#000>(</span><span style=color:#000>e</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>lockInterruptibly</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>tryLock</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>tryLock</span><span style=color:#000>(</span><span style=color:#a90d91>long</span> <span style=color:#000>time</span><span style=color:#000>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>false</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>unlock</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>Thread</span><span style=color:#000>.</span><span style=color:#836c28>currentThread</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;unlock &#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#a90d91>null</span> <span style=color:#000>!=</span> <span style=color:#000>nodeId</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>zk</span><span style=color:#000>.</span><span style=color:#836c28>delete</span><span style=color:#000>(</span><span style=color:#000>nodeId</span><span style=color:#000>.</span><span style=color:#836c28>get</span><span style=color:#000>(),</span> <span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>nodeId</span><span style=color:#000>.</span><span style=color:#836c28>remove</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>printStackTrace</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>KeeperException</span> <span style=color:#000>e</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#836c28>printStackTrace</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Condition</span> <span style=color:#000>newCondition</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=小结-2><strong>小结</strong></h3><p>zk实现的原理主要是ZAB协议控制所有写请求都转发到leader节点执行，以保证新建节点的唯一性。zk实现的分布式锁可用性较高，实现简单，自动锁释放，缺点是创建和删除节点的性能较差。zk分布式锁对于锁的qps和锁数量都有一定的要求，在锁QPS超过100或者锁的数量超过50万，建议不要使用基于ZK的分布式锁，应寻求其他分布式锁方案。</p><h1 id=方案比较>方案比较</h1><table><thead><tr><th style=text-align:left></th><th style=text-align:left>mysql</th><th style=text-align:left>redis</th><th style=text-align:left>redisson</th><th style=text-align:left>zookeeper</th></tr></thead><tbody><tr><td style=text-align:left>实现复杂度</td><td style=text-align:left>复杂</td><td style=text-align:left>简单</td><td style=text-align:left>简单</td><td style=text-align:left>简单</td></tr><tr><td style=text-align:left>性能</td><td style=text-align:left>3</td><td style=text-align:left>1</td><td style=text-align:left>1</td><td style=text-align:left>2</td></tr><tr><td style=text-align:left>可用性</td><td style=text-align:left>3</td><td style=text-align:left>2</td><td style=text-align:left>2</td><td style=text-align:left>1</td></tr><tr><td style=text-align:left>可重入性</td><td style=text-align:left>需要额外增加字段支持</td><td style=text-align:left>支持</td><td style=text-align:left>支持</td><td style=text-align:left>支持</td></tr><tr><td style=text-align:left>锁超时</td><td style=text-align:left>需要额外增加字段支持</td><td style=text-align:left>支持，超时后失效</td><td style=text-align:left>支持，超时后失效</td><td style=text-align:left>支持，宕机后节点自动失效</td></tr></tbody></table><h2 id=总结>总结</h2><ol><li>mysql方案看起来最简单，但实现过程中的细节较多，性能一般，适用于特别简单或者没有其他方案可选的场景，一般不建议使用该方法。</li><li>redis 性能是最高的，使用场景最多，但可能存在单点问题，要么业务上自己处理，要么使用官方推荐的 RedLock，实际生产中需要注意 redis 多机房带来的锁问题。</li><li>zookeeper 的性能不如 redis，当 qps 高于 100 或锁数量大于 50 万时建议使用redis（性能数据来源于参考文档）。</li></ol><h1 id=reference>Reference</h1><p><a href=https://redis.io/commands/set>https://redis.io/commands/set</a></p><p><a href=https://zookeeper.apache.org/doc/r3.1.2/zookeeperOver.html>Apache zookeeper</a></p><p><a href=https://www.cnblogs.com/zhili/p/redisdistributelock.html>Redis实现分布式锁的正确姿势</a></p><p><a href=https://xiaomi-info.github.io/2019/12/17/redis-distributed-lock>小米-分布式锁的实现之redis篇</a></p><p><a href=https://zhuanlan.zhihu.com/p/100140241>知乎-基于Redis的分布式锁详解</a></p><p><a href=https://juejin.cn/post/6844903830442737671>掘金-基于Redis的分布式锁实现</a></p><p><a href=https://mp.weixin.qq.com/s/64bYwgsb9h87SLQ-aiPvhA>Redisson 分布式锁实战与watch dog机制解读</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-345f73fab4bf2c5b06a1ab1a28636e27>8 - 常见分布式拓扑结构</h1><h1 id=背景>背景</h1><p>分布式架构一般有以下几种结构：</p><ul><li>主从架构</li><li>去中心化架构</li><li>混合型架构</li></ul><h1 id=redis分布式模式>Redis分布式模式</h1><p>Redis一般有两种模式：</p><ul><li>主从模式</li><li>集群模式（Redis Cluster）</li></ul><h2 id=主从模式>主从模式</h2><h3 id=标准主从模式>标准主从模式</h3><p>标准的Redis主从模式，只有 Master 节点接收写入请求，并将写入的数据复制给一个或多个Slave，形成良好的读写分离机制，多个 Slave 可以分担读请求。Redis 主从是标准的分布式中心化思想。</p><p><img src=../imgs/distributed_architecture_1.png alt=distributed_architecture_1.png></p><h3 id=树形主从模式>树形主从模式</h3><p>Redis 应用场景大多是极高并发的内存 I/O，常见应用场景是作为数据库的防护网，防止数据库被击穿，因此标准的主从模式中的 Master 对外既要承担写入，对内又要承担各个节点的复制操作，资源消耗很大，且随着 slave 节点增多问题越发明显。因此又形成主从的一个变形形式。</p><p><img src=../imgs/distributed_architecture_2.png alt=distributed_architecture_2.png></p><h2 id=集群模式>集群模式</h2><p>对于高并发的业务场景，Master 始终是一个隐患。因为 Master 承担着所有的写操作，如果没有HA解决方案一旦宕机，集群将不可用。因此 Redis 社区推出集群方案，主要是为了解决 Master 压力，即集群的分布式无中心模式。</p><p><img src=../imgs/distributed_architecture_3.png alt=distributed_architecture_3.png></p><p>无中心模式采用虚拟槽概念，独立于物理节点。虚拟槽有 0～16383 个，数据会进行 key 的hash计算，确定进入哪个槽位。而物理节点负责哪些虚拟槽，即对应关系可以自行指定。</p><p>每个节点（数据节点）都是<strong>对等节点</strong>。此外，为了高可靠HA，每个节点也可以再演变成 Master 和 Slave 的主从模式部署。</p><h2 id=小结>小结</h2><p>Redis 最成熟的方案还是主从模式，Redis Cluster 带来的性能优势无法抵消去中心化带来的不成熟和不可靠问题，导致人工运维的复杂度和难度。生产中慎用 Redis Cluster。</p><h1 id=kafka>Kafka</h1><h2 id=架构>架构</h2><p><img src=../imgs/distributed_architecture_4.png alt=distributed_architecture_4.png></p><p>Kafka 集群使用 Zookeeper 集群来管理，Broker 的注册发现等都是依靠 zookeeper 来协助完成。每个 Broker 会以一主二从（Leader 和 Follower）的方式均匀分布。</p><p>生产者（Product）从任意节点获取 Meta 信息，找到 Broker 中的 Leader 分区副本，会向里面写分配好的数据，Leader 会向集群中其他 Broker 的 Follower 分区副本复制。</p><h2 id=小结-1>小结</h2><p>Broker 分区信息是分布在每一台 Broker 的 meta 缓存里面，生产者和消费者可以在任意一台 Borker 上获取需要操作的 Leader 分区信息，Kafka 这种设计有点去中心化的意思。但是这些 meta 缓存信息实质是来自 Zookeeper（强依赖），所以本质上 Kafka 依然是中心化管理。</p><h1 id=rocketmq>RocketMQ</h1><h2 id=架构-1>架构</h2><p><img src=../imgs/distributed_architecture_5.png alt=distributed_architecture_5.png></p><p>RocketMQ 总体结构与 Kafka 类似，更适合高并发场景，使用 NameServer 替代了 Zookeeper。</p><p>NameServer 是无中心节点的，都通过锁注册表的方式共享信息。NameServer 是 Broker 的注册表，Broker 新注册或者异常退出，对应的 NameSever 都会感知到。NameServer 增加/删除所辖 Broker 信息到该注册表，并定时读取最新的集群所有broker信息。</p><p>生产者（Producet）连接一个 NameServer，便能获取到想要发送分区数据的 Brokers（消费者同理）。</p><p>每个 Borker 可以再分成主从模式，Master 进行队列操作，Slave 只做数据同步，Master 出现故障时进行替换。</p><h2 id=小结-2>小结</h2><p>NameSever 相对于 Zookeeper 的结构更简单，生产者和消费者对 Broker 以及分区的获取必须来自 NameSever，尽管 NameSever 集群本身是无中心的，但整个 RocketMQ 的 Brokers 是被 NameSever 中心化管理的，但整体上 Product、Consumer、Brokers集群对这种集中管理的依赖程度并不高，只是提供了很简单的 Broker 元信息服务，真正的数据流还是交给各个Broker 自行解决。</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>