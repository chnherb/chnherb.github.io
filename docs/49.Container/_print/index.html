<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/49.Container/><link rel=alternate type=application/rss+xml href=/docs/49.Container/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Container | Herbdocs</title><meta name=description content="Introduction
Docker、Docker Compose等
"><meta property="og:title" content="Container"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/49.Container/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="Container"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Container"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/49.Container/>返回本页常规视图</a>.</p></div><h1 class=title>Container</h1><ul><li>1: <a href=#pg-cb5c6dc0cfd45d6b5f2bb628de225821>01.docker基础版</a></li><li>2: <a href=#pg-b83f5b169855ed2dfd689f0676a70777>20.docker目录</a></li><li>3: <a href=#pg-95c79c407c4c8e9db9da6e562da9557c>21.docker路径修改</a></li><li>4: <a href=#pg-f4c17e11167c018806258fd3fd777977>22.dockerd</a></li><li>5: <a href=#pg-c1880f7042ae36f17ca371e2d8a67f10>51.kubernetes01</a></li><li>6: <a href=#pg-f2bb2d943c5dcee9f88556e6fee4cd01>52.kubernetes02</a></li></ul><div class=content><h1 id=introduction>Introduction</h1><p>Docker、Docker Compose等</p></div></div><div class=td-content><h1 id=pg-cb5c6dc0cfd45d6b5f2bb628de225821>1 - 01.docker基础版</h1><p>官方文档：<a href=https://docs.docker.com>https://docs.docker.com</a></p><h2 id=概述>概述</h2><p><img src=../imgs/docker_basic_1.png alt=docker_basic_1.png></p><h2 id=安装卸载>安装卸载</h2><h3 id=安装>安装</h3><p>CentOS安装：<a href=https://docs.docker.com/engine/install/centos/>https://docs.docker.com/engine/install/centos/</a></p><p><img src=../imgs/docker_basic_2.png alt=docker_basic_2.png></p><p>mac安装：<a href=https://yeasy.gitbook.io/docker_practice/install/mac>https://yeasy.gitbook.io/docker_practice/install/mac</a></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 启动docker</span>
</span></span><span style=display:flex><span>systemctl start docker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># hello-world</span>
</span></span><span style=display:flex><span>docker run hello-world
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看下载的hellow-world镜像</span>
</span></span><span style=display:flex><span>docker images
</span></span></code></pre></td></tr></table></div></div></div><h3 id=卸载>卸载</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 卸载依赖</span>
</span></span><span style=display:flex><span>yum remove docker-ce docker-ce-cli containerd.io
</span></span><span style=display:flex><span><span style=color:#177500># 删除资源，docker的默认工作路径</span>
</span></span><span style=display:flex><span>rm -rf /var/lib/docker  
</span></span></code></pre></td></tr></table></div></div></div><h3 id=run的流程>run的流程</h3><p><img src=../imgs/docker_basic_3.png alt=docker_basic_3.png></p><h3 id=底层原理>底层原理</h3><p>Docker是怎么工作的？</p><p>Docker是一个Client-Server结构的系统，Docker的守护进程运行在主机上。通过socket从客户端访问</p><p>DockerServer接收到Docker-Client的指令，就会执行这个命令</p><p><img src=../imgs/docker_basic_4.png alt=docker_basic_4.png></p><p>Docker为什么比VM快？</p><p>1、Docker有着比虚拟机更少的抽象层</p><p>2、Docker利用的是宿主机的内核，vm需要Guest OS</p><h2 id=heading></h2><h2 id=常用命令>常用命令</h2><p>官方命令文档：<a href=https://docs.docker.com/engine/reference/commandline/info/>https://docs.docker.com/engine/reference/commandline/info/</a></p><h3 id=demo>Demo</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>// 官方demo
</span></span><span style=display:flex><span>docker run -d -p 80:80 docker/getting-started
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// nginx服务器，通过http://localhost访问证明docker已安装成功
</span></span><span style=display:flex><span>docker run -d -p 80:80 --name webserver nginx
</span></span><span style=display:flex><span>docker stop webserver
</span></span><span style=display:flex><span>docker rm webserver
</span></span></code></pre></td></tr></table></div></div></div><h3 id=帮助命令>帮助命令</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker version
</span></span><span style=display:flex><span>docker info 
</span></span><span style=display:flex><span>docker 命令 <span style=color:#a90d91>help</span> <span style=color:#177500># 万能命令</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=镜像命令>镜像命令</h3><p>镜像官方：<a href=https://hub.docker.com/>https://hub.docker.com/</a></p><h4 id=查看镜像-images>查看镜像 images</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker images <span style=color:#177500># 查看所有镜像</span>
</span></span><span style=display:flex><span><span style=color:#177500># REPOSITORY 镜像的仓库源</span>
</span></span><span style=display:flex><span><span style=color:#177500># TAG         镜像的标签</span>
</span></span><span style=display:flex><span><span style=color:#177500># IMAGE ID    镜像的ID</span>
</span></span><span style=display:flex><span><span style=color:#177500># CREATED     镜像的创建时间</span>
</span></span><span style=display:flex><span><span style=color:#177500># SIZE        镜像的大小 </span>
</span></span><span style=display:flex><span><span style=color:#177500># 可选项</span>
</span></span><span style=display:flex><span>-a, -all    <span style=color:#177500># 列出所有镜像</span>
</span></span><span style=display:flex><span>-q, --quiet  <span style=color:#177500># 只显示镜像的ID</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=列出镜像-image-ls>列出镜像 image ls</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker image ls  <span style=color:#177500># 注意：image而不是images。等同docker images</span>
</span></span><span style=display:flex><span><span style=color:#177500># 镜像下载到本地后，展开的大小，准确说，是展开后的各层所占空间的总和.</span>
</span></span><span style=display:flex><span><span style=color:#177500># 列表中的镜像体积总和并非是所有镜像实际硬盘消耗。</span>
</span></span><span style=display:flex><span><span style=color:#177500># 由于 Docker 镜像是多层存储结构，并且可以继承、复用，因此不同镜像可能会因为使用相同的基础镜像，从而拥有共同的层。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker image ls -a <span style=color:#177500># 中间层镜像</span>
</span></span><span style=display:flex><span>docker image ls ubuntu  <span style=color:#177500># 列举部分镜像</span>
</span></span><span style=display:flex><span>docker image ls ubuntu:18.04  <span style=color:#177500># 列举部分镜像</span>
</span></span><span style=display:flex><span><span style=color:#177500># 过滤镜像</span>
</span></span><span style=display:flex><span>docker image ls -f <span style=color:#000>since</span><span style=color:#000>=</span>mongo:3.2
</span></span><span style=display:flex><span>docker image ls -f <span style=color:#000>label</span><span style=color:#000>=</span>com.example.version<span style=color:#000>=</span>0.1  
</span></span></code></pre></td></tr></table></div></div></div><h4 id=搜索镜像-search>搜索镜像 search</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker search 镜像名
</span></span><span style=display:flex><span><span style=color:#177500># 可选项</span>
</span></span><span style=display:flex><span>--filter<span style=color:#000>=</span><span style=color:#000>STARS</span><span style=color:#000>=</span><span style=color:#1c01ce>3000</span> <span style=color:#177500># 搜索出来的镜像STARS大于3000</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=下载镜像-pull>下载镜像 pull</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull 镜像名<span style=color:#000>[</span>:tag<span style=color:#000>]</span>  
</span></span><span style=display:flex><span><span style=color:#177500># 不写tage，默认就是latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 举例</span>
</span></span><span style=display:flex><span>docker pull mysql   
</span></span><span style=display:flex><span><span style=color:#177500># 等价于</span>
</span></span><span style=display:flex><span>docker pull docker.io/library/mysql:latest
</span></span></code></pre></td></tr></table></div></div></div><h4 id=删除镜像>删除镜像</h4><p><strong>注意ID可用短ID，保证不重复即可，完整的ID也称为长ID</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker rmi -f 镜像id <span style=color:#177500># 删除指定镜像</span>
</span></span><span style=display:flex><span>docker image rm 501a <span style=color:#177500># 短id 删除</span>
</span></span><span style=display:flex><span>docker image rm centos   <span style=color:#177500># 镜像名 删除</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker rmi -f <span style=color:#a90d91>$(</span>docker images -aq<span style=color:#a90d91>)</span>  <span style=color:#177500># 删除所有的镜像</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=镜像体积-system-df>镜像体积 system df</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker system df  // 实际占用空间，因为各层复用，实际空间相比较小
</span></span></code></pre></td></tr></table></div></div></div><h4 id=利用commit理解镜像构成>利用commit理解镜像构成</h4><p>参考：<a href=https://yeasy.gitbook.io/docker_practice/image/commit>https://yeasy.gitbook.io/docker_practice/image/commit</a></p><p>入侵后保存现场等.</p><p>不要用作定制镜像，应使用Dockerfile完成</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker <span style=color:#a90d91>exec</span> -it webserver bash
</span></span><span style=display:flex><span>root@3729b97e8226:/# <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#39;</span> &gt; /usr/share/nginx/html/index.html
</span></span><span style=display:flex><span>root@3729b97e8226:/# <span style=color:#a90d91>exit</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>exit</span>
</span></span><span style=display:flex><span>docker diff webserver <span style=color:#177500># 查看具体改动</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker commit <span style=color:#000>[</span>选项<span style=color:#000>]</span> &lt;容器ID或容器名&gt; <span style=color:#000>[</span>&lt;仓库名&gt;<span style=color:#000>[</span>:&lt;标签&gt;<span style=color:#000>]]</span>
</span></span><span style=display:flex><span>docker commit <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--author <span style=color:#c41a16>&#34;Tao Wang &lt;twang2218@gmail.com&gt;&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--message <span style=color:#c41a16>&#34;修改了默认网页&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>webserver <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>nginx:v2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker image ls  <span style=color:#177500># 查看新定制的镜像</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>history</span>  <span style=color:#177500># 查看镜像内的历史记录</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>history</span> nginx:v2  <span style=color:#177500># 比较 nginx:latest 的历史记录</span>
</span></span></code></pre></td></tr></table></div></div></div><p>慎用：简单修改文件会发现大量无关内容被改动，导致镜像臃肿。生成的镜像也被称为 <strong>黑箱镜像</strong></p><h3 id=容器命令>容器命令</h3><p>说明：有了镜像才能创建容器，下载一个centos镜像来测试学习</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull centos
</span></span></code></pre></td></tr></table></div></div></div><h4 id=新建容器并启动-run>新建容器并启动 run</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run <span style=color:#000>[</span>可选参数<span style=color:#000>]</span> image
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 参数说明</span>
</span></span><span style=display:flex><span>--name<span style=color:#000>=</span><span style=color:#c41a16>&#34;Name&#34;</span>  容器名字，tomcat01 tomcat02，用来区分容器
</span></span><span style=display:flex><span>-d             后台方式运行
</span></span><span style=display:flex><span>-it            使用交互方式运行，进入容器查看内容
</span></span><span style=display:flex><span>-p             指定容器的端口 -p 8080:8080
</span></span><span style=display:flex><span>  -p ip:主机端口:容器端口
</span></span><span style=display:flex><span>  -p 主机端口:容器端口  <span style=color:#000>(</span>常用<span style=color:#000>)</span>
</span></span><span style=display:flex><span>  -p 容器端口
</span></span><span style=display:flex><span>-P             随机指定端口
</span></span><span style=display:flex><span>--rm           容器退出后随之将其删除
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 测试，启动并进入容器</span>
</span></span><span style=display:flex><span>docker run -it centos /bin/bash
</span></span><span style=display:flex><span>// docker run -it --rm ubuntu:18.04 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>exit</span> <span style=color:#177500># 退出容器</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=exec>exec</h4><p>在运行的容器中执行命令</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> <span style=color:#000>[</span>OPTIONS<span style=color:#000>]</span> CONTAINER COMMAND <span style=color:#000>[</span>ARG...<span style=color:#000>]</span>
</span></span><span style=display:flex><span>-d :分离模式: 在后台运行
</span></span><span style=display:flex><span>example: 
</span></span><span style=display:flex><span><span style=color:#177500># 开启一个交互模式的终端</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it webserver bash
</span></span><span style=display:flex><span><span style=color:#177500># 以交互模式执行容器内 /root/runoob.sh 脚本</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it mynginx /bin/sh /root/runoob.sh
</span></span><span style=display:flex><span><span style=color:#177500># 对指定的容器执行 bash</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it 9df70f9a0714 /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 启动已终止容器</span>
</span></span><span style=display:flex><span>docker container start
</span></span></code></pre></td></tr></table></div></div></div><h4 id=列出所有的运行的容器-ps>列出所有的运行的容器 ps</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker ps
</span></span><span style=display:flex><span><span style=color:#177500># 参数说明</span>
</span></span><span style=display:flex><span>    <span style=color:#177500># 列出当前正在运行的容器</span>
</span></span><span style=display:flex><span>-a  <span style=color:#177500># 列出当前正在运行的容器+带出历史运行过的容器</span>
</span></span><span style=display:flex><span>-n<span style=color:#000>=</span>? <span style=color:#177500># 显示最近创建的容器</span>
</span></span><span style=display:flex><span>-q  <span style=color:#177500># 只显示容器的编号</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker container ls
</span></span><span style=display:flex><span>-a 
</span></span></code></pre></td></tr></table></div></div></div><h4 id=退出容器>退出容器</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>exit</span> <span style=color:#177500># 直接容器停止并退出</span>
</span></span><span style=display:flex><span>Ctrl+P+Q  <span style=color:#177500># 容器不停止退出</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker container stop
</span></span></code></pre></td></tr></table></div></div></div><h4 id=删除容器>删除容器</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker rm 容器id  <span style=color:#177500># 删除指定的容器，不能删除正在运行的容器，强制删除：rm -f</span>
</span></span><span style=display:flex><span>docker rm -f <span style=color:#a90d91>$(</span>docker ps -aq<span style=color:#a90d91>)</span>   <span style=color:#177500># 删除所有的容器</span>
</span></span><span style=display:flex><span>docker ps -a -q|xargs docker rm <span style=color:#177500># 删除所有的容器</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=启动和停止容器的操作>启动和停止容器的操作</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker start 容器id  <span style=color:#177500># 启动容器</span>
</span></span><span style=display:flex><span>docker restart 容器id  <span style=color:#177500># 重启容器</span>
</span></span><span style=display:flex><span>docker stop 容器id
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>kill</span> 容器id   <span style=color:#177500># 强制停止当前容器</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=常用其他命令>常用其他命令</h4><p>后台启动容器</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d 镜像名
</span></span><span style=display:flex><span>docker run -d centos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 问题：docker ps，发现centos停止了</span>
</span></span><span style=display:flex><span><span style=color:#177500># 常见的坑，docker容器使用后台运行，就必须要有一个前台进程，</span>
</span></span><span style=display:flex><span><span style=color:#177500># docker发现没有应用，就会自动停止，如nginx</span>
</span></span></code></pre></td></tr></table></div></div></div><p>查看日志</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker logs
</span></span><span style=display:flex><span>docker logs -f container_id  <span style=color:#177500># 实时查看对应容器日志，如启动时等</span>
</span></span><span style=display:flex><span>docker logs -tf --tail <span style=color:#1c01ce>10</span> container_id  <span style=color:#177500># tail 10条</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 自己写一段脚本</span>
</span></span><span style=display:flex><span>docker run -d centos /bin/sh -c <span style=color:#c41a16>&#34;while true;do echo test123456;sleep 1;done&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 可选参数</span>
</span></span><span style=display:flex><span>-tf   <span style=color:#177500># 显示日志</span>
</span></span><span style=display:flex><span>--tail number  <span style=color:#177500># 要显示日志条数</span>
</span></span></code></pre></td></tr></table></div></div></div><p>查看容器中进程信息</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker top 容器id
</span></span></code></pre></td></tr></table></div></div></div><p>查看镜像的元数据</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker inspect 容器id
</span></span></code></pre></td></tr></table></div></div></div><p>进入当前正在运行的容器</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 通常容器都是后台运行</span>
</span></span><span style=display:flex><span><span style=color:#177500># 方式1</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it 容器id bashShell
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it 容器id /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 方式2</span>
</span></span><span style=display:flex><span>docker attach -it 容器id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># docker exec  # 进入容器后开启一个新的终端，可以在里面操作(常用)</span>
</span></span><span style=display:flex><span><span style=color:#177500># docker attach # 进入容器正在执行的终端，不会启动新的进程</span>
</span></span></code></pre></td></tr></table></div></div></div><p>从容器内拷贝文件到主机上</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp 容器id:/xxx/xxx.xx  /xxx
</span></span></code></pre></td></tr></table></div></div></div><p>查看映射端口配置</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker port fa <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=练习>练习</h3><p>官网：<a href=https://hub.docker.com/_/elasticsearch>https://hub.docker.com</a></p><h4 id=部署nginx>部署Nginx</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker images
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># -d 后台运行， --name 取名  -p 宿主机端口，容器内部端口</span>
</span></span><span style=display:flex><span>docker run -d --name nginx01 -p 3344:80 nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker ps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:3344
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 进入容器</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it nginx01 /bin/bash
</span></span><span style=display:flex><span>whereis nginx
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /etc/nginx
</span></span></code></pre></td></tr></table></div></div></div><p>端口暴露
<img src=../imgs/docker_basic_5.png alt=docker_basic_5.png></p><p>思考问题：每次改动Nginx配置文件，都需要进入容器内部，十分麻烦。需要可以在容器外部提供一个映射路径，达到在容器外部修改文件名，容器内部可以自动修改？-v 数据卷</p><h4 id=部署tomcat>部署Tomcat</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 官方的使用</span>
</span></span><span style=display:flex><span>docker run -t --rm tomcat:9.0
</span></span><span style=display:flex><span><span style=color:#177500># 之前的启动都是后台，停止容器之后，容器还可以查到， 上面的命令一般用来测试，用完即删</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 下载</span>
</span></span><span style=display:flex><span>docker pull tomcat:9.0
</span></span><span style=display:flex><span><span style=color:#177500># 启动</span>
</span></span><span style=display:flex><span>docker run -d -p 3355:8080 --name tomcat01 tomcat
</span></span><span style=display:flex><span><span style=color:#177500># 无法访问，但是程序本身没问题</span>
</span></span><span style=display:flex><span><span style=color:#177500># 进入容器</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat01 /bin/bash
</span></span><span style=display:flex><span><span style=color:#177500># 问题：1、linux命令少了，如ll；2、没有webapps</span>
</span></span><span style=display:flex><span><span style=color:#177500># 原因：阿里云镜像的原因。默认最小的镜像，所有不必要的都剔除掉，保证最小的运行环境</span>
</span></span><span style=display:flex><span>cp -r webapps.dist/* webapps
</span></span></code></pre></td></tr></table></div></div></div><p>思考问题：部署项目，每次进入容器十分麻烦。在容器外部提供一个映射路径，webapps，在外部放置项目，自动同步到内部就行了</p><h4 id=部署es-kibana>部署es+kibana</h4><p><a href=https://hub.docker.com/_/elasticsearch>https://hub.docker.com/_/elasticsearch</a></p><p>es暴露接口多</p><p>es十分消耗内存</p><p>es的数据一般需要防止</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>--net somenetwork ? 网络配置
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 启动elasticsearch</span>
</span></span><span style=display:flex><span>docker run -d --name elasticsearch --net somenetwork -p 9200:9200 
</span></span><span style=display:flex><span>-p 9300:9300 -e <span style=color:#c41a16>&#34;discovery.type=single-node&#34;</span> elasticsearch:7.6.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 启动了，linux就卡</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:9200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看cpu状态</span>
</span></span><span style=display:flex><span>docker stats 容器id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 增加内存限制</span>
</span></span><span style=display:flex><span>docker run -d --name elasticsearch02 --net somenetwork -p 9200:9200 
</span></span><span style=display:flex><span>-p 9300:9300 -e <span style=color:#c41a16>&#34;discovery.type=single-node&#34;</span> 
</span></span><span style=display:flex><span>-e <span style=color:#000>ES_JAVA_OPTS</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;-Xms64m -Xmx512m&#34;</span> elasticsearch:7.6.2
</span></span></code></pre></td></tr></table></div></div></div><p><img src=../imgs/docker_basic_6.png alt=docker_basic_6.png></p><h3 id=可视化>可视化</h3><ul><li><p>portainer（先用这个）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d -p 8088:9000 
</span></span><span style=display:flex><span>--restart<span style=color:#000>=</span>always -v /var/run/docker.sock:/var/run/docker.sock 
</span></span><span style=display:flex><span>--privileged<span style=color:#000>=</span><span style=color:#a90d91>true</span> portainer/portainer
</span></span></code></pre></td></tr></table></div></div></div></p></li><li><p>Rancher（CI/CD再用）</p></li></ul><h4 id=什么是portainer>什么是portainer</h4><p>Docker图形化界面管理工具，提供一个后台面板供我们操作</p><p>使用：<a href=http://ip:8088>http://ip:8088</a></p><h2 id=docker镜像讲解>Docker镜像讲解</h2><p>镜像是什么</p><h3 id=docker镜像加载原理>Docker镜像加载原理</h3><blockquote><p>UnionFS（联合文件系统）</p></blockquote><p>UnionFS（联合文件系统）：Union文件系统（UnionFS）是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以讲不同目录挂在到同一个虚拟文件系统下（unite several directories into a single virtual filesystem）。Union文件系统是Docker镜像的基础。镜像可以通过分层来进行继承，基于镜像（没有父镜像），可以制作各种具体的应用镜像。</p><p>特性：一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</p><p>下载时一层层的记录就是这个。。</p><blockquote><p>Docker镜像加载原理</p></blockquote><p>docker的镜像实际上由一层一层的文件系统组成，这种层级的文件系统UnionFS。</p><p>bootfs(boot file system)主要包含bootloader和kernel，bootloader主要是引导加载kernel，Linux刚启动时会加载bootfs文件系统，在Docker镜像的最底层是bootfs。这一层与我们典型的Linux/Unix系统十一样的，包含boot加载器和内核。当boot加载完成之后整个内核都在内存中了，此时内存的使用权已由bootfs转交给内核，此时系统也会卸载bootfs。</p><p>rootfs(root file system)，在bootfs之上。包含的就是典型Linux系统中的/dev, /proc, /bin, /etc等标准目录和文件。rootfs就是各种不同的操作系统发行版，比如Ubuntu，Centos等。</p><p>平时安装的CentOS都是好几个G，为什么Docker这里才200M？</p><p>对于一个精简的OS，rootfs可是很小，只需要包含最基本的命令、工具和程序库就可以了，因为底层直接用Host的kernel，自己只需要提供rootfs就可以了。由此可见对于不同的linux发行版，bootfs基本是一致的，因此不同的发行版可以共用bootfs。</p><h3 id=分层理解>分层理解</h3><blockquote><p>分层的镜像</p></blockquote><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker image inspect redis:latest
</span></span></code></pre></td></tr></table></div></div></div><p>拉去镜像时，显示6层
<img src=../imgs/docker_basic_7.png alt=docker_basic_7.png></p><p>查看Layers详情时，刚好6层</p><p><img src=../imgs/docker_basic_8.png alt=docker_basic_8.png></p><blockquote><p>特点</p></blockquote><p>Docker镜像都是只读的，当容器启动时，一个新的可写层被加载到镜像的顶部！</p><p>这一层就是我们通常说的容器层，容器之下的都叫镜像层</p><h3 id=commit镜像>commit镜像</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker commit 提交容器成为一个新的版本
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 命令和git原理类似</span>
</span></span><span style=display:flex><span>docker commit -m<span style=color:#000>=</span><span style=color:#c41a16>&#34;提交的描述信息&#34;</span> -a<span style=color:#000>=</span><span style=color:#c41a16>&#34;作者&#34;</span> 容器id 目标镜像名:<span style=color:#000>[</span>Tag<span style=color:#000>]</span>
</span></span></code></pre></td></tr></table></div></div></div><p>实战测试<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 启动一个默认的tomcat</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 发现这个默认的tomcat是没有webapps应用，镜像的默认配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 拷贝文件到tomcat的webapp下</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># commit镜像，以后可使用自己修改过的镜像</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看镜像</span>
</span></span><span style=display:flex><span>docker images 
</span></span></code></pre></td></tr></table></div></div></div></p><p><img src=../imgs/docker_basic_9.png alt=docker_basic_9.png></p><h2 id=容器数据卷>容器数据卷</h2><p>什么是容器数据卷</p><p>如果数据都在容器中，那么我们容器删除，数据就会丢失！需求：数据持久化</p><p>MySQL，容器删了，删除跑路！需求：MySQL数据可以存储在本地</p><p>容器之间可以有一个数据共享的技术！Docker容器中产生的数据，同步到本地！</p><p>这就是卷技术，目录的挂在，将我们容器内的目录，挂在到Linux上面！</p><p><img src=../imgs/docker_basic_10.png alt=docker_basic_10.png></p><p>总结一句话：容器的持久化和同步操作！容器间也是可以数据共享的！</p><h3 id=使用数据卷>使用数据卷</h3><blockquote><p>方式一：直接使用命令来挂载 -v</p></blockquote><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it -v 主机目录:容器内目录 <span style=color:#177500># -p 主机端口:容器内端口</span>
</span></span><span style=display:flex><span><span style=color:#177500># 例子</span>
</span></span><span style=display:flex><span>docker run -it -v /home/ceshi:/home centos /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 换个终端，在容器外查看目录或者容器相关信息</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /home/ceshi
</span></span><span style=display:flex><span>docker inspect 容器id
</span></span></code></pre></td></tr></table></div></div></div><p><img src=../imgs/docker_basic_11.png alt=docker_basic_11.png></p><p>容器内创建的文件，会在容器外创建，反之亦然。</p><h3 id=实战-安装mysql>实战：安装MySQL</h3><h3 id=具名和匿名挂载>具名和匿名挂载</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker volume --help
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 匿名挂载</span>
</span></span><span style=display:flex><span>-v 容器内路径
</span></span><span style=display:flex><span>docker run -d -P --name nginx01 -v /etc/nginx nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看所有的volume的情况</span>
</span></span><span style=display:flex><span>docker volume ls 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 具名挂载</span>
</span></span><span style=display:flex><span>docker run -d -P --name nginx02 -v juming-nginx:/etc/nignx nginx 
</span></span><span style=display:flex><span><span style=color:#177500># -v 卷名：容器内路径</span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看卷</span>
</span></span><span style=display:flex><span>docker volume inspect juming-nginx
</span></span></code></pre></td></tr></table></div></div></div><p>所有docker容器内的卷，没有指定目录的情况下都是在<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># /var/lib/docker/volumes/xxxx/_data</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>大多数情况下使用具名挂载<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 如何确定是具名挂载还是匿名挂载，还是指定路径挂载！</span>
</span></span><span style=display:flex><span>-v 容器内路径  <span style=color:#177500># 匿名挂载</span>
</span></span><span style=display:flex><span>-v 卷名：容器内路径  <span style=color:#177500># 具名挂载</span>
</span></span><span style=display:flex><span>-v /宿主机路径:容器内路径 <span style=color:#177500># 指定路径挂载</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>拓展：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 通过 -v 容器内路径:ro rw改变读写权限</span>
</span></span><span style=display:flex><span>ro  <span style=color:#a90d91>readonly</span>  <span style=color:#177500># 只读</span>
</span></span><span style=display:flex><span>rw  readWrite  <span style=color:#177500># 可读可写 </span>
</span></span><span style=display:flex><span>docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:ro nginx
</span></span><span style=display:flex><span>docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:rw nginx
</span></span><span style=display:flex><span><span style=color:#177500># ro 只要看到ro就说明这个路径只能通过宿主机来操作，容器内部无法操作</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=初识dockerfile>初识DockerFile</h3><p>DockerFile就是用来构建docker镜像的构建文件！命令脚本</p><p>通过脚本可以生成镜像，镜像是一层一层的，脚本一个个的命令，每个命令都是一层</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 创建一个dockerfile文件，名字可以随机，建议dockerfile</span>
</span></span><span style=display:flex><span><span style=color:#177500># 文件名的内容 指定(大写) 参数</span>
</span></span><span style=display:flex><span>FROM centos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VOLUME <span style=color:#000>[</span><span style=color:#c41a16>&#34;volume01&#34;</span>,<span style=color:#c41a16>&#34;volume02&#34;</span><span style=color:#000>]</span>  <span style=color:#177500># 匿名挂载</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;-----end-----&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD /bin/bash
</span></span><span style=display:flex><span><span style=color:#177500># 每个命令都是镜像的一层</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建镜像</span>
</span></span><span style=display:flex><span>docker build -f /home/docker-test-volume/dockfile1 
</span></span><span style=display:flex><span>-t kuangshen/centos:1.0 .    <span style=color:#177500># 镜像名不能用/开头</span>
</span></span></code></pre></td></tr></table></div></div></div><p>通过dockerfile这种方式也能卷挂载</p><h3 id=数据卷容器>数据卷容器</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 使用上面创建的镜像创建容器</span>
</span></span><span style=display:flex><span>docker run -it --name docker01 kuangshen/centos:1.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建第2个容器，共享容器1的数据</span>
</span></span><span style=display:flex><span>docker run -it --name docker02 --volumes-from docker01 kuangshen/centos:1.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建第3个容器，共享容器1的数据</span>
</span></span><span style=display:flex><span>docker run -it --name docker03 --volumes-from docker01 kuangshen/centos:1.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 数据共享，即使其中的任意容器删除了，也不影响数据</span>
</span></span></code></pre></td></tr></table></div></div></div><p>多个MySQL实现数据共享<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 路径挂载，忽略</span>
</span></span><span style=display:flex><span>docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v 
</span></span><span style=display:flex><span>/home/mysql/data:/var/lib/mysql -e <span style=color:#000>MYSQL_ROOT_PASSWORD</span><span style=color:#000>=</span><span style=color:#1c01ce>123456</span> --name
</span></span><span style=display:flex><span>mysql01 mysql:5.7
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 匿名挂载</span>
</span></span><span style=display:flex><span>docker run -d -p 3310:3306 -v /etc/mysql/conf.d -v /var/lib/mysql
</span></span><span style=display:flex><span> -e <span style=color:#000>MYSQL_ROOT_PASSWORD</span><span style=color:#000>=</span><span style=color:#1c01ce>123456</span> --name mysql01 mysql:5.7
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#177500># 共享数据</span>
</span></span><span style=display:flex><span>docker run -d -p 3310:3306 -e <span style=color:#000>MYSQL_ROOT_PASSWORD</span><span style=color:#000>=</span><span style=color:#1c01ce>123456</span> 
</span></span><span style=display:flex><span>--name mysql02 --volumes-from mysql01 mysql:5.7
</span></span></code></pre></td></tr></table></div></div></div></p><p>结论：
容器之间配置信息的传递，数据卷容器的声明周期一直持续到没有容器使用为止。</p><p>但是一旦持久化到了本地，本地的数据时不会删除的。</p><h2 id=dockerfile>Dockerfile</h2><p>Dockerfile就是用来构建docker镜像的构建文件</p><p>构建步骤：</p><p>1、编写一个dockerfile文件</p><p>2、docker build 构建成为一个镜像</p><p>3、docker run 运行镜像</p><p>4、docker push 发布镜像（DockerHub、阿里云镜像仓库）</p><h3 id=dockerfile构建过程>DockerFile构建过程</h3><p>基础知识：</p><p>1、每个保留关键字（指令）</p><p>2、从上到下顺序执行</p><p>3、#表示注释</p><p>4、每一个指令都会创建一个新的镜像层，并提交</p><p><img src=../imgs/docker_basic_12.png alt=docker_basic_12.png></p><h3 id=dockerfile的指令>DockerFile的指令</h3><p><img src=../imgs/docker_basic_13.png alt=docker_basic_13.png></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>FROM    <span style=color:#177500># 基础镜像，一切从这里开始构建</span>
</span></span><span style=display:flex><span>MAINTAINER  <span style=color:#177500># 镜像是谁写的，姓名+邮箱</span>
</span></span><span style=display:flex><span>RUN        <span style=color:#177500># 镜像构建的时候需要运行的命令</span>
</span></span><span style=display:flex><span>ADD        <span style=color:#177500># 步骤：添加内容</span>
</span></span><span style=display:flex><span>WORKDIER   <span style=color:#177500># 镜像的工作目录</span>
</span></span><span style=display:flex><span>VOLUME     <span style=color:#177500># 挂载的目录</span>
</span></span><span style=display:flex><span>EXPOST     <span style=color:#177500># 保留端口配置</span>
</span></span><span style=display:flex><span>CMD        <span style=color:#177500># 指定容器启动的时候需要运行的命令，只有最后一个会生效，可被替代</span>
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#177500># 指定容器启动的时候需要运行的命令，可追加命令</span>
</span></span><span style=display:flex><span>ONBUILD    <span style=color:#177500># 当构建一个被继承DockerFile这个时候就会运行 ONBUILD 的命令。触发指令。</span>
</span></span><span style=display:flex><span>COPY       <span style=color:#177500># 类似ADD，将文件拷贝到镜像中</span>
</span></span><span style=display:flex><span>ENV        <span style=color:#177500># 构建的时候设置环境变量</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=dockerfile定制镜像>Dockerfile定制镜像</h3><p>参考：<a href=https://yeasy.gitbook.io/docker_practice/image/build>https://yeasy.gitbook.io/docker_practice/image/build</a></p><p>Dockerfile 支持 Shell 类的行尾添加 <code>\</code> 的命令换行方式，以及行首 <code>#</code> 进行注释的格式。良好的格式，比如换行、缩进、注释等，会让维护、排障更为容易，这是一个比较好的习惯。</p><h4 id=from指定基础镜像>FROM指定基础镜像</h4><p>官方镜像都是基础包，很多功能没有，通常会自己搭建自己的镜像</p><p>除了选择现有镜像为基础镜像外，Docker 还存在一个特殊的镜像，名为 <code>scratch</code>。这个镜像是虚拟的概念，并不实际存在，它表示一个空白的镜像。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>FROM scratch
</span></span></code></pre></td></tr></table></div></div></div><h4 id=run执行命令>RUN执行命令</h4><p>两种格式</p><ul><li>shell格式：RUN &lt;命令></li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>RUN</span> <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#39;</span> &gt; /usr/share/nginx/html/index.html<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>exec格式：RUN ["可执行文件", "参数1", "参数2"]</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> debian:stretch</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> apt-get update<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> apt-get install -y gcc libc6-dev make wget<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> wget -O redis.tar.gz <span style=color:#c41a16>&#34;http://download.redis.io/releases/redis-5.0.3.tar.gz&#34;</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> mkdir -p /usr/src/redis<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> tar -xzf redis.tar.gz -C /usr/src/redis --strip-components<span style=color:#000>=</span><span style=color:#1c01ce>1</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> make -C /usr/src/redis<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> make -C /usr/src/redis install<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Dockerfile 中每一个指令都会建立一层</strong>，上述非常臃肿、非常多层的镜像，正确写法</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> debian:stretch</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> <span style=color:#a90d91>set</span> -x; <span style=color:#000>buildDeps</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;gcc libc6-dev make wget&#39;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> apt-get update <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> apt-get install -y <span style=color:#000>$buildDeps</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> wget -O redis.tar.gz <span style=color:#c41a16>&#34;http://download.redis.io/releases/redis-5.0.3.tar.gz&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> mkdir -p /usr/src/redis <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> tar -xzf redis.tar.gz -C /usr/src/redis --strip-components<span style=color:#000>=</span><span style=color:#1c01ce>1</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> make -C /usr/src/redis <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> make -C /usr/src/redis install <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> rm redis.tar.gz <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> rm -r /usr/src/redis <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>&amp;&amp;</span> apt-get purge -y --auto-remove <span style=color:#000>$buildDeps</span><span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p>还可以看到这一组命令的最后添加了清理工作的命令，删除了为了编译构建所需要的软件，清理了所有下载、展开的文件，并且还清理了 apt 缓存文件。这是很重要的一步，我们之前说过，镜像是多层存储，每一层的东西并不会在下一层被删除，会一直跟随着镜像。因此镜像构建时，一定要确保每一层只添加真正需要添加的东西，任何无关的东西都应该清理掉。</p><h4 id=构建镜像>构建镜像</h4><p>命令格式</p><p>docker build [选项] &lt;上下文路径/URL/-></p><p>在 Dockerfile 文件所在路径执行</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker build -t nginx:v3 .
</span></span><span style=display:flex><span>Sending build context to Docker daemon 2.048 kB
</span></span><span style=display:flex><span>Step <span style=color:#1c01ce>1</span> : FROM nginx
</span></span><span style=display:flex><span> ---&gt; e43d811ce2f4
</span></span><span style=display:flex><span>Step <span style=color:#1c01ce>2</span> : RUN <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#39;</span> &gt; /usr/share/nginx/html/index.html
</span></span><span style=display:flex><span> ---&gt; Running in 9cdc27646c7b
</span></span><span style=display:flex><span> ---&gt; 44aa4490ce2c
</span></span><span style=display:flex><span>Removing intermediate container 9cdc27646c7b
</span></span><span style=display:flex><span>Successfully built 44aa4490ce2c
</span></span></code></pre></td></tr></table></div></div></div><p>默认<code>Dockerfile</code> 的文件名为但并不要求必须为 <code>Dockerfile</code>，而且并不要求必须位于上下文目录中，比如可以用 <code>-f ../Dockerfile.php</code> 参数指定某个文件作为 <code>Dockerfile</code>。</p><h4 id=镜像构建上下文-context>镜像构建上下文（Context）</h4><p>构建命令最后有个“.”，指定上下文路径。</p><p>Docker 在运行时分为 Docker 引擎（也就是服务端守护进程）和客户端工具。</p><p>虽然表面上我们好像是在本机执行各种 <code>docker</code> 功能，但实际上，一切都是使用的远程调用形式在服务端（Docker 引擎）完成。也因为这种 C/S 设计，让我们操作远程服务器的 Docker 引擎变得轻而易举。</p><p>当我们进行镜像构建的时候，并非所有定制都会通过 <code>RUN</code> 指令完成，经常会需要将一些本地文件复制进镜像，比如通过 <code>COPY</code> 指令、<code>ADD</code> 指令等。而 <code>docker build</code> 命令构建镜像，其实并非在本地构建，而是在服务端，也就是 Docker 引擎中构建的。那么在这种客户端/服务端的架构中，如何才能让服务端获得本地文件呢？</p><p>这就引入了上下文的概念。当构建的时候，用户会指定构建镜像上下文的路径，<code>docker build</code> 命令得知这个路径后，会将路径下的所有内容打包，然后上传给 Docker 引擎。这样 Docker 引擎收到这个上下文包后，展开就会获得构建镜像所需的一切文件。</p><p>一般来说，应该会将 <code>Dockerfile</code> 置于一个空目录下，或者项目根目录下。如果该目录下没有所需文件，那么应该把所需文件复制一份过来。如果目录下有些东西确实不希望构建时传给 Docker 引擎，那么可以用 <code>.gitignore</code> 一样的语法写一个 <code>.dockerignore</code>，该文件是用于剔除不需要作为上下文传递给 Docker 引擎的。</p><h3 id=其它docker-build的用法>其它docker build的用法</h3><h4 id=直接用-git-repo-进行构建>直接用 Git repo 进行构建</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># $env:DOCKER_BUILDKIT=0</span>
</span></span><span style=display:flex><span><span style=color:#177500># export DOCKER_BUILDKIT=0</span>
</span></span><span style=display:flex><span>$ docker build -t hello-world https://github.com/docker-library/hello-world.git#master:amd64/hello-world
</span></span><span style=display:flex><span>Step 1/3 : FROM scratch
</span></span><span style=display:flex><span> ---&gt;
</span></span><span style=display:flex><span>Step 2/3 : COPY hello /
</span></span><span style=display:flex><span> ---&gt; ac779757d46e
</span></span><span style=display:flex><span>Step 3/3 : CMD <span style=color:#000>[</span><span style=color:#c41a16>&#34;/hello&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span> ---&gt; Running in d2a513a760ed
</span></span><span style=display:flex><span>Removing intermediate container d2a513a760ed
</span></span><span style=display:flex><span> ---&gt; 038ad4142d2b
</span></span><span style=display:flex><span>Successfully built 038ad4142d2b
</span></span></code></pre></td></tr></table></div></div></div><p>这行命令指定了构建所需的 Git repo，并且指定分支为 <code>master</code>，构建目录为 <code>/amd64/hello-world/</code>，然后 Docker 就会自己去 <code>git clone</code> 这个项目、切换到指定分支、并进入到指定目录后开始构建。</p><h4 id=用给定的-tar-压缩包构建>用给定的 tar 压缩包构建</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker build http://server/context.tar.gz
</span></span></code></pre></td></tr></table></div></div></div><p>如果所给出的 URL 不是个 Git repo，而是个 <code>tar</code> 压缩包，那么 Docker 引擎会下载这个包，并自动解压缩，以其作为上下文，开始构建。</p><h4 id=从标准输入中读取-dockerfile-进行构建>从标准输入中读取 Dockerfile 进行构建</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker build - &lt; Dockerfile
</span></span><span style=display:flex><span><span style=color:#177500># 或</span>
</span></span><span style=display:flex><span>cat Dockerfile | docker build -
</span></span></code></pre></td></tr></table></div></div></div><p>如果标准输入传入的是文本文件，则将其视为 <code>Dockerfile</code>，并开始构建。这种形式由于直接从标准输入中读取 Dockerfile 的内容，它没有上下文，因此不可以像其他方法那样可以将本地文件 <code>COPY</code> 进镜像之类的事情。</p><h4 id=从标准输入中读取上下文压缩包进行构建>从标准输入中读取上下文压缩包进行构建</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker build - &lt; context.tar.gz
</span></span></code></pre></td></tr></table></div></div></div><p>如果发现标准输入的文件格式是 <code>gzip</code>、<code>bzip2</code> 以及 <code>xz</code> 的话，将会使其为上下文压缩包，直接将其展开，将里面视为上下文，并开始构建。</p><h3 id=dockerfile指令详解>Dockerfile指令详解</h3><p>参考：<a href=https://yeasy.gitbook.io/docker_practice/image/dockerfile>https://yeasy.gitbook.io/docker_practice/image/dockerfile</a></p><h4 id=copy-复制文件>COPY 复制文件</h4><p>两种格式：类似于命令行、类似于函数调用</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>COPY</span> <span style=color:#000>[</span>--chown<span style=color:#000>=</span>&lt;user&gt;:&lt;group&gt;<span style=color:#000>]</span> &lt;源路径&gt;... &lt;目标路径&gt;<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> <span style=color:#000>[</span>--chown<span style=color:#000>=</span>&lt;user&gt;:&lt;group&gt;<span style=color:#000>]</span> <span style=color:#000>[</span><span style=color:#c41a16>&#34;&lt;源路径1&gt;&#34;</span>,... <span style=color:#c41a16>&#34;&lt;目标路径&gt;&#34;</span><span style=color:#000>]</span><span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p>使用 <code>COPY</code> 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p><p>在使用该指令的时候还可以加上 <code>--chown=&lt;user>:&lt;group></code> 选项来改变文件的所属用户及所属组。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>COPY</span> --chown<span style=color:#000>=</span>55:mygroup files* /mydir/<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> --chown<span style=color:#000>=</span>bin files* /mydir/<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> --chown<span style=color:#000>=</span><span style=color:#1c01ce>1</span> files* /mydir/<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> --chown<span style=color:#000>=</span>10:11 files* /mydir/<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=add-更高级的复制文件>ADD 更高级的复制文件</h4><p>不太常用的命令。</p><p>在 <code>COPY</code> 和 <code>ADD</code> 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 <code>COPY</code> 指令，仅在需要自动解压缩的场合使用 <code>ADD</code>。</p><h4 id=cmd-容器启动命令>CMD 容器启动命令</h4><h4 id=entrypoint-入口点>ENTRYPOINT 入口点</h4><p>可以在原来的命令后面增加参数</p><h4 id=env-设置环境变量>ENV 设置环境变量</h4><p>格式有两种：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>ENV</span> &lt;key&gt; &lt;value&gt;<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>ENV</span> &lt;key1&gt;<span style=color:#000>=</span>&lt;value1&gt; &lt;key2&gt;<span style=color:#000>=</span>&lt;value2&gt;...<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>ENV</span> <span style=color:#000>VERSION</span><span style=color:#000>=</span><span style=color:#1c01ce>1</span>.0 <span style=color:#000>DEBUG</span><span style=color:#000>=</span>on <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#000>NAME</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;Happy Feet&#34;</span><span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=arg-构建参数>ARG 构建参数</h4><p><code>Dockerfile</code> 中的 <code>ARG</code> 指令是定义参数名称，以及定义其默认值。该默认值可以在构建命令 <code>docker build</code> 中用 <code>--build-arg &lt;参数名>=&lt;值></code> 来覆盖。</p><p>灵活的使用 <code>ARG</code> 指令，能够在不修改 Dockerfile 的情况下，构建出不同的镜像。</p><p>ARG 指令有生效范围，如果在 <code>FROM</code> 指令之前指定，那么只能用于 <code>FROM</code> 指令中。但是多个FROM中可以生效，各个阶段必须重新指定</p><h4 id=volume-定义匿名卷>VOLUME 定义匿名卷</h4><h4 id=expose-暴露端口>EXPOSE 暴露端口</h4><h4 id=workdir-指定工作目录>WORKDIR 指定工作目录</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>RUN</span> <span style=color:#a90d91>cd</span> /app<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;hello&#34;</span> &gt; world.txt<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p>如果将这个 <code>Dockerfile</code> 进行构建镜像运行后，会发现找不到 <code>/app/world.txt</code> 文件，或者其内容不是 <code>hello</code>。原因其实很简单，<strong>在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在</strong><code>Dockerfile</code><strong>中，这两行</strong><code>RUN</code>**命令的执行环境根本不同，是两个完全不同的容器。**这就是对 <code>Dockerfile</code> 构建分层存储的概念不了解所导致的错误。
<strong>之前说过每一个</strong><code>RUN</code>**都是启动一个容器、执行命令、然后提交存储层文件变更。**第一层 <code>RUN cd /app</code> 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p><p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 <code>WORKDIR</code> 指令。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> /app</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;hello&#34;</span> &gt; world.txt<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p>如果你的 <code>WORKDIR</code> 指令使用的相对路径，那么所切换的路径与之前的 <code>WORKDIR</code> 有关：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> /a</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> b</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> c</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> pwd<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p><code>RUN pwd</code> 的工作目录为 <code>/a/b/c</code>。</p><h4 id=user-指定当前用户>USER 指定当前用户</h4><p>如果以 <code>root</code> 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程，不要使用 <code>su</code> 或者 <code>sudo</code>，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 <code>gosu</code>。</p><h4 id=healthcheck-健康检查>HEALTHCHECK 健康检查</h4><ul><li><p><code>HEALTHCHECK [选项] CMD &lt;命令></code>：设置检查容器健康状况的命令</p></li><li><p><code>HEALTHCHECK NONE</code>：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令
支持下列选项：</p></li><li><p><code>--interval=&lt;间隔></code>：两次健康检查的间隔，默认为 30 秒；</p></li><li><p><code>--timeout=&lt;时长></code>：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；</p></li><li><p><code>--retries=&lt;次数></code>：当连续失败指定次数后，则将容器状态视为 <code>unhealthy</code>，默认 3 次。
和 <code>CMD</code>, <code>ENTRYPOINT</code> 一样，<code>HEALTHCHECK</code> 只可以出现一次，如果写了多个，只有最后一个生效。</p></li></ul><p>Web Demo</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> nginx</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> apt-get update <span style=color:#000>&amp;&amp;</span> apt-get install -y curl <span style=color:#000>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>HEALTHCHECK --interval=5s --timeout=3s \
</span></span></span><span style=display:flex><span><span style=color:#000>  </span><span style=color:#a90d91>CMD</span> curl -fs http://localhost/ <span style=color:#000>||</span> <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span><span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p>shell<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker build -t myweb:v1 .
</span></span><span style=display:flex><span>$ docker run -d --name web -p 80:80 myweb:v1
</span></span><span style=display:flex><span><span style=color:#177500># 多次运行，观察status</span>
</span></span><span style=display:flex><span>docker container ls
</span></span><span style=display:flex><span><span style=color:#177500># 排除故障</span>
</span></span><span style=display:flex><span>$ docker inspect --format <span style=color:#c41a16>&#39;{{json .State.Health}}&#39;</span> web | python -m json.tool
</span></span></code></pre></td></tr></table></div></div></div></p><h4 id=onbuild-为他人做嫁衣>ONBUILD 为他人做嫁衣</h4><h4 id=label-为镜像添加云数据>LABEL 为镜像添加云数据</h4><h4 id=shell-指令>SHELL 指令</h4><h4 id=参考文档>参考文档</h4><h3 id=实战-构建自己的centos>实战：构建自己的Centos</h3><p>Docker Hub中99%的镜像都是从这个基础镜像过来的 FROM scratch，然后配置需要的软件和配置来进行构建</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#177500># 1、编写DockerFile的文件</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> centos</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>MAINTAINER</span><span style=color:#c41a16> kuangshen&lt;xxx@xx.com&gt;</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>ENV</span> MYPATH /usr/local<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> $MYPATH</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> yum -y install vim<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> yum -y install net-tools<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>EXPOSE</span><span style=color:#c41a16> 80</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>CMD</span> <span style=color:#a90d91>echo</span> <span style=color:#000>$MYPATH</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>CMD</span> <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;-----end----&#34;</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>CMD</span> /bin/bash<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># 2、通过这个文件构建镜像</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span>docker build -f dockerfile文件路径 -t 镜像名:<span style=color:#000>[</span>tag<span style=color:#000>]</span> .<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># 或者在 Dockerfile 文件所在目录执行</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span>docker build -t 镜像名:<span style=color:#000>[</span>tag<span style=color:#000>]</span> .<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># 3、测试运行</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span>docker run -it mycentos:0.1<span style=color:#000>
</span></span></span></code></pre></td></tr></table></div></div><p>额外技巧：查看其它官方镜像的步骤<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker images
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>history</span> 镜像id  <span style=color:#177500># 查看当前镜像的步骤</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=cmd和entrypoint对比>CMD和ENTRYPOINT对比</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>CMD        <span style=color:#177500># 指定容器启动的时候需要运行的命令，只有最后一个会生效，可被替代</span>
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#177500># 指定容器启动的时候需要运行的命令，可追加命令</span>
</span></span></code></pre></td></tr></table></div></div></div><p>CMD测试<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># dockerfile-cmd-test</span>
</span></span><span style=display:flex><span>FROM centos
</span></span><span style=display:flex><span>CMD <span style=color:#000>[</span><span style=color:#c41a16>&#34;ls&#34;</span>,<span style=color:#c41a16>&#34;-a&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 构建镜像</span>
</span></span><span style=display:flex><span>docker build -f dockerfile-cmd-test -t cmdtest .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># run运行，发现ls -a命令生效</span>
</span></span><span style=display:flex><span>docker run 镜像id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 追加一个命令 -l     ls -al</span>
</span></span><span style=display:flex><span>docker run 镜像id -l  <span style=color:#177500># 报错，-l替换了CMD[&#34;ls&#34;,&#34;-a&#34;]命令，-l不是命令所以报错</span>
</span></span><span style=display:flex><span>docker run 镜像id ls -al <span style=color:#177500># 正常</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>ENTRYPOINT测试<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># dockerfile-cmd-entrypoint</span>
</span></span><span style=display:flex><span>FROM centos
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#000>[</span><span style=color:#c41a16>&#34;ls&#34;</span>,<span style=color:#c41a16>&#34;-a&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 构建镜像</span>
</span></span><span style=display:flex><span>docker build -f dockerfile-cmd-entrypoint -t entrypoint_test .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># run运行，发现ls -a命令生效</span>
</span></span><span style=display:flex><span>docker run 镜像id
</span></span><span style=display:flex><span>docker run 镜像id -l
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=实战-dockerfile制作tomcat镜像>实战：DockerFile制作Tomcat镜像</h3><p>1、准备镜像文件tomcat压缩包、JDK压缩包</p><p>2、编写dockerfile文件，官方明明<code>Dockerfile</code>，build会自动寻找这个文件，就不需要-f指定了</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>FROM centos
</span></span><span style=display:flex><span>MAINTAINER kuanshane&lt;xx@qq.com&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY reame.txt /usr/local/readme.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ADD jdk-8u11-linux-x64.tar.gz /usr/local/
</span></span><span style=display:flex><span>ADD apache-tomcat-xx.tar.gz /usr/local/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN yum -y install vim
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENV MYAPTH /usr/local
</span></span><span style=display:flex><span>WORKDIR <span style=color:#000>$MYPATH</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENV JAVA_HOME /usr/local/jdk1.8.0_11
</span></span><span style=display:flex><span>ENV CLASSPATH <span style=color:#000>$JAVA_HOME</span>/lib/dt.jar:<span style=color:#000>$JAVA_HOME</span>/lib/tools.jar
</span></span><span style=display:flex><span>ENV CATALINA_HOME /usr/local/apache-tomcat-9.0.22
</span></span><span style=display:flex><span>ENV CATALINA_BASE /usr/local/apache-tomcat-9.0.22
</span></span><span style=display:flex><span>ENV PATH <span style=color:#000>$PATH</span>:<span style=color:#000>$JAVA_HOME</span>/bin:<span style=color:#000>$CLASSPATH</span>/lib:<span style=color:#000>$CATALINA_HOME</span>/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EXPOSE <span style=color:#1c01ce>8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD /usr/local/apache-tomcat-9.0.22/bin/startup.sh <span style=color:#000>&amp;&amp;</span> tail -F 
</span></span><span style=display:flex><span>/usr/local/apache-tomcat-9.0.22/bin/logs/catalina.out
</span></span></code></pre></td></tr></table></div></div></details><br><p>3、构建镜像<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t diytomcat .
</span></span></code></pre></td></tr></table></div></div></div></p><p>4、运行<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d -p 9090:8080 --name kuangshentomcat 
</span></span><span style=display:flex><span>-v /home/kuangshen/build/tomcat/test:/usr/local/apache-tomcat-9.0.22/webapps/test
</span></span><span style=display:flex><span>-v /home/kuangshen/build/tomcat/tomcatlos/:/usr/local/apache-tomcat-9.0.22/logs 
</span></span><span style=display:flex><span>diytomcat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it 容器id /bin/bash
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=发布镜像到dockerhub>发布镜像到DockerHub</h3><p>1、地址 <a href=https://hub.docker.com>https://hub.docker.com</a> 注册账号</p><p>2、提交镜像</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker login -help
</span></span><span style=display:flex><span>docker login -u kuangshen
</span></span><span style=display:flex><span><span style=color:#177500># 登录其他仓库</span>
</span></span><span style=display:flex><span>docker login --username<span style=color:#000>=</span>xxx registry.cn-beijing.aliyuncs.com
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>logout</span>
</span></span></code></pre></td></tr></table></div></div></div><p>3、提交镜像</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker push diytomcat
</span></span><span style=display:flex><span><span style=color:#177500># 增加tag</span>
</span></span><span style=display:flex><span>docker push kuangshen/diytomcat:1.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 给当前的镜像增加tag</span>
</span></span><span style=display:flex><span>docker tag 镜像id kuangshen/tomcat:1.0
</span></span></code></pre></td></tr></table></div></div></div><h3 id=dockerfile-demo>Dockerfile demo</h3><h4 id=nginx>nginx</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>FROM nginx
</span></span><span style=display:flex><span>RUN <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#39;</span> &gt; /usr/share/nginx/html/index.html
</span></span></code></pre></td></tr></table></div></div></div><h2 id=docker网络>Docker网络</h2><h3 id=理解docker0>理解Docker0</h3><p><img src=../imgs/docker_basic_14.png alt=docker_basic_14.png></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看网络地址，如上图</span>
</span></span><span style=display:flex><span>ip addr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 上下两个命令分别使用可以看到容器内外一对地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看容器内部网络地址  ip addr ，发现容器启动的时候会得到一个 eth0 ip地址，docker分配的</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat01 ip addr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 思考，linux能不能ping通容器内部</span>
</span></span><span style=display:flex><span>ping xxxxx  <span style=color:#177500># 可以</span>
</span></span></code></pre></td></tr></table></div></div></div><p>原理：
每启动一个docker容器，docker就会给容器分配一个ip，只要安装了docker，就会有一个网卡docker0桥接模式，使用的技术是evth-pair技术</p><p>每启动一个容器带来的网卡都是一对一对的</p><p>evth-pair 就是一对的虚拟设备接口，成对出现，一段连着协议，一段彼此相连</p><p>一般利用这个特性 evth-pair 充当一个桥梁，连接各种网络设备</p><p>测试容器之间是否能够ping通</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat02 ping 172.18.0.2 <span style=color:#177500># 可以</span>
</span></span></code></pre></td></tr></table></div></div></div><p>结论：容器之间可以 ping 通
网络模型图：</p><p><img src=../imgs/docker_basic_15.png alt=docker_basic_15.png></p><p>结论：tomcat01和tomcat02公用的一个路由器，docker0</p><p>所有的容器不指定网络的情况下，都是docker0路由的，docker会给我们的容器分配一个默认的可用IP</p><p>总结：Docker使用的是Linux的桥接，宿主机中的是一个Docker容器的网桥 docker0。</p><p><img src=../imgs/docker_basic_16.png alt=docker_basic_16.png></p><p>Docker中的所有网络接口都是虚拟的，虚拟的转发效率高！（内网传递文件）。</p><p>容器删除，对应一对网桥没了</p><blockquote><p>思考一个场景，项目不重启，ip更换，通过服务名连接访问</p></blockquote><h3 id=容器互联-link>容器互联--link</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 先启动tomcat01和tomcat02两个容器</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat-2 ping tomcat01 <span style=color:#177500># 无法ping通</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d -P --name tomcat03 --link tomcat02 tomcat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat03 ping tomcat02 <span style=color:#177500># 可以ping通</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat02 ping tomcat03 <span style=color:#177500># 不可以ping通</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker network --help
</span></span><span style=display:flex><span>docker network ls <span style=color:#177500># 查看所有网络</span>
</span></span><span style=display:flex><span>docker network inspect
</span></span><span style=display:flex><span>docker inspect 容器id
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat03 cat /etc/hosts
</span></span></code></pre></td></tr></table></div></div></div><p>原理探究：--link就是在hosts配置中了tomcat02的ip
实际开发已经不建议使用 --link 了。</p><p>docker0问题：不支持容器名直接访问！</p><h3 id=自定义网络>自定义网络</h3><p>网络模式</p><p>bridge：桥接docker（默认）</p><p>none：不配置网络</p><p>host：和宿主机共享网络</p><p>container：容器网络连通（用的少，局限很大）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker --run -d -P --name tomcat01 tomcat <span style=color:#177500># 等同</span>
</span></span><span style=display:flex><span>docker --run -d -P --name tomcat01 --net bridge tomcat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建网络</span>
</span></span><span style=display:flex><span>docker network create --help
</span></span><span style=display:flex><span>docker network create --driver bridge --subnet 192.168.0.0/16
</span></span><span style=display:flex><span>--gateway 192.168.0.1 mynet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker network ls
</span></span><span style=display:flex><span>docker network inspect mynet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 启动两个容器</span>
</span></span><span style=display:flex><span>docker run -d -P --name tomcat-net-01 --net mynet tomcat
</span></span><span style=display:flex><span>docker run -d -P --name tomcat-net-02 --net mynet tomcat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 测试网络连接</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat-net-01 ping 192.168.0.3  <span style=color:#177500># 能ping通</span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat-net-01 ping tomcat-net-02  <span style=color:#177500># 能ping通</span>
</span></span></code></pre></td></tr></table></div></div></div><p>我们自定义的网络已经帮我们维护好了对应的关系，推荐使用！</p><h3 id=网络连通>网络连通</h3><p><img src=../imgs/docker_basic_17.png alt=docker_basic_17.png></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker network connect --help
</span></span><span style=display:flex><span>docker network connect <span style=color:#000>[</span>OPTIONS<span style=color:#000>]</span> NETWORK CONTAINER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 测试打通tomcat01 到 mynet</span>
</span></span><span style=display:flex><span>docker network connect mynet tomcat01
</span></span><span style=display:flex><span><span style=color:#177500># 查看连通后mynet</span>
</span></span><span style=display:flex><span>docker network inspect mynet  <span style=color:#177500># Containers参数</span>
</span></span><span style=display:flex><span><span style=color:#177500># 连通后就是将tomcat01放到了mynet网络下，一个容器两个ip地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it tomcat01 ping tomcat-net-01 <span style=color:#177500># 能ping通</span>
</span></span></code></pre></td></tr></table></div></div></div><p>跨网络操作别人，就需要使用docker network connect连接</p><h3 id=实战-redis集群部署>实战：Redis集群部署</h3><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker network create redis --subnet 172.38.0.0/16
</span></span><span style=display:flex><span>docker network inspect redis
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 通过脚本创建6个redis配置，直接粘贴在终端运行</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>for</span> port in <span style=color:#a90d91>$(</span>seq <span style=color:#1c01ce>1</span> 6<span style=color:#a90d91>)</span>; <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span><span style=color:#a90d91>do</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>mkdir -p /mydata/redis/node-<span style=color:#c41a16>${</span><span style=color:#000>port</span><span style=color:#c41a16>}</span>/conf
</span></span><span style=display:flex><span>touch /mydata/redis/node-<span style=color:#c41a16>${</span><span style=color:#000>port</span><span style=color:#c41a16>}</span>/conf/redis.conf
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&lt;&lt; EOF &gt; /mydata/redis/node-${port}/conf/redis.conf
</span></span></span><span style=display:flex><span><span style=color:#c41a16>port 6379
</span></span></span><span style=display:flex><span><span style=color:#c41a16>bind 0.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#c41a16>cluster-enable yes
</span></span></span><span style=display:flex><span><span style=color:#c41a16>cluster-config-file nodes.conf
</span></span></span><span style=display:flex><span><span style=color:#c41a16>cluster-announce-ip 172.38.0.1${port}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>cluster-announce-port 6379
</span></span></span><span style=display:flex><span><span style=color:#c41a16>cluster-announce-bus-port 16379
</span></span></span><span style=display:flex><span><span style=color:#c41a16>appendonly yes
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -p 6371:6379 -p 16371:16379 --name redis-1
</span></span><span style=display:flex><span>-v /mydata/redis/node-1/data:/data
</span></span><span style=display:flex><span>-v /mydata/redis/node-1/conf/redis.conf:/etc/redis/redis.conf
</span></span><span style=display:flex><span>-d --net redis --ip 172.38.0.11 redis:5.0.9-alpine3.11 redis-server
</span></span><span style=display:flex><span>/etc/redis/redis.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker ps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 继续启动redis容器，2、3、4、5、6</span>
</span></span><span style=display:flex><span>docker run -p 6372:6379 -p 16372:16379 --name redis-2
</span></span><span style=display:flex><span>-v /mydata/redis/node-2/data:/data
</span></span><span style=display:flex><span>-v /mydata/redis/node-2/conf/redis.conf:/etc/redis/redis.conf
</span></span><span style=display:flex><span>-d --net redis --ip 172.38.0.12 redis:5.0.9-alpine3.11 redis-server
</span></span><span style=display:flex><span>/etc/redis/redis.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#a90d91>exec</span> -it redis-1 /bin/sh  <span style=color:#177500># 进入默认/data， ls可以看到配置文件</span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建集群</span>
</span></span><span style=display:flex><span>redis-cli --cluster creeate 172.38.0.11:6379 
</span></span><span style=display:flex><span>172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379
</span></span><span style=display:flex><span>172.38.0.16:6379 --cluster-replicas <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 进入集群</span>
</span></span><span style=display:flex><span>redis-cli -c
</span></span><span style=display:flex><span>xx&gt; cluster info
</span></span><span style=display:flex><span>xx&gt; cluster nodes
</span></span><span style=display:flex><span>xx&gt; <span style=color:#a90d91>set</span> a b  <span style=color:#177500># 可以看到处理节点</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker stop redis-3 <span style=color:#177500># 停掉主机</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xx&gt; get a  <span style=color:#177500># 从副本机器上获取到了</span>
</span></span><span style=display:flex><span>xx&gt; cluster nodes <span style=color:#177500># 可以看到主机fail</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=springboot微服务打包docker镜像>SpringBoot微服务打包Docker镜像</h3><p>1、构建Spring-boot项目</p><p>2、打包应用</p><p>3、编写dockerfile</p><p>4、构建镜像</p><p>5、发布运行</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># dockerfile</span>
</span></span><span style=display:flex><span>FROM java:8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY *.jar /app.jar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD <span style=color:#000>[</span><span style=color:#c41a16>&#34;--server:port=8080&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EXPOSE <span style=color:#1c01ce>8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#000>[</span><span style=color:#c41a16>&#34;java&#34;</span>,<span style=color:#c41a16>&#34;-jar&#34;</span>,<span style=color:#c41a16>&#34;/app.jar&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 构建镜像</span>
</span></span><span style=display:flex><span><span style=color:#177500># 在目录中准备好jar包和dockerfile</span>
</span></span><span style=display:flex><span>docker build -t kuangshen666 .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker images
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 会显示容器内部地址</span>
</span></span><span style=display:flex><span>docker run -d -P --name kuangshen-springboot-web kuangshen666
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker ps
</span></span><span style=display:flex><span>curl localhost:32779/hello
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=reference>Reference</h2><p><a href=https://yeasy.gitbook.io/docker_practice/image>Docker-从入门到实践</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-b83f5b169855ed2dfd689f0676a70777>2 - 20.docker目录</h1><h1 id=各种id关系>各种ID关系</h1><p>layerID -> diffID -> chainID -> cacheID</p><p>layerID和diffID的对应关系在diffid-by-digest和v2metadata-by-diffid</p><p>chainID主要存在于/var/lib/docker/image/overlay2/layerdb/sha256/<chain-id></p><p>cacheID主要存在于/var/lib/docker/overlay2/<cache-id></p><h2 id=layerid>layerID</h2><p>layerID是压缩数据的sha256的值（Distribution根据layer compressed data计算）</p><p>压缩的layer层的哈希值为layerID，即distribution hashes，如pull镜像时显示的Layer ID。注意pull下来的是压缩的数据。</p><h2 id=diffid>diffID</h2><p>diffID是解压缩数据的sha256的值（本地由Docker根据layer uncompressed data计算）</p><p>如使用 docker [image] inspect nginx:latest，其中有一个RootFS的键值对，这里的rootfs layers的值就是diffID。</p><h3 id=layerid与diffid的映射关系>layerID与diffID的映射关系</h3><p>目录：docker/image/overlay2/distribution/下</p><p>diffid-by-digest文件：digest(layerID) -> diffID</p><p>即distribution hashes和Content hashes的映射关系。也是正向查询。</p><p>v2metadata-by-diffid文件：diffid -> (digest, repository)</p><p>可以查找layer的digest及其所属的repository。也即是反向查询，可以从diffID->layerID（其实就是digest）</p><h2 id=chainid>chainID</h2><p>layer.ChainID只用于本地，根据layer.diffID计算，<strong>并用于layerdb的目录名称</strong></p><p>chainID唯一标识了一组diffID的hash值，包含了这一层和父层（底层）</p><p>chainID(layer0) = diffID(layer0)</p><p>chainID(layerN) = SHA256hex(chainID(layerN-1) + " " + diffID(layerN))</p><p>docker/image/overlay2/layerdb/sha256 目录下保存了所有的chainID，可以发现在对应镜像的inspect中，只有第一层diffID与第一层的chainID相同。另外该文件夹包含了<strong>diff和cache-id</strong>等信息</p><p>chainID计算</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>echo</span> -n <span style=color:#c41a16>&#34;sha256:chainID(layerN-1) sha256:diffID(layerN)&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sha256sum | awk <span style=color:#c41a16>&#39;{print $1}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># eg:</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> -n <span style=color:#c41a16>&#34;sha256:2edcec3590a4ec7f40cf0743c15d78fb39d8326bc029073b41ef9727da6c851f sha256:e379e8aedd4d72bb4c529a4ca07a4e4d230b5a1d3f7a61bc80179e8f02421ad8&#34;</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>| sha256sum | awk <span style=color:#c41a16>&#39;{print $1}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=cacheid>cacheID</h2><p>cacheID的目录在 /var/lib/docker/overlay2/ 下。</p><h1 id=镜像目录文件>镜像目录文件</h1><p>Docker镜像是一个只读的容器模板，含有启动Docker容器所需的文件系统。Docker镜像的文件内容和一些运行容器的配置文件组成了Docker容器的文件系统运行环境——rootfs。</p><p>当使用docker pull下载一个nginx镜像后，可以在Docker的工作目录**/docker/image/overlay2** 下找到它的相关信息</p><h2 id=docker-image-overlay2><strong>docker/image/overlay2</strong></h2><h3 id=distribution><strong>distribution</strong></h3><h4 id=diffid-by-digest-sha256>diffid-by-digest/sha256</h4><p>保存了<strong>digest(layerID)->diffID</strong>的映射关系</p><h4 id=v2metadata-by-diffid-sha256>v2metadata-by-diffid/sha256</h4><p>保存了**diffid -> (digest,repository)**的映射关系</p><p>**digest(layerID)**就是 pull 镜像时的 <strong>hash ID</strong>，拉取是 镜像层文件是压缩文件，压缩态</p><p><strong>diffid</strong> 是 docker inspect 查看到的 镜像层 hash ID，此时 镜像层文件是解压缩的，解压缩态</p><h3 id=imagedb>imagedb</h3><p>保存镜像的元数据信息</p><h4 id=content-sha256>content/sha256</h4><p>镜像的<strong>元数据信息</strong>，包括<strong>镜像架构、操作系统、默认配置、创建时间、历史信息和rootfs</strong>等。</p><p>image元数据中layer的diffID是以底层到高层的顺序记录的</p><h4 id=metadata-sha256>metadata/sha256</h4><h3 id=layerdb>layerdb</h3><p>保存镜像层的关联关系</p><h4 id=sha256>sha256</h4><p>其下的目录名称是以layer的 <strong>chainID</strong> 来命名的，计算方式为：</p><p>1、如果layer是最底层，没有任何父layer，那么 <strong>diffID = chainID</strong></p><p>2、否则，<strong>chainID(n)=sha256sum(chainID(n-1)) diffID(n))</strong></p><p>各个chainID目录下：</p><p>1、cache-id</p><p>2、diff</p><p>3、parent</p><p>4、size</p><p>5、tar-split.json.gz</p><h3 id=repositories-json>repositories.json</h3><p>registry 是镜像仓库，如官方的Docker Hub。而 repository 代表镜像组（比如不同版本的 nginx 镜像集合）</p><p>该文件描述了宿主机上所有镜像的repository元数据，主要包括镜像名、tag和镜像ID。</p><p>镜像ID是Docker采用SHA256算法，根据镜像元数据配置文件计算得出的。</p><h1 id=容器>容器</h1><p>通过上面的分析得出，镜像是由多个layer组成的文件，并在容器启动时成为容器文件系统的运行环境——只读的rootfs。而容器其实就是Dokcer利用存储驱动在只读rootfs上挂载一个可读写层后的结果。</p><h2 id=联合挂载>联合挂载</h2><p>联合挂载技术可以在一个挂载点同时挂载多个文件系统，将挂载点的原目录与被挂载内容进行整合，使得最终可见的文件系统将会包含整合之后的各层的文件和目录。</p><p>Linux提供了一种叫做联合文件系统的文件系统，它具备如下特性：</p><p>1、联合挂载：将多个目录按层次组合，一并挂载到一个联合挂载点。</p><p>2、写时复制：对联合挂载点的修改不会影响到底层的多个目录，而是使用其他目录记录修改的操作。</p><p>目前有多种文件系统可以被当作联合文件系统，实现如上的功能：overlay2，aufs，devicemapper，btrfs，zfs，vfs等等。而overlay2就是其中的佼佼者，也是docker目前推荐的文件系统：<a href=https://docs.docker.com/storage/storagedriver/select-storage-driver/>https://docs.docker.com/storage/storagedriver/select-storage-driver/</a>。</p><h2 id=overlayfs>OverlayFS</h2><p>OverlayFS是一种堆叠文件系统，它依赖并建立在其它的文件系统之上（例如 ext4fs 和 xfs 等），并不直接参与磁盘空间结构的划分，仅仅将原来系统文件中的文件或者目录进行“合并一起”，最后向用户展示“合并”的文件时在同一级的目录，这就是联合挂载技术，相对于AUFS（&lt;1.12早期使用的存储技术），OverlayFS速度更快，实现更简单。</p><p>Linux内核为Docker提供的OverlayFS驱动有两种：Overlay和Overlay2。而Overlay2是相对于Overlay的一种改进，在lnode利用率方面比Overlay更有效。但是Overlay有环境需求：Docker版本17.06.02+，宿主机文件系统需要时EXT4或XFS格式。</p><h3 id=overlayfs实现方式>OverlayFS实现方式</h3><p>overlay2架构</p><p><img src=../imgs/docker_dir_1.png alt=docker_dir_1.png></p><p>它主要通过四类目录完成工作：</p><p><strong>lower</strong></p><p>底层文件系统。对于Docker来说，就是只读的镜像层；</p><p><strong>upper</strong></p><p>上层文件系统。对于Docker来说，就是可读写的容器层；</p><p><strong>merged</strong></p><p>是lowerdir和upperdir合并后的统一视图联合挂载点。对于Docker来说，就是用户视角下的文件系统；</p><p><strong>work</strong></p><p>工作基础目录，挂载后内容会被清空。用来存放挂载后的临时文件与间接文件。</p><h2 id=容器实战>容器实战</h2><p>启动容器后，观察系统中overlay2类型的挂载情况</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d -p 80:80 --name webserver nginx
</span></span><span style=display:flex><span><span style=color:#177500># 查看overlay挂载情况</span>
</span></span><span style=display:flex><span>mount -t overlay
</span></span><span style=display:flex><span><span style=color:#177500># 查看所有挂载情况</span>
</span></span><span style=display:flex><span>df -h
</span></span></code></pre></td></tr></table></div></div></div><p>根据输出结果可以找到overlay2的挂载点位置。总结如下：
1、/var/lib/docker/overlay2/l 目录保存的是软链接文件，其文件名是避免使用mount命令时输出结果达到页面大小限制而生成的短名称。</p><p>2、容器会自动生成一层的以读写层cache-id-init命名的init-layer，其中的文件配置了容器的主机名，DNS服务等。（init后缀的文件夹）</p><p>3、overlay2将upper和lower的文件系统联合挂载，就得到了用户视角下的文件系统</p><p>容器的文件系统分为三层: - r/o层：也就是镜像层 - init层：启动容器时的参数 - r/w层：可读写层</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker/image/overlay2/layerdb/mounts/&lt;container_full_id&gt;下
</span></span><span style=display:flex><span>init-id   <span style=color:#177500># init层的id</span>
</span></span><span style=display:flex><span>mount-id  <span style=color:#177500># r/w层的id</span>
</span></span><span style=display:flex><span>parent    <span style=color:#177500># 基于哪个layer</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这三个文件记录了在 /docker/overlay2/下的目录名
参考：<a href=https://zhuanlan.zhihu.com/p/95900321>浅谈docker中镜像和容器在本地的存储</a></p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>mount -t overlay
</span></span><span style=display:flex><span>cat /etc/mtab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /lower<span style=color:#000>{</span>1..3<span style=color:#000>}</span>
</span></span><span style=display:flex><span>mkdir /upper /work /merged
</span></span><span style=display:flex><span>mount -n -t overlay overlayfs:/overlay -o <span style=color:#000>lowerdir</span><span style=color:#000>=</span>/lower1:/lower2:/lower3,upperdir<span style=color:#000>=</span>/upper,workdir<span style=color:#000>=</span>/worker /merged
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mount | grep merged
</span></span><span style=display:flex><span><span style=color:#177500># 在/upper目录中写入文件，在merged中可以显示</span>
</span></span><span style=display:flex><span>touch /upper/upper.txt
</span></span><span style=display:flex><span>ls /merged/
</span></span><span style=display:flex><span><span style=color:#177500># 在merged目录中写入文件，实际上是存储到了/upper</span>
</span></span><span style=display:flex><span>touch /merged/merged.txt
</span></span><span style=display:flex><span>ls /upper/
</span></span><span style=display:flex><span><span style=color:#177500># 如果没有upperdir，merged是只读的</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /var/lib/docker/overlay2 
</span></span><span style=display:flex><span>du -sc * | sort -rn  | more
</span></span></code></pre></td></tr></table></div></div></details><br><h1 id=docker数据导出实战>Docker数据导出实战</h1><h2 id=脚本>脚本</h2><p>export-workspace.sh</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#633820>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#633820></span><span style=color:#a90d91>set</span> -e
</span></span><span style=display:flex><span><span style=color:#177500># set -x</span>
</span></span><span style=display:flex><span>get_docker_root<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$DOCKER_ROOT</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#000>$DOCKER_ROOT</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>docker_root</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>docker info | grep <span style=color:#c41a16>&#34;Docker Root Dir&#34;</span> | awk <span style=color:#c41a16>&#39;{print $NF}&#39;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$docker_root</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#000>docker_root</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;/var/lib/docker&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#000>$docker_root</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>get_container_id<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$ENVIRONMENT_ID</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>container_key</span><span style=color:#000>=</span><span style=color:#000>$ENVIRONMENT_ID</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_id</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>docker ps | grep <span style=color:#000>$container_key</span> | awk <span style=color:#c41a16>&#39;{print $1}&#39;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#000>$container_id</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>get_container_merged_dir<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_id</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_id<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$container_id</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;cannot find ENVIRONMENT_ID: </span><span style=color:#000>$ENVIRONMENT_ID</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_merged_dir</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>docker inspect <span style=color:#000>$container_id</span> | grep UpperDir | awk <span style=color:#c41a16>&#39;{print $NF}&#39;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span><span style=color:#177500>#  container_merged_dir=$(docker inspect $container_id | grep MergedDir | awk &#39;{print $NF}&#39;)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>container_merged_dir</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>${</span><span style=color:#000>container_merged_dir</span>#<span style=color:#c41a16>\&#34;</span><span style=color:#c41a16>}</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>container_merged_dir</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>${</span><span style=color:#000>container_merged_dir</span>%<span style=color:#c41a16>\&#34;</span>*<span style=color:#c41a16>}</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#000>$container_merged_dir</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>get_container_full_id_by_name<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>docker_root</span><span style=color:#000>=</span><span style=color:#000>$1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>name_key</span><span style=color:#000>=</span><span style=color:#000>$2</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_path</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$docker_root</span><span style=color:#c41a16>/containers&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ! <span style=color:#a90d91>test</span> -d <span style=color:#000>$container_path</span>  &gt; /dev/null 2&gt;&amp;1; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$container_path</span><span style=color:#c41a16> is not existed&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ! <span style=color:#a90d91>type</span> <span style=color:#c41a16>&#34;jq&#34;</span> &gt; /dev/null 2&gt;&amp;1; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    sudo apt-get install -y jq &gt; /dev/null
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_full_ids</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>cd</span> <span style=color:#000>$container_path</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>for</span> f in ./*
</span></span><span style=display:flex><span>  <span style=color:#a90d91>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#a90d91>test</span> -d <span style=color:#000>$f</span> ; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> cat <span style=color:#c41a16>&#34;</span><span style=color:#000>$f</span><span style=color:#c41a16>/config.v2.json&#34;</span> | jq . | grep <span style=color:#c41a16>&#34;Name&#34;</span> | grep -qs <span style=color:#000>$ENVIRONMENT_ID</span> ; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>local</span> <span style=color:#000>cur_full_id</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>${</span><span style=color:#000>f</span>##*/<span style=color:#c41a16>}</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;cur_full_id: </span><span style=color:#000>$cur_full_id</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>container_full_ids</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$container_full_ids</span><span style=color:#c41a16>;</span><span style=color:#000>$cur_full_id</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>done</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#000>$container_full_ids</span> | cut -c 2-  <span style=color:#177500># rm prefix ;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>get_container_full_id_by_id<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>docker_root</span><span style=color:#000>=</span><span style=color:#000>$1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_id</span><span style=color:#000>=</span><span style=color:#000>$2</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_path</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$docker_root</span><span style=color:#c41a16>/containers&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ! <span style=color:#a90d91>test</span> -d <span style=color:#000>$container_path</span>  &gt; /dev/null 2&gt;&amp;1; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$container_path</span><span style=color:#c41a16> is not existed&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>cd</span> <span style=color:#000>$container_path</span>
</span></span><span style=display:flex><span><span style=color:#177500>#  local container_full_ids=$(ls -al | grep $container_id | awk &#39;{print $NF}&#39;)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_full_ids</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>ls -al | grep <span style=color:#000>$container_id</span> | awk <span style=color:#c41a16>&#39;{print $NF}&#39;</span> | xargs | sed <span style=color:#c41a16>&#39;s/ /;/g&#39;</span><span style=color:#a90d91>)</span>  <span style=color:#177500># 变一行</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#000>$container_full_ids</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>get_container_mount_dir<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#177500># 1.get docker_root</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>docker_root</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_docker_root<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#177500># 2.get container_full_id</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$CONTAINER_ID</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#177500># 2.1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>container_full_ids</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_full_id_by_id <span style=color:#000>$docker_root</span> <span style=color:#000>$CONTAINER_ID</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;get_container_full_id_by_id container_full_ids: </span><span style=color:#000>$container_full_ids</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>  <span style=color:#177500># todo</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>elif</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$ENVIRONMENT_ID</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#177500># 2.2 list container</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>container_full_ids</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_full_id_by_name <span style=color:#000>$docker_root</span> <span style=color:#000>$ENVIRONMENT_ID</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;get_container_full_id_by_name container_full_ids: </span><span style=color:#000>$container_full_ids</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>  <span style=color:#177500># todo</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;ENVIRONMENT_ID and CONTAINER_ID is empty&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_full_id_count</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> <span style=color:#000>$container_full_ids</span> | awk -F<span style=color:#c41a16>&#34;;&#34;</span> <span style=color:#c41a16>&#39;{print NF}&#39;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;count: </span><span style=color:#000>$container_full_id_count</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>  <span style=color:#177500># todo</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#000>$container_full_id_count</span> -gt <span style=color:#1c01ce>1</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;there are multiple container: </span><span style=color:#000>$container_full_ids</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_full_id</span><span style=color:#000>=</span><span style=color:#000>$container_full_ids</span>  <span style=color:#177500># just one</span>
</span></span><span style=display:flex><span>  <span style=color:#177500># 3. mount_id</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>mount_id</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>cat <span style=color:#c41a16>&#34;</span><span style=color:#000>$docker_root</span><span style=color:#c41a16>/image/overlay2/layerdb/mounts/</span><span style=color:#000>$container_full_id</span><span style=color:#c41a16>/mount-id&#34;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#177500># 4. mount_idr</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>mount_dir</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$docker_root</span><span style=color:#c41a16>/overlay2/</span><span style=color:#000>$mount_id</span><span style=color:#c41a16>/diff&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#000>$mount_dir</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>export_workspace<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_id</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_id<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$DIR_MODE</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span> <span style=color:#000>||</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$CONTAINER_ID</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>container_diff_dir</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_mount_dir<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>elif</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$container_id</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>container_diff_dir</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_merged_dir<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>container_diff_dir</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>get_container_mount_dir<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$container_diff_dir</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>container_user_dir</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$container_diff_dir</span><span style=color:#c41a16>/home/</span><span style=color:#000>$USER_NAME</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;user_home: </span><span style=color:#000>$container_user_dir</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ! <span style=color:#a90d91>test</span> -d <span style=color:#000>$container_user_dir</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;user name err: </span><span style=color:#000>$USER_NAME</span><span style=color:#c41a16> in </span><span style=color:#000>$container_user_dir</span><span style=color:#c41a16>&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>cd</span> <span style=color:#000>$container_user_dir</span>
</span></span><span style=display:flex><span>  <span style=color:#000>curTime</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>date +<span style=color:#c41a16>&#34;%Y-%m-%d_%H-%M-%S&#34;</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>tar_workspace_path</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$TMP_PATH</span><span style=color:#c41a16>/byte-ide-</span><span style=color:#c41a16>${</span><span style=color:#000>ENVIRONMENT_ID</span><span style=color:#c41a16>}</span><span style=color:#c41a16>_</span><span style=color:#000>$curTime</span><span style=color:#c41a16>.tar.gz&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>local</span> <span style=color:#000>dist</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;workspace&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$DIST_PATH</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>dist</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$dist</span><span style=color:#c41a16>/</span><span style=color:#000>$DIST_PATH</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$EXCLUDE_DIR</span><span style=color:#c41a16>&#34;</span> !<span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>local</span> <span style=color:#000>exclude_dir</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$dist</span><span style=color:#c41a16>/</span><span style=color:#000>$EXCLUDE_DIR</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span>    tar -zcf <span style=color:#000>$tar_workspace_path</span> --exclude<span style=color:#000>=</span><span style=color:#000>$exclude_dir</span> <span style=color:#000>$dist</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>    tar -zcf <span style=color:#000>$tar_workspace_path</span> <span style=color:#000>$dist</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#a90d91>test</span> -f <span style=color:#000>$tar_workspace_path</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;start download </span><span style=color:#000>$tar_workspace_path</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span>    sz <span style=color:#000>$tar_workspace_path</span> <span style=color:#000>||</span> <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>    rm <span style=color:#000>$tar_workspace_path</span> <span style=color:#000>||</span> <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>check_params<span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$USER_NAME</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;USER_NAME is empty&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$CONTAINER_ID</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>[</span> <span style=color:#c41a16>&#34;</span><span style=color:#000>$ENVIRONMENT_ID</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span> <span style=color:#000>]</span> ; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;ENVIRONMENT_ID and CONTAINER_ID is empty&#34;</span> &gt;&amp;<span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>DOCKER_ROOT</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>DOCKER_ROOT</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>TMP_PATH</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>TMP_PATH</span><span style=color:#a90d91>:-</span>/tmp<span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>USER_NAME</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>USER_NAME</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>DIR_MODE</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>DIR_MODE</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>CONTAINER_ID</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>CONTAINER_ID</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>ENVIRONMENT_ID</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>ENVIRONMENT_ID</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>DIST_PATH</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>DIST_PATH</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span><span style=color:#000>EXCLUDE_DIR</span><span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>EXCLUDE_DIR</span><span style=color:#a90d91>:-</span><span style=color:#c41a16>&#34;&#34;</span><span style=color:#c41a16>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>## err log</span>
</span></span><span style=display:flex><span><span style=color:#177500>#TMP_ERR_LOG=$(mktemp)</span>
</span></span><span style=display:flex><span>check_params
</span></span><span style=display:flex><span>export_workspace
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=使用示例>使用示例</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 本地使用</span>
</span></span><span style=display:flex><span>sudo <span style=color:#000>ENVIRONMENT_ID</span><span style=color:#000>=</span><span style=color:#1c01ce>12345</span> <span style=color:#000>USER_NAME</span><span style=color:#000>=</span>zhangsan <span style=color:#000>DIST_PATH</span><span style=color:#000>=</span>apollo_sort <span style=color:#000>EXCLUDE_DIR</span><span style=color:#000>=</span>output sh export_workspace.sh
</span></span><span style=display:flex><span><span style=color:#177500># 远程使用</span>
</span></span><span style=display:flex><span>sudo curl -s http://xxx/export-workspace.sh | <span style=color:#000>ENVIRONMENT_ID</span><span style=color:#000>=</span><span style=color:#1c01ce>12345</span> <span style=color:#000>USER_NAME</span><span style=color:#000>=</span>zhangsan <span style=color:#000>DIST_PATH</span><span style=color:#000>=</span>apollo_sort <span style=color:#000>EXCLUDE_DIR</span><span style=color:#000>=</span>output sh
</span></span></code></pre></td></tr></table></div></div></div><h1 id=reference>Reference</h1><p><a href="https://blog.csdn.net/u010566813/article/details/117783220?spm=1001.2014.3001.5502">docker中各ID之间的关系和计算</a></p><p><a href=https://www.keepnight.com/archives/336/>https://www.keepnight.com/archives/336/</a></p><p><a href=https://juejin.cn/post/6844903574137208839>https://juejin.cn/post/6844903574137208839</a></p><p><a href=https://www.cnblogs.com/wdliu/p/10483252.html>https://www.cnblogs.com/wdliu/p/10483252.html</a></p><p><a href=https://docs.docker.com/storage/storagedriver/overlayfs-driver>官方文档：使用 OverlayFS 存储驱动程序</a></p><p><a href=https://zhuanlan.zhihu.com/p/374924046>手撕docker文件结构 —— overlayFS，image，container文件结构详解</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-95c79c407c4c8e9db9da6e562da9557c>3 - 21.docker路径修改</h1><h1 id=相关命令>相关命令</h1><h2 id=查看docker安装路径>查看docker安装路径</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker info | grep <span style=color:#c41a16>&#34;Docker Root Dir&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=修改docker路径>修改docker路径</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 默认目录：/var/lib/docker，注意软连接(/data00/docker)</span>
</span></span><span style=display:flex><span>vi /etc/docker/daemon.json <span style=color:#177500># 修改该文件的data-root，注：dockerd -graph已被废弃</span>
</span></span><span style=display:flex><span><span style=color:#c41a16>&#34;data-root&#34;</span>: <span style=color:#c41a16>&#34;/mnt/ide_drive/docker&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl restart docker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/lib/systemd/system/docker.service
</span></span><span style=display:flex><span>/usr/bin/dockerd -g /mnt/ide_drive/docker -H fd:// --containerd<span style=color:#000>=</span>/run/containerd/containerd.sock
</span></span><span style=display:flex><span>/usr/bin/dockerd --graph /mnt/ide_drive/docker --live-restore --storage-driver overlay2 --insecure-registry<span style=color:#000>=</span>hub.docker.com --insecure-registry<span style=color:#000>=</span>hub.docker.com:443 --insecure-registry<span style=color:#000>=</span>aliyun-sin-hub.docker.com --insecure-registry<span style=color:#000>=</span>aliyun-va-hub.docker.com -H fd://
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 卸载老版本</span>
</span></span><span style=display:flex><span><span style=color:#177500># dpkg -l | grep docker</span>
</span></span><span style=display:flex><span><span style=color:#177500># sudo apt-get remove docker docker-engine docker.io containerd runc</span>
</span></span><span style=display:flex><span>apt-get remove docker-ce-cli docker-ce  <span style=color:#177500># 亲测卸载用这个</span>
</span></span><span style=display:flex><span><span style=color:#177500># apt-get autoremove # 会自动卸载containerd.io等一干软件。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>netstat -anp | grep <span style=color:#1c01ce>14679</span>  <span style=color:#177500># 查看端口的进程id</span>
</span></span><span style=display:flex><span>pstree -a  <span style=color:#177500># 每个进程的完整指令，路径、参数  # https://developer.aliyun.com/article/689792</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker network ls
</span></span><span style=display:flex><span>docker network inspect bridge
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=docker目录>docker目录</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看容器目录</span>
</span></span><span style=display:flex><span>docker inspect &lt;container_id&gt;
</span></span><span style=display:flex><span><span style=color:#177500># 查看镜像目录</span>
</span></span><span style=display:flex><span>docker image inspect jre8:1.0 
</span></span></code></pre></td></tr></table></div></div></div><h3 id=容器的目录>容器的目录</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>mount -t overlay
</span></span><span style=display:flex><span>cat /etc/mtab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mount -n -t overlay overlayfs:/overlay -o <span style=color:#000>lowerdir</span><span style=color:#000>=</span>lower/,upperdir<span style=color:#000>=</span>upper/,workdir<span style=color:#000>=</span>worker/ merger/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /var/lib/docker/overlay2 
</span></span><span style=display:flex><span>du -sc * | sort -rn  | more
</span></span></code></pre></td></tr></table></div></div></div><h2 id=heading></h2><h2 id=清理相关命令>清理相关命令</h2><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker system prune --volumes
</span></span><span style=display:flex><span>清除：
</span></span><span style=display:flex><span>所有停止的容器
</span></span><span style=display:flex><span>所有不被任何一个容器使用的网络
</span></span><span style=display:flex><span>所有不被任何一个容器使用的volume
</span></span><span style=display:flex><span>所有无实例的镜像
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker system prune -a -f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker system df      <span style=color:#177500>#查看空间使用情况</span>
</span></span><span style=display:flex><span>docker system df -v   <span style=color:#177500>#命令可以进一步查看空间占用细节</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker system prune   <span style=color:#177500>#可对空间进行自动清理。也可以清理未释放的文件数</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>#该命令所清理的对象如下：</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>#已停止的容器</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>#未被任何容器使用的卷</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>#未被任何容器所关联的网络</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>#所有悬空的镜像</span>
</span></span><span style=display:flex><span>docker system prune      <span style=color:#177500>#后面可以加额外的参数，如：</span>
</span></span><span style=display:flex><span>docker system prune -a ： <span style=color:#177500>#一并清除所有未被使用的镜像和悬空镜像。</span>
</span></span><span style=display:flex><span>docker system prune -f ： <span style=color:#177500>#用以强制删除，不提示信息。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker image prune <span style=color:#177500>#删除悬空的镜像。</span>
</span></span><span style=display:flex><span>docker container prune <span style=color:#177500>#删除无用的容器。</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>#--默认情况下docker container prune 命令会清理掉所有处于stopped状态的容器</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>#--如果不想那么残忍统统都删掉，也可以使用--filter标志来筛选出不希望被清理掉的容器。例子：清除掉所有停掉的容器，但24内创建的除外：</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>#-- docker container prune --filter &#34;until=24h&#34;  </span>
</span></span><span style=display:flex><span>docker volume prune <span style=color:#177500>#删除无用的卷。</span>
</span></span><span style=display:flex><span>docker network prune <span style=color:#177500>#删除无用的网络</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>#对于悬空镜像和未使用镜像可以使用手动进行个别删除：</span>
</span></span><span style=display:flex><span><span style=color:#177500>#1、删除所有悬空镜像，不删除未使用镜像：</span>
</span></span><span style=display:flex><span>docker rmi <span style=color:#a90d91>$(</span>docker images -f <span style=color:#c41a16>&#34;dangling=true&#34;</span> -q<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span><span style=color:#177500>#2、删除所有未使用镜像和悬空镜像</span>
</span></span><span style=display:flex><span>docker rmi <span style=color:#a90d91>$(</span>docker images -q<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span><span style=color:#177500>#3、清理卷</span>
</span></span><span style=display:flex><span><span style=color:#177500>#如果卷占用空间过高，可以清除一些不使用的卷，包括一些未被任何容器调用的卷（-v 详细信息中若显示 LINKS = 0，则是未被调用）：</span>
</span></span><span style=display:flex><span><span style=color:#177500>#删除所有未被容器引用的卷：</span>
</span></span><span style=display:flex><span>docker volume rm <span style=color:#a90d91>$(</span>docker volume ls -qf <span style=color:#000>dangling</span><span style=color:#000>=</span><span style=color:#a90d91>true</span><span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span><span style=color:#177500>#4、容器清理</span>
</span></span><span style=display:flex><span><span style=color:#177500>#如果发现是容器占用过高的空间，可以手动删除一些：</span>
</span></span><span style=display:flex><span><span style=color:#177500>#删除所有已退出的容器：</span>
</span></span><span style=display:flex><span>docker rm -v <span style=color:#a90d91>$(</span>docker ps -aq -f <span style=color:#000>status</span><span style=color:#000>=</span>exited<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span><span style=color:#177500>#删除所有状态为dead的容器</span>
</span></span><span style=display:flex><span>docker rm -v <span style=color:#a90d91>$(</span>docker ps -aq -f <span style=color:#000>status</span><span style=color:#000>=</span>dead<span style=color:#a90d91>)</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=修改安装路径脚本>修改安装路径脚本</h2><p>第一版，问题：文件不存在未考虑，空文件和空内容未考虑</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>daemon_json_file</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;/etc/docker/daemon.json&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> grep -qs <span style=color:#c41a16>&#39;&#34;data-root&#34;&#39;</span> <span style=color:#000>$daemon_json_file</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ! <span style=color:#a90d91>type</span> <span style=color:#c41a16>&#34;jq&#34;</span> &gt; /dev/null 2&gt;&amp;1; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;# start install jq&#34;</span>
</span></span><span style=display:flex><span>    sudo apt-get install -y jq &gt; /dev/null
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#000>tmp</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>mktemp<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  sudo jq <span style=color:#c41a16>&#34;.\&#34;data-root\&#34;= \&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34;&#34;</span> <span style=color:#000>$daemon_json_file</span> &gt; <span style=color:#c41a16>&#34;</span><span style=color:#000>$tmp</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>&amp;&amp;</span> sudo mv <span style=color:#c41a16>&#34;</span><span style=color:#000>$tmp</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>$daemon_json_file</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;# alter \&#34;data-root\&#34;=\&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34; in </span><span style=color:#000>$daemon_json_file</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>  sudo sed -i <span style=color:#c41a16>&#34;s#{#{
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    \&#34;data-root\&#34;: \&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34;,#1&#34;</span> <span style=color:#000>$daemon_json_file</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;# add \&#34;data-root\&#34;=\&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34; in </span><span style=color:#000>$daemon_json_file</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fi</span>
</span></span></code></pre></td></tr></table></div></div></div><p>第二版<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>daemon_json_file</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;/etc/docker/daemon.json&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>[</span> ! -d <span style=color:#c41a16>&#34;</span><span style=color:#000>$daemon_json_file</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>  sudo <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;{  \&#34;data-root\&#34;: \&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34;}&#34;</span> &gt; <span style=color:#000>$daemon_json_file</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> ! <span style=color:#a90d91>type</span> <span style=color:#c41a16>&#34;jq&#34;</span> &gt; /dev/null 2&gt;&amp;1; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;# start install jq&#34;</span>
</span></span><span style=display:flex><span>    sudo apt-get install -y jq &gt; /dev/null
</span></span><span style=display:flex><span>  <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#000>tmp</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>mktemp<span style=color:#a90d91>)</span>
</span></span><span style=display:flex><span>  sudo jq <span style=color:#c41a16>&#34;.\&#34;data-root\&#34;= \&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34;&#34;</span> <span style=color:#000>$daemon_json_file</span> &gt; <span style=color:#c41a16>&#34;</span><span style=color:#000>$tmp</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>&amp;&amp;</span> sudo mv <span style=color:#c41a16>&#34;</span><span style=color:#000>$tmp</span><span style=color:#c41a16>&#34;</span> <span style=color:#000>$daemon_json_file</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;# alter \&#34;data-root\&#34;=\&#34;</span><span style=color:#000>$mount_docker_path</span><span style=color:#c41a16>\&#34; in </span><span style=color:#000>$daemon_json_file</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fi</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=问题排查>问题排查</h2><h3 id=docker启动报错>docker启动报错</h3><p>Job for docker.service failed because the control process exited with error code. See "systemctl status docker.service" and "journalctl -xe" for details.</p><p>一般是daemon.json文件配置错误，不符合json格式</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>systemctl status docker.service -l  # 查看Error
</span></span></code></pre></td></tr></table></div></div></div><h3 id=网络访问不通>网络访问不通</h3><p>g"docker桥接网络访问不通"</p><p>eth0 网段正好跟docker0是相同网段</p><p>在/etc/docker/daemon.json中增加一行，如：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#c41a16>&#34;bip&#34;</span><span style=color:#000>:</span> <span style=color:#c41a16>&#34;192.168.1.5/24&#34;</span><span style=color:#000>,</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://cloud.tencent.com/developer/article/1768097>https://cloud.tencent.com/developer/article/1768097</a></p><h1 id=reference>Reference</h1><p><a href=https://www.digitalocean.com/community/questions/how-to-move-the-default-var-lib-docker-to-another-directory-for-docker-on-linux>How to move the default /var/lib/docker to another directory for Docker on Linux?</a></p><p><a href=https://zhuanlan.zhihu.com/p/377624621>Docker 常见疑难杂症解决方案</a></p><p><a href=https://www.cnblogs.com/fan-gx/p/12804835.html>一次遇到too many open files的解决详情</a></p><p><a href=https://get.docker.com/>https://get.docker.com/</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f4c17e11167c018806258fd3fd777977>4 - 22.dockerd</h1><h1 id=概述>概述</h1><p>docker是client+server架构，可通过 docker version分别看到客户端和服务端的信息。</p><p>执行docker相关命令实际上是通过客户端将请求发送到当前电脑的Docker Daemon服务上，由Docker Daemon返回信息，客户端收到信息后展示在控制台上。</p><p>官方解释：<a href=https://docs.docker.com/engine/reference/commandline/dockerd/#description>https://docs.docker.com/engine/reference/commandline/dockerd/#description</a></p><h1 id=docker组件>Docker组件</h1><h2 id=docker-cli-docker>Docker CLI(docker)</h2><p>docker 程序是一个客户端工具，用来把用户的请求发送给 docker daemon(dockerd)。</p><p>该程序的安装路径为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/docker
</span></span></code></pre></td></tr></table></div></div></div><h2 id=dockerd>Dockerd</h2><p>docker daemon(dockerd)，一般也会被称为 docker engine。</p><p>该程序的安装路径为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/dockerd
</span></span></code></pre></td></tr></table></div></div></div><h2 id=containerd>Containerd</h2><p>在宿主机中管理完整的容器生命周期：容器镜像的传输和存储、容器的执行和管理、存储和网络等。</p><p>该程序的安装路径为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>/usr/bin/docker-containerd
</span></span></code></pre></td></tr></table></div></div></div><h2 id=containerd-shim>Containerd-shim</h2><p>它是 containerd 的组件，是容器的运行时载体，主要是用于剥离 containerd 守护进程与容器进程，引入shim，允许runc 在创建和运行容器之后退出，并将 shim 作为容器的父进程，而不是 containerd 作为父进程，这样做的目的是当 containerd 进程挂掉，由于 shim 还正常运行，因此可以保证容器不受影响。此外，shim 也可以收集和报告容器的退出状态，不需要 containerd 来 wait 容器进程。我们在 docker 宿主机上看到的 shim 也正是代表着一个个通过调用 containerd 启动的 docker 容器。</p><p>该程序的安装路径为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/docker-containerd-shim
</span></span></code></pre></td></tr></table></div></div></div><h2 id=runc>RunC</h2><p>RunC 是一个轻量级的工具，它是用来运行容器的，容器作为 runC 的子进程开启，在不需要运行一个 Docker daemon 的情况下可以嵌入到其他各种系统，也就是说可以不用通过 docker 引擎，直接运行容器。docker是通过Containerd调用 runC 运行容器的</p><p>该程序的安装路径为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/docker-runc
</span></span></code></pre></td></tr></table></div></div></div><h1 id=docker-deamon连接方式>Docker Deamon连接方式</h1><p>官方文档：<a href=https://docs.docker.com/engine/reference/commandline/dockerd/#description>https://docs.docker.com/engine/reference/commandline/dockerd/#description</a></p><h2 id=unix套接字>Unix套接字</h2><p>默认就是这种方式, 会生成一个 /var/run/docker.sock 文件, UNIX 域套接字用于本地进程之间的通讯, 这种方式相比于网络套接字效率更高, 但局限性就是只能被本地的客户端访问。</p><h2 id=tcp端口监听>TCP端口监听</h2><p>服务端开启端口监听 dockerd -H IP:PORT , 客户端通过指定IP和端口访问服务端 docker -H IP:PORT 。通过这种方式, 任何人只要知道了你暴露的ip和端口就能随意访问你的docker服务了, 这是一件很危险的事, 因为docker的权限很高, 不法分子可以从这突破取得服务端宿主机的最高权限。</p><h2 id=连接方式设置>连接方式设置</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 查看配置文件位置，Loaded字段，修改配置文件</span>
</span></span><span style=display:flex><span>systemctl status docker  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 配置文件修改 如</span>
</span></span><span style=display:flex><span>-H unix:///var/run/docker.sock -H tcp://192.168.59.106 -H tcp://10.10.10.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 重启docker</span>
</span></span><span style=display:flex><span>systemctl restart docker  
</span></span></code></pre></td></tr></table></div></div></div><h2 id=问题>问题</h2><h3 id=dockerd-h-fd-是什么意思>dockerd -H fd://是什么意思</h3><p>-H fd://在 systemd 中运行 docker 时使用该语法。Systemd 本身会在 docker.socket 单元文件中创建一个套接字并监听它，这个套接字使用fd://docker.service 单元文件中的语法连接到 docker 守护进程。</p><p>所以直接使用以下命令是错误的，因为不是使用systemd</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ /usr/bin/dockerd -H fd://
</span></span><span style=display:flex><span>Failed to load listeners: no sockets found via socket activation: make sure the service was started by systemd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 可不指定通信方式，默认使用 /var/run/docker.sock 通信</span>
</span></span><span style=display:flex><span>$ /usr/bin/dockerd
</span></span><span style=display:flex><span>xxx
</span></span><span style=display:flex><span>INFO<span style=color:#000>[</span>2022-02-18T09:25:56.831993805Z<span style=color:#000>]</span> API listen on /var/run/docker.sock
</span></span><span style=display:flex><span><span style=color:#177500># 在另外一个终端使用docker命令能正常工作</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ /usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://10.231.243.5  <span style=color:#177500># 当前机器ip</span>
</span></span><span style=display:flex><span>xxx
</span></span><span style=display:flex><span>INFO<span style=color:#000>[</span>2022-02-18T09:30:42.680110643Z<span style=color:#000>]</span> API listen on /var/run/docker.sock
</span></span><span style=display:flex><span>INFO<span style=color:#000>[</span>2022-02-18T09:30:42.680141327Z<span style=color:#000>]</span> API listen on 10.231.243.5:2375
</span></span><span style=display:flex><span>$ docker xx <span style=color:#177500># 当前机器访问</span>
</span></span><span style=display:flex><span>$ curl -s 10.231.243.5:2375/images/json | python -m json.tool  <span style=color:#177500># 其它机器访问</span>
</span></span></code></pre></td></tr></table></div></div></div><p>参考：
<a href=https://stackoverflow.com/questions/43303507/what-does-fd-mean-exactly-in-dockerd-h-fd>https://stackoverflow.com/questions/43303507/what-does-fd-mean-exactly-in-dockerd-h-fd</a></p><p><a href=https://blog.csdn.net/michaelwoshi/article/details/107601744>https://blog.csdn.net/michaelwoshi/article/details/107601744</a></p><h1 id=api>API</h1><p>详见：<a href=https://docs.docker.com/engine/api/v1.39/>https://docs.docker.com/engine/api/v1.39/</a></p><h1 id=实战>实战</h1><h2 id=容器内访问dockerd>容器内访问dockerd</h2><p>挂载以下两个目录即可：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#c41a16>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>, <span style=color:#c41a16>&#34;/usr/bin/docker:/usr/bin/docker&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建容器并挂载目录</span>
</span></span><span style=display:flex><span>docker run -d -p 80:80 -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker --name webserver nginx
</span></span><span style=display:flex><span>或
</span></span><span style=display:flex><span>docker run -it -p 80:80 -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker --name webserver nginx /bin/bash
</span></span></code></pre></td></tr></table></div></div></div><p>如果指定docker命令报错：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>docker: error while loading shared libraries: libltdl.so.7: cannot open shared object file: No such file or directory
</span></span></code></pre></td></tr></table></div></div></div></p><p>执行以下命令解决：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>apt-get update
</span></span><span style=display:flex><span>apt-get install -y libltdl7
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=模拟http请求>模拟http请求</h2><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s --unix-socket /var/run/docker.sock &lt;url&gt;
</span></span><span style=display:flex><span><span style=color:#177500># 注意url需要增加localhost或127.0.0.1前缀</span>
</span></span><span style=display:flex><span>curl -s --unix-socket /var/run/docker.sock http://localhost/images/json
</span></span><span style=display:flex><span><span style=color:#177500># 并格式化json，或 jq .</span>
</span></span><span style=display:flex><span>curl -s --unix-socket /var/run/docker.sock localhost/images/json | python -m json.tool  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl --unix-socket /var/run/docker.sock http://localhost/version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -s 10.231.243.5:2375/images/json | python -m json.tool
</span></span></code></pre></td></tr></table></div></div></div><h1 id=reference>Reference</h1><p><a href=https://docs.docker.com/engine/api/v1.39/>https://docs.docker.com/engine/api/v1.39/</a></p><p><a href=https://docs.docker.com/engine/reference/commandline/dockerd/#description>https://docs.docker.com/engine/reference/commandline/dockerd/#description</a></p><p><a href=https://github.com/moby/moby/blob/41be7293f54f15dc04f024bf2b0f09e1a697208b/daemon/listeners/listeners_linux.go#L63>docker daemon启动-H fd://代码</a></p><p><a href=https://cloud.tencent.com/developer/article/1697053>如何在Docker容器中运行Docker [3种方法]</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c1880f7042ae36f17ca371e2d8a67f10>5 - 51.kubernetes01</h1><h1 id=介绍说明>介绍说明</h1><p>中文文档：<a href=https://kubernetes.io/docs/home/>https://kubernetes.io/docs/home/</a></p><h2 id=资源管理器对比>资源管理器对比</h2><h2 id=k8s优势>K8S优势</h2><ul><li>轻量级：消耗资源少</li><li>开源</li><li>弹性伸缩</li><li>负载均衡：IPVS
适合人群：软件工程师、测试工程师、运维工程师、软件工程师、运维</li></ul><h2 id=k8s组件说明>K8S组件说明</h2><p>K8S架构</p><p><img src=../imgs/k8s01_1.png alt=k8s01_1.png></p><p>Api-server：所有服务访问统一入口</p><p>Controller Manager：维持副本期望数目</p><p>Scheuler：负责介绍任务，选择合适的节点进行分配任务</p><p>ETCD：键值对数据库，储存K8S集群所有重要信息（持久化）</p><p>Kubelet：直接跟容器引擎交互实现容器的声明周期管理</p><p>Kube-proxy：负责写入规则至 IPTABLES、IPVS，实现服务映射访问</p><p>CoreDNS：为集群中的SVC创建一个域名IP的对应关系解析</p><p>Dashboard：给K8S集群提供一个 B/S 结构访问体系</p><p>Ingress：官方只能实现四层代理，INGRESS可以实现七层代理</p><p>Federation：提供一个可以跨集群中心多K8S统一管理功能</p><p>Prometheus：提供K8S集群的监控能力</p><p>ELK：提供K8S集群日志统一分析介入平台</p><p>额外说明</p><p>kubeadm：用来初始化集群的指令。</p><p>kubelet：在集群中的每个节点上用来启动 pod 和容器等。</p><p>kubectl：用来与集群通信的命令行工具</p><h3 id=borg组件说明>Borg组件说明</h3><h3 id=k8s结构说明>K8S结构说明</h3><h4 id=网络结构>网络结构</h4><h4 id=组件结构>组件结构</h4><h1 id=基础概念>基础概念</h1><h2 id=pod概念>Pod概念</h2><h3 id=自主式pod>自主式Pod</h3><p>Pod退出了，此类型的Pod不会被创建</p><h3 id=控制器管理的pod>控制器管理的Pod</h3><p>在控制器的生命周期里，始终要维持Pod的副本数目</p><h3 id=pod控制器类型>Pod控制器类型</h3><h4 id=rs-rc概念>RS、RC概念</h4><p>ReplicationController</p><p>ReplicaSet</p><h4 id=deployment概念>deployment概念</h4><h4 id=hpa概念>HPA概念</h4><p>Horizontal Pod Autoscaling 仅适用于Deployment和ReplicaSet，在V1版本中仅支持根据Pod的CPU利用率扩缩容，在v1alpha版本中，支持根据内存和用户自定义的metric扩缩容</p><h4 id=statefullset概念>StatefullSet概念</h4><p>StatefulSet是为了解决有状态服务的问题（对应Deployments和ReplicaSets是为无状态服务而设计），其应用场景包括：</p><p>1、稳定的持久化存储, 即Pod重新调度后还是能访问到相同的持久化数据, 基于PVC来实现</p><p>2、稳定的网络标志, 即Pod重新调度后其PodName和HostName不变, 基于Headless Service</p><p>（即没有ClusterIP的Service）来实现</p><p>3、有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是 Running 和 Ready 状态）， 基于 init containers 来实现</p><p>4、有序收缩, 有序删除（即从N-1到0）</p><h4 id=daemonset概念>DaemonSet概念</h4><p>DaemonSet 确保全部（或者一些）Node上运行一个Pod的副本。当有Node加入集群时，也会为他们新增一个Pod。当有Node从集群移除时, 这些Pod也会被回收。删除DaemonSet将会删除它创建的所有Pod。</p><p>使用DaemonSet的一些典型用法: </p><p>1、运行集群存储 daemon，例如在每个Node上运行 glusterd、ceph。</p><p>2、在每个 Node 上运行日志收集 daemon，例如 fluentd、1ogstash。</p><p>3、在每个 Node 上运行监控 daemon，例如 Prometheus Node Exporter</p><h4 id=job-cronjob概念>Job、CronJob概念</h4><p>Job负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个Pod成功结束</p><p>Cron Job管理基于时间的Job，即： </p><p>1、在给定时间点只运行一次</p><p>2、周期性地在给定时间点运行</p><h3 id=服务发现>服务发现</h3><h3 id=pod协同>Pod协同</h3><h2 id=网络通讯模式>网络通讯模式</h2><p>Kubernetes的网络模型假定了所有Pod都在一个可以直接连通的扁平的网络空间中，这在</p><p>GCE（Google Compute Engine）里面是现成的网络模型，Kubernetes假定这个网络已经存在。</p><p>而在私有云里搭建Kubernetes集群，就不能假定这个网络已经存在了。我们需要自己实现这</p><p>个网络假设，将不同节点上的Docker容器之间的互相访问先打通，然后运行Kubernetes</p><p>同一个 Pod 内的多个容器：localhost（lo）</p><p>各 Pod 之间的通讯：Overlay Network</p><p>Pod 与 Service之间的通讯：各节点的 Iptables 规则</p><p><strong>Flannel</strong> 是 Core0S 团队针对 Kubernetes 设计的一个网络规划服务，简单来说，它的功能是</p><p><strong>让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址</strong>。而且它还能在</p><p>这些IP地址之间建立一个<strong>覆盖网络（0verlayNetwork）</strong>，通过这个覆盖网络，将数据包原封</p><p>不动地传递到目标容器内。</p><p>基本思想是二次封装做转发。如下图所示：</p><p><img src=../imgs/k8s01_2.png alt=k8s01_2.png></p><p>ETCD 之 Flannel 提供说明：</p><p>1、存储管理 Flannel 可分配的 IP 地址段资源</p><p>2、监控 ETCD 中每个 Pod 的实际地址，并在内存中建立维护 Pod 节点路由表</p><p><strong>同一个Pod内部通讯</strong></p><p>同一个Pod共享同一个网络命名空间, 共享同一个Linux协议栈</p><p><strong>Podl至Pod2</strong></p><p>1、Podl与Pod2不在同一台主机</p><p>Pod的地址是与docker0在同一个网段的, 但docker0网段与宿主机网卡是两个完全不同的IP网段, 并且不同Node之间的通信只能通过宿主机的物理网卡进行。将Pod的IP和所在Node的IP关联起来, 通过这个关联让Pod可以互相访问（如经过Flannel）</p><p>2、Pod与Pod2在同一台机器</p><p>由Docker0网桥直接转发请求至Pod2, 不需要经过Flannel</p><p><strong>Pod至Service的网络</strong></p><p>目前基于性能考虑, 全部为iptables维护和转发（最新使用LVS性能会更高）</p><p><strong>Pod到外网</strong></p><p>Pod向外网发送请求, 查找路由表, 转发数据包到宿主机的网卡, 宿主网卡完成路由选择后, iptables执行Masaquerade, 把源IP更改为宿主网卡的IP, 然后向外网服务器发送请求</p><p><strong>外网访问Pod</strong></p><p>Service</p><h3 id=网络通讯模式说明>网络通讯模式说明</h3><h3 id=组件通讯模式说明>组件通讯模式说明</h3><h1 id=k8s安装>K8S安装</h1><h2 id=安装方式介绍>安装方式介绍</h2><h3 id=minikube>minikube</h3><p>只是一个K8S集群模拟器，只有一个节点的集群，只为测试用，master和worker都在一起</p><p>需要提前安装好docker。</p><p><a href=https://minikube.sigs.k8s.io/docs/start>minikube官方安装指南</a></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 启动集群</span>
</span></span><span style=display:flex><span>minikube start
</span></span><span style=display:flex><span><span style=color:#177500># 查看节点。kubectl是一个用来跟K8S集群进行交互的命令行工具</span>
</span></span><span style=display:flex><span>kubectl get node
</span></span><span style=display:flex><span><span style=color:#177500># 停止集群</span>
</span></span><span style=display:flex><span>minikube stop
</span></span><span style=display:flex><span><span style=color:#177500># 清空集群</span>
</span></span><span style=display:flex><span>minikube delete --all
</span></span><span style=display:flex><span><span style=color:#177500># 安装集群可视化Web UI控制台</span>
</span></span><span style=display:flex><span>minikube dashboard
</span></span></code></pre></td></tr></table></div></div></div><h3 id=云平台搭建>云平台搭建</h3><p>可视化搭建，只需简单几步就可以创建好一个集群</p><p>优点：安装简单，生态齐全，负载均衡器、存储等都分配好。简单操作就行。</p><p>1、腾讯云TKE-控制台搜索容器</p><p>2、阿里云控制台-产品搜索Kubernetes</p><h3 id=裸机安装-bare-metal>裸机安装（Bare Metal）</h3><p>至少需要两台机器（主节点、工作节点各一台），需要自己安装Kubernetes组件，配置会稍微麻烦点。可以租用云厂商服务器，费用低，用完销毁。</p><p>缺点：配置麻烦，缺少生态支持，例如负载均衡器、云存储。</p><h4 id=主节点需要组件>主节点需要组件</h4><p>1、docker（也可以其它容器运行时）</p><p>2、kubectl集群命令行交互工具</p><p>3、kubeadm集群初始化工具</p><h4 id=工作节点需要组件>工作节点需要组件</h4><p>1、docker（也可以其它容器运行时）</p><p>2、kubelet管理Pod和容器，确保健康运行</p><p>3、kube-proxy网络代理，负责网络相关工作</p><h4 id=开始安装>开始安装</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 每个节点分别设置对应主机名</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname master
</span></span><span style=display:flex><span>hostnamectl set-hostname node1
</span></span><span style=display:flex><span>hostnamectl set-hostname node2
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 所有节点都修改hosts</span>
</span></span><span style=display:flex><span>vi /etc/hosts
</span></span><span style=display:flex><span>172.16.32.2 node1
</span></span><span style=display:flex><span>172.16.32.6 node2
</span></span><span style=display:flex><span>172.16.0.4 master
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 所有节点关闭 SELinux</span>
</span></span><span style=display:flex><span>setenforce <span style=color:#1c01ce>0</span>
</span></span><span style=display:flex><span>sed -i --follow-symlinks <span style=color:#c41a16>&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/sysconfig/selinux
</span></span></code></pre></td></tr></table></div></div></div><p>注意：所有节点确保防火墙关闭<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl stop firewalld
</span></span><span style=display:flex><span>systemctl disable firewalld
</span></span></code></pre></td></tr></table></div></div></div></p><p>添加安装源（所有节点）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 添加 k8s 安装源
</span></span><span style=display:flex><span>cat &lt;&lt;EOF &gt; kubernetes.repo
</span></span><span style=display:flex><span>[kubernetes]
</span></span><span style=display:flex><span>name=Kubernetes
</span></span><span style=display:flex><span>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span><span style=display:flex><span>enabled=1
</span></span><span style=display:flex><span>gpgcheck=1
</span></span><span style=display:flex><span>repo_gpgcheck=1
</span></span><span style=display:flex><span>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>mv kubernetes.repo /etc/yum.repos.d/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 添加 Docker 安装源
</span></span><span style=display:flex><span>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span></code></pre></td></tr></table></div></div></div></p><p>安装所需组件（所有节点）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>yum install -y kubelet kubeadm kubectl docker-ce
</span></span></code></pre></td></tr></table></div></div></div></p><p>启动 kubelet、docker，并设置开机启动（所有节点）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>systemctl enable kubelet
</span></span><span style=display:flex><span>systemctl start kubelet
</span></span><span style=display:flex><span>systemctl enable docker
</span></span><span style=display:flex><span>systemctl start docker
</span></span></code></pre></td></tr></table></div></div></div></p><p>修改 docker 配置（所有节点）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># kubernetes 官方推荐 docker 等使用 systemd 作为 cgroupdriver，否则 kubelet 启动不了
</span></span><span style=display:flex><span>cat &lt;&lt;EOF &gt; daemon.json
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span><span style=display:flex><span>  &#34;registry-mirrors&#34;: [&#34;https://ud6340vz.mirror.aliyuncs.com&#34;]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>mv daemon.json /etc/docker/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 重启生效
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart docker
</span></span></code></pre></td></tr></table></div></div></div></p><p>用 <a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/>kubeadm</a> 初始化集群（仅在主节点跑），<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 初始化集群控制台 Control plane
</span></span><span style=display:flex><span># 失败了可以用 kubeadm reset 重置
</span></span><span style=display:flex><span>kubeadm init --image-repository=registry.aliyuncs.com/google_containers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 记得把 kubeadm join xxx 保存起来
</span></span><span style=display:flex><span># 忘记了重新获取：kubeadm token create --print-join-command
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 复制授权文件，以便 kubectl 可以有权限访问集群
</span></span><span style=display:flex><span>mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>chown $(id -u):$(id -g) $HOME/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 在其他机器上创建 ~/.kube/config 文件也能通过 kubectl 访问到集群
</span></span></code></pre></td></tr></table></div></div></div></p><p>有兴趣了解 kubeadm init 具体做了什么的，可以 <a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/>查看文档</a>
把工作节点加入集群（只在工作节点跑）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span># 执行上一步 kubeadm init 之后 界面会打印下面的指令
</span></span><span style=display:flex><span>kubeadm join 172.16.32.10:6443 --token xxx --discovery-token-ca-cert-hash xxx
</span></span></code></pre></td></tr></table></div></div></div><p>安装网络插件，否则 node 是 NotReady 状态（主节点跑）<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></td></tr></table></div></div></div></p><p>查看节点，要在主节点查看（其他节点有安装 kubectl 也可以查看）</p><h2 id=系统初始化>系统初始化</h2><h2 id=k8s部署安装>K8S部署安装</h2><p>Harbor使用Cenot7或内核3.1以上（最新最好4.4，有些bug导致docker意外重启）能避免较多问题（老版本不支持某些命名空间、Overlay的文件系统需要编译内核加载等）</p><p><img src=../imgs/k8s01_3.png alt=k8s01_3.png></p><h3 id=node安装>Node安装</h3><p>kubeadm安装k8s，kube-system命名空间</p><h3 id=harbor安装>Harbor安装</h3><p>私有镜像仓库</p><h2 id=常见问题分析>常见问题分析</h2><h1 id=资源清单>资源清单</h1><h2 id=k8s资源概念>K8S资源概念</h2><h3 id=资源定义>资源定义</h3><p>K8S中所有的内容都抽象为资源，资源实例化之后，叫做对象。</p><h3 id=名称空间级别资源>名称空间级别资源</h3><p>工作负载型资源（workload）</p><p>Pod、ReplicaSet、Deployment、StatefulSet、DaemonSet、Job、CronJob（ReplicationController在v1.11版本被废弃）</p><p>服务发现及负载均衡型资源（ServiceDiscovery LoadBalbance）</p><p>Service、Ingress、...</p><p>配置与存储型资源</p><p>Volume（存储卷）、GSI（容器存储接口，可以扩展各种各样的第三方存储卷）</p><p>特殊类型的存储卷</p><p>ConfigMap（当配置中心来使用的资源类型）、Secret（保存敏感数据）、DownwardAPI（把外部环境中的信息输出给容器）</p><h3 id=集群级别资源>集群级别资源</h3><p>Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</p><h3 id=元数据型资源>元数据型资源</h3><p>HPA、PodTemplate、LimitRange</p><h2 id=资源清单含义>资源清单含义</h2><p>在K8S中，一般使用yaml格式的文件来创建符合我们预期期望的pod，这样的yaml文件我们一般称为资源清单</p><h3 id=yaml语法格式>yaml语法格式</h3><h4 id=基本语法>基本语法</h4><p>1、缩进时不允许使用Tab键，只允许使用空格</p><p>2、缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</p><p>3、标识注释，从这个字符一直到行尾，都会被解释器忽略</p><h4 id=yaml支持的数据结构>yaml支持的数据结构</h4><p>对象</p><p>键值对的集合，又称为映射（mapping）/哈希（hashes）、字典（dictionary）</p><p>数组</p><p>一组按次序排列的值，又称为序列（sequence）/列表</p><p>纯量（scalars）</p><p>单个的、不可再分的值。</p><h4 id=对象类型>对象类型</h4><p>对象的一组键值对，使用冒号结构表示</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>name</span>: <span style=color:#1c01ce>zhangsan</span>
</span></span><span style=display:flex><span><span style=color:#000>age</span>: <span style=color:#1c01ce>20</span>
</span></span></code></pre></td></tr></table></div></div></div><p>yaml也允许另外一种写法，将所有键值对写成一个行内对象<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>hash</span>: { <span style=color:#000>name: zhangsan, age</span>: <span style=color:#1c01ce>20</span>}
</span></span></code></pre></td></tr></table></div></div></div></p><p>数组也可以采用行内表示法<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>animal</span>: [<span style=color:#1c01ce>Dog, Cat]</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>纯量
如字符串、布尔值、整数、浮点数、null、时间、日期</p><p>其中null用~表示</p><p>允许使用两个感叹号，强制转换数据类型，如</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>e</span>: <span style=color:#633820>!!str</span> <span style=color:#1c01ce>123</span>
</span></span><span style=display:flex><span><span style=color:#000>f</span>: <span style=color:#633820>!!str</span> <span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div><p>字符串
默认不需要使用引号表示，如果包含空格或者特殊字符，需要放在引号之中。其中双引号不会对特殊字符转义。单引号之中如果还有需要转义的单引号，必须连续使用两个单引号转义。</p><p>多行字符串可以写成多行，从第二行开始，必须有一个单空格缩进。换行符会被转为空格。</p><p>多行字符可以使用 | 保留换行符，也可以使用 > 折叠换行</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>this</span>: <span style=color:#1c01ce>|</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>Tom</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>Tony</span>
</span></span><span style=display:flex><span><span style=color:#000>that</span>: <span style=color:#1c01ce>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>Tom</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>Tony</span>
</span></span></code></pre></td></tr></table></div></div></div><p>+表示保留文字块末尾的换行，-表示删除字符串末尾的换行<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>this</span>: <span style=color:#1c01ce>|+</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>Tom</span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>Tony</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=常用字段说明>常用字段说明</h3><p>可以通过下面命令查询字段含义</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl explain pod
</span></span><span style=display:flex><span>kubectl explain pod.apiVersion 
</span></span></code></pre></td></tr></table></div></div></div><table><thead><tr><th style=text-align:left>参数名</th><th style=text-align:left>字段类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>version</td><td style=text-align:left>String</td><td style=text-align:left>K8S API的版本，目前基本上是v1，可以用kubectl api-versions命令查询</td></tr><tr><td style=text-align:left>kind</td><td style=text-align:left>String</td><td style=text-align:left>yaml文件定义的资源类型和角色，如：Pod</td></tr><tr><td style=text-align:left>metadata</td><td style=text-align:left>Object</td><td style=text-align:left>元数据对象，固定值就写metadata</td></tr><tr><td style=text-align:left>metadata.name</td><td style=text-align:left>String</td><td style=text-align:left>元数据对象的名字，由自己编写，如命名Pod名字</td></tr><tr><td style=text-align:left>metadata.namespace</td><td style=text-align:left>String</td><td style=text-align:left>元数据对象的命名空间，由自己编写</td></tr><tr><td style=text-align:left>Spec</td><td style=text-align:left>Object</td><td style=text-align:left>详细定义对象，固定值就写Spec</td></tr><tr><td style=text-align:left>spec.containers[]</td><td style=text-align:left>list</td><td style=text-align:left>Spec对象的容器列表定义，列表</td></tr><tr><td style=text-align:left>spec.containers[].name</td><td style=text-align:left>String</td><td style=text-align:left>容器的名字</td></tr><tr><td style=text-align:left>spec.containers[].image</td><td style=text-align:left>String</td><td style=text-align:left>镜像名称</td></tr><tr><td style=text-align:left>spec.containers[].imagePullPolicy</td><td style=text-align:left>String</td><td style=text-align:left>镜像拉取策略，有Always(默认值)、Never(仅适用本地镜像)、IfNotPreset三个值</td></tr><tr><td style=text-align:left>spec.containers[].command[]</td><td style=text-align:left>List</td><td style=text-align:left>容器启动命令，不指定则使用镜像打包时使用的启动命令</td></tr><tr><td style=text-align:left>spec.containers[].args[]</td><td style=text-align:left>List</td><td style=text-align:left>指定容器启动命令参数</td></tr><tr><td style=text-align:left>spec.containers[].workingDir</td><td style=text-align:left>String</td><td style=text-align:left>指定容器的工作目录</td></tr><tr><td style=text-align:left>spec.containers[].volumeMounts[]</td><td style=text-align:left>List</td><td style=text-align:left>容器的存储卷配置</td></tr><tr><td style=text-align:left>spec.containers[].volumeMounts[].name</td><td style=text-align:left>String</td><td style=text-align:left>被容器挂载的存储卷名称</td></tr><tr><td style=text-align:left>spec.containers[].volumeMounts[].mountPath</td><td style=text-align:left>String</td><td style=text-align:left>被容器挂载的存储卷路径</td></tr><tr><td style=text-align:left>spec.containers[].volumeMounts[].readOnly</td><td style=text-align:left>String</td><td style=text-align:left>设置存储卷路径的读写模式，true/false，默认true</td></tr><tr><td style=text-align:left>spec.containers[].ports[]</td><td style=text-align:left>List</td><td style=text-align:left>指定容器需要用到的端口列表</td></tr><tr><td style=text-align:left>spec.containers[].ports[].name</td><td style=text-align:left>String</td><td style=text-align:left>端口名称</td></tr><tr><td style=text-align:left>spec.containers[].ports[].containerPort</td><td style=text-align:left>String</td><td style=text-align:left>容器需要监听的端口号</td></tr><tr><td style=text-align:left>spec.containers[].ports[].hostPort</td><td style=text-align:left>String</td><td style=text-align:left>指定容器所在主机需要监听的端口号，默认跟containerPort相同，注意设置了该值同一台主机无法启动容器的相同副本（端口号冲突）</td></tr><tr><td style=text-align:left>spec.containers[].ports[].protocol</td><td style=text-align:left>String</td><td style=text-align:left>指定端口协议，支持TCP(默认)和UDP</td></tr><tr><td style=text-align:left>spec.containers[].env[]</td><td style=text-align:left>List</td><td style=text-align:left>容器运行前需要设置的环境变量列表</td></tr><tr><td style=text-align:left>spec.containers[].env[].name</td><td style=text-align:left>String</td><td style=text-align:left>环境变量名称</td></tr><tr><td style=text-align:left>spec.containers[].env[].value</td><td style=text-align:left>String</td><td style=text-align:left>环境变量值</td></tr><tr><td style=text-align:left>spec.containers[].resources</td><td style=text-align:left>Object</td><td style=text-align:left>资源限制和资源请求的值（资源上限）</td></tr><tr><td style=text-align:left>spec.containers[].resources.limits</td><td style=text-align:left>Object</td><td style=text-align:left>容器运行时资源的运行上限</td></tr><tr><td style=text-align:left>spec.containers[].resources.limits.cpu</td><td style=text-align:left>String</td><td style=text-align:left>CPU的限制，单位为core数，将用于docker run --cpu-shares参数</td></tr><tr><td style=text-align:left>spec.containers[].resources.limits.memory</td><td style=text-align:left>String</td><td style=text-align:left>MEM内存的限制，单位为MiB、GiB</td></tr><tr><td style=text-align:left>spec.containers[].resources.requests</td><td style=text-align:left>Object</td><td style=text-align:left>容器启动和调度室的限制设置</td></tr><tr><td style=text-align:left>spec.containers[].resources.requests.cpu</td><td style=text-align:left>String</td><td style=text-align:left>CPU请求，单位为core数，容器启动时初始化可用数量</td></tr><tr><td style=text-align:left>spec.containers[].resources.requests.memory</td><td style=text-align:left>String</td><td style=text-align:left>内存请求，单位为MiB、GiB，容器启动的初始化可用数量</td></tr><tr><td style=text-align:left>spec.restartPolicy</td><td style=text-align:left>String</td><td style=text-align:left>定义Pod的重启策略，可选值为Always(默认值)、OnFailure(只有Pod以非零退出码终止时，kubelet才会重启该容器)、Never(kubelet将退出码报告给Master，不重启)</td></tr><tr><td style=text-align:left>spec.nodeSelector</td><td style=text-align:left>Object</td><td style=text-align:left>Node的Label过滤标签，以key:value格式指定</td></tr><tr><td style=text-align:left>spec.imagePullSecrets</td><td style=text-align:left>Object</td><td style=text-align:left>pull镜像时使用secret名称，以name:secretkey格式指定</td></tr><tr><td style=text-align:left>spec.hostNetwork</td><td style=text-align:left>Boolean</td><td style=text-align:left>是否使用主机网络模式，默认false，true表示使用宿主机网络，不适用docker网桥，同时设置了true无法在同一台宿主机上启动第二个副本</td></tr></tbody></table><h3 id=查看pod容器日志>查看pod容器日志</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod
</span></span><span style=display:flex><span>kubectl get pod -w <span style=color:#177500># 自动刷新</span>
</span></span><span style=display:flex><span>kubectl get pod -o wide <span style=color:#177500># 显示更多信息，如ip和node</span>
</span></span><span style=display:flex><span>kubectl log &lt;pod-name&gt;  <span style=color:#177500># 单个容器</span>
</span></span><span style=display:flex><span>kubectl log &lt;pod-name&gt; -c &lt;container-name&gt;  <span style=color:#177500># 多个容器</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=通过资源清单编写pod>通过资源清单编写pod</h2><h2 id=pod的生命周期>pod的生命周期</h2><p><img src=../imgs/k8s01_4.png alt=k8s01_4.png></p><h3 id=initc>initC</h3><p>init Contianer：init 容器</p><p>Pod能够具有多个容器，应用运行在容器里面，但是也有可能有一个或多个先于应用容器启动的Init容器</p><p>Init容器与普通的容器非常像，除了以下两点：</p><p>1、Init容器总是运行到成功完成为止</p><p>2、每个Init容器都必须在下一个Init容器启动之前成功完成</p><p>如果Pod的Init容器失败，Kubernetes会不断重启该Pod，知道Init容器成功为止。如果Pod对应的restartPolicy为Never，则不会重启。</p><p><strong>init容器的作用</strong></p><p>因为Init容器具有与应用程序容器分离的单独镜像，所以它们的启动相关代码有如下优势：</p><p>1、它们可以包含并运行实用工具，但出于安全考虑，不建议在应用程序容器镜像中包含这些使用工具</p><p>2、可以包含使用工具和定制化代码来安装，但不能出现在应用程序镜像中。如：创建镜像没必要From另外一个镜像，只需要在安装过程中使用类似sed、awk、python或dig这样的工具</p><p>3、应用程序镜像可以分离出创建和部署的角色，而没有必要联合它们构建一个单独的镜像</p><p>4、Init容器使用Linux Namespace，所以相对应用程序容器来说具有不同的文件系统视图。因此，它们能够具有访问Secret的权限，而应用程序容器则不能。</p><p>5、它们必须在应用程序容器启动之前运行完成，而应用程序容器式并行运行的，所以Init容器能够提供一种简单的阻塞或延迟应用容器的启动的方法，知道满足了一组先决条件。</p><p><strong>Init模板</strong></p><p><strong>init-pod.yaml</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myapp-pod</span>
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>  <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>myapp-container</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>busybox</span>
</span></span><span style=display:flex><span>      <span style=color:#000>command</span>: [<span style=color:#c41a16>&#39;sh&#39;</span>, <span style=color:#c41a16>&#39;-c&#39;</span>, <span style=color:#c41a16>&#39;echo The app is running! &amp;&amp; sleep 3600&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#000>initContainers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>init-myservice</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>busybox</span>
</span></span><span style=display:flex><span>      <span style=color:#000>command</span>: [<span style=color:#c41a16>&#39;sh&#39;</span>, <span style=color:#c41a16>&#39;-c&#39;</span>, <span style=color:#c41a16>&#39;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#39;</span>]
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>init-mydb</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>busybox</span>
</span></span><span style=display:flex><span>      <span style=color:#000>command</span>: [<span style=color:#c41a16>&#39;sh&#39;</span>, <span style=color:#c41a16>&#39;-c&#39;</span>, <span style=color:#c41a16>&#39;until nslookup mydb; do echo waiting for mydb; sleep 2; done;&#39;</span>]  
</span></span></code></pre></td></tr></table></div></div></div><p>运行命令：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f init-pod.yaml
</span></span><span style=display:flex><span>kubectl describe pod &lt;pod-name&gt;
</span></span><span style=display:flex><span>kubectl log &lt;pod-name&gt; -c &lt;container-name&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pod <span style=color:#177500># 查看pod列表</span>
</span></span><span style=display:flex><span>kubectl delete deployment --all <span style=color:#177500># 删除所有的deployment</span>
</span></span><span style=display:flex><span>kubectl delete pod --all <span style=color:#177500># 删除所有的deployment</span>
</span></span><span style=display:flex><span>kubectl get svc  <span style=color:#177500># 查看service列表</span>
</span></span><span style=display:flex><span>kubectl delete svc &lt;svc-name&gt;
</span></span></code></pre></td></tr></table></div></div></div></p><p>myservice<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Service</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myservice</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>protocol</span>: <span style=color:#1c01ce>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#000>port</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>      <span style=color:#000>targetPort</span>: <span style=color:#1c01ce>9376</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>mydb.yaml</p><pre tabindex=0><code>kind: Service
apiVersion: v1
metadata:
  name: mydb
spec:
  ports:
    - protocol: TCP
      port: 80
      targetPort: 9377
</code></pre><p>运行命令：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f myservice.yaml
</span></span><span style=display:flex><span>kubectl create -f mydb.yaml
</span></span></code></pre></td></tr></table></div></div></div></p><p><strong>特殊说明</strong>
1、在Pod启动过程中，Init容器会按顺序在网络和数据卷初始化(<strong>Pause容器</strong>)之后启动。每个容器必须在下一个容器启动之前成功退出</p><p>2、如果由于运行时或失败退出，将导致容器启动失败，他会根据Pod的restartPolicy指定的策略进行重试。然而，如果Pod的restartPolicy设置为Always，Init容器失败时会使用RestartPolicy策略。</p><p>3、在所有的Init容器没有成功之前，Pod将不会编程Ready状态。Init容器的端口将不会在Service中进行聚集（不会暴露出去）。正在初始化的Pod处于Pending状态，但应该会将Initializing状态设置为true</p><p>4、如果Pod重启，所有init容器必须重新执行</p><p>5、对Init容器spec的修改被限制在容器image字段，修改其他字段都不会生效。更改init容器的image字段，等价于重启该Pod</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit pod &lt;pod-name&gt; <span style=color:#177500># 修改pod配置</span>
</span></span></code></pre></td></tr></table></div></div></div><p>6、Init容器具有应用容器的所有字段。除了readinessProbe，因为Init容器无法定义不同于完成（completion）的就绪（readiness）之外的其他状态。这会在验证过程中强制执行。（init容器本身就是做就绪的工作，再来就绪检测就呵呵）
7、在Pod中的每个app和Init容器的名称必须唯一；与任何其它容器共享同一个名称，会在验证时抛出错误</p><h3 id=pod-phase>Pod phase</h3><p><strong>挂起（Pending）</strong></p><p>Pod已被Kubernetes系统接受, 但有一个或多个容器镜像尚未创建。等待时间包括调度Pod的时间和通过网络下载镜像的时间, 这可能需要花点时间</p><p><strong>运行中（Running）</strong></p><p>该Pod已经绑定到了一个节点上, Pod中所有的容器都已被创建。至少有一个容器正在运行, 或者正处于启动或重启状态</p><p><strong>成功（Succeeded）</strong></p><p>Pod中的所有容器都被成功终止, 并且不会再重启</p><p><strong>失败（Failed）</strong></p><p>Pod中的所有容器都已终止了, 并且至少有一个容器是因为失败终止。也就是说, 容器以非0状态退出或者被系统终止</p><p><strong>未知（Unknown)</strong></p><p>因为某些原因无法取得Pod的状态，通常是因为与Pod所在主机通信失败</p><h3 id=容器探针>容器探针</h3><p>探针是由kubelet对容器执行的定期诊断。要执行诊断，kubelet调用由容器实现的Handler。有三种类型的处理程序： </p><p>1、ExechAction：在容器内执行指定和令。如果佐令退出时返回码为0则认为诊断成功。</p><p>2、TCPSockethction: 对指定端口上的容器的IP地址进行TCP检查。如果踹口打开, 则识断</p><p>被认为是成功的。</p><p>3、HTTPGethction：对指定的端口和路径上的容器的IP地址执行HTTP Get请求。如果响应的</p><p>状态码大于等于200且小于400，则诊断被认为是成功的</p><p>每次探测都将获得以下三种结果之一：</p><p>1、成功: 容器通过了诊断。</p><p>2、夫败: 容器未通过诊断。</p><p>3、未知: 诊断失败，因此不会采取任何行动</p><h4 id=livenessprobe>livenessProbe</h4><p>指示容器是否正在运行。如果存活探测失败，则kubelet会杀死容器，并且容器将|受到其重启策略的影响。如果容器不提供存活探针, 则默认状态为Success</p><p>redinessProbe-httpget</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>: 
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>readiness-httpget-pod</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>readiness-httpget-container</span>
</span></span><span style=display:flex><span>    <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xxxnignx:v1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>imagePullPolicy</span>: <span style=color:#1c01ce>IfNotPresent</span>
</span></span><span style=display:flex><span>    <span style=color:#000>readinessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>httpGet</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>port</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>        <span style=color:#000>path</span>: <span style=color:#1c01ce>/index1.html</span>
</span></span><span style=display:flex><span>        <span style=color:#000>initialDelaySeconds</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>periodSeconds</span>: <span style=color:#1c01ce>3</span>
</span></span></code></pre></td></tr></table></div></div></div><p>进入容器<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 进入容器</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a90d91>exec</span> &lt;pod-name&gt;  <span style=color:#177500># pod只有单个容器</span>
</span></span><span style=display:flex><span><span style=color:#177500># pod有多个容器</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a90d91>exec</span> &lt;pod-name&gt; -c &lt;container-name&gt; -it -- /bin/sh
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /usr/share/nignx/html
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;hello&#34;</span> &gt;&gt; index1.html
</span></span><span style=display:flex><span><span style=color:#a90d91>exit</span> <span style=color:#177500># 退出</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h4 id=readinessprobe>readinessProbe</h4><p>指示容器是告准备好服务请求。如果就绪探测失败, 端点控制器将从与Pod匹配的所有Service的踹点中删除该Pod的IP地址。初始延迟之前的就绪状态默认为Failure。如果容器不提供就绪探针, 则默认状态为Success</p><p>livenessProbe-exec</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>liveness-exec-pod</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>: 
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>liveness-exec-container</span>
</span></span><span style=display:flex><span>    <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>imagePullPolicy</span>: <span style=color:#1c01ce>IfNotPresent</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;/bin/sh&#34;</span>, <span style=color:#c41a16>&#34;-c&#34;</span>, <span style=color:#c41a16>&#34;touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#000>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>exec</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;test&#34;</span>, <span style=color:#c41a16>&#34;-e&#34;</span>, <span style=color:#c41a16>&#34;/tmp/live&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#000>initialDelaySeconds</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>periodSeconds</span>: <span style=color:#1c01ce>3</span>   
</span></span></code></pre></td></tr></table></div></div></div><p>创建并观察<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod -w
</span></span><span style=display:flex><span><span style=color:#177500># 可以发现pod重启</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>livenessProbe-httpget<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>liveness-httpget-pod</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>: 
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>liveness-httpget-container</span>
</span></span><span style=display:flex><span>    <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx:v1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>imagePullPolicy</span>: <span style=color:#1c01ce>IfNotPresent</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>http</span>
</span></span><span style=display:flex><span>      <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>    <span style=color:#000>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>httpGet</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>port</span>: <span style=color:#1c01ce>http</span>
</span></span><span style=display:flex><span>        <span style=color:#000>path</span>: <span style=color:#1c01ce>/index.html</span>
</span></span><span style=display:flex><span>      <span style=color:#000>initialDelaySeconds</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>periodSeconds</span>: <span style=color:#1c01ce>3</span>
</span></span><span style=display:flex><span>      <span style=color:#000>timeoutSeconds</span>: <span style=color:#1c01ce>10</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>创建并观察<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod -o wide <span style=color:#177500># 查看pod ip</span>
</span></span><span style=display:flex><span>curl &lt;ip&gt;/index.html
</span></span><span style=display:flex><span>kubectl <span style=color:#a90d91>exec</span> &lt;pod-name&gt; -it -- /bin/sh
</span></span><span style=display:flex><span>rm -rf /usr/share/nginx/html/index.html
</span></span><span style=display:flex><span><span style=color:#a90d91>exit</span>
</span></span><span style=display:flex><span>curl &lt;ip&gt;/index.html  <span style=color:#177500># 访问报错</span>
</span></span><span style=display:flex><span><span style=color:#177500># 重启后</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a90d91>exec</span> &lt;pod-name&gt; -it -- rm -rf /usr/share/nginx/html/index.html
</span></span><span style=display:flex><span>kubectl get pod  <span style=color:#177500># 会发现再次重启了</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>livenessProbe-tcp<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>: 
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>probe-tcp</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>initalDelaySeconds</span>: <span style=color:#1c01ce>5</span>
</span></span><span style=display:flex><span>      <span style=color:#000>timeoutSecond</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>tcpSocket</span>: 
</span></span><span style=display:flex><span>        <span style=color:#000>port</span>: <span style=color:#1c01ce>8080</span>
</span></span><span style=display:flex><span>      <span style=color:#000>periodSeconds</span>: <span style=color:#1c01ce>3</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=pod-hook>Pod hook</h3><p>启动退出动作</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>lifecycle-demo</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>lifecycle-demo-container</span>
</span></span><span style=display:flex><span>    <span style=color:#000>iamge</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lifecycle</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>postStart</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>exec</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;/bin/sh&#34;</span>, <span style=color:#c41a16>&#34;-c&#34;</span>, <span style=color:#c41a16>&#34;echo Hello from the postStart handler &gt; usr/share/message&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#000>preStop</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>exec</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;/bin/sh&#34;</span>, <span style=color:#c41a16>&#34;-c&#34;</span>, <span style=color:#c41a16>&#34;echo Hello from the postStop handler &gt; usr/share/message&#34;</span>]
</span></span></code></pre></td></tr></table></div></div></div><h3 id=重启策略>重启策略</h3><h1 id=pod控制器>Pod控制器</h1><h2 id=什么是控制器>什么是控制器</h2><p>Kubernets中内建了很多controller（控制器），相当于一个状态机，用来控制Pod的具体状态和行为</p><h2 id=控制器类型说明>控制器类型说明</h2><h3 id=replicationcontroller和replicaset>ReplicationController和ReplicaSet</h3><p>ReplicationController(RC) 用来确保容器应用的副本数始终保持在用户定义的副本数，即如果有容器异常退出，会自动创建新的Pod来替代；而如果异常多出来的容器也会自动回收</p><p>在新版本的Kubernetes中建议使用ReplicaSet来取代ReplicationController。ReplicaSet跟</p><p>ReplicationController没有本质的不同, 只是名字不一样, 并且ReplicaSet支持集合式的selector（通过标签匹配）</p><p>RS实战</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl explain rs <span style=color:#177500># 查看更多field及其用法</span>
</span></span></code></pre></td></tr></table></div></div></div><p>RS demo<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ReplicaSet</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>frontend</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>3</span>
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>machLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>tier</span>: <span style=color:#1c01ce>frontend</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>tier</span>: <span style=color:#1c01ce>frontend</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>php-redis</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>gcr.io/google_samples/gb-fronted:v3</span>
</span></span><span style=display:flex><span>        <span style=color:#000>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>GET_HOSTS_FROM</span>
</span></span><span style=display:flex><span>          <span style=color:#000>value</span>: <span style=color:#1c01ce>dns</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span> 
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>操作<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod --show-labels
</span></span><span style=display:flex><span>kubectl delete rs -all
</span></span><span style=display:flex><span><span style=color:#177500># 会发现自动又创建了一些pod，并且名称的随机后缀不一样</span>
</span></span><span style=display:flex><span>kubectl label pod &lt;pod-name&gt; <span style=color:#000>tier</span><span style=color:#000>=</span>&lt;new-label-name&gt;
</span></span></code></pre></td></tr></table></div></div></div></p><p>注意：RS根据标签名管理，如果修改了标签名则删除相关rs不会影响修改了label的pod</p><h3 id=deployment>Deployment</h3><p>Deployment为Pod和ReplicaSet提供了一个声明式定义（declarative）方法，用来替代以前的</p><p>ReplicationController来方便的管理应用。典型的应用场景包括：</p><p>1、定义Deployment来创建Pod和ReplicaSet</p><p>2、滚动升级和回滚应用</p><p>3、扩容和缩容（RS）</p><p>4、暂停和继续Deployment</p><p><img src=../imgs/k8s01_5.png alt=k8s01_5.png></p><p>Deployment更新策略</p><p>Deployment可以保证在升级时只有一定数量的Pod是down的。默认确保至少有比期望的Pod数量少一个是up状态（最多一个不可用）</p><p>Deployment同时也可以确保只创建出超过期望数量的一定数量的Pod。默认确保最多比期望的Pod数量多一个的Pod是up状态（最多1个surge）</p><p>未来的K8S版本中，将从1-1变成25%-25%</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe deployments
</span></span></code></pre></td></tr></table></div></div></div><p><strong>Rollover（多个rollout并行）</strong>
假如创建了一个有5个nginx:1.7.9 replica的Deployment，但是当还只有3个ngnix:1.7.9的replica创建出来的时候就开始更新含有5个nginx:1.9.1 replica的Deployment。这种情况下，Deployment会立即杀掉已创建的3个nginx:1.7.9的Pod，并开始创建nginx:1.9.1的Pod。不会等到所有的5个nginx:1.7.9的Pod都创建完成后才开始改变航道</p><p><strong>回退Deployment</strong></p><p>只要Deployment的rollout被触发就会创建一个revision。也就是说当且仅当Deployment的Pod template（如.spec.template）被更改，例如更新template中的label和容器镜像时，就会创建出一个新的revision。其它的更新如扩容Deployment不会创建revision，因此可以很方便手动或自动扩容。这意味着回退到历史revision时，只有Deployment中的Pod template部分才会回退。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a90d91>set</span> image deployment/nginx-deployment <span style=color:#000>nginx</span><span style=color:#000>=</span>nginx:1.9.1
</span></span><span style=display:flex><span>kubectl rollout status deployments nginx-deployment
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span>kubectl rollout <span style=color:#a90d91>history</span> deployment/nginx-deployment
</span></span><span style=display:flex><span>kubectl rollout undo deployment/nginx-deployment
</span></span><span style=display:flex><span><span style=color:#177500># 使用revision参数指定某个历史版本，防止死循环</span>
</span></span><span style=display:flex><span>kubectl rollout undo deployment/nginx-deployment --to-revision<span style=color:#000>=</span><span style=color:#1c01ce>2</span> 
</span></span><span style=display:flex><span>kubectl rollout pause deployment/nginx-deployment  <span style=color:#177500># 暂停deployment更新</span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看deployment是否完成，成功将返回一个0值的Exit Code</span>
</span></span><span style=display:flex><span>kubectl rollout status deployment/nginx-deployment 
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#000>$?</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a90d91>set</span> image deployment/nginx-deployment <span style=color:#000>nginx</span><span style=color:#000>=</span>xxx:v3
</span></span></code></pre></td></tr></table></div></div></div><p><strong>清理Policy</strong>
可以通过设置.spec.revisionHistoryLimit项来指定deployment最多保留多少revision历史记录。默认会保留所有的revision，如果将该项设置为0，Deployment就不允许回退。</p><p><strong>Deployment实战部署Nginx</strong></p><p>配置文件</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx-deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>3</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>app</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>: 
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>nginx:1.7.9</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>        
</span></span></code></pre></td></tr></table></div></div></div><p>创建<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/docs/user-guide/nginx-deployment.yaml --record
</span></span><span style=display:flex><span><span style=color:#177500>## --record参数可以记录命令，方便查看每次revision变化</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 扩容</span>
</span></span><span style=display:flex><span>kubectl scale deployment nginx-deployment --replicas <span style=color:#1c01ce>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 支持HPA，可以设置自动扩展</span>
</span></span><span style=display:flex><span>kubectl autoscale deployment nginx-deployment --min<span style=color:#000>=</span><span style=color:#1c01ce>10</span> --max<span style=color:#000>=</span><span style=color:#1c01ce>15</span> --cpu-percent<span style=color:#000>=</span><span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f deployment.yaml --record
</span></span><span style=display:flex><span>kubectl get deployment
</span></span><span style=display:flex><span>kubectl get rs
</span></span><span style=display:flex><span><span style=color:#177500># 回滚</span>
</span></span><span style=display:flex><span>kubectl rollout undo deployment/nginx-deployment
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=daemonset>DaemonSet</h3><p>Daemonset 确保全部(或者一些) Node上运行一个Pod的副本。当有Node加入集群时, 也会为他们新增一个Pod。当有Node从集群移除时, 这些pod也会被回收。<strong>删除DaemonSet将会删除它创建的所有Pod。</strong></p><p>使用DaemonSet的一些典型用法: </p><p>1、运行集群存储daemon, 例如在每个Node上运行glusterd、ceph</p><p>2、在每个Node上运行日志收集daemon, 例如fluentd、logstash</p><p>3、在每个Node上运行监控daemon, 例如Prometheus Node Exporter、collectd、Datadog代理、New Relic代理, 或Ganglia gmond</p><p><strong>DaemonSet实战</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>DaemonSet</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>deamonset-example</span>
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>daemonset</span>
</span></span><span style=display:flex><span>  <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>matchLabels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>name</span>: <span style=color:#1c01ce>daemonset-example</span>
</span></span><span style=display:flex><span>    <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>name</span>: <span style=color:#1c01ce>daemonset-example</span>
</span></span><span style=display:flex><span>      <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#000>name</span>: <span style=color:#1c01ce>daemonset-example</span>
</span></span><span style=display:flex><span>            <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xxx:v1</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=job>Job</h3><p>Job负责批处理任务，即仅执行一次的任务，保证批处理任务的一个或多个Pod成功结束</p><p>特殊说明：</p><p>1、spec.template格式同Pod</p><p>2、RestartPolicy仅支持Never或OnFailure</p><p>3、单个Pod时，默认Pod成功运行后Job即结束</p><p>4、.spec.completions标志Job结束需要成功运行的Pod个数，默认为1</p><p>5、.spec.parallelism标志并行运行的Pod的个数，默认为1</p><p>6、spec.activeDeadlineSeconds标志失败Pod的重试最大时间，超过这个时间不会继续重试</p><p>Job实战</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>batch/v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Job</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pi</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>matedata;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>name</span>: <span style=color:#1c01ce>pi</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>pi</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>perl</span>
</span></span><span style=display:flex><span>        <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;perl&#34;</span>, <span style=color:#c41a16>&#34;-Mbignum=bpi&#34;</span>, <span style=color:#c41a16>&#34;-wle&#34;</span>, <span style=color:#c41a16>&#34;print bpi(2000)&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#000>restartPolicy</span>: <span style=color:#1c01ce>Never </span>
</span></span></code></pre></td></tr></table></div></div></div><p>查看日志，可以显示打印的2000位的PI值<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker load -i xx.tar
</span></span><span style=display:flex><span>kubectl get job
</span></span><span style=display:flex><span>kubectl log &lt;job-name&gt;
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=cronjob>CronJob</h3><p>CronJob管理基于时间的Job，即：</p><p>1、在给定的时间点只运行一次</p><p>2、周期性地在给定时间点运行</p><p>使用前提条件：当前使用k8s集群，版本>=1.8（对CronJob）。对于先前版本的集群，版本&lt;1.8，启动API Server时，通过传递选项</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>--runtime-config=batch/v2alpha1=true
</span></span></code></pre></td></tr></table></div></div></div><p>可以开启batch/v2alpha1 API
典型用法：</p><p>1、给定的时间点调度Job运行</p><p>2、创建周期性运行的Job，例如：数据库备份、发送邮件</p><p><strong>CronJob Spec</strong></p><p>1、.spec.schedule：调度，必需字段，指定任务运行周期，格式Cron</p><p>2、.spec.jobTemplate：Job模板，必需字段，指定需要运行的任务，格式同Job</p><p>3、.spec.startingDeadlineSeconds：启动Job的期限（秒级别），可选字段，如果因为任何原因而错过了被调度的时间，那么错过执行时间的Job将被认为是失败的。没有指定则没有期限。</p><p>4、.spec.concurrencyPolicy：并发策略，可选字段。指定如何处理被Cron Job创建的Job的并发执行。只允许指定下面策略中的一种：</p><p>1）Allow（默认）：允许并发运行的Job</p><p>2）Forbid：禁止并发运行，如果前一个还没有完成，则直接跳过下一个</p><p>3）Replace：取消当前正在运行的Job，用一个新的来替换</p><p>注意：当前策略只能应用于同一个Cron Job创建的Job。如果存在多个Cron Job，它们创建的Job之间总是允许并发运行。</p><p>5、.spec.suspend：挂起，字段可选。true表示后续所有执行都会被挂起。对已经开始执行的Job不起作用。默认值false</p><p>6、.spec.successfulJobsHistoryLimit和.spec.failedJobsHistoryLimit：历史限制，可选字段，指定可以保留多少完成和失败的Job，默认分别设置2和1，设置限制的值为0则相关类型的Job完成后将不会被保留。</p><p><strong>CronJob的限制</strong></p><p>创建job操作应该是幂等的。</p><p><strong>CronJob实战</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>batch/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>CronJob</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>hello</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>schedule</span>: <span style=color:#c41a16>&#34;*/1 * * * *&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>jobTemplate</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>tempalte</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#000>name</span>: <span style=color:#1c01ce>hello</span>
</span></span><span style=display:flex><span>            <span style=color:#000>iamge</span>: <span style=color:#1c01ce>busybox</span>
</span></span><span style=display:flex><span>            <span style=color:#000>args</span>:
</span></span><span style=display:flex><span>            - <span style=color:#1c01ce>/bin/sh</span>
</span></span><span style=display:flex><span>            - -<span style=color:#1c01ce>c</span>
</span></span><span style=display:flex><span>            - <span style=color:#1c01ce>date; echo Hello from the k8s cluster</span>
</span></span><span style=display:flex><span>         <span style=color:#000>restartPolicy</span>: <span style=color:#1c01ce>OnFailure</span>
</span></span></code></pre></td></tr></table></div></div></div><p>创建<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f cronjob.yaml
</span></span><span style=display:flex><span>kubectl get cronjob
</span></span><span style=display:flex><span>kubectl get pod
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=statefulset>StatefulSet</h3><p>StatefulSet作为 Controller 为Pod提供唯一的标识，可以保证部署和scale的顺序</p><p>StatefulSet是为了解决有状态服务的问题（对应Deployments和ReplicaSets是为无状态服务而设计），其应用场景包括：</p><p>1、稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC实现</p><p>2、稳定的网络标志，即Pod重新调度后其PodName和HostName不变，基于Headless Service（即没有Cluster IP的Service）来实现</p><p>3、有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态），基于init containers来实现</p><p>4、有序收缩，有序删除（即从N-1到0）</p><h3 id=horizontal-pod-autoscaling-hpa>Horizontal Pod Autoscaling(HPA)</h3><p>顾名思义，Pod水平自动缩放。应用的资源使用率通常都有高峰和低谷的时候，它可以削峰填谷，提高集群的整体资源利用率，让service中的Pod个数自动调整。</p><p>这个并不是一个直接的控制器，而是控制如Deployment</p><h1 id=服务发现-svc>服务发现(SVC)</h1><h2 id=service原理>Service原理</h2><p>所有服务都注册到SVC，上层Nginx与SVC交互，不与具体的服务ip打交道。</p><p><strong>只有一个调度算法轮询（RR）。</strong></p><p><img src=../imgs/k8s01_6.png alt=k8s01_6.png></p><h3 id=service含义>Service含义</h3><p>K8S Service定义了这样一个抽象：一个Pod的逻辑分组，一种可以访问它们的策略——通常称为微服务。这一组Pod能够被Serice访问到，通常是通过Label Selector</p><p>Service能够提供负载均衡的能力，但是在使用上有以下限制：</p><p>1、只提供4层负载均衡能力（只基于ip+port进行转发），而没有7层负载均衡能力（不能通过主机名/域名），但有时可能需要更多的匹配规则来转发消息，4层负载均衡是不支持的。后面介绍通过Ingress来实现7层负载均衡</p><h3 id=service常见分类>Service常见分类</h3><p>Service在K8S中有以下四种类型：</p><h4 id=clusterip>ClusterIP</h4><p>默认类型，自动分配一个仅Cluster内部可以访问的虚拟IP。</p><p>clusterIP主要在每个node节点使用iptables（<strong>实际依赖具体环境底层代理模式</strong>，也可以是ipvs或userspace，下文有介绍），将发向clusterIP对应端口的数据，转发到kube-proxy中。然后kube-proxy自己内部实现有负载均衡的方法，并可以查询到这个service下对应pod的地址和端口，进而把数据转发给对应的pod的地址和端口。</p><p><img src=../imgs/k8s01_7.png alt=k8s01_7.png></p><p>为了实现图上的功能, 主要需要以下几个组件的协同工作: </p><p>1、apiserver：用户通过kubectl命令向apiserver发送创建service的命令，apiserver接收到请求后将数据存储到etcd中</p><p>2、Kube-proxy：kubernetes的每个节点中都有一个叫做kube-porxy的进程，这个进程负责感知service、pod的变化（检听etcd变化），并将变化的信息写入本地的iptables规则中</p><p>3、iptables使用NAT等技术将virtuallP的流量转至endpoint中</p><p>实战</p><p>svc-deployment.yaml</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myapp-deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>3</span>
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>app</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>      <span style=color:#000>release</span>: <span style=color:#1c01ce>stabel</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>app</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>        <span style=color:#000>release</span>: <span style=color:#1c01ce>stabel</span>
</span></span><span style=display:flex><span>        <span style=color:#000>env</span>: <span style=color:#1c01ce>test</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx:v2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>imagePullPolicy</span>: <span style=color:#1c01ce>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>http</span>
</span></span><span style=display:flex><span>          <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>创建<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f svc-deployment.yaml
</span></span><span style=display:flex><span>kubectl get pod  <span style=color:#177500># 每个都有自己的地址，可以直接curl</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>创建Service信息</p><p>svc-service.yaml</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Service</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>type</span>: <span style=color:#1c01ce>ClusterIP</span>
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>    <span style=color:#000>release</span>: <span style=color:#1c01ce>stabel</span>
</span></span><span style=display:flex><span>  <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>http</span>
</span></span><span style=display:flex><span>    <span style=color:#000>port</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>    <span style=color:#000>targetPort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><p>创建<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f svc-service.yaml
</span></span><span style=display:flex><span>kubectl get svc 
</span></span><span style=display:flex><span><span style=color:#177500># 如果没有对应标签的Pod，curl访问不到，可以通过ipvsadm -Ln 查看ipvs代理转发ip为空</span>
</span></span><span style=display:flex><span>kubectl delete -f svc-service.yaml
</span></span><span style=display:flex><span><span style=color:#177500># 可以访问到对应的hostname信息</span>
</span></span><span style=display:flex><span>curl &lt;svc-ip&gt;/hostname.html
</span></span></code></pre></td></tr></table></div></div></div></p><h4 id=nodeport>NodePort</h4><p>在ClusterIP基础上为Service在每台机器上绑定一个端口，可以通过<nodeip>:NodePort来访问服务</p><p>nodePort的原理在于在node上开了一个端口，将向该端口的流量导入到kube-proxy，然后由kube-proxy进一步地给到对应的pod</p><p>实战</p><p>配置信息除了将spec.type改成NodePort外，其它同ClusterIP的配置</p><p>注意：其实一组pod可以对应多个svc，因为svc是根据label进行关联的。如这里NodePort的配置文件和ClusterIP的配置文件除了spec.type外完全一致的情况下。</p><p>创建并验证</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc <span style=color:#177500># 会发现nodePort的port会多一个随机端口信息</span>
</span></span><span style=display:flex><span>netstat -anpt | grep :&lt;port&gt;  <span style=color:#177500># 可以发现该端口是kube-proxy创建的</span>
</span></span><span style=display:flex><span>iptables -t nat -nvL  <span style=color:#177500># 查询iptables的代理流程，ipvs用 ipvsadm -Ln </span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=loadbalancer>LoadBalancer</h4><p>在NodePort的基础上，借助cloud provider创建一个外部负载均衡器，并将请求转发到<nodeip>: NodePort</p><p>localBalancer 和 nodePort 其实是同一种方式。区别在于loadBalancer比nodePort多了一步，就是可以调用cloud provider去创建LB来向节点导流（LB一般是LAAS，但是收费！）</p><p><img src=../imgs/k8s01_8.png alt=k8s01_8.png></p><h4 id=externalname>ExternalName</h4><p>把集群外部的服务引入到集群内部来，在集群内部直接使用。没有任何类型代理被创建，只有k8s 1.7或更高版本的kube-dns才支持</p><p>这种类型的Service通过返回 CNAME 和它的值, 可以将服务映射到externalName字段的内容。ExternalNameService是Service的特例，没有selector，也没有定义任何的端口和Endpoint。相反对于运行在集群外部的服务, 它通过返回该外部服务的别名这种方式来提供服务。</p><p>实战</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Service</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>my-service1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>type</span>: <span style=color:#1c01ce>ExternalName</span>
</span></span><span style=display:flex><span>  <span style=color:#000>externalName</span>: <span style=color:#1c01ce>my.database.example.com</span>
</span></span></code></pre></td></tr></table></div></div></div><p>当查询主机 my-service1.default.svc.cluster.local（SVC_NAME.NAMESPECE.svc.cluster.local）时，集群的DNS服务将返回一个值my.database.example.com的CNAME记录。访问这个服务的工作方式和其他相同，唯一不同的是<strong>重定向发生在DNS层</strong>，而且<strong>不会进行代理或转发</strong>。</p><h4 id=headless-service>Headless Service</h4><p>有时不需要或不想要负载均衡，以及单独的Service IP。遇到这种情况，可以通过制定Cluster IP（spec.clusterIP）的值为"None"来创建Headless Service。这类Service并不会分配Cluster IP，kube-proxy不会处理他们，而且平台不会为他们进行负载均衡和路由。</p><p>举例</p><p>svc-headless.yaml</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Service</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myapp-headless</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>myapp</span>
</span></span><span style=display:flex><span>  <span style=color:#000>clusterIP</span>: <span style=color:#c41a16>&#34;None&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>port</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>    <span style=color:#000>targetPort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><p>创建验证<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f svc-headless.yaml
</span></span><span style=display:flex><span>kubectl get svc  <span style=color:#177500># 会发现对应svc的CLUSTER-IP为None</span>
</span></span><span style=display:flex><span>kubectl get pod -n kube-system  <span style=color:#177500># 查看dns的地址信息(下面的dig的ip)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 主机名默认是 svc名称.当前空间名称.集群域名</span>
</span></span><span style=display:flex><span>dig -t A myapp-headless.default.svc.cluster.local. @&lt;ip&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pod  <span style=color:#177500># 查看pod ip和上面dig的一样</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 附录Ldig安装</span>
</span></span><span style=display:flex><span>yum -y install bind-utils
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=service代理模式分类>Service代理模式分类</h3><p>总体结构</p><p><img src=../imgs/k8s01_9.png alt=k8s01_9.png></p><p><strong>VIP和Service代理背景</strong></p><p>在K8S集群中，每个Node运行一个kube-proxy进程，kube-proxy负责为Service实现了一种**VIP（虚拟IP）**的形式，而不是ExternalName的形式。</p><p>在K8S v1.0版本，代理完全在userspace。</p><p>在K8S v1.1版本，新增了iptables代理，但并不是默认的运行模式。</p><p>从K8S v1.2起，默认就是iptables代理。</p><p>在K8S v1.8.0-beta.0中，添加了ipvs代理。</p><p>在K8S v1.14八本开始默认使用ipvs代理</p><p>在K8S v1.0版本中，Service是 **4层（TCP/UDP over IP）**概念。</p><p>在K8S v1.1版本，新增Ingress API（beta版），用来表示**7层（HTTP）**服务</p><p>为什么不适用 round-robin DNS？</p><p>DNS一般会缓存。一般服务解析后一般不会清除缓存</p><h4 id=userspace>userspace</h4><p>userpace代理模式</p><p><img src=../imgs/k8s01_10.png alt=k8s01_10.png></p><p>服务的访问和apiserver都会访问kube-proxy，导致压力比较大。</p><h4 id=iptables>iptables</h4><p>iptables代理模式</p><p><img src=../imgs/k8s01_11.png alt=k8s01_11.png></p><p>访问速率大大增加，kube-proxy能提高稳定性、减小压力。</p><p>缺点：防火墙的性能不高</p><h4 id=ipvs>ipvs</h4><p>kube-proxy会监视K8S Service对象和Endpoints，调用netlink接口以相应地创建ipvs规则并定期与K8S Service对象和Endpoints对象同步ipvs规则，以确保ipvs状态与期望一直。访问服务时，流量将重定向到其中一个后端Pod。</p><p>与iptables类似，ipvs于netfilter的hook功能，但使用哈希表作为底层数据结构并在内核空间中工作。这意味着ipvs可以更快地重定向流量，并且在同步代理规则时具有更好的性能。此外，ipvs为负载均衡算法提供了更多的选项。例如：</p><p>1、rr：轮询调度</p><p>2、lc：最小连接数</p><p>3、dh：目标哈希</p><p>4、sh：源哈希</p><p>5、sed：最短期望延迟</p><p>6、nq：不排队调度</p><p>注意：ipvs模式假定在运行kube-proxy之前在节点上都已经安装了 IPVS 内核模块。当kube-proxy以ipvs代理模式启动时，kube-proxy将验证节点上是否安装了IPVS模块，如果未安装，则kube-proxy将回退到iptables代理模式。</p><p>ipvs代理模式</p><p><img src=../imgs/k8s01_12.png alt=k8s01_12.png></p><p>相关命令</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ipvsadm -Ln  <span style=color:#177500># 查看ipvs代理</span>
</span></span><span style=display:flex><span>kubectl get svc  <span style=color:#177500># 查看cluster-ip，结合查看代理</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=ingress>Ingress</h2><p>github ingress：<a href=https://github.com/kubernetes/ingress-nginx>https://github.com/kubernetes/ingress-nginx</a></p><p>官方网站：<a href=https://kubernetes.github.io/ingress-nginx/>https://kubernetes.github.io/ingress-nginx/</a></p><p>中文文档：<a href=https://kubernetes.io/zh/docs/concepts/services-networking/ingress/>https://kubernetes.io/zh/docs/concepts/services-networking/ingress/</a></p><p>Ingress整体流程</p><p><img src=../imgs/k8s01_13.png alt=k8s01_13.png></p><h3 id=部署ingress-nginx>部署Ingress-Nginx</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># https://kubernetes.github.io/ingress-nginx/deploy/</span>
</span></span><span style=display:flex><span>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/cloud/deploy.yaml
</span></span><span style=display:flex><span>cat deploy.yam | grep image <span style=color:#177500># 查看镜像，可以提前pull</span>
</span></span><span style=display:flex><span>docker pull quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0
</span></span></code></pre></td></tr></table></div></div></div><p>保存镜像到本地</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker save -o ingress.contr.tar quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0
</span></span><span style=display:flex><span>tar -zcvf ingress.contr.tar.gz ingress.contr.tar
</span></span><span style=display:flex><span>sz ingress.contr.tar.gz <span style=color:#177500># 下载到本机</span>
</span></span><span style=display:flex><span>rz <span style=color:#177500># 上传到远端</span>
</span></span><span style=display:flex><span>scp ingree.contro.tar.gz root@hostname:/root
</span></span><span style=display:flex><span>tar -zxvf ingree.contr.tar.gz
</span></span><span style=display:flex><span>docker load -i ingree.contr.tar  <span style=color:#177500># 导入镜像。注意这里是tar结尾</span>
</span></span></code></pre></td></tr></table></div></div></div><p>创建</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f deploy.yaml
</span></span><span style=display:flex><span>kubectl get pod -n ingress-nginx
</span></span><span style=display:flex><span><span style=color:#177500># 暴露方案，AWS、GCE-GKE或NodePort(裸机)</span>
</span></span><span style=display:flex><span>wget -o servie-nodeport https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/baremetal/deploy.yaml
</span></span><span style=display:flex><span>kubectl apply -f service-nodeport.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get svc -n ingress-nginx <span style=color:#177500># 有NodePort</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=http代理访问>HTTP代理访问</h3><p>deployment/Service/Ingress yaml文件</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>deployment1</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>         - <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx1</span>
</span></span><span style=display:flex><span>           <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx:v1</span>
</span></span><span style=display:flex><span>           <span style=color:#000>imagePullPolicy</span>: <span style=color:#1c01ce>IfNotPresent</span>
</span></span><span style=display:flex><span>           <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>             - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span><span style=color:#000>---</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Service</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>svc-1</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>port</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>      <span style=color:#000>targetPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>      <span style=color:#000>protocol</span>: <span style=color:#1c01ce>TCP</span>
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx1</span>
</span></span><span style=display:flex><span><span style=color:#000>---</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx-test</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>host</span>: <span style=color:#1c01ce>xxxx.com</span>
</span></span><span style=display:flex><span>      <span style=color:#000>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>paths</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>path</span>: <span style=color:#1c01ce>/</span>
</span></span><span style=display:flex><span>          <span style=color:#000>backend</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>serviceName</span>: <span style=color:#1c01ce>svc-1</span>
</span></span><span style=display:flex><span>            <span style=color:#000>servicePort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>相关命令<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc -n ingress-nginx  <span style=color:#177500># 查看端口</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=https代理访问>HTTPS代理访问</h3><p>创建整数，以及cert存储方式</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#1c01ce>365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span style=color:#c41a16>&#34;/CN=nginxsvc/0=nginxsvc&#34;</span>
</span></span><span style=display:flex><span>kubectl create secret tls tls-secret --key tls.key --cert tls.crt
</span></span></code></pre></td></tr></table></div></div></div><p>Deployment/Service/Ingress yaml文件
deployment和svc同上，修改label即可</p><p>ingress-https.yaml</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>https</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>tls</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>hosts</span>:
</span></span><span style=display:flex><span>      - <span style=color:#1c01ce>xxx.com</span>
</span></span><span style=display:flex><span>      <span style=color:#000>secretName</span>: <span style=color:#1c01ce>tls-secret</span>
</span></span><span style=display:flex><span>  <span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>host</span>: <span style=color:#1c01ce>xxxx.com</span>
</span></span><span style=display:flex><span>      <span style=color:#000>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>paths</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>path</span>: <span style=color:#1c01ce>/</span>
</span></span><span style=display:flex><span>          <span style=color:#000>backend</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>serviceName</span>: <span style=color:#1c01ce>svc-1</span>
</span></span><span style=display:flex><span>            <span style=color:#000>servicePort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=使用cookie实现会话关联>使用cookie实现会话关联</h3><p>参考官方文档：</p><p><a href=https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/>https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/</a></p><h3 id=basicauth>BasicAuth</h3><p>参考官方用例：<a href=https://kubernetes.github.io/ingress-nginx/examples/auth/basic/>https://kubernetes.github.io/ingress-nginx/examples/auth/basic/</a></p><p>Nginx进行基础认证，用户密码登录</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>yum -y install httpd
</span></span><span style=display:flex><span>htpasswd -c auth &lt;username&gt;  <span style=color:#177500># 依赖httpd</span>
</span></span><span style=display:flex><span>kubectl create generic basic-auth --from-file<span style=color:#000>=</span>auth
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>ingress-with-auth</span>
</span></span><span style=display:flex><span>  <span style=color:#000>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>nginx.ingress.kubernetes.io/auth-type</span>: <span style=color:#1c01ce>basic</span>
</span></span><span style=display:flex><span>    <span style=color:#000>nginx.ingress.kubernetes.io/auth-secret</span>: <span style=color:#1c01ce>basic-auth</span>
</span></span><span style=display:flex><span>    <span style=color:#000>nginx.ingress.kubernetes.io/auth-realm</span>: <span style=color:#c41a16>&#39;Authentication Required - &lt;username&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>host</span>: <span style=color:#1c01ce>xxx.com</span>
</span></span><span style=display:flex><span>    <span style=color:#000>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>path</span>: <span style=color:#1c01ce>/</span>
</span></span><span style=display:flex><span>        <span style=color:#000>backend</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>serviceName</span>: <span style=color:#1c01ce>svc-1</span>
</span></span><span style=display:flex><span>          <span style=color:#000>servicePort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=nginx进行重写>Nginx进行重写</h3><table><thead><tr><th style=text-align:left>名称</th><th style=text-align:left>描述</th><th style=text-align:left>值</th></tr></thead><tbody><tr><td style=text-align:left>nginx.ingress.kubernetes.io/rewrite-target</td><td style=text-align:left>必须重定向流量的目标URI</td><td style=text-align:left>串</td></tr><tr><td style=text-align:left>nginx.ingress.kubernetes.io/ssl-redirect</td><td style=text-align:left>指示位置部分是否仅可访问SSL（当Ingress包含整数时默认为True）</td><td style=text-align:left>布尔</td></tr><tr><td style=text-align:left>nginx.ingress.kubernetes.io/force-ssl-redirect</td><td style=text-align:left>即使Ingress未启用TLS，也前世重定向到HTTPS</td><td style=text-align:left>布尔</td></tr><tr><td style=text-align:left>nginx.ingress.kubernetes.io/app-root</td><td style=text-align:left>定义Controller必须重定向的应用程序根，如果他在'/'上下文中</td><td style=text-align:left>串</td></tr><tr><td style=text-align:left>nginx.ingress.kubernetes/use-regex</td><td style=text-align:left>指示Ingress上定义的路径是否使用正则表达式</td><td style=text-align:left>布尔</td></tr></tbody></table><p>示例</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx-test</span>
</span></span><span style=display:flex><span>  <span style=color:#000>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>nginx.ingress.kubernetes.io/rewrite-target</span>: <span style=color:#1c01ce>xx.com:&lt;port&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>host</span>: <span style=color:#1c01ce>xxx.com</span>
</span></span><span style=display:flex><span>    <span style=color:#000>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>path</span>: <span style=color:#1c01ce>/</span>
</span></span><span style=display:flex><span>        <span style=color:#000>backend</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>serviceName</span>: <span style=color:#1c01ce>svc-1</span>
</span></span><span style=display:flex><span>          <span style=color:#000>servicePort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=reference>Reference</h1><p><a href=https://mp.weixin.qq.com/s/6Pu7k-3taQhtZ18JkjbU0A>k8s主要概念大梳理</a></p><p><a href=https://k8s.easydoc.net/docs/dRiQjyTY/28366845/6GiNOzyZ/nd7yOvdY>安装k8s集群</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f2bb2d943c5dcee9f88556e6fee4cd01>6 - 52.kubernetes02</h1><h1 id=存储>存储</h1><p>服务分类</p><ul><li>有状态服务：DBMS</li><li>无状态服务：LVS、APACHE</li></ul><h2 id=configmap>configMap</h2><p>配置文件注册中心</p><p>注意：nginx不支持热更新，需要重启</p><h3 id=创建configmap>创建configMap</h3><h4 id=使用目录创建>使用目录创建</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>$ ls docs/user-guide/configmap/kubectl
</span></span><span style=display:flex><span>game.properties
</span></span><span style=display:flex><span>ui.properties
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat docs/user-guide/configmap/kubectl/game.properties
</span></span><span style=display:flex><span>ememies=aliens
</span></span><span style=display:flex><span>lives=3
</span></span><span style=display:flex><span>ememies.cheat=true
</span></span><span style=display:flex><span>ememies.cheat.level=noGoodRotten
</span></span><span style=display:flex><span>secret.code.passphrase=UUDDLRLRBABAS
</span></span><span style=display:flex><span>secret.code.allowed=true
</span></span><span style=display:flex><span>secret.code.lives=30
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat docs/user-guide/configmap/kubectl/ui.properties
</span></span><span style=display:flex><span>color.good=purple
</span></span><span style=display:flex><span>color.bad=yellow
</span></span><span style=display:flex><span>allow.textmode=true
</span></span><span style=display:flex><span>how.nice.to.look=fairlyNice
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl create configmap game-config --from-file=docs/user-guide/configmap/kubectl
</span></span><span style=display:flex><span>kubectl get cm
</span></span><span style=display:flex><span>kubectl get cm game-config
</span></span><span style=display:flex><span>kubectl get cm game-config -o yaml
</span></span><span style=display:flex><span>kubectl describe cm game-config
</span></span></code></pre></td></tr></table></div></div></details><br><p>--from-file：指定在目录下的所有文件都会被用在ConfigMap里面创建一个键值对，键的名字就是文件名，值就是文件的内容。</p><h4 id=使用文件创建>使用文件创建</h4><p>指定为一个文件就可以从单个文件创建ConfigMap</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create configmap game-config-2 --from-file<span style=color:#000>=</span>docs/user-guide/configmap/kubectl/game.properties
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get configmaps game-config-2 -o yaml
</span></span></code></pre></td></tr></table></div></div></div><p>--from-file参数可以使用多次，可以使用两次分别指定上个实例中的两个配置文件，效果跟指定整个目录是一样的</p><h4 id=使用字面值创建>使用字面值创建</h4><p>利用--from-literal参数传递配置信息，该参数可以使用多次，如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create configmap special-config <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--from-literal<span style=color:#000>=</span>special.how<span style=color:#000>=</span>very --from-literal<span style=color:#000>=</span>special.type<span style=color:#000>=</span>charm
</span></span></code></pre></td></tr></table></div></div></div><h3 id=pod中使用configmap>Pod中使用configMap</h3><h4 id=configmap来替代环境变量>ConfigMap来替代环境变量</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>special-config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>special.how</span>: <span style=color:#1c01ce>very</span>
</span></span><span style=display:flex><span>  <span style=color:#000>special.type</span>: <span style=color:#1c01ce>charm</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>env-config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>log_level</span>: <span style=color:#1c01ce>INFO</span>
</span></span></code></pre></td></tr></table></div></div></div><p>将配置值注入到Pod的环境变量中<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>dapi-test-pod</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>test-container</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;/bin/sh&#34;</span>, <span style=color:#c41a16>&#34;-c&#34;</span>, <span style=color:#c41a16>&#34;env&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#000>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>SPECIAL_LEVEL_KEY</span>
</span></span><span style=display:flex><span>          <span style=color:#000>valueFrom</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>configMapKeyRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>name</span>: <span style=color:#1c01ce>special-config</span>
</span></span><span style=display:flex><span>            <span style=color:#000>key</span>: <span style=color:#1c01ce>special.how</span>
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>SPECIAL_TYPE_KEY</span>
</span></span><span style=display:flex><span>          <span style=color:#000>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>configMapKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#000>name</span>: <span style=color:#1c01ce>special-config</span>
</span></span><span style=display:flex><span>              <span style=color:#000>key</span>: <span style=color:#1c01ce>special.type</span>
</span></span><span style=display:flex><span>      <span style=color:#000>envFrom</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>configMapRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>name</span>: <span style=color:#1c01ce>env-config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>restartPolicy</span>: <span style=color:#1c01ce>Never</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><h4 id=configmap设置命令行参数>ConfigMap设置命令行参数</h4><p>基本同上，导入变量一样，只是在启动命令中使用而已</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>dapi-test-pod</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>test-container</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;/bin/sh&#34;</span>, <span style=color:#c41a16>&#34;-c&#34;</span>, <span style=color:#c41a16>&#34;echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)&#34;</span> ]
</span></span><span style=display:flex><span>      <span style=color:#000>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>SPECIAL_LEVEL_KEY</span>
</span></span><span style=display:flex><span>          <span style=color:#000>valueFrom</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>configMapKeyRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>name</span>: <span style=color:#1c01ce>special-config</span>
</span></span><span style=display:flex><span>            <span style=color:#000>key</span>: <span style=color:#1c01ce>special.how</span>
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>SPECIAL_TYPE_KEY</span>
</span></span><span style=display:flex><span>          <span style=color:#000>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>configMapKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#000>name</span>: <span style=color:#1c01ce>special-config</span>
</span></span><span style=display:flex><span>              <span style=color:#000>key</span>: <span style=color:#1c01ce>special.type</span>
</span></span><span style=display:flex><span>      <span style=color:#000>envFrom</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>configMapRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>name</span>: <span style=color:#1c01ce>env-config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>restartPolicy</span>: <span style=color:#1c01ce>Never</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h4 id=通过数据卷插件使用configmap>通过数据卷插件使用ConfigMap</h4><p>在数据卷里面使用ConfigMap，有不同的选项。最基本的就是将文件填入数据卷，在这个文件中，键就是文件名，键值就是文件内容</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>dapi-test-pod</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>test-container</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>command</span>: [<span style=color:#c41a16>&#34;/bin/sh&#34;</span>, <span style=color:#c41a16>&#34;-c&#34;</span>, <span style=color:#c41a16>&#34;cat /etc/config/special.how&#34;</span> ]
</span></span><span style=display:flex><span>      <span style=color:#000>volumeMounts</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>config-volume</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mountPath</span>: <span style=color:#1c01ce>/etc/config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>volumes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>config-volume</span>
</span></span><span style=display:flex><span>      <span style=color:#000>configMap</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>name</span>: <span style=color:#1c01ce>special-config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>restartPolicy</span>: <span style=color:#1c01ce>Never</span>
</span></span></code></pre></td></tr></table></div></div></div><p>验证<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a90d91>exec</span> &lt;pod-name&gt; -it -- /bin/sh
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /etc/config
</span></span><span style=display:flex><span>ls <span style=color:#177500># 会看到special.how 和 special.type</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=configmap热更新>configMap热更新</h3><h4 id=实现演示>实现演示</h4><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>log-config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>data</span>: 
</span></span><span style=display:flex><span>  <span style=color:#000>log_level</span>: <span style=color:#1c01ce>INFO</span>
</span></span><span style=display:flex><span><span style=color:#000>---</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>my-nginx</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>tempalte</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>run</span>: <span style=color:#1c01ce>my-nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>my-nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>        <span style=color:#000>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>config-volume</span>
</span></span><span style=display:flex><span>          <span style=color:#000>mountPath</span>: <span style=color:#1c01ce>/etc/config</span>
</span></span><span style=display:flex><span>        <span style=color:#000>volumes</span>:
</span></span><span style=display:flex><span>          - <span style=color:#000>name</span>: <span style=color:#1c01ce>config-volume</span>
</span></span><span style=display:flex><span>            <span style=color:#000>configMap</span>:
</span></span><span style=display:flex><span>              <span style=color:#000>name</span>: <span style=color:#1c01ce>log-config</span>
</span></span></code></pre></td></tr></table></div></div></details><br><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a90d91>exec</span> <span style=color:#c41a16>`</span>kubectl get pods -l <span style=color:#000>run</span><span style=color:#000>=</span>my-nginx -o<span style=color:#000>=</span>name|cut -d <span style=color:#c41a16>&#34;/&#34;</span> -f2<span style=color:#c41a16>`</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>cat /etc/config/log_level
</span></span><span style=display:flex><span>INFO
</span></span></code></pre></td></tr></table></div></div></div><p>修改ConfigMap<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit configmap log-config
</span></span></code></pre></td></tr></table></div></div></div></p><p>特别注意：
configMap如果是以ENV的方式挂载至容器，修改configMap并不会实现热更新</p><h4 id=更新触发说明>更新触发说明</h4><p>更新ConfigMap目前并不会触发相关Pod的滚动更新，可以通过修改pod annotations的方式强制触发滚动更新</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment my-nginx --path <span style=color:#c41a16>&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;metadata&#34;: {&#34;annotations&#34;: {&#34;version/config&#34;: &#34;20210117&#34;}}}}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这个例子里在.spec.template.metadata.annotations 中添加 version/config，每次通过修改version/config 来触发滚动更新。
更新ConfigMap后</p><p>1、使用该ConfigMap挂载的Env不会同步更新</p><p>2、使用该ConfigMap挂载的Volume中的数据需要一段时间（实测大概10秒）才能同步更新</p><h2 id=secret>Secret</h2><p>定义概念</p><p>Secret解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或者环境变量的方式使用。</p><p>Secret有以下3种类型</p><h3 id=service-account>Service Account</h3><p>用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的 /run/secrets/kubernetes.io/serviceaccount 目录中</p><h3 id=opaque-secret>Opaque Secret</h3><p>base64编码格式的Secret，用来存储密码、密钥等</p><h4 id=创建说明>创建说明</h4><p>Opaque类型的数据是一个map类型，要求value是base64编码格式</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ <span style=color:#a90d91>echo</span> -n <span style=color:#c41a16>&#34;admin&#34;</span> | base64
</span></span><span style=display:flex><span><span style=color:#000>YWRtaW4</span><span style=color:#000>=</span>
</span></span><span style=display:flex><span>$ <span style=color:#a90d91>echo</span> -n <span style=color:#c41a16>&#34;admin666&#34;</span> | base64
</span></span><span style=display:flex><span><span style=color:#000>YWRtaW42NjY</span><span style=color:#000>=</span>
</span></span></code></pre></td></tr></table></div></div></div><p>secrets.yml<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Secret</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>mysecret</span>
</span></span><span style=display:flex><span><span style=color:#000>type</span>: <span style=color:#1c01ce>Opaque</span>
</span></span><span style=display:flex><span><span style=color:#000>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>password</span>: <span style=color:#1c01ce>YWRtaW42NjY=</span>
</span></span><span style=display:flex><span>  <span style=color:#000>username</span>: <span style=color:#1c01ce>YWRtaW4=</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h4 id=使用方式>使用方式</h4><p>1、将Secret挂载到Volume中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>secret-test</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>secret-test</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>secrets</span>
</span></span><span style=display:flex><span>    <span style=color:#000>secret</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>secretName</span>: <span style=color:#1c01ce>mysecret</span>
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>image</span>: <span style=color:#1c01ce>xxxx:v1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>db</span>
</span></span><span style=display:flex><span>    <span style=color:#000>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>secrets</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mountPath</span>: <span style=color:#c41a16>&#34;/etc/secrets&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>readOnly</span>: <span style=color:#a90d91>true</span>      
</span></span></code></pre></td></tr></table></div></div></div><p>操作：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 启动后</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /etc/secrets
</span></span><span style=display:flex><span>cat username <span style=color:#177500># 会自动解密</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>2、将Secret导出到环境变量中<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extension/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-deployment1</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>app</span>: <span style=color:#1c01ce>pod-deployment1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>        <span style=color:#000>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>TEST_USER</span>
</span></span><span style=display:flex><span>          <span style=color:#000>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>secretKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#000>name</span>: <span style=color:#1c01ce>mysecret</span>
</span></span><span style=display:flex><span>              <span style=color:#000>key</span>: <span style=color:#1c01ce>username</span>
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>TEST_PASSWORD</span>
</span></span><span style=display:flex><span>          <span style=color:#000>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>secretKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#000>name</span>: <span style=color:#1c01ce>mysecret</span>
</span></span><span style=display:flex><span>              <span style=color:#000>key</span>: <span style=color:#1c01ce>password</span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><h3 id=kubernetes-io-dockerconfigjson>kubernetes.io/dockerconfigjson</h3><p>用来存储私有docker registry的认证信息</p><p>使用Kubectl创建docker registry认证的secret</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create secret docker-registry myregistrykey --docker-server<span style=color:#000>=</span>DOCKER_REGISITRY_SERVER <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--docker-username<span style=color:#000>=</span>DOCKER_USER --docker-password<span style=color:#000>=</span>DOCKER_PASSWORD <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--docker-email<span style=color:#000>=</span>DOCKER_EMAIL 
</span></span><span style=display:flex><span>secret <span style=color:#c41a16>&#34;myregistrykey&#34;</span> created.
</span></span></code></pre></td></tr></table></div></div></div><p>修改镜像名并推送</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag old:v1 new:v2
</span></span><span style=display:flex><span>docker push new:v2  <span style=color:#177500># error</span>
</span></span><span style=display:flex><span>docker login xxx  <span style=color:#177500># push again</span>
</span></span></code></pre></td></tr></table></div></div></div><p>拉取私有镜像<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker <span style=color:#a90d91>logout</span> xxx <span style=color:#177500># 先退出登录，之前认证过</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>创建Pod，通过 imagePullSecrets 来引用刚创建的 myregistrykey<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>foo</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>foo</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>imagePullSecrets</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>myregistrykey</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=volume>volume</h2><p>容器磁盘上的文件的声明周期是短暂的，这就使得在容器中运行重要应用时会出现一些问题。首先，当容器崩溃时，kubelet会重启它，但是容器中的文件将丢失——容器以干净的状态（镜像最初的状态）重新启动（与docker不一样！docker会保留数据）。其次，在Pod中同时运行多个容器时，这些容器之间通常需要共享文件。Kubernetes中的Volume抽象就很好的解决了这些问题。</p><h3 id=背景>背景</h3><p>Kubernetes中的卷有明确的寿命一一与封装它的Pod相同。所以, 卷的生命比Pod中的所有容器都长, 当这个容器重启时数据仍然得以保存。当然, 当Pod不再存在时, 卷也封不复存在。也许更重要的是, Kubernetes支持多种类型的卷, Pod可以同时使用任意数量的卷</p><p><img src=../imgs/k8s02_1.png alt=k8s02_1.png></p><h3 id=卷的类型>卷的类型</h3><p>Kubernetes支持以下类型的卷：</p><ul><li>awsElasticBlockStore、azureDisk、azureFile、cephfs、csi、dowwardAPI、emptyDir</li><li>fc、flocker、gcePersistentDisk、gitRepo、glusterfs、hostPath、iscsi、local、nfs</li><li>ersistentVolumeClaim、projected、portworxVolume、quobyte、rbd、scaleIO、secret</li><li>storage、vsphereVolume</li></ul><h3 id=emptydir>emptyDir</h3><p>当Pod被分配给节点时，首先创建emptyDir卷，并且只要该Pod在该节点上运行，该卷就会存在。正如卷的名字所述, 它最初是空的。Pod中的容器可以读取和写入enptyDir卷中的相同文件, 尽管该卷可以挂载到每个容器中的相同或不同路径上。当出于任何原因从节点中删除Pod时, enptyoir中的数据特被永久删除</p><p>注意: 容器崩溃不会从节点中移除pod，因此emptyDir卷中的数据在容器崩溃时是安全的 </p><p>emptyDir的用法：</p><p>1、暂存空间，例如用于基于磁盘的合并排序</p><p>2、用作长时间计算奔溃恢复时的检查点</p><p>3、Web服务器容器提供数据时，保存内容管理器容器提取的文件</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVerison</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>test_pd</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>: 
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>name:test-container</span>
</span></span><span style=display:flex><span>    <span style=color:#000>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>mountPath</span>: <span style=color:#1c01ce>/cache</span>
</span></span><span style=display:flex><span>      <span style=color:#000>name</span>: <span style=color:#1c01ce>cache-volume</span>
</span></span><span style=display:flex><span>    <span style=color:#000>volumes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>name</span>: <span style=color:#1c01ce>cache-volume</span>
</span></span><span style=display:flex><span>      <span style=color:#000>emptyDir</span>: {}
</span></span></code></pre></td></tr></table></div></div></div><h3 id=hostpath>hostPath</h3><p>卷将主机节点的文件系统中的文件或目录挂载到集群中</p><p>配置方式简单，需要手动指定pod跑在某个固定节点上。仅供单节点测试使用，不适用与多节点集群。minikube提供了hostPath存储。</p><p>hostPath的用途如下：</p><p>1、运行需要访问Docker内部的容器；使用 /var/lib/docker 的hostPath</p><p>2、在容器中运行cAdvisor；使用 /dev/cgroups 的hostPath</p><p>除了所需的path属性之外，用户还可以为 hostPath 卷指定 type</p><table><thead><tr><th style=text-align:left>值</th><th style=text-align:left>行为</th></tr></thead><tbody><tr><td style=text-align:left></td><td style=text-align:left>空字符串（默认）用于向后兼容，意味着在挂载hostPath卷之前不会执行任何检查</td></tr><tr><td style=text-align:left>DirectoryOrCreate</td><td style=text-align:left>如果在给定的路径上没有任何东西存在，那么将根据需要在那里创建一个空目录，权限设置为0755，与kubelet具有相同的组合所有权</td></tr><tr><td style=text-align:left>FileOrCreate</td><td style=text-align:left>如果在给定的路径上没有任何东西存在，那么会根据需要创建一个空文件，权限设置为0644，与kubelet具有相同的组和所有权</td></tr><tr><td style=text-align:left>File</td><td style=text-align:left>给定的路径下必须存在文件</td></tr><tr><td style=text-align:left>Socket</td><td style=text-align:left>给定的路径下必须存在UNIX套接字</td></tr><tr><td style=text-align:left>CharDevice</td><td style=text-align:left>给定的路径下必须存在字符设备</td></tr><tr><td style=text-align:left>BlockDevice</td><td style=text-align:left>给定的另下必须存在块设备</td></tr></tbody></table><p>使用这种卷类型时请注意，因为：</p><p>1、由于每个节点上的文件都不同，具有相同配置（例如从 podTemplate 创建的）的Pod在不同节点上的行为可能会有所不同</p><p>2、当Kubernetes按照计划添加资源感知调度时，将无法考虑hostPath使用的资源</p><p>3、当底层主机上创建的文件或目录只能由root写入。您需要在特权容器中以root身份运行进程，或修改主机上的文件以便写入hostPath卷</p><p>demo</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>test-pd</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>image</span>: <span style=color:#1c01ce>xx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>test-container</span>
</span></span><span style=display:flex><span>    <span style=color:#000>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#000>mountPath</span>: <span style=color:#1c01ce>/test-pd</span>
</span></span><span style=display:flex><span>      <span style=color:#000>name</span>: <span style=color:#1c01ce>test-volume</span>
</span></span><span style=display:flex><span>  <span style=color:#000>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>test-volume</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hostPath</span>:
</span></span><span style=display:flex><span>      <span style=color:#177500># directory location on host</span>
</span></span><span style=display:flex><span>      <span style=color:#000>path</span>: <span style=color:#1c01ce>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#177500># this field is optional</span>
</span></span><span style=display:flex><span>      <span style=color:#000>type</span>: <span style=color:#1c01ce>Directory</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=pv-persistent-volume>PV(Persistent Volume)</h2><h3 id=概念解释>概念解释</h3><p><strong>PV（PersistentVolume）</strong></p><p>是由管理员设置的存储，它是集群的一部分。就像节点时集群中的资源一样，PV也是集群中的资源。PV是Volume之类的卷插件，但<strong>具有独立于使用PV的Pod的生命周期</strong>。此API对象包含存储实现的细节，即NFS、iSCSI或特定于云供应商的存储系统</p><p><strong>PVC（PersistentVolumeClaim）</strong></p><p>是用户存储的请求。与Pod相似。Pod消耗节点资源，PVC消耗PV资源。Pod可以请求特定级别的资源（CPU和内存）。声明可以请求特定的大小和访问模式（例如，可以以读写一次货只读多次模式挂载）</p><h3 id=pv-pvc>PV&PVC</h3><p><strong>静态pv</strong></p><p>集群管理员创建一些PV。它们带有可供集群用户使用的实际存储的细节。它们存在于Kubernetes API中，可用于消费</p><p><strong>动态pv（了解即可）</strong></p><p>当管理员创建的静态pv都不匹配用户的PersistentVolumeClaim时，集群可能会尝试动态地为PVC创建卷。此配置基于StorageClasses：PVC必须请求[存储类]，并且管理员必须创建并配置该类才能进行动态创建。声明该类为""可以有效地禁用其动态配置</p><p>要启用基于存储级别的动态存储配置，集群管理员需要启用API server上的DefaultStorageClass[准入控制器]。例如，通过确保DefaultStorageClass位于API server组件的--adminsssion-control标志，使用逗号分隔的有序值列表中，可以完成此操作</p><p><strong>绑定</strong></p><p>master中的控制环路监视新的PVC，寻找匹配的PV（如果可能），并将它们绑定在一起。如果为新的PVC动态调配PV，则该环路将始终将该PV绑定到PVC。否则，用户总会德奥它们所请求的存储，但是容量可能超出要求的数量。一旦PV和PVC绑定后，PersistentVolumeClaim绑定是排他性的，不管它们是如何绑定的。PVC跟PV绑定是一对一的映射。</p><p><strong>持久化卷声明的保护</strong></p><p>PVC保护的目的是确保由pod正在使用的PVC不会从系统中移除，因为如果被移除的话可能会导致数据丢失</p><p>注意：当pod状态为Pending并且pod已经分配给节点或pod为Running状态时，pvc处于活动状态</p><p>当启用PVC保护alpha功能时，如果用户删除了一个pod正在使用的PVC，则该PVC不会被立即删除。PVC的删除将被推迟，直到PVC不再被任何pod使用。</p><p><strong>持久卷演示代码</strong></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pv0003</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>capacity</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>storage</span>: <span style=color:#1c01ce>5Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#000>volumeMode</span>: <span style=color:#1c01ce>Filesystem</span>
</span></span><span style=display:flex><span>  <span style=color:#000>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#1c01ce>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#000>persistentVolumeReclaimPolicy</span>: <span style=color:#1c01ce>Recycle</span>
</span></span><span style=display:flex><span>  <span style=color:#000>storageClassName</span>: <span style=color:#1c01ce>slow</span>
</span></span><span style=display:flex><span>  <span style=color:#000>mountOptions</span>:
</span></span><span style=display:flex><span>    - <span style=color:#1c01ce>hard</span>
</span></span><span style=display:flex><span>    - <span style=color:#1c01ce>nfsvers=4.1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>nfs</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>path</span>: <span style=color:#1c01ce>/tmp</span>
</span></span><span style=display:flex><span>    <span style=color:#000>server</span>: <span style=color:#1c01ce>172.17.0.2</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=后端类型>后端类型</h4><p>持久化卷类型</p><p>PersistentVolume类型以插件形式实现。Kubernetes目前支持以下插件类型：</p><p>1、GCEPersistentDisk、AWSElasticBlockStrore、AzureFile AzureDisk FC(Fibre Channel)</p><p>2、FlexVolume Flocker NFS iSCSI RBD(Ceph Block Device) CephFS</p><p>3、Cinder(OpenStack block storage) Glusterfs VsphereVolume Quobyte Volumes</p><p>4、HostPath VMware Photon Portworx Volumes ScaleIO Volumes StorageOS</p><h4 id=pv访问模式说明>PV访问模式说明</h4><p>PersistentVolume可以以资源提供者支持的任何方式挂载到主机上。如下表所示，供应商具有不同的功能, 每个PV的访问模式都将被设置为该卷支持的特定模式。例如，NFS可以支持多个读/写客户端，但特定的NFSPV可能以只读方式导出到服务器上。每个PV都有一套自己的用来描述特定功能的访问模式</p><p>1、ReadWriteOnce一一该卷可以被单个节点以读/写模式挂载</p><p>2、ReadOnlyMany一一该卷可以被多个节点以只读模式挂载</p><p>3、ReadWriteMany一一该卷可以被多个节点以读/写模式挂载</p><p>在命令行中, 访问模式缩写为: </p><p>1、RWO - ReadWriteOnce</p><p>2、ROX - ReadOnlyMany</p><p>3、RWX - ReadWriteMany</p><p>一个卷一次只能使用一种访问模式挂载，即使它支持很多访问模式。例如, GCEpersistentDisk可以由单个节点作为ReadWriteOnce模式挂载，或由多个节点以ReadOnlyMany模式挂载，但不能同时挂载。</p><h4 id=回收策略>回收策略</h4><p>1、Retain（保留）——手动回收</p><p>2、Recycle（回收）——基本擦除（rm -rf /thevolume/*）</p><p>3、Delete（删除）——关联的存储资产（例如AWS EBS、GCE PD、Azure Disk和OpenStack Cinder卷）将被删除</p><p>当前，只有NFS和HostPath支持回收策略。AWS EBS、GCE PD、Azure Disk和OpenStack Cinder卷支持删除策略。</p><h4 id=状态>状态</h4><p>卷可以处于以下的某种状态: </p><p>1、Available(可用) 一一一块空闲资源还没有被任何声明绑定</p><p>2、Bound(已绑定) 一一卷已经被声明绑定</p><p>3、Released(已释放) 一一声明被删除, 但是资源还未被集群重新声明</p><p>4、Failed(失败) 一一该卷的自动回收失败</p><p>命令行会显示绑定到PV的PVC的名称</p><h3 id=实例演示>实例演示</h3><p>持久化演示说明-NFS</p><p>整体结构</p><p><img src=../imgs/k8s02_2.png alt=k8s02_2.png></p><p>1、安装 NFS 服务器</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>yum install -y nfs-common nfs-utils rpcbind
</span></span><span style=display:flex><span>mkdir /nfsdata
</span></span><span style=display:flex><span>chmod <span style=color:#1c01ce>666</span> /nfsdata
</span></span><span style=display:flex><span>cat /etc/exports
</span></span><span style=display:flex><span>/nfs *<span style=color:#000>(</span>rw,no_root_squash,no_all_squash,sync<span style=color:#000>)</span>
</span></span><span style=display:flex><span>/nfs1 *<span style=color:#000>(</span>rw,no_root_squash,no_all_squash,sync<span style=color:#000>)</span>
</span></span><span style=display:flex><span>/nfs2 *<span style=color:#000>(</span>rw,no_root_squash,no_all_squash,sync<span style=color:#000>)</span>
</span></span><span style=display:flex><span>/nfs3 *<span style=color:#000>(</span>rw,no_root_squash,no_all_squash,sync<span style=color:#000>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl start rpcbind
</span></span><span style=display:flex><span>systemctl start nfs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 多创建几个pv</span>
</span></span><span style=display:flex><span>mkdir /nfs<span style=color:#000>{</span>1..3<span style=color:#000>}</span>
</span></span><span style=display:flex><span>chmod <span style=color:#1c01ce>777</span> nfs1/ nfs2/ nfs3/
</span></span><span style=display:flex><span>chown nfsnobody nfs1/ nfs2/ nfs3/
</span></span><span style=display:flex><span>systemctl restart rpcbind
</span></span><span style=display:flex><span>systemctl restart nfs
</span></span></code></pre></td></tr></table></div></div></div><p>测试：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>showmount -e 192.168.66.100 <span style=color:#177500># 查看共享目录</span>
</span></span><span style=display:flex><span>mount -t nfs 192.168.66.100:/nfs /test/  <span style=color:#177500># 挂载nfs目录到test下</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /test <span style=color:#000>&amp;&amp;</span> vi 1.html
</span></span><span style=display:flex><span>unmount /test/
</span></span><span style=display:flex><span>rm -rf /test/
</span></span></code></pre></td></tr></table></div></div></div></p><p>2、部署PV<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>nfspv1</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>capacity</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>storage</span>: <span style=color:#1c01ce>2Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#000>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#1c01ce>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#000>persistentVolumeReclaimPolicy</span>: <span style=color:#1c01ce>Retain</span>
</span></span><span style=display:flex><span>  <span style=color:#000>storageClassName</span>: <span style=color:#1c01ce>nfs</span>
</span></span><span style=display:flex><span>  <span style=color:#000>nfs</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>path</span>: <span style=color:#1c01ce>/nfs</span>
</span></span><span style=display:flex><span>    <span style=color:#000>server</span>: <span style=color:#1c01ce>10.168.66.100</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>创建pv<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f pv.yaml
</span></span><span style=display:flex><span>kubectl get pv
</span></span></code></pre></td></tr></table></div></div></div></p><p>3、创建服务并使用PVC<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Service</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>port</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>web</span>
</span></span><span style=display:flex><span>  <span style=color:#000>clusterIP</span>: <span style=color:#1c01ce>None</span>
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span><span style=color:#000>---</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>web</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>app</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>3</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>app</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span><span style=display:flex><span>          <span style=color:#000>name</span>: <span style=color:#1c01ce>web</span>
</span></span><span style=display:flex><span>        <span style=color:#000>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>name</span>: <span style=color:#1c01ce>www</span>
</span></span><span style=display:flex><span>          <span style=color:#000>mountPath</span>: <span style=color:#1c01ce>/usr/share/nginx/html</span>
</span></span><span style=display:flex><span>  <span style=color:#000>volumeClaimTemplates</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>www</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>accessModes</span>: [ <span style=color:#c41a16>&#34;ReadWriteOnce&#34;</span> ]
</span></span><span style=display:flex><span>      <span style=color:#000>storageClassName</span>: <span style=color:#c41a16>&#34;nfs&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>resources</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>requests</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>storage</span>: <span style=color:#1c01ce>1Gi         </span>
</span></span></code></pre></td></tr></table></div></div></details><br></p><p>操作：<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit pv &lt;pv-name&gt; <span style=color:#177500># 删除claimRef，pv才不会显示claim，仅删除pvc和pod都不行</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>KFStatefulSet</p><p>1、匹配Pod name(网络标识) 的模式为: $(statefulset名称) -$(序号) , 比如上面的示例: web-0, web-1, web-2</p><p>2、StatefulSet为每个Pod副本创建了一个DNS域名, 这个域名的格式为: $(podname) .(headless server name)，也就意味着服务间是通过Pod域名来通信而非Pod IP，因为当Pod所在Node发生故障时，Pod会被迁移到其它Node上，PodIP会发生变化，但是Pod域名不会有变化</p><p>3、StatefulSet使用Headless服务来控制Pod的域名，这个域名的FQDN为：(servicename). </p><p>(namespacej).svc.cluster.local，其中, “cluster.loca”指的是集群的域名</p><p>4、根据volumeClaimTemplates，为每个Pod创建一个pvc，pvc的命名规则匹配模式: </p><p>(volumeClaimTemplates.name)-(pod_name)，比如上面的volumeMounts.name=www，pod</p><p>name=web-[0-2]，因此创建出来的PVC是www-web-0、www-web-1、www-web-2</p><p>5、删除Pod不会删除其pvc，手动删除pvc将自动释放pv</p><p>Statefulset的启停顺序：</p><p>1、有序部署：部署StatefulSet时，如果有多个Pod副本，它们会被顺序地创建(从0到N-1) 并且，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态。</p><p>2、有序删除：当Pod被删除时, 它们被终止的顺序是从N-1到0。</p><p>3、有序扩展：当对Pod执行扩展操作时，与部署一样，它前面的Pod必须都处于Running和Ready状态。</p><p>StatefulSet使用场景：</p><p>1、稳定的持久化部署，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC来实现</p><p>2、稳定的网络标识符，即Pod重新掉浮后其PodName和HostName不变</p><p>3、有序部署，有序扩展，基于init containers来实现</p><p>4、有序收缩</p><h3 id=heading></h3><h1 id=调度器>调度器</h1><h2 id=调度器概念>调度器概念</h2><p>Scheduler是kubernetes的调度器，主要的任务是把定义的pod分配到集群的节点上。听起来非常简单，但有很多要考虑的问题: </p><p>1、公平：如何保证每个节点都能被分配资源</p><p>2、资源高效利用：集群所有资源最大化被使用</p><p>3、效率：调度的性能要好，能够尽快地对大批量的pod完成调度工作</p><p>4、灵活：允许用户根据自己的需求控制调度的逻辑</p><p>Sheduler是作为单独的程序运行的，启动之后会一直监听APIServer，获取podspec.NodeNanme为空的pod，对每个pod都会创建一个binding, 表明该pod应该放到哪个节点上</p><h2 id=调度过程>调度过程</h2><p>调度分为几个部分：首先是过滤摇不满足条件的节点，这个过程称为predicate；然后对通过的节点按照优先级排序，这个是priority；最后从中选择优先级最高的节点。如果中间任何一步骤有错误, 就直接返回错误</p><p>Predicate有一系列的算法可以使用: </p><p>1、PodFitsResources：节点上剩余的资源是否大于pod请求的资源</p><p>2、PodFitsHost：如果pod指定了NodeName，检查节点名称是否和NodeName匹配</p><p>3、PodFitsHostPorts：节点上已经使用的port是否和pod申请的port冲突</p><p>4、PodSelectormatches：过滤掉和pod指定的label不匹配的节点</p><p>5、Nooiskconflict：已经mount的volume和pod指定的volume不冲突，除非它们都是只读</p><p>如果在predicate过程中没有合适的节点，pod会一直在pending状态，不断重试调度，直到有节点满足条件。经过这个步骤，如果有多个节点满足条件，就继续priorities过程：按照优先级大小对节点排序。</p><p>优先级由一系列键值对组成，销是该优先级顶的名称，值是它的权重(该项的重要性) 。这些优先级选项包括：</p><p>1、LeastRequestedPriority：通过计算CPU和Memory的使用率来决定权重，使用率越低权重越高。换句话说，这个优先级指标倾向于资源使用比例更低的节点</p><p>2、BalancedResourceAllocation：节点上CPU和Memory使用率越接近，权重越高。这个应该和上面的一起使用，不应该单独使用</p><h2 id=调度亲和性>调度亲和性</h2><p>键值运算关系</p><p>1、In：label的值在某个列表中</p><p>2、NotIn：label的值不在某个列表中</p><p>3、Gt：label的值大于某个值</p><p>4、Lt：label的值小于某个值</p><p>5、Exists：某个label存在</p><p>6、DoesNotExist：某个label不存在</p><p>如果nodeSelectorTerms下面有多个选项的话，满足任何一个条件就可以了；如果matchExpressions有多个选项的话，则必须同时满足这些条件才能正常调度</p><p>亲和性和反亲和性调度策略比较如下：</p><table><thead><tr><th style=text-align:left>调度策略</th><th style=text-align:left>匹配标签</th><th style=text-align:left>操作符</th><th style=text-align:left>拓扑域</th><th style=text-align:left>调度目标</th></tr></thead><tbody><tr><td style=text-align:left>nodeAffinity</td><td style=text-align:left>主机</td><td style=text-align:left>In, NotIn, Exists, DoesNotExist, Gt, Lt</td><td style=text-align:left>否</td><td style=text-align:left>指定主机</td></tr><tr><td style=text-align:left>podAffinity</td><td style=text-align:left>POD</td><td style=text-align:left>In, NotIn, Exists, DoesNotExist</td><td style=text-align:left>是</td><td style=text-align:left>POD与指定POD同一拓扑域</td></tr><tr><td style=text-align:left>podAffinity</td><td style=text-align:left>POD</td><td style=text-align:left>In, NotIn, Exists, DoesNotExist</td><td style=text-align:left>是</td><td style=text-align:left>POD与指定POD不在同一拓扑域</td></tr></tbody></table><h3 id=节点亲和性>节点亲和性</h3><p>pod.spec.nodeAffinity</p><p>1、preferredDuringSchedulingIgnoreDuringExecution：软策略</p><p>2、requireDuringSchedulingIgnoreDuringExecution：硬策略</p><p>requireDuringSchedulingIgnoreDuringExecution</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>affinity</span>
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>node-affinity-pod</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>with-node-affinity</span>
</span></span><span style=display:flex><span>    <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xxx:v1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>affinity</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>nodeAffinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>requiredDuringSchedulingIgnoreDuringExecution</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>nodeSelectorTerms</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>matchExpressions</span>:
</span></span><span style=display:flex><span>          - <span style=color:#000>key</span>: <span style=color:#1c01ce>kubernetes.io/hostname</span>
</span></span><span style=display:flex><span>            <span style=color:#000>operator</span>: <span style=color:#1c01ce>NotIn</span>
</span></span><span style=display:flex><span>            <span style=color:#000>values</span>:
</span></span><span style=display:flex><span>            - <span style=color:#1c01ce>k8s-node02</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>辅助信息查询<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get node --show-labels  <span style=color:#177500># key就是node节点的标签</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>preferredDuringSchedulingIgnoredDuringExecution</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>affinity</span>
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>node-affinity-pod</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>with-node-affinity</span>
</span></span><span style=display:flex><span>    <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xxx:v1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>affinity</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>nodeAffinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>preferredDuringSchedulingIgnoreDuringExecution</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>weight</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>preference</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>matchExpressions</span>:
</span></span><span style=display:flex><span>          - <span style=color:#000>key</span>: <span style=color:#1c01ce>source</span>
</span></span><span style=display:flex><span>            <span style=color:#000>operator</span>: <span style=color:#1c01ce>In</span>
</span></span><span style=display:flex><span>            <span style=color:#000>values</span>:
</span></span><span style=display:flex><span>            - <span style=color:#1c01ce>xxx</span>
</span></span></code></pre></td></tr></table></div></div></details><br><p>当然软硬策略是可以一起使用的，略</p><h3 id=pod亲和性>Pod亲和性</h3><p>pod.spec.affinity.podAffinity/podAntiAffinity</p><p>1、preferredDuringSchedulingIgnoreDuringExecution：软策略</p><p>2、requireDuringSchedulingIgnoreDuringExecution：硬策略</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Pod</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-3p </span>
</span></span><span style=display:flex><span>  <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>app</span>: <span style=color:#1c01ce>pod-3</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-3</span>
</span></span><span style=display:flex><span>    <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xxx:v1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>affinity</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>podAffinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>requiredDuringSchedulingIgnoreDuringExecution</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>labelSelector</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>matchExpressions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>key</span>: <span style=color:#1c01ce>app</span>
</span></span><span style=display:flex><span>          <span style=color:#000>operator</span>: <span style=color:#1c01ce>In</span>
</span></span><span style=display:flex><span>          <span style=color:#000>values</span>:
</span></span><span style=display:flex><span>          - <span style=color:#1c01ce>pod-1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>podAntiAffinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>preferredDuringSchedulingIgnoreDuringExecution</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>weight</span>: <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>podAffinityTerm</span>:
</span></span><span style=display:flex><span>          <span style=color:#000>labelSelector</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>matchExpressions</span>:
</span></span><span style=display:flex><span>            - <span style=color:#000>key</span>: <span style=color:#1c01ce>app</span>
</span></span><span style=display:flex><span>              <span style=color:#000>operator</span>: <span style=color:#1c01ce>In</span>
</span></span><span style=display:flex><span>              <span style=color:#000>values</span>:
</span></span><span style=display:flex><span>              - <span style=color:#1c01ce>xxx</span>
</span></span><span style=display:flex><span>          <span style=color:#000>topologyKey</span>: <span style=color:#1c01ce>kubernetes.io/hostname</span>
</span></span></code></pre></td></tr></table></div></div></details><br><h2 id=污点和容忍>污点和容忍</h2><p>节点亲和性，是pod的一种属性(偏好或硬性要求)，它使pod被吸引到一类特定的节点，Taint则相反，它使节点能够排斥一类特定的pod</p><p>Taint和toleration相互配合，可以用来避免pod被分配到不合适的节点上。每个节点上都可以应用一个或多个taint，这表示对于那些不能容忍这些taint的pod，是不会被该节点接受的。如果将toleration应用于pod上，则表示这些pod可以(但不要求)被调度到具有匹配taint的节点上。</p><h3 id=污点-taint>污点（Taint）</h3><p>1、污点的组成</p><p>使用kubectl taint命令可以给某个Node节点设置污点，Node被设置上污点之后就和Pod之间存在了一种相斥的关系，可以让Node拒绝Pod的调度执行，甚至将Node已经存在的Pod驱逐出去</p><p>每个污点的组成如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000>key=value:effect</span>
</span></span></code></pre></td></tr></table></div></div></div><p>每个污点有一个key和value作为污点的标签，其中value可以为空，effect描述污点的作用。当前taint effect支持如下三个选项：
1、NoSchedule：表示k8s将不会将Pod调度到具有该污点的Node上</p><p>2、PreferNoSchedule：表示k8s将尽量避免将Pod调度到具有该污点的Node上</p><p>3、NoExecute：表示k8s将不会将Pod调度到具有该污点的Node上已经存在的Pod驱逐出去</p><p>污点的设置、查看和去除</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 设置污点</span>
</span></span><span style=display:flex><span>kubectl taint nodes node1 <span style=color:#000>key1</span><span style=color:#000>=</span>value1:NoSchedule
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 节点说明中，查找Taints字段</span>
</span></span><span style=display:flex><span>kubectl describe pod pod-name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 去除污点</span>
</span></span><span style=display:flex><span>kubectl taint nodes node1 key1:NoSchedule-
</span></span></code></pre></td></tr></table></div></div></div><h3 id=容忍-tolerations>容忍（Tolerations）</h3><p>设置了污点的Node将根据taint的effect: NoSchedule、PreferNoSchedule、NoExecute</p><p>和Pod之间产生互斥的关系，Pod将在一定程度上不会被调度到Node上。但我们可以在Pod上设</p><p>置容忍(Toleration) ，意思是设置了容忍的Pod将可以容忍污点的存在，可以被调度到存在污点的Node上</p><p>pod.spec.tolerations</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>tolerations</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>key</span>: <span style=color:#c41a16>&#34;key1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>operator</span>: <span style=color:#c41a16>&#34;Equal&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>value</span>: <span style=color:#c41a16>&#34;value1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>effect</span>: <span style=color:#c41a16>&#34;NoSchedule&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>tolerationSeconds</span>: <span style=color:#1c01ce>3600</span>
</span></span><span style=display:flex><span>- <span style=color:#000>key</span>: <span style=color:#c41a16>&#34;key1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>operator</span>: <span style=color:#c41a16>&#34;Equal&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>value</span>: <span style=color:#c41a16>&#34;value1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>effect</span>: <span style=color:#c41a16>&#34;NoSchedule&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#000>key</span>: <span style=color:#c41a16>&#34;key2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>operator</span>: <span style=color:#c41a16>&#34;Exists&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>effect</span>: <span style=color:#c41a16>&#34;NoSchedule&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>1）其中key, vaule, effect要与Node上设置的taint保持一致
2）operator的值为Exists将会忽略value值</p><p>3）tolerationSeconds用于描述当Pod需要被驱逐时可以在Pod上继续保留运行的时间</p><p>1、当报振定key值时, 表示容志所有的污点key: </p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#1c01ce>tolerations: </span>
</span></span><span style=display:flex><span>- <span style=color:#000>operator</span>: <span style=color:#c41a16>&#34;Exists&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、当不指定effect值时, 表示容忍所有的污点作用</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>tolerations: 
</span></span><span style=display:flex><span>- key: <span style=color:#c41a16>&#34;key&#34;</span>
</span></span><span style=display:flex><span>  operator: <span style=color:#c41a16>&#34;Exists&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>3、有多个Master存在时, 防止资源浪费, 可以如下设置<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#1c01ce>kubectl taint nodes Node-Name node-role.kubernetes.io/master=:PreferNoSchedule</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=固定节点调度>固定节点调度</h2><p>1、Pod.spec.nodeName将Pod直接调度到指定的Node节点上，会跳过Scheduler的调度策</p><p>略, 该匹配规则是强制匹配</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extension/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myweb</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>7</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#1c01ce>labels：</span>
</span></span><span style=display:flex><span>        <span style=color:#000>app</span>: <span style=color:#1c01ce>myweb</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>nodeName</span>: <span style=color:#1c01ce>k8s-node01</span>
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>myweb</span>
</span></span><span style=display:flex><span>        <span style=color:#000>iamge</span>: <span style=color:#1c01ce>xx:v1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2、Pod.spec.nodeSelector：通过Kubernetes的label-selector机制选择节点，由调度器调度策略匹配label，而后调度Pod到目标节点，该匹配规则属于强制约束</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>extension/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>myweb</span>
</span></span><span style=display:flex><span><span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>replicas</span>: <span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>app</span>: <span style=color:#1c01ce>myweb</span>
</span></span><span style=display:flex><span>    <span style=color:#000>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>nodeSelector</span>:
</span></span><span style=display:flex><span>        <span style=color:#1c01ce>type:backEndNode01</span>
</span></span><span style=display:flex><span>      <span style=color:#000>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#000>name</span>: <span style=color:#1c01ce>myweb</span>
</span></span><span style=display:flex><span>        <span style=color:#000>image</span>: <span style=color:#1c01ce>xxx:xx</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#000>containerPort</span>: <span style=color:#1c01ce>80</span>    
</span></span></code></pre></td></tr></table></div></div></div><h1 id=集群安全机制>集群安全机制</h1><p>机制说明</p><p>Kubernetes作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。API Server是集群内部各个组件通信的中介，也是外部控制的入口。所以Kubernetes的安全机制基本就是围绕保护API Server来设计的。Kubernetes使用了认证（Authentication）、鉴权（Authorization）、准入控制（Admission Control）三步来保证API Server的安全。</p><h2 id=认证>认证</h2><h3 id=http-token>HTTP Token</h3><p>通过一个Token来识别合法用户。</p><p>HTTP Token的认证使用一个很长的特殊编码方式的并且难以被模仿的字符串-Token来表达客户的一种方式。Token是一个很长的很复杂的字符串，每一个Token对应一个用户名存储在API Server能访问的文件中。当客户端发起API调度请求时，需要在HTTP Header里放入Token</p><h3 id=http-base>HTTP Base</h3><p>通过用户名+密码的方式认证</p><p>用户名+密码用BASE64算法进行编码后的字符串放在HTTP Request中的Heather Authorization域里发送给服务端，服务端收到后进行编码，获取用户名及密码。</p><p>上面两种方式的问题：服务端没有被认证，只认证了客户端</p><h3 id=https>HTTPS</h3><p>基于CA根证书签名的客户端身份认证方式</p><p>1、HTTPS证书认证</p><p><img src=../imgs/k8s02_3.png alt=k8s02_3.png></p><p>2、需要认证的节点</p><p>两种类型：</p><p>1、Kubernetes组件对API Server的访问：kubectl、Controller Manager、Scheduler、kubelet、kube-proxy</p><p>2、Kubernetes管理的Pod对容器的访问：Pod（dashborad也是以Pod形式运行）</p><p>安全性说明</p><p>1、Controller Manager、Scheduler与API Server在同一台机器，所以直接使用API Server的非安全端口访问，--insecure-bind-address=127.0.0.1</p><p>2、kubectl、kubelet、kube-proxy访问API Server就都需要证书进行HTTPS双向认证</p><p>证书颁发</p><p>1、手动签发：通过k8s集群的跟CA进行签发HTTPS证书</p><p>2、自动签发：kubelet首次访问API Server时，使用token做认证，通过后，Controller Manager会为kubelet生成一个证书，以后的访问都是用证书做认证了</p><p>3、kubeconfig</p><p>kubeconfig文件包含集群参数（CA证书、API Server地址），客户端参数（上面生成的证书和私钥），集群context信息（集群名称、用户名）。Kubernetes组件通过启动时指定不同的kubeconfig文件可以切换到不同的集群</p><p>4、ServiceAccount</p><p>Pod中的容器访问API Server。因为Pod的创建、销毁是动态的，所以要为它手动生成证书就不可行了。Kubernetes使用Service Account解决Pod访问API Server的认证问题</p><p>5、Secret与SA的关系</p><p>Kubernetes设计了一种资源对象叫做Secret，分为两类，一种是用于ServiceAccount的service-accont-token，另一种是用于保存用户自定义保密信息的Opaque。ServiceAccount中用到包含三个部分：Token、ca.crt、namespace</p><p>1）token是使用API Server私钥签名的JWT。用于访问API Server时，Server端认证</p><p>2）ca.crt，根证书。用于Client端验证API Server发送的证书</p><p>3）namespace，标识这个serveice-account-token的作用域名空间</p><p>Json web token（JWT），是为了在网络应用环境间船体声明而执行的一种基于JSON的开放标准（RFC 7519）。该token被设计为紧凑且安全的，特别适用于分布式站点的单点登陆（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间船体被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证、也可被加密。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret --all-namespaces
</span></span><span style=display:flex><span>kubectl describe secret default-token-5gm9r --namespace<span style=color:#000>=</span>kube-system
</span></span></code></pre></td></tr></table></div></div></div><p>默认情况下，每个namespace都会有一个ServiceAccount，如果Pod在创建时没有指定ServiceAccount，就会使用Pod所属的namespace的ServiceAccount
默认挂载目录：/run/secrets/kubernetes.io/serviceaccount/</p><h2 id=鉴权>鉴权</h2><p>上面认证过程，只是确认通信的双方都确认了对方是可信的，可以相互通信。而鉴权是确定请求方有哪些资源的权限。API Server目前支持以下几种授权策略（通过API Server的启动参数"--authorization-mode"设置）</p><h3 id=alwaysdeny>AlwaysDeny</h3><p>表示拒绝所有的请求，一般用于测试</p><h3 id=alwaysallow>AlwaysAllow</h3><p>允许接收所有秦秋，如果集群不需要授权流程，则可以采用该策略</p><h3 id=abac>ABAC</h3><p>（Attribute-Based Access Control）：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制。并且修改后需要重启API Server。（需要定义很多属性）</p><h3 id=webbook>Webbook</h3><p>通过调用外部REST服务对用户进行授权</p><h3 id=rbac>RBAC</h3><p>（Role-Based Access Control）：基于角色的访问控制，现行默认规则</p><h4 id=rbac授权模式>RBAC授权模式</h4><p>在Kubernetes 1.5中引入，现行版本成为默认标准。相对于其它访问控制方式，拥有以下优势</p><p>1）对集群中的资源和非资源均拥有完整的覆盖</p><p>2）整个RBAC完全由几个API对象完成，同其它API对象一样，可以用kubectl或API进行操作</p><p>3）可以在运行时进行调整，无需重启API Server</p><p>1、RBAC的API资源对象说明</p><p>RBAC引入了4个新的顶级资源对象：Role、ClusterRole、RoleBinding、ClusterRoleBinding，4种对象类型均可以通过kubectl与API操作</p><p><img src=../imgs/k8s02_4.png alt=k8s02_4.png></p><p>需要注意的是Kubernetes并不会提供用户管理，那么User、Group、ServiceAccount指定的用户又是从哪里来的呢？Kubernetes组件（kubectl、kube-proxy）或是其他自定义的用户在想CA申请证书时，需要提供一个证书请求文件</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;CN&#34;</span>: <span style=color:#c41a16>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;hosts&#34;</span>: [],
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;key&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;algo&#34;</span>: <span style=color:#c41a16>&#34;rsa&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;size&#34;</span>: <span style=color:#1c01ce>2048</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;names&#34;</span>: [
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;C&#34;</span>: <span style=color:#c41a16>&#34;CN&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;ST&#34;</span>: <span style=color:#c41a16>&#34;HangZhou&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;L&#34;</span>: <span style=color:#c41a16>&#34;XS&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;O&#34;</span>: <span style=color:#c41a16>&#34;system:masters&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;OU&#34;</span>: <span style=color:#c41a16>&#34;System&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>API Server会把客户端证书的CN字段作为User，把names.O字段作为Group
kubelet使用TLS Bootstaping认证时，API Server可以使用Bootstrap Tokens或者Token authentication file 验证 =token，无论哪一种，Kubernetes都会为token绑定一个默认的User和Group</p><p>Pod使用ServiceAccount认证时，service-account-token中的JWT会保存User信息</p><p>有了用户信息，再创建一对角色/角色绑定（集群角色/集群角色绑定）资源对象，就可以完成权限绑定了</p><h4 id=role-and-clusterrole>Role and ClusterRole</h4><p>在RBAC API中，Role表示一组规则权限，权限只会增加（累加权限），不存在一个资源一开始就有很多权限而通过RBAC对其进行减少的操作；Role可以定义一个namespace钟，如果想要跨namespace中，如果想要跨namespace则可以创建ClusterRole</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Role</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-reader</span>
</span></span><span style=display:flex><span><span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>apiGroups</span>: [<span style=color:#c41a16>&#34;&#34;</span>] <span style=color:#177500># &#34;&#34; indicates the core API group</span>
</span></span><span style=display:flex><span>  <span style=color:#000>resources</span>: [<span style=color:#c41a16>&#34;pods&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#000>verbs</span>: [<span style=color:#c41a16>&#34;get&#34;</span>, <span style=color:#c41a16>&#34;watch&#34;</span>, <span style=color:#c41a16>&#34;list&#34;</span>]
</span></span></code></pre></td></tr></table></div></div></div><p>ClusterRole具有与Role相同的权限角色控制能力，不同的是ClusterRole是集群级别的，ClusterRole可以用于：
1、集群级别的资源控制（例如node访问权限）</p><p>2、非资源型endpoints（例如 /healthz 访问）</p><p>3、所有命名空间资源控制（例如pods）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ClusterRole</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#177500># &#34;namespace&#34; omitted since ClusterRole are not namespaced</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>secret-reader</span>
</span></span><span style=display:flex><span><span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>apiGroups</span>: [<span style=color:#c41a16>&#34;&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#000>resources</span>: [<span style=color:#c41a16>&#34;secrets&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#000>verbs</span>: [<span style=color:#c41a16>&#34;get&#34;</span>, <span style=color:#c41a16>&#34;watch&#34;</span>, <span style=color:#c41a16>&#34;list&#34;</span>]
</span></span></code></pre></td></tr></table></div></div></div><h4 id=rolebinding-and-clusterrolebindind>RoleBinding and ClusterRoleBindind</h4><p>RoleBinding可以将角色中定义的权限授予用户或用户组，RoleBinding包含一组权限列表（subjects），权限列表中包含有不同形式的待授予权限资源类型（users, groups, or service accounts）；RoleBinding同样包含对被Bind的Role引用；RoleBinding适用于某个命名空间内授权，而ClusterRoleBinding适用于集群范围内的授权</p><p>将default命名空间的pod-reader Role授予jane用户，此后jane用户在default命名空间中将具有pod-reader的权限</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>read-pods</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span><span style=color:#000>subjects</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>kind</span>: <span style=color:#1c01ce>User</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>jane</span>
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span><span style=color:#000>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>kind</span>: <span style=color:#1c01ce>Role</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-reader</span>
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span></code></pre></td></tr></table></div></div></div><p>RoleBinding同样可以引用ClusterRole来对当前namespaces内用户、用户组或ServiceAccount进行授权，这种操作允许操作集群管理员在整个集群内定义一些通用的ClusterRole，然后在不同的namespace中使用RoleBinding来引用
例如，以下RoleBinding引用了一个ClusterRole，这个ClusterRole具有整个集群内对secrets的访问权限；但是其授权用户dave只能访问development空间中的secrets（因为RoleBinding定义在development命名空间）</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#177500># this role binding allows &#34;dave&#34; to read secrets in the &#34;development&#34; namespace</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>read-secrets</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>development</span> <span style=color:#177500># This is only grants permissions within the &#34;development&#34; namespace</span>
</span></span><span style=display:flex><span><span style=color:#000>subjects</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>kind</span>: <span style=color:#1c01ce>User</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>dave</span>
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span><span style=color:#000>RoleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>kind</span>: <span style=color:#1c01ce>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>secret-reader</span>
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span></code></pre></td></tr></table></div></div></div><p>使用ClusterRoleBinding可以对整个集群中的所有命名空间资源权限进行授权，以下ClusterRoleBinding示例展示了授权manager组内所有用户在全部命名空间中对secrets进行访问<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#177500># this cluster role binding allows anyone in the &#34;manager&#34; group to read secrets in any namespace</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>read-secrets-global</span>
</span></span><span style=display:flex><span><span style=color:#000>subjects</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>kind</span>: <span style=color:#1c01ce>Group</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>manager</span>
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span><span style=color:#000>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>kind</span>: <span style=color:#1c01ce>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>secret-reader</span>
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h4 id=resources>Resources</h4><p>Kubernetes集群内一些资源一般以其名称字符串来表示，这些字符串一般会在API的URL地址中出现；同时某些资源也会包含子资源，例如logs资源就属于pods的子资源，API中URL样例如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>GET /api/v1/namespace/<span style=color:#000>{</span>namespace<span style=color:#000>}</span>/pods/<span style=color:#000>{</span>name<span style=color:#000>}</span>/log
</span></span></code></pre></td></tr></table></div></div></div><p>如果要在RBAC授权模型中控制这些子资源的访问权限，可以通过 / 分隔符来实现，以下是一个定义pods资源logs访问权限的Role定义样例<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>Role</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>default</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>pod-and-pod-logs-reader</span>
</span></span><span style=display:flex><span><span style=color:#000>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#000>apiGroups</span>: [<span style=color:#c41a16>&#34;&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#000>resources</span>: [<span style=color:#c41a16>&#34;pods&#34;</span>, <span style=color:#c41a16>&#34;pods/log&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#000>verbs</span>: [<span style=color:#c41a16>&#34;get&#34;</span>, <span style=color:#c41a16>&#34;list&#34;</span>]
</span></span></code></pre></td></tr></table></div></div></div></p><h4 id=to-subjects>to Subjects</h4><p>RoleBinding和ClusterRoleBinding可以将Role绑定到Subjects；Subjects可以是groups、users或者service accounts</p><p>Subjects中Users使用字符串表示，它可以是一个普通的名字字符串，如“alice”；也可以是email格式的邮箱地址；甚至是一组字符串形式的数字ID。但是Users的前缀system: 是系统保留的，集群管理员应该确保普通用户不会使用这个前缀格式</p><p>Groups书写格式与Users相同，都为一个字符串，并且没有特定的格式要求；同样system: 前缀为系统保留</p><h4 id=实验-创建系统用户管理名称空间>实验：创建系统用户管理名称空间</h4><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;CN&#34;: </span><span style=color:#c41a16>&#34;devuser&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;hosts&#34;: </span>[],
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;key&#34;: </span>{
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;algo&#34;: </span><span style=color:#c41a16>&#34;rsa&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;size&#34;: </span><span style=color:#1c01ce>2048</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;names&#34;: </span>[
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#000>&#34;C&#34;: </span><span style=color:#c41a16>&#34;CN&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>&#34;ST&#34;: </span><span style=color:#c41a16>&#34;BeiJing&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>&#34;L&#34;: </span><span style=color:#c41a16>&#34;BeiJing&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>&#34;O&#34;: </span><span style=color:#c41a16>&#34;k8s&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#000>&#34;OU&#34;: </span><span style=color:#c41a16>&#34;System&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><p>证书工具<style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 下载证书生成工具</span>
</span></span><span style=display:flex><span>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
</span></span><span style=display:flex><span>mv cfssl_linux-amd64 /usr/local/bin/sfssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span></span><span style=display:flex><span>mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span></span><span style=display:flex><span>mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cfssl gencert -ca<span style=color:#000>=</span>ca.crt -ca-key<span style=color:#000>=</span>ca.key -profile<span style=color:#000>=</span>kubernetes /root/devuser-csr.json | <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>cfssljson -bare devuser
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 设置集群参数</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>export</span> <span style=color:#000>KUBE_APISERVER</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;https://172.20.0.113.6443&#34;</span>
</span></span><span style=display:flex><span>kubectl config set-cluster kubernetes <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--certificate-authority<span style=color:#000>=</span>/etc/kubernetes/ssl/ca.pem <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--embed-certs<span style=color:#000>=</span><span style=color:#a90d91>true</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--server<span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>KUBE_APISERVER</span><span style=color:#c41a16>}</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--kubeconfig<span style=color:#000>=</span>devuser.kubeconfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 设置客户端认证参数</span>
</span></span><span style=display:flex><span>kubectl config set-credentials devuser <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--client-certificate<span style=color:#000>=</span>/etc/kubernetes/ssl/devuser.pem <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--client-key<span style=color:#000>=</span>/etc/kubernetes/ssl/devuser-key.pem <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--embed-certs<span style=color:#000>=</span><span style=color:#a90d91>true</span> <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--kubeconfig<span style=color:#000>=</span>devuser.kubeconfig
</span></span><span style=display:flex><span><span style=color:#177500># 会生成devuser.kubeconfig文件</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 设置上下文参数</span>
</span></span><span style=display:flex><span>kubectl config set-context kubernetes <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--cluster<span style=color:#000>=</span>kubernetes <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--user<span style=color:#000>=</span>devuser <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--namespace<span style=color:#000>=</span>dev <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--kubeconfig<span style=color:#000>=</span>devuser.kubeconfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create namespace dev
</span></span><span style=display:flex><span><span style=color:#177500># 设置默认上下文</span>
</span></span><span style=display:flex><span>kubectl config use-context kubernetes --kubeconfig<span style=color:#000>=</span>devuser.kubeconfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp -f ./devuser.kubeconfig /root/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create rolebinding devuser-admin-binding --clusterrole<span style=color:#000>=</span>admin <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--user<span style=color:#000>=</span>devuser --namespace<span style=color:#000>=</span>dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pod --all-namespace -o wide | grep nginx
</span></span><span style=display:flex><span>kubectl get pod -n default
</span></span></code></pre></td></tr></table></div></div></details><br></p><h2 id=准入控制>准入控制</h2><p>准入控制是API Server的插件集合，通过添加不同的插件，实现额外的准入控制规则。甚至于API Server的一些主要的功能都需要通过Admission Controllers实现，比如ServiceAccount</p><p>官方文档上有一份针对不同版本的准入控制器推荐列表，其中最新的1.14的推荐列表是：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plain data-lang=plain><span style=display:flex><span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MustatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota
</span></span></code></pre></td></tr></table></div></div></div><p>列举几个插件的功能：
1、NamespaceLifecycle</p><p>防止不存在namespace上创建对象，防止删除系统阈值namespace，删除namespace是，连带删除它的所有资源对象</p><p>2、LimitRanger</p><p>确保请求的资源不会超过资源所在Namespace的LimitRange的限制</p><p>3、ServiceAccount</p><p>实现了自动化添加ServiceAccount</p><p>4、ResourceQuota</p><p>确保请求的资源不会超过资源的ResourceQuota限制</p><h1 id=helm>HELM</h1><p>在没使用helm之前，想Kubernetes部署应用，要一次部署deployment、svc等，步骤较繁琐。况且随着很多项目微服务话，复杂的应用在容器中部署以及管理显得较为复杂，helm通过打包的方式，支持发布的版本管理和控制，很大程序上简化了Kubernetes应用的部署和管理</p><p>Helm本质就是让K8S的应用管理（Deployment、Service等）可配置，能动态生成。通过动态生成K8S资源清单文件（deployment.yaml、service.yaml）。然后调用kubectl自动执行K8S资源部署</p><p>Helm是官方提供的类似于Linux的YUM的包管理器，是部署环境的流程封装。Helm有两个重要的概念：chart和release</p><p>1、chart是创建一个因公的信息集合，包括各种Kubernetes对象的配置模板、参数定义、依赖关系、文档说明等。chart是应用部署的自包含逻辑单元。可以将chart想象成apt、yum中的软件安装包</p><p>2、release是chart的运行实例，代表了一个正在运行的应用。当chart被安装到Kubernetes集群，就生成一个release。chart能够多次安装到同一个集群，每次安装都是一个release</p><p>Helm包含两个组件：Helm客户端和Tiller服务器</p><p><img src=../imgs/k8s02_5.png alt=k8s02_5.png></p><p>Helm客户端负责chart和release的创建和管理以及和Tiller的交互。Tiller服务器运行在Kubernetes集群中，它会处理Helm客户端的请求，与Kubernetes API Server交互。</p><h2 id=helm部署实例>HELM部署实例</h2><p>下载helm命令行工具到master节点node1的 /usr/local/bin下</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>ntpdate ntp1.aliyun.com
</span></span><span style=display:flex><span>wget https;//storage.googleapis.com/kubernetes-helm/helm-v2.13.1-linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar -zxvf helm-v2.13.1-linux-amd64.tar.gz
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> linux-amd64/
</span></span><span style=display:flex><span>cp helm /usr/local/bin/
</span></span></code></pre></td></tr></table></div></div></div><p>为了安装服务端tiller，还需要再这台机器上配置好kubectl工具和kubeconfig文件，确保kubectl工具可以在这台机器上访问apiserver且正常使用。这里的node1节点以及配置好了kubectl
因为Kubernetes APIServer开启了RBAC的访问控制，所以需要创建tiller使用的service account: tiller并分配合适的角色给它。详细内容可以查看helm文档中的Role-based Access Control（<a href=https://docs.helm.sh/using_helm/#role-based-access-control>https://docs.helm.sh/using_helm/#role-based-access-control</a>）。这里简单起见直接分配cluster-admin集群内置的Cluster Role给它。创建rbac-config.yaml文件：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>v1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>tiller</span>
</span></span><span style=display:flex><span>  <span style=color:#000>namespace</span>: <span style=color:#1c01ce>kube-system</span>
</span></span><span style=display:flex><span><span style=color:#000>---</span>
</span></span><span style=display:flex><span><span style=color:#000>apiVersion</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#000>kind</span>: <span style=color:#1c01ce>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#000>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>tiller</span>
</span></span><span style=display:flex><span><span style=color:#000>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>apiGroup</span>: <span style=color:#1c01ce>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#000>kind</span>: <span style=color:#1c01ce>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#000>name</span>: <span style=color:#1c01ce>cluster-admin</span>
</span></span><span style=display:flex><span><span style=color:#000>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#000>kind</span>: <span style=color:#1c01ce>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#000>name</span>: <span style=color:#1c01ce>tiller</span>
</span></span><span style=display:flex><span>    <span style=color:#000>namespace</span>: <span style=color:#1c01ce>kube-system</span>
</span></span></code></pre></td></tr></table></div></div></div><p>操作<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f rbac-config.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm init --service-account tiller --skip-refresh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pod -n kube-system
</span></span><span style=display:flex><span>kubectl describe pod xxxx 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pod -n kube-system -l <span style=color:#000>app</span><span style=color:#000>=</span>helm
</span></span><span style=display:flex><span>helm version
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=helm自定义模板>HELM自定义模板</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 创建文件夹</span>
</span></span><span style=display:flex><span>mkdir ./hello-world
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> ./hello-world
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 创建自描述文件 Chart.yaml，必须有 name 和 version 定义</span>
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&lt;&lt;&#39;EOF&#39; &gt; ./Chart.yaml
</span></span></span><span style=display:flex><span><span style=color:#c41a16>name: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>version: 1.0.0
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 创建模板文件，用于生成Kubernetes资源清单(manifests)</span>
</span></span><span style=display:flex><span>mkdir ./templates
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&lt;&lt;&#39;EOF&#39; &gt; ./templates/deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#c41a16>apiVersion: extensions/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#c41a16>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#c41a16>metadata:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  name: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>spec:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  template:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      labels:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        app: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    spec:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      containers:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        - name: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>          image: xxx:v1
</span></span></span><span style=display:flex><span><span style=color:#c41a16>          ports:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>            - containerPort: 8080
</span></span></span><span style=display:flex><span><span style=color:#c41a16>              protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&lt;&lt;&#39;EOF&#39; &gt; ./templates/service.yaml
</span></span></span><span style=display:flex><span><span style=color:#c41a16>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#c41a16>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#c41a16>metadata:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  name: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>spec:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  type: NodePort
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  ports:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  - port: 8080
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    targetPort: 8080
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  selector:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    app: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span></code></pre></td></tr></table></div></div></details><br><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 使用命令 helm install RELATIVE_PATH_TO_CHART 创建一次Release</span>
</span></span><span style=display:flex><span>helm install .
</span></span><span style=display:flex><span><span style=color:#177500># 列出已经部署的 Release</span>
</span></span><span style=display:flex><span>helm ls
</span></span><span style=display:flex><span><span style=color:#177500># 查询一个特定的Release的状态</span>
</span></span><span style=display:flex><span>helm status RELEASE_NAME
</span></span><span style=display:flex><span><span style=color:#177500># 移除所有与这个 Release 相关的 Kubernetes 资源</span>
</span></span><span style=display:flex><span>helm delete cautious-shrimp
</span></span><span style=display:flex><span>helm rollback RELEASE_NAME REVISION_NUMBER
</span></span><span style=display:flex><span>helm rollback cautious-shrimp <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span><span style=color:#177500># 使用 helm delete --purge RELEASE_NAME 移除所有与指定Release相关的</span>
</span></span><span style=display:flex><span><span style=color:#177500># Kubernetes资源和所有这个Release的记录</span>
</span></span><span style=display:flex><span>helm delete --purge cautious-shrimp
</span></span><span style=display:flex><span>helm ls --deleted
</span></span></code></pre></td></tr></table></div></div></div><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 配置提现在配置文件 values.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&lt;&lt;&#39;EOF&#39; &gt; ./values.yaml
</span></span></span><span style=display:flex><span><span style=color:#c41a16>image:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  repository: xxx
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  tag: &#39;1.0&#39;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 这个文件中定义的值，在模板文件中可以通过 .Values对象访问到</span>
</span></span><span style=display:flex><span>cat <span style=color:#c41a16>&lt;&lt;&#39;EOF&#39; &gt; ./templates/deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#c41a16>apiVersion: extension/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#c41a16>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#c41a16>metadata:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  name: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>spec:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  template:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      labels:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        app: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    spec:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      containers:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        - name: hello-world
</span></span></span><span style=display:flex><span><span style=color:#c41a16>          image: {{ .Values.image.repository }}:{{ .Value.image.tag }}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>          ports:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>            - containerPort: 8080
</span></span></span><span style=display:flex><span><span style=color:#c41a16>              protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 在values.yaml 中的值可以被不熟 release 时用到的参数 --values YAML_FILE_PATH</span>
</span></span><span style=display:flex><span><span style=color:#177500># 或 --set key1=value1, key2=value2 覆盖掉</span>
</span></span><span style=display:flex><span>helm install --set iamge.tag<span style=color:#000>=</span><span style=color:#c41a16>&#39;latest&#39;</span> .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 升级版本</span>
</span></span><span style=display:flex><span>helm upgrade -f values.yaml <span style=color:#a90d91>test</span> .
</span></span></code></pre></td></tr></table></div></div></details><br><p>Debug</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 使用模板动态生成k8s资源清单，非常需要能提前预览生成的结果</span>
</span></span><span style=display:flex><span><span style=color:#177500># 使用--dry-run --debug选项来打印出生成的清单文件内容，而不执行部署</span>
</span></span><span style=display:flex><span>helm install . --dry-run --debug --set image.tag<span style=color:#000>=</span>latest
</span></span></code></pre></td></tr></table></div></div></div><h3 id=helm部署dashboard>HELM部署dashboard</h3><p>kubernetes-dashboard.yaml</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>image:
</span></span><span style=display:flex><span>  repository: xxx
</span></span><span style=display:flex><span>  tag: v1.10.1
</span></span><span style=display:flex><span>ingress:
</span></span><span style=display:flex><span>  enabled: <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>    - k8s.frognew.com
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/ssl-redirect: <span style=color:#c41a16>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/backend-protocol: <span style=color:#c41a16>&#34;HTTPS&#34;</span>
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>    - secretName: frognew-com-tls-secret
</span></span><span style=display:flex><span>      hosts:
</span></span><span style=display:flex><span>      - k8s.frognew.com
</span></span><span style=display:flex><span>rbac:
</span></span><span style=display:flex><span>  clusterAdminRole: <span style=color:#a90d91>true</span>
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm repo list
</span></span><span style=display:flex><span>helm fetch stable/kubernetes-dashboard
</span></span><span style=display:flex><span>helm install stable/kubernetes-dashboard <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>-n kubernetes-dashboard <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>--namespace kube-system <span style=color:#c41a16>\
</span></span></span><span style=display:flex><span><span style=color:#c41a16></span>-f kubernetes-dashboard.yaml
</span></span></code></pre></td></tr></table></div></div></div><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n kube-system get secret | grep kubernetes-dashboard-token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl describe secret kubernetes-dashboard-token-xx -n kube-system
</span></span><span style=display:flex><span><span style=color:#177500># 得到token，即令牌</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=metrics-server>metrics-server</h3><h4 id=hpa演示>HPA演示</h4><h4 id=资源限制>资源限制</h4><p>pod</p><p>命名空间</p><h3 id=prometheus>Prometheus</h3><h3 id=efk>EFK</h3><h1 id=运维>运维</h1><h2 id=kubeadm源码修改>Kubeadm源码修改</h2><h2 id=kubernetes高可用构建>Kubernetes高可用构建</h2><h1 id=reference>Reference</h1><p><a href=https://mp.weixin.qq.com/s/6Pu7k-3taQhtZ18JkjbU0A>k8s主要概念大梳理</a></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>