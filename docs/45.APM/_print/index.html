<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=canonical type=text/html href=/docs/45.APM/><link rel=alternate type=application/rss+xml href=/docs/45.APM/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>APM | Herbdocs</title><meta name=description content="Introduction
APM
"><meta property="og:title" content="APM"><meta property="og:description" content="Herb's blog"><meta property="og:type" content="website"><meta property="og:url" content="/docs/45.APM/"><meta property="og:site_name" content="Herbdocs"><meta itemprop=name content="APM"><meta itemprop=description content="Herb's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="APM"><meta name=twitter:description content="Herb's blog"><link rel=preload href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css as=style><link href=/scss/main.min.dcab2c3dae6e6fefb7672f19e4b612cc4e75ca208740f642aa2f1fe378478a8f.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img width=6% style=margin-bottom:1% src=/favicons/favicon.ico></span><span class=font-weight-bold>&nbsp;Herbdocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/45.APM/>返回本页常规视图</a>.</p></div><h1 class=title>APM</h1><ul><li>1: <a href=#pg-304523d189c2769f702bb43ce8bc0faa>Skywalking基础使用</a></li><li>2: <a href=#pg-a1a28a29c586795fdcd490189bf31b61>Skywalking源码分析2-启动流程</a></li><li>3: <a href=#pg-952788f74d6d2060db99836bc84177d2>字节码增强技术-概念</a></li></ul><div class=content><h1 id=introduction>Introduction</h1><p>APM</p></div></div><div class=td-content><h1 id=pg-304523d189c2769f702bb43ce8bc0faa>1 - Skywalking基础使用</h1><h1 id=skywalking概述>Skywalking概述</h1><h2 id=什么是skywalking>什么是Skywalking</h2><h3 id=概述>概述</h3><p>Skywalking主要概念包括：</p><ul><li>服务（Service）</li><li>端点（EndPoint）</li><li>实例（Instance）</li></ul><p><img src=../imgs/skywalking_tutorial_211223_1.png alt=skywalking_tutorial_211223_1.png></p><p>端点就是服务暴露的端口如/usr/queryAll</p><h1 id=安装>安装</h1><h2 id=安装es>安装ES</h2><p>替换默认的h2存储，因为h2存储在内存中。</p><p>1、下载并解压ES安装包</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>tar -zxvf elasticsearch-6.x.x.tar.gz
</span></span></code></pre></td></tr></table></div></div></div><p>2、修改Linux系统的限制配置，将文件创建数修改为65536个。
1）修改系统中允许应用最多创建多少文件等的限制权限。Linux默认一般限制创建的文件数为65535个。但是ES至少需要65536的文件创建数的权限。</p><p>2）修改系统中允许用户启动的进程开启多少个线程。Linux默认root用户可以开启任意数量的线程，其他用户的进程可以开启1024个线程。必须修改限制数为4096+。因为ES至少需要4096个线程池预备。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>vi /etc/security/limits.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 在 limits.conf 文件中追加以下内容，保存完自动生效</span>
</span></span><span style=display:flex><span>es soft nofile <span style=color:#1c01ce>65536</span>
</span></span><span style=display:flex><span>es hard nofile <span style=color:#1c01ce>65536</span>
</span></span><span style=display:flex><span>es soft nproc <span style=color:#1c01ce>4096</span>
</span></span><span style=display:flex><span>es hard nproc <span style=color:#1c01ce>4096</span>
</span></span></code></pre></td></tr></table></div></div></div><p>3、修改系统控制权限，ES需要开辟一个65536字节以上空间的虚拟缓存。Linux不允许任何用户和应用程序直接开辟这么的虚拟内存。<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>vi /etc/sysctl.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 在 sysctl.conf 文件中追加如下内容尾部，当前用户拥有的内存权限大小</span>
</span></span><span style=display:flex><span>vm.max_map_count<span style=color:#000>=</span><span style=color:#1c01ce>262144</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 退出文件编辑，并执行以下命令，让系统控制权限配置生效</span>
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></td></tr></table></div></div></div></p><p>4、创建一个用户，用于ES启动
因为ES在5.x版本后，强制在Linux中不能使用root用户启动ES进程。</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 创建用户</span>
</span></span><span style=display:flex><span>useradd es
</span></span><span style=display:flex><span><span style=color:#177500># 修改上述用户的密码</span>
</span></span><span style=display:flex><span>passwd es
</span></span><span style=display:flex><span><span style=color:#177500># 修改目录拥有者</span>
</span></span><span style=display:flex><span>chown -R es elasticsearch-6.x.x
</span></span></code></pre></td></tr></table></div></div></div><p>5、启动ES<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 切换用户</span>
</span></span><span style=display:flex><span>su es
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> bin
</span></span><span style=display:flex><span><span style=color:#177500># 后台启动ES</span>
</span></span><span style=display:flex><span>./elasticsearch -d
</span></span></code></pre></td></tr></table></div></div></div></p><p>6、测试启动
ES默认不支持跨域访问，在不修改配置的情况下只能在本机上访问测试是否成功</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://localhost:9200
</span></span></code></pre></td></tr></table></div></div></div><h2 id=安装skywalking>安装Skywalking</h2><p>两个步骤：</p><p>1、安装后端服务</p><p>2、安装UI</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 首先切回root用户</span>
</span></span><span style=display:flex><span>su root
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> /usr/local/skywalking
</span></span><span style=display:flex><span>tar -zxvf apache-skywalking-apm-6.4.0.tar.gz
</span></span></code></pre></td></tr></table></div></div></div><p>修改Skywalking存储的数据源配置<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> apache-skywalking-apm-bin
</span></span><span style=display:flex><span>vi config/application.xml
</span></span><span style=display:flex><span><span style=color:#177500># 注释掉h2存储配置</span>
</span></span><span style=display:flex><span><span style=color:#177500># 把ES的注释打开</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>webapp配置<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>vi webapp/webapp.xml
</span></span><span style=display:flex><span><span style=color:#177500># 修改端口8080，防止冲突</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>启动程序<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>oapService.sh  <span style=color:#177500># 启动backend后端服务</span>
</span></span><span style=display:flex><span>webappService.sh  <span style=color:#177500># 启动UI服务</span>
</span></span><span style=display:flex><span>./startup.sh   <span style=color:#177500># 启动两个部分</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>日志<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>tail -f logs/webapp.log
</span></span></code></pre></td></tr></table></div></div></div></p><p>浏览器访问skywalking网页页面</p><h1 id=基础>基础</h1><h2 id=agent使用>agent使用</h2><p>agent探针在java中使用java agent技术实现的，不需要更改任何代码，java agent会通过虚拟机接口来在运行期更改代码</p><p>Agent探针支持JDK1.6-12的版本，Agent探针所有的文件在Skywalking的agent文件夹下。文件目录如下：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>agent
</span></span><span style=display:flex><span>  activations
</span></span><span style=display:flex><span>  // 配置文件
</span></span><span style=display:flex><span>  config
</span></span><span style=display:flex><span>  // 组件的所有插件
</span></span><span style=display:flex><span>  plugins
</span></span><span style=display:flex><span>  // 可选插件
</span></span><span style=display:flex><span>  optional-plugins
</span></span><span style=display:flex><span>  
</span></span></code></pre></td></tr></table></div></div></div><blockquote><p>部分插件在使用上会影响整体的性能或者由于版权问题放置于可选插件包中，不会直接加载，如果需要使用，将可选插件中的jar包拷贝到plugins包下</p></blockquote><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> apache-skywalking-apm-bin
</span></span><span style=display:flex><span>vi agent/config/agent.config
</span></span></code></pre></td></tr></table></div></div></div><p>修改agent.service_name<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>agent.service_name<span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>SW_AGENT_NAME</span>:<span style=color:#000>Your_ApplicationName</span><span style=color:#c41a16>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>配置含义是可以读到SW_AGENT_NAME配置属性，如果该配置没有指定，那么默认名称为Your_xx，这里替换成skywalking_tomcat
然后将tomcat重启</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>./shutdown.sh
</span></span><span style=display:flex><span>./startup.sh
</span></span></code></pre></td></tr></table></div></div></div><h3 id=linux下tomcat7和8中使用>Linux下tomcat7和8中使用</h3><p>1、要使用Skywalking监控Tomcat中的应用，需要先准备一个Spring mvc项目，这里准备好一个打包好的文件：skywalking_springmvc-1.0-SNAPSHOT.war</p><p>内容为一个简单的hello world controller接口.</p><p>2、将war包上传至 xx/apache-tomcat-xx/webapps/下。编辑xx/apache-tomcat-xx/bin/catalina.sh文件，在文件顶部添加：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>CATALINA_OPTS</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;</span><span style=color:#000>$CATALINA_OPTS</span><span style=color:#c41a16> -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin/agent/skywalking-agent.jar&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>export</span> CATALINA_OPTS
</span></span></code></pre></td></tr></table></div></div></div><p>修改tomcat启动端口<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>vi conf/server.xml
</span></span><span style=display:flex><span><span style=color:#177500># port = 8081，防止冲突</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>启动项目，访问接口，然后访问skywalking UI页面，即可查询各项指标</p><h3 id=windows下tomcat7和8中使用>Windows下tomcat7和8中使用</h3><p>windows下只需要修改 tomcat目录下 bin/catalina.bat文件的第一行为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>set</span> <span style=color:#000>CATALINA_OPTS</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;=-javaagent:/path/to/skywalking-agent/skywalking-agent.jar&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=spring-boot中使用>Spring Boot中使用</h3><p>Skywalking与spring boot集成提供了完善的支持</p><p>1、首先复制一份agent，防止与tomcat使用时冲突</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> /usr/local/skywalking/apapche-skywalking-apm-bin/
</span></span><span style=display:flex><span>cp -r agent agent_boot
</span></span><span style=display:flex><span>vi agent_boot/config/agent.config
</span></span></code></pre></td></tr></table></div></div></div><p>修改配置的应用名为 skywalking_boot（同上，略）
2、同上准备web应用 skywalking_springboot.jar，提供一个正常和异常controller接口</p><p>将文件上传至 xx 目录下。</p><p>3、使用命令启动spring boot项目</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin/agent_boot/skywalking-agent.jar
</span></span><span style=display:flex><span>-Dserver.port<span style=color:#000>=</span><span style=color:#1c01ce>8082</span> -jar skywalking_boot.jar &amp;
</span></span><span style=display:flex><span><span style=color:#177500># 指定端口号防止冲突</span>
</span></span><span style=display:flex><span><span style=color:#177500># 末尾 &amp; 表示后台启动</span>
</span></span></code></pre></td></tr></table></div></div></div><p>访问接口，然后访问skywalking UI页面，即可查询各项指标</p><h2 id=rocketbot的使用>RocketBot的使用</h2><p>Skywalking的监控UI页面称为RocketBot，可以通过修改webapp/webapp.yml来更改端口：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#000>port</span>: <span style=color:#1c01ce>8080</span>  
</span></span></code></pre></td></tr></table></div></div></div><h1 id=skywalking高级>Skywalking高级</h1><h2 id=rpc调用监控>Rpc调用监控</h2><h2 id=mysql调用监控>MySQL调用监控</h2><p>启动docker</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker -v <span style=color:#177500># ce版本，可以使用systemctl</span>
</span></span><span style=display:flex><span>systemctl start docker
</span></span></code></pre></td></tr></table></div></div></div><p>使用docker启动MySQL<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker images
</span></span><span style=display:flex><span>docker run -id --name<span style=color:#000>=</span>skywalking_mysql -p 33306:3306 -e
</span></span><span style=display:flex><span><span style=color:#000>MYSQL_ROOT_PASSWORD</span><span style=color:#000>=</span><span style=color:#1c01ce>123456</span> centos/mysql-57-centos57
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=skywalking常用插件>Skywalking常用插件</h2><h3 id=配置覆盖>配置覆盖</h3><h4 id=系统配置>系统配置</h4><p>使用skywalking. +配置文件中的配置名作为系统配置项来进行覆盖</p><p>1、为什么添加前缀</p><p>agent的系统配置和环境与目标应用共享，所以加上前缀可以有效的避免冲突</p><p>2、案例</p><p>通过如下进行agent.service_name的覆盖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000>-Dskywalking.agent.service_name=skywalking_mysql</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=探针配置>探针配置</h4><p>Add the properties after the agent path in JVM arguments</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-javaagent:/path/to/skywalking-agent.jar<span style=color:#000>=[</span>option1<span style=color:#000>]=[</span>value1<span style=color:#000>]</span>,<span style=color:#000>[</span>option2<span style=color:#000>]=[</span>value2<span style=color:#000>]</span>
</span></span></code></pre></td></tr></table></div></div></div><p>1、案例
通过如下进行agent.service_name覆盖</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-javaagent:/path/to/skywalking-agent.jar<span style=color:#000>=</span>agent.service_name<span style=color:#000>=</span>skywalking_mysql
</span></span></code></pre></td></tr></table></div></div></div><p>2、特殊字符
如果配置中包含分隔符（，或者=），就必须使用引号包裹起来</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>-javaagent:/path/to/skywalking-agent.jar<span style=color:#000>=</span>agent.ignore_suffix<span style=color:#000>=</span><span style=color:#c41a16>&#39;.jpg,.jpeg&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=系统环境变量>系统环境变量</h4><p>1、案例</p><p>由于agent.service_name配置项如下所示：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>agent.service_name<span style=color:#000>=</span><span style=color:#c41a16>${</span><span style=color:#000>SW_AGENT_NAME</span>:<span style=color:#000>Your_ApplicationName</span><span style=color:#c41a16>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>可以在环境变量中设置SW_AGENT_NAME的值来制定服务名</p><h3 id=覆盖优先级>覆盖优先级</h3><p>探针配置 > 系统配置 > 系统环境变量配置 > 配置文件中的值</p><p>所以我们的启动命令可以修改为：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -javaagent:/usr/local/skywaling/apache-skywalking-apm-bin/agent_mysql/skywalking-agent.jar
</span></span><span style=display:flex><span>-Dskywalking.agent.service_name<span style=color:#000>=</span>skywalking_mysql -jar skywalking_mysql.jar &amp;
</span></span></code></pre></td></tr></table></div></div></div><p>或<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -javaagent:/usr/local/skywaling/apache-skywalking-apm-bin/agent_mysql/skywalking-agent.jar
</span></span><span style=display:flex><span><span style=color:#000>=</span>agent.service_name<span style=color:#000>=</span>skywalking_mysql -jar skywalking_mysql.jar &amp;
</span></span></code></pre></td></tr></table></div></div></div></p><h3 id=过滤指定端点>过滤指定端点</h3><p>1、将skywalking_plugins.jar上传至/usr/local/wkywalking目录下</p><p>2、将agent中的/agent/optional-plugins/apm-trace-ignore-plugin-6.4.0.jar插件拷贝到plugins目录中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> /usr/local/skywalking/apache-skywalking-apm-bin
</span></span><span style=display:flex><span>cp optional-plugins/apm-trace-ignore-plugin-6.4.0.jar plugins/apm-trace-ignore-plugin-6.4.0.jar
</span></span></code></pre></td></tr></table></div></div></div><p>3、启动skywalk_plugins应用<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>java -javaagent:/usr/local/skwalking/apache-skywalking-apm-bin/agent/skywalking-agent.jar
</span></span><span style=display:flex><span>-Dskywalking.agent.service_name<span style=color:#000>=</span>skywalking_plugins -Dskywalking.trace.ignore_path<span style=color:#000>=</span>/exclude -jar skywalking_plugins.jar &amp;
</span></span></code></pre></td></tr></table></div></div></div></p><blockquote><p>这里添加-Dskywalking.trace.ignore_path=/exclude参数来标识需要过滤哪些请求，支持Ant Path表达式：
/path/*, /path/**, /path/?</p><ul><li>?匹配任何单字符</li><li>*匹配0或者任意数量的字符</li></ul></blockquote><h2 id=告警功能>告警功能</h2><h3 id=告警功能简介>告警功能简介</h3><p>Skywalking每隔一段时间根据收集到的链路追踪的数据和配置的告警规则（如服务响应时间、服务响应时间百分比等），判断如果达到阈值则发送响应的告警信息。发送告警信息是通过调用webhook接口完成，具体的webhook接口可以使用者自行定义，从而开发者可以在指定的webhook接口编写各种告警方式，比如邮件、短信等。告警的信息也可以在RocketBot中查看。</p><p>以下是默认的告警规则配置，位于skywalking安装目录下的config文件夹下alarm-settings.yml文件中：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>rules</span>: 
</span></span><span style=display:flex><span>  <span style=color:#177500># Rule unique name, must be ended with `_rule`.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>service_resp_time_rule</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>metrics-name</span>: <span style=color:#1c01ce>service_resp_time</span>
</span></span><span style=display:flex><span>    <span style=color:#000>op</span>: <span style=color:#c41a16>&#34;&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>threshold</span>: <span style=color:#1c01ce>1000</span>
</span></span><span style=display:flex><span>    <span style=color:#000>period</span>: <span style=color:#1c01ce>10</span>
</span></span><span style=display:flex><span>    <span style=color:#000>count</span>: <span style=color:#1c01ce>3</span>
</span></span><span style=display:flex><span>    <span style=color:#000>silence-perild</span>: <span style=color:#1c01ce>5</span>
</span></span><span style=display:flex><span>    <span style=color:#000>message</span>: <span style=color:#1c01ce>Response time of serice {name} is more thran 1000ms in 3 minutes of last 10 minutes.</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#000>webhooks</span>: 
</span></span><span style=display:flex><span>  - <span style=color:#1c01ce>http:127.0.0.1/notify/  </span>
</span></span></code></pre></td></tr></table></div></div></div><blockquote><p>满足规则的告警信息将调用通过webhooks配置的接口</p></blockquote><h1 id=skywalking原理>Skywalking原理</h1><h2 id=java-agent原理>Java agent原理</h2><p><strong>Javaagent是什么？</strong></p><p>Java agent是java命令的一个参数。参数javaagent可以用于指定一个jar包。</p><p>1、这个jar包的MANIFEST.MF文件必须指定Premain-Class项。</p><p>2、Premain-Class指定的那个类必须实现premain()方法</p><p>当java虚拟机启动时，在执行main函数之前，JVM会先运行-javaagent所指定jar包内Premain-Class这个类的premain方法。</p><p><strong>如何使用java agent？</strong></p><p>步骤：</p><ol><li>定义一个MANIFEST.MF文件，必须包含Premain-Class选项，通常也会加入Can-Redefine-Classes和Can-Retransform-Class选项</li><li>创建一个Premain-Class指定的类，类中包含premain方法，方法逻辑由用户自己指定</li><li>将premain的类和MANIFEST.MF文件打成jar包</li><li>使用参数-javaagent:jar包路径 启动要代理的方法</li></ol><h3 id=搭建java-agent工程>搭建java agent工程</h3><p>PreMainAgent.java</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>PreMainAgent</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>premain</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>agentparam</span><span style=color:#000>,</span> <span style=color:#000>Instrumenttation</span> <span style=color:#000>inst</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;premain start&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>agentparam</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>premain</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>agentparam</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;premain start2&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>agentparam</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><blockquote><p>优先调用两个参数的方法</p></blockquote><p>MANIFEST.MF</p><p>在maven中添加插件 maven-assembly-plugin</p><style>.highlight{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:130%}.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}</style><details class=code-collapse><summary>Expand/Collapse Code Block</summary><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;build&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;artifactId&gt;</span>maven-assembly-plugin<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;appendAssemblyId&gt;</span>false<span style=color:#000>&lt;/appendAssemblyId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;descriptorRefs&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;descriptorRef&gt;</span>jar-with-dependecies<span style=color:#000>&lt;/descriptorRefs&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/descriptorRefs&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;archive&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#177500>&lt;!-- 自动添加META-INF/MANIFEST.MF --&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;manifest&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;addClassPath&gt;</span>true<span style=color:#000>&lt;/addClassPath&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;/manifest&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;mainfestEntries&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;Premain-Class&gt;</span>PreMainAgent<span style=color:#000>&lt;/Premain-Class&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;Agent-Class&gt;</span>PreMainAgent<span style=color:#000>&lt;/Agent-Class&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;Can-Redefine-Classes&gt;</span>true<span style=color:#000>&lt;/Can-Redefine-Classes&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;Can-Retransform-Classes&gt;</span>true<span style=color:#000>&lt;/Can-Retransform-Classes&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;/mainfestEntries&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/archive&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;id&gt;</span>make-assembly<span style=color:#000>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;phase&gt;</span>package<span style=color:#000>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>&lt;goal&gt;</span>single<span style=color:#000>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/build&gt;</span>    
</span></span></code></pre></td></tr></table></div></div></details><br><h3 id=统计方法调用时间>统计方法调用时间</h3><p>Skywalking中对每个调用的市场都进行了统计。这一小节中我们会使用<strong>ByteBuddy和Java agent技术</strong>来统计方法的调用时长</p><p>Byte Buddy是开源的、基于Apache 2.0许可证的库，它致力于解决字节码操作和Instrumentation API的复杂性。Byte Buddy所声称的目标是将显式的字节码操作隐藏在一个类型安全的领域特定语言背后。通过使用Byte Buddy，任何熟悉Java编程语言的人都有望非常容易地进行字节码操作。Byte Buddy提供了额外的API来声称Java agent，可以轻松的增强我们已有的代码。</p><p>添加依赖：</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>net.bytebuddy<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>byte-buddy<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>1.9.2<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;groupId&gt;</span>net.bytebuddy<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;artifactId&gt;</span>byte-buddy-agent<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;version&gt;</span>1.9.2<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>PreMainAgent.java<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>PreMainAgent</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>premain</span><span style=color:#000>(</span><span style=color:#000>String</span> <span style=color:#000>agentparam</span><span style=color:#000>,</span> <span style=color:#000>Instrumentation</span> <span style=color:#000>inst</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>AgentBuilder</span><span style=color:#000>.</span><span style=color:#836c28>Transformer</span> <span style=color:#000>transformer</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>AgentBuilder</span><span style=color:#000>.</span><span style=color:#836c28>Transformer</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>public</span> <span style=color:#000>DynamicType</span><span style=color:#000>.</span><span style=color:#836c28>Builder</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>transform</span><span style=color:#000>(</span><span style=color:#000>DynamicType</span><span style=color:#000>.</span><span style=color:#836c28>Builder</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>builder</span><span style=color:#000>,</span> <span style=color:#000>TypeDescription</span> <span style=color:#000>typeDescription</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// mothod指定哪些方法需要被拦截，ElementMatchers.any指定了所有方法
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#177500>// 声明intercept拦截器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>return</span> <span style=color:#000>builder</span><span style=color:#000>.</span><span style=color:#836c28>method</span><span style=color:#000>(</span><span style=color:#000>ElementMathcers</span><span style=color:#000>.&lt;</span><span style=color:#000>MethodDescription</span><span style=color:#000>&gt;</span><span style=color:#000>any</span><span style=color:#000>())</span>
</span></span><span style=display:flex><span>             <span style=color:#000>.</span><span style=color:#836c28>intercept</span><span style=color:#000>(</span><span style=color:#000>MthodDelegation</span><span style=color:#000>.</span><span style=color:#836c28>to</span><span style=color:#000>(</span><span style=color:#000>MyInterceptor</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>));</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>};</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>new</span> <span style=color:#000>AgentBuilder</span><span style=color:#000>.</span><span style=color:#836c28>Default</span><span style=color:#000>().</span><span style=color:#836c28>type</span><span style=color:#000>(</span><span style=color:#000>ElementMathcers</span><span style=color:#000>.&lt;</span><span style=color:#000>TypeDescripttion</span><span style=color:#000>&gt;</span><span style=color:#000>nameStartsWith</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;com.agent&#34;</span><span style=color:#000>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000>.</span><span style=color:#836c28>transform</span><span style=color:#000>(</span><span style=color:#000>transformer</span><span style=color:#000>).</span><span style=color:#836c28>installOn</span><span style=color:#000>(</span><span style=color:#000>inst</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><p>MyInterceptor.java<style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyInterceptor</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>@RuntimeType</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#000>(</span><span style=color:#000>@Origin</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#000>,</span> <span style=color:#000>@SuperCall</span> <span style=color:#000>Callable</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>callable</span><span style=color:#000>)</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Long</span> <span style=color:#000>start</span> <span style=color:#000>=</span> <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>currentTimeMillis</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> <span style=color:#000>callable</span><span style=color:#000>.</span><span style=color:#836c28>call</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span> <span style=color:#a90d91>finally</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>method</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>()</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;:&#34;</span> <span style=color:#000>+</span> <span style=color:#000>(</span><span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>currentTimeMillis</span><span style=color:#000>()-</span><span style=color:#000>start</span><span style=color:#000>)</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;ms&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div></p><h2 id=open-tracing介绍>Open Tracing介绍</h2><p>Open Tracing通过提供平台无关、厂商无关API，使得开发人员能够方便的添加/更换追踪系统的实现。OpenTracing 最核心的概念就是 Trace</p><h3 id=trace的概念>Trace的概念</h3><p>广义上，一个trace代表了一个事务或者流程在（分布式）系统中的执行过程。在OpenTracing标准中，trace是多个span组成的一个有向无环图（DAG），每一个span代表trace中被明明并计时的连续性的执行片段。</p><p><img src=../imgs/skywalking_tutorial_211223_2.png alt=skywalking_tutorial_211223_2.png></p><p>例如客户端发起的一次请求，就可以认为是一个trace。将上面的图通过Open Tracing的语义修改完之后做可视化，得到下面的图：</p><p><img src=../imgs/skywalking_tutorial_211223_3.png alt=skywalking_tutorial_211223_3.png></p><p>图中每一个色块其实就是一个span.</p><h3 id=span的概念>Span的概念</h3><p>每一个Span代表系统中具有开始时间和执行市场的逻辑运行单元。span之间通过嵌套或者顺序排列简历逻辑因果关系。</p><p>Span里面的信息包括：操作的名字，开始时间和结束时间，可以附带多个key:value构成的Tags（key必须是String，value可以是String/bool/数字），还可以附带Logs信息（不一定所有的实现都支持）也是key:value形式。</p><p>一个Span可以和一个或多个Span间存在因果关系。OpenTracing定义了两种关系：childOf和FollowsFrom。这两种引用类型代表了子节点和父节点间的直接因果关系。未来，OpenTracing将支持非因果关系的span引用关系。（例如：多个span被批量处理，span在同一个队列等）</p><h3 id=log的概念>Log的概念</h3><p>每个span可以进行多次Logs操作，每一次Logs操作，都需要一个带时间戳的时间名称，以及可选的任意大小的存储结构。</p><h3 id=tags的概念>Tags的概念</h3><p>每个span可以有多个键值对（key:value）形式的Tags，Tags是没有时间戳的，支持简单的对span进行注解和补充。</p><p><img src=../imgs/skywalking_tutorial_211223_4.png alt=skywalking_tutorial_211223_4.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-a1a28a29c586795fdcd490189bf31b61>2 - Skywalking源码分析2-启动流程</h1><h1 id=概述>概述</h1><p><img src=../imgs/skywalking-source-code-211211_1.png alt=skywalking-source-code-211211_1.png></p><h1 id=初始化配置>初始化配置</h1><h2 id=加载配置信息>加载配置信息</h2><ul><li>/config/agent.config</li><li>系统环境变量</li><li>Agent参数</li><li>优先级：自下而上</li></ul><h2 id=将配置信息映射到config类>将配置信息映射到Config类</h2><h2 id=根据配置信息重新指定日志解析器>根据配置信息重新指定日志解析器</h2><h2 id=检查agent名称和后端地址是否配置>检查agent名称和后端地址是否配置</h2><h2 id=标记配置加载完成>标记配置加载完成</h2><h1 id=加载插件>加载插件</h1><h2 id=m-插件配置读取>M: 插件配置读取</h2><blockquote><p>可以借鉴读取配置</p></blockquote><p>按行加载键值对，并剔除指定不需要的插件</p><ul><li>SkyWalkingAgent.java<ul><li>PluginFinder.java<ul><li>PluginBootstrap.java<ul><li>PluginCfg.java</li></ul></li></ul></li></ul></li></ul><h2 id=插件定义体系>插件定义体系</h2><h3 id=插件定义-xxxinstrumentation>插件定义: XxxInstrumentation</h3><ul><li>拦截实例方法/构造器：ClassInstanceMethodsEnhancePluginDefine</li><li>拦截静态方法：ClassStaticMethodsEnhancePluginDefine</li><li>AbstractClassEnhancePluginDefine 插件顶级父类</li><li>要拦截的类：enhanceClass()</li><li>要拦截的方法：getXxxInterceptorPoints()</li></ul><h3 id=目标类匹配>目标类匹配</h3><ul><li>ClassMatch<ul><li>按类名匹配：NameMatch</li><li>间接匹配：IndirectMatch<ul><li>PrefixMatch</li><li>MethodAnnotationMatch</li></ul></li></ul></li></ul><h3 id=拦截器定义>拦截器定义</h3><ul><li>beforeMethod</li><li>afterMethod</li><li>handleMethodException</li></ul><h3 id=插件声明>插件声明</h3><ul><li>resouces/skywalking-plugin.def</li><li>插件名称-插件定义</li></ul><h2 id=加载流程>加载流程</h2><h3 id=pluginbootstrap实例化所有插件>PluginBootstrap实例化所有插件</h3><h3 id=pluginfinder分类插件>PluginFinder分类插件</h3><ul><li>命名插件 - NameMatch</li><li>间接匹配插件 - IndirectMatch</li><li>JDK 类库插件</li></ul><h1 id=定制agent>定制Agent</h1><h2 id=创建bytebuddy实例>创建ByteBuddy实例</h2><h2 id=指定bytebuddy要忽略的类>指定ByteBuddy要忽略的类</h2><h2 id=将必要的类注入到bootstrapclassloader中>将必要的类注入到BootstrapClassLoader中</h2><p>为什么注入classes到bootstrap加载器中</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ClassInjector</span><span style=color:#000>.</span><span style=color:#836c28>UsingUnsafe</span><span style=color:#000>.</span><span style=color:#836c28>Factory</span> <span style=color:#000>factory</span> <span style=color:#000>=</span> <span style=color:#000>ClassInjector</span><span style=color:#000>.</span><span style=color:#836c28>UsingUnsafe</span><span style=color:#000>.</span><span style=color:#836c28>Factory</span><span style=color:#000>.</span><span style=color:#836c28>resolve</span><span style=color:#000>(</span><span style=color:#000>instrumentation</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>factory</span><span style=color:#000>.</span><span style=color:#836c28>make</span><span style=color:#000>(</span><span style=color:#a90d91>null</span><span style=color:#000>,</span> <span style=color:#a90d91>null</span><span style=color:#000>).</span><span style=color:#836c28>injectRaw</span><span style=color:#000>(</span><span style=color:#000>classesTypeMap</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span><span style=color:#000>agentBuilder</span> <span style=color:#000>=</span> <span style=color:#000>agentBuilder</span><span style=color:#000>.</span><span style=color:#836c28>with</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>AgentBuilder</span><span style=color:#000>.</span><span style=color:#836c28>InjectionStrategy</span><span style=color:#000>.</span><span style=color:#836c28>UsingUnsafe</span><span style=color:#000>.</span><span style=color:#836c28>OfFactory</span><span style=color:#000>(</span><span style=color:#000>factory</span><span style=color:#000>));</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=../imgs/skywalking-source-code-211211_2.png alt=skywalking-source-code-211211_2.png></p><h2 id=解决jdk模块系统的跨模块类访问>解决JDK模块系统的跨模块类访问</h2><h2 id=根据配置决定是否将修改后的字节码保存到磁盘-内存中>根据配置决定是否将修改后的字节码保存到磁盘/内存中</h2><h2 id=细节定制>细节定制</h2><h3 id=指定-bytebuddy要拦截的类>指定 ByteBuddy要拦截的类</h3><h3 id=指定做字节码增强的工具>指定做字节码增强的工具</h3><h3 id=指定做字节码增强的模式>指定做字节码增强的模式</h3><p>redefine和restransform的区别在于是否保留修改前的内容</p><ul><li>redefine 覆盖</li><li>restransform 保留</li></ul><h3 id=注册监听器>注册监听器</h3><h3 id=将agent安装到instrumentation>将Agent安装到Instrumentation</h3><h2 id=什么是-synthetic>什么是<strong>Synthetic</strong></h2><p><strong>Synthetic关键字：</strong></p><p><strong>合成的，Java编译器在编译阶段自动生成的[构造]</strong></p><p><strong>JLS：所有存在于字节码文件中，但是不存在于源代码文件的[构造]，都应该被synthetic关键字标注</strong></p><p><strong>[构造] => Constructs => Field/Method/Constructor</strong></p><p>内部类的私有属性、私有构造方法，都能被外部类直接访问不报错，就是因为编译期新生成了方法或者属性，这就是synthetic</p><p>getModifiers()的值为4096的话，就代表这个是synthetic</p><p>用js简单说明：java编译器帮我们自动做了var that = this操作</p><p>讲解环境：JDK11之前的版本</p><h2 id=nbac-nested-based-access-control>NBAC(Nested Based Access Control)</h2><p>编译环境JDK1.8</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#000>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;maven.compiler.source&gt;</span>11<span style=color:#000>&lt;/maven.compiler.source&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;maven.compiler.target&gt;</span>11<span style=color:#000>&lt;/maven.compiler.target&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/properties&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;build&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;groupId&gt;</span>org.apache.maven.plugins<span style=color:#000>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;artifactId&gt;</span>maven-compiler-plugin<span style=color:#000>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;version&gt;</span>3.8.1<span style=color:#000>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;source&gt;</span>1.8<span style=color:#000>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>&lt;target&gt;</span>1.8<span style=color:#000>&lt;/target&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>&lt;/build&gt;</span>    
</span></span></code></pre></td></tr></table></div></div></div><p>内部类里面存在同一个方法的不同调用方法呈现不同结果的情况</p><ul><li>直接调用 - 可以</li><li>反射调用 - 不可以</li></ul><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Outer</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>fun</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>outPrivate</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Inner</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>innerPublic</span><span style=color:#000>()</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>outerPrivate</span><span style=color:#000>();</span> <span style=color:#177500>//可以
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>reflectOuter</span><span style=color:#000>(</span><span style=color:#000>Outer</span> <span style=color:#000>outer</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#000>=</span> <span style=color:#000>outer</span><span style=color:#000>.</span><span style=color:#836c28>getClass</span><span style=color:#000>().</span><span style=color:#836c28>getDeclaredMethod</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;outerPrivate&#34;</span><span style=color:#000>);</span> <span style=color:#177500>//报错
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>method</span><span style=color:#000>.</span><span style=color:#836c28>invoke</span><span style=color:#000>(</span><span style=color:#000>outer</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>NBAC消除了这个问题，将pom插件配置改成JDK11（1.8改成1.11）就没有这个问题
原理：</p><p>阅读JDK11的Class.java源码，观察getNestHost等方法</p><p>Inner => nestHost = Outer.class</p><p>Outer => nestMembers = {Inner.class}</p><p>nestMembers => nestMates</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// 嵌套宿主一致，都是Outer
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Inner 的嵌套宿主：&#34;</span> <span style=color:#000>+</span> <span style=color:#000>Outer</span><span style=color:#000>.</span><span style=color:#836c28>Inner</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>getNestHost</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Outer 的嵌套宿主：&#34;</span> <span style=color:#000>+</span> <span style=color:#000>Outer</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>getNestHost</span><span style=color:#000>().</span><span style=color:#836c28>getName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// 嵌套成员一致，都是Outer和Outer$Inner
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Outer 的嵌套成员：&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>nestMember</span> <span style=color:#000>:</span> <span style=color:#000>Outer</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>getNestMembers</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>nestMember</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Inner 的嵌套成员：&#34;</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>nestMember</span> <span style=color:#000>:</span> <span style=color:#000>Outer</span><span style=color:#000>.</span><span style=color:#836c28>Inner</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>getNestMembers</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#000>nestMember</span><span style=color:#000>.</span><span style=color:#836c28>getName</span><span style=color:#000>());</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>out</span><span style=color:#000>.</span><span style=color:#836c28>println</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Inner 和 Outer 是 NestMate 吗？&#34;</span> <span style=color:#000>+</span> 
</span></span><span style=display:flex><span>  <span style=color:#000>Outer</span><span style=color:#000>.</span><span style=color:#836c28>Inner</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>.</span><span style=color:#836c28>isNestmateOf</span><span style=color:#000>(</span><span style=color:#000>Outer</span><span style=color:#000>.</span><span style=color:#836c28>class</span><span style=color:#000>));</span> <span style=color:#177500>// true
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=加载服务>加载服务</h1><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ServiceManager</span><span style=color:#000>.</span><span style=color:#836c28>INSTANCE</span><span style=color:#000>.</span><span style=color:#836c28>boot</span><span style=color:#000>();</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=服务组织>服务组织</h2><ul><li>服务需要实现 BootService 接口</li><li>如果服务只有一种实现，直接创建一个类即可</li><li>如果服务有多种实现<ul><li>默认实现需要使用 @DefaultImplementor</li><li>覆盖实现需要使用 @OverrideImplementor</li></ul></li></ul><h2 id=加载流程-1>加载流程</h2><ul><li>SPI加载所有 BootService 的实现</li><li>根据服务的实现模式进行服务的筛选<ul><li>两个注解都没有的服务实现直接加入集合</li><li>对于 @DefaultImplementor 直接加入集合</li><li>对于 @OverrideImplementor<ul><li>value指向的服务有 @DefaultImplementor 则覆盖掉</li><li>value指向的服务没有 @OverrideImplementor 则报错</li></ul></li></ul></li></ul><h1 id=插件工作原理>插件工作原理</h1><h2 id=组件版本识别技术-witness机制>组件版本识别技术（Witness机制）</h2><ul><li>witnessClasses</li><li>witnessMethods</li></ul><p><img src=../imgs/skywalking-source-code-211211_3.png alt=skywalking-source-code-211211_3.png></p><p>可观察 AbstractClassEnhancePluginDefine.java的 witnessClasses()或witnessMethods方法的实现</p><p>举例：查看spring官方文档，对比新增class</p><blockquote><p>参考spring 3.2.9: <a href=https://docs.spring.io/spring-framework/docs/3.2.9.RELEASE/javadoc-api/>https://docs.spring.io/spring-framework/docs/3.2.9.RELEASE/javadoc-api/</a>
参考spring 4: <a href=https://docs.spring.io/spring-framework/docs/4.3.30.RELEASE/javadoc-api/>https://docs.spring.io/spring-framework/docs/4.3.30.RELEASE/javadoc-api/</a>
参考spring 5: <a href=https://docs.spring.io/spring-framework/docs/5.2.16.RELEASE/javadoc-api/>https://docs.spring.io/spring-framework/docs/5.2.16.RELEASE/javadoc-api/</a></p></blockquote><h2 id=工作流程>工作流程</h2><h3 id=校验-typedescription-插件是否可用>校验 TypeDescription 插件是否可用</h3><h3 id=字节码增强流程>字节码增强流程</h3><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#177500>// AbstractClassEnhancePluginDefine.java
</span></span></span><span style=display:flex><span><span style=color:#177500>// ClassEnhancePluginDefine.java
</span></span></span><span style=display:flex><span><span style=color:#177500>// StaticMethodsInter.java
</span></span></span><span style=display:flex><span><span style=color:#177500>// StaticMethodsInterWithOverrideArgs.java
</span></span></span></code></pre></td></tr></table></div></div></div><h4 id=静态方法插桩>静态方法插桩</h4><ul><li>要修改原方法入参<ul><li>是 JDK 库核心类</li><li>不是 JDK 库核心类<ul><li>实例化插件中定义的 Interceptor</li><li>调用 beforeMethod()<ul><li>可以修改原方法入参</li></ul></li><li>调用原方法<ul><li>调用时可以传参</li><li>对于异常，调用 handleMethodException</li></ul></li><li>调用 afterMethod()</li></ul></li></ul></li><li>不修改原方法入参<ul><li>是 JDK 库核心类</li><li>不是 JDK 库核心类<ul><li>实例化插件中定义的 Interceptor</li><li>调用 beforeMethod()</li><li>调用原方法<ul><li>调用时不能传参</li><li>对于异常，调用 handleMethodException</li></ul></li><li>调用 afterMethod()</li></ul></li></ul></li></ul><h4 id=构造器和实例方法插桩>构造器和实例方法插桩</h4><ul><li>构造器<ul><li>是 JDK 库核心类</li><li>不是 JDK 库核心类<ul><li>只能在拦截的构造器原本逻辑执行完成以后再执行 onConstruct()</li></ul></li></ul></li><li>实例方法<ul><li>参考静态方法</li></ul></li></ul><h3 id=将记录状态的上下文-enhancecontext-设置为-已增强>将记录状态的上下文 EnhanceContext 设置为 [已增强]</h3><h2 id=插件拦截器加载流程>插件拦截器加载流程</h2><p>双亲委派机制</p><p>Agentxxx必须使用目标类的类加载器加载，才能操作目标类。</p><p><img src=../imgs/skywalking-source-code-211211_4.png alt=skywalking-source-code-211211_4.png></p><h2 id=运行时插件效果的字节码>运行时插件效果的字节码</h2><p>借助工具：<a href=https://github.com/zifeihan/friday>https://github.com/zifeihan/friday</a></p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ret</span> <span style=color:#000>=</span> <span style=color:#000>zuper</span><span style=color:#000>.</span><span style=color:#836c28>call</span><span style=color:#000>();</span>
</span></span><span style=display:flex><span><span style=color:#177500>// method.invoke(); 
</span></span></span></code></pre></td></tr></table></div></div></div><p>// 不能这么写，会死循环，因为原方法被重命名，如sayHello()被会改成sayHelloXxxx()，新方法sayHello()则是修改字节码后的的方法，method指代的是修改后的sayHello()方法，这里需要调用sayHelloXxx()方法</p><h1 id=注册关闭钩子>注册关闭钩子</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-952788f74d6d2060db99836bc84177d2>3 - 字节码增强技术-概念</h1><h1 id=asm>ASM</h1><p>Cglib就是基于ASM</p><p>IDEA插件 ASM Bytecode Outline：<a href=https://plugins.jetbrains.com/plugin/5918-asm-bytecode-outline/>https://plugins.jetbrains.com/plugin/5918-asm-bytecode-outline/</a></p><p>ASM和Javassist对比及应用</p><ul><li>javassist是基于源码级别的API比基于字节码的ASM简单;</li><li>基于javassist开发,不需要了解字节码的知识,而且其封装的一些工具类可以简单实现一些高级功能, 比如HotSwaper</li><li>ASM比javassist性能更快, 灵活性也较高</li><li>javassist提供的动态代理接口最慢, 比JDK自带的还慢</li><li>监控方法, 采集方法运行时的入参, 出参和异常信息.</li></ul><h1 id=javaassist>JavaAssist</h1><p>ASM虽然可以达到修改字节码的效果，但是代码实现上更偏底层，是一个个虚拟机指令的组合，不好理解、记忆，和Java语言的编程习惯有较大差距。</p><p>利用Javassist实现字节码增强时，可以无须关注字节码刻板的结构，其优点就在于编程简单。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构或者动态生成类。</p><ul><li>ClassPool：保存CtClass的池子，通过classPool.get(类全路径名)来获取CtClass</li><li>CtClass：编译时类信息，它是一个class文件在代码中的抽象表现形式</li><li>CtMethod：对应类中的方法</li><li>CtField：对应类中的属性、变量</li></ul><p>上面ASM和JavaAssist的Demo，都有一个共同点：<strong>两者例子中的目标类都没有被提前加载到JVM中</strong>，如果只能在类加载前对类中字节码进行修改，那将失去其存在意义，毕竟大部分运行的Java系统，都是在运行状态的线上系统。</p><p><strong>JVM是不允许在运行时动态重载一个类的</strong></p><h1 id=instrumentation>Instrumentation</h1><p>instrument是JVM提供的一个可以修改已加载类的类库。它需要依赖JVMTI的Attach API机制实现，在JDK 1.6之后，instrument支持了在运行时对类定义的修改。要使用instrument的类修改功能，我们需要实现它提供的ClassFileTransformer接口，定义一个类文件转换器。接口中的transform()方法会在类文件被加载时调用</p><p>先看下其关键方法</p><style>.td-content .highlight{margin-top:.5rem;margin-bottom:.5rem}.code-collapse1{overflow-y:auto;max-height:500px;overflow-x:auto;max-width:100%}</style><div class=code-collapse1><div class=highlight><div style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>interface</span> <span style=color:#3f6e75>Instrumentation</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>//添加一个类文件转换器
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>void</span> <span style=color:#000>addTransformer</span><span style=color:#000>(</span><span style=color:#000>ClassFileTransformer</span> <span style=color:#000>transformer</span><span style=color:#000>);</span>
</span></span><span style=display:flex><span>  <span style=color:#177500>//重新加载一个类，加载时触发ClassFileTransformer接口
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>void</span> <span style=color:#000>retransformClasses</span><span style=color:#000>(</span><span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;...</span> <span style=color:#000>classes</span><span style=color:#000>)</span> <span style=color:#a90d91>throws</span> <span style=color:#000>UnmodifiableClassException</span><span style=color:#000>;</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h1 id=agent>Agent</h1><p>光有Instrumentation接口还不够，如何将其注入到一个正在运行JVM的进程中去呢？我们还需要自定义一个Agent，借助Agent的能力将Instrumentation注入到运行的JVM中。</p><p>Agent是JVMTI的一种实现，Agent有两种启动方式</p><ul><li>一是随Java进程启动而启动，经常见到的java -agentlib就是这种方式；</li><li>二是运行时载入，通过attach API，将模块（jar包）动态地Attach到指定进程id的Java进程内</li></ul><h3 id=premainclass随jvm进程启动>PremainClass随JVM进程启动</h3><p>-javaagent方式</p><p>以Agent+JavaAssist的方式实现了零侵入方式的AOP，其原理就是JVM会优先调用PreMain方法(即Agent中的方法)，后面才会调用Main方法。</p><p>但是缺点也是显而易见的，Agent必须随着JVM进程启动而加载的方式，不够灵活</p><h3 id=agentclass以attach方法注入agent>AgentClass以Attach方法注入Agent</h3><p>随着进程启动的Premain方式的Agent更偏向是一种初始化加载时的修改方式，而Attach API的loadAgent()方法，能够将打包好的Agent jar包动态Attach到目标JVM上，是一种运行时注入Agent、修改字节码的方式</p><p>市面上诸如Arthas、Btrace这种JVM监控工具即是基于这种思路实现</p><h1 id=bytebuddy>ByteBuddy</h1><p>ByteBuddy是一个可以在运行时动态生成java class的类库。</p><ul><li>基于ASM的代码修改和生成工具</li><li>runtime期动态生成和修改</li><li>easy use无需理解字节码，简洁的代码风格</li></ul><h1 id=reference>Reference</h1><p><a href=https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html>美团技术-字节码增强技术探索</a></p><p><a href=https://blog.csdn.net/hosaos/article/details/102931887>Java字节码技术(二)字节码增强之ASM、JavaAssist、Agent、Instrumentation</a></p><p><a href=https://zhuanlan.zhihu.com/p/151843984>ByteBuddy入门教程</a></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Herb 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small><p class=mt-2><a href=/about/>Herbdocs</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>