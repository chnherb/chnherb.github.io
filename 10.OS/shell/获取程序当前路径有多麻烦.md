

# 背景

为了实现程序自己更新自己，需要获取当前程序的安装路径。

# 程序执行方式

程序可以通过如下几种方式来执行：

## 软链接

通过软链接执行程序

```shell
# 生成软链接
ln -s /Users/bo/util-cli/util-cli_darwin_amd64 /usr/local/bin/util-cli

# 1、在 非/usr/local/bin路径下执行
util-cli
# 2、在/usr/local/bin路径下执行
util-cli
```
## 相对路径

如以下命令：

```shell
# 1、当前路径
./util-cli_darwin_amd64
# 2、父目录
./install_dir/util-cli_darwin_amd64
# 3、当前路径
../install_dir/util-cli_darwin_amd64
```
## alias

通过在 .bash_profile或 .bash_rc 中配置 alias 的方式来执行

注意：脚本配置 alias 需要用 source 执行脚本而不是 bash 等，否则alias不会生效

```shell
alias util-cli="/Users/bo/util-cli/util-cli_darwin_amd64"
```


# 解决方案

针对以上三个类情况对文件安装目录进行解析，然后安装替换。

## 运行程序名称

通过os.Args[0] 来获取程序运行名称。

### 软链接方式

程序名称为输入的程序名称，如 util-cli

### 相对路径

同上，程序名称为输入的程序名称，如 

```shell
./install_dir/util-cli_darwin_amd64
# 或
./install_dir/util-cli_darwin_amd64  # 等
```
### alias

程序名称为文件全路径，如

```shell
/Users/bo/util-cli/util-cli_darwin_amd64
```

## which/type

可通过 which type 等命令来获取其软链地址

注意：

1、which、type 不可获取 alias 地址，尤其是 sh -c which/type xxx会报错

2、程序运行时，which、type获取不到alias的别名信息，与环境有关

## pwd

通过pwd或者os.Getwd()来获取当前运行路径，然后拼接运行程序名获取全路径，可解决 相对路径 执行方式

# 核心解决思路

```shell
ls -ld $(programName) | awk '{print $(NF)}'
```
该命令可解决  软链在其目录下 和 alias 的执行方式
其他情况可搭配 which pwd 处理

# 程序代码

```go
func getProgramRealDir(programName string) (string, error) {
   programPath, err := util.ShellExecWithWorkDir(fmt.Sprintf("ls -ld %s | awk '{print $(NF)}'", programName), ".")
   if err != nil {
      return "", err
   }
   realDir := ""
   // ln -s, not in /usr/local/bin
   if strings.HasSuffix(programPath, "No such file or directory") {
      lnCmdPath, err := util.ShellExecWithWorkDir(fmt.Sprintf("which %s", programName), ".")
      if err != nil {
         return "", err
      }
      realDir, err = util.ShellExecWithWorkDir(fmt.Sprintf("ls -ld %s | awk '{print $(NF)}'", lnCmdPath), ".")
      if err != nil {
         return "", err
      }
      return filepath.Dir(realDir), nil
   } else {
      // alias and ln -s in /usr/local/bin
      realDir = filepath.Dir(programPath)
      // relative path
      if strings.HasPrefix(programPath, ".") {
         pwd, err := os.Getwd()
         if err != nil {
            return "", nil
         }
         programDir := filepath.Dir(programPath)
         if programDir == "." {
            realDir = pwd
         } else {
            realDir = fmt.Sprintf("%s/%s", pwd, programDir)
         }
      }
   }
   return realDir, nil
}
```
