---
categories: ["APM"] 
tags: ["bytecode"] 
title: "字节码增强技术-概念"
# linkTitle: ""
weight: 5
description: >
  
---



# ASM

Cglib就是基于ASM

IDEA插件 ASM Bytecode Outline：[https://plugins.jetbrains.com/plugin/5918-asm-bytecode-outline/](https://plugins.jetbrains.com/plugin/5918-asm-bytecode-outline/)

ASM和Javassist对比及应用

* javassist是基于源码级别的API比基于字节码的ASM简单;
* 基于javassist开发,不需要了解字节码的知识,而且其封装的一些工具类可以简单实现一些高级功能, 比如HotSwaper
* ASM比javassist性能更快, 灵活性也较高
* javassist提供的动态代理接口最慢, 比JDK自带的还慢
* 监控方法, 采集方法运行时的入参, 出参和异常信息.

# JavaAssist

ASM虽然可以达到修改字节码的效果，但是代码实现上更偏底层，是一个个虚拟机指令的组合，不好理解、记忆，和Java语言的编程习惯有较大差距。

利用Javassist实现字节码增强时，可以无须关注字节码刻板的结构，其优点就在于编程简单。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构或者动态生成类。

* ClassPool：保存CtClass的池子，通过classPool.get(类全路径名)来获取CtClass
* CtClass：编译时类信息，它是一个class文件在代码中的抽象表现形式
* CtMethod：对应类中的方法
* CtField：对应类中的属性、变量

上面ASM和JavaAssist的Demo，都有一个共同点：**两者例子中的目标类都没有被提前加载到JVM中**，如果只能在类加载前对类中字节码进行修改，那将失去其存在意义，毕竟大部分运行的Java系统，都是在运行状态的线上系统。

**JVM是不允许在运行时动态重载一个类的**

# Instrumentation

instrument是JVM提供的一个可以修改已加载类的类库。它需要依赖JVMTI的Attach API机制实现，在JDK 1.6之后，instrument支持了在运行时对类定义的修改。要使用instrument的类修改功能，我们需要实现它提供的ClassFileTransformer接口，定义一个类文件转换器。接口中的transform()方法会在类文件被加载时调用

先看下其关键方法

```java
public interface Instrumentation {
  //添加一个类文件转换器
  void addTransformer(ClassFileTransformer transformer);
  //重新加载一个类，加载时触发ClassFileTransformer接口
  void retransformClasses(Class<?>... classes) throws UnmodifiableClassException;
}
```


# Agent

光有Instrumentation接口还不够，如何将其注入到一个正在运行JVM的进程中去呢？我们还需要自定义一个Agent，借助Agent的能力将Instrumentation注入到运行的JVM中。

Agent是JVMTI的一种实现，Agent有两种启动方式

* 一是随Java进程启动而启动，经常见到的java -agentlib就是这种方式；
* 二是运行时载入，通过attach API，将模块（jar包）动态地Attach到指定进程id的Java进程内

### PremainClass随JVM进程启动

-javaagent方式

以Agent+JavaAssist的方式实现了零侵入方式的AOP，其原理就是JVM会优先调用PreMain方法(即Agent中的方法)，后面才会调用Main方法。

但是缺点也是显而易见的，Agent必须随着JVM进程启动而加载的方式，不够灵活

### AgentClass以Attach方法注入Agent

随着进程启动的Premain方式的Agent更偏向是一种初始化加载时的修改方式，而Attach API的loadAgent()方法，能够将打包好的Agent jar包动态Attach到目标JVM上，是一种运行时注入Agent、修改字节码的方式

市面上诸如Arthas、Btrace这种JVM监控工具即是基于这种思路实现


# ByteBuddy

ByteBuddy是一个可以在运行时动态生成java class的类库。

* 基于ASM的代码修改和生成工具
* runtime期动态生成和修改
* easy use无需理解字节码，简洁的代码风格

# Reference

[美团技术-字节码增强技术探索](https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html)

[Java字节码技术(二)字节码增强之ASM、JavaAssist、Agent、Instrumentation](https://blog.csdn.net/hosaos/article/details/102931887)

[ByteBuddy入门教程](https://zhuanlan.zhihu.com/p/151843984)
